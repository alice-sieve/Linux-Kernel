<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH] ath6kl: Use vmalloc to allocate ar&#45;>fw for api1 method -->
<!--X-From-R13: Rna Yrcuneg &#60;Rna.YrcunegNynveqgrpu.pbz> -->
<!--X-Date: Mon, 21 Dec 2015 14:01:20 &#45;0800 -->
<!--X-Message-Id: F12301F7&#45;EE8E&#45;4B5A&#45;BE28&#45;17A235DBCA7E@lairdtech.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 1448948470&#45;31111&#45;1&#45;git&#45;send&#45;email&#45;motobud@gmail.com -->
<!--X-Reference: CAFqt6zaALx895c0BVrMpLdtfgYLz=&#45;mmqaurtD28Nm1Ut2g1Dw@mail.gmail.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Linux ATH6KL: Re: [PATCH] ath6kl: Use vmalloc to allocate ar-&gt;fw for api1 method">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH] ath6kl: Use vmalloc to allocate ar-&gt;fw for api1 method (Linux ATH6KL)</title>
<link rel="alternate" type="application/rss+xml" title="Linux ATH6KL" href="//feedproxy.google.com/LinuxATH6KL">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:6308783764" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH] ath6kl: Use vmalloc to allocate ar-&gt;fw for api1 method</h1>
[<a href="msg00171.html">Date Prev</a>][<a href="msg00173.html">Date Next</a>][<a href="msg00175.html">Thread Prev</a>][<a href="msg00164.html">Thread Next</a>][<a href="maillist.html#00172">Date Index</a>][<a href="index.html#00172">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Souptick Joarder &lt;<a href="mailto:jrdr.linux@DOMAIN.HIDDEN">jrdr.linux@xxxxxxxxx</a>&gt;, Brent Taylor &lt;<a href="mailto:motobud@DOMAIN.HIDDEN">motobud@xxxxxxxxx</a>&gt;</li>
<li><em>Subject</em>: Re: [PATCH] ath6kl: Use vmalloc to allocate ar-&gt;fw for api1 method</li>
<li><em>From</em>: Dan Kephart &lt;<a href="mailto:Dan.Kephart@DOMAIN.HIDDEN">Dan.Kephart@xxxxxxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Mon, 21 Dec 2015 22:00:40 +0000</li>
<li><em>Accept-language</em>: en-US</li>
<li><em>Cc</em>: &quot;<a href="mailto:netdev@DOMAIN.HIDDEN">netdev@xxxxxxxxxxxxxxx</a>&quot; &lt;<a href="mailto:netdev@DOMAIN.HIDDEN">netdev@xxxxxxxxxxxxxxx</a>&gt;,        Kalle Valo &lt;<a href="mailto:kvalo@DOMAIN.HIDDEN">kvalo@xxxxxxxxxxxxxxxx</a>&gt;,        &quot;<a href="mailto:ath6kl@DOMAIN.HIDDEN">ath6kl@xxxxxxxxxxxxxxxxxxx</a>&quot; &lt;<a href="mailto:ath6kl@DOMAIN.HIDDEN">ath6kl@xxxxxxxxxxxxxxxxxxx</a>&gt;,        &quot;<a href="mailto:linux-wireless@DOMAIN.HIDDEN">linux-wireless@xxxxxxxxxxxxxxx</a>&quot; &lt;<a href="mailto:linux-wireless@DOMAIN.HIDDEN">linux-wireless@xxxxxxxxxxxxxxx</a>&gt;,        &quot;<a href="mailto:linux-kernel@DOMAIN.HIDDEN">linux-kernel@xxxxxxxxxxxxxxx</a>&quot; &lt;<a href="mailto:linux-kernel@DOMAIN.HIDDEN">linux-kernel@xxxxxxxxxxxxxxx</a>&gt;</li>
<li><em>In-reply-to</em>: &lt;CAFqt6zaALx895c0BVrMpLdtfgYLz=-mmqaurtD28Nm1Ut2g1Dw@mail.gmail.com&gt;</li>
<li><em>Thread-index</em>: AQHRPCUeuJG4SF56vEea2Ug7ggI0m57WH0wA</li>
<li><em>Thread-topic</em>: [PATCH] ath6kl: Use vmalloc to allocate ar-&gt;fw for api1 method</li>
<li><em>User-agent</em>: Microsoft-MacOutlook/0.0.0.151105</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Hi Brent and Souptick,




On 12/21/15, 2:23 PM, &quot;ath6kl on behalf of Souptick Joarder&quot; &lt;ath6kl-bounces@xxxxxxxxxxxxxxxxxxx on behalf of jrdr.linux@xxxxxxxxx&gt; wrote:

&gt;Hi Brent,
&gt;
&gt;On Tue, Dec 1, 2015 at 11:11 AM, Brent Taylor &lt;motobud@xxxxxxxxx&gt; wrote:
&gt;&gt; Since commit 8437754c83351d6213c1a47ff029c1126d6042a7, ar-&gt;fw is expected to be pointing to memory allocated by vmalloc.  If the api1 method (via ath6kl_fetch_fw_api1) is used to allocate memory for ar-&gt;fw, then kmemdup is used.  This patch checks if the firmware being loaded is the 'fw' image, then use vmalloc, otherwise use kmalloc.
&gt;&gt;
&gt;&gt; Signed-off-by: Brent Taylor &lt;motobud@xxxxxxxxx&gt;
&gt;&gt; ---
&gt;&gt;  drivers/net/wireless/ath/ath6kl/init.c | 7 ++++++-
&gt;&gt;  1 file changed, 6 insertions(+), 1 deletion(-)
&gt;&gt;
&gt;&gt; diff --git a/drivers/net/wireless/ath/ath6kl/init.c b/drivers/net/wireless/ath/ath6kl/init.c
&gt;&gt; index 6ae0734..4f2b124d 100644
&gt;&gt; --- a/drivers/net/wireless/ath/ath6kl/init.c
&gt;&gt; +++ b/drivers/net/wireless/ath/ath6kl/init.c
&gt;&gt; @@ -673,10 +673,15 @@ static int ath6kl_get_fw(struct ath6kl *ar, const char *filename,
&gt;&gt;                 return ret;
&gt;&gt;
&gt;&gt;         *fw_len = fw_entry-&gt;size;
&gt;&gt; -       *fw = kmemdup(fw_entry-&gt;data, fw_entry-&gt;size, GFP_KERNEL);
&gt;&gt; +   if (&amp;ar-&gt;fw == fw)
&gt;&gt; +               *fw = vmalloc(fw_entry-&gt;size);
&gt;&gt; +   else
&gt;&gt; +               *fw = kmalloc(fw_entry-&gt;size, GFP_KERNEL);
&gt;
&gt;          Why vmalloc and kmalloc both are required? can't use either
&gt;vmalloc or kmalloc?

My guess is the reason to use both vmalloc and kmalloc is that the firmware blob can be near 128KB.  I know our ar6003 firmwares approach that.  So vmalloc must have been chosen to avoid any issues if it was greater than 128KB.  So kmalloc is used for all the small firmware pieces (board data, otp.bin, etc) but vmalloc for the firmware itself.  

I personally fixed this issue for loading the firmware (but not board data, opt.bin, etc) in the api1 and testmode functions by have it call a new helper function:

static int ath6kl_get_fw_vm(struct ath6kl *ar, const char *filename,
			 u8 **fw, size_t *fw_len)
{
	const struct firmware *fw_entry;
	int ret;

	ret = request_firmware(&amp;fw_entry, filename, ar-&gt;dev);
	if (ret)
	return ret;

	*fw_len = fw_entry-&gt;size;
	*fw = vmalloc(*fw_len);

	if (*fw == NULL)
	ret = -ENOMEM;

	memcpy(*fw, fw_entry-&gt;data, *fw_len);

	release_firmware(fw_entry);

	return ret;
}



&gt;&gt;
&gt;&gt;         if (*fw == NULL)
&gt;&gt;                 ret = -ENOMEM;
&gt;&gt; +       else
&gt;&gt; +               memcpy(*fw, fw_entry-&gt;data, fw_entry-&gt;size);
&gt;&gt;
&gt;&gt;         release_firmware(fw_entry);
&gt;&gt;
&gt;&gt; --
&gt;&gt; 2.6.3
&gt;&gt;
&gt;&gt; --
&gt;&gt; To unsubscribe from this list: send the line &quot;unsubscribe linux-wireless&quot; in
&gt;&gt; the body of a message to majordomo@xxxxxxxxxxxxxxx
&gt;&gt; More majordomo info at  <a  rel="nofollow" href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a>
&gt;
&gt;-Souptick
&gt;
&gt;_______________________________________________
&gt;ath6kl mailing list
&gt;ath6kl@xxxxxxxxxxxxxxxxxxx
&gt;<a  rel="nofollow" href="http://lists.infradead.org/mailman/listinfo/ath6kl">http://lists.infradead.org/mailman/listinfo/ath6kl</a>

- Dan Kephart
_______________________________________________
ath6kl mailing list
ath6kl@xxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="http://lists.infradead.org/mailman/listinfo/ath6kl">http://lists.infradead.org/mailman/listinfo/ath6kl</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00161" href="msg00161.html">[PATCH] ath6kl: Use vmalloc to allocate ar-&gt;fw for api1 method</a></strong>
<ul><li><em>From:</em> Brent Taylor</li></ul></li>
<li><strong><a name="00170" href="msg00170.html">Re: [PATCH] ath6kl: Use vmalloc to allocate ar-&gt;fw for api1 method</a></strong>
<ul><li><em>From:</em> Souptick Joarder</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00171.html">Re: [PATCH] ath6kl: Use vmalloc to allocate ar-&gt;fw for api1 method</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00173.html">Re: [PATCH] ath6kl: Use vmalloc to allocate ar-&gt;fw for api1 method</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00175.html">Re: [PATCH] ath6kl: Use vmalloc to allocate ar-&gt;fw for api1 method</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00164.html">[v2] ath6kl: Use vmalloc to allocate ar-&gt;fw for api1 method</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00172"><strong>Date</strong></a></li>
<li><a href="index.html#00172"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-wireless/>[Linux&nbsp;Wireless]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-bluetooth/>[Linux&nbsp;Bluetooth]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-wpan/>[Linux&nbsp;WPAN]</a>
&nbsp;
&nbsp;
<a href=/lists/netdev/>[Linux&nbsp;Netdev]</a>
&nbsp;
&nbsp;
<a href=/lists/newbies/>[Kernel&nbsp;Newbies]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-ide/>[IDE]</a>
&nbsp;
&nbsp;
<a href=/lists/security/>[Security]</a>
&nbsp;
&nbsp;
<a href=/lists/git/>[Git]</a>
&nbsp;
&nbsp;
<a href=/lists/netfilter/>[Netfilter]</a>
&nbsp;
&nbsp;
<a href=/lists/bugtraq/>[Bugtraq]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/mips/>[MIPS&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/arm/>[ARM&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/security/>[Linux&nbsp;Security]</a>
&nbsp;
&nbsp;
<a href=/lists/raid/>[Linux&nbsp;RAID]</a>
&nbsp;
&nbsp;
<a href=/lists/ataraid/>[Linux&nbsp;ATA&nbsp;RAID]</a>
&nbsp;
&nbsp;
<a href=/lists/samba/>[Samba]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

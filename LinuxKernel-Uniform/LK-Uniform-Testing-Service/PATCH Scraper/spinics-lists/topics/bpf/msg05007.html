<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH bpf&#45;next 1/2] bpf, libbpf: add a new API bpf_object__reuse_maps() -->
<!--X-From-R13: Rnavry Pbexznaa &#60;qnavryNvbtrneobk.arg> -->
<!--X-Date: Fri, 5 Jul 2019 14:44:52 &#45;0700 -->
<!--X-Message-Id: 734dd45a&#45;95b0&#45;a7fd&#45;9e1d&#45;0535ef4d3e12@iogearbox.net -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: cover.1562359091.git.a.s.protopopov@gmail.com -->
<!--X-Reference: e183c0af99056f8ea4de06acb358ace7f3a3d6ae.1562359091.git.a.s.protopopov@gmail.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="BPF: Re: [PATCH bpf-next 1/2] bpf, libbpf: add a new API bpf_object__reuse_maps()">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH bpf-next 1/2] bpf, libbpf: add a new API bpf_object__reuse_maps() &mdash; BPF</title>
<link rel="alternate" type="application/rss+xml" title="BPF" href="//feeds.feedburner.com/packetfilters">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH bpf-next 1/2] bpf, libbpf: add a new API bpf_object__reuse_maps()</h1>
[<a href="msg05006.html">Date Prev</a>][<a href="msg05008.html">Date Next</a>][<a href="msg05003.html">Thread Prev</a>][<a href="msg05059.html">Thread Next</a>][<a href="maillist.html#05007">Date Index</a>][<a href="index.html#05007">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH bpf-next 1/2] bpf, libbpf: add a new API bpf_object__reuse_maps()</li>
<li><em>From</em>: Daniel Borkmann &lt;daniel@xxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Fri, 5 Jul 2019 23:44:44 +0200</li>
<li><em>In-reply-to</em>: &lt;<a href="msg05003.html">e183c0af99056f8ea4de06acb358ace7f3a3d6ae.1562359091.git.a.s.protopopov@gmail.com</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Thunderbird/52.3.0</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On 07/05/2019 10:44 PM, Anton Protopopov wrote:
&gt;<i> Add a new API bpf_object__reuse_maps() which can be used to replace all maps in</i>
&gt;<i> an object by maps pinned to a directory provided in the path argument.  Namely,</i>
&gt;<i> each map M in the object will be replaced by a map pinned to path/M.name.</i>
&gt;<i> </i>
&gt;<i> Signed-off-by: Anton Protopopov &lt;a.s.protopopov@xxxxxxxxx&gt;</i>
&gt;<i> ---</i>
&gt;<i>  tools/lib/bpf/libbpf.c   | 34 ++++++++++++++++++++++++++++++++++</i>
&gt;<i>  tools/lib/bpf/libbpf.h   |  2 ++</i>
&gt;<i>  tools/lib/bpf/libbpf.map |  1 +</i>
&gt;<i>  3 files changed, 37 insertions(+)</i>
&gt;<i> </i>
&gt;<i> diff --git a/tools/lib/bpf/libbpf.c b/tools/lib/bpf/libbpf.c</i>
&gt;<i> index 4907997289e9..84c9e8f7bfd3 100644</i>
&gt;<i> --- a/tools/lib/bpf/libbpf.c</i>
&gt;<i> +++ b/tools/lib/bpf/libbpf.c</i>
&gt;<i> @@ -3144,6 +3144,40 @@ int bpf_object__unpin_maps(struct bpf_object *obj, const char *path)</i>
&gt;<i>  	return 0;</i>
&gt;<i>  }</i>
&gt;<i>  </i>
&gt;<i> +int bpf_object__reuse_maps(struct bpf_object *obj, const char *path)</i>
&gt;<i> +{</i>
&gt;<i> +	struct bpf_map *map;</i>
&gt;<i> +</i>
&gt;<i> +	if (!obj)</i>
&gt;<i> +		return -ENOENT;</i>
&gt;<i> +</i>
&gt;<i> +	if (!path)</i>
&gt;<i> +		return -EINVAL;</i>
&gt;<i> +</i>
&gt;<i> +	bpf_object__for_each_map(map, obj) {</i>
&gt;<i> +		int len, err;</i>
&gt;<i> +		int pinned_map_fd;</i>
&gt;<i> +		char buf[PATH_MAX];</i>

We'd need to skip the case of bpf_map__is_internal(map) since they are always
recreated for the given object.

&gt;<i> +		len = snprintf(buf, PATH_MAX, &quot;%s/%s&quot;, path, bpf_map__name(map));</i>
&gt;<i> +		if (len &lt; 0) {</i>
&gt;<i> +			return -EINVAL;</i>
&gt;<i> +		} else if (len &gt;= PATH_MAX) {</i>
&gt;<i> +			return -ENAMETOOLONG;</i>
&gt;<i> +		}</i>
&gt;<i> +</i>
&gt;<i> +		pinned_map_fd = bpf_obj_get(buf);</i>
&gt;<i> +		if (pinned_map_fd &lt; 0)</i>
&gt;<i> +			return pinned_map_fd;</i>

Should we rather have a new map definition attribute that tells to reuse
the map if it's pinned in bpf fs, and if not, we create it and later on
pin it? This is what iproute2 is doing and which we're making use of heavily.
In bpf_object__reuse_maps() bailing out if bpf_obj_get() fails is perhaps
too limiting for a generic API as new version of an object file may contain
new maps which are not yet present in bpf fs at that point.

&gt;<i> +		err = bpf_map__reuse_fd(map, pinned_map_fd);</i>
&gt;<i> +		if (err)</i>
&gt;<i> +			return err;</i>
&gt;<i> +	}</i>
&gt;<i> +</i>
&gt;<i> +	return 0;</i>
&gt;<i> +}</i>
&gt;<i> +</i>
&gt;<i>  int bpf_object__pin_programs(struct bpf_object *obj, const char *path)</i>
&gt;<i>  {</i>
&gt;<i>  	struct bpf_program *prog;</i>
&gt;<i> diff --git a/tools/lib/bpf/libbpf.h b/tools/lib/bpf/libbpf.h</i>
&gt;<i> index d639f47e3110..7fe465a1be76 100644</i>
&gt;<i> --- a/tools/lib/bpf/libbpf.h</i>
&gt;<i> +++ b/tools/lib/bpf/libbpf.h</i>
&gt;<i> @@ -82,6 +82,8 @@ int bpf_object__variable_offset(const struct bpf_object *obj, const char *name,</i>
&gt;<i>  LIBBPF_API int bpf_object__pin_maps(struct bpf_object *obj, const char *path);</i>
&gt;<i>  LIBBPF_API int bpf_object__unpin_maps(struct bpf_object *obj,</i>
&gt;<i>  				      const char *path);</i>
&gt;<i> +LIBBPF_API int bpf_object__reuse_maps(struct bpf_object *obj,</i>
&gt;<i> +				      const char *path);</i>
&gt;<i>  LIBBPF_API int bpf_object__pin_programs(struct bpf_object *obj,</i>
&gt;<i>  					const char *path);</i>
&gt;<i>  LIBBPF_API int bpf_object__unpin_programs(struct bpf_object *obj,</i>
&gt;<i> diff --git a/tools/lib/bpf/libbpf.map b/tools/lib/bpf/libbpf.map</i>
&gt;<i> index 2c6d835620d2..66a30be6696c 100644</i>
&gt;<i> --- a/tools/lib/bpf/libbpf.map</i>
&gt;<i> +++ b/tools/lib/bpf/libbpf.map</i>
&gt;<i> @@ -172,5 +172,6 @@ LIBBPF_0.0.4 {</i>
&gt;<i>  		btf_dump__new;</i>
&gt;<i>  		btf__parse_elf;</i>
&gt;<i>  		bpf_object__load_xattr;</i>
&gt;<i> +		bpf_object__reuse_maps;</i>
&gt;<i>  		libbpf_num_possible_cpus;</i>
&gt;<i>  } LIBBPF_0.0.3;</i>
&gt;<i> </i>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="05093" href="msg05093.html">Re: [PATCH bpf-next 1/2] bpf, libbpf: add a new API bpf_object__reuse_maps()</a></strong>
<ul><li><em>From:</em> Andrii Nakryiko</li></ul></li>
<li><strong><a name="05059" href="msg05059.html">Re: [PATCH bpf-next 1/2] bpf, libbpf: add a new API bpf_object__reuse_maps()</a></strong>
<ul><li><em>From:</em> Anton Protopopov</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="05002" href="msg05002.html">[PATCH bpf-next 0/2]  libbpf: add an option to reuse maps when loading a program</a></strong>
<ul><li><em>From:</em> Anton Protopopov</li></ul></li>
<li><strong><a name="05003" href="msg05003.html">[PATCH bpf-next 1/2] bpf, libbpf: add a new API bpf_object__reuse_maps()</a></strong>
<ul><li><em>From:</em> Anton Protopopov</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg05006.html">Re: [PATCH v5 bpf-next 0/4] capture integers in BTF type info for map defs</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg05008.html">Re: [PATCH bpf-next v2] tools: bpftool: add &quot;prog run&quot; subcommand to test-run programs</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg05003.html">[PATCH bpf-next 1/2] bpf, libbpf: add a new API bpf_object__reuse_maps()</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg05059.html">Re: [PATCH bpf-next 1/2] bpf, libbpf: add a new API bpf_object__reuse_maps()</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#05007"><strong>Date</strong></a></li>
<li><a href="index.html#05007"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;Samsung&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-rockchip/>[Linux&nbsp;Rockchip&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-actions/>[Linux&nbsp;Actions&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-snps-arc/>[Linux&nbsp;for&nbsp;Synopsys&nbsp;ARC&nbsp;Processors]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nfs/>[Linux&nbsp;NFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nilfs/>[Linux&nbsp;NILFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/vfl/>[Video&nbsp;for&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<p>
<hr>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

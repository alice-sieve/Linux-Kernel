<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace -->
<!--X-From-R13: Oyrkrv Egnebibvgbi &#60;nyrkrv.fgnebibvgbiNtznvy.pbz> -->
<!--X-Date: Tue, 16 Jul 2019 13:55:03 &#45;0700 -->
<!--X-Message-Id: 20190716205455.iimn3pqpvsc3k4ry@ast&#45;mbp.dhcp.thefacebook.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190710141548.132193&#45;1&#45;joel@joelfernandes.org -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="BPF: Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace &mdash; BPF</title>
<link rel="alternate" type="application/rss+xml" title="BPF" href="//feeds.feedburner.com/packetfilters">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</h1>
[<a href="msg05451.html">Date Prev</a>][<a href="msg05453.html">Date Next</a>][<a href="msg05172.html">Thread Prev</a>][<a href="msg05453.html">Thread Next</a>][<a href="maillist.html#05452">Date Index</a>][<a href="index.html#05452">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</li>
<li><em>From</em>: Alexei Starovoitov &lt;alexei.starovoitov@xxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 16 Jul 2019 13:54:57 -0700</li>
<li><em>Cc</em>: linux-kernel@xxxxxxxxxxxxxxx,        Adrian Ratiu &lt;adrian.ratiu@xxxxxxxxxxxxx&gt;,        Alexei Starovoitov &lt;ast@xxxxxxxxxx&gt;, bpf@xxxxxxxxxxxxxxx,        Brendan Gregg &lt;brendan.d.gregg@xxxxxxxxx&gt;, connoro@xxxxxxxxxx,        Daniel Borkmann &lt;daniel@xxxxxxxxxxxxx&gt;,        duyuchao &lt;yuchao.du@xxxxxxxxxx&gt;, Ingo Molnar &lt;mingo@xxxxxxxxxx&gt;,        jeffv@xxxxxxxxxx, Karim Yaghmour &lt;karim.yaghmour@xxxxxxxxxxx&gt;,        kernel-team@xxxxxxxxxxx, linux-kselftest@xxxxxxxxxxxxxxx,        Manali Shukla &lt;manalishukla14@xxxxxxxxx&gt;,        Manjo Raja Rao &lt;linux@xxxxxxxxxxxxxxxx&gt;,        Martin KaFai Lau &lt;kafai@xxxxxx&gt;,        Masami Hiramatsu &lt;mhiramat@xxxxxxxxxx&gt;, Matt Mullins &lt;mmullins@xxxxxx&gt;,        Michal Gregorczyk &lt;michalgr@xxxxxx&gt;,        Michal Gregorczyk &lt;michalgr@xxxxxxxx&gt;,        Mohammad Husain &lt;russoue@xxxxxxxxx&gt;, namhyung@xxxxxxxxxx,        namhyung@xxxxxxxxxx, netdev@xxxxxxxxxxxxxxx, paul.chaignon@xxxxxxxxx,        primiano@xxxxxxxxxx, Qais Yousef &lt;qais.yousef@xxxxxxx&gt;,        Shuah Khan &lt;shuah@xxxxxxxxxx&gt;, Song Liu &lt;songliubraving@xxxxxx&gt;,        Srinivas Ramana &lt;sramana@xxxxxxxxxxxxxx&gt;,        Steven Rostedt &lt;rostedt@xxxxxxxxxxx&gt;,        Tamir Carmeli &lt;carmeli.tamir@xxxxxxxxx&gt;, Yonghong Song &lt;yhs@xxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg05170.html">20190710141548.132193-1-joel@joelfernandes.org</a>&gt;</li>
<li><em>User-agent</em>: NeoMutt/20180223</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Wed, Jul 10, 2019 at 10:15:44AM -0400, Joel Fernandes (Google) wrote:
&gt;<i> Hi,</i>

why are you cc-ing the whole world for this patch set?
I'll reply to all as well, but I suspect a bunch of folks consider it spam.
Please read Documentation/bpf/bpf_devel_QA.rst

Also, I think, netdev@vger rejects emails with 80+ characters in cc as spam,
so I'm not sure this set reached public mailing lists.

&gt;<i> These patches make it possible to attach BPF programs directly to tracepoints</i>
&gt;<i> using ftrace (/sys/kernel/debug/tracing) without needing the process doing the</i>
&gt;<i> attach to be alive. This has the following benefits:</i>
&gt;<i> </i>
&gt;<i> 1. Simplified Security: In Android, we have finer-grained security controls to</i>
&gt;<i> specific ftrace trace events using SELinux labels. We control precisely who is</i>
&gt;<i> allowed to enable an ftrace event already. By adding a node to ftrace for</i>
&gt;<i> attaching BPF programs, we can use the same mechanism to further control who is</i>
&gt;<i> allowed to attach to a trace event.</i>
&gt;<i> </i>
&gt;<i> 2. Process lifetime: In Android we are adding usecases where a tracing program</i>
&gt;<i> needs to be attached all the time to a tracepoint, for the full life time of</i>
&gt;<i> the system. Such as to gather statistics where there no need for a detach for</i>
&gt;<i> the full system lifetime. With perf or bpf(2)'s BPF_RAW_TRACEPOINT_OPEN, this</i>
&gt;<i> means keeping a process alive all the time.  However, in Android our BPF loader</i>
&gt;<i> currently (for hardeneded security) involves just starting a process at boot</i>
&gt;<i> time, doing the BPF program loading, and then pinning them to /sys/fs/bpf.  We</i>
&gt;<i> don't keep this process alive all the time. It is more suitable to do a</i>
&gt;<i> one-shot attach of the program using ftrace and not need to have a process</i>
&gt;<i> alive all the time anymore for this. Such process also needs elevated</i>
&gt;<i> privileges since tracepoint program loading currently requires CAP_SYS_ADMIN</i>
&gt;<i> anyway so by design Android's bpfloader runs once at init and exits.</i>
&gt;<i> </i>
&gt;<i> This series add a new bpf file to /sys/kernel/debug/tracing/events/X/Y/bpf</i>
&gt;<i> The following commands can be written into it:</i>
&gt;<i> attach:&lt;fd&gt;     Attaches BPF prog fd to tracepoint</i>
&gt;<i> detach:&lt;fd&gt;     Detaches BPF prog fd to tracepoint</i>

Looks like, to detach a program the user needs to read a text file,
parse bpf prog id from text into binary. Then call fd_from_id bpf syscall,
get a binary FD, convert it back to text and write as a text back into this file.
I think this is just a single example why text based apis are not accepted
in bpf anymore.

Through the patch set you call it ftrace. As far as I can see, this set
has zero overlap with ftrace. There is no ftrace-bpf connection here at all
that we discussed in the past Steven. It's all quite confusing.

I suggest android to solve sticky raw_tracepoint problem with user space deamon.
The reasons, you point out why user daemon cannot be used, sound weak to me.
Another acceptable solution would be to introduce pinning of raw_tp objects.
bpf progs and maps can be pinned in bpffs already. Pinning raw_tp would
be natural extension.



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="05453" href="msg05453.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
<ul><li><em>From:</em> Joel Fernandes</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="05170" href="msg05170.html">[PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
<ul><li><em>From:</em> Joel Fernandes (Google)</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg05451.html">Re: [PATCH bpf 1/2] selftests/bpf: fix test_verifier/test_maps make dependencies</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg05453.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg05172.html">[PATCH RFC 4/4] selftests/bpf: Add test for ftrace-based BPF attach/detach</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg05453.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#05452"><strong>Date</strong></a></li>
<li><a href="index.html#05452"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;Samsung&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-rockchip/>[Linux&nbsp;Rockchip&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-actions/>[Linux&nbsp;Actions&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-snps-arc/>[Linux&nbsp;for&nbsp;Synopsys&nbsp;ARC&nbsp;Processors]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nfs/>[Linux&nbsp;NFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nilfs/>[Linux&nbsp;NILFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/vfl/>[Video&nbsp;for&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<p>
<hr>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

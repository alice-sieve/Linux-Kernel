<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH bpf v4 00/14] sockmap/tls fixes -->
<!--X-From-R13: Xnxho Yvpvafxv &#60;wnxho.xvpvafxvNargebabzr.pbz> -->
<!--X-Date: Fri, 19 Jul 2019 10:31:02 &#45;0700 -->
<!--X-Message-Id: 20190719172927.18181&#45;1&#45;jakub.kicinski@netronome.com -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="BPF: [PATCH bpf v4 00/14] sockmap/tls fixes">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[PATCH bpf v4 00/14] sockmap/tls fixes &mdash; BPF</title>
<link rel="alternate" type="application/rss+xml" title="BPF" href="//feeds.feedburner.com/packetfilters">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH bpf v4 00/14] sockmap/tls fixes</h1>
[<a href="msg05538.html">Date Prev</a>][<a href="msg05540.html">Date Next</a>][<a href="msg05527.html">Thread Prev</a>][<a href="msg05540.html">Thread Next</a>][<a href="maillist.html#05539">Date Index</a>][<a href="index.html#05539">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH bpf v4 00/14] sockmap/tls fixes</li>
<li><em>From</em>: Jakub Kicinski &lt;jakub.kicinski@xxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Fri, 19 Jul 2019 10:29:13 -0700</li>
<li><em>Cc</em>: edumazet@xxxxxxxxxx, netdev@xxxxxxxxxxxxxxx, bpf@xxxxxxxxxxxxxxx,        Jakub Kicinski &lt;jakub.kicinski@xxxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>John says:

Resolve a series of splats discovered by syzbot and an unhash
TLS issue noted by Eric Dumazet.

The main issues revolved around interaction between TLS and
sockmap tear down. TLS and sockmap could both reset sk-&gt;prot
ops creating a condition where a close or unhash op could be
called forever. A rare race condition resulting from a missing
rcu sync operation was causing a use after free. Then on the
TLS side dropping the sock lock and re-acquiring it during the
close op could hang. Finally, sockmap must be deployed before
tls for current stack assumptions to be met. This is enforced
now. A feature series can enable it.

To fix this first refactor TLS code so the lock is held for the
entire teardown operation. Then add an unhash callback to ensure
TLS can not transition from ESTABLISHED to LISTEN state. This
transition is a similar bug to the one found and fixed previously
in sockmap. Then apply three fixes to sockmap to fix up races
on tear down around map free and close. Finally, if sockmap
is destroyed before TLS we add a new ULP op update to inform
the TLS stack it should not call sockmap ops. This last one
appears to be the most commonly found issue from syzbot.

v4:
 - fix some use after frees;
 - disable disconnect work for offload (ctx lifetime is much
   more complex);
 - remove some of the dead code which made it hard to understand
   (for me) that things work correctly (e.g. the checks TLS is
   the top ULP);
 - add selftets.

Jakub Kicinski (7):
  net/tls: don't arm strparser immediately in tls_set_sw_offload()
  net/tls: don't call tls_sk_proto_close for hw record offload
  selftests/tls: add a test for ULP but no keys
  selftests/tls: test error codes around TLS ULP installation
  selftests/tls: add a bidirectional test
  selftests/tls: close the socket with open record
  selftests/tls: add shutdown tests

John Fastabend (7):
  net/tls: remove close callback sock unlock/lock around TX work flush
  net/tls: remove sock unlock/lock around strp_done()
  net/tls: fix transition through disconnect with close
  bpf: sockmap, sock_map_delete needs to use xchg
  bpf: sockmap, synchronize_rcu before free'ing map
  bpf: sockmap, only create entry if ulp is not already enabled
  bpf: sockmap/tls, close can race with map free

 Documentation/networking/tls-offload.rst |   6 +
 include/linux/skmsg.h                    |   8 +-
 include/net/tcp.h                        |   3 +
 include/net/tls.h                        |  15 +-
 net/core/skmsg.c                         |   4 +-
 net/core/sock_map.c                      |  19 ++-
 net/ipv4/tcp_ulp.c                       |  13 ++
 net/tls/tls_main.c                       | 142 +++++++++++++----
 net/tls/tls_sw.c                         |  83 +++++++---
 tools/testing/selftests/net/tls.c        | 194 +++++++++++++++++++++++
 10 files changed, 419 insertions(+), 68 deletions(-)

-- 
2.21.0



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="05554" href="msg05554.html">Re: [PATCH bpf v4 00/14] sockmap/tls fixes</a></strong>
<ul><li><em>From:</em> Jakub Kicinski</li></ul></li>
<li><strong><a name="05553" href="msg05553.html">[PATCH bpf v4 09/14] bpf: sockmap/tls, close can race with map free</a></strong>
<ul><li><em>From:</em> Jakub Kicinski</li></ul></li>
<li><strong><a name="05552" href="msg05552.html">[PATCH bpf v4 14/14] selftests/tls: add shutdown tests</a></strong>
<ul><li><em>From:</em> Jakub Kicinski</li></ul></li>
<li><strong><a name="05551" href="msg05551.html">[PATCH bpf v4 13/14] selftests/tls: close the socket with open record</a></strong>
<ul><li><em>From:</em> Jakub Kicinski</li></ul></li>
<li><strong><a name="05550" href="msg05550.html">[PATCH bpf v4 12/14] selftests/tls: add a bidirectional test</a></strong>
<ul><li><em>From:</em> Jakub Kicinski</li></ul></li>
<li><strong><a name="05549" href="msg05549.html">[PATCH bpf v4 11/14] selftests/tls: test error codes around TLS ULP installation</a></strong>
<ul><li><em>From:</em> Jakub Kicinski</li></ul></li>
<li><strong><a name="05548" href="msg05548.html">[PATCH bpf v4 10/14] selftests/tls: add a test for ULP but no keys</a></strong>
<ul><li><em>From:</em> Jakub Kicinski</li></ul></li>
<li><strong><a name="05547" href="msg05547.html">[PATCH bpf v4 08/14] bpf: sockmap, only create entry if ulp is not already enabled</a></strong>
<ul><li><em>From:</em> Jakub Kicinski</li></ul></li>
<li><strong><a name="05546" href="msg05546.html">[PATCH bpf v4 06/14] bpf: sockmap, sock_map_delete needs to use xchg</a></strong>
<ul><li><em>From:</em> Jakub Kicinski</li></ul></li>
<li><strong><a name="05545" href="msg05545.html">[PATCH bpf v4 03/14] net/tls: remove close callback sock unlock/lock around TX work flush</a></strong>
<ul><li><em>From:</em> Jakub Kicinski</li></ul></li>
<li><strong><a name="05544" href="msg05544.html">[PATCH bpf v4 07/14] bpf: sockmap, synchronize_rcu before free'ing map</a></strong>
<ul><li><em>From:</em> Jakub Kicinski</li></ul></li>
<li><strong><a name="05543" href="msg05543.html">[PATCH bpf v4 04/14] net/tls: remove sock unlock/lock around strp_done()</a></strong>
<ul><li><em>From:</em> Jakub Kicinski</li></ul></li>
<li><strong><a name="05542" href="msg05542.html">[PATCH bpf v4 05/14] net/tls: fix transition through disconnect with close</a></strong>
<ul><li><em>From:</em> Jakub Kicinski</li></ul></li>
<li><strong><a name="05541" href="msg05541.html">[PATCH bpf v4 02/14] net/tls: don't call tls_sk_proto_close for hw record offload</a></strong>
<ul><li><em>From:</em> Jakub Kicinski</li></ul></li>
<li><strong><a name="05540" href="msg05540.html">[PATCH bpf v4 01/14] net/tls: don't arm strparser immediately in tls_set_sw_offload()</a></strong>
<ul><li><em>From:</em> Jakub Kicinski</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg05538.html">Re: [PATCH 2/2] libbpf: Avoid designated initializers for unnamed union members</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg05540.html">[PATCH bpf v4 01/14] net/tls: don't arm strparser immediately in tls_set_sw_offload()</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg05527.html">[GIT PULL 0/2] libbpf build fixes</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg05540.html">[PATCH bpf v4 01/14] net/tls: don't arm strparser immediately in tls_set_sw_offload()</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#05539"><strong>Date</strong></a></li>
<li><a href="index.html#05539"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;Samsung&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-rockchip/>[Linux&nbsp;Rockchip&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-actions/>[Linux&nbsp;Actions&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-snps-arc/>[Linux&nbsp;for&nbsp;Synopsys&nbsp;ARC&nbsp;Processors]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nfs/>[Linux&nbsp;NFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nilfs/>[Linux&nbsp;NILFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/vfl/>[Video&nbsp;for&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<p>
<hr>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

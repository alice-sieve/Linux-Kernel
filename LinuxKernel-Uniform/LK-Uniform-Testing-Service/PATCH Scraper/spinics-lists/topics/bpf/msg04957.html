<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH bpf&#45;next v3 3/6] i40e: add support for AF_XDP need_wakup feature -->
<!--X-From-R13: [ntahf Yneyffba &#60;zntahf.xneyffbaNvagry.pbz> -->
<!--X-Date: Thu, 4 Jul 2019 05:43:20 &#45;0700 -->
<!--X-Message-Id: 1562244134&#45;19069&#45;4&#45;git&#45;send&#45;email&#45;magnus.karlsson@intel.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 1562244134&#45;19069&#45;1&#45;git&#45;send&#45;email&#45;magnus.karlsson@intel.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="BPF: [PATCH bpf-next v3 3/6] i40e: add support for AF_XDP need_wakup feature">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[PATCH bpf-next v3 3/6] i40e: add support for AF_XDP need_wakup feature &mdash; BPF</title>
<link rel="alternate" type="application/rss+xml" title="BPF" href="//feeds.feedburner.com/packetfilters">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH bpf-next v3 3/6] i40e: add support for AF_XDP need_wakup feature</h1>
[<a href="msg04956.html">Date Prev</a>][<a href="msg04958.html">Date Next</a>][<a href="msg04956.html">Thread Prev</a>][<a href="msg04958.html">Thread Next</a>][<a href="maillist.html#04957">Date Index</a>][<a href="index.html#04957">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH bpf-next v3 3/6] i40e: add support for AF_XDP need_wakup feature</li>
<li><em>From</em>: Magnus Karlsson &lt;magnus.karlsson@xxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu,  4 Jul 2019 14:42:11 +0200</li>
<li><em>Cc</em>: bpf@xxxxxxxxxxxxxxx, bruce.richardson@xxxxxxxxx,        ciara.loftus@xxxxxxxxx, jakub.kicinski@xxxxxxxxxxxxx,        xiaolong.ye@xxxxxxxxx, qi.z.zhang@xxxxxxxxx, maximmi@xxxxxxxxxxxx,        sridhar.samudrala@xxxxxxxxx, kevin.laatz@xxxxxxxxx,        ilias.apalodimas@xxxxxxxxxx, kiran.patil@xxxxxxxxx, axboe@xxxxxxxxx,        maciej.fijalkowski@xxxxxxxxx, maciejromanfijalkowski@xxxxxxxxx,        intel-wired-lan@xxxxxxxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg04954.html">1562244134-19069-1-git-send-email-magnus.karlsson@intel.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>This patch adds support for the need_wakeup feature of AF_XDP. If the
application has told the kernel that it might sleep using the new bind
flag XDP_USE_NEED_WAKEUP, the driver will then set this flag if it has
no more buffers on the NIC Rx ring and yield to the application. For
Tx, it will set the flag if it has no outstanding Tx completion
interrupts and return to the application.

Signed-off-by: Magnus Karlsson &lt;magnus.karlsson@xxxxxxxxx&gt;
---
 drivers/net/ethernet/intel/i40e/i40e_xsk.c | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/drivers/net/ethernet/intel/i40e/i40e_xsk.c b/drivers/net/ethernet/intel/i40e/i40e_xsk.c
index d0ff5d8..18de7b6 100644
--- a/drivers/net/ethernet/intel/i40e/i40e_xsk.c
+++ b/drivers/net/ethernet/intel/i40e/i40e_xsk.c
@@ -626,6 +626,15 @@ int i40e_clean_rx_irq_zc(struct i40e_ring *rx_ring, int budget)
 
 	i40e_finalize_xdp_rx(rx_ring, xdp_xmit);
 	i40e_update_rx_stats(rx_ring, total_rx_bytes, total_rx_packets);
+
+	if (xsk_umem_uses_might_sleep(rx_ring-&gt;xsk_umem)) {
+		if (failure || rx_ring-&gt;next_to_clean == rx_ring-&gt;next_to_use)
+			xsk_set_rx_need_wakeup(rx_ring-&gt;xsk_umem);
+		else
+			xsk_clear_rx_need_wakeup(rx_ring-&gt;xsk_umem);
+
+		return (int)total_rx_packets;
+	}
 	return failure ? budget : (int)total_rx_packets;
 }
 
@@ -761,6 +770,13 @@ bool i40e_clean_xdp_tx_irq(struct i40e_vsi *vsi,
 out_xmit:
 	xmit_done = i40e_xmit_zc(tx_ring, budget);
 
+	if (xsk_umem_uses_might_sleep(tx_ring-&gt;xsk_umem)) {
+		if (tx_ring-&gt;next_to_clean == tx_ring-&gt;next_to_use)
+			xsk_set_tx_need_wakeup(tx_ring-&gt;xsk_umem);
+		else
+			xsk_clear_tx_need_wakeup(tx_ring-&gt;xsk_umem);
+	}
+
 	return work_done &amp;&amp; xmit_done;
 }
 
-- 
2.7.4



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="04954" href="msg04954.html">[PATCH bpf-next v3 0/6] add need_wakeup flag to the AF_XDP rings</a></strong>
<ul><li><em>From:</em> Magnus Karlsson</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg04956.html">[PATCH bpf-next v3 2/6] xsk: add support for need_wakeup flag in AF_XDP rings</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg04958.html">[PATCH bpf-next v3 4/6] ixgbe: add support for AF_XDP need_wakup feature</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg04956.html">[PATCH bpf-next v3 2/6] xsk: add support for need_wakeup flag in AF_XDP rings</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg04958.html">[PATCH bpf-next v3 4/6] ixgbe: add support for AF_XDP need_wakup feature</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#04957"><strong>Date</strong></a></li>
<li><a href="index.html#04957"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;Samsung&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-rockchip/>[Linux&nbsp;Rockchip&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-actions/>[Linux&nbsp;Actions&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-snps-arc/>[Linux&nbsp;for&nbsp;Synopsys&nbsp;ARC&nbsp;Processors]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nfs/>[Linux&nbsp;NFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nilfs/>[Linux&nbsp;NILFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/vfl/>[Video&nbsp;for&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<p>
<hr>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

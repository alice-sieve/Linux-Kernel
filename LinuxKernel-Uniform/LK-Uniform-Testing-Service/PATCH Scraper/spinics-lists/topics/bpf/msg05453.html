<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace -->
<!--X-From-R13: Xbry Treanaqrf &#60;wbryNwbrysreanaqrf.bet> -->
<!--X-Date: Tue, 16 Jul 2019 14:30:55 &#45;0700 -->
<!--X-Message-Id: 20190716213050.GA161922@google.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190710141548.132193&#45;1&#45;joel@joelfernandes.org -->
<!--X-Reference: 20190716205455.iimn3pqpvsc3k4ry@ast&#45;mbp.dhcp.thefacebook.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="BPF: Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace &mdash; BPF</title>
<link rel="alternate" type="application/rss+xml" title="BPF" href="//feeds.feedburner.com/packetfilters">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</h1>
[<a href="msg05452.html">Date Prev</a>][<a href="msg05454.html">Date Next</a>][<a href="msg05452.html">Thread Prev</a>][<a href="msg05456.html">Thread Next</a>][<a href="maillist.html#05453">Date Index</a>][<a href="index.html#05453">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</li>
<li><em>From</em>: Joel Fernandes &lt;joel@xxxxxxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 16 Jul 2019 17:30:50 -0400</li>
<li><em>Cc</em>: linux-kernel@xxxxxxxxxxxxxxx,        Adrian Ratiu &lt;adrian.ratiu@xxxxxxxxxxxxx&gt;,        Alexei Starovoitov &lt;ast@xxxxxxxxxx&gt;, bpf@xxxxxxxxxxxxxxx,        Brendan Gregg &lt;brendan.d.gregg@xxxxxxxxx&gt;, connoro@xxxxxxxxxx,        Daniel Borkmann &lt;daniel@xxxxxxxxxxxxx&gt;,        duyuchao &lt;yuchao.du@xxxxxxxxxx&gt;, Ingo Molnar &lt;mingo@xxxxxxxxxx&gt;,        jeffv@xxxxxxxxxx, Karim Yaghmour &lt;karim.yaghmour@xxxxxxxxxxx&gt;,        kernel-team@xxxxxxxxxxx, linux-kselftest@xxxxxxxxxxxxxxx,        Manali Shukla &lt;manalishukla14@xxxxxxxxx&gt;,        Manjo Raja Rao &lt;linux@xxxxxxxxxxxxxxxx&gt;,        Martin KaFai Lau &lt;kafai@xxxxxx&gt;,        Masami Hiramatsu &lt;mhiramat@xxxxxxxxxx&gt;, Matt Mullins &lt;mmullins@xxxxxx&gt;,        Michal Gregorczyk &lt;michalgr@xxxxxx&gt;,        Michal Gregorczyk &lt;michalgr@xxxxxxxx&gt;,        Mohammad Husain &lt;russoue@xxxxxxxxx&gt;, namhyung@xxxxxxxxxx,        namhyung@xxxxxxxxxx, netdev@xxxxxxxxxxxxxxx, paul.chaignon@xxxxxxxxx,        primiano@xxxxxxxxxx, Qais Yousef &lt;qais.yousef@xxxxxxx&gt;,        Shuah Khan &lt;shuah@xxxxxxxxxx&gt;, Song Liu &lt;songliubraving@xxxxxx&gt;,        Srinivas Ramana &lt;sramana@xxxxxxxxxxxxxx&gt;,        Steven Rostedt &lt;rostedt@xxxxxxxxxxx&gt;,        Tamir Carmeli &lt;carmeli.tamir@xxxxxxxxx&gt;, Yonghong Song &lt;yhs@xxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg05452.html">20190716205455.iimn3pqpvsc3k4ry@ast-mbp.dhcp.thefacebook.com</a>&gt;</li>
<li><em>User-agent</em>: Mutt/1.10.1 (2018-07-13)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Tue, Jul 16, 2019 at 01:54:57PM -0700, Alexei Starovoitov wrote:
&gt;<i> On Wed, Jul 10, 2019 at 10:15:44AM -0400, Joel Fernandes (Google) wrote:</i>
&gt;<i> &gt; Hi,</i>
&gt;<i> </i>
&gt;<i> why are you cc-ing the whole world for this patch set?</i>

Well, the whole world happens to be interested in BPF on Android.

&gt;<i> I'll reply to all as well, but I suspect a bunch of folks consider it spam.</i>
&gt;<i> Please read Documentation/bpf/bpf_devel_QA.rst</i>

Ok, I'll read it.

&gt;<i> Also, I think, netdev@vger rejects emails with 80+ characters in cc as spam,</i>
&gt;<i> so I'm not sure this set reached public mailing lists.</i>

Certainly the CC list here is not added to folks who consider it spam. All
the folks added have been interested in BPF on Android at various points of
time. Is this CC list really that large? It has around 24 email addresses or
so. I can trim it a bit if needed. Also, you sound like as if people are
screaming at me to stop emailing them, certainly that's not the case and no
one has told me it is spam.

And, it did reach the public archive btw:
<a  rel="nofollow" href="https://lore.kernel.org/netdev/20190716205455.iimn3pqpvsc3k4ry@xxxxxxxxxxxxxxxxxxxxxxxxxxxx/T/#m1460ba463b78312e38b68b8c118f673d2ead9446">https://lore.kernel.org/netdev/20190716205455.iimn3pqpvsc3k4ry@xxxxxxxxxxxxxxxxxxxxxxxxxxxx/T/#m1460ba463b78312e38b68b8c118f673d2ead9446</a>

&gt;<i> &gt; These patches make it possible to attach BPF programs directly to tracepoints</i>
&gt;<i> &gt; using ftrace (/sys/kernel/debug/tracing) without needing the process doing the</i>
&gt;<i> &gt; attach to be alive. This has the following benefits:</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; 1. Simplified Security: In Android, we have finer-grained security controls to</i>
&gt;<i> &gt; specific ftrace trace events using SELinux labels. We control precisely who is</i>
&gt;<i> &gt; allowed to enable an ftrace event already. By adding a node to ftrace for</i>
&gt;<i> &gt; attaching BPF programs, we can use the same mechanism to further control who is</i>
&gt;<i> &gt; allowed to attach to a trace event.</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; 2. Process lifetime: In Android we are adding usecases where a tracing program</i>
&gt;<i> &gt; needs to be attached all the time to a tracepoint, for the full life time of</i>
&gt;<i> &gt; the system. Such as to gather statistics where there no need for a detach for</i>
&gt;<i> &gt; the full system lifetime. With perf or bpf(2)'s BPF_RAW_TRACEPOINT_OPEN, this</i>
&gt;<i> &gt; means keeping a process alive all the time.  However, in Android our BPF loader</i>
&gt;<i> &gt; currently (for hardeneded security) involves just starting a process at boot</i>
&gt;<i> &gt; time, doing the BPF program loading, and then pinning them to /sys/fs/bpf.  We</i>
&gt;<i> &gt; don't keep this process alive all the time. It is more suitable to do a</i>
&gt;<i> &gt; one-shot attach of the program using ftrace and not need to have a process</i>
&gt;<i> &gt; alive all the time anymore for this. Such process also needs elevated</i>
&gt;<i> &gt; privileges since tracepoint program loading currently requires CAP_SYS_ADMIN</i>
&gt;<i> &gt; anyway so by design Android's bpfloader runs once at init and exits.</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; This series add a new bpf file to /sys/kernel/debug/tracing/events/X/Y/bpf</i>
&gt;<i> &gt; The following commands can be written into it:</i>
&gt;<i> &gt; attach:&lt;fd&gt;     Attaches BPF prog fd to tracepoint</i>
&gt;<i> &gt; detach:&lt;fd&gt;     Detaches BPF prog fd to tracepoint</i>
&gt;<i> </i>
&gt;<i> Looks like, to detach a program the user needs to read a text file,</i>
&gt;<i> parse bpf prog id from text into binary. Then call fd_from_id bpf syscall,</i>
&gt;<i> get a binary FD, convert it back to text and write as a text back into this file.</i>
&gt;<i> I think this is just a single example why text based apis are not accepted</i>
&gt;<i> in bpf anymore.</i>

This can also be considered a tracefs API.

And we can certainly change the detach to accept program ids as well if
that's easier. 'detach:prog:&lt;prog_id&gt;' and 'detach:fd:&lt;fd&gt;'.

By the way, I can also list the set of cumbersome steps needed to attach a
BPF program using perf and I bet it will be longer ;-)

&gt;<i> Through the patch set you call it ftrace. As far as I can see, this set</i>
&gt;<i> has zero overlap with ftrace. There is no ftrace-bpf connection here at all</i>
&gt;<i> that we discussed in the past Steven. It's all quite confusing.</i>

It depends on what you mean by ftrace, may be I can call it 'trace events' or
something if it is less ambiguious. All of this has been collectively called
ftrace before.

I am not sure if you you are making sense actually, trace_events mechanism is
a part of ftrace. See the documentation: Documentation/trace/ftrace.rst. Even
the documentation file name has the word ftrace in it.

I have also spoken to Steven before about this, I don't think he ever told me
there is no connection so again I am a bit lost at your comments.

&gt;<i> I suggest android to solve sticky raw_tracepoint problem with user space deamon.</i>
&gt;<i> The reasons, you point out why user daemon cannot be used, sound weak to me.</i>

I don't think it is weak. It seems overkill to have a daemon for a trace
event that is say supposed to be attached to all the time for the lifetime of
the system. Why should there be a daemon consuming resources if it is active
all the time?

In Android, we are very careful about spawning useless processes and leaving
them alive for the lifetime of the system - for no good reason. Our security
teams also don't like this, and they can comment more.

&gt;<i> Another acceptable solution would be to introduce pinning of raw_tp objects.</i>
&gt;<i> bpf progs and maps can be pinned in bpffs already. Pinning raw_tp would</i>
&gt;<i> be natural extension.</i>

I don't think the pinning solves the security problem, it just solves the
process lifetime problem. Currently, attaching trace events through perf
requires CAP_SYS_ADMIN. However, with ftrace events, we already control
security of events by labeling the nodes in tracefs and granting access to
the labeled context through the selinux policies. Having a 'bpf' node in
tracefs for events, and granting access to the labels is a natural extension.

I also thought about the pinning idea before, but we also want to add support
for not just raw tracepoints, but also regular tracepoints (events if you
will). I am hesitant to add a new BPF API just for creating regular
tracepoints and then pinning those as well.

I don't see why a new bpf node for a trace event is a bad idea, really.
tracefs is how we deal with trace events on Android. We do it in production
systems. This is a natural extension to that and fits with the security model
well.

thanks,

 - Joel






</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="05457" href="msg05457.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
<ul><li><em>From:</em> Steven Rostedt</li></ul></li>
<li><strong><a name="05456" href="msg05456.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
<ul><li><em>From:</em> Alexei Starovoitov</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="05170" href="msg05170.html">[PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
<ul><li><em>From:</em> Joel Fernandes (Google)</li></ul></li>
<li><strong><a name="05452" href="msg05452.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
<ul><li><em>From:</em> Alexei Starovoitov</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg05452.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg05454.html">Re: [PATCH bpf 1/2] selftests/bpf: fix test_verifier/test_maps make dependencies</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg05452.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg05456.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#05453"><strong>Date</strong></a></li>
<li><a href="index.html#05453"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;Samsung&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-rockchip/>[Linux&nbsp;Rockchip&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-actions/>[Linux&nbsp;Actions&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-snps-arc/>[Linux&nbsp;for&nbsp;Synopsys&nbsp;ARC&nbsp;Processors]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nfs/>[Linux&nbsp;NFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nilfs/>[Linux&nbsp;NILFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/vfl/>[Video&nbsp;for&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<p>
<hr>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

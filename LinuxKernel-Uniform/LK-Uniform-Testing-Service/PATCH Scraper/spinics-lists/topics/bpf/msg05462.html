<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH bpf 1/2] selftests/bpf: fix test_verifier/test_maps make dependencies -->
<!--X-From-R13: Oaqevv @nxelvxb &#60;naqevv.anxelvxbNtznvy.pbz> -->
<!--X-Date: Tue, 16 Jul 2019 16:37:22 &#45;0700 -->
<!--X-Message-Id: CAEf4BzY7NYZSGuRHVye_CerZ1BBBLsDyOT2ar5sBXsPGy8g0xA@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190716193837.2808971&#45;1&#45;andriin@fb.com -->
<!--X-Reference: 20190716195544.GB14834@mini&#45;arch -->
<!--X-Reference: CAEf4BzZ4XAdjasYq+JGFHnhwEV3G5UYWBuqKMK1yu1KRLn19MQ@mail.gmail.com -->
<!--X-Reference: 20190716225735.GC14834@mini&#45;arch -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="BPF: Re: [PATCH bpf 1/2] selftests/bpf: fix test_verifier/test_maps make dependencies">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH bpf 1/2] selftests/bpf: fix test_verifier/test_maps make dependencies &mdash; BPF</title>
<link rel="alternate" type="application/rss+xml" title="BPF" href="//feeds.feedburner.com/packetfilters">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH bpf 1/2] selftests/bpf: fix test_verifier/test_maps make dependencies</h1>
[<a href="msg05461.html">Date Prev</a>][<a href="msg05463.html">Date Next</a>][<a href="msg05461.html">Thread Prev</a>][<a href="msg05464.html">Thread Next</a>][<a href="maillist.html#05462">Date Index</a>][<a href="index.html#05462">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH bpf 1/2] selftests/bpf: fix test_verifier/test_maps make dependencies</li>
<li><em>From</em>: Andrii Nakryiko &lt;andrii.nakryiko@xxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 16 Jul 2019 16:37:08 -0700</li>
<li><em>Cc</em>: Andrii Nakryiko &lt;andriin@xxxxxx&gt;, bpf &lt;bpf@xxxxxxxxxxxxxxx&gt;,        Networking &lt;netdev@xxxxxxxxxxxxxxx&gt;,        Daniel Borkmann &lt;daniel@xxxxxxxxxxxxx&gt;,        Alexei Starovoitov &lt;ast@xxxxxx&gt;, Kernel Team &lt;kernel-team@xxxxxx&gt;,        Ilya Leoshkevich &lt;iii@xxxxxxxxxxxxx&gt;,        Stanislav Fomichev &lt;sdf@xxxxxxxxxx&gt;, Martin KaFai Lau &lt;kafai@xxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;20190716225735.GC14834@mini-arch&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Tue, Jul 16, 2019 at 3:57 PM Stanislav Fomichev &lt;sdf@xxxxxxxxxxx&gt; wrote:
&gt;<i></i>
&gt;<i> On 07/16, Andrii Nakryiko wrote:</i>
&gt;<i> &gt; On Tue, Jul 16, 2019 at 12:55 PM Stanislav Fomichev &lt;sdf@xxxxxxxxxxx&gt; wrote:</i>
&gt;<i> &gt; &gt;</i>
&gt;<i> &gt; &gt; On 07/16, Andrii Nakryiko wrote:</i>
&gt;<i> &gt; &gt; &gt; e46fc22e60a4 (&quot;selftests/bpf: make directory prerequisites order-only&quot;)</i>
&gt;<i> &gt; &gt; &gt; exposed existing problem in Makefile for test_verifier and test_maps tests:</i>
&gt;<i> &gt; &gt; &gt; their dependency on auto-generated header file with a list of all tests wasn't</i>
&gt;<i> &gt; &gt; &gt; recorded explicitly. This patch fixes these issues.</i>
&gt;<i> &gt; &gt; Why adding it explicitly fixes it? At least for test_verifier, we have</i>
&gt;<i> &gt; &gt; the following rule:</i>
&gt;<i> &gt; &gt;</i>
&gt;<i> &gt; &gt;         test_verifier.c: $(VERIFIER_TESTS_H)</i>
&gt;<i> &gt; &gt;</i>
&gt;<i> &gt; &gt; And there should be implicit/builtin test_verifier -&gt; test_verifier.c</i>
&gt;<i> &gt; &gt; dependency rule.</i>
&gt;<i> &gt; &gt;</i>
&gt;<i> &gt; &gt; Same for maps, I guess:</i>
&gt;<i> &gt; &gt;</i>
&gt;<i> &gt; &gt;         $(OUTPUT)/test_maps: map_tests/*.c</i>
&gt;<i> &gt; &gt;         test_maps.c: $(MAP_TESTS_H)</i>
&gt;<i> &gt; &gt;</i>
&gt;<i> &gt; &gt; So why is it not working as is? What I'm I missing?</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; I don't know exactly why it's not working, but it's clearly because of</i>
&gt;<i> &gt; that. It's the only difference between how test_progs are set up,</i>
&gt;<i> &gt; which didn't break, and test_maps/test_verifier, which did.</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; Feel free to figure it out through a maze of Makefiles why it didn't</i>
&gt;<i> &gt; work as expected, but this definitely fixed a breakage (at least for</i>
&gt;<i> &gt; me).</i>
&gt;<i> Agreed on not wasting time. I took a brief look (with make -qp) and I</i>
&gt;<i> don't have any clue.</i>

Oh, -qp is cool, noted :)

&gt;<i></i>
&gt;<i> By default implicit matching doesn't work:</i>
&gt;<i> # makefile (from 'Makefile', line 261)</i>
&gt;<i> /linux/tools/testing/selftests/bpf/test_maps: CFLAGS += $(TEST_MAPS_CFLAGS)</i>
&gt;<i> /linux/tools/testing/selftests/bpf/test_maps: map_tests/sk_storage_map.c /linux/tools/testing/selftests/bpf/test_stub.o /linux/tools/testing/selftests/bpf/libbpf.a</i>
&gt;<i> #  Implicit rule search has not been done.</i>
&gt;<i> #  File is an intermediate prerequisite.</i>
&gt;<i> #  Modification time never checked.</i>
&gt;<i> #  File has not been updated.</i>
&gt;<i> # variable set hash-table stats:</i>
&gt;<i> # Load=1/32=3%, Rehash=0, Collisions=0/2=0%</i>
&gt;<i></i>
&gt;<i> If I comment out the following line:</i>
&gt;<i> $(TEST_GEN_PROGS): $(OUTPUT)/test_stub.o $(BPFOBJ)</i>
&gt;<i></i>
&gt;<i> Then it works:</i>
&gt;<i> # makefile (from 'Makefile', line 261)</i>
&gt;<i> /linux/tools/testing/selftests/bpf/test_maps: CFLAGS += $(TEST_MAPS_CFLAGS)</i>
&gt;<i> /linux/tools/testing/selftests/bpf/test_maps: test_maps.c map_tests/sk_storage_map.c</i>
&gt;<i> #  Implicit rule search has been done.</i>
&gt;<i> #  Implicit/static pattern stem: 'test_maps'</i>
&gt;<i> #  File is an intermediate prerequisite.</i>
&gt;<i> #  File does not exist.</i>
&gt;<i> #  File has not been updated.</i>
&gt;<i> # variable set hash-table stats:</i>
&gt;<i> # Load=1/32=3%, Rehash=0, Collisions=0/2=0%</i>
&gt;<i> #  recipe to execute (from '../lib.mk', line 138):</i>
&gt;<i>         $(LINK.c) $^ $(LDLIBS) -o $@</i>
&gt;<i></i>
&gt;<i> It's because &quot;File is an intermediate prerequisite.&quot;, but I</i>
&gt;<i> don't see how it's is a intermediate prerequisite for anything...</i>

Well, it's &quot;File is an intermediate prerequisite.&quot; in both cases, so I
don't know if that's it.
Makefiles is not my strong suit, honestly, and definitely not an area
of passion, so no idea

&gt;<i></i>
&gt;<i></i>
&gt;<i> One other optional suggestion I have to your second patch: maybe drop all</i>
&gt;<i> those dependencies on the directories altogether? Why not do the following</i>
&gt;<i> instead, for example (same for test_progs/test_maps)?</i>

Some of those _TEST_DIR's are dependencies of multiple targets, so
you'd need to replicate that `mkdir -p $@` in multiple places, which
is annoying.

But I also don't think we need to worry about creating them, because
there is always at least one test (otherwise those tests are useless
anyways) in those directories, so we might as well just remove those
dependencies, I guess.

TBH, those explicit dependencies are good to specify anyways, so I
think this fix is good. Second patch just makes the layout of
dependencies similar, so it's easier to spot differences like this
one.

As usual, I'll let Alexei and Daniel decide which one to apply (or if
we need to take some other approach to fixing this).


&gt;<i></i>
&gt;<i> diff --git a/tools/testing/selftests/bpf/Makefile b/tools/testing/selftests/bpf/Makefile</i>
&gt;<i> index 1296253b3422..c2d087ce6d4b 100644</i>
&gt;<i> --- a/tools/testing/selftests/bpf/Makefile</i>
&gt;<i> +++ b/tools/testing/selftests/bpf/Makefile</i>
&gt;<i> @@ -277,12 +277,9 @@ VERIFIER_TESTS_H := $(OUTPUT)/verifier/tests.h</i>
&gt;<i>  test_verifier.c: $(VERIFIER_TESTS_H)</i>
&gt;<i>  $(OUTPUT)/test_verifier: CFLAGS += $(TEST_VERIFIER_CFLAGS)</i>
&gt;<i></i>
&gt;<i> -VERIFIER_TESTS_DIR = $(OUTPUT)/verifier</i>
&gt;<i> -$(VERIFIER_TESTS_DIR):</i>
&gt;<i> -       mkdir -p $@</i>
&gt;<i> -</i>
&gt;<i>  VERIFIER_TEST_FILES := $(wildcard verifier/*.c)</i>
&gt;<i> -$(OUTPUT)/verifier/tests.h: $(VERIFIER_TEST_FILES) | $(VERIFIER_TESTS_DIR)</i>
&gt;<i> +$(OUTPUT)/verifier/tests.h: $(VERIFIER_TEST_FILES)</i>
&gt;<i> +       mkdir -p $(dir $@)</i>
&gt;<i>         $(shell ( cd verifier/; \</i>
&gt;<i>                   echo '/* Generated header, do not edit */'; \</i>
&gt;<i>                   echo '#ifdef FILL_ARRAY'; \</i>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="05464" href="msg05464.html">Re: [PATCH bpf 1/2] selftests/bpf: fix test_verifier/test_maps make dependencies</a></strong>
<ul><li><em>From:</em> Stanislav Fomichev</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="05447" href="msg05447.html">[PATCH bpf 1/2] selftests/bpf: fix test_verifier/test_maps make dependencies</a></strong>
<ul><li><em>From:</em> Andrii Nakryiko</li></ul></li>
<li><strong><a name="05451" href="msg05451.html">Re: [PATCH bpf 1/2] selftests/bpf: fix test_verifier/test_maps make dependencies</a></strong>
<ul><li><em>From:</em> Stanislav Fomichev</li></ul></li>
<li><strong><a name="05454" href="msg05454.html">Re: [PATCH bpf 1/2] selftests/bpf: fix test_verifier/test_maps make dependencies</a></strong>
<ul><li><em>From:</em> Andrii Nakryiko</li></ul></li>
<li><strong><a name="05461" href="msg05461.html">Re: [PATCH bpf 1/2] selftests/bpf: fix test_verifier/test_maps make dependencies</a></strong>
<ul><li><em>From:</em> Stanislav Fomichev</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg05461.html">Re: [PATCH bpf 1/2] selftests/bpf: fix test_verifier/test_maps make dependencies</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg05463.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg05461.html">Re: [PATCH bpf 1/2] selftests/bpf: fix test_verifier/test_maps make dependencies</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg05464.html">Re: [PATCH bpf 1/2] selftests/bpf: fix test_verifier/test_maps make dependencies</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#05462"><strong>Date</strong></a></li>
<li><a href="index.html#05462"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;Samsung&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-rockchip/>[Linux&nbsp;Rockchip&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-actions/>[Linux&nbsp;Actions&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-snps-arc/>[Linux&nbsp;for&nbsp;Synopsys&nbsp;ARC&nbsp;Processors]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nfs/>[Linux&nbsp;NFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nilfs/>[Linux&nbsp;NILFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/vfl/>[Video&nbsp;for&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<p>
<hr>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

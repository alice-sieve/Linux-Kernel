<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH V2 1/1 (was 0/1 by accident)] tools/dtrace: initial implementation of DTrace -->
<!--X-From-R13: Rnavry Pbexznaa &#60;qnavryNvbtrneobk.arg> -->
<!--X-Date: Wed, 10 Jul 2019 12:32:32 &#45;0700 -->
<!--X-Message-Id: c7f15d1d&#45;1696&#45;4d95&#45;1729&#45;4c4e97bdc43e@iogearbox.net -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 201907101537.x6AFboMR015946@aserv0122.oracle.com -->
<!--X-Reference: 201907101542.x6AFgOO9012232@userv0121.oracle.com -->
<!--X-Reference: 20190710181227.GA9925@oracle.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="BPF: Re: [PATCH V2 1/1 (was 0/1 by accident)] tools/dtrace: initial implementation of DTrace">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH V2 1/1 (was 0/1 by accident)] tools/dtrace: initial implementation of DTrace &mdash; BPF</title>
<link rel="alternate" type="application/rss+xml" title="BPF" href="//feeds.feedburner.com/packetfilters">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH V2 1/1 (was 0/1 by accident)] tools/dtrace: initial implementation of DTrace</h1>
[<a href="msg05189.html">Date Prev</a>][<a href="msg05191.html">Date Next</a>][<a href="msg05184.html">Thread Prev</a>][<a href="msg05193.html">Thread Next</a>][<a href="maillist.html#05190">Date Index</a>][<a href="index.html#05190">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH V2 1/1 (was 0/1 by accident)] tools/dtrace: initial implementation of DTrace</li>
<li><em>From</em>: Daniel Borkmann &lt;daniel@xxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Wed, 10 Jul 2019 21:32:25 +0200</li>
<li><em>Cc</em>: netdev@xxxxxxxxxxxxxxx, bpf@xxxxxxxxxxxxxxx,        dtrace-devel@xxxxxxxxxxxxxx, linux-kernel@xxxxxxxxxxxxxxx,        rostedt@xxxxxxxxxxx, mhiramat@xxxxxxxxxx, acme@xxxxxxxxxx,        ast@xxxxxxxxxx, Peter Zijlstra &lt;peterz@xxxxxxxxxxxxx&gt;,        Chris Mason &lt;clm@xxxxxx&gt;, brendan.d.gregg@xxxxxxxxx,        davem@xxxxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg05184.html">20190710181227.GA9925@oracle.com</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Thunderbird/52.3.0</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Hello Kris,

On 07/10/2019 08:12 PM, Kris Van Hees wrote:
&gt;<i> This patch's subject should of course be [PATCH V2 1/1] rather than 0/1.</i>
&gt;<i> Sorry about that.</i>
&gt;<i> </i>
&gt;<i> On Wed, Jul 10, 2019 at 08:42:24AM -0700, Kris Van Hees wrote:</i>
&gt;<i>&gt; This initial implementation of a tiny subset of DTrace functionality</i>
&gt;<i>&gt; provides the following options:</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; 	dtrace [-lvV] [-b bufsz] -s script</i>
&gt;<i>&gt; 	    -b  set trace buffer size</i>
&gt;<i>&gt; 	    -l  list probes (only works with '-s script' for now)</i>
&gt;<i>&gt; 	    -s  enable or list probes for the specified BPF program</i>
&gt;<i>&gt; 	    -V  report DTrace API version</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; The patch comprises quite a bit of code due to DTrace requiring a few</i>
&gt;<i>&gt; crucial components, even in its most basic form.</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; The code is structured around the command line interface implemented in</i>
&gt;<i>&gt; dtrace.c.  It provides option parsing and drives the three modes of</i>
&gt;<i>&gt; operation that are currently implemented:</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; 1. Report DTrace API version information.</i>
&gt;<i>&gt; 	Report the version information and terminate.</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; 2. List probes in BPF programs.</i>
&gt;<i>&gt; 	Initialize the list of probes that DTrace recognizes, load BPF</i>
&gt;<i>&gt; 	programs, parse all BPF ELF section names, resolve them into</i>
&gt;<i>&gt; 	known probes, and emit the probe names.  Then terminate.</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; 3. Load BPF programs and collect tracing data.</i>
&gt;<i>&gt; 	Initialize the list of probes that DTrace recognizes, load BPF</i>
&gt;<i>&gt; 	programs and attach them to their corresponding probes, set up</i>
&gt;<i>&gt; 	perf event output buffers, and start processing tracing data.</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; This implementation makes extensive use of BPF (handled by dt_bpf.c) and</i>
&gt;<i>&gt; the perf event output ring buffer (handled by dt_buffer.c).  DTrace-style</i>
&gt;<i>&gt; probe handling (dt_probe.c) offers an interface to probes that hides the</i>
&gt;<i>&gt; implementation details of the individual probe types by provider (dt_fbt.c</i>
&gt;<i>&gt; and dt_syscall.c).  Probe lookup by name uses a hashtable implementation</i>
&gt;<i>&gt; (dt_hash.c).  The dt_utils.c code populates a list of online CPU ids, so</i>
&gt;<i>&gt; we know what CPUs we can obtain tracing data from.</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; Building the tool is trivial because its only dependency (libbpf) is in</i>
&gt;<i>&gt; the kernel tree under tools/lib/bpf.  A simple 'make' in the tools/dtrace</i>
&gt;<i>&gt; directory suffices.</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; The 'dtrace' executable needs to run as root because BPF programs cannot</i>
&gt;<i>&gt; be loaded by non-root users.</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; Signed-off-by: Kris Van Hees &lt;kris.van.hees@xxxxxxxxxx&gt;</i>
&gt;<i>&gt; Reviewed-by: David Mc Lean &lt;david.mclean@xxxxxxxxxx&gt;</i>
&gt;<i>&gt; Reviewed-by: Eugene Loh &lt;eugene.loh@xxxxxxxxxx&gt;</i>
&gt;<i>&gt; ---</i>
&gt;<i>&gt; Changes in v2:</i>
&gt;<i>&gt;         - Use ring_buffer_read_head() and ring_buffer_write_tail() to</i>
&gt;<i>&gt;           avoid use of volatile.</i>
&gt;<i>&gt;         - Handle perf events that wrap around the ring buffer boundary.</i>
&gt;<i>&gt;         - Remove unnecessary PERF_EVENT_IOC_ENABLE.</i>
&gt;<i>&gt;         - Remove -I$(srctree)/tools/perf from KBUILD_HOSTCFLAGS since it</i>
&gt;<i>&gt;           is not actually used.</i>
&gt;<i>&gt;         - Use PT_REGS_PARM1(x), etc instead of my own macros.  Adding </i>
&gt;<i>&gt;           PT_REGS_PARM6(x) in bpf_sample.c because we need to be able to</i>
&gt;<i>&gt;           support up to 6 arguments passed by registers.</i>

Looks like you missed Brendan Gregg's prior feedback from v1 [0]. I haven't
seen a strong compelling argument for why this needs to reside in the kernel
tree given we also have all the other tracing tools and many of which also
rely on BPF such as bcc, bpftrace, ply, systemtap, sysdig, lttng to just name
a few. Given all the other tracers manage to live outside the kernel tree just
fine, so can dtrace as well; it's _not_ special in this regard in any way. It
will be tons of code in long term which is better off in its separate project,
and if we add tools/dtrace/, other projects will come as well asking for kernel
tree inclusion 'because tools/dtrace' is now there, too. While it totally makes
sense to extend the missing kernel bits where needed, it doesn't make sense to
have another big tracing project similar to perf in the tree. Therefore, I'm
not applying this patch, sorry.

Thanks,
Daniel

  [0] <a  rel="nofollow" href="https://lore.kernel.org/bpf/CAE40pdeSfJBpbBHTmwz1xZ+MW02=kJ0krq1mN+EkjSLqf2GX_w@xxxxxxxxxxxxxx/">https://lore.kernel.org/bpf/CAE40pdeSfJBpbBHTmwz1xZ+MW02=kJ0krq1mN+EkjSLqf2GX_w@xxxxxxxxxxxxxx/</a>

&gt;<i>&gt; ---</i>
&gt;<i>&gt;  MAINTAINERS                |   6 +</i>
&gt;<i>&gt;  tools/dtrace/Makefile      |  87 ++++++++++</i>
&gt;<i>&gt;  tools/dtrace/bpf_sample.c  | 146 ++++++++++++++++</i>
&gt;<i>&gt;  tools/dtrace/dt_bpf.c      | 185 ++++++++++++++++++++</i>
&gt;<i>&gt;  tools/dtrace/dt_buffer.c   | 338 +++++++++++++++++++++++++++++++++++++</i>
&gt;<i>&gt;  tools/dtrace/dt_fbt.c      | 201 ++++++++++++++++++++++</i>
&gt;<i>&gt;  tools/dtrace/dt_hash.c     | 211 +++++++++++++++++++++++</i>
&gt;<i>&gt;  tools/dtrace/dt_probe.c    | 230 +++++++++++++++++++++++++</i>
&gt;<i>&gt;  tools/dtrace/dt_syscall.c  | 179 ++++++++++++++++++++</i>
&gt;<i>&gt;  tools/dtrace/dt_utils.c    | 132 +++++++++++++++</i>
&gt;<i>&gt;  tools/dtrace/dtrace.c      | 249 +++++++++++++++++++++++++++</i>
&gt;<i>&gt;  tools/dtrace/dtrace.h      |  13 ++</i>
&gt;<i>&gt;  tools/dtrace/dtrace_impl.h | 101 +++++++++++</i>
&gt;<i>&gt;  13 files changed, 2078 insertions(+)</i>
&gt;<i>&gt;  create mode 100644 tools/dtrace/Makefile</i>
&gt;<i>&gt;  create mode 100644 tools/dtrace/bpf_sample.c</i>
&gt;<i>&gt;  create mode 100644 tools/dtrace/dt_bpf.c</i>
&gt;<i>&gt;  create mode 100644 tools/dtrace/dt_buffer.c</i>
&gt;<i>&gt;  create mode 100644 tools/dtrace/dt_fbt.c</i>
&gt;<i>&gt;  create mode 100644 tools/dtrace/dt_hash.c</i>
&gt;<i>&gt;  create mode 100644 tools/dtrace/dt_probe.c</i>
&gt;<i>&gt;  create mode 100644 tools/dtrace/dt_syscall.c</i>
&gt;<i>&gt;  create mode 100644 tools/dtrace/dt_utils.c</i>
&gt;<i>&gt;  create mode 100644 tools/dtrace/dtrace.c</i>
&gt;<i>&gt;  create mode 100644 tools/dtrace/dtrace.h</i>
&gt;<i>&gt;  create mode 100644 tools/dtrace/dtrace_impl.h</i>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="05195" href="msg05195.html">Re: [PATCH V2 1/1 (was 0/1 by accident)] tools/dtrace: initial implementation of DTrace</a></strong>
<ul><li><em>From:</em> Jonathan Corbet</li></ul></li>
<li><strong><a name="05193" href="msg05193.html">Re: [PATCH V2 1/1 (was 0/1 by accident)] tools/dtrace: initial implementation of DTrace</a></strong>
<ul><li><em>From:</em> Steven Rostedt</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="05175" href="msg05175.html">[PATCH V2 0/1] tools/dtrace: initial implementation of DTrace</a></strong>
<ul><li><em>From:</em> Kris Van Hees</li></ul></li>
<li><strong><a name="05176" href="msg05176.html">[PATCH V2 0/1] tools/dtrace: initial implementation of DTrace</a></strong>
<ul><li><em>From:</em> Kris Van Hees</li></ul></li>
<li><strong><a name="05184" href="msg05184.html">Re: [PATCH V2 1/1 (was 0/1 by accident)] tools/dtrace: initial implementation of DTrace</a></strong>
<ul><li><em>From:</em> Kris Van Hees</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg05189.html">Re: [PATCH bpf-next v9 0/2] bpf: Allow bpf_skb_event_output for more prog types</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg05191.html">Re: [bpf PATCH v2 2/6] bpf: tls fix transition through disconnect with close</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg05184.html">Re: [PATCH V2 1/1 (was 0/1 by accident)] tools/dtrace: initial implementation of DTrace</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg05193.html">Re: [PATCH V2 1/1 (was 0/1 by accident)] tools/dtrace: initial implementation of DTrace</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#05190"><strong>Date</strong></a></li>
<li><a href="index.html#05190"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;Samsung&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-rockchip/>[Linux&nbsp;Rockchip&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-actions/>[Linux&nbsp;Actions&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-snps-arc/>[Linux&nbsp;for&nbsp;Synopsys&nbsp;ARC&nbsp;Processors]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nfs/>[Linux&nbsp;NFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nilfs/>[Linux&nbsp;NILFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/vfl/>[Video&nbsp;for&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<p>
<hr>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

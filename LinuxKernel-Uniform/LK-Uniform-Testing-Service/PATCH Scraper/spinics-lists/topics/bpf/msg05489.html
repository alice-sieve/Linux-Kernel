<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH bpf] bpf: fix narrower loads on s390 -->
<!--X-From-R13: K Ebat &#60;lf114321Ntznvy.pbz> -->
<!--X-Date: Wed, 17 Jul 2019 15:24:17 &#45;0700 -->
<!--X-Message-Id: CAH3MdRUXJBf5qQFkUZ5x3X=ziXE8Ou7O1cH_WJvyXVpEtQQ0nQ@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190716115910.23093&#45;1&#45;iii@linux.ibm.com -->
<!--X-Reference: CAH3MdRWGVDjW8cA9EbnFjK8ko1EqeyDyC_LoRTsxhLsYn1fZtw@mail.gmail.com -->
<!--X-Reference: CAH3MdRU&#45;u1Gn6uj2D=mzXvdC2RDWas3Ec0QXObKsLac1GwuREQ@mail.gmail.com -->
<!--X-Reference: 98C6AA13&#45;A44D&#45;4FF1&#45;BA73&#45;1BD446BD773A@linux.ibm.com -->
<!--X-Reference: 4311B5C3&#45;8D1B&#45;4958&#45;9CDE&#45;450662A7851D@linux.ibm.com -->
<!--X-Reference: CAH3MdRV&#45;qsJnyZVV1GnxRZ4=3KXTvKSgETp90fyevxycmAiHmA@mail.gmail.com -->
<!--X-Reference: B91434A8&#45;6056&#45;49E2&#45;852D&#45;6DE5FFD53B29@linux.ibm.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="BPF: Re: [PATCH bpf] bpf: fix narrower loads on s390">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH bpf] bpf: fix narrower loads on s390 &mdash; BPF</title>
<link rel="alternate" type="application/rss+xml" title="BPF" href="//feeds.feedburner.com/packetfilters">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH bpf] bpf: fix narrower loads on s390</h1>
[<a href="msg05488.html">Date Prev</a>][<a href="msg05490.html">Date Next</a>][<a href="msg05487.html">Thread Prev</a>][<a href="msg05435.html">Thread Next</a>][<a href="maillist.html#05489">Date Index</a>][<a href="index.html#05489">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH bpf] bpf: fix narrower loads on s390</li>
<li><em>From</em>: Y Song &lt;ys114321@xxxxxxxxx&gt;</li>
<li><em>Date</em>: Wed, 17 Jul 2019 15:23:32 -0700</li>
<li><em>Cc</em>: bpf &lt;bpf@xxxxxxxxxxxxxxx&gt;, netdev &lt;netdev@xxxxxxxxxxxxxxx&gt;,        gor@xxxxxxxxxxxxx, heiko.carstens@xxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg05487.html">B91434A8-6056-49E2-852D-6DE5FFD53B29@linux.ibm.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Wed, Jul 17, 2019 at 1:52 PM Ilya Leoshkevich &lt;iii@xxxxxxxxxxxxx&gt; wrote:
&gt;<i></i>
&gt;<i> &gt; Am 17.07.2019 um 18:25 schrieb Y Song &lt;ys114321@xxxxxxxxx&gt;:</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; On Wed, Jul 17, 2019 at 3:36 AM Ilya Leoshkevich &lt;iii@xxxxxxxxxxxxx&gt; wrote:</i>
&gt;<i> &gt;&gt;</i>
&gt;<i> &gt;&gt;</i>
&gt;<i> &gt;&gt; Here is a better one: len=0x11223344 and we would like to do</i>
&gt;<i> &gt;&gt; ((u8 *)&amp;len)[3].</i>
&gt;<i> &gt;&gt;</i>
&gt;<i> &gt;&gt; len is represented as `11 22 33 44` in memory, so the desired result is</i>
&gt;<i> &gt;&gt; 0x44. It can be obtained by doing (*(u32 *)&amp;len) &amp; 0xff, but today the</i>
&gt;<i> &gt;&gt; verifier does ((*(u32 *)&amp;len) &gt;&gt; 24) &amp; 0xff instead.</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; What you described above for the memory layout all makes sense.</i>
&gt;<i> &gt; The root cause is for big endian, we should do *((u8 *)&amp;len + 3).</i>
&gt;<i> &gt; This is exactly what macros in test_pkt_md_access.c tries to do.</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; if  __BYTE_ORDER__ == __ORDER_LITTLE_ENDIAN__</i>
&gt;<i> &gt; #define TEST_FIELD(TYPE, FIELD, MASK)                                   \</i>
&gt;<i> &gt;        {                                                               \</i>
&gt;<i> &gt;                TYPE tmp = *(volatile TYPE *)&amp;skb-&gt;FIELD;               \</i>
&gt;<i> &gt;                if (tmp != ((*(volatile __u32 *)&amp;skb-&gt;FIELD) &amp; MASK))   \</i>
&gt;<i> &gt;                        return TC_ACT_SHOT;                             \</i>
&gt;<i> &gt;        }</i>
&gt;<i> &gt; #else</i>
&gt;<i> &gt; #define TEST_FIELD_OFFSET(a, b) ((sizeof(a) - sizeof(b)) / sizeof(b))</i>
&gt;<i> &gt; #define TEST_FIELD(TYPE, FIELD, MASK)                                   \</i>
&gt;<i> &gt;        {                                                               \</i>
&gt;<i> &gt;                TYPE tmp = *((volatile TYPE *)&amp;skb-&gt;FIELD +             \</i>
&gt;<i> &gt;                              TEST_FIELD_OFFSET(skb-&gt;FIELD, TYPE));     \</i>
&gt;<i> &gt;                if (tmp != ((*(volatile __u32 *)&amp;skb-&gt;FIELD) &amp; MASK))   \</i>
&gt;<i> &gt;                        return TC_ACT_SHOT;                             \</i>
&gt;<i> &gt;        }</i>
&gt;<i> &gt; #endif</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; Could you check whether your __BYTE_ORDER__ is set</i>
&gt;<i> &gt; correctly or not for this case? You may need to tweak Makefile</i>
&gt;<i> &gt; if you are doing cross compilation, I am not sure how as I</i>
&gt;<i> &gt; did not have environment.</i>
&gt;<i></i>
&gt;<i> I&#x2019;m building natively on s390.</i>
&gt;<i></i>
&gt;<i> Here is the (formatted) preprocessed C code for the first condition:</i>
&gt;<i></i>
&gt;<i> {</i>
&gt;<i>         __u8 tmp = *((volatile __u8 *)&amp;skb-&gt;len +</i>
&gt;<i>                 ((sizeof(skb-&gt;len) - sizeof(__u8)) / sizeof(__u8)));</i>
&gt;<i>         if (tmp != ((*(volatile __u32 *)&amp;skb-&gt;len) &amp; 0xFF)) return 2;</i>
&gt;<i> };</i>
&gt;<i></i>
&gt;<i> So I believe the endianness is chosen correctly.</i>
&gt;<i></i>
&gt;<i> Here is the clang-generated BPF bytecode for the first condition:</i>
&gt;<i></i>
&gt;<i> # llvm-objdump -d test_pkt_md_access.o</i>
&gt;<i> 0000000000000000 process:</i>
&gt;<i>        0:       71 21 00 03 00 00 00 00 r2 = *(u8 *)(r1 + 3)</i>
&gt;<i>        1:       61 31 00 00 00 00 00 00 r3 = *(u32 *)(r1 + 0)</i>
&gt;<i>        2:       57 30 00 00 00 00 00 ff r3 &amp;= 255</i>
&gt;<i>        3:       5d 23 00 1d 00 00 00 00 if r2 != r3 goto +29 &lt;LBB0_10&gt;</i>
&gt;<i></i>
&gt;<i> This also looks good to me.</i>
&gt;<i></i>
&gt;<i> Finally, here is the verifier-generated BPF bytecode:</i>
&gt;<i></i>
&gt;<i> # bpftool prog dump xlated id 14</i>
&gt;<i> ; TEST_FIELD(__u8,  len, 0xFF);</i>
&gt;<i>    0: (61) r2 = *(u32 *)(r1 +104)</i>
&gt;<i>    1: (bc) w2 = w2</i>
&gt;<i>    2: (74) w2 &gt;&gt;= 24</i>
&gt;<i>    3: (bc) w2 = w2</i>
&gt;<i>    4: (54) w2 &amp;= 255</i>
&gt;<i>    5: (bc) w2 = w2</i>
&gt;<i></i>
&gt;<i> Here we can see the shift that I'm referring to. I believe we should</i>
&gt;<i> translate *(u8 *)(r1 + 3) in this case without this shift on big-endian</i>
&gt;<i> machines.</i>

Thanks for the detailed illustration.
Now, with your detailed output of byte codes and xlated program, it
indeed becomes apparent
that verifier should not do shift at insn 2.

I was correct that after insn 0, register r2 should hold the same
value for big and little endian.
But I missed the fact in the first review that insn-&gt;off for original
first insn is different.
r2 = *(u8 *)(r1 + 3), the first insn on big endian, and r2 = *(u8 *)r1
for little endian.
They should really have the same shift amount.

Therefore, indeed, shifting amount is actually different between big
and little endians.
So your code is correct. Could you add a macro in linux/filter.h? Most
narrow load related
macros are there? This way, we maintain verifier.c __BYTE_ORDER__ macro free.

Also, could you put your above analysis in the commit message? This will help
reasoning the change easily later on.

Thanks!

&gt;<i></i>
&gt;<i> Best regards,</i>
&gt;<i> Ilya</i>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="05434" href="msg05434.html">[PATCH bpf] bpf: fix narrower loads on s390</a></strong>
<ul><li><em>From:</em> Ilya Leoshkevich</li></ul></li>
<li><strong><a name="05476" href="msg05476.html">Re: [PATCH bpf] bpf: fix narrower loads on s390</a></strong>
<ul><li><em>From:</em> Y Song</li></ul></li>
<li><strong><a name="05477" href="msg05477.html">Re: [PATCH bpf] bpf: fix narrower loads on s390</a></strong>
<ul><li><em>From:</em> Y Song</li></ul></li>
<li><strong><a name="05481" href="msg05481.html">Re: [PATCH bpf] bpf: fix narrower loads on s390</a></strong>
<ul><li><em>From:</em> Ilya Leoshkevich</li></ul></li>
<li><strong><a name="05483" href="msg05483.html">Re: [PATCH bpf] bpf: fix narrower loads on s390</a></strong>
<ul><li><em>From:</em> Ilya Leoshkevich</li></ul></li>
<li><strong><a name="05486" href="msg05486.html">Re: [PATCH bpf] bpf: fix narrower loads on s390</a></strong>
<ul><li><em>From:</em> Y Song</li></ul></li>
<li><strong><a name="05487" href="msg05487.html">Re: [PATCH bpf] bpf: fix narrower loads on s390</a></strong>
<ul><li><em>From:</em> Ilya Leoshkevich</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg05488.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg05490.html">Re: [PATCH AUTOSEL 5.2 226/249] selftests: bpf: fix inlines in test_lwt_seg6local</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg05487.html">Re: [PATCH bpf] bpf: fix narrower loads on s390</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg05435.html">[PATCH bpf] selftests/bpf: fix perf_buffer on s390</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#05489"><strong>Date</strong></a></li>
<li><a href="index.html#05489"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;Samsung&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-rockchip/>[Linux&nbsp;Rockchip&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-actions/>[Linux&nbsp;Actions&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-snps-arc/>[Linux&nbsp;for&nbsp;Synopsys&nbsp;ARC&nbsp;Processors]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nfs/>[Linux&nbsp;NFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nilfs/>[Linux&nbsp;NILFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/vfl/>[Video&nbsp;for&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<p>
<hr>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH AUTOSEL 5.2 189/249] net/mlx5e: Attach/detach XDP program safely -->
<!--X-From-R13: Enfun Zriva &#60;fnfunyNxreary.bet> -->
<!--X-Date: Mon, 15 Jul 2019 06:58:24 &#45;0700 -->
<!--X-Message-Id: 20190715134655.4076&#45;189&#45;sashal@kernel.org -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190715134655.4076&#45;1&#45;sashal@kernel.org -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="BPF: [PATCH AUTOSEL 5.2 189/249] net/mlx5e: Attach/detach XDP program safely">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[PATCH AUTOSEL 5.2 189/249] net/mlx5e: Attach/detach XDP program safely &mdash; BPF</title>
<link rel="alternate" type="application/rss+xml" title="BPF" href="//feeds.feedburner.com/packetfilters">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH AUTOSEL 5.2 189/249] net/mlx5e: Attach/detach XDP program safely</h1>
[<a href="msg05335.html">Date Prev</a>][<a href="msg05337.html">Date Next</a>][<a href="msg05335.html">Thread Prev</a>][<a href="msg05337.html">Thread Next</a>][<a href="maillist.html#05336">Date Index</a>][<a href="index.html#05336">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH AUTOSEL 5.2 189/249] net/mlx5e: Attach/detach XDP program safely</li>
<li><em>From</em>: Sasha Levin &lt;sashal@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Mon, 15 Jul 2019 09:45:54 -0400</li>
<li><em>Cc</em>: Maxim Mikityanskiy &lt;maximmi@xxxxxxxxxxxx&gt;,        Tariq Toukan &lt;tariqt@xxxxxxxxxxxx&gt;,        Saeed Mahameed &lt;saeedm@xxxxxxxxxxxx&gt;,        Daniel Borkmann &lt;daniel@xxxxxxxxxxxxx&gt;,        Sasha Levin &lt;sashal@xxxxxxxxxx&gt;, netdev@xxxxxxxxxxxxxxx,        linux-rdma@xxxxxxxxxxxxxxx, xdp-newbies@xxxxxxxxxxxxxxx,        bpf@xxxxxxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;20190715134655.4076-1-sashal@kernel.org&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>From: Maxim Mikityanskiy &lt;maximmi@xxxxxxxxxxxx&gt;

[ Upstream commit e18953240de8b46360a67090c87ee1ef8160b35d ]

When an XDP program is set, a full reopen of all channels happens in two
cases:

1. When there was no program set, and a new one is being set.

2. When there was a program set, but it's being unset.

The full reopen is necessary, because the channel parameters may change
if XDP is enabled or disabled. However, it's performed in an unsafe way:
if the new channels fail to open, the old ones are already closed, and
the interface goes down. Use the safe way to switch channels instead.
The same way is already used for other configuration changes.

Signed-off-by: Maxim Mikityanskiy &lt;maximmi@xxxxxxxxxxxx&gt;
Signed-off-by: Tariq Toukan &lt;tariqt@xxxxxxxxxxxx&gt;
Signed-off-by: Saeed Mahameed &lt;saeedm@xxxxxxxxxxxx&gt;
Signed-off-by: Daniel Borkmann &lt;daniel@xxxxxxxxxxxxx&gt;
Signed-off-by: Sasha Levin &lt;sashal@xxxxxxxxxx&gt;
---
 .../net/ethernet/mellanox/mlx5/core/en_main.c | 31 ++++++++++++-------
 1 file changed, 20 insertions(+), 11 deletions(-)

diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en_main.c b/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
index a8e8350b38aa..8db9fdbc03ea 100644
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
@@ -4192,8 +4192,6 @@ static int mlx5e_xdp_set(struct net_device *netdev, struct bpf_prog *prog)
 	/* no need for full reset when exchanging programs */
 	reset = (!priv-&gt;channels.params.xdp_prog || !prog);
 
-	if (was_opened &amp;&amp; reset)
-		mlx5e_close_locked(netdev);
 	if (was_opened &amp;&amp; !reset) {
 		/* num_channels is invariant here, so we can take the
 		 * batched reference right upfront.
@@ -4205,20 +4203,31 @@ static int mlx5e_xdp_set(struct net_device *netdev, struct bpf_prog *prog)
 		}
 	}
 
-	/* exchange programs, extra prog reference we got from caller
-	 * as long as we don't fail from this point onwards.
-	 */
-	old_prog = xchg(&amp;priv-&gt;channels.params.xdp_prog, prog);
+	if (was_opened &amp;&amp; reset) {
+		struct mlx5e_channels new_channels = {};
+
+		new_channels.params = priv-&gt;channels.params;
+		new_channels.params.xdp_prog = prog;
+		mlx5e_set_rq_type(priv-&gt;mdev, &amp;new_channels.params);
+		old_prog = priv-&gt;channels.params.xdp_prog;
+
+		err = mlx5e_safe_switch_channels(priv, &amp;new_channels, NULL);
+		if (err)
+			goto unlock;
+	} else {
+		/* exchange programs, extra prog reference we got from caller
+		 * as long as we don't fail from this point onwards.
+		 */
+		old_prog = xchg(&amp;priv-&gt;channels.params.xdp_prog, prog);
+	}
+
 	if (old_prog)
 		bpf_prog_put(old_prog);
 
-	if (reset) /* change RQ type according to priv-&gt;xdp_prog */
+	if (!was_opened &amp;&amp; reset) /* change RQ type according to priv-&gt;xdp_prog */
 		mlx5e_set_rq_type(priv-&gt;mdev, &amp;priv-&gt;channels.params);
 
-	if (was_opened &amp;&amp; reset)
-		err = mlx5e_open_locked(netdev);
-
-	if (!test_bit(MLX5E_STATE_OPENED, &amp;priv-&gt;state) || reset)
+	if (!was_opened || reset)
 		goto unlock;
 
 	/* exchanging programs w/o reset, we update ref counts on behalf
-- 
2.20.1



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg05335.html">[PATCH AUTOSEL 5.2 177/249] bpf: fix BPF_ALU32 | BPF_ARSH on BE arches</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg05337.html">[PATCH AUTOSEL 5.2 209/249] bpf: fix uapi bpf_prog_info fields alignment</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg05335.html">[PATCH AUTOSEL 5.2 177/249] bpf: fix BPF_ALU32 | BPF_ARSH on BE arches</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg05337.html">[PATCH AUTOSEL 5.2 209/249] bpf: fix uapi bpf_prog_info fields alignment</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#05336"><strong>Date</strong></a></li>
<li><a href="index.html#05336"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;Samsung&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-rockchip/>[Linux&nbsp;Rockchip&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-actions/>[Linux&nbsp;Actions&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-snps-arc/>[Linux&nbsp;for&nbsp;Synopsys&nbsp;ARC&nbsp;Processors]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nfs/>[Linux&nbsp;NFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nilfs/>[Linux&nbsp;NILFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/vfl/>[Video&nbsp;for&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<p>
<hr>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

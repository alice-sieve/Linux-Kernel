<!-- MHonArc v2.6.19 -->
<!--X-Subject: [bpf PATCH v3 0/8] sockmap/tls fixes -->
<!--X-From-R13: Xbua Tnfgnoraq &#60;wbua.snfgnoraqNtznvy.pbz> -->
<!--X-Date: Mon, 15 Jul 2019 13:49:05 &#45;0700 -->
<!--X-Message-Id: 156322373173.18678.6003379631139659856.stgit@john&#45;XPS&#45;13&#45;9370 -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="BPF: [bpf PATCH v3 0/8] sockmap/tls fixes">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[bpf PATCH v3 0/8] sockmap/tls fixes &mdash; BPF</title>
<link rel="alternate" type="application/rss+xml" title="BPF" href="//feeds.feedburner.com/packetfilters">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[bpf PATCH v3 0/8] sockmap/tls fixes</h1>
[<a href="msg05380.html">Date Prev</a>][<a href="msg05382.html">Date Next</a>][<a href="msg05370.html">Thread Prev</a>][<a href="msg05382.html">Thread Next</a>][<a href="maillist.html#05381">Date Index</a>][<a href="index.html#05381">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [bpf PATCH v3 0/8] sockmap/tls fixes</li>
<li><em>From</em>: John Fastabend &lt;john.fastabend@xxxxxxxxx&gt;</li>
<li><em>Date</em>: Mon, 15 Jul 2019 13:49:01 -0700</li>
<li><em>Cc</em>: netdev@xxxxxxxxxxxxxxx, edumazet@xxxxxxxxxx, john.fastabend@xxxxxxxxx,        bpf@xxxxxxxxxxxxxxx</li>
<li><em>User-agent</em>: StGit/0.17.1-dirty</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Resolve a series of splats discovered by syzbot and an unhash
TLS issue noted by Eric Dumazet.

The main issues revolved around interaction between TLS and
sockmap tear down. TLS and sockmap could both reset sk-&gt;prot
ops creating a condition where a close or unhash op could be
called forever. A rare race condition resulting from a missing
rcu sync operation was causing a use after free. Then on the
TLS side dropping the sock lock and re-acquiring it during the
close op could hang. Finally, sockmap must be deployed before
tls for current stack assumptions to be met. This is enforced
now. A feature series can enable it.

To fix this first refactor TLS code so the lock is held for the
entire teardown operation. Then add an unhash callback to ensure
TLS can not transition from ESTABLISHED to LISTEN state. This
transition is a similar bug to the one found and fixed previously
in sockmap. Then apply three fixes to sockmap to fix up races
on tear down around map free and close. Finally, if sockmap
is destroyed before TLS we add a new ULP op update to inform
the TLS stack it should not call sockmap ops. This last one
appears to be the most commonly found issue from syzbot.

---

Jakub Kicinski (1):
      net/tls: don't arm strparser immediately in tls_set_sw_offload()

John Fastabend (7):
      tls: remove close callback sock unlock/lock around TX work flush
      tls: remove sock unlock/lock around strp_done()
      bpf: tls fix transition through disconnect with close
      bpf: sockmap, sock_map_delete needs to use xchg
      bpf: sockmap, synchronize_rcu before free'ing map
      bpf: sockmap, only create entry if ulp is not already enabled
      bpf: sockmap/tls, close can race with map free


 include/linux/skmsg.h |    8 ++-
 include/net/tcp.h     |    3 +
 include/net/tls.h     |   12 +++-
 net/core/skmsg.c      |    4 +
 net/core/sock_map.c   |   19 ++++--
 net/ipv4/tcp_ulp.c    |   13 ++++
 net/tls/tls_main.c    |  155 ++++++++++++++++++++++++++++++++++++++-----------
 net/tls/tls_sw.c      |   76 +++++++++++++++++-------
 8 files changed, 221 insertions(+), 69 deletions(-)

--
Signature


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="05475" href="msg05475.html">Re: [bpf PATCH v3 0/8] sockmap/tls fixes</a></strong>
<ul><li><em>From:</em> Jakub Kicinski</li></ul></li>
<li><strong><a name="05389" href="msg05389.html">[bpf PATCH v3 8/8] bpf: sockmap/tls, close can race with map free</a></strong>
<ul><li><em>From:</em> John Fastabend</li></ul></li>
<li><strong><a name="05388" href="msg05388.html">[bpf PATCH v3 7/8] bpf: sockmap, only create entry if ulp is not already enabled</a></strong>
<ul><li><em>From:</em> John Fastabend</li></ul></li>
<li><strong><a name="05387" href="msg05387.html">[bpf PATCH v3 6/8] bpf: sockmap, synchronize_rcu before free'ing map</a></strong>
<ul><li><em>From:</em> John Fastabend</li></ul></li>
<li><strong><a name="05386" href="msg05386.html">[bpf PATCH v3 5/8] bpf: sockmap, sock_map_delete needs to use xchg</a></strong>
<ul><li><em>From:</em> John Fastabend</li></ul></li>
<li><strong><a name="05385" href="msg05385.html">[bpf PATCH v3 4/8] bpf: tls fix transition through disconnect with close</a></strong>
<ul><li><em>From:</em> John Fastabend</li></ul></li>
<li><strong><a name="05384" href="msg05384.html">[bpf PATCH v3 3/8] tls: remove sock unlock/lock around strp_done()</a></strong>
<ul><li><em>From:</em> John Fastabend</li></ul></li>
<li><strong><a name="05383" href="msg05383.html">[bpf PATCH v3 2/8] tls: remove close callback sock unlock/lock around TX work flush</a></strong>
<ul><li><em>From:</em> John Fastabend</li></ul></li>
<li><strong><a name="05382" href="msg05382.html">[bpf PATCH v3 1/8] net/tls: don't arm strparser immediately in tls_set_sw_offload()</a></strong>
<ul><li><em>From:</em> John Fastabend</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg05380.html">Re: [PATCH bpf 0/5] bpf: allow wide (u64) aligned loads for some fields of bpf_sock_addr</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg05382.html">[bpf PATCH v3 1/8] net/tls: don't arm strparser immediately in tls_set_sw_offload()</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg05370.html">[PATCH bpf 0/5] bpf: allow wide (u64) aligned loads for some fields of bpf_sock_addr</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg05382.html">[bpf PATCH v3 1/8] net/tls: don't arm strparser immediately in tls_set_sw_offload()</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#05381"><strong>Date</strong></a></li>
<li><a href="index.html#05381"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;Samsung&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-rockchip/>[Linux&nbsp;Rockchip&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-actions/>[Linux&nbsp;Actions&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-snps-arc/>[Linux&nbsp;for&nbsp;Synopsys&nbsp;ARC&nbsp;Processors]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nfs/>[Linux&nbsp;NFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nilfs/>[Linux&nbsp;NILFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/vfl/>[Video&nbsp;for&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<p>
<hr>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

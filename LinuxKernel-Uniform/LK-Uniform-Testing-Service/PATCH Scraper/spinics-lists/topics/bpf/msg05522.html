<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH] virtio&#45;net: parameterize min ring num_free for virtio receive -->
<!--X-From-R13: Xnfba Inat &#60;wnfbjnatNerqung.pbz> -->
<!--X-Date: Thu, 18 Jul 2019 19:37:05 &#45;0700 -->
<!--X-Message-Id: d1faa33a&#45;6c4c&#45;1190&#45;8430&#45;f0639edc3b96@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: BYAPR14MB32056583C4963342F5D817C4A6C80@BYAPR14MB3205.namprd14.prod.outlook.com -->
<!--X-Reference: 20190718085836&#45;mutt&#45;send&#45;email&#45;mst@kernel.org -->
<!--X-Reference: bdd30ef5&#45;4f69&#45;8218&#45;eed0&#45;38c6daac42db@redhat.com -->
<!--X-Reference: 20190718103641&#45;mutt&#45;send&#45;email&#45;mst@kernel.org -->
<!--X-Reference: 20190718104307&#45;mutt&#45;send&#45;email&#45;mst@kernel.org -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="BPF: Re: [PATCH] virtio-net: parameterize min ring num_free for virtio receive">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH] virtio-net: parameterize min ring num_free for virtio receive &mdash; BPF</title>
<link rel="alternate" type="application/rss+xml" title="BPF" href="//feeds.feedburner.com/packetfilters">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH] virtio-net: parameterize min ring num_free for virtio receive</h1>
[<a href="msg05521.html">Date Prev</a>][<a href="msg05523.html">Date Next</a>][<a href="msg05501.html">Thread Prev</a>][<a href="msg05530.html">Thread Next</a>][<a href="maillist.html#05522">Date Index</a>][<a href="index.html#05522">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH] virtio-net: parameterize min ring num_free for virtio receive</li>
<li><em>From</em>: Jason Wang &lt;jasowang@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Fri, 19 Jul 2019 10:36:52 +0800</li>
<li><em>Cc</em>: &quot;davem@xxxxxxxxxxxxx&quot; &lt;davem@xxxxxxxxxxxxx&gt;,        &quot;ast@xxxxxxxxxx&quot; &lt;ast@xxxxxxxxxx&gt;,        &quot;daniel@xxxxxxxxxxxxx&quot; &lt;daniel@xxxxxxxxxxxxx&gt;,        &quot;jakub.kicinski@xxxxxxxxxxxxx&quot; &lt;jakub.kicinski@xxxxxxxxxxxxx&gt;,        &quot;hawk@xxxxxxxxxx&quot; &lt;hawk@xxxxxxxxxx&gt;,        &quot;john.fastabend@xxxxxxxxx&quot; &lt;john.fastabend@xxxxxxxxx&gt;,        &quot;kafai@xxxxxx&quot; &lt;kafai@xxxxxx&gt;,        &quot;songliubraving@xxxxxx&quot; &lt;songliubraving@xxxxxx&gt;,        &quot;yhs@xxxxxx&quot; &lt;yhs@xxxxxx&gt;,        &quot;virtualization@xxxxxxxxxxxxxxxxxxxxxxxxxx&quot;         &lt;virtualization@xxxxxxxxxxxxxxxxxxxxxxxxxx&gt;,        &quot;netdev@xxxxxxxxxxxxxxx&quot; &lt;netdev@xxxxxxxxxxxxxxx&gt;,        &quot;linux-kernel@xxxxxxxxxxxxxxx&quot; &lt;linux-kernel@xxxxxxxxxxxxxxx&gt;,        &quot;xdp-newbies@xxxxxxxxxxxxxxx&quot; &lt;xdp-newbies@xxxxxxxxxxxxxxx&gt;,        &quot;bpf@xxxxxxxxxxxxxxx&quot; &lt;bpf@xxxxxxxxxxxxxxx&gt;,        &quot;jiangran.jr@xxxxxxxxxxxxxxx&quot; &lt;jiangran.jr@xxxxxxxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg05501.html">20190718104307-mutt-send-email-mst@kernel.org</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Thunderbird/60.8.0</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">

On 2019/7/18 &#x4E0B;&#x5348;10:43, Michael S. Tsirkin wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On Thu, Jul 18, 2019 at 10:42:47AM -0400, Michael S. Tsirkin wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On Thu, Jul 18, 2019 at 10:01:05PM +0800, Jason Wang wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On 2019/7/18 &#x4E0B;&#x5348;9:04, Michael S. Tsirkin wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On Thu, Jul 18, 2019 at 12:55:50PM +0000, ? jiang wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
This change makes ring buffer reclaim threshold num_free configurable
for better performance, while it's hard coded as 1/2 * queue now.
According to our test with qemu + dpdk, packet dropping happens when
the guest is not able to provide free buffer in avail ring timely.
Smaller value of num_free does decrease the number of packet dropping
during our test as it makes virtio_net reclaim buffer earlier.

At least, we should leave the value changeable to user while the
default value as 1/2 * queue is kept.

Signed-off-by: jiangkidd&lt;jiangkidd@xxxxxxxxxxx&gt;
</pre></blockquote><pre style="margin: 0em;">
That would be one reason, but I suspect it's not the
true one. If you need more buffer due to jitter
then just increase the queue size. Would be cleaner.


However are you sure this is the reason for
packet drops? Do you see them dropped by dpdk
due to lack of space in the ring? As opposed to
by guest?


</pre></blockquote><pre style="margin: 0em;">
Besides those, this patch depends on the user to choose a suitable threshold
which is not good. You need either a good value with demonstrated numbers or
something smarter.

Thanks
</pre></blockquote><pre style="margin: 0em;">
I do however think that we have a problem right now: try_fill_recv can
take up a long time during which net stack does not run at all. Imagine
a 1K queue - we are talking 512 packets. That's exceessive.
</pre></blockquote></blockquote><pre style="margin: 0em;">


Yes, we will starve a fast host in this case.


</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
   napi poll
weight solves a similar problem, so it might make sense to cap this at
napi_poll_weight.

Which will allow tweaking it through a module parameter as a
side effect :) Maybe just do NAPI_POLL_WEIGHT.
</pre></blockquote><pre style="margin: 0em;">
Or maybe NAPI_POLL_WEIGHT/2 like we do at half the queue ;). Please
experiment, measure performance and let the list know

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Need to be careful though: queues can also be small and I don't think we
want to exceed queue size / 2, or maybe queue size - napi_poll_weight.
Definitely must not exceed the full queue size.
</pre></blockquote></blockquote><pre style="margin: 0em;">


</pre><tt>Looking at intel, it uses 16 and i40e uses 32.&#xA0; It looks to me 
</tt><tt>NAPI_POLL_WEIGHT/2 is better.
</tt><pre style="margin: 0em;">

Jiang, want to try that and post a new patch?

Thanks


</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

--
MST
</pre></blockquote></blockquote><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="05496" href="msg05496.html">Re: [PATCH] virtio-net: parameterize min ring num_free for virtio receive</a></strong>
<ul><li><em>From:</em> Michael S. Tsirkin</li></ul></li>
<li><strong><a name="05498" href="msg05498.html">Re: [PATCH] virtio-net: parameterize min ring num_free for virtio receive</a></strong>
<ul><li><em>From:</em> Jason Wang</li></ul></li>
<li><strong><a name="05500" href="msg05500.html">Re: [PATCH] virtio-net: parameterize min ring num_free for virtio receive</a></strong>
<ul><li><em>From:</em> Michael S. Tsirkin</li></ul></li>
<li><strong><a name="05501" href="msg05501.html">Re: [PATCH] virtio-net: parameterize min ring num_free for virtio receive</a></strong>
<ul><li><em>From:</em> Michael S. Tsirkin</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg05521.html">Re: [PATCH bpf] libbpf: fix missing __WORDSIZE definition</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg05523.html">Re: [PATCH AUTOSEL 5.2 226/249] selftests: bpf: fix inlines in test_lwt_seg6local</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg05501.html">Re: [PATCH] virtio-net: parameterize min ring num_free for virtio receive</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg05530.html">Re: [PATCH] virtio-net: parameterize min ring num_free for virtio receive</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#05522"><strong>Date</strong></a></li>
<li><a href="index.html#05522"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;Samsung&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-rockchip/>[Linux&nbsp;Rockchip&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-actions/>[Linux&nbsp;Actions&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-snps-arc/>[Linux&nbsp;for&nbsp;Synopsys&nbsp;ARC&nbsp;Processors]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nfs/>[Linux&nbsp;NFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nilfs/>[Linux&nbsp;NILFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/vfl/>[Video&nbsp;for&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<p>
<hr>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH] Implement an offset option for vbladed -->
<!--X-From-R13: Quevfgbcu Pvrqy &#60;fbheprsbetr.oajvNznapuzny.va&#45;hyz.qr> -->
<!--X-Date: Thu, 8 May 2014 15:24:43 &#45;0700 -->
<!--X-Message-Id: 1399581222@msgid.manchmal.in&#45;ulm.de -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Derived: pgpiTcuucY725.pgp -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="[PATCH] Implement an offset option for vbladed &mdash; Linux ATA over Ethernet Tools">
<title>[PATCH] Implement an offset option for vbladed &mdash; Linux ATA over Ethernet Tools</title>
<link rel="alternate" type="application/rss+xml" title="Linux ATA over Ethernet Tools" href="//feeds.feedburner.com/aoetools">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com/cse" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:isdiegq275o" />
    <input type="hidden" name="ie" value="ISO-8859-1" />
    <input type="text" name="q" size="37" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH] Implement an offset option for vbladed</h1>
[<a href="msg00095.html">Date Prev</a>][<a href="msg00097.html">Date Next</a>][<a href="msg00094.html">Thread Prev</a>][<a href="msg00097.html">Thread Next</a>][<a href="maillist.html#00096">Date Index</a>][<a href="index.html#00096">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: <a href="mailto:aoetools-discuss@DOMAIN.HIDDEN">aoetools-discuss@xxxxxxxxxxxxxxxxxxxxx</a></li>
<li><em>Subject</em>: [PATCH] Implement an offset option for vbladed</li>
<li><em>From</em>: Christoph Biedl &lt;<a href="mailto:sourceforge.bnwi@DOMAIN.HIDDEN">sourceforge.bnwi@xxxxxxxxxxxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Thu, 8 May 2014 22:43:15 +0200</li>
<li><em>User-agent</em>: Mutt/1.5.21 (2010-09-15)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Hello,

the patch below implements a new option -o for vbladed, denoting the
number of sectors that should be skipped at the beginning of the
exported file. Default is 0 (no offset, export from beginning, current
behaviour).

Rationale:

If the exported files are actually raw block devices on the target,
something that might happen when using logical volumes for exports,
several tools running on the target that assume block devices are
for exclusive local access only might create confusion or even
havoc. Most prominently:

* os-prober of grub (might be disabled, though)
  Might mount any block device found that contain a file system.
* (Linux) logical volume management
  Will report any physical volume if the export is used as such.
* (Linux) blkid 
  Reports any block device (minor impact, mostly information leakage)
  
The overall problem is applications are not aware some block devices 
might be used from a remote client while there's no locking and that
might be hard to implement

Solutions tried but not considered helpful:

* Filter out exported block devices
  Problems: The tools need the ability to filter; new tools might come
  into existance, requiring new action. Filter languages might be hard
  to use (Linux LVM is quite a nightmare here).
* Optionally open block devices with O_EXCL
  Had no effect. Still exposes block devices where no vbladed is running
  yet.

So the goal was to hide the actual content from these tools. One
approach was to obscure the data using XOR, however it seemed easier
to sacrifice one or more sectors (8 recommended for 4k sector hard
drives) for a simple workaround.

This is based on vblade-20, tests on Debian Linux included a simple
write of each sector with a unique ID and later re-read in order to
detect any re-ordering bugs, however everything worked as expected.

    Christoph

--- a/aoe.c
+++ b/aoe.c
@@ -464,9 +464,10 @@ main(int argc, char **argv)
 	int ch, omode = 0, readonly = 0;
 
 	bufcnt = Bufcount;
+	offset = 0;
 	setbuf(stdin, NULL);
 	progname = *argv;
-	while ((ch = getopt(argc, argv, &quot;b:dsrm:&quot;)) != -1) {
+	while ((ch = getopt(argc, argv, &quot;b:dsrm:o:&quot;)) != -1) {
 		switch (ch) {
 		case 'b':
 			bufcnt = atoi(optarg);
@@ -485,6 +486,9 @@ main(int argc, char **argv)
 		case 'm':
 			setmask(optarg);
 			break;
+		case 'o':
+			offset = atoi(optarg);
+			break;
 		case '?':
 		default:
 			usage();
@@ -505,6 +509,11 @@ main(int argc, char **argv)
 	setserial(argv[3], shelf, slot);
 	size = getsize(bfd);
 	size /= 512;
+	if (size &lt; offset) {
+		fprintf(stderr, &quot;Offset %u too big - remaining size is negative!\n&quot;, offset);
+		exit(1);
+	}
+	size -= offset;
 	ifname = argv[2];
 	sfd = dial(ifname, bufcnt);
 	getea(sfd, ifname, mac);
diff --git a/ata.c b/ata.c
index 4854f34..7c53b46 100644
--- a/ata.c
+++ b/ata.c
@@ -155,12 +155,12 @@ atacmd(Ataregs *p, uchar *dp, int ndp, int payload) // do the ata cmd
 		return 0;
 	}
 	if (p-&gt;cmd == 0x20 || p-&gt;cmd == 0x24)
-		n = getsec(bfd, dp, lba, p-&gt;sectors);
+		n = getsec(bfd, dp, lba+offset, p-&gt;sectors);
 	else {
 		// packet should be big enough to contain the data
 		if (payload &lt; 512 * p-&gt;sectors)
 			return -1;
-		n = putsec(bfd, dp, lba, p-&gt;sectors);
+		n = putsec(bfd, dp, lba+offset, p-&gt;sectors);
 	}
 	n /= 512;
 	if (n != p-&gt;sectors) {
diff --git a/dat.h b/dat.h
index 064ab1e..f3a93d8 100644
--- a/dat.h
+++ b/dat.h
@@ -169,6 +169,7 @@ uchar	mac[6];
 int	bfd;		// block file descriptor
 int	sfd;		// socket file descriptor
 vlong	size;		// size of vblade
+unsigned offset;
 char	*progname;
 char	serial[Nserial+1];
 
diff --git a/vblade.8 b/vblade.8
index 2cd2b2c..3d8ff13 100644
--- a/vblade.8
+++ b/vblade.8
@@ -55,6 +55,10 @@ The -r flag restricts the export of the device to be read-only.
 The -m flag takes an argument, a comma separated list of MAC addresses
 permitted access to the vblade.  A MAC address can be specified in upper
 or lower case, with or without colons.
+.TP
+\fB-o\fP
+The -o flag takes an argument, the number of sectors that should be
+skipped at the beginning of filename.
 .SH EXAMPLE
 In this example, the root user on a host named
 .I nai
</pre><p><strong>Attachment:
<a href="attachments/pgpiTcuucY725.pgp" ><tt>signature.asc</tt></a></strong><br>
<em>Description:</em> Digital signature</p>
<pre>------------------------------------------------------------------------------
Is your legacy SCM system holding you back? Join Perforce May 7 to find out:
&amp;#149; 3 signs your SCM is hindering your productivity
&amp;#149; Requirements for releasing software faster
&amp;#149; Expert tips and advice for migrating your SCM now
<a  rel="nofollow" href="http://p.sf.net/sfu/perforce">http://p.sf.net/sfu/perforce</a></pre><pre>_______________________________________________
Aoetools-discuss mailing list
Aoetools-discuss@xxxxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://lists.sourceforge.net/lists/listinfo/aoetools-discuss">https://lists.sourceforge.net/lists/listinfo/aoetools-discuss</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00097" href="msg00097.html">Re:  [PATCH] Implement an offset option for vbladed</a></strong>
<ul><li><em>From:</em> Ed Cashin</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00095.html">Re:  AoE support in tcpdump</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00097.html">Re:  [PATCH] Implement an offset option for vbladed</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00094.html">AoE support in tcpdump</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00097.html">Re:  [PATCH] Implement an offset option for vbladed</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00096"><strong>Date</strong></a></li>
<li><a href="index.html#00096"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/arm-kernel/>[Linux&nbsp;ARM&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
&nbsp;
&nbsp;
<a href=/lists/arm/>[Linux&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;Omap]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-arm/>[Fedora&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/ietf-ann/>[IETF&nbsp;Annouce]</a>
&nbsp;
&nbsp;
<a href=/lists/security/>[Security]</a>
&nbsp;
&nbsp;
<a href=/lists/bugtraq/>[Bugtraq]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;OMAP]</a>
&nbsp;
&nbsp;
<a href=/lists/mips/>[Linux&nbsp;MIPS]</a>
&nbsp;
&nbsp;
<a href=/lists/ecos/>[eCos]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;Internet&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-api/>[Linux&nbsp;API]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

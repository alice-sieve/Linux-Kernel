<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH] Incorrect shelf/slot handling in BPF -->
<!--X-From-R13: Qngnyva Enytnh &#60;pfnytnhNhfref.fbheprsbetr.arg> -->
<!--X-Date: Mon, 19 May 2014 13:53:59 &#45;0700 -->
<!--X-Message-Id: 537A6931.2010200@users.sourceforge.net -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 537A576D.7050008@users.sourceforge.net -->
<!--X-Reference: 97E4E135&#45;9B3D&#45;4C6E&#45;9075&#45;DA6AAB1C1EDC@coraid.com -->
<!--X-Reference: 537A643C.2070801@users.sourceforge.net -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re:  [PATCH] Incorrect shelf/slot handling in BPF &mdash; Linux ATA over Ethernet Tools">
<title>Re:  [PATCH] Incorrect shelf/slot handling in BPF &mdash; Linux ATA over Ethernet Tools</title>
<link rel="alternate" type="application/rss+xml" title="Linux ATA over Ethernet Tools" href="//feeds.feedburner.com/aoetools">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com/cse" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:isdiegq275o" />
    <input type="hidden" name="ie" value="ISO-8859-1" />
    <input type="text" name="q" size="37" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [PATCH] Incorrect shelf/slot handling in BPF</h1>
[<a href="msg00119.html">Date Prev</a>][<a href="msg00121.html">Date Next</a>][<a href="msg00121.html">Thread Prev</a>][<a href="msg00123.html">Thread Next</a>][<a href="maillist.html#00120">Date Index</a>][<a href="index.html#00120">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH] Incorrect shelf/slot handling in BPF</li>
<li><em>From</em>: Catalin Salgau &lt;<a href="mailto:csalgau@DOMAIN.HIDDEN">csalgau@xxxxxxxxxxxxxxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Mon, 19 May 2014 23:27:29 +0300</li>
<li><em>Cc</em>: &quot;<a href="mailto:aoetools-discuss@DOMAIN.HIDDEN">aoetools-discuss@xxxxxxxxxxxxxxxxxxxxx</a>&quot;	&lt;<a href="mailto:aoetools-discuss@DOMAIN.HIDDEN">aoetools-discuss@xxxxxxxxxxxxxxxxxxxxx</a>&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg00121.html">537A643C.2070801@users.sourceforge.net</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (Windows NT 6.3; Win64; x64;	rv:32.0) Gecko/20100101 Thunderbird/32.0a1</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>And yes. I am aware that testing a patch and not covering the actual 
problem should not qualify as testing the patch.
My argument for the validity of the patch is that since the new code 
touches and treats all packets equally, having it work in general covers 
the corner case that was rejected in the original code.
I'll admit that I'm not entirely certain under what circumstances one 
would use this behaviour (maybe an environment where multiple hosts 
serve the same image?) or if there are Coraid appliances or HBAs that 
actually support this.


On 19/05/2014 11:06 PM, Catalin Salgau wrote:
&gt; I'm not exactly sure how this can be tested without relying on a 
&gt; second system or packet capture. I'm thinking on the lines of 
&gt; attaching vblade to lo0 and writing another BPF based program to make 
&gt; requests, but I believe that would not be very reliable under some 
&gt; conditions.
&gt;
&gt; Back to the patch. I do not have a testing suite for this. I noticed 
&gt; the incorrect behaviour when tweaking the code in another direction. 
&gt; I've taken several looks at the BPF filter over the past two years and 
&gt; have been running with this change in 'production' for about one, but 
&gt; I do not actually use the corner case covered by it. Since I'm 
&gt; isolating patches to post to the mailing list, I have tested this 
&gt; change against vblade-21 with a full boot-shutdown cycle of Windows 8.
&gt; By reusing the same accumulator for both comparisons, the code is 
&gt; slightly shorter(and marginally faster) and this changes a few offsets.
&gt;
&gt; The present code is roughly equivalent to
&gt; if P[16:2] == SHELF:
&gt;   if P[18] == SLOT:
&gt;     goto ACCEPT
&gt; if P[16:2] != '\xFF\xFF':
&gt;   goto REJECT
&gt; if P[18] != '\xFF':
&gt;   goto REJECT
&gt;
&gt; The patch changes it to something like
&gt; if P[16:2] == SHELF:
&gt;   goto CHECKSLOT
&gt; if P[16:2] != 0xffff:
&gt;   goto REJECT
&gt; if P[18] == SLOT:
&gt;   goto ACCEPT
&gt; if P[18] != 0xff:
&gt;   goto REJECT
&gt;
&gt;
&gt; I would encourage anyone wishing to validate the changes to read the 
&gt; FILTER_MACHINE section in bpf(4) in the FreeBSD man pages. Linux LSF 
&gt; is supposed to be compatible.
&gt;
&gt;
&gt; On 19/05/2014 10:22 PM, Ed Cashin wrote:
&gt;&gt; I think you mean that a vblade that's AoE 11.22 should answer AoE 
&gt;&gt; commands sent to 0xffff.2 or 11.0xff but does not currently.
&gt;&gt;
&gt;&gt; It would be very nice if we had a collection of tests, so that you 
&gt;&gt; could also include a test that showed what this fix corrects and 
&gt;&gt; validated the fix itself.  Alas.  Still, it would be good to hear 
&gt;&gt; about how the fix was tested if you don't want to take a stab at 
&gt;&gt; adding such a test.
&gt;&gt;
&gt;&gt; On May 19, 2014, at 3:11 PM, Catalin Salgau 
&gt;&gt; &lt;csalgau@xxxxxxxxxxxxxxxxxxxxx&gt; wrote:
&gt;&gt;
&gt;&gt;&gt; The BPF filter program currently included in vblade requires that the
&gt;&gt;&gt; major and minor fields in a packet header either
&gt;&gt;&gt; - match server's major and minor addresses or
&gt;&gt;&gt; - be both all ones (0xffff and 0xff respectively)
&gt;&gt;&gt; This is against the AoE specification that requires that the two fields
&gt;&gt;&gt; be tested separately. (as seen in aoe.c:368)
&gt;&gt;&gt; Proposed patch corrects this.
&gt;&gt;&gt;
&gt;&gt;&gt; diff --git a/vblade/bpf.c b/vblade/bpf.c
&gt;&gt;&gt; --- a/vblade/bpf.c
&gt;&gt;&gt; +++ b/vblade/bpf.c
&gt;&gt;&gt; @@ -82,32 +82,27 @@
&gt;&gt;&gt;   {
&gt;&gt;&gt;       struct bpf_program *bpf_program;
&gt;&gt;&gt;       struct bpf_insn insns[] = {
&gt;&gt;&gt; -        /* Load the type into register */
&gt;&gt;&gt; +        /* CHECKTYPE: Load the type into register */
&gt;&gt;&gt;           BPF_STMT(BPF_LD+BPF_H+BPF_ABS, 12),
&gt;&gt;&gt;           /* Does it match AoE Type (0x88a2)? No, goto INVALID */
&gt;&gt;&gt; -        BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, 0x88a2, 0, 12),
&gt;&gt;&gt; +        BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, 0x88a2, 0, 10),
&gt;&gt;&gt;           /* Load the flags into register */
&gt;&gt;&gt;           BPF_STMT(BPF_LD+BPF_B+BPF_ABS, 14),
&gt;&gt;&gt;           /* Check to see if the Resp flag is set */
&gt;&gt;&gt;           BPF_STMT(BPF_ALU+BPF_AND+BPF_K, Resp),
&gt;&gt;&gt;           /* Yes, goto INVALID */
&gt;&gt;&gt; -        BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, 0, 0, 9),
&gt;&gt;&gt; -        /* Load the shelf number into register */
&gt;&gt;&gt; +        BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, 0, 0, 7),
&gt;&gt;&gt; +        /* CHECKSHELF: Load the shelf number into register */
&gt;&gt;&gt;           BPF_STMT(BPF_LD+BPF_H+BPF_ABS, 16),
&gt;&gt;&gt; -        /* Does it match shelf number? No, goto CHECKBROADCAST */
&gt;&gt;&gt; -        BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, shelf, 0, 2),
&gt;&gt;&gt; -        /* Load the slot number into register */
&gt;&gt;&gt; +        /* Does it match shelf number? Yes, goto CHECKSLOT */
&gt;&gt;&gt; +        BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, shelf, 1, 0),
&gt;&gt;&gt; +        /* Does it match broadcast? No, goto INVALID */
&gt;&gt;&gt; +        BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, 0xffff, 0, 4),
&gt;&gt;&gt; +        /* CHECKSLOT: Load the slot number into register */
&gt;&gt;&gt;           BPF_STMT(BPF_LD+BPF_B+BPF_ABS, 18),
&gt;&gt;&gt;           /* Does it match shelf number? Yes, goto VALID */
&gt;&gt;&gt; -        BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, slot, 4, 0),
&gt;&gt;&gt; -        /* CHECKBROADCAST: is (shelf, slot) == (0xffff, 0xff)? */
&gt;&gt;&gt; -        /* Load the shelf number into register */
&gt;&gt;&gt; -        BPF_STMT(BPF_LD+BPF_H+BPF_ABS, 16),
&gt;&gt;&gt; -        /* Is it 0xffff? No, goto INVALID */
&gt;&gt;&gt; -        BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, 0xffff, 0, 3),
&gt;&gt;&gt; -        /* Load the slot number into register */
&gt;&gt;&gt; -        BPF_STMT(BPF_LD+BPF_B+BPF_ABS, 18),
&gt;&gt;&gt; -        /* Is it 0xff? No, goto INVALID */
&gt;&gt;&gt; +        BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, slot, 1, 0),
&gt;&gt;&gt; +        /* Does it match broadcast? No, goto INVALID */
&gt;&gt;&gt;           BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, 0xff, 0, 1),
&gt;&gt;&gt;           /* VALID: return -1 (allow the packet to be read) */
&gt;&gt;&gt;           BPF_STMT(BPF_RET+BPF_K, -1),
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; ------------------------------------------------------------------------------ 
&gt;&gt;&gt;
&gt;&gt;&gt; &quot;Accelerate Dev Cycles with Automated Cross-Browser Testing - For FREE
&gt;&gt;&gt; Instantly run your Selenium tests across 300+ browser/OS combos.
&gt;&gt;&gt; Get unparalleled scalability from the best Selenium testing platform 
&gt;&gt;&gt; available
&gt;&gt;&gt; Simple to use. Nothing to install. Get started now for free.&quot;
&gt;&gt;&gt; <a  rel="nofollow" href="http://p.sf.net/sfu/SauceLabs">http://p.sf.net/sfu/SauceLabs</a>
&gt;&gt;&gt; _______________________________________________
&gt;&gt;&gt; Aoetools-discuss mailing list
&gt;&gt;&gt; Aoetools-discuss@xxxxxxxxxxxxxxxxxxxxx
&gt;&gt;&gt; <a  rel="nofollow" href="https://lists.sourceforge.net/lists/listinfo/aoetools-discuss">https://lists.sourceforge.net/lists/listinfo/aoetools-discuss</a>
&gt;&gt;
&gt;&gt;
&gt;


------------------------------------------------------------------------------
&quot;Accelerate Dev Cycles with Automated Cross-Browser Testing - For FREE
Instantly run your Selenium tests across 300+ browser/OS combos.
Get unparalleled scalability from the best Selenium testing platform available
Simple to use. Nothing to install. Get started now for free.&quot;
<a  rel="nofollow" href="http://p.sf.net/sfu/SauceLabs">http://p.sf.net/sfu/SauceLabs</a>
_______________________________________________
Aoetools-discuss mailing list
Aoetools-discuss@xxxxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://lists.sourceforge.net/lists/listinfo/aoetools-discuss">https://lists.sourceforge.net/lists/listinfo/aoetools-discuss</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00118" href="msg00118.html">[PATCH] Incorrect shelf/slot handling in BPF</a></strong>
<ul><li><em>From:</em> Catalin Salgau</li></ul></li>
<li><strong><a name="00119" href="msg00119.html">Re:  [PATCH] Incorrect shelf/slot handling in BPF</a></strong>
<ul><li><em>From:</em> Ed Cashin</li></ul></li>
<li><strong><a name="00121" href="msg00121.html">Re:  [PATCH] Incorrect shelf/slot handling in BPF</a></strong>
<ul><li><em>From:</em> Catalin Salgau</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00119.html">Re:  [PATCH] Incorrect shelf/slot handling in BPF</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00121.html">Re:  [PATCH] Incorrect shelf/slot handling in BPF</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00121.html">Re:  [PATCH] Incorrect shelf/slot handling in BPF</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00123.html">Re:  [PATCH] Incorrect shelf/slot handling in BPF</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00120"><strong>Date</strong></a></li>
<li><a href="index.html#00120"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/arm-kernel/>[Linux&nbsp;ARM&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
&nbsp;
&nbsp;
<a href=/lists/arm/>[Linux&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;Omap]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-arm/>[Fedora&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/ietf-ann/>[IETF&nbsp;Annouce]</a>
&nbsp;
&nbsp;
<a href=/lists/security/>[Security]</a>
&nbsp;
&nbsp;
<a href=/lists/bugtraq/>[Bugtraq]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;OMAP]</a>
&nbsp;
&nbsp;
<a href=/lists/mips/>[Linux&nbsp;MIPS]</a>
&nbsp;
&nbsp;
<a href=/lists/ecos/>[eCos]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;Internet&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-api/>[Linux&nbsp;API]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

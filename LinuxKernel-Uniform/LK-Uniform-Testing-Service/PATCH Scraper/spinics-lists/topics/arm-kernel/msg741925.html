<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH 1/3] arm64: kprobes: Recover pstate.D in single&#45;step exception handler -->
<!--X-From-R13: Xnzrf [befr &#60;wnzrf.zbefrNnez.pbz> -->
<!--X-Date: Fri, 19 Jul 2019 03:07:53 &#45;0700 -->
<!--X-Message-Id: 3a198660&#45;35cc&#45;0c65&#45;6a6d&#45;e30d2494ff21@arm.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 156342860634.8565.14804606041960884732.stgit@devnote2 -->
<!--X-Reference: 156342861775.8565.9122725195458920037.stgit@devnote2 -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<meta name="description" content="Linux ARM, OMAP, Xscale Kernel: Re: [PATCH 1/3] arm64: kprobes: Recover pstate.D in single-step exception handler">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Re: [PATCH 1/3] arm64: kprobes: Recover pstate.D in single-step exception handler &mdash; ARM, OMAP, Xscale Linux Kernel</title>
<link rel="alternate" type="application/rss+xml" title="Linux ARM Kernel" href="//feedproxy.google.com/LinuxArmKernel">
<link rel="alternate" type="application/rss+xml" title="Linux ARM Kernel" href="//feeds.feedburner.com/LinuxArmxscaleEtc">
<link rel="alternate" type="application/rss+xml" title="Fedora ARM" href="//feeds.feedburner.com/FedoraArm">
<link rel="alternate" type="application/rss+xml" title="Linux for OMAP" href="//feedproxy.google.com/LinuxOmap">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<td align=right><form action="//www.google.com/cse" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:isdiegq275o" />
    <input type="hidden" name="ie" value="ISO-8859-1" />
    <input type="text" name="q" size="37" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/cse/brand?form=cse-search-box&amp;lang=en" async></script>
<h1 itemprop="name">Re: [PATCH 1/3] arm64: kprobes: Recover pstate.D in single-step exception handler</h1>
[<a href="msg741924.html">Date Prev</a>][<a href="msg741926.html">Date Next</a>][<a href="msg741700.html">Thread Prev</a>][<a href="msg742023.html">Thread Next</a>][<a href="maillist.html#741925">Date Index</a>][<a href="threads.html#741925">Thread Index</a>] 
<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH 1/3] arm64: kprobes: Recover pstate.D in single-step exception handler</li>
<li><em>From</em>: James Morse &lt;james.morse@xxxxxxx&gt;</li>
<li><em>Date</em>: Fri, 19 Jul 2019 11:07:33 +0100</li>
<li><em>In-reply-to</em>: &lt;156342861775.8565.9122725195458920037.stgit@devnote2&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux aarch64; rv:60.0) Gecko/20100101 Thunderbird/60.7.0</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Hi!

On 18/07/2019 06:43, Masami Hiramatsu wrote:
&gt;<i> On arm64, if a nested kprobes hit, it can crash the kernel with below</i>
&gt;<i> error message.</i>
&gt;<i> </i>
&gt;<i> [  152.118921] Unexpected kernel single-step exception at EL1</i>
&gt;<i> </i>
&gt;<i> This is because commit 7419333fa15e (&quot;arm64: kprobe: Always clear</i>
&gt;<i> pstate.D in breakpoint exception handler&quot;) clears pstate.D always in</i>
&gt;<i> the nested kprobes. That is correct *unless* any nested kprobes</i>
&gt;<i> (single-stepping) runs inside other kprobes (including kprobes in</i>
&gt;<i>  user handler).</i>

kprobes probing kprobes!? ... why do we support this?

We treat 'debug' as our highest exception level, it can interrupt pNMI and RAS-errors.
Letting it loop doesn't sound like a good idea.


&gt;<i> When the 1st kprobe hits, do_debug_exception() will be called. At this</i>
&gt;<i> point, debug exception (= pstate.D) must be masked (=1).</i>

&gt;<i> When the 2nd (nested) kprobe is hit before single-step of the first kprobe,</i>

How does this happen?
I guess the kprobe-helper-function gets called in debug context, but surely you can't
kprobe a kprobe-helper-function? What stops this going in a loop?


&gt;<i> it modifies debug exception clear (pstate.D = 0).</i>

After taking the first BRK, DAIF=0xf, everything is masked. When you take the second BRK
this shouldn't change.

Those spsr_set_debug_flag() calls are modifying the spsr in the regs structure, they only
become PSTATE when we eret for single-step.


&gt;<i> Then, when the 1st kprobe setting up single-step, it saves current</i>
&gt;<i> DAIF, mask DAIF, enable single-step, and restore DAIF.</i>

&gt;<i> However, since &quot;D&quot; flag in DAIF is cleared by the 2nd kprobe, the</i>
&gt;<i> single-step exception happens soon after restoring DAIF.</i>

PSTATE.D bit clearing should only be effective for the duration of the single-step.


&gt;<i> To solve this issue, this refers saved pstate register to check the</i>
&gt;<i> previous pstate.D and recover it if needed.</i>

(This sounds like undoing something that shouldn't have happened in the first place)


&gt;<i> diff --git a/arch/arm64/kernel/probes/kprobes.c b/arch/arm64/kernel/probes/kprobes.c</i>
&gt;<i> index bd5dfffca272..6e1dc0bb4c82 100644</i>
&gt;<i> --- a/arch/arm64/kernel/probes/kprobes.c</i>
&gt;<i> +++ b/arch/arm64/kernel/probes/kprobes.c</i>
&gt;<i> @@ -201,12 +201,14 @@ spsr_set_debug_flag(struct pt_regs *regs, int mask)</i>
&gt;<i>   * interrupt occurrence in the period of exception return and  start of</i>
&gt;<i>   * out-of-line single-step, that result in wrongly single stepping</i>
&gt;<i>   * into the interrupt handler.</i>
&gt;<i> + * This also controls debug flag, so that we can refer the saved pstate.</i>
&gt;<i>   */</i>
&gt;<i>  static void __kprobes kprobes_save_local_irqflag(struct kprobe_ctlblk *kcb,</i>
&gt;<i>  						struct pt_regs *regs)</i>
&gt;<i>  {</i>
&gt;<i>  	kcb-&gt;saved_irqflag = regs-&gt;pstate;</i>
&gt;<i>  	regs-&gt;pstate |= PSR_I_BIT;</i>
&gt;<i> +	spsr_set_debug_flag(regs, 0);</i>

(Nit: this is the only caller of spsr_set_debug_flag(), as we're modifing regs-&gt;pstate
directly here, can we lose the helper and just manipulate regs-&gt;pstate? )

&gt;<i>  }</i>
&gt;<i>  </i>
&gt;<i>  static void __kprobes kprobes_restore_local_irqflag(struct kprobe_ctlblk *kcb,</i>
&gt;<i> @@ -245,15 +251,12 @@ static void __kprobes setup_singlestep(struct kprobe *p,</i>
&gt;<i>  		kcb-&gt;kprobe_status = KPROBE_HIT_SS;</i>
&gt;<i>  	}</i>
&gt;<i></i>
&gt;<i> -</i>
&gt;<i>  	if (p-&gt;ainsn.api.insn) {</i>
&gt;<i>  		/* prepare for single stepping */</i>
&gt;<i>  		slot = (unsigned long)p-&gt;ainsn.api.insn;</i>
&gt;<i></i>
&gt;<i>  		set_ss_context(kcb, slot);	/* mark pending ss */</i>
&gt;<i></i>
&gt;<i> -		spsr_set_debug_flag(regs, 0);</i>
&gt;<i> -</i>
&gt;<i>  		/* IRQs and single stepping do not mix well. */</i>
&gt;<i>  		kprobes_save_local_irqflag(kcb, regs);</i>
&gt;<i>  		kernel_enable_single_step(regs);</i>

These two hunks look like cleanup, could we do this separately from a fix for stable?



&gt;<i> @@ -216,6 +218,10 @@ static void __kprobes kprobes_restore_local_irqflag(struct kprobe_ctlblk *kcb,</i>
&gt;<i>  		regs-&gt;pstate |= PSR_I_BIT;</i>
&gt;<i>  	else</i>
&gt;<i>  		regs-&gt;pstate &amp;= ~PSR_I_BIT;</i>
&gt;<i> +</i>
&gt;<i> +	/* Recover pstate.D mask if needed */</i>
&gt;<i> +	if (kcb-&gt;saved_irqflag &amp; PSR_D_BIT)</i>
&gt;<i> +		spsr_set_debug_flag(regs, 1);</i>
&gt;<i>  }</i>

Ugh. .. I get it ..

I think the simplest summary of the problem is:
Kprobes unmasks debug exceptions for single-step, then leaves them unmasked when the
probed function is restarted.

I'd like to know more about this nested case, but I don't think its the simplest example
of this problem.
The commit message is describing both the interrupted and running PSTATE as PSTATE. I
think it would be clearer if you called the interrupted one SPSR (saved pstate register).
That's the value in the regs structure.


Please don't re-manipulate the flags, its overly verbose and we've already got this wrong
once! We should just blindly restore the DAIF setting we had before as its simpler.

Could we change kprobes_save_local_irqflag() to save the DAIF bits of pstate:
|&#x2003;kcb-&gt;saved_irqflag = regs-&gt;pstate &amp; DAIF_MASK;
(DAIF_MASK is all four PSR bits)

So that we can then fix this in kprobes_restore_local_irqflag() with:
| regs-&gt;pstate &amp;= ~DAIF_MASK;
| regs-&gt;pstate |= kcb-&gt;saved_irqflag

(the value splicing is needed because regs-&gt;pstate also holds the 'condition code' flags,
which could be modified by the single-step instruction, then depended on afterwards.)


Thanks,

James

_______________________________________________
linux-arm-kernel mailing list
linux-arm-kernel@xxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="http://lists.infradead.org/mailman/listinfo/linux-arm-kernel">http://lists.infradead.org/mailman/listinfo/linux-arm-kernel</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="742023" href="msg742023.html">Re: [PATCH 1/3] arm64: kprobes: Recover pstate.D in single-step exception handler</a></strong>
<ul><li><em>From:</em> Masami Hiramatsu</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="741699" href="msg741699.html">[PATCH 0/3] arm64: kprobes: Fix some bugs in arm64 kprobes</a></strong>
<ul><li><em>From:</em> Masami Hiramatsu</li></ul></li>
<li><strong><a name="741700" href="msg741700.html">[PATCH 1/3] arm64: kprobes: Recover pstate.D in single-step exception handler</a></strong>
<ul><li><em>From:</em> Masami Hiramatsu</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg741924.html">Re: [PATCH 14/18] drivers: firmware: psci: Manage runtime PM in the idle path for CPUs</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg741926.html">[PATCH v2] arm64: vdso: Cleanup Makefiles</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg741700.html">[PATCH 1/3] arm64: kprobes: Recover pstate.D in single-step exception handler</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg742023.html">Re: [PATCH 1/3] arm64: kprobes: Recover pstate.D in single-step exception handler</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#741925"><strong>Date</strong></a></li>
<li><a href="threads.html#741925"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-arm/>[Linux&nbsp;ARM&nbsp;(vger)]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-arm-msm/>[Linux&nbsp;ARM&nbsp;MSM]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;Omap]</a>
&nbsp;
&nbsp;
<a href=/lists/centos-arm-devel/>[CentOS&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/arm/>[Linux&nbsp;Arm]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-tegra/>[Linux&nbsp;Tegra]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-arm/>[Fedora&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;for&nbsp;Samsung&nbsp;SOC]</a>
&nbsp;
&nbsp;
<a href=/lists/ecos/>[eCos]</a>
&nbsp;
&nbsp;
<a href=/lists/fastboot/>[Linux&nbsp;Fastboot]</a>
&nbsp;
&nbsp;
<a href=/lists/gcchelp/>[Gcc&nbsp;Help]</a>
&nbsp;
&nbsp;
<a href=/lists/git/>[Git]</a>
&nbsp;
&nbsp;
<a href=/lists/dccp/>[DCCP]</a>
&nbsp;
&nbsp;
<a href=/lists/ietf-ann>[IETF&nbsp;Announce]</a>
&nbsp;
&nbsp;
<a href=/lists/security/>[Security]</a>
&nbsp;
&nbsp;
<a href=/lists/mips/>[Linux&nbsp;MIPS]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }

initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

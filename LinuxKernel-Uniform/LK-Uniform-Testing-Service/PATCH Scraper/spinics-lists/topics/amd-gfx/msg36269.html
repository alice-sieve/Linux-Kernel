<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH] drm/amd/powerplay: change smu_read_sensor sequence in smu -->
<!--X-From-R13: Oyrk Rrhpure &#60;nyrkqrhpureNtznvy.pbz> -->
<!--X-Date: Fri, 19 Jul 2019 08:17:22 &#45;0700 -->
<!--X-Message-Id: CADnq5_P2UVmm4P1myih0UOQ2nvLDB01zdaFN9v7p423QeLASKg@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190719112232.28485&#45;1&#45;kevin1.wang@amd.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="AMD GFX: Re: [PATCH] drm/amd/powerplay: change smu_read_sensor sequence in smu">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH] drm/amd/powerplay: change smu_read_sensor sequence in smu &mdash; Linux AMD GFX</title>
<link rel="alternate" type="application/rss+xml" title="Linux AMD GFX" href="//feeds.feedburner.com/LinuxAmdGraphics">
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en" async defer></script>
<h1 itemprop="name">Re: [PATCH] drm/amd/powerplay: change smu_read_sensor sequence in smu</h1>
[<a href="msg36268.html">Date Prev</a>][<a href="msg36270.html">Date Next</a>][<a href="msg36261.html">Thread Prev</a>][<a href="msg36270.html">Thread Next</a>][<a href="maillist.html#36269">Date Index</a>][<a href="index.html#36269">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: &quot;Wang, Kevin(Yang)&quot; &lt;Kevin1.Wang@xxxxxxx&gt;</li>
<li><em>Subject</em>: Re: [PATCH] drm/amd/powerplay: change smu_read_sensor sequence in smu</li>
<li><em>From</em>: Alex Deucher &lt;alexdeucher@xxxxxxxxx&gt;</li>
<li><em>Date</em>: Fri, 19 Jul 2019 11:17:05 -0400</li>
<li><em>Cc</em>: &quot;Huang, Ray&quot; &lt;Ray.Huang@xxxxxxx&gt;, &quot;Feng, Kenneth&quot; &lt;Kenneth.Feng@xxxxxxx&gt;,        &quot;amd-gfx@xxxxxxxxxxxxxxxxxxxxx&quot; &lt;amd-gfx@xxxxxxxxxxxxxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg36261.html">20190719112232.28485-1-kevin1.wang@amd.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg36261.html">20190719112232.28485-1-kevin1.wang@amd.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Fri, Jul 19, 2019 at 7:23 AM Wang, Kevin(Yang) &lt;Kevin1.Wang@xxxxxxx&gt; wrote:
&gt;<i></i>
&gt;<i> each asic maybe has different read sensor method.</i>
&gt;<i> so change read sensor sequence in smu.</i>
&gt;<i></i>
&gt;<i> read sensor sequence:</i>
&gt;<i> asic sensor --&gt; smc sensor (smu 11...) --&gt; default_sensor (common)</i>

I think this makes sense.  That said, the current swSMU callback
structures are really confusing.  I think we should switch to a single
set of per asic callbacks and then add common helpers.  Then for asics
where it makes sense we can just use the helper as the callback for
all relevant asics.  If they need something asic specific, use the
asic specific function.  That should avoid the current mix of
callbacks and make it clearer what code gets used when.

Alex

&gt;<i></i>
&gt;<i> Signed-off-by: Kevin Wang &lt;kevin1.wang@xxxxxxx&gt;</i>
&gt;<i> ---</i>
&gt;<i>  drivers/gpu/drm/amd/powerplay/amdgpu_smu.c    | 26 +++++++++++++++++--</i>
&gt;<i>  .../gpu/drm/amd/powerplay/inc/amdgpu_smu.h    |  9 ++++---</i>
&gt;<i>  drivers/gpu/drm/amd/powerplay/navi10_ppt.c    |  3 +++</i>
&gt;<i>  drivers/gpu/drm/amd/powerplay/smu_v11_0.c     | 10 +++----</i>
&gt;<i>  drivers/gpu/drm/amd/powerplay/vega20_ppt.c    |  3 +++</i>
&gt;<i>  5 files changed, 40 insertions(+), 11 deletions(-)</i>
&gt;<i></i>
&gt;<i> diff --git a/drivers/gpu/drm/amd/powerplay/amdgpu_smu.c b/drivers/gpu/drm/amd/powerplay/amdgpu_smu.c</i>
&gt;<i> index 05b91bc5054c..85269f86cae2 100644</i>
&gt;<i> --- a/drivers/gpu/drm/amd/powerplay/amdgpu_smu.c</i>
&gt;<i> +++ b/drivers/gpu/drm/amd/powerplay/amdgpu_smu.c</i>
&gt;<i> @@ -284,11 +284,14 @@ int smu_get_power_num_states(struct smu_context *smu,</i>
&gt;<i>         return 0;</i>
&gt;<i>  }</i>
&gt;<i></i>
&gt;<i> -int smu_common_read_sensor(struct smu_context *smu, enum amd_pp_sensors sensor,</i>
&gt;<i> -                          void *data, uint32_t *size)</i>
&gt;<i> +int smu_default_read_sensor(struct smu_context *smu, enum amd_pp_sensors sensor,</i>
&gt;<i> +                           void *data, uint32_t *size)</i>
&gt;<i>  {</i>
&gt;<i>         int ret = 0;</i>
&gt;<i></i>
&gt;<i> +       if (!data || !size)</i>
&gt;<i> +               return -EINVAL;</i>
&gt;<i> +</i>
&gt;<i>         switch (sensor) {</i>
&gt;<i>         case AMDGPU_PP_SENSOR_STABLE_PSTATE_SCLK:</i>
&gt;<i>                 *((uint32_t *)data) = smu-&gt;pstate_sclk;</i>
&gt;<i> @@ -321,6 +324,25 @@ int smu_common_read_sensor(struct smu_context *smu, enum amd_pp_sensors sensor,</i>
&gt;<i>         return ret;</i>
&gt;<i>  }</i>
&gt;<i></i>
&gt;<i> +int smu_read_sensor(struct smu_context *smu, enum amd_pp_sensors sensor,</i>
&gt;<i> +                   void *data, uint32_t *size)</i>
&gt;<i> +{</i>
&gt;<i> +       int ret = 0;</i>
&gt;<i> +</i>
&gt;<i> +       if (!data || !size)</i>
&gt;<i> +               return -EINVAL;</i>
&gt;<i> +</i>
&gt;<i> +       /* handle sensor sequence: asic --&gt; ip level --&gt;  default */</i>
&gt;<i> +       ret = smu_asic_read_sensor(smu, sensor, data, size);</i>
&gt;<i> +       if (ret) {</i>
&gt;<i> +               ret = smu_smc_read_sensor(smu, sensor, data, size);</i>
&gt;<i> +               if (ret)</i>
&gt;<i> +                       ret = smu_default_read_sensor(smu, sensor, data, size);</i>
&gt;<i> +       }</i>
&gt;<i> +</i>
&gt;<i> +       return ret;</i>
&gt;<i> +}</i>
&gt;<i> +</i>
&gt;<i>  int smu_update_table(struct smu_context *smu, enum smu_table_id table_index, int argument,</i>
&gt;<i>                      void *table_data, bool drv2smu)</i>
&gt;<i>  {</i>
&gt;<i> diff --git a/drivers/gpu/drm/amd/powerplay/inc/amdgpu_smu.h b/drivers/gpu/drm/amd/powerplay/inc/amdgpu_smu.h</i>
&gt;<i> index 34093ddca105..462bae8d62aa 100644</i>
&gt;<i> --- a/drivers/gpu/drm/amd/powerplay/inc/amdgpu_smu.h</i>
&gt;<i> +++ b/drivers/gpu/drm/amd/powerplay/inc/amdgpu_smu.h</i>
&gt;<i> @@ -820,10 +820,10 @@ struct smu_funcs</i>
&gt;<i>         ((smu)-&gt;ppt_funcs-&gt;set_thermal_fan_table ? (smu)-&gt;ppt_funcs-&gt;set_thermal_fan_table((smu)) : 0)</i>
&gt;<i>  #define smu_start_thermal_control(smu) \</i>
&gt;<i>         ((smu)-&gt;funcs-&gt;start_thermal_control? (smu)-&gt;funcs-&gt;start_thermal_control((smu)) : 0)</i>
&gt;<i> -#define smu_read_sensor(smu, sensor, data, size) \</i>
&gt;<i> -       ((smu)-&gt;funcs-&gt;read_sensor? (smu)-&gt;funcs-&gt;read_sensor((smu), (sensor), (data), (size)) : 0)</i>
&gt;<i> +#define smu_smc_read_sensor(smu, sensor, data, size) \</i>
&gt;<i> +       ((smu)-&gt;funcs-&gt;read_sensor? (smu)-&gt;funcs-&gt;read_sensor((smu), (sensor), (data), (size)) : -EINVAL)</i>
&gt;<i>  #define smu_asic_read_sensor(smu, sensor, data, size) \</i>
&gt;<i> -       ((smu)-&gt;ppt_funcs-&gt;read_sensor? (smu)-&gt;ppt_funcs-&gt;read_sensor((smu), (sensor), (data), (size)) : 0)</i>
&gt;<i> +       ((smu)-&gt;ppt_funcs-&gt;read_sensor? (smu)-&gt;ppt_funcs-&gt;read_sensor((smu), (sensor), (data), (size)) : -EINVAL)</i>
&gt;<i>  #define smu_get_power_profile_mode(smu, buf) \</i>
&gt;<i>         ((smu)-&gt;ppt_funcs-&gt;get_power_profile_mode ? (smu)-&gt;ppt_funcs-&gt;get_power_profile_mode((smu), buf) : 0)</i>
&gt;<i>  #define smu_set_power_profile_mode(smu, param, param_size) \</i>
&gt;<i> @@ -989,5 +989,6 @@ enum amd_dpm_forced_level smu_get_performance_level(struct smu_context *smu);</i>
&gt;<i>  int smu_force_performance_level(struct smu_context *smu, enum amd_dpm_forced_level level);</i>
&gt;<i>  int smu_set_display_count(struct smu_context *smu, uint32_t count);</i>
&gt;<i>  bool smu_clk_dpm_is_enabled(struct smu_context *smu, enum smu_clk_type clk_type);</i>
&gt;<i> -</i>
&gt;<i> +int smu_read_sensor(struct smu_context *smu, enum amd_pp_sensors sensor,</i>
&gt;<i> +                   void *data, uint32_t *size);</i>
&gt;<i>  #endif</i>
&gt;<i> diff --git a/drivers/gpu/drm/amd/powerplay/navi10_ppt.c b/drivers/gpu/drm/amd/powerplay/navi10_ppt.c</i>
&gt;<i> index 46e2913e4af4..0a53695785b6 100644</i>
&gt;<i> --- a/drivers/gpu/drm/amd/powerplay/navi10_ppt.c</i>
&gt;<i> +++ b/drivers/gpu/drm/amd/powerplay/navi10_ppt.c</i>
&gt;<i> @@ -1365,6 +1365,9 @@ static int navi10_read_sensor(struct smu_context *smu,</i>
&gt;<i>         struct smu_table_context *table_context = &amp;smu-&gt;smu_table;</i>
&gt;<i>         PPTable_t *pptable = table_context-&gt;driver_pptable;</i>
&gt;<i></i>
&gt;<i> +       if (!data || !size)</i>
&gt;<i> +               return -EINVAL;</i>
&gt;<i> +</i>
&gt;<i>         switch (sensor) {</i>
&gt;<i>         case AMDGPU_PP_SENSOR_MAX_FAN_RPM:</i>
&gt;<i>                 *(uint32_t *)data = pptable-&gt;FanMaximumRpm;</i>
&gt;<i> diff --git a/drivers/gpu/drm/amd/powerplay/smu_v11_0.c b/drivers/gpu/drm/amd/powerplay/smu_v11_0.c</i>
&gt;<i> index 76bc157525d0..2679b6ff6ca3 100644</i>
&gt;<i> --- a/drivers/gpu/drm/amd/powerplay/smu_v11_0.c</i>
&gt;<i> +++ b/drivers/gpu/drm/amd/powerplay/smu_v11_0.c</i>
&gt;<i> @@ -1267,6 +1267,10 @@ static int smu_v11_0_read_sensor(struct smu_context *smu,</i>
&gt;<i>                                  void *data, uint32_t *size)</i>
&gt;<i>  {</i>
&gt;<i>         int ret = 0;</i>
&gt;<i> +</i>
&gt;<i> +       if (!data || !size)</i>
&gt;<i> +               return -EINVAL;</i>
&gt;<i> +</i>
&gt;<i>         switch (sensor) {</i>
&gt;<i>         case AMDGPU_PP_SENSOR_GFX_MCLK:</i>
&gt;<i>                 ret = smu_get_current_clk_freq(smu, SMU_UCLK, (uint32_t *)data);</i>
&gt;<i> @@ -1285,14 +1289,10 @@ static int smu_v11_0_read_sensor(struct smu_context *smu,</i>
&gt;<i>                 *size = 4;</i>
&gt;<i>                 break;</i>
&gt;<i>         default:</i>
&gt;<i> -               ret = smu_common_read_sensor(smu, sensor, data, size);</i>
&gt;<i> +               ret = -EINVAL;</i>
&gt;<i>                 break;</i>
&gt;<i>         }</i>
&gt;<i></i>
&gt;<i> -       /* try get sensor data by asic */</i>
&gt;<i> -       if (ret)</i>
&gt;<i> -               ret = smu_asic_read_sensor(smu, sensor, data, size);</i>
&gt;<i> -</i>
&gt;<i>         if (ret)</i>
&gt;<i>                 *size = 0;</i>
&gt;<i></i>
&gt;<i> diff --git a/drivers/gpu/drm/amd/powerplay/vega20_ppt.c b/drivers/gpu/drm/amd/powerplay/vega20_ppt.c</i>
&gt;<i> index bcd0efaf7bbd..b44ec7c670c5 100644</i>
&gt;<i> --- a/drivers/gpu/drm/amd/powerplay/vega20_ppt.c</i>
&gt;<i> +++ b/drivers/gpu/drm/amd/powerplay/vega20_ppt.c</i>
&gt;<i> @@ -3146,6 +3146,9 @@ static int vega20_read_sensor(struct smu_context *smu,</i>
&gt;<i>         struct smu_table_context *table_context = &amp;smu-&gt;smu_table;</i>
&gt;<i>         PPTable_t *pptable = table_context-&gt;driver_pptable;</i>
&gt;<i></i>
&gt;<i> +       if (!data || !size)</i>
&gt;<i> +               return -EINVAL;</i>
&gt;<i> +</i>
&gt;<i>         switch (sensor) {</i>
&gt;<i>         case AMDGPU_PP_SENSOR_MAX_FAN_RPM:</i>
&gt;<i>                 *(uint32_t *)data = pptable-&gt;FanMaximumRpm;</i>
&gt;<i> --</i>
&gt;<i> 2.22.0</i>
&gt;<i></i>
&gt;<i> _______________________________________________</i>
&gt;<i> amd-gfx mailing list</i>
&gt;<i> amd-gfx@xxxxxxxxxxxxxxxxxxxxx</i>
&gt;<i> <a  rel="nofollow" href="https://lists.freedesktop.org/mailman/listinfo/amd-gfx">https://lists.freedesktop.org/mailman/listinfo/amd-gfx</a></i>
_______________________________________________
amd-gfx mailing list
amd-gfx@xxxxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://lists.freedesktop.org/mailman/listinfo/amd-gfx">https://lists.freedesktop.org/mailman/listinfo/amd-gfx</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="36270" href="msg36270.html">Re: [PATCH] drm/amd/powerplay: change smu_read_sensor sequence in smu</a></strong>
<ul><li><em>From:</em> Wang, Kevin(Yang)</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="36261" href="msg36261.html">[PATCH] drm/amd/powerplay: change smu_read_sensor sequence in smu</a></strong>
<ul><li><em>From:</em> Wang, Kevin(Yang)</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg36268.html">some render processes enter the D state, waiting for the dma fence , without GPU hang</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg36270.html">Re: [PATCH] drm/amd/powerplay: change smu_read_sensor sequence in smu</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg36261.html">[PATCH] drm/amd/powerplay: change smu_read_sensor sequence in smu</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg36270.html">Re: [PATCH] drm/amd/powerplay: change smu_read_sensor sequence in smu</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#36269"><strong>Date</strong></a></li>
<li><a href="index.html#36269"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

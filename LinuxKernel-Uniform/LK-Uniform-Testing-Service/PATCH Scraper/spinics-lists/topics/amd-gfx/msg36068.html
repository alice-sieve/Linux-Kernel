<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH 2/2] drm/amdgpu: Fix silent amdgpu_bo_move failures -->
<!--X-From-R13: =?GFT&#45;8?C?Quevfgvna_Y=p3=o6avt?= &#60;pxbravt.yrvpugmhzrexraNtznvy.pbz> -->
<!--X-Date: Tue, 16 Jul 2019 02:29:25 &#45;0700 -->
<!--X-Message-Id: 166533ad&#45;2894&#45;5a93&#45;d5dc&#45;09887c3067e3@gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190713064211.20047&#45;1&#45;Felix.Kuehling@amd.com -->
<!--X-Reference: 20190713064211.20047&#45;2&#45;Felix.Kuehling@amd.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="AMD GFX: Re: [PATCH 2/2] drm/amdgpu: Fix silent amdgpu_bo_move failures">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH 2/2] drm/amdgpu: Fix silent amdgpu_bo_move failures &mdash; Linux AMD GFX</title>
<link rel="alternate" type="application/rss+xml" title="Linux AMD GFX" href="//feeds.feedburner.com/LinuxAmdGraphics">
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en" async defer></script>
<h1 itemprop="name">Re: [PATCH 2/2] drm/amdgpu: Fix silent amdgpu_bo_move failures</h1>
[<a href="msg36067.html">Date Prev</a>][<a href="msg36069.html">Date Next</a>][<a href="msg35808.html">Thread Prev</a>][<a href="msg36067.html">Thread Next</a>][<a href="maillist.html#36068">Date Index</a>][<a href="index.html#36068">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: &quot;Kuehling, Felix&quot; &lt;Felix.Kuehling@xxxxxxx&gt;,        &quot;amd-gfx@xxxxxxxxxxxxxxxxxxxxx&quot; &lt;amd-gfx@xxxxxxxxxxxxxxxxxxxxx&gt;</li>
<li><em>Subject</em>: Re: [PATCH 2/2] drm/amdgpu: Fix silent amdgpu_bo_move failures</li>
<li><em>From</em>: Christian K&#xF6;nig &lt;ckoenig.leichtzumerken@xxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 16 Jul 2019 11:29:19 +0200</li>
<li><em>In-reply-to</em>: &lt;<a href="msg35808.html">20190713064211.20047-2-Felix.Kuehling@amd.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg35807.html">20190713064211.20047-1-Felix.Kuehling@amd.com</a>&gt; &lt;<a href="msg35808.html">20190713064211.20047-2-Felix.Kuehling@amd.com</a>&gt;</li>
<li><em>Reply-to</em>: christian.koenig@xxxxxxx</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Thunderbird/60.7.2</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
Am 13.07.19 um 08:42 schrieb Kuehling, Felix:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Under memory pressure, buffer moves between RAM to VRAM  can
fail when there is no GTT space available. In those cases
amdgpu_bo_move falls back to ttm_bo_move_memcpy, which seems to
succeed, although it doesn't really support non-contiguous or
invisible VRAM. This manifests as VM faults with corrupted page
table entries in KFD eviction stress tests.

Print some helpful messages when lack of GTT space is causing buffer
moves to fail. Check that source and destination memory regions are
supported by ttm_bo_move_memcpy before taking that fallback.

Signed-off-by: Felix Kuehling &lt;Felix.Kuehling@xxxxxxx&gt;
</pre></blockquote><pre style="margin: 0em;">

Reviewed-by: Christian K&#xF6;nig &lt;christian.koenig@xxxxxxx&gt;

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
---
  drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c | 40 +++++++++++++++++++++++--
  1 file changed, 37 insertions(+), 3 deletions(-)

diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c
index 78440748c87f..37d9a3b09946 100644
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c
@@ -498,6 +498,7 @@ static int amdgpu_move_vram_ram(struct ttm_buffer_object *bo, bool evict,
  	placements.flags = TTM_PL_MASK_CACHING | TTM_PL_FLAG_TT;
  	r = ttm_bo_mem_space(bo, &amp;placement, &amp;tmp_mem, ctx);
  	if (unlikely(r)) {
+		pr_err(&quot;Failed to find GTT space for blit from VRAM\n&quot;);
  		return r;
  	}
</pre><tt>  
</tt><tt>@@ -556,6 +557,7 @@ static int amdgpu_move_ram_vram(struct ttm_buffer_object *bo, bool evict,
</tt><pre style="margin: 0em;">
  	placements.flags = TTM_PL_MASK_CACHING | TTM_PL_FLAG_TT;
  	r = ttm_bo_mem_space(bo, &amp;placement, &amp;tmp_mem, ctx);
  	if (unlikely(r)) {
+		pr_err(&quot;Failed to find GTT space for blit to VRAM\n&quot;);
  		return r;
  	}
</pre><tt>  
</tt><tt>@@ -575,6 +577,30 @@ static int amdgpu_move_ram_vram(struct ttm_buffer_object *bo, bool evict,
</tt><pre style="margin: 0em;">
  	return r;
  }
</pre><tt>  
</tt><tt>+/**
</tt><pre style="margin: 0em;">
+ * amdgpu_mem_visible - Check that memory can be accessed by ttm_bo_move_memcpy
+ *
+ * Called by amdgpu_bo_move()
+ */
+static bool amdgpu_mem_visible(struct amdgpu_device *adev,
+			       struct ttm_mem_reg *mem)
+{
+	struct drm_mm_node *nodes = mem-&gt;mm_node;
+
+	if (mem-&gt;mem_type == TTM_PL_SYSTEM ||
+	    mem-&gt;mem_type == TTM_PL_TT)
+		return true;
+	if (mem-&gt;mem_type != TTM_PL_VRAM)
+		return false;
+
+	/* ttm_mem_reg_ioremap only supports contiguous memory */
+	if (nodes-&gt;size != mem-&gt;num_pages)
+		return false;
+
+	return ((nodes-&gt;start + nodes-&gt;size) &lt;&lt; PAGE_SHIFT)
+		&lt;= adev-&gt;gmc.visible_vram_size;
+}
+
  /**
   * amdgpu_bo_move - Move a buffer object to a new memory location
   *
@@ -619,8 +645,10 @@ static int amdgpu_bo_move(struct ttm_buffer_object *bo, bool evict,
  		return 0;
  	}
</pre><tt>  
</tt><tt>-	if (!adev-&gt;mman.buffer_funcs_enabled)
</tt><pre style="margin: 0em;">
+	if (!adev-&gt;mman.buffer_funcs_enabled) {
+		r = -ENODEV;
  		goto memcpy;
+	}
</pre><tt>  
</tt><tt>  	if (old_mem-&gt;mem_type == TTM_PL_VRAM &amp;&amp;
</tt><pre style="margin: 0em;">
  	    new_mem-&gt;mem_type == TTM_PL_SYSTEM) {
@@ -635,10 +663,16 @@ static int amdgpu_bo_move(struct ttm_buffer_object *bo, bool evict,
</pre><tt>  
</tt><tt>  	if (r) {
</tt><pre style="margin: 0em;">
  memcpy:
-		r = ttm_bo_move_memcpy(bo, ctx, new_mem);
-		if (r) {
+		/* Check that all memory is CPU accessible */
+		if (!amdgpu_mem_visible(adev, old_mem) ||
+		    !amdgpu_mem_visible(adev, new_mem)) {
+			pr_err(&quot;Move buffer fallback to memcpy unavailable\n&quot;);
  			return r;
  		}
+
+		r = ttm_bo_move_memcpy(bo, ctx, new_mem);
+		if (r)
+			return r;
  	}
</pre><tt>  
</tt><tt>  	if (bo-&gt;type == ttm_bo_type_device &amp;&amp;
</tt></blockquote><pre style="margin: 0em;">

_______________________________________________
amd-gfx mailing list
amd-gfx@xxxxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://lists.freedesktop.org/mailman/listinfo/amd-gfx">https://lists.freedesktop.org/mailman/listinfo/amd-gfx</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="35807" href="msg35807.html">[PATCH 1/2] drm/amdgpu: Dump PDEs and PTEs on VM faults (v3)</a></strong>
<ul><li><em>From:</em> Kuehling, Felix</li></ul></li>
<li><strong><a name="35808" href="msg35808.html">[PATCH 2/2] drm/amdgpu: Fix silent amdgpu_bo_move failures</a></strong>
<ul><li><em>From:</em> Kuehling, Felix</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg36067.html">Re: [PATCH 1/2] drm/amdgpu: Dump PDEs and PTEs on VM faults (v3)</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg36069.html">[PATCH] drm/amd/amdgpu: Fix offset for vmid selection in debugfs interface</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg35808.html">[PATCH 2/2] drm/amdgpu: Fix silent amdgpu_bo_move failures</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg36067.html">Re: [PATCH 1/2] drm/amdgpu: Dump PDEs and PTEs on VM faults (v3)</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#36068"><strong>Date</strong></a></li>
<li><a href="index.html#36068"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH 3/3] drm/amdgpu: Implement clearing of sensitive VRAM -->
<!--X-From-R13: "Yhruyvat, Tryvk" &#60;Tryvk.YhruyvatNnzq.pbz> -->
<!--X-Date: Mon, 8 Jul 2019 22:32:59 &#45;0700 -->
<!--X-Message-Id: 20190709053222.22588&#45;3&#45;Felix.Kuehling@amd.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190709053222.22588&#45;1&#45;Felix.Kuehling@amd.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="AMD GFX: [PATCH 3/3] drm/amdgpu: Implement clearing of sensitive VRAM">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[PATCH 3/3] drm/amdgpu: Implement clearing of sensitive VRAM &mdash; Linux AMD GFX</title>
<link rel="alternate" type="application/rss+xml" title="Linux AMD GFX" href="//feeds.feedburner.com/LinuxAmdGraphics">
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en" async defer></script>
<h1 itemprop="name">[PATCH 3/3] drm/amdgpu: Implement clearing of sensitive VRAM</h1>
[<a href="msg35652.html">Date Prev</a>][<a href="msg35654.html">Date Next</a>][<a href="msg35651.html">Thread Prev</a>][<a href="msg35655.html">Thread Next</a>][<a href="maillist.html#35653">Date Index</a>][<a href="index.html#35653">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: &quot;amd-gfx@xxxxxxxxxxxxxxxxxxxxx&quot; &lt;amd-gfx@xxxxxxxxxxxxxxxxxxxxx&gt;</li>
<li><em>Subject</em>: [PATCH 3/3] drm/amdgpu: Implement clearing of sensitive VRAM</li>
<li><em>From</em>: &quot;Kuehling, Felix&quot; &lt;Felix.Kuehling@xxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 9 Jul 2019 05:32:53 +0000</li>
<li><em>Accept-language</em>: en-US</li>
<li><em>Cc</em>: &quot;Kuehling, Felix&quot; &lt;Felix.Kuehling@xxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg35652.html">20190709053222.22588-1-Felix.Kuehling@amd.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg35652.html">20190709053222.22588-1-Felix.Kuehling@amd.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Clear VRAM memory containing sensitive data before freeing it. Doing
this in the VRAM manager's put_node callback covers all cases that
release memory, including freeing, moving or evicting BOs. To
minimize the performance impact, use the mman-&gt;move fence to delay
future memory allocations rather than waiting for completion inside
the memory free code path. This is the same mechanism used to wait
for pipelined evictions from VRAM.

Signed-off-by: Felix Kuehling &lt;Felix.Kuehling@xxxxxxx&gt;
---
 drivers/gpu/drm/amd/amdgpu/amdgpu_vram_mgr.c | 94 ++++++++++++++++++++
 1 file changed, 94 insertions(+)

diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_vram_mgr.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_vram_mgr.c
index 1150e34bc28f..02594230d29f 100644
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_vram_mgr.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_vram_mgr.c
@@ -359,6 +359,12 @@ static int amdgpu_vram_mgr_new(struct ttm_mem_type_manager *man,
 	atomic64_add(vis_usage, &amp;mgr-&gt;vis_usage);
 
 	mem-&gt;mm_node = nodes;
+	/* Remember the sensitive flag in the color of the first
+	 * node. While the node is allocated, drm_mm doesn't use
+	 * it for anything else.
+	 */
+	nodes[0].color = (ttm_to_amdgpu_bo(tbo)-&gt;flags &amp;
+			  AMDGPU_GEM_CREATE_VRAM_SENSITIVE);
 
 	return 0;
 
@@ -372,6 +378,69 @@ static int amdgpu_vram_mgr_new(struct ttm_mem_type_manager *man,
 	return r == -ENOSPC ? 0 : r;
 }
 
+/**
+ * clear_mem_reg - clear VRAM memory from a mem_reg
+ *
+ * @adev: amdgpu_device_pointer
+ * @mem: TTM memory object
+ * @fence: used to store a pointer to the fence signaling completion
+ *
+ * This is the fast version using SDMA.
+ *
+ * Returns:
+ * 0 on success, negavite error code otherwise.
+ */
+static int clear_mem_reg(struct amdgpu_device *adev, struct ttm_mem_reg *mem,
+			 struct dma_fence **fence)
+{
+	const uint32_t max_pages =
+		adev-&gt;mman.buffer_funcs-&gt;fill_max_bytes &gt;&gt; PAGE_SHIFT;
+	struct amdgpu_ring *ring = adev-&gt;mman.buffer_funcs_ring;
+	struct drm_mm_node *nodes;
+	struct amdgpu_job *job;
+	unsigned int pages, num_dw = 64; /* for IB padding */
+	int r;
+
+	if (unlikely(!adev-&gt;mman.buffer_funcs_enabled))
+		return -ENODEV;
+
+	for (pages = mem-&gt;num_pages, nodes = mem-&gt;mm_node; pages;
+	     pages -= nodes-&gt;size, ++nodes)
+		num_dw += DIV_ROUND_UP(nodes-&gt;size, max_pages) *
+			adev-&gt;mman.buffer_funcs-&gt;fill_num_dw;
+
+	r = amdgpu_job_alloc_with_ib(adev, num_dw * 4, &amp;job);
+	if (unlikely(r))
+		return r;
+
+	for (pages = mem-&gt;num_pages, nodes = mem-&gt;mm_node; pages;
+	     pages -= nodes-&gt;size, ++nodes) {
+		uint64_t page_count = nodes-&gt;size;
+		uint64_t dst_addr = (nodes-&gt;start &lt;&lt; PAGE_SHIFT) +
+			adev-&gt;gmc.vram_start;
+
+		while (page_count) {
+			uint32_t cur_size_in_pages =
+				min_t(uint64_t, page_count, max_pages);
+
+			amdgpu_emit_fill_buffer(adev, &amp;job-&gt;ibs[0], 0, dst_addr,
+						cur_size_in_pages
+						&lt;&lt; PAGE_SHIFT);
+			dst_addr += (uint64_t)cur_size_in_pages &lt;&lt; PAGE_SHIFT;
+			page_count -= cur_size_in_pages;
+		}
+	}
+
+	amdgpu_ring_pad_ib(ring, &amp;job-&gt;ibs[0]);
+	WARN_ON(job-&gt;ibs[0].length_dw &gt; num_dw);
+	r = amdgpu_job_submit(job, &amp;adev-&gt;mman.entity,
+			      AMDGPU_FENCE_OWNER_UNDEFINED, fence);
+	if (unlikely(r))
+		amdgpu_job_free(job);
+
+	return r;
+}
+
 /**
  * amdgpu_vram_mgr_del - free ranges
  *
@@ -390,10 +459,35 @@ static void amdgpu_vram_mgr_del(struct ttm_mem_type_manager *man,
 	struct drm_mm_node *nodes = mem-&gt;mm_node;
 	uint64_t usage = 0, vis_usage = 0;
 	unsigned pages = mem-&gt;num_pages;
+	struct dma_fence *fence;
 
 	if (!mem-&gt;mm_node)
 		return;
 
+	if (nodes[0].color &amp; AMDGPU_GEM_CREATE_VRAM_SENSITIVE) {
+		int r = clear_mem_reg(adev, mem, &amp;fence);
+
+		/* FIXME: It may be better to leak memory than to
+		 * allow reusing it without clearing.
+		 */
+		WARN_ON(r);
+
+		/* Clearing memory happens in the background. But new
+		 * memory cannot be allocated until clearing is
+		 * completed. Update the move fence to ensure that.
+		 */
+		if (!r &amp;&amp; fence) {
+			spin_lock(&amp;man-&gt;move_lock);
+			if (!man-&gt;move ||
+			    dma_fence_is_later(fence, man-&gt;move)) {
+				dma_fence_put(man-&gt;move);
+				man-&gt;move = dma_fence_get(fence);
+			}
+			spin_unlock(&amp;man-&gt;move_lock);
+			dma_fence_put(fence);
+		}
+	}
+
 	spin_lock(&amp;mgr-&gt;lock);
 	while (pages) {
 		pages -= nodes-&gt;size;
-- 
2.17.1

_______________________________________________
amd-gfx mailing list
amd-gfx@xxxxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://lists.freedesktop.org/mailman/listinfo/amd-gfx">https://lists.freedesktop.org/mailman/listinfo/amd-gfx</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="35652" href="msg35652.html">[PATCH 1/3] drm/amdgpu: Add flag for allocating memory for sensitive data</a></strong>
<ul><li><em>From:</em> Kuehling, Felix</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg35652.html">[PATCH 1/3] drm/amdgpu: Add flag for allocating memory for sensitive data</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg35654.html">[PATCH] drm/amd/powerplay: increase the SMU msg response waiting time</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg35651.html">[PATCH 2/3] drm/amdgpu: Mark KFD VRAM allocations as sensitive</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg35655.html">Re: [PATCH 1/3] drm/amdgpu: Add flag for allocating memory for sensitive data</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#35653"><strong>Date</strong></a></li>
<li><a href="index.html#35653"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

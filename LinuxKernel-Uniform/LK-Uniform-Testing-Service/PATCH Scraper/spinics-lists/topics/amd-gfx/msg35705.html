<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH 02/10] drm/dp_mst: Enable registration of AUX devices for MST ports (v2) -->
<!--X-From-R13: Zlhqr Bnhy &#60;ylhqrNerqung.pbz> -->
<!--X-Date: Wed, 10 Jul 2019 12:52:01 &#45;0700 -->
<!--X-Message-Id: f7c74bb4b7814cc9f62f59b6db3dbb6d1530d46a.camel@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190704190519.29525&#45;1&#45;sunpeng.li@amd.com -->
<!--X-Reference: 20190704190519.29525&#45;3&#45;sunpeng.li@amd.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="AMD GFX: Re: [PATCH 02/10] drm/dp_mst: Enable registration of AUX devices for MST ports (v2)">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH 02/10] drm/dp_mst: Enable registration of AUX devices for MST ports (v2) &mdash; Linux AMD GFX</title>
<link rel="alternate" type="application/rss+xml" title="Linux AMD GFX" href="//feeds.feedburner.com/LinuxAmdGraphics">
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en" async defer></script>
<h1 itemprop="name">Re: [PATCH 02/10] drm/dp_mst: Enable registration of AUX devices for MST ports (v2)</h1>
[<a href="msg35704.html">Date Prev</a>][<a href="msg35706.html">Date Next</a>][<a href="msg35557.html">Thread Prev</a>][<a href="msg35708.html">Thread Next</a>][<a href="maillist.html#35705">Date Index</a>][<a href="index.html#35705">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: sunpeng.li@xxxxxxx, amd-gfx@xxxxxxxxxxxxxxxxxxxxx,        dri-devel@xxxxxxxxxxxxxxxxxxxxx</li>
<li><em>Subject</em>: Re: [PATCH 02/10] drm/dp_mst: Enable registration of AUX devices for MST ports (v2)</li>
<li><em>From</em>: Lyude Paul &lt;lyude@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Wed, 10 Jul 2019 15:51:42 -0400</li>
<li><em>Cc</em>: ville.syrjala@xxxxxxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg35557.html">20190704190519.29525-3-sunpeng.li@amd.com</a>&gt;</li>
<li><em>Organization</em>: Red Hat</li>
<li><em>References</em>: &lt;<a href="msg35555.html">20190704190519.29525-1-sunpeng.li@amd.com</a>&gt; &lt;<a href="msg35557.html">20190704190519.29525-3-sunpeng.li@amd.com</a>&gt;</li>
<li><em>User-agent</em>: Evolution 3.32.3 (3.32.3-1.fc30) </li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Some small nitpicks

On Thu, 2019-07-04 at 15:05 -0400, sunpeng.li@xxxxxxx wrote:
&gt;<i> From: Ville Syrj&#xE4;l&#xE4; &lt;ville.syrjala@xxxxxxxxxxxxxxx&gt;</i>
&gt;<i> </i>
&gt;<i> All available downstream ports - physical and logical - are exposed for</i>
&gt;<i> each MST device. They are listed in /dev/, following the same naming</i>
&gt;<i> scheme as SST devices by appending an incremental ID.</i>
&gt;<i> </i>
&gt;<i> Although all downstream ports are exposed, only some will work as</i>
&gt;<i> expected. Consider the following topology:</i>
&gt;<i> </i>
&gt;<i>                +---------+</i>
&gt;<i>                |  ASIC   |</i>
&gt;<i>                +---------+</i>
&gt;<i>               Conn-0|</i>
&gt;<i>                     |</i>
&gt;<i>                +----v----+</i>
&gt;<i>           +----| MST HUB |----+</i>
&gt;<i>           |    +---------+    |</i>
&gt;<i>           |                   |</i>
&gt;<i>           |Port-1       Port-2|</i>
&gt;<i>     +-----v-----+       +-----v-----+</i>
&gt;<i>     |  MST      |       |  SST      |</i>
&gt;<i>     |  Display  |       |  Display  |</i>
&gt;<i>     +-----------+       +-----------+</i>
&gt;<i>           |Port-1</i>
&gt;<i>           x</i>
&gt;<i> </i>
&gt;<i>  MST Path  | MST Device</i>
&gt;<i>  ----------+----------------------------------</i>
&gt;<i>  sst:0     | MST Hub</i>
&gt;<i>  mst:0-1   | MST Display</i>
&gt;<i>  mst:0-1-1 | MST Display's disconnected DP out</i>
&gt;<i>  mst:0-1-8 | MST Display's internal sink</i>
&gt;<i>  mst:0-2   | SST Display</i>
&gt;<i> </i>
&gt;<i> On certain MST displays, the upstream physical port will ACK DPCD reads.</i>
&gt;<i> However, reads on the local logical port to the internal sink will</i>
&gt;<i> *NAK*. i.e. reading mst:0-1 ACKs, but mst:0-1-8 NAKs.</i>
&gt;<i> </i>
&gt;<i> There may also be duplicates. Some displays will return the same GUID</i>
&gt;<i> when reading DPCD from both mst:0-1 and mst:0-1-8.</i>
&gt;<i> </i>
&gt;<i> There are some device-dependent behavior as well. The MST hub used</i>
&gt;<i> during testing will actually *ACK* read requests on a disconnected</i>
&gt;<i> physical port, whereas the MST displays will NAK.</i>
&gt;<i> </i>
&gt;<i> In light of these discrepancies, it's simpler to expose all downstream</i>
&gt;<i> ports - both physical and logical - and let the user decide what to use.</i>
&gt;<i> </i>
&gt;<i> (v2) changes:</i>
&gt;<i> </i>
&gt;<i> Moved remote aux device (un)registration to new mst connector late</i>
&gt;<i> register and early unregister helpers. Drivers should call these from</i>
&gt;<i> their own mst connector function hooks.</i>
&gt;<i> </i>
&gt;<i> This is to solve an issue during driver unload, where mst connector</i>
&gt;<i> devices are unregistered before the remote aux devices are. In a setup</i>
&gt;<i> where aux devices are created as children of connector devices, the aux</i>
&gt;<i> device would be removed too early, and uncleanly. Doing so in</i>
&gt;<i> early_unregister solves this issue, as that is called before connector</i>
&gt;<i> unregistration.</i>
&gt;<i> </i>
&gt;<i> Signed-off-by: Ville Syrj&#xE4;l&#xE4; &lt;ville.syrjala@xxxxxxxxxxxxxxx&gt;</i>
&gt;<i> Signed-off-by: Leo Li &lt;sunpeng.li@xxxxxxx&gt;</i>
&gt;<i> ---</i>
&gt;<i>  drivers/gpu/drm/drm_dp_aux_dev.c      |  16 ++-</i>
&gt;<i>  drivers/gpu/drm/drm_dp_mst_topology.c | 137 ++++++++++++++++++++++++--</i>
&gt;<i>  include/drm/drm_dp_helper.h           |   4 +</i>
&gt;<i>  include/drm/drm_dp_mst_helper.h       |  11 +++</i>
&gt;<i>  4 files changed, 156 insertions(+), 12 deletions(-)</i>
&gt;<i> </i>
&gt;<i> diff --git a/drivers/gpu/drm/drm_dp_aux_dev.c</i>
&gt;<i> b/drivers/gpu/drm/drm_dp_aux_dev.c</i>
&gt;<i> index 26e38dacf654..4aa5e455e894 100644</i>
&gt;<i> --- a/drivers/gpu/drm/drm_dp_aux_dev.c</i>
&gt;<i> +++ b/drivers/gpu/drm/drm_dp_aux_dev.c</i>
&gt;<i> @@ -37,6 +37,7 @@</i>
&gt;<i>  </i>
&gt;<i>  #include &lt;drm/drm_crtc.h&gt;</i>
&gt;<i>  #include &lt;drm/drm_dp_helper.h&gt;</i>
&gt;<i> +#include &lt;drm/drm_dp_mst_helper.h&gt;</i>
&gt;<i>  #include &lt;drm/drm_print.h&gt;</i>
&gt;<i>  </i>
&gt;<i>  #include &quot;drm_crtc_helper_internal.h&quot;</i>
&gt;<i> @@ -116,6 +117,7 @@ static ssize_t name_show(struct device *dev,</i>
&gt;<i>  </i>
&gt;<i>  	return res;</i>
&gt;<i>  }</i>
&gt;<i> +</i>
&gt;<i>  static DEVICE_ATTR_RO(name);</i>
&gt;<i>  </i>
&gt;<i>  static struct attribute *drm_dp_aux_attrs[] = {</i>
&gt;<i> @@ -162,7 +164,12 @@ static ssize_t auxdev_read_iter(struct kiocb *iocb,</i>
&gt;<i> struct iov_iter *to)</i>
&gt;<i>  			break;</i>
&gt;<i>  		}</i>
&gt;<i>  </i>
&gt;<i> -		res = drm_dp_dpcd_read(aux_dev-&gt;aux, pos, buf, todo);</i>
&gt;<i> +		if (aux_dev-&gt;aux-&gt;is_remote)</i>
&gt;<i> +			res = drm_dp_mst_dpcd_read(aux_dev-&gt;aux, pos, buf,</i>
&gt;<i> +						   todo);</i>
&gt;<i> +		else</i>
&gt;<i> +			res = drm_dp_dpcd_read(aux_dev-&gt;aux, pos, buf, todo);</i>
&gt;<i> +</i>
&gt;<i>  		if (res &lt;= 0)</i>
&gt;<i>  			break;</i>
&gt;<i>  </i>
&gt;<i> @@ -209,7 +216,12 @@ static ssize_t auxdev_write_iter(struct kiocb *iocb,</i>
&gt;<i> struct iov_iter *from)</i>
&gt;<i>  			break;</i>
&gt;<i>  		}</i>
&gt;<i>  </i>
&gt;<i> -		res = drm_dp_dpcd_write(aux_dev-&gt;aux, pos, buf, todo);</i>
&gt;<i> +		if (aux_dev-&gt;aux-&gt;is_remote)</i>
&gt;<i> +			res = drm_dp_mst_dpcd_write(aux_dev-&gt;aux, pos, buf,</i>
&gt;<i> +						    todo);</i>
&gt;<i> +		else</i>
&gt;<i> +			res = drm_dp_dpcd_write(aux_dev-&gt;aux, pos, buf, todo);</i>
&gt;<i> +</i>
&gt;<i>  		if (res &lt;= 0)</i>
&gt;<i>  			break;</i>
&gt;<i>  </i>
&gt;<i> diff --git a/drivers/gpu/drm/drm_dp_mst_topology.c</i>
&gt;<i> b/drivers/gpu/drm/drm_dp_mst_topology.c</i>
&gt;<i> index 0984b9a34d55..dde79c44b625 100644</i>
&gt;<i> --- a/drivers/gpu/drm/drm_dp_mst_topology.c</i>
&gt;<i> +++ b/drivers/gpu/drm/drm_dp_mst_topology.c</i>
&gt;<i> @@ -36,6 +36,8 @@</i>
&gt;<i>  #include &lt;drm/drm_print.h&gt;</i>
&gt;<i>  #include &lt;drm/drm_probe_helper.h&gt;</i>
&gt;<i>  </i>
&gt;<i> +#include &quot;drm_crtc_helper_internal.h&quot;</i>
&gt;<i> +</i>
&gt;<i>  /**</i>
&gt;<i>   * DOC: dp mst helper</i>
&gt;<i>   *</i>
&gt;<i> @@ -53,6 +55,9 @@ static int drm_dp_dpcd_write_payload(struct</i>
&gt;<i> drm_dp_mst_topology_mgr *mgr,</i>
&gt;<i>  				     int id,</i>
&gt;<i>  				     struct drm_dp_payload *payload);</i>
&gt;<i>  </i>
&gt;<i> +static int drm_dp_send_dpcd_read(struct drm_dp_mst_topology_mgr *mgr,</i>
&gt;<i> +				 struct drm_dp_mst_port *port,</i>
&gt;<i> +				 int offset, int size, u8 *bytes);</i>
&gt;<i>  static int drm_dp_send_dpcd_write(struct drm_dp_mst_topology_mgr *mgr,</i>
&gt;<i>  				  struct drm_dp_mst_port *port,</i>
&gt;<i>  				  int offset, int size, u8 *bytes);</i>
&gt;<i> @@ -1238,6 +1243,9 @@ static void drm_dp_destroy_port(struct kref *kref)</i>
&gt;<i>  	struct drm_dp_mst_topology_mgr *mgr = port-&gt;mgr;</i>
&gt;<i>  </i>
&gt;<i>  	if (!port-&gt;input) {</i>
&gt;<i> +</i>

We should get rid of the extra newline right here ^

&gt;<i> +		port-&gt;vcpi.num_slots = 0;</i>
&gt;<i> +</i>
&gt;<i>  		kfree(port-&gt;cached_edid);</i>
&gt;<i>  </i>
&gt;<i>  		/*</i>
&gt;<i> @@ -1483,6 +1491,48 @@ static bool drm_dp_port_setup_pdt(struct</i>
&gt;<i> drm_dp_mst_port *port)</i>
&gt;<i>  	return send_link;</i>
&gt;<i>  }</i>
&gt;<i>  </i>
&gt;<i> +/**</i>
&gt;<i> + * drm_dp_mst_dpcd_read() - read a series of bytes from the DPCD via</i>
&gt;<i> sideband</i>
&gt;<i> + * @aux: Fake sideband AUX CH</i>
&gt;<i> + * @offset: address of the (first) register to read</i>
&gt;<i> + * @buffer: buffer to store the register values</i>
&gt;<i> + * @size: number of bytes in @buffer</i>
&gt;<i> + *</i>
&gt;<i> + * Performs the same functionality for remote devices via</i>
&gt;<i> + * sideband messaging as drm_dp_dpcd_read() does for local</i>
&gt;<i> + * devices via actual AUX CH.</i>
&gt;<i> + */</i>

You forgot to document the return value

&gt;<i> +ssize_t drm_dp_mst_dpcd_read(struct drm_dp_aux *aux,</i>
&gt;<i> +			     unsigned int offset, void *buffer, size_t size)</i>
&gt;<i> +{</i>
&gt;<i> +	struct drm_dp_mst_port *port = container_of(aux, struct</i>
&gt;<i> drm_dp_mst_port,</i>
&gt;<i> +						    aux);</i>
&gt;<i> +</i>
&gt;<i> +	return drm_dp_send_dpcd_read(port-&gt;mgr, port,</i>
&gt;<i> +				     offset, size, buffer);</i>
&gt;<i> +}</i>
&gt;<i> +</i>
&gt;<i> +/**</i>
&gt;<i> + * drm_dp_mst_dpcd_write() - write a series of bytes to the DPCD via</i>
&gt;<i> sideband</i>
&gt;<i> + * @aux: Fake sideband AUX CH</i>
&gt;<i> + * @offset: address of the (first) register to write</i>
&gt;<i> + * @buffer: buffer containing the values to write</i>
&gt;<i> + * @size: number of bytes in @buffer</i>
&gt;<i> + *</i>
&gt;<i> + * Performs the same functionality for remote devices via</i>
&gt;<i> + * sideband messaging as drm_dp_dpcd_write() does for local</i>
&gt;<i> + * devices via actual AUX CH.</i>
&gt;<i> + */</i>

Same for this one&#x2026;

&gt;<i> +ssize_t drm_dp_mst_dpcd_write(struct drm_dp_aux *aux,</i>
&gt;<i> +			      unsigned int offset, void *buffer, size_t size)</i>
&gt;<i> +{</i>
&gt;<i> +	struct drm_dp_mst_port *port = container_of(aux, struct</i>
&gt;<i> drm_dp_mst_port,</i>
&gt;<i> +						    aux);</i>
&gt;<i> +</i>
&gt;<i> +	return drm_dp_send_dpcd_write(port-&gt;mgr, port,</i>
&gt;<i> +				      offset, size, buffer);</i>
&gt;<i> +}</i>
&gt;<i> +</i>
&gt;<i>  static void drm_dp_check_mstb_guid(struct drm_dp_mst_branch *mstb, u8</i>
&gt;<i> *guid)</i>
&gt;<i>  {</i>
&gt;<i>  	int ret;</i>
&gt;<i> @@ -1526,6 +1576,44 @@ static void build_mst_prop_path(const struct</i>
&gt;<i> drm_dp_mst_branch *mstb,</i>
&gt;<i>  	strlcat(proppath, temp, proppath_size);</i>
&gt;<i>  }</i>
&gt;<i>  </i>
&gt;<i> +/**</i>
&gt;<i> + * drm_dp_mst_connector_late_register() - Late MST connector registration</i>
&gt;<i> + * @drm_connector: The MST connector</i>
&gt;<i> + * @port: The MST port for this connector</i>
&gt;<i> + *</i>
&gt;<i> + * Helper to register the remote aux device for this MST port. Drivers</i>
&gt;<i> should</i>
&gt;<i> + * call this from their mst connector's late_register hook to enable MST</i>
&gt;<i> aux</i>
&gt;<i> + * devices.</i>
&gt;<i> + */</i>

&#x2026;and this one&#x2026;

&gt;<i> +int drm_dp_mst_connector_late_register(struct drm_connector *connector,</i>
&gt;<i> +				       struct drm_dp_mst_port *port)</i>
&gt;<i> +{</i>
&gt;<i> +	DRM_DEBUG_KMS(&quot;registering %s remote bus for %s\n&quot;,</i>
&gt;<i> +		      port-&gt;aux.name, connector-&gt;kdev-&gt;kobj.name);</i>
&gt;<i> +</i>
&gt;<i> +	port-&gt;aux.dev = connector-&gt;kdev;</i>
&gt;<i> +	return drm_dp_aux_register_devnode(&amp;port-&gt;aux);</i>
&gt;<i> +}</i>
&gt;<i> +EXPORT_SYMBOL(drm_dp_mst_connector_late_register);</i>
&gt;<i> +</i>
&gt;<i> +/**</i>
&gt;<i> + * drm_dp_mst_connector_early_unregister() - Early MST connector</i>
&gt;<i> unregistration</i>
&gt;<i> + * @drm_connector: The MST connector</i>
&gt;<i> + * @port: The MST port for this connector</i>
&gt;<i> + *</i>
&gt;<i> + * Helper to unregister the remote aux device for this MST port, registered</i>
&gt;<i> by</i>
&gt;<i> + * drm_dp_mst_connector_late_register(). Drivers should call this from</i>
&gt;<i> their mst</i>
&gt;<i> + * connector's early_unregister hook.</i>
&gt;<i> + */</i>

&#x2026;and this one.

&gt;<i> +void drm_dp_mst_connector_early_unregister(struct drm_connector *connector,</i>
&gt;<i> +					   struct drm_dp_mst_port *port)</i>
&gt;<i> +{</i>
&gt;<i> +	DRM_DEBUG_KMS(&quot;unregistering %s remote bus for %s\n&quot;,</i>
&gt;<i> +		      port-&gt;aux.name, connector-&gt;kdev-&gt;kobj.name);</i>
&gt;<i> +	drm_dp_aux_unregister_devnode(&amp;port-&gt;aux);</i>
&gt;<i> +}</i>
&gt;<i> +EXPORT_SYMBOL(drm_dp_mst_connector_early_unregister);</i>
&gt;<i> +</i>
&gt;<i>  static void drm_dp_add_port(struct drm_dp_mst_branch *mstb,</i>
&gt;<i>  			    struct drm_device *dev,</i>
&gt;<i>  			    struct drm_dp_link_addr_reply_port *port_msg)</i>
&gt;<i> @@ -1548,6 +1636,7 @@ static void drm_dp_add_port(struct drm_dp_mst_branch</i>
&gt;<i> *mstb,</i>
&gt;<i>  		port-&gt;mgr = mstb-&gt;mgr;</i>
&gt;<i>  		port-&gt;aux.name = &quot;DPMST&quot;;</i>
&gt;<i>  		port-&gt;aux.dev = dev-&gt;dev;</i>
&gt;<i> +		port-&gt;aux.is_remote = true;</i>
&gt;<i>  </i>
&gt;<i>  		/*</i>
&gt;<i>  		 * Make sure the memory allocation for our parent branch stays</i>
&gt;<i> @@ -1816,7 +1905,6 @@ static bool drm_dp_validate_guid(struct</i>
&gt;<i> drm_dp_mst_topology_mgr *mgr,</i>
&gt;<i>  	return false;</i>
&gt;<i>  }</i>
&gt;<i>  </i>
&gt;<i> -#if 0</i>
&gt;<i>  static int build_dpcd_read(struct drm_dp_sideband_msg_tx *msg, u8 port_num,</i>
&gt;<i> u32 offset, u8 num_bytes)</i>
&gt;<i>  {</i>
&gt;<i>  	struct drm_dp_sideband_msg_req_body req;</i>
&gt;<i> @@ -1829,7 +1917,6 @@ static int build_dpcd_read(struct</i>
&gt;<i> drm_dp_sideband_msg_tx *msg, u8 port_num, u32</i>
&gt;<i>  </i>
&gt;<i>  	return 0;</i>
&gt;<i>  }</i>
&gt;<i> -#endif</i>
&gt;<i>  </i>
&gt;<i>  static int drm_dp_send_sideband_msg(struct drm_dp_mst_topology_mgr *mgr,</i>
&gt;<i>  				    bool up, u8 *msg, int len)</i>
&gt;<i> @@ -2441,26 +2528,56 @@ int drm_dp_update_payload_part2(struct</i>
&gt;<i> drm_dp_mst_topology_mgr *mgr)</i>
&gt;<i>  }</i>
&gt;<i>  EXPORT_SYMBOL(drm_dp_update_payload_part2);</i>
&gt;<i>  </i>
&gt;<i> -#if 0 /* unused as of yet */</i>
&gt;<i>  static int drm_dp_send_dpcd_read(struct drm_dp_mst_topology_mgr *mgr,</i>
&gt;<i>  				 struct drm_dp_mst_port *port,</i>
&gt;<i> -				 int offset, int size)</i>
&gt;<i> +				 int offset, int size, u8 *bytes)</i>
&gt;<i>  {</i>
&gt;<i>  	int len;</i>
&gt;<i> +	int ret = 0;</i>
&gt;<i>  	struct drm_dp_sideband_msg_tx *txmsg;</i>
&gt;<i> +	struct drm_dp_mst_branch *mstb;</i>
&gt;<i> +</i>
&gt;<i> +	mstb = drm_dp_mst_topology_get_mstb_validated(mgr, port-&gt;parent);</i>
&gt;<i> +	if (!mstb)</i>
&gt;<i> +		return -EINVAL;</i>
&gt;<i>  </i>
&gt;<i>  	txmsg = kzalloc(sizeof(*txmsg), GFP_KERNEL);</i>
&gt;<i> -	if (!txmsg)</i>
&gt;<i> -		return -ENOMEM;</i>
&gt;<i> +	if (!txmsg) {</i>
&gt;<i> +		ret = -ENOMEM;</i>
&gt;<i> +		goto fail_put;</i>
&gt;<i> +	}</i>
&gt;<i>  </i>
&gt;<i> -	len = build_dpcd_read(txmsg, port-&gt;port_num, 0, 8);</i>
&gt;<i> +	len = build_dpcd_read(txmsg, port-&gt;port_num, offset, size);</i>
&gt;<i>  	txmsg-&gt;dst = port-&gt;parent;</i>
&gt;<i>  </i>
&gt;<i>  	drm_dp_queue_down_tx(mgr, txmsg);</i>
&gt;<i>  </i>
&gt;<i> -	return 0;</i>
&gt;<i> +	ret = drm_dp_mst_wait_tx_reply(mstb, txmsg);</i>
&gt;<i> +	if (ret &lt; 0)</i>
&gt;<i> +		goto fail_free;</i>
&gt;<i> +</i>
&gt;<i> +	/* DPCD read should never be NACKed */</i>
&gt;<i> +	if (WARN_ON_ONCE(txmsg-&gt;reply.reply_type == 1)) {</i>
&gt;<i> +		ret = -EIO;</i>
&gt;<i> +		goto fail_free;</i>
&gt;<i> +	}</i>
&gt;<i> +</i>
&gt;<i> +	if (txmsg-&gt;reply.u.remote_dpcd_read_ack.num_bytes != size) {</i>
&gt;<i> +		ret = -EPROTO;</i>
&gt;<i> +		goto fail_free;</i>
&gt;<i> +	}</i>
&gt;<i> +</i>
&gt;<i> +	ret = min_t(size_t, txmsg-&gt;reply.u.remote_dpcd_read_ack.num_bytes,</i>
&gt;<i> +		    size);</i>
&gt;<i> +	memcpy(bytes, txmsg-&gt;reply.u.remote_dpcd_read_ack.bytes, ret);</i>
&gt;<i> +</i>
&gt;<i> +fail_free:</i>
&gt;<i> +	kfree(txmsg);</i>
&gt;<i> +fail_put:</i>
&gt;<i> +	drm_dp_mst_topology_put_mstb(mstb);</i>
&gt;<i> +</i>
&gt;<i> +	return ret;</i>
&gt;<i>  }</i>
&gt;<i> -#endif</i>
&gt;<i>  </i>
&gt;<i>  static int drm_dp_send_dpcd_write(struct drm_dp_mst_topology_mgr *mgr,</i>
&gt;<i>  				  struct drm_dp_mst_port *port,</i>
&gt;<i> @@ -2489,7 +2606,7 @@ static int drm_dp_send_dpcd_write(struct</i>
&gt;<i> drm_dp_mst_topology_mgr *mgr,</i>
&gt;<i>  	ret = drm_dp_mst_wait_tx_reply(mstb, txmsg);</i>
&gt;<i>  	if (ret &gt; 0) {</i>
&gt;<i>  		if (txmsg-&gt;reply.reply_type == DP_SIDEBAND_REPLY_NAK)</i>
&gt;<i> -			ret = -EINVAL;</i>
&gt;<i> +			ret = -EIO;</i>
&gt;<i>  		else</i>
&gt;<i>  			ret = 0;</i>
&gt;<i>  	}</i>
&gt;<i> diff --git a/include/drm/drm_dp_helper.h b/include/drm/drm_dp_helper.h</i>
&gt;<i> index 397896b5b21a..cb2deface950 100644</i>
&gt;<i> --- a/include/drm/drm_dp_helper.h</i>
&gt;<i> +++ b/include/drm/drm_dp_helper.h</i>
&gt;<i> @@ -1309,6 +1309,10 @@ struct drm_dp_aux {</i>
&gt;<i>  	 * @cec: struct containing fields used for CEC-Tunneling-over-AUX.</i>
&gt;<i>  	 */</i>
&gt;<i>  	struct drm_dp_aux_cec cec;</i>
&gt;<i> +	/**</i>
&gt;<i> +	 * @is_remote: Is this &quot;AUX CH&quot; actually using sideband messaging.</i>

I'd remove the quotations around AUX CH, but that's up to you. With those
small whitespace and kernel doc changes addressed:

Reviewed-by: Lyude Paul &lt;lyude@xxxxxxxxxx&gt;

Thanks for the great work with this!

&gt;<i> +	 */</i>
&gt;<i> +	bool is_remote;</i>
&gt;<i>  };</i>
&gt;<i>  </i>
&gt;<i>  ssize_t drm_dp_dpcd_read(struct drm_dp_aux *aux, unsigned int offset,</i>
&gt;<i> diff --git a/include/drm/drm_dp_mst_helper.h</i>
&gt;<i> b/include/drm/drm_dp_mst_helper.h</i>
&gt;<i> index 8c97a5f92c47..2ba6253ea6d3 100644</i>
&gt;<i> --- a/include/drm/drm_dp_mst_helper.h</i>
&gt;<i> +++ b/include/drm/drm_dp_mst_helper.h</i>
&gt;<i> @@ -643,6 +643,17 @@ void drm_dp_mst_dump_topology(struct seq_file *m,</i>
&gt;<i>  void drm_dp_mst_topology_mgr_suspend(struct drm_dp_mst_topology_mgr *mgr);</i>
&gt;<i>  int __must_check</i>
&gt;<i>  drm_dp_mst_topology_mgr_resume(struct drm_dp_mst_topology_mgr *mgr);</i>
&gt;<i> +</i>
&gt;<i> +ssize_t drm_dp_mst_dpcd_read(struct drm_dp_aux *aux,</i>
&gt;<i> +			     unsigned int offset, void *buffer, size_t size);</i>
&gt;<i> +ssize_t drm_dp_mst_dpcd_write(struct drm_dp_aux *aux,</i>
&gt;<i> +			      unsigned int offset, void *buffer, size_t size);</i>
&gt;<i> +</i>
&gt;<i> +int drm_dp_mst_connector_late_register(struct drm_connector *connector,</i>
&gt;<i> +				       struct drm_dp_mst_port *port);</i>
&gt;<i> +void drm_dp_mst_connector_early_unregister(struct drm_connector *connector,</i>
&gt;<i> +					   struct drm_dp_mst_port *port);</i>
&gt;<i> +</i>
&gt;<i>  struct drm_dp_mst_topology_state *drm_atomic_get_mst_topology_state(struct</i>
&gt;<i> drm_atomic_state *state,</i>
&gt;<i>  								    struct</i>
&gt;<i> drm_dp_mst_topology_mgr *mgr);</i>
&gt;<i>  int __must_check</i>
-- 
Cheers,
	Lyude Paul

_______________________________________________
amd-gfx mailing list
amd-gfx@xxxxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://lists.freedesktop.org/mailman/listinfo/amd-gfx">https://lists.freedesktop.org/mailman/listinfo/amd-gfx</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="35555" href="msg35555.html">[PATCH 00/10] Enable MST Aux devices (v2)</a></strong>
<ul><li><em>From:</em> sunpeng.li</li></ul></li>
<li><strong><a name="35557" href="msg35557.html">[PATCH 02/10] drm/dp_mst: Enable registration of AUX devices for MST ports (v2)</a></strong>
<ul><li><em>From:</em> sunpeng.li</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg35704.html">Re: [PATCH 1/3] drm/amdgpu: Add flag for allocating memory for sensitive data</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg35706.html">Re: [PATCH 3/5] drm/ttm: Add release_notify callback to ttm_bo_driver</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg35557.html">[PATCH 02/10] drm/dp_mst: Enable registration of AUX devices for MST ports (v2)</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg35708.html">Re: [PATCH 02/10] drm/dp_mst: Enable registration of AUX devices for MST ports (v2)</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#35705"><strong>Date</strong></a></li>
<li><a href="index.html#35705"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

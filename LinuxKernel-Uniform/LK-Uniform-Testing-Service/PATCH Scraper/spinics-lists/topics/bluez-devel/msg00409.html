<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH] Re: No more binary SDP registration in new	4.0 API? -->
<!--X-From-R13: [nahry @nenawb &#60;znahryNnvepnoyr.arg> -->
<!--X-Date: Mon, 7 Jul 2008 20:26:02 &#45;0700 -->
<!--X-Message-Id: 4872DE41.7040007@aircable.net -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: 48728258.6080809@aircable.net -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Bluez Devel: [PATCH] Re: No more binary SDP registration in new	4.0 API?">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[PATCH] Re: No more binary SDP registration in new	4.0 API? &mdash; Bluez Devel</title>
<link rel="alternate" type="application/rss+xml" title="Bluez Devel" href="maillist.rdf">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH] Re: No more binary SDP registration in new	4.0 API?</h1>
[<a href="msg00408.html">Date Prev</a>][<a href="msg00410.html">Date Next</a>][<a href="msg00408.html">Thread Prev</a>][<a href="msg00410.html">Thread Next</a>][<a href="maillist.html#00409">Date Index</a>][<a href="index.html#00409">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH] Re: No more binary SDP registration in new	4.0 API?</li>
<li><em>From</em>: Manuel Naranjo &lt;<a href="mailto:manuel@DOMAIN.HIDDEN">manuel@xxxxxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Tue, 08 Jul 2008 00:25:53 -0300</li>
<li><em>In-reply-to</em>: &lt;<a href="mailto:48728258.6080809@DOMAIN.HIDDEN">48728258.6080809@xxxxxxxxxxxx</a>&gt;</li>
<li><em>References</em>: &lt;<a href="mailto:48728258.6080809@DOMAIN.HIDDEN">48728258.6080809@xxxxxxxxxxxx</a>&gt;</li>
<li><em>Reply-to</em>: BlueZ development &lt;<a href="mailto:bluez-devel@DOMAIN.HIDDEN">bluez-devel@xxxxxxxxxxxxxxxxxxxxx</a>&gt;</li>
<li><em>User-agent</em>: Thunderbird 2.0.0.12 (X11/20080305)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" defer async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><tt>On Dbus api 3.X you could register binary sdp records over dbus, but 
</tt><tt>new api can't I all ready implemented adding records, I need to 
</tt><tt>implement the update records. But I would like to know if it makes 
</tt><tt>sense to commit this patch or not.
</tt></blockquote><tt>Just in case it makes sense, here's the patch that implements 
</tt><tt>AddBinServiceRecord and UpdateBinServiceRecord.
</tt><pre>Index: doc/adapter-api.txt
===================================================================
RCS file: /cvsroot/bluez/utils/doc/adapter-api.txt,v
retrieving revision 1.17
diff -u -r1.17 adapter-api.txt
--- doc/adapter-api.txt	3 Jun 2008 14:29:57 -0000	1.17
+++ doc/adapter-api.txt	8 Jul 2008 03:22:23 -0000
@@ -182,6 +182,25 @@
 			Possible errors: org.bluez.Error.InvalidArguments
 					 org.bluez.Error.NotAvailable
 					 org.bluez.Error.Failed
+		
+		uint32 AddBinServiceRecord(array{byte})
+
+			Adds a new service record from and returns the assigned 
+			record handle.
+
+			Possible errors: org.bluez.Error.InvalidArguments
+					 org.bluez.Error.Failed
+
+		void UpdateBinServiceRecord(uint32 handle, array{byte})
+
+			Updates a given service record.
+
+			Possible errors: org.bluez.Error.InvalidArguments
+					 org.bluez.Error.NotAvailable
+					 org.bluez.Error.Failed
+		
+		
+
 
 		void RemoveServiceRecord(uint32 handle)
 
Index: hcid/adapter.c
===================================================================
RCS file: /cvsroot/bluez/utils/hcid/adapter.c,v
retrieving revision 1.129
diff -u -r1.129 adapter.c
--- hcid/adapter.c	30 Jun 2008 17:26:18 -0000	1.129
+++ hcid/adapter.c	8 Jul 2008 03:22:28 -0000
@@ -4119,6 +4119,8 @@
 	auth-&gt;agent = NULL;
 }
 
+
+
 static DBusMessage *register_agent(DBusConnection *conn,
 					DBusMessage *msg, void *data)
 {
@@ -4180,6 +4182,44 @@
 	return dbus_message_new_method_return(msg);
 }
 
+static DBusMessage *add_bin_service_record(DBusConnection *conn,
+						DBusMessage *msg, void *data)
+{
+	DBusMessageIter iter, array;
+	DBusMessage *reply;
+	struct adapter *adapter = data;
+	const char *sender;
+	const uint8_t *record;
+	int len = -1, err;
+	dbus_uint32_t handle;
+	bdaddr_t src;
+	
+	dbus_message_iter_init(msg, &amp;iter);
+	dbus_message_iter_recurse(&amp;iter, &amp;array);
+	
+	dbus_message_iter_get_fixed_array(&amp;array, &amp;record, &amp;len);
+	if ( len &lt;= 0)
+	    return NULL;
+	
+	sender = dbus_message_get_sender(msg);
+	
+	str2ba(adapter-&gt;address, &amp;src);
+	
+	err = add_bin_record(conn, sender, &amp;src, record, len, &amp;handle);
+	
+	if ( err &lt; 0 )
+	    return failed_strerror(msg, err);
+	
+	reply = dbus_message_new_method_return(msg);
+	if (!reply)
+		return NULL;
+
+	dbus_message_append_args(reply, DBUS_TYPE_UINT32, &amp;handle,
+							DBUS_TYPE_INVALID);
+
+	return reply;	
+}
+
 static DBusMessage *add_service_record(DBusConnection *conn,
 						DBusMessage *msg, void *data)
 {
@@ -4207,7 +4248,20 @@
 	dbus_message_append_args(reply, DBUS_TYPE_UINT32, &amp;handle,
 							DBUS_TYPE_INVALID);
 
-	return reply;
+	return reply;	
+
+
+}
+
+static DBusMessage *update_bin_service_record(DBusConnection *conn,
+						DBusMessage *msg, void *data)
+{
+	struct adapter *adapter = data;
+	bdaddr_t src;
+
+	str2ba(adapter-&gt;address, &amp;src);
+
+        return update_bin_service_record(conn, msg, &amp;src);
 }
 
 static DBusMessage *update_service_record(DBusConnection *conn,
@@ -4276,7 +4330,9 @@
 	{ &quot;RegisterAgent&quot;,	&quot;os&quot;,	&quot;&quot;,	register_agent		},
 	{ &quot;UnregisterAgent&quot;,	&quot;o&quot;,	&quot;&quot;,	unregister_agent	},
 	{ &quot;AddServiceRecord&quot;,	&quot;s&quot;,	&quot;u&quot;,	add_service_record	},
+	{ &quot;AddBinServiceRecord&quot;,&quot;ay&quot;,	&quot;u&quot;,	add_bin_service_record	},
 	{ &quot;UpdateServiceRecord&quot;,&quot;us&quot;,	&quot;&quot;,	update_service_record	},
+	{ &quot;UpdateBinServiceRecord&quot;,&quot;uay&quot;,&quot;&quot;,	update_bin_service_record},
 	{ &quot;RemoveServiceRecord&quot;,&quot;u&quot;,	&quot;&quot;,	remove_service_record	},
 	{ &quot;RequestAuthorization&quot;,&quot;su&quot;,	&quot;&quot;,	request_authorization,
 						G_DBUS_METHOD_FLAG_ASYNC},
Index: hcid/dbus-database.c
===================================================================
RCS file: /cvsroot/bluez/utils/hcid/dbus-database.c,v
retrieving revision 1.57
diff -u -r1.57 dbus-database.c
--- hcid/dbus-database.c	24 Jun 2008 00:24:08 -0000	1.57
+++ hcid/dbus-database.c	8 Jul 2008 03:22:28 -0000
@@ -102,59 +102,75 @@
 	return g_dbus_create_error(msg, ERROR_INTERFACE &quot;.Failed&quot;, &quot;Failed&quot;);
 }
 
-static DBusMessage *add_service_record(DBusConnection *conn,
-						DBusMessage *msg, void *data)
+int add_bin_record(DBusConnection *conn, const char *sender, bdaddr_t *src,
+		    const uint8_t *record, const int len, dbus_uint32_t *handle)
 {
-	DBusMessageIter iter, array;
-	const char *sender;
 	struct record_data *user_record;
 	sdp_record_t *sdp_record;
-	const uint8_t *record;
-	int scanned, len = -1;
-
-	dbus_message_iter_init(msg, &amp;iter);
-	dbus_message_iter_recurse(&amp;iter, &amp;array);
-
-	dbus_message_iter_get_fixed_array(&amp;array, &amp;record, &amp;len);
-	if (len &lt;= 0)
-		return invalid_arguments(msg);
+	int scanned;
 
 	sdp_record = sdp_extract_pdu_safe(record, len, &amp;scanned);
 	if (!sdp_record) {
 		error(&quot;Parsing of service record failed&quot;);
-		return failed(msg);
+		return -EIO;
 	}
 
 	if (scanned != len) {
 		error(&quot;Size mismatch of service record&quot;);
 		sdp_record_free(sdp_record);
-		return failed(msg);
+		return -EIO;
 	}
 
-	if (add_record_to_server(BDADDR_ANY, sdp_record) &lt; 0) {
+	if (add_record_to_server(src, sdp_record) &lt; 0) {
 		error(&quot;Failed to register service record&quot;);
 		sdp_record_free(sdp_record);
-		return failed(msg);
+		return -EIO;
 	}
-
+	
 	user_record = g_new0(struct record_data, 1);
 
 	user_record-&gt;handle = sdp_record-&gt;handle;
 
-	sender = dbus_message_get_sender(msg);
-
 	user_record-&gt;sender = g_strdup(sender);
 
 	records = g_slist_append(records, user_record);
 
 	user_record-&gt;listener_id = g_dbus_add_disconnect_watch(conn, sender,
-								exit_callback,
-								user_record,
-								NULL);
+					exit_callback, user_record, NULL);
 
 	debug(&quot;listener_id %d&quot;, user_record-&gt;listener_id);
 
-	return g_dbus_create_reply(msg, DBUS_TYPE_UINT32, &amp;user_record-&gt;handle,
+	*handle = user_record-&gt;handle;
+	
+	return 0;
+}
+
+
+DBusMessage *add_service_record(DBusConnection *conn,
+						DBusMessage *msg, void *data)
+{
+	DBusMessageIter iter, array;
+	const char *sender;
+	const uint8_t *record;
+	int len = -1, err;
+	dbus_uint32_t handle;
+
+	dbus_message_iter_init(msg, &amp;iter);
+	dbus_message_iter_recurse(&amp;iter, &amp;array);
+
+	dbus_message_iter_get_fixed_array(&amp;array, &amp;record, &amp;len);
+	if (len &lt;= 0)
+	    return invalid_arguments(msg);
+	    
+	sender = dbus_message_get_sender(msg);
+
+	err = add_bin_record(conn, sender, BDADDR_ANY, 
+		    record, len, &amp;handle );
+		
+	if ( err &lt; 0 )
+	    return failed(msg);
+
+	return g_dbus_create_reply(msg, DBUS_TYPE_UINT32, &amp;handle,
 							DBUS_TYPE_INVALID);
 }
 
@@ -240,8 +256,8 @@
 	return dbus_message_new_method_return(msg);
 }
 
-static DBusMessage *update_service_record(DBusConnection *conn,
-						DBusMessage *msg, void *data)
+DBusMessage *update_bin_record(DBusConnection *conn,
+				    DBusMessage *msg, bdaddr_t *src)
 {
 	struct record_data *user_record;
 	DBusMessageIter iter, array;
@@ -275,9 +291,15 @@
 		return invalid_arguments(msg);
 	}
 
-	return update_record(conn, msg, BDADDR_ANY, handle, sdp_record);
+	return update_record(conn, msg, src, handle, sdp_record);
+}
+
+DBusMessage *update_service_record(DBusConnection *conn,
+						DBusMessage *msg, void *data){
+	return update_bin_record(conn, msg, BDADDR_ANY);
 }
 
+
 DBusMessage *update_xml_record(DBusConnection *conn,
 				DBusMessage *msg, bdaddr_t *src)
 {
@@ -362,7 +384,7 @@
 static GDBusMethodTable database_methods[] = {
 	{ &quot;AddServiceRecord&quot;,		&quot;ay&quot;,  &quot;u&quot;,	add_service_record		},
 	{ &quot;AddServiceRecordFromXML&quot;,	&quot;s&quot;,   &quot;u&quot;,	add_service_record_from_xml	},
-	{ &quot;UpdateServiceRecord&quot;,	&quot;uay&quot;, &quot;&quot;,	update_service_record		},
+	{ &quot;UpdateServiceRecord&quot;,	&quot;uay&quot;, &quot;&quot;,	update_service_record  		},
 	{ &quot;UpdateServiceRecordFromXML&quot;,	&quot;us&quot;,  &quot;&quot;,	update_service_record_from_xml	},
 	{ &quot;RemoveServiceRecord&quot;,	&quot;u&quot;,   &quot;&quot;,	remove_service_record		},
 	{ }
Index: hcid/dbus-database.h
===================================================================
RCS file: /cvsroot/bluez/utils/hcid/dbus-database.h,v
retrieving revision 1.12
diff -u -r1.12 dbus-database.h
--- hcid/dbus-database.h	3 Jun 2008 17:47:44 -0000	1.12
+++ hcid/dbus-database.h	8 Jul 2008 03:22:28 -0000
@@ -27,9 +27,13 @@
 dbus_bool_t database_init(DBusConnection *conn, const char *path);
 void database_cleanup(DBusConnection *conn, const char *path);
 
+int add_bin_record(DBusConnection *conn, const char *sender, bdaddr_t *src,
+		const uint8_t *record, const int len, dbus_uint32_t *handle);
 int add_xml_record(DBusConnection *conn, const char *sender, bdaddr_t *src,
 				const char *record, dbus_uint32_t *handle);
 DBusMessage *update_xml_record(DBusConnection *conn,
 				DBusMessage *msg, bdaddr_t *src);
+DBusMessage *update_bin_record(DBusConnection *conn,
+                                DBusMessage *msg, bdaddr_t *src);
 int remove_record(DBusConnection *conn, const char *sender,
 						dbus_uint32_t handle);
</pre><pre>-------------------------------------------------------------------------
Sponsored by: SourceForge.net Community Choice Awards: VOTE NOW!
Studies have shown that voting for your favorite open source project,
along with a healthy diet, reduces your potential for chronic lameness
and boredom. Vote Now at <a  rel="nofollow" href="http://www.sourceforge.net/community/cca08">http://www.sourceforge.net/community/cca08</a></pre><pre>_______________________________________________
Bluez-devel mailing list
Bluez-devel@xxxxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://lists.sourceforge.net/lists/listinfo/bluez-devel">https://lists.sourceforge.net/lists/listinfo/bluez-devel</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00408" href="msg00408.html">No more binary SDP registration in new 4.0 API?</a></strong>
<ul><li><em>From:</em> Manuel Naranjo</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00408.html">No more binary SDP registration in new 4.0 API?</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00410.html">Re:  No more binary SDP registration in new 4.0 API?</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00408.html">No more binary SDP registration in new 4.0 API?</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00410.html">Re:  No more binary SDP registration in new 4.0 API?</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00409"><strong>Date</strong></a></li>
<li><a href="index.html#00409"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-bluetooth/>[Linux&nbsp;Bluetooth&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/netdev/>[Network&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

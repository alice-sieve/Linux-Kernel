<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH] Add HID&#45;>HCI switching support for newer Dell	BT cards -->
<!--X-From-R13: &#60;[nevb_ZvzbapvryybNRryy.pbz> -->
<!--X-Date: Fri, 4 Apr 2008 11:55:42 &#45;0700 -->
<!--X-Message-Id: 1207335282.19116.5.camel@mlimonciello -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Derived: pgp1roZEc14DO.pgp -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Bluez Devel: [PATCH] Add HID-&gt;HCI switching support for newer Dell	BT cards">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[PATCH] Add HID-&gt;HCI switching support for newer Dell	BT cards &mdash; Bluez Devel</title>
<link rel="alternate" type="application/rss+xml" title="Bluez Devel" href="maillist.rdf">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH] Add HID-&gt;HCI switching support for newer Dell	BT cards</h1>
[<a href="msg00074.html">Date Prev</a>][<a href="msg00076.html">Date Next</a>][<a href="msg00069.html">Thread Prev</a>][<a href="msg00076.html">Thread Next</a>][<a href="maillist.html#00075">Date Index</a>][<a href="index.html#00075">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH] Add HID-&gt;HCI switching support for newer Dell	BT cards</li>
<li><em>From</em>: &lt;<a href="mailto:Mario_Limonciello@DOMAIN.HIDDEN">Mario_Limonciello@xxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Fri, 4 Apr 2008 13:54:42 -0500</li>
<li><em>Reply-to</em>: BlueZ development &lt;<a href="mailto:bluez-devel@DOMAIN.HIDDEN">bluez-devel@xxxxxxxxxxxxxxxxxxxxx</a>&gt;</li>
<li><em>Thread-index</em>: AciWhVcAujFnthT/RXCyknt9xjOhUQ==</li>
<li><em>Thread-topic</em>: [PATCH] Add HID-&gt;HCI switching support for newer Dell BT cards</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" defer async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->




Hello,<BR>
<BR>
As I've recently discovered, the more recent (Dell Wireless 370+) BT adapters with the latest firmware don't come up in Bluetooth Radio mode.&nbsp; They come up in a HID/UHE dongle like mode before the OS loads and expect the OS to transition the device to HCI mode.&nbsp; Unfortunately, the transition to HCI mode isn't done in the same fashion as the existing switch_hidproxy function available in hid2hci.&nbsp; I'm attaching a patch to hid2hci that adds a function for the expected behavior on these newer adapters. <BR>
<BR>
The device that needs to have the report sent to it is claimed by usbhid at OS load time, so there are some calls in there to release it from usbhid.<BR>
<BR>
I tested this against a Dell 370 BT adapter.&nbsp; &#65279;This should be the same for the newer adapters (after the 370), but I haven't verified them yet, so there may be an additional patch needed for it.<BR>
<BR>
Thanks,<BR>
 <BR>
<TABLE CELLSPACING="0" CELLPADDING="0" WIDTH="100%">
<TR>
<TD>
<FONT SIZE="2"><FONT COLOR="#808080">---</FONT></FONT><BR>
<FONT SIZE="2"><FONT COLOR="#808080">Mario Limonciello</FONT></FONT><BR>
<B><FONT SIZE="1"><FONT COLOR="#ff0000">Dell</FONT></FONT></B><B> </B><B><FONT SIZE="1"><FONT COLOR="#000000">|</FONT></FONT></B><B><FONT SIZE="1"><FONT COLOR="#808080"> Linux Engineering</FONT></FONT></B><BR>
<FONT SIZE="1"><FONT COLOR="#808080">mario_limonciello@xxxxxxxx</FONT></FONT><BR>
<BR>
<BR>
</TD>
</TR>
</TABLE>


<pre>diff -Nur -x '*.orig' -x '*~' bluez-utils-3.26/tools/hid2hci.c bluez-utils-3.26.new/tools/hid2hci.c
--- bluez-utils-3.26/tools/hid2hci.c	2008-02-01 17:16:34.000000000 -0600
+++ bluez-utils-3.26.new/tools/hid2hci.c	2008-04-04 13:34:13.000000000 -0500
@@ -211,6 +211,42 @@
 	return err;
 }
 
+static int switch_dell(struct device_info *devinfo)
+{
+	char report[] = { 0x7F, 0x13, 0x00, 0x00};
+
+	struct usb_dev_handle *handle;
+	int err;
+
+	//release any locks that the kernel may have on this device
+	handle = usb_open(devinfo-&gt;dev);
+	if (handle)
+	{
+		usb_claim_interface(handle, 0);
+		usb_detach_kernel_driver_np(handle,0);
+	}
+
+	//switch device modes
+	err = usb_control_msg(handle,
+		USB_ENDPOINT_OUT + USB_TYPE_CLASS + USB_RECIP_INTERFACE,
+		0x09,
+		0x7f + (0x03 &lt;&lt; 8),
+		0,
+		(char*)report, 4, 10000);
+
+	if (err == 0) {
+		err = -1;
+		errno = EALREADY;
+	} else {
+		if (errno == ETIMEDOUT)
+			err = 0;
+	}
+
+	usb_close(handle);
+
+	return err;
+}
+
 static struct device_id device_list[] = {
 	{ HCI, 0x0a12, 0x1000, switch_hidproxy },
 	{ HID, 0x0a12, 0x0001, switch_hidproxy },
@@ -229,6 +265,7 @@
 	{ HCI, 0x046d, 0xc70e, switch_logitech },	/* Logitech diNovo keyboard */
 	{ HCI, 0x046d, 0xc713, switch_logitech },	/* Logitech diNovo Edge */
 	{ HCI, 0x046d, 0xc714, switch_logitech },	/* Logitech diNovo Edge */
+	{ HCI, 0x413c, 0x8158, switch_dell },		/* Dell Wireless 370 */
 	{ -1 }
 };
 
</pre><p><strong>Attachment:
<a href="pgp1roZEc14DO.pgp" ><tt>signature.asc</tt></a></strong><br>
<em>Description:</em> This is a digitally signed message part</p>
<pre>-------------------------------------------------------------------------
Check out the new SourceForge.net Marketplace.
It's the best place to buy or sell services for
just about anything Open Source.
<a  rel="nofollow" href="http://ad.doubleclick.net/clk;164216239;13503038;w?http://sf.net/marketplace">http://ad.doubleclick.net/clk;164216239;13503038;w?http://sf.net/marketplace</a></pre><pre>_______________________________________________
Bluez-devel mailing list
Bluez-devel@xxxxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://lists.sourceforge.net/lists/listinfo/bluez-devel">https://lists.sourceforge.net/lists/listinfo/bluez-devel</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00076" href="msg00076.html">Re:  [PATCH] Add HID-&gt;HCI switching support for newer	Dell BT cards</a></strong>
<ul><li><em>From:</em> Mario_Limonciello</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00074.html">Re:  Loading plugin error</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00076.html">Re:  [PATCH] Add HID-&gt;HCI switching support for newer	Dell BT cards</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00069.html">Loading plugin error</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00076.html">Re:  [PATCH] Add HID-&gt;HCI switching support for newer	Dell BT cards</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00075"><strong>Date</strong></a></li>
<li><a href="index.html#00075"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-bluetooth/>[Linux&nbsp;Bluetooth&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/netdev/>[Network&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

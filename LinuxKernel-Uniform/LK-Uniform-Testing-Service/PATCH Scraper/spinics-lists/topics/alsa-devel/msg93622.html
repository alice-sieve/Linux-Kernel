<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH] ALSA: hda: Simplify	snd_hdac_refresh_widgets() -->
<!--X-From-R13: Fnxnfuv Wjnv &#60;gvjnvNfhfr.qr> -->
<!--X-Date: Mon, 8 Jul 2019 09:55:35 &#45;0700 -->
<!--X-Message-Id: s5hd0ikjwky.wl&#45;tiwai@suse.de -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190705100605.19945&#45;1&#45;tiwai@suse.de -->
<!--X-Reference: CAE=gft72HzSUG6Yc0G2wTdGgmUste67ZUDibjBttXZVD7Kds8Q@mail.gmail.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re:  [PATCH] ALSA: hda: Simplify	snd_hdac_refresh_widgets() &mdash; ALSA Devel">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re:  [PATCH] ALSA: hda: Simplify	snd_hdac_refresh_widgets() &mdash; ALSA Devel</title>
<link rel="alternate" type="application/rss+xml" title="ALSA Devel" href="//feedproxy.google.com/AlsaDevel">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [PATCH] ALSA: hda: Simplify	snd_hdac_refresh_widgets()</h1>
[<a href="msg93621.html">Date Prev</a>][<a href="msg93623.html">Date Next</a>][<a href="msg93621.html">Thread Prev</a>][<a href="msg93576.html">Thread Next</a>][<a href="maillist.html#93622">Date Index</a>][<a href="threads.html#93622">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Evan Green &lt;evgreen@xxxxxxxxxxxx&gt;</li>
<li><em>Subject</em>: Re:  [PATCH] ALSA: hda: Simplify	snd_hdac_refresh_widgets()</li>
<li><em>From</em>: Takashi Iwai &lt;tiwai@xxxxxxx&gt;</li>
<li><em>Date</em>: Mon, 08 Jul 2019 18:54:37 +0200</li>
<li><em>Cc</em>: alsa-devel@xxxxxxxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;CAE=gft72HzSUG6Yc0G2wTdGgmUste67ZUDibjBttXZVD7Kds8Q@mail.gmail.com&gt;</li>
<li><em>References</em>: &lt;<a href="msg93570.html">20190705100605.19945-1-tiwai@suse.de</a>&gt; &lt;CAE=gft72HzSUG6Yc0G2wTdGgmUste67ZUDibjBttXZVD7Kds8Q@mail.gmail.com&gt;</li>
<li><em>User-agent</em>: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka) FLIM/1.14.9 (Goj&#x14D;) APEL/10.8 Emacs/25.3 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Mon, 08 Jul 2019 18:49:01 +0200,
Evan Green wrote:
&gt; 
&gt; On Fri, Jul 5, 2019 at 3:06 AM Takashi Iwai &lt;tiwai@xxxxxxx&gt; wrote:
&gt; &gt;
&gt; &gt; Along with the recent fix for the races of snd_hdac_refresh_widgets()
&gt; &gt; it turned out that the instantiation of widgets sysfs at
&gt; &gt; snd_hdac_sysfs_reinit() could cause a race.  The race itself was
&gt; &gt; already covered later by extending the mutex protection range, the
&gt; &gt; commit 98482377dc72 (&quot;ALSA: hda: Fix widget_mutex incomplete
&gt; &gt; protection&quot;), but this also indicated that the call of *_reinit() is
&gt; &gt; basically superfluous, as the widgets shall be created sooner or later
&gt; &gt; from snd_hdac_device_register().
&gt; &gt;
&gt; &gt; This patch removes the redundant call of snd_hdac_sysfs_reinit() at
&gt; &gt; first.  By this removal, the sysfs argument itself in
&gt; &gt; snd_hdac_refresh_widgets() becomes superfluous, too, because the only
&gt; &gt; case sysfs=false is always with codec-&gt;widgets=NULL.  So, we drop this
&gt; &gt; redundant argument as well.
&gt; &gt;
&gt; &gt; Signed-off-by: Takashi Iwai &lt;tiwai@xxxxxxx&gt;
&gt; &gt; ---
&gt; &gt;  include/sound/hdaudio.h      |  2 +-
&gt; &gt;  sound/hda/hdac_device.c      | 13 +++++--------
&gt; &gt;  sound/hda/hdac_sysfs.c       |  2 +-
&gt; &gt;  sound/pci/hda/hda_codec.c    |  2 +-
&gt; &gt;  sound/soc/codecs/hdac_hdmi.c |  2 +-
&gt; &gt;  5 files changed, 9 insertions(+), 12 deletions(-)
&gt; &gt;
&gt; &gt; diff --git a/include/sound/hdaudio.h b/include/sound/hdaudio.h
&gt; &gt; index e8346784cf3f..f475293d0668 100644
&gt; &gt; --- a/include/sound/hdaudio.h
&gt; &gt; +++ b/include/sound/hdaudio.h
&gt; &gt; @@ -120,7 +120,7 @@ void snd_hdac_device_unregister(struct hdac_device *codec);
&gt; &gt;  int snd_hdac_device_set_chip_name(struct hdac_device *codec, const char *name);
&gt; &gt;  int snd_hdac_codec_modalias(struct hdac_device *hdac, char *buf, size_t size);
&gt; &gt;
&gt; &gt; -int snd_hdac_refresh_widgets(struct hdac_device *codec, bool sysfs);
&gt; &gt; +int snd_hdac_refresh_widgets(struct hdac_device *codec);
&gt; &gt;
&gt; &gt;  unsigned int snd_hdac_make_cmd(struct hdac_device *codec, hda_nid_t nid,
&gt; &gt;                                unsigned int verb, unsigned int parm);
&gt; &gt; diff --git a/sound/hda/hdac_device.c b/sound/hda/hdac_device.c
&gt; &gt; index 11050bfd8068..a265c1d68876 100644
&gt; &gt; --- a/sound/hda/hdac_device.c
&gt; &gt; +++ b/sound/hda/hdac_device.c
&gt; &gt; @@ -89,7 +89,7 @@ int snd_hdac_device_init(struct hdac_device *codec, struct hdac_bus *bus,
&gt; &gt;
&gt; &gt;         fg = codec-&gt;afg ? codec-&gt;afg : codec-&gt;mfg;
&gt; &gt;
&gt; &gt; -       err = snd_hdac_refresh_widgets(codec, false);
&gt; &gt; +       err = snd_hdac_refresh_widgets(codec);
&gt; &gt;         if (err &lt; 0)
&gt; &gt;                 goto error;
&gt; &gt;
&gt; &gt; @@ -394,9 +394,8 @@ static void setup_fg_nodes(struct hdac_device *codec)
&gt; &gt;  /**
&gt; &gt;   * snd_hdac_refresh_widgets - Reset the widget start/end nodes
&gt; &gt;   * @codec: the codec object
&gt; &gt; - * @sysfs: re-initialize sysfs tree, too
&gt; &gt;   */
&gt; &gt; -int snd_hdac_refresh_widgets(struct hdac_device *codec, bool sysfs)
&gt; &gt; +int snd_hdac_refresh_widgets(struct hdac_device *codec)
&gt; &gt;  {
&gt; &gt;         hda_nid_t start_nid;
&gt; &gt;         int nums, err = 0;
&gt; &gt; @@ -414,11 +413,9 @@ int snd_hdac_refresh_widgets(struct hdac_device *codec, bool sysfs)
&gt; &gt;                 goto unlock;
&gt; &gt;         }
&gt; &gt;
&gt; &gt; -       if (sysfs) {
&gt; &gt; -               err = hda_widget_sysfs_reinit(codec, start_nid, nums);
&gt; &gt; -               if (err &lt; 0)
&gt; &gt; -                       goto unlock;
&gt; &gt; -       }
&gt; &gt; +       err = hda_widget_sysfs_reinit(codec, start_nid, nums);
&gt; &gt; +       if (err &lt; 0)
&gt; &gt; +               goto unlock;
&gt; &gt;
&gt; &gt;         codec-&gt;num_nodes = nums;
&gt; &gt;         codec-&gt;start_nid = start_nid;
&gt; &gt; diff --git a/sound/hda/hdac_sysfs.c b/sound/hda/hdac_sysfs.c
&gt; &gt; index 909d5ef1179c..e56e83325903 100644
&gt; &gt; --- a/sound/hda/hdac_sysfs.c
&gt; &gt; +++ b/sound/hda/hdac_sysfs.c
&gt; &gt; @@ -428,7 +428,7 @@ int hda_widget_sysfs_reinit(struct hdac_device *codec,
&gt; &gt;         int i;
&gt; &gt;
&gt; &gt;         if (!codec-&gt;widgets)
&gt; &gt; -               return hda_widget_sysfs_init(codec);
&gt; &gt; +               return 0;
&gt; 
&gt; Hi Takashi,
&gt; So this no-ops out reinit() if there are no widgets. Are there any
&gt; cases in which hda_widget_sysfs_exit() could be called, followed by
&gt; hda_widget_sysfs_reinit()? That would be problematic, as exit would
&gt; wipe out the widgets, but now reinit would never restore them.

Such a pattern must be a bug.

&gt; Are there any plausible cases where a caller might call
&gt; refresh_widgets() and then attempt to utilize or otherwise depend on
&gt; the widgets being present? The semantics of this function seem odd to
&gt; me now, as it will now return having updated num_nodes, start_nid, and
&gt; end_nid, but without having actually built the widgets array.
&gt; 
&gt; I'm probably biased, but I still think it makes more sense to let
&gt; sysfs_reinit actually reinitialize the widgets, but just pass down
&gt; start_nid and count so that the tree is built correctly.

The semantic is that refresh is a refresh -- not creating a stuff.

Actually this helper function is exposed solely for the case where the
widget tree is updated at the codec driver probe time (typically Intel
HDMI codec).  If it's used for anything else, especially implicitly
relying on its creation behavior, it's a bug to be fixed.


thanks,

Takashi
_______________________________________________
Alsa-devel mailing list
Alsa-devel@xxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://mailman.alsa-project.org/mailman/listinfo/alsa-devel">https://mailman.alsa-project.org/mailman/listinfo/alsa-devel</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="93570" href="msg93570.html">[PATCH] ALSA: hda: Simplify snd_hdac_refresh_widgets()</a></strong>
<ul><li><em>From:</em> Takashi Iwai</li></ul></li>
<li><strong><a name="93621" href="msg93621.html">Re:  [PATCH] ALSA: hda: Simplify	snd_hdac_refresh_widgets()</a></strong>
<ul><li><em>From:</em> Evan Green</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg93621.html">Re:  [PATCH] ALSA: hda: Simplify	snd_hdac_refresh_widgets()</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg93623.html">Re:  [PATCH V2 2/2] ASoC: fsl_esai: recover the channel swap after xrun</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg93621.html">Re:  [PATCH] ALSA: hda: Simplify	snd_hdac_refresh_widgets()</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg93576.html">[PATCH 2/3 v2] pcm_file: improve error checking in	write_wav_header function</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#93622"><strong>Date</strong></a></li>
<li><a href="threads.html#93622"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/alsa-user/>[ALSA&nbsp;User]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/pulse-audio/>[Pulse&nbsp;Audio]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Kernel&nbsp;Archive]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=http://yosemitephotos.net/>[Photo&nbsp;Sharing]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/linux-sound/>[Linux&nbsp;Sound]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-media/>[Video&nbsp;4&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/gimp/>[Gimp]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

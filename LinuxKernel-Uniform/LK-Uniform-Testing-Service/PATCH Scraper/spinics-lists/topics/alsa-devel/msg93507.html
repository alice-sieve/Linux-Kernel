<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH v2 1/2] ASoC: tas5720.c: cleanup variant	management -->
<!--X-From-R13: @vxbynhf Hbff &#60;aiNibfa.qr> -->
<!--X-Date: Wed, 3 Jul 2019 22:37:50 &#45;0700 -->
<!--X-Message-Id: alpine.DEB.2.20.1907040731270.27853@fox.voss.local -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190628143037.GH5379@sirena.org.uk -->
<!--X-Reference: cover.1561988282.git.nikolaus.voss@loewensteinmedical.de -->
<!--X-Reference: c79df50175d59265a37c5e7c8a0cfbf8119bcf78.1561988282.git.nikolaus.voss@loewensteinmedical.de -->
<!--X-Reference: 80af3fca&#45;f71b&#45;c118&#45;e5d8&#45;fde8b7d21705@ti.com -->
<!--X-Reference: alpine.DEB.2.20.1907011633310.4353@fox.voss.local -->
<!--X-Reference: 074d4df3&#45;51d8&#45;6e20&#45;869d&#45;5f88b46cc172@ti.com -->
<!--X-Reference: alpine.DEB.2.20.1907020855240.10248@fox.voss.local -->
<!--X-Reference: 4897e119&#45;28fa&#45;aa2c&#45;aa06&#45;2534af6b4c62@ti.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re:  [PATCH v2 1/2] ASoC: tas5720.c: cleanup variant	management &mdash; ALSA Devel">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re:  [PATCH v2 1/2] ASoC: tas5720.c: cleanup variant	management &mdash; ALSA Devel</title>
<link rel="alternate" type="application/rss+xml" title="ALSA Devel" href="//feedproxy.google.com/AlsaDevel">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [PATCH v2 1/2] ASoC: tas5720.c: cleanup variant	management</h1>
[<a href="msg93506.html">Date Prev</a>][<a href="msg93508.html">Date Next</a>][<a href="msg93504.html">Thread Prev</a>][<a href="msg93459.html">Thread Next</a>][<a href="maillist.html#93507">Date Index</a>][<a href="threads.html#93507">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: &quot;Andrew F. Davis&quot; &lt;afd@xxxxxx&gt;</li>
<li><em>Subject</em>: Re:  [PATCH v2 1/2] ASoC: tas5720.c: cleanup variant	management</li>
<li><em>From</em>: Nikolaus Voss &lt;nv@xxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 4 Jul 2019 07:36:48 +0200 (CEST)</li>
<li><em>Cc</em>: Kate Stewart &lt;kstewart@xxxxxxxxxxxxxxxxxxx&gt;, alsa-devel@xxxxxxxxxxxxxxxx,        linux-kernel@xxxxxxxxxxxxxxx, Takashi Iwai &lt;tiwai@xxxxxxxx&gt;,        Liam Girdwood &lt;lgirdwood@xxxxxxxxx&gt;, linux-acpi@xxxxxxxxxxxxxxx,        Mark Brown &lt;broonie@xxxxxxxxxx&gt;,        Andreas Dannenberg &lt;dannenberg@xxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg93504.html">4897e119-28fa-aa2c-aa06-2534af6b4c62@ti.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg93322.html">20190628143037.GH5379@sirena.org.uk</a>&gt; &lt;<a href="msg93457.html">cover.1561988282.git.nikolaus.voss@loewensteinmedical.de</a>&gt; &lt;<a href="msg93458.html">c79df50175d59265a37c5e7c8a0cfbf8119bcf78.1561988282.git.nikolaus.voss@loewensteinmedical.de</a>&gt; &lt;<a href="msg93404.html">80af3fca-f71b-c118-e5d8-fde8b7d21705@ti.com</a>&gt; &lt;alpine.DEB.2.20.1907011633310.4353@fox.voss.local&gt; &lt;<a href="msg93410.html">074d4df3-51d8-6e20-869d-5f88b46cc172@ti.com</a>&gt; &lt;alpine.DEB.2.20.1907020855240.10248@fox.voss.local&gt; &lt;<a href="msg93504.html">4897e119-28fa-aa2c-aa06-2534af6b4c62@ti.com</a>&gt;</li>
<li><em>User-agent</em>: Alpine 2.20 (DEB 67 2015-01-07)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
On Wed, 3 Jul 2019, Andrew F. Davis wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On 7/2/19 6:12 AM, Nikolaus Voss wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On Mon, 1 Jul 2019, Andrew F. Davis wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On 7/1/19 11:35 AM, Nikolaus Voss wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On Mon, 1 Jul 2019, Andrew F. Davis wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On 7/1/19 9:42 AM, Nikolaus Voss wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Replace enum tas572x_type with struct tas5720_variant which aggregates
variant specific stuff and can be directly referenced from an id
table.

Signed-off-by: Nikolaus Voss &lt;nikolaus.voss@xxxxxxxxxxxxxxxxxxxxx&gt;
---
&#xA0;sound/soc/codecs/tas5720.c | 98
+++++++++++++-------------------------
&#xA0;1 file changed, 33 insertions(+), 65 deletions(-)

diff --git a/sound/soc/codecs/tas5720.c b/sound/soc/codecs/tas5720.c
index 37fab8f22800..b2e897f094b4 100644
--- a/sound/soc/codecs/tas5720.c
+++ b/sound/soc/codecs/tas5720.c
@@ -28,9 +28,10 @@
&#xA0;/* Define how often to check (and clear) the fault status register
(in ms) */
&#xA0;#define TAS5720_FAULT_CHECK_INTERVAL&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; 200

-enum tas572x_type {
-&#xA0;&#xA0;&#xA0; TAS5720,
-&#xA0;&#xA0;&#xA0; TAS5722,
+struct tas5720_variant {
+&#xA0;&#xA0;&#xA0; const int device_id;
+&#xA0;&#xA0;&#xA0; const struct regmap_config *reg_config;
+&#xA0;&#xA0;&#xA0; const struct snd_soc_component_driver *comp_drv;
&#xA0;};

&#xA0;static const char * const tas5720_supply_names[] = {
@@ -44,7 +45,7 @@ struct tas5720_data {
&#xA0;&#xA0;&#xA0;&#xA0; struct snd_soc_component *component;
&#xA0;&#xA0;&#xA0;&#xA0; struct regmap *regmap;
&#xA0;&#xA0;&#xA0;&#xA0; struct i2c_client *tas5720_client;
-&#xA0;&#xA0;&#xA0; enum tas572x_type devtype;
+&#xA0;&#xA0;&#xA0; const struct tas5720_variant *variant;
</pre></blockquote><pre style="margin: 0em;">

Why add a new struct? Actually I don't see the need for this patch at
all, the commit message only explains the 'what' not the 'why'. We can
and do already build this info from the tas572x_type.
</pre></blockquote><pre style="margin: 0em;">

As the commit message says, the purpose is to aggregate the variant
specifics and make it accessible via one pointer. This is a standard
approach for of/acpi_device_id tables and thus makes the code simpler
and improves readability. This is a maintenance patch to prepare using
the device match API in a proper way.

</pre></blockquote><pre style="margin: 0em;">


&quot;make it accessible via one pointer&quot; is again a &quot;what&quot;, the &quot;why&quot; is:

&quot;This is a standard approach&quot;
&quot;makes the code simpler and improves readability&quot;

Those are valid reasons and should be what you put in the commit message.
</pre></blockquote><pre style="margin: 0em;">

ok

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">


</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

Also below are several functional changes, the cover letter says
this is
not a functional change, yet the driver behaves differently now.
</pre></blockquote><pre style="margin: 0em;">

Can you be a little bit more specific? The code should behave exactly as
before.

</pre></blockquote><pre style="margin: 0em;">


Sure, for instance the line &quot;unexpected private driver data&quot; is removed,
this can now never happen, that is a functional change. The phrase &quot;no
functional change&quot;, should be reserved for only changes to spelling,
formatting, code organizing, etc..
</pre></blockquote><pre style="margin: 0em;">

&quot;unexpected private driver data&quot; was unreachable code before, but you're
right, debug output has changed a little, but the functional part is
exactly the same.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">


</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Niko

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

Andrew

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
&#xA0;&#xA0;&#xA0;&#xA0; struct regulator_bulk_data supplies[TAS5720_NUM_SUPPLIES];
&#xA0;&#xA0;&#xA0;&#xA0; struct delayed_work fault_check_work;
&#xA0;&#xA0;&#xA0;&#xA0; unsigned int last_fault;
@@ -179,17 +180,13 @@ static int tas5720_set_dai_tdm_slot(struct
snd_soc_dai *dai,
&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; goto error_snd_soc_component_update_bits;

&#xA0;&#xA0;&#xA0;&#xA0; /* Configure TDM slot width. This is only applicable to
TAS5722. */
-&#xA0;&#xA0;&#xA0; switch (tas5720-&gt;devtype) {
-&#xA0;&#xA0;&#xA0; case TAS5722:
+&#xA0;&#xA0;&#xA0; if (tas5720-&gt;variant-&gt;device_id == TAS5722_DEVICE_ID) {
</pre></blockquote></blockquote></blockquote><pre style="margin: 0em;">


I also don't like this, TAS5722_DEVICE_ID is the expected contents of a
register, you are using it like the enum tas572x_type that you removed.
I'd leave that enum, the device ID register itself is not guaranteed to
be correct or unique, which is why we warn about mismatches below but
then continue to use the user provided device type anyway.
</pre></blockquote><pre style="margin: 0em;">

Strange, with me it's the other way round, I don't like the enum. The
mismatch behavior hasn't changed a bit, the same warning is printed. If
the device ID is no longer unique in the future (apparently it is for
now) the driver should explicitly handle this instead of printing a
warning, because warnings should be reserved for an indication of any
kind of misconfiguration and not of expected behavior.

That said the variant struct can of course replace the enum in every
aspect, even for what you describe above. The enum was an ordinal
representation of the user-selected i2c_device_id, the variant struct* is
a pointer representation of the user-selected i2c/of/acpi_device_id. The
only difference is that it directly points to the variant specific parts
of the driver instead of resolving those via multiple switch/case
statements.
</pre></blockquote><pre style="margin: 0em;">

The enum identifies the device type, easy as that, if you want to
instead do all the logic switching on some internal ID register value
code then make a patch for just that and explain what is gained. Don't
do that into this one.
</pre></blockquote><pre style="margin: 0em;">

</pre><tt>I don't do and I don't want to. The struct pointer identifies the device 
</tt><tt>type the same way as the enum does. I guess we better leave things as they 
</tt><tt>are. Anyway, thanks for your time and effort.
</tt><pre style="margin: 0em;">

Nikolaus
_______________________________________________
Alsa-devel mailing list
Alsa-devel@xxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://mailman.alsa-project.org/mailman/listinfo/alsa-devel">https://mailman.alsa-project.org/mailman/listinfo/alsa-devel</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="93322" href="msg93322.html">Re:  [PATCH] sound/soc/codecs/tas5720.c: add ACPI	support</a></strong>
<ul><li><em>From:</em> Mark Brown</li></ul></li>
<li><strong><a name="93457" href="msg93457.html">[PATCH v2 0/2] ASoC: tas5720.c: add ACPI enumeration	support</a></strong>
<ul><li><em>From:</em> Nikolaus Voss</li></ul></li>
<li><strong><a name="93458" href="msg93458.html">[PATCH v2 1/2] ASoC: tas5720.c: cleanup variant	management</a></strong>
<ul><li><em>From:</em> Nikolaus Voss</li></ul></li>
<li><strong><a name="93404" href="msg93404.html">Re:  [PATCH v2 1/2] ASoC: tas5720.c: cleanup variant	management</a></strong>
<ul><li><em>From:</em> Andrew F. Davis</li></ul></li>
<li><strong><a name="93460" href="msg93460.html">Re:  [PATCH v2 1/2] ASoC: tas5720.c: cleanup variant	management</a></strong>
<ul><li><em>From:</em> Nikolaus Voss</li></ul></li>
<li><strong><a name="93410" href="msg93410.html">Re:  [PATCH v2 1/2] ASoC: tas5720.c: cleanup variant	management</a></strong>
<ul><li><em>From:</em> Andrew F. Davis</li></ul></li>
<li><strong><a name="93461" href="msg93461.html">Re:  [PATCH v2 1/2] ASoC: tas5720.c: cleanup variant	management</a></strong>
<ul><li><em>From:</em> Nikolaus Voss</li></ul></li>
<li><strong><a name="93504" href="msg93504.html">Re:  [PATCH v2 1/2] ASoC: tas5720.c: cleanup variant	management</a></strong>
<ul><li><em>From:</em> Andrew F. Davis</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg93506.html">Re:  [PATCH V2 2/2] ASoC: fsl_esai: recover the channel swap after xrun</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg93508.html">[PATCH] ASoC: audio-graph-card: fix use-after-free in	graph_for_each_link</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg93504.html">Re:  [PATCH v2 1/2] ASoC: tas5720.c: cleanup variant	management</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg93459.html">[PATCH v2 2/2] ASoC: tas5720.c: add ACPI enumeration	support</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#93507"><strong>Date</strong></a></li>
<li><a href="threads.html#93507"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/alsa-user/>[ALSA&nbsp;User]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/pulse-audio/>[Pulse&nbsp;Audio]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Kernel&nbsp;Archive]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=http://yosemitephotos.net/>[Photo&nbsp;Sharing]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/linux-sound/>[Linux&nbsp;Sound]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-media/>[Video&nbsp;4&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/gimp/>[Gimp]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

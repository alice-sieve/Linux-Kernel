<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH 30/30] sound/soc: Use kmemdup rather than duplicating its implementation -->
<!--X-From-R13: Dvpuneq Tvgmtrenyq &#60;esNbcrafbhepr.pveehf.pbz> -->
<!--X-Date: Wed, 3 Jul 2019 06:56:06 &#45;0700 -->
<!--X-Message-Id: 547c68b0&#45;f55f&#45;ca1d&#45;c5b3&#45;f6a5f89d93a9@opensource.cirrus.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190703131842.26082&#45;1&#45;huangfq.daxian@gmail.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re:  [PATCH 30/30] sound/soc: Use kmemdup rather than duplicating its implementation &mdash; ALSA Devel">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re:  [PATCH 30/30] sound/soc: Use kmemdup rather than duplicating its implementation &mdash; ALSA Devel</title>
<link rel="alternate" type="application/rss+xml" title="ALSA Devel" href="//feedproxy.google.com/AlsaDevel">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [PATCH 30/30] sound/soc: Use kmemdup rather than duplicating its implementation</h1>
[<a href="msg93494.html">Date Prev</a>][<a href="msg93496.html">Date Next</a>][<a href="msg93494.html">Thread Prev</a>][<a href="msg93496.html">Thread Next</a>][<a href="maillist.html#93495">Date Index</a>][<a href="threads.html#93495">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Fuqian Huang &lt;huangfq.daxian@xxxxxxxxx&gt;</li>
<li><em>Subject</em>: Re:  [PATCH 30/30] sound/soc: Use kmemdup rather than duplicating its implementation</li>
<li><em>From</em>: Richard Fitzgerald &lt;rf@xxxxxxxxxxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Wed, 3 Jul 2019 14:55:03 +0100</li>
<li><em>Cc</em>: alsa-devel@xxxxxxxxxxxxxxxx, Liam Girdwood &lt;lgirdwood@xxxxxxxxx&gt;,        patches@xxxxxxxxxxxxxxxxxxxxx, Jie Yang &lt;yang.jie@xxxxxxxxxxxxxxx&gt;,        Pierre-Louis Bossart &lt;pierre-louis.bossart@xxxxxxxxxxxxxxx&gt;,        Takashi Iwai &lt;tiwai@xxxxxxxx&gt;, Mark Brown &lt;broonie@xxxxxxxxxx&gt;,        linux-kernel@xxxxxxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg93494.html">20190703131842.26082-1-huangfq.daxian@gmail.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg93494.html">20190703131842.26082-1-huangfq.daxian@gmail.com</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Thunderbird/52.8.0</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
On 03/07/19 14:18, Fuqian Huang wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
kmemdup is introduced to duplicate a region of memory in a neat way.
Rather than kmalloc/kzalloc + memset, which the programmer needs to
write the size twice (sometimes lead to mistakes), kmemdup improves
readability, leads to smaller code and also reduce the chances of mistakes.
Suggestion to use kmemdup rather than using kmalloc/kzalloc + memset.

Signed-off-by: Fuqian Huang &lt;huangfq.daxian@xxxxxxxxx&gt;
---
  sound/soc/codecs/wm0010.c             | 4 +---
  sound/soc/intel/atom/sst/sst_loader.c | 3 +--
</pre></blockquote><pre style="margin: 0em;">

Should be one patch per file as the drivers are not related to each
other at all, and if one needed a revert you couldn't revert this
patch because it would revert both drivers.

But apart from that, for wm0010.c:
Acked-by: Richard Fitzgerald &lt;rf@xxxxxxxxxxxxxxxxxxxxx&gt;

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
  2 files changed, 2 insertions(+), 5 deletions(-)

diff --git a/sound/soc/codecs/wm0010.c b/sound/soc/codecs/wm0010.c
index 727d6703c905..807826f30f58 100644
--- a/sound/soc/codecs/wm0010.c
+++ b/sound/soc/codecs/wm0010.c
@@ -515,7 +515,7 @@ static int wm0010_stage2_load(struct snd_soc_component *component)
  	dev_dbg(component-&gt;dev, &quot;Downloading %zu byte stage 2 loader\n&quot;, fw-&gt;size);
</pre><tt>  
</tt><tt>  	/* Copy to local buffer first as vmalloc causes problems for dma */
</tt><pre style="margin: 0em;">
-	img = kzalloc(fw-&gt;size, GFP_KERNEL | GFP_DMA);
+	img = kmemdup(&amp;fw-&gt;data[0], fw-&gt;size, GFP_KERNEL | GFP_DMA);
  	if (!img) {
  		ret = -ENOMEM;
  		goto abort2;
@@ -527,8 +527,6 @@ static int wm0010_stage2_load(struct snd_soc_component *component)
  		goto abort1;
  	}
</pre><tt>  
</tt><tt>-	memcpy(img, &amp;fw-&gt;data[0], fw-&gt;size);
</tt><pre style="margin: 0em;">
-
  	spi_message_init(&amp;m);
  	memset(&amp;t, 0, sizeof(t));
  	t.rx_buf = out;
diff --git a/sound/soc/intel/atom/sst/sst_loader.c b/sound/soc/intel/atom/sst/sst_loader.c
index ce11c36848c4..cc95af35c060 100644
--- a/sound/soc/intel/atom/sst/sst_loader.c
+++ b/sound/soc/intel/atom/sst/sst_loader.c
@@ -288,14 +288,13 @@ static int sst_cache_and_parse_fw(struct intel_sst_drv *sst,
  {
  	int retval = 0;
</pre><tt>  
</tt><tt>-	sst-&gt;fw_in_mem = kzalloc(fw-&gt;size, GFP_KERNEL);
</tt><pre style="margin: 0em;">
+	sst-&gt;fw_in_mem = kmemdup(fw-&gt;data, fw-&gt;size, GFP_KERNEL);
  	if (!sst-&gt;fw_in_mem) {
  		retval = -ENOMEM;
  		goto end_release;
  	}
  	dev_dbg(sst-&gt;dev, &quot;copied fw to %p&quot;, sst-&gt;fw_in_mem);
  	dev_dbg(sst-&gt;dev, &quot;phys: %lx&quot;, (unsigned long)virt_to_phys(sst-&gt;fw_in_mem));
-	memcpy(sst-&gt;fw_in_mem, fw-&gt;data, fw-&gt;size);
  	retval = sst_parse_fw_memcpy(sst, fw-&gt;size, &amp;sst-&gt;memcpy_list);
  	if (retval) {
  		dev_err(sst-&gt;dev, &quot;Failed to parse fw\n&quot;);

</pre></blockquote><pre style="margin: 0em;">

_______________________________________________
Alsa-devel mailing list
Alsa-devel@xxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://mailman.alsa-project.org/mailman/listinfo/alsa-devel">https://mailman.alsa-project.org/mailman/listinfo/alsa-devel</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="93496" href="msg93496.html">Re:  [PATCH 30/30] sound/soc: Use kmemdup rather than	duplicating its implementation</a></strong>
<ul><li><em>From:</em> Fuqian Huang</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="93494" href="msg93494.html">[PATCH 30/30] sound/soc: Use kmemdup rather than	duplicating its implementation</a></strong>
<ul><li><em>From:</em> Fuqian Huang</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg93494.html">[PATCH 30/30] sound/soc: Use kmemdup rather than	duplicating its implementation</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg93496.html">Re:  [PATCH 30/30] sound/soc: Use kmemdup rather than	duplicating its implementation</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg93494.html">[PATCH 30/30] sound/soc: Use kmemdup rather than	duplicating its implementation</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg93496.html">Re:  [PATCH 30/30] sound/soc: Use kmemdup rather than	duplicating its implementation</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#93495"><strong>Date</strong></a></li>
<li><a href="threads.html#93495"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/alsa-user/>[ALSA&nbsp;User]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/pulse-audio/>[Pulse&nbsp;Audio]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Kernel&nbsp;Archive]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=http://yosemitephotos.net/>[Photo&nbsp;Sharing]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/linux-sound/>[Linux&nbsp;Sound]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-media/>[Video&nbsp;4&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/gimp/>[Gimp]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

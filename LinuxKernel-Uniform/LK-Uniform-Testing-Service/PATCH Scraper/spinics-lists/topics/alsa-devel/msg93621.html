<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH] ALSA: hda: Simplify	snd_hdac_refresh_widgets() -->
<!--X-From-R13: Sina Uerra &#60;riterraNpuebzvhz.bet> -->
<!--X-Date: Mon, 8 Jul 2019 09:50:49 &#45;0700 -->
<!--X-Message-Id: CAE=gft72HzSUG6Yc0G2wTdGgmUste67ZUDibjBttXZVD7Kds8Q@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190705100605.19945&#45;1&#45;tiwai@suse.de -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re:  [PATCH] ALSA: hda: Simplify	snd_hdac_refresh_widgets() &mdash; ALSA Devel">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re:  [PATCH] ALSA: hda: Simplify	snd_hdac_refresh_widgets() &mdash; ALSA Devel</title>
<link rel="alternate" type="application/rss+xml" title="ALSA Devel" href="//feedproxy.google.com/AlsaDevel">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [PATCH] ALSA: hda: Simplify	snd_hdac_refresh_widgets()</h1>
[<a href="msg93620.html">Date Prev</a>][<a href="msg93622.html">Date Next</a>][<a href="msg93570.html">Thread Prev</a>][<a href="msg93622.html">Thread Next</a>][<a href="maillist.html#93621">Date Index</a>][<a href="threads.html#93621">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Takashi Iwai &lt;tiwai@xxxxxxx&gt;</li>
<li><em>Subject</em>: Re:  [PATCH] ALSA: hda: Simplify	snd_hdac_refresh_widgets()</li>
<li><em>From</em>: Evan Green &lt;evgreen@xxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Mon, 8 Jul 2019 09:49:01 -0700</li>
<li><em>Cc</em>: alsa-devel@xxxxxxxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg93570.html">20190705100605.19945-1-tiwai@suse.de</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg93570.html">20190705100605.19945-1-tiwai@suse.de</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Fri, Jul 5, 2019 at 3:06 AM Takashi Iwai &lt;tiwai@xxxxxxx&gt; wrote:
&gt;
&gt; Along with the recent fix for the races of snd_hdac_refresh_widgets()
&gt; it turned out that the instantiation of widgets sysfs at
&gt; snd_hdac_sysfs_reinit() could cause a race.  The race itself was
&gt; already covered later by extending the mutex protection range, the
&gt; commit 98482377dc72 (&quot;ALSA: hda: Fix widget_mutex incomplete
&gt; protection&quot;), but this also indicated that the call of *_reinit() is
&gt; basically superfluous, as the widgets shall be created sooner or later
&gt; from snd_hdac_device_register().
&gt;
&gt; This patch removes the redundant call of snd_hdac_sysfs_reinit() at
&gt; first.  By this removal, the sysfs argument itself in
&gt; snd_hdac_refresh_widgets() becomes superfluous, too, because the only
&gt; case sysfs=false is always with codec-&gt;widgets=NULL.  So, we drop this
&gt; redundant argument as well.
&gt;
&gt; Signed-off-by: Takashi Iwai &lt;tiwai@xxxxxxx&gt;
&gt; ---
&gt;  include/sound/hdaudio.h      |  2 +-
&gt;  sound/hda/hdac_device.c      | 13 +++++--------
&gt;  sound/hda/hdac_sysfs.c       |  2 +-
&gt;  sound/pci/hda/hda_codec.c    |  2 +-
&gt;  sound/soc/codecs/hdac_hdmi.c |  2 +-
&gt;  5 files changed, 9 insertions(+), 12 deletions(-)
&gt;
&gt; diff --git a/include/sound/hdaudio.h b/include/sound/hdaudio.h
&gt; index e8346784cf3f..f475293d0668 100644
&gt; --- a/include/sound/hdaudio.h
&gt; +++ b/include/sound/hdaudio.h
&gt; @@ -120,7 +120,7 @@ void snd_hdac_device_unregister(struct hdac_device *codec);
&gt;  int snd_hdac_device_set_chip_name(struct hdac_device *codec, const char *name);
&gt;  int snd_hdac_codec_modalias(struct hdac_device *hdac, char *buf, size_t size);
&gt;
&gt; -int snd_hdac_refresh_widgets(struct hdac_device *codec, bool sysfs);
&gt; +int snd_hdac_refresh_widgets(struct hdac_device *codec);
&gt;
&gt;  unsigned int snd_hdac_make_cmd(struct hdac_device *codec, hda_nid_t nid,
&gt;                                unsigned int verb, unsigned int parm);
&gt; diff --git a/sound/hda/hdac_device.c b/sound/hda/hdac_device.c
&gt; index 11050bfd8068..a265c1d68876 100644
&gt; --- a/sound/hda/hdac_device.c
&gt; +++ b/sound/hda/hdac_device.c
&gt; @@ -89,7 +89,7 @@ int snd_hdac_device_init(struct hdac_device *codec, struct hdac_bus *bus,
&gt;
&gt;         fg = codec-&gt;afg ? codec-&gt;afg : codec-&gt;mfg;
&gt;
&gt; -       err = snd_hdac_refresh_widgets(codec, false);
&gt; +       err = snd_hdac_refresh_widgets(codec);
&gt;         if (err &lt; 0)
&gt;                 goto error;
&gt;
&gt; @@ -394,9 +394,8 @@ static void setup_fg_nodes(struct hdac_device *codec)
&gt;  /**
&gt;   * snd_hdac_refresh_widgets - Reset the widget start/end nodes
&gt;   * @codec: the codec object
&gt; - * @sysfs: re-initialize sysfs tree, too
&gt;   */
&gt; -int snd_hdac_refresh_widgets(struct hdac_device *codec, bool sysfs)
&gt; +int snd_hdac_refresh_widgets(struct hdac_device *codec)
&gt;  {
&gt;         hda_nid_t start_nid;
&gt;         int nums, err = 0;
&gt; @@ -414,11 +413,9 @@ int snd_hdac_refresh_widgets(struct hdac_device *codec, bool sysfs)
&gt;                 goto unlock;
&gt;         }
&gt;
&gt; -       if (sysfs) {
&gt; -               err = hda_widget_sysfs_reinit(codec, start_nid, nums);
&gt; -               if (err &lt; 0)
&gt; -                       goto unlock;
&gt; -       }
&gt; +       err = hda_widget_sysfs_reinit(codec, start_nid, nums);
&gt; +       if (err &lt; 0)
&gt; +               goto unlock;
&gt;
&gt;         codec-&gt;num_nodes = nums;
&gt;         codec-&gt;start_nid = start_nid;
&gt; diff --git a/sound/hda/hdac_sysfs.c b/sound/hda/hdac_sysfs.c
&gt; index 909d5ef1179c..e56e83325903 100644
&gt; --- a/sound/hda/hdac_sysfs.c
&gt; +++ b/sound/hda/hdac_sysfs.c
&gt; @@ -428,7 +428,7 @@ int hda_widget_sysfs_reinit(struct hdac_device *codec,
&gt;         int i;
&gt;
&gt;         if (!codec-&gt;widgets)
&gt; -               return hda_widget_sysfs_init(codec);
&gt; +               return 0;

Hi Takashi,
So this no-ops out reinit() if there are no widgets. Are there any
cases in which hda_widget_sysfs_exit() could be called, followed by
hda_widget_sysfs_reinit()? That would be problematic, as exit would
wipe out the widgets, but now reinit would never restore them.

Are there any plausible cases where a caller might call
refresh_widgets() and then attempt to utilize or otherwise depend on
the widgets being present? The semantics of this function seem odd to
me now, as it will now return having updated num_nodes, start_nid, and
end_nid, but without having actually built the widgets array.

I'm probably biased, but I still think it makes more sense to let
sysfs_reinit actually reinitialize the widgets, but just pass down
start_nid and count so that the tree is built correctly.
-Evan
_______________________________________________
Alsa-devel mailing list
Alsa-devel@xxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://mailman.alsa-project.org/mailman/listinfo/alsa-devel">https://mailman.alsa-project.org/mailman/listinfo/alsa-devel</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="93622" href="msg93622.html">Re:  [PATCH] ALSA: hda: Simplify	snd_hdac_refresh_widgets()</a></strong>
<ul><li><em>From:</em> Takashi Iwai</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="93570" href="msg93570.html">[PATCH] ALSA: hda: Simplify snd_hdac_refresh_widgets()</a></strong>
<ul><li><em>From:</em> Takashi Iwai</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg93620.html">[RFC PATCH] ASoC: max98357a: use mdelay for	sdmode-delay</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg93622.html">Re:  [PATCH] ALSA: hda: Simplify	snd_hdac_refresh_widgets()</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg93570.html">[PATCH] ALSA: hda: Simplify snd_hdac_refresh_widgets()</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg93622.html">Re:  [PATCH] ALSA: hda: Simplify	snd_hdac_refresh_widgets()</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#93621"><strong>Date</strong></a></li>
<li><a href="threads.html#93621"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/alsa-user/>[ALSA&nbsp;User]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/pulse-audio/>[Pulse&nbsp;Audio]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Kernel&nbsp;Archive]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=http://yosemitephotos.net/>[Photo&nbsp;Sharing]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/linux-sound/>[Linux&nbsp;Sound]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-media/>[Video&nbsp;4&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/gimp/>[Gimp]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

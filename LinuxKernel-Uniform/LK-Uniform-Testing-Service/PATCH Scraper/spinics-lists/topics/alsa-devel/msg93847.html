<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH 1/3] ASoC: fsl_sai: add of_match data -->
<!--X-From-R13: Zhpnf Egnpu &#60;y.fgnpuNcrathgebavk.qr> -->
<!--X-Date: Wed, 17 Jul 2019 03:58:35 &#45;0700 -->
<!--X-Message-Id: 20190717105635.18514&#45;2&#45;l.stach@pengutronix.de -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190717105635.18514&#45;1&#45;l.stach@pengutronix.de -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="[PATCH 1/3] ASoC: fsl_sai: add of_match data &mdash; ALSA Devel">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[PATCH 1/3] ASoC: fsl_sai: add of_match data &mdash; ALSA Devel</title>
<link rel="alternate" type="application/rss+xml" title="ALSA Devel" href="//feedproxy.google.com/AlsaDevel">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH 1/3] ASoC: fsl_sai: add of_match data</h1>
[<a href="msg93846.html">Date Prev</a>][<a href="msg93848.html">Date Next</a>][<a href="msg93846.html">Thread Prev</a>][<a href="msg93854.html">Thread Next</a>][<a href="maillist.html#93847">Date Index</a>][<a href="threads.html#93847">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Timur Tabi &lt;timur@xxxxxxxxxx&gt;, Nicolin Chen &lt;nicoleotsuka@xxxxxxxxx&gt;,        Xiubo Li &lt;Xiubo.Lee@xxxxxxxxx&gt;, Fabio Estevam &lt;festevam@xxxxxxxxx&gt;,        Liam Girdwood &lt;lgirdwood@xxxxxxxxx&gt;, Mark Brown &lt;broonie@xxxxxxxxxx&gt;</li>
<li><em>Subject</em>: [PATCH 1/3] ASoC: fsl_sai: add of_match data</li>
<li><em>From</em>: Lucas Stach &lt;l.stach@xxxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Wed, 17 Jul 2019 12:56:33 +0200</li>
<li><em>Cc</em>: alsa-devel@xxxxxxxxxxxxxxxx, Angus Ainslie &lt;angus@xxxxxxxx&gt;,        NXP Linux Team &lt;linux-imx@xxxxxxx&gt;, kernel@xxxxxxxxxxxxxx,        patchwork-lst@xxxxxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg93846.html">20190717105635.18514-1-l.stach@pengutronix.de</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg93846.html">20190717105635.18514-1-l.stach@pengutronix.de</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>New revisions of the SAI IP block have even more differences that need
be taken into account by the driver. To avoid sprinking compatible
checks all over the driver move the current differences into of_match_data.

Signed-off-by: Lucas Stach &lt;l.stach@xxxxxxxxxxxxxx&gt;
---
 sound/soc/fsl/fsl_sai.c | 22 ++++++++++++++--------
 sound/soc/fsl/fsl_sai.h |  6 +++++-
 2 files changed, 19 insertions(+), 9 deletions(-)

diff --git a/sound/soc/fsl/fsl_sai.c b/sound/soc/fsl/fsl_sai.c
index 812c94fbb160..3a1ed8b857d6 100644
--- a/sound/soc/fsl/fsl_sai.c
+++ b/sound/soc/fsl/fsl_sai.c
@@ -9,6 +9,7 @@
 #include &lt;linux/dmaengine.h&gt;
 #include &lt;linux/module.h&gt;
 #include &lt;linux/of_address.h&gt;
+#include &lt;linux/of_device.h&gt;
 #include &lt;linux/pm_runtime.h&gt;
 #include &lt;linux/regmap.h&gt;
 #include &lt;linux/slab.h&gt;
@@ -798,10 +799,7 @@ static int fsl_sai_probe(struct platform_device *pdev)
 		return -ENOMEM;
 
 	sai-&gt;pdev = pdev;
-
-	if (of_device_is_compatible(np, &quot;fsl,imx6sx-sai&quot;) ||
-	    of_device_is_compatible(np, &quot;fsl,imx6ul-sai&quot;))
-		sai-&gt;sai_on_imx = true;
+	sai-&gt;soc_data = of_device_get_match_data(&amp;pdev-&gt;dev);
 
 	sai-&gt;is_lsb_first = of_property_read_bool(np, &quot;lsb-first&quot;);
 
@@ -910,7 +908,7 @@ static int fsl_sai_probe(struct platform_device *pdev)
 	if (ret)
 		return ret;
 
-	if (sai-&gt;sai_on_imx)
+	if (sai-&gt;soc_data-&gt;use_imx_pcm)
 		return imx_pcm_dma_init(pdev, IMX_SAI_DMABUF_SIZE);
 	else
 		return devm_snd_dmaengine_pcm_register(&amp;pdev-&gt;dev, NULL, 0);
@@ -923,10 +921,18 @@ static int fsl_sai_remove(struct platform_device *pdev)
 	return 0;
 }
 
+static const struct fsl_sai_soc_data fsl_sai_vf610_data = {
+	.use_imx_pcm = false,
+};
+
+static const struct fsl_sai_soc_data fsl_sai_imx6sx_data = {
+	.use_imx_pcm = true,
+};
+
 static const struct of_device_id fsl_sai_ids[] = {
-	{ .compatible = &quot;fsl,vf610-sai&quot;, },
-	{ .compatible = &quot;fsl,imx6sx-sai&quot;, },
-	{ .compatible = &quot;fsl,imx6ul-sai&quot;, },
+	{ .compatible = &quot;fsl,vf610-sai&quot;, .data = &amp;fsl_sai_vf610_data },
+	{ .compatible = &quot;fsl,imx6sx-sai&quot;, .data = &amp;fsl_sai_imx6sx_data },
+	{ .compatible = &quot;fsl,imx6ul-sai&quot;, .data = &amp;fsl_sai_imx6sx_data },
 	{ /* sentinel */ }
 };
 MODULE_DEVICE_TABLE(of, fsl_sai_ids);
diff --git a/sound/soc/fsl/fsl_sai.h b/sound/soc/fsl/fsl_sai.h
index 24cb156bf995..83e2bfe05b1b 100644
--- a/sound/soc/fsl/fsl_sai.h
+++ b/sound/soc/fsl/fsl_sai.h
@@ -126,6 +126,10 @@
 #define FSL_SAI_MAXBURST_TX 6
 #define FSL_SAI_MAXBURST_RX 6
 
+struct fsl_sai_soc_data {
+	bool use_imx_pcm;
+};
+
 struct fsl_sai {
 	struct platform_device *pdev;
 	struct regmap *regmap;
@@ -135,7 +139,6 @@ struct fsl_sai {
 	bool is_slave_mode;
 	bool is_lsb_first;
 	bool is_dsp_mode;
-	bool sai_on_imx;
 	bool synchronous[2];
 
 	unsigned int mclk_id[2];
@@ -143,6 +146,7 @@ struct fsl_sai {
 	unsigned int slots;
 	unsigned int slot_width;
 
+	const struct fsl_sai_soc_data *soc_data;
 	struct snd_dmaengine_dai_dma_data dma_params_rx;
 	struct snd_dmaengine_dai_dma_data dma_params_tx;
 };
-- 
2.20.1

_______________________________________________
Alsa-devel mailing list
Alsa-devel@xxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://mailman.alsa-project.org/mailman/listinfo/alsa-devel">https://mailman.alsa-project.org/mailman/listinfo/alsa-devel</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="93899" href="msg93899.html">Re:  [PATCH 1/3] ASoC: fsl_sai: add of_match data</a></strong>
<ul><li><em>From:</em> Angus Ainslie</li></ul></li>
<li><strong><a name="93854" href="msg93854.html">Re:  [PATCH 1/3] ASoC: fsl_sai: add of_match data</a></strong>
<ul><li><em>From:</em> Daniel Baluta</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="93846" href="msg93846.html">[PATCH 0/3] i.MX8M support for FSL SAI</a></strong>
<ul><li><em>From:</em> Lucas Stach</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg93846.html">[PATCH 0/3] i.MX8M support for FSL SAI</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg93848.html">[PATCH 3/3] ASoC: fsl_sai: add i.MX8M support</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg93846.html">[PATCH 0/3] i.MX8M support for FSL SAI</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg93854.html">Re:  [PATCH 1/3] ASoC: fsl_sai: add of_match data</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#93847"><strong>Date</strong></a></li>
<li><a href="threads.html#93847"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/alsa-user/>[ALSA&nbsp;User]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/pulse-audio/>[Pulse&nbsp;Audio]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Kernel&nbsp;Archive]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=http://yosemitephotos.net/>[Photo&nbsp;Sharing]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/linux-sound/>[Linux&nbsp;Sound]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-media/>[Video&nbsp;4&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/gimp/>[Gimp]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH V4] ALSA: usb&#45;audio: Scarlett Gen 2 mixer	interface -->
<!--X-From-R13: Fnxnfuv Wjnv &#60;gvjnvNfhfr.qr> -->
<!--X-Date: Tue, 9 Jul 2019 06:58:28 &#45;0700 -->
<!--X-Message-Id: s5hk1crtinr.wl&#45;tiwai@suse.de -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190709132605.GA25293@b4.vu -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re:  [PATCH V4] ALSA: usb-audio: Scarlett Gen 2 mixer	interface &mdash; ALSA Devel">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re:  [PATCH V4] ALSA: usb-audio: Scarlett Gen 2 mixer	interface &mdash; ALSA Devel</title>
<link rel="alternate" type="application/rss+xml" title="ALSA Devel" href="//feedproxy.google.com/AlsaDevel">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [PATCH V4] ALSA: usb-audio: Scarlett Gen 2 mixer	interface</h1>
[<a href="msg93643.html">Date Prev</a>][<a href="msg93645.html">Date Next</a>][<a href="msg93640.html">Thread Prev</a>][<a href="msg93645.html">Thread Next</a>][<a href="maillist.html#93644">Date Index</a>][<a href="threads.html#93644">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: &quot;Geoffrey D. Bennett&quot; &lt;g@xxxxx&gt;</li>
<li><em>Subject</em>: Re:  [PATCH V4] ALSA: usb-audio: Scarlett Gen 2 mixer	interface</li>
<li><em>From</em>: Takashi Iwai &lt;tiwai@xxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 09 Jul 2019 15:57:28 +0200</li>
<li><em>Cc</em>: alsa-devel@xxxxxxxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg93640.html">20190709132605.GA25293@b4.vu</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg93640.html">20190709132605.GA25293@b4.vu</a>&gt;</li>
<li><em>User-agent</em>: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka) FLIM/1.14.9 (Goj&#x14D;) APEL/10.8 Emacs/25.3 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Tue, 09 Jul 2019 15:26:05 +0200,
Geoffrey D. Bennett wrote:
&gt; 
&gt; Only outstanding question I believe:
&gt; 
&gt; - Takashi, you wrote last time &quot;Also, the delayed work needs to be
&gt;   canceled or flushed at PM suspend callback as well as
&gt;   disconnecting.&quot; I'm not sure why it should be cancelled; is it not
&gt;   okay to do on resume?

Not really.  The standard idiom is to cancel the pending task
immediately at suspend, so that the whole PM procedure won't be
interfered, then reschedule the work at resume again.

&gt; But I tested suspending while the delayed work
&gt;   was waiting and it seemed like the delayed work was cancelled
&gt;   anyway. Probably better to do a flush on suspend though;

The flush would block, hence it wastes lots of time at suspend.
Ideally the suspend should be performed immediately.

&gt; should this
&gt;   be done through a hook like:
&gt; 
&gt;   diff --git a/sound/usb/mixer.c b/sound/usb/mixer.c
&gt;   index 2444737a14b2..1572a89267c6 100644
&gt;   --- a/sound/usb/mixer.c
&gt;   +++ b/sound/usb/mixer.c
&gt;   @@ -3547,6 +3547,8 @@ static int snd_usb_mixer_activate(struct usb_mixer_interface *mixer)
&gt;    int snd_usb_mixer_suspend(struct usb_mixer_interface *mixer)
&gt;    {
&gt;           snd_usb_mixer_inactivate(mixer);
&gt;   +       if (mixer-&gt;private_suspend)
&gt;   +               mixer-&gt;private_suspend(mixer);
&gt;           return 0;
&gt;    }
&gt;    
&gt;   diff --git a/sound/usb/mixer.h b/sound/usb/mixer.h
&gt;   index fa6e216a06f0..d94c688c65f7 100644
&gt;   --- a/sound/usb/mixer.h
&gt;   +++ b/sound/usb/mixer.h
&gt;   @@ -28,6 +28,7 @@ struct usb_mixer_interface {
&gt;    
&gt;           void *private_data;
&gt;           void (*private_free)(struct usb_mixer_interface *private_data);
&gt;   +       void (*private_suspend)(struct usb_mixer_interface *);
&gt;    };
&gt;    
&gt;    #define MAX_CHANNELS   16      /* max logical channels */
&gt; 
&gt;   ...or just keep the existing behaviour where it seems to get
&gt;   cancelled?

I'm fine to add the new suspend/resume callbacks, but maybe the
corresponding resume would be needed.

Other than that, the patch looks almost good.

&gt; --- /dev/null
&gt; +++ b/sound/usb/mixer_scarlett_gen2.c
&gt; @@ -0,0 +1,2078 @@
&gt; +// SPDX-License-Identifier: GPL-2.0
&gt; +/*
&gt; + *   Focusrite Scarlett 6i6/18i8/18i20 Gen 2 Driver for ALSA
&gt; + *
&gt; + *   Copyright (c) 2018-2019 by Geoffrey D. Bennett &lt;g at b4.vu&gt;
&gt; + *
&gt; + *   Based on the Scarlett (Gen 1) Driver for ALSA:
&gt; + *
&gt; + *   Copyright (c) 2013 by Tobias Hoffmann
&gt; + *   Copyright (c) 2013 by Robin Gareus &lt;robin at gareus.org&gt;
&gt; + *   Copyright (c) 2002 by Takashi Iwai &lt;tiwai at suse.de&gt;
&gt; + *   Copyright (c) 2014 by Chris J Arges &lt;chris.j.arges at canonical.com&gt;
&gt; + *
&gt; + *   Many codes borrowed from audio.c by
&gt; + *     Alan Cox (alan at lxorguk.ukuu.org.uk)
&gt; + *     Thomas Sailer (sailer at ife.ee.ethz.ch)
&gt; + *
&gt; + *   Code cleanup:
&gt; + *   David Henningsson &lt;david.henningsson at canonical.com&gt;
&gt; + *
&gt; + *   This program is free software; you can redistribute it and/or modify
&gt; + *   it under the terms of the GNU General Public License as published by
&gt; + *   the Free Software Foundation; either version 2 of the License, or
&gt; + *   (at your option) any later version.
&gt; + *
&gt; + *   This program is distributed in the hope that it will be useful,
&gt; + *   but WITHOUT ANY WARRANTY; without even the implied warranty of
&gt; + *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
&gt; + *   GNU General Public License for more details.

Drop these texts.  The SPDX identifier should suffice.

&gt; +static int scarlett_gen2_mixer_enable;
&gt; +module_param(scarlett_gen2_mixer_enable, int, 0444);
&gt; +MODULE_PARM_DESC(scarlett_gen2_mixer_enable,
&gt; +		 &quot;Focusrite Scarlett Gen 2 Mixer Driver Enable&quot;);

Do we need this?  If disabling the quirk is really required, it should
be implemented rather in a generic option, instead.


&gt; +/* Send a proprietary format request to the Scarlett interface */
&gt; +static int scarlett2_usb(
&gt; +	struct usb_mixer_interface *mixer, u32 cmd,
&gt; +	void *req_data, u16 req_size, void *resp_data, u16 resp_size)
&gt; +{
&gt; +	struct scarlett2_mixer_data *private = mixer-&gt;private_data;
&gt; +
&gt; +	u16 req_buf_size = sizeof(struct scarlett2_usb_packet) + req_size;
&gt; +	u16 resp_buf_size = sizeof(struct scarlett2_usb_packet) + resp_size;
&gt; +
&gt; +	struct scarlett2_usb_packet *req = 0, *resp = 0;
&gt; +
&gt; +	int err = 0;

Avoid unnecessary blank lines.

&gt; +
&gt; +	mutex_lock(&amp;private-&gt;usb_mutex);
&gt; +
&gt; +	/* build request message and send it */
&gt; +
&gt; +	req = kmalloc(req_buf_size, GFP_KERNEL);
&gt; +	if (!req) {
&gt; +		err = -ENOMEM;
&gt; +		goto unlock;
&gt; +	}

Better to run kmalloc outside the mutex.  It's not necessarily
exclusive.

&gt; +	/* send a second message to get the response */
&gt; +
&gt; +	resp = kmalloc(resp_buf_size, GFP_KERNEL);
&gt; +	if (!resp) {
&gt; +		err = -ENOMEM;
&gt; +		goto unlock;
&gt; +	}

Ditto, this could be better allocated before the critical section.


thanks,

Takashi
_______________________________________________
Alsa-devel mailing list
Alsa-devel@xxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://mailman.alsa-project.org/mailman/listinfo/alsa-devel">https://mailman.alsa-project.org/mailman/listinfo/alsa-devel</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="93645" href="msg93645.html">Re:  [PATCH V4] ALSA: usb-audio: Scarlett Gen 2 mixer	interface</a></strong>
<ul><li><em>From:</em> Geoffrey D. Bennett</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="93640" href="msg93640.html">[PATCH V4] ALSA: usb-audio: Scarlett Gen 2 mixer	interface</a></strong>
<ul><li><em>From:</em> Geoffrey D. Bennett</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg93643.html">Re:  DW-DMA: Probe failures on broadwell</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg93645.html">Re:  [PATCH V4] ALSA: usb-audio: Scarlett Gen 2 mixer	interface</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg93640.html">[PATCH V4] ALSA: usb-audio: Scarlett Gen 2 mixer	interface</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg93645.html">Re:  [PATCH V4] ALSA: usb-audio: Scarlett Gen 2 mixer	interface</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#93644"><strong>Date</strong></a></li>
<li><a href="threads.html#93644"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/alsa-user/>[ALSA&nbsp;User]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/pulse-audio/>[Pulse&nbsp;Audio]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Kernel&nbsp;Archive]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=http://yosemitephotos.net/>[Photo&nbsp;Sharing]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/linux-sound/>[Linux&nbsp;Sound]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-media/>[Video&nbsp;4&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/gimp/>[Gimp]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH] Fix usage of uninitialized pointer -->
<!--X-From-R13: Wna Yrag &#60;eniraNgurznj.arg> -->
<!--X-Date: Tue, 30 May 2017 18:37:53 &#45;0700 -->
<!--X-Message-Id: 1496194664.3804.3.camel@themaw.net -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 1496151337&#45;21367&#45;1&#45;git&#45;send&#45;email&#45;buczek@molgen.mpg.de -->
<!--X-Reference: 1496190434.3804.1.camel@themaw.net -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re: [PATCH] Fix usage of uninitialized pointer &mdash; Linux AutoFS">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH] Fix usage of uninitialized pointer &mdash; Linux AutoFS</title>
<link rel="alternate" type="application/rss+xml" title="Linux AutoFS" href="//feeds.feedburner.com/autofs">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com/cse" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:isdiegq275o" />
    <input type="hidden" name="ie" value="ISO-8859-1" />
    <input type="text" name="q" size="37" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH] Fix usage of uninitialized pointer</h1>
[<a href="msg01599.html">Date Prev</a>][<a href="msg01601.html">Date Next</a>][<a href="msg01599.html">Thread Prev</a>][<a href="msg01601.html">Thread Next</a>][<a href="maillist.html#01600">Date Index</a>][<a href="index.html#01600">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Donald Buczek &lt;buczek@xxxxxxxxxxxxx&gt;</li>
<li><em>Subject</em>: Re: [PATCH] Fix usage of uninitialized pointer</li>
<li><em>From</em>: Ian Kent &lt;raven@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Wed, 31 May 2017 09:37:44 +0800</li>
<li><em>Cc</em>: autofs@xxxxxxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg01599.html">1496190434.3804.1.camel@themaw.net</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg01598.html">1496151337-21367-1-git-send-email-buczek@molgen.mpg.de</a>&gt;         &lt;<a href="msg01599.html">1496190434.3804.1.camel@themaw.net</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Wed, 2017-05-31 at 08:27 +0800, Ian Kent wrote:
&gt; On Tue, 2017-05-30 at 15:35 +0200, Donald Buczek wrote:
&gt; &gt; In the error path after a getgrgid_r failure (e.g. when a unnamed gid
&gt; &gt; was used), the pointer tsv-&gt;group was left unitialized. Still the tsv
&gt; &gt; was given to pthread_setspecific(key_thread_stdenv_vars,...) and the
&gt; &gt; consumers used and freed the uninitialized pointer.
&gt; 
&gt; Umm ... ok, I'll check ... good catch.

I think this bug will warrant another release.

&gt; 
&gt; &gt; 
&gt; &gt; &#xA0;&#xA0;&#xA0;&#xA0;2017-05-29T18:16:11+02:00 rofl automount[14749]: attempting to mount
&gt; &gt; entry
&gt; &gt; /package/twiki
&gt; &gt; &#xA0;&#xA0;&#xA0;&#xA0;2017-05-29T18:16:11+02:00 rofl automount[14749]: set_tsd_user_vars:
&gt; &gt; failed
&gt; &gt; to get group info from getgrgid_r
&gt; &gt; &#xA0;&#xA0;&#xA0;&#xA0;2017-05-29T18:16:11+02:00 rofl automount[14749]: mounted /package/twiki
&gt; &gt; &#xA0;&#xA0;&#xA0;&#xA0;2017-05-29T18:16:11+02:00 rofl systemd[1]: automount.service: main
&gt; &gt; process
&gt; &gt; exited, code=dumped, status=6
&gt; &gt; &#xA0;&#xA0;&#xA0;&#xA0;2017-05-29T18:16:12+02:00 rofl systemd[1]: automount.service holdoff
&gt; &gt; time
&gt; &gt; over, scheduling restart.
&gt; &gt; &#xA0;&#xA0;&#xA0;&#xA0;2017-05-29T18:16:12+02:00 rofl systemd[1]: Unit automount.service
&gt; &gt; entered
&gt; &gt; failed state.
&gt; &gt; &#xA0;&#xA0;&#xA0;&#xA0;2017-05-29T18:16:12+02:00 rofl automount[17936]: Starting automounter
&gt; &gt; version 5.1.3, master map auto.master
&gt; &gt; 
&gt; &gt; &#xA0;&#xA0;&#xA0;&#xA0;[May29 18:16] traps: automount[18234] general protection ip:7f8b025c324a
&gt; &gt; sp:7f8b0049a508 error:0 in libc-2.19.so[7f8b02541000+1a2000]
&gt; &gt; 
&gt; &gt; Handle the error by not calling pthread_setspecific. Clean up
&gt; &gt; and return instead.
&gt; &gt; ---
&gt; &gt; &#xA0;lib/mounts.c | 21 ++++++++++++---------
&gt; &gt; &#xA0;1 file changed, 12 insertions(+), 9 deletions(-)
&gt; &gt; 
&gt; &gt; diff --git a/lib/mounts.c b/lib/mounts.c
&gt; &gt; index ce6a60a..fe1a6cd 100644
&gt; &gt; --- a/lib/mounts.c
&gt; &gt; +++ b/lib/mounts.c
&gt; &gt; @@ -1552,28 +1552,31 @@ void set_tsd_user_vars(unsigned int logopt, uid_t
&gt; &gt; uid,
&gt; &gt; gid_t gid)
&gt; &gt; &#xA0;	}
&gt; &gt; &#xA0;
&gt; &gt; &#xA0;no_group:
&gt; &gt; -	if (status || !pgr)
&gt; &gt; +	if (status || !pgr) {
&gt; &gt; &#xA0;		error(logopt, &quot;failed to get group info from getgrgid_r&quot;);
&gt; &gt; -	else {
&gt; 
&gt; Extra braces, I leave these out (when I can) on single statement clauses
&gt; deliberately and always try to put the single statement as the first branch of
&gt; the if.
&gt; 
&gt; &gt; +		goto free_gr_tmp;
&gt; &gt; +	} else {
&gt; &gt; &#xA0;		tsv-&gt;group = strdup(gr.gr_name);
&gt; &gt; -		if (!tsv-&gt;group)
&gt; &gt; +		if (!tsv-&gt;group) {
&gt; &gt; &#xA0;			error(logopt, &quot;failed to malloc buffer for group&quot;);
&gt; &gt; +			goto free_gr_tmp;
&gt; &gt; +		}
&gt; &gt; &#xA0;	}
&gt; &gt; &#xA0;
&gt; &gt; -	if (gr_tmp)
&gt; &gt; -		free(gr_tmp);
&gt; &gt; -
&gt; &gt; &#xA0;	status = pthread_setspecific(key_thread_stdenv_vars, tsv);
&gt; &gt; &#xA0;	if (status) {
&gt; &gt; &#xA0;		error(logopt, &quot;failed to set stdenv thread var&quot;);
&gt; &gt; &#xA0;		goto free_tsv_group;
&gt; &gt; &#xA0;	}
&gt; &gt; -
&gt; &gt; +	if (gr_tmp)
&gt; &gt; +		free(gr_tmp);
&gt; 
&gt; But this doesn't do what I intended.
&gt; 
&gt; What I want to do is set the thread specific standard variables even if the
&gt; group name can't be obtained.
&gt; 
&gt; It looks like I've made an assumption elsewhere that if the tsd is set then
&gt; all
&gt; the variables have valid values, I'd rather fix that than do this.

I would prefer to do this instead.

Could you check this resolves the problem you have seen please.

autofs-5.1.3 - fix unset tsd group name handling

From: Ian Kent &lt;raven@xxxxxxxxxx&gt;

Commit 1a64a6bbc5 changed set_tsd_user_vars() to set the thread specific
values even if the group name could not be obtained.

But the structure holding the values was not initialized on allocation
so the group field might not be NULL when no group name is available.

Also the macro addition and removal functions didn't handle setting a
macro name with a NULL value.

Signed-off-by: Ian Kent &lt;raven@xxxxxxxxxx&gt;
Reported-by: Donald Buczek &lt;buczek@xxxxxxxxxxxxx&gt;
---
&#xA0;lib/macros.c |&#xA0;&#xA0;&#xA0;27 +++++++++++++--------------
&#xA0;lib/mounts.c |&#xA0;&#xA0;&#xA0;&#xA0;1 +
&#xA0;2 files changed, 14 insertions(+), 14 deletions(-)

diff --git a/lib/macros.c b/lib/macros.c
index ff9ba89..30dbcdb 100644
--- a/lib/macros.c
+++ b/lib/macros.c
@@ -281,19 +281,21 @@ macro_addvar(struct substvar *table, const char *str, int
len, const char *value
&#xA0;	}
&#xA0;
&#xA0;	if (lv) {
-		char *this = malloc(strlen(value) + 1);
-		if (!this) {
-			lv = table;
-			goto done;
+		char *this = NULL;
+
+		if (value) {
+			this = malloc(strlen(value) + 1);
+			if (this)
+				strcpy(this, value);
&#xA0;		}
-		strcpy(this, value);
-		free(lv-&gt;val);
+		if (lv-&gt;val)
+			free(lv-&gt;val);
&#xA0;		lv-&gt;val = this;
&#xA0;		if (lv != table)
&#xA0;			lv = table;
&#xA0;	} else {
&#xA0;		struct substvar *new;
-		char *def, *val;
+		char *def, *val = NULL;
&#xA0;
&#xA0;		def = strdup(str);
&#xA0;		if (!def) {
@@ -302,18 +304,15 @@ macro_addvar(struct substvar *table, const char *str, int
len, const char *value
&#xA0;		}
&#xA0;		def[len] = '\0';
&#xA0;
-		val = strdup(value);
-		if (!val) {
-			lv = table;
-			free(def);
-			goto done;
-		}
+		if (value)
+			val = strdup(value);
&#xA0;
&#xA0;		new = malloc(sizeof(struct substvar));
&#xA0;		if (!new) {
&#xA0;			lv = table;
&#xA0;			free(def);
-			free(val);
+			if (val)
+				free(val);
&#xA0;			goto done;
&#xA0;		}
&#xA0;		new-&gt;def = def;
diff --git a/lib/mounts.c b/lib/mounts.c
index ce6a60a..0b38bd8 100644
--- a/lib/mounts.c
+++ b/lib/mounts.c
@@ -1463,6 +1463,7 @@ void set_tsd_user_vars(unsigned int logopt, uid_t uid,
gid_t gid)
&#xA0;		error(logopt, &quot;failed alloc tsv storage&quot;);
&#xA0;		return;
&#xA0;	}
+	memset(tsv, 0, sizeof(struct thread_stdenv_vars));
&#xA0;
&#xA0;	tsv-&gt;uid = uid;
&#xA0;	tsv-&gt;gid = gid;
--
To unsubscribe from this list: send the line &quot;unsubscribe autofs&quot; in


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="01601" href="msg01601.html">Re: [PATCH] Fix usage of uninitialized pointer</a></strong>
<ul><li><em>From:</em> Donald Buczek</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="01598" href="msg01598.html">[PATCH] Fix usage of uninitialized pointer</a></strong>
<ul><li><em>From:</em> Donald Buczek</li></ul></li>
<li><strong><a name="01599" href="msg01599.html">Re: [PATCH] Fix usage of uninitialized pointer</a></strong>
<ul><li><em>From:</em> Ian Kent</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg01599.html">Re: [PATCH] Fix usage of uninitialized pointer</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg01601.html">Re: [PATCH] Fix usage of uninitialized pointer</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg01599.html">Re: [PATCH] Fix usage of uninitialized pointer</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg01601.html">Re: [PATCH] Fix usage of uninitialized pointer</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#01600"><strong>Date</strong></a></li>
<li><a href="index.html#01600"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-fsdevel/>[Linux&nbsp;Filesystem&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-ext4/>[Linux&nbsp;Ext4]</a>
&nbsp;
&nbsp;
<a href=/lists/arm-kernel/>[Linux&nbsp;ARM&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/arm/>[Linux&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;Omap]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-arm/>[Fedora&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/ietf-ann/>[IETF&nbsp;Annouce]</a>
&nbsp;
&nbsp;
<a href=/lists/security/>[Security]</a>
&nbsp;
&nbsp;
<a href=/lists/bugtraq/>[Bugtraq]</a>
&nbsp;
&nbsp;
<a href=/linux/>[Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;OMAP]</a>
&nbsp;
&nbsp;
<a href=/lists/mips/>[Linux&nbsp;MIPS]</a>
&nbsp;
&nbsp;
<a href=/lists/ecos/>[ECOS]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;Internet&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-api/>[Linux&nbsp;API]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

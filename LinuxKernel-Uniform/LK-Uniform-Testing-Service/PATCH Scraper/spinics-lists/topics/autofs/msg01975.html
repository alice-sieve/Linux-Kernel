<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH 18/22] autofs&#45;5.1.4 &#45; add systemd service command line option -->
<!--X-From-R13: Wna Yrag &#60;eniraNgurznj.arg> -->
<!--X-Date: Sun, 14 Oct 2018 20:48:10 &#45;0700 -->
<!--X-Message-Id: 153957509984.14897.12111534820516481994.stgit@pluto&#45;themaw&#45;net -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 153957483372.14897.14805717004658230261.stgit@pluto&#45;themaw&#45;net -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="[PATCH 18/22] autofs-5.1.4 - add systemd service command line option &mdash; Linux AutoFS">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[PATCH 18/22] autofs-5.1.4 - add systemd service command line option &mdash; Linux AutoFS</title>
<link rel="alternate" type="application/rss+xml" title="Linux AutoFS" href="//feeds.feedburner.com/autofs">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com/cse" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:isdiegq275o" />
    <input type="hidden" name="ie" value="ISO-8859-1" />
    <input type="text" name="q" size="37" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH 18/22] autofs-5.1.4 - add systemd service command line option</h1>
[<a href="msg01974.html">Date Prev</a>][<a href="msg01976.html">Date Next</a>][<a href="msg01974.html">Thread Prev</a>][<a href="msg01976.html">Thread Next</a>][<a href="maillist.html#01975">Date Index</a>][<a href="index.html#01975">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: autofs mailing list &lt;autofs@xxxxxxxxxxxxxxx&gt;</li>
<li><em>Subject</em>: [PATCH 18/22] autofs-5.1.4 - add systemd service command line option</li>
<li><em>From</em>: Ian Kent &lt;raven@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Mon, 15 Oct 2018 11:45:00 +0800</li>
<li><em>In-reply-to</em>: &lt;153957483372.14897.14805717004658230261.stgit@pluto-themaw-net&gt;</li>
<li><em>References</em>: &lt;153957483372.14897.14805717004658230261.stgit@pluto-themaw-net&gt;</li>
<li><em>User-agent</em>: StGit/unknown-version</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>When run as a systemd service using the systemd notification method to
synchronise startup, logging should be done to syslog so the log entry
format is consistent between daemon and systemd usage.

So, rather than run use the forground option, add an option to tell
the automounter it's being run as a systemd service and use syslog
for logging when its present on the command line.

Signed-off-by: Ian Kent &lt;raven@xxxxxxxxxx&gt;
---
 CHANGELOG                 |    1 +
 daemon/automount.c        |   22 +++++++++++++++++++---
 include/automount.h       |    1 +
 man/automount.8           |    4 ++++
 samples/autofs.service.in |    2 +-
 5 files changed, 26 insertions(+), 4 deletions(-)

diff --git a/CHANGELOG b/CHANGELOG
index 4e1d9c98..21fc9ca7 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -47,6 +47,7 @@ xx/xx/2018 autofs-5.1.5
 - update build info with systemd.
 - use flags for startup boolean options.
 - move close stdio descriptors to become_daemon().
+- add systemd service command line option.
 
 19/12/2017 autofs-5.1.4
 - fix spec file url.
diff --git a/daemon/automount.c b/daemon/automount.c
index c1360ed6..4628f20c 100644
--- a/daemon/automount.c
+++ b/daemon/automount.c
@@ -1210,13 +1210,21 @@ static void become_daemon(unsigned int flags)
 	}
 
 	/* Detach from foreground process */
-	if (flags &amp; DAEMON_FLAGS_FOREGROUND) {
+	if (flags &amp; DAEMON_FLAGS_FOREGROUND &amp;&amp;
+	   !(flags &amp; DAEMON_FLAGS_SYSTEMD_SERVICE)) {
 		if ((flags &amp; DAEMON_FLAGS_CHECK_DAEMON) &amp;&amp; !aquire_flag_file()) {
 			fprintf(stderr, &quot;%s: program is already running.\n&quot;,
 				program);
 			exit(1);
 		}
 		log_to_stderr();
+	} else if (flags &amp; DAEMON_FLAGS_SYSTEMD_SERVICE) {
+		if ((flags &amp; DAEMON_FLAGS_CHECK_DAEMON) &amp;&amp; !aquire_flag_file()) {
+			fprintf(stderr, &quot;%s: program is already running.\n&quot;,
+				program);
+			exit(1);
+		}
+		open_log();
 	} else {
 		int nullfd;
 
@@ -1925,6 +1933,8 @@ static void usage(void)
 		&quot;	-d --debug	log debuging info\n&quot;
 		&quot;	-Dvariable=value, --define variable=value\n&quot;
 		&quot;			define global macro variable\n&quot;
+		&quot;	-S --systemd-service\n&quot;
+		&quot;			run automounter as a systemd service\n&quot;
 		&quot;	-f --foreground do not fork into background\n&quot;
 		&quot;	-r --random-multimount-selection\n&quot;
 		&quot;			use ramdom replicated server selection\n&quot;
@@ -2190,7 +2200,7 @@ int main(int argc, char *argv[])
 	time_t timeout;
 	time_t age = monotonic_time(NULL);
 	struct rlimit rlim;
-	const char *options = &quot;+hp:t:vmdD:fVrO:l:n:CFM&quot;;
+	const char *options = &quot;+hp:t:vmdD:SfVrO:l:n:CFM&quot;;
 	static const struct option long_options[] = {
 		{&quot;help&quot;, 0, 0, 'h'},
 		{&quot;pid-file&quot;, 1, 0, 'p'},
@@ -2198,6 +2208,7 @@ int main(int argc, char *argv[])
 		{&quot;verbose&quot;, 0, 0, 'v'},
 		{&quot;debug&quot;, 0, 0, 'd'},
 		{&quot;define&quot;, 1, 0, 'D'},
+		{&quot;systemd-service&quot;, 0, 0, 'S'},
 		{&quot;foreground&quot;, 0, 0, 'f'},
 		{&quot;random-multimount-selection&quot;, 0, 0, 'r'},
 		{&quot;negative-timeout&quot;, 1, 0, 'n'},
@@ -2266,6 +2277,10 @@ int main(int argc, char *argv[])
 			macro_parse_globalvar(optarg);
 			break;
 
+		case 'S':
+			flags |= DAEMON_FLAGS_SYSTEMD_SERVICE;
+			break;
+
 		case 'f':
 			flags |= DAEMON_FLAGS_FOREGROUND;
 			break;
@@ -2653,7 +2668,8 @@ int main(int argc, char *argv[])
 	}
 
 #ifdef WITH_SYSTEMD
-	sd_notify(1, &quot;READY=1&quot;);
+	if (flags &amp; DAEMON_FLAGS_SYSTEMD_SERVICE)
+		sd_notify(1, &quot;READY=1&quot;);
 #endif
 
 	state_mach_thid = pthread_self();
diff --git a/include/automount.h b/include/automount.h
index 848fd0be..45fde53e 100644
--- a/include/automount.h
+++ b/include/automount.h
@@ -67,6 +67,7 @@
 #endif
 
 #define DAEMON_FLAGS_FOREGROUND			0x0001
+#define DAEMON_FLAGS_SYSTEMD_SERVICE		0x0002
 #define DAEMON_FLAGS_HAVE_GLOBAL_OPTIONS	0x0004
 #define DAEMON_FLAGS_GHOST			0x0008
 #define DAEMON_FLAGS_CHECK_DAEMON		0x0010
diff --git a/man/automount.8 b/man/automount.8
index 68d2aaa3..9f92288e 100644
--- a/man/automount.8
+++ b/man/automount.8
@@ -57,6 +57,10 @@ Define a global macro substitution variable. Global definitions
 are over-ridden macro definitions of the same name specified in
 mount entries.
 .TP
+.I \-S, \-\-systemd-service
+Used when running the automounter as a systemd service to ensure log entry
+format is consistent with the log entry format when running as a daemon.
+.TP
 .I &quot;\-f, \-\-foreground&quot;
 Run the daemon in the foreground and log to stderr instead of syslog.&quot;
 .TP
diff --git a/samples/autofs.service.in b/samples/autofs.service.in
index 281d31ef..175a806d 100644
--- a/samples/autofs.service.in
+++ b/samples/autofs.service.in
@@ -6,7 +6,7 @@ Wants=network-online.target rpc-statd.service rpcbind.service
 [Service]
 Type=notify
 EnvironmentFile=-@@autofsconfdir@@/autofs
-ExecStart=@@sbindir@@/automount $OPTIONS --foreground --dont-check-daemon
+ExecStart=@@sbindir@@/automount $OPTIONS --systemd-service --dont-check-daemon
 ExecReload=/usr/bin/kill -HUP $MAINPID
 KillMode=process
 TimeoutSec=180



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="01980" href="msg01980.html">[PATCH 00/22] Current patch queue</a></strong>
<ul><li><em>From:</em> Ian Kent</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg01974.html">[PATCH 17/22] autofs-5.1.4 - move close stdio descriptors to become_daemon()</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg01976.html">[PATCH 19/22] autofs-5.1.4 - refactor negative map entry check</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg01974.html">[PATCH 17/22] autofs-5.1.4 - move close stdio descriptors to become_daemon()</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg01976.html">[PATCH 19/22] autofs-5.1.4 - refactor negative map entry check</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#01975"><strong>Date</strong></a></li>
<li><a href="index.html#01975"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-fsdevel/>[Linux&nbsp;Filesystem&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-ext4/>[Linux&nbsp;Ext4]</a>
&nbsp;
&nbsp;
<a href=/lists/arm-kernel/>[Linux&nbsp;ARM&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/arm/>[Linux&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;Omap]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-arm/>[Fedora&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/ietf-ann/>[IETF&nbsp;Annouce]</a>
&nbsp;
&nbsp;
<a href=/lists/security/>[Security]</a>
&nbsp;
&nbsp;
<a href=/lists/bugtraq/>[Bugtraq]</a>
&nbsp;
&nbsp;
<a href=/linux/>[Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;OMAP]</a>
&nbsp;
&nbsp;
<a href=/lists/mips/>[Linux&nbsp;MIPS]</a>
&nbsp;
&nbsp;
<a href=/lists/ecos/>[ECOS]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;Internet&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-api/>[Linux&nbsp;API]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

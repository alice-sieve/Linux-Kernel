<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH] autofs4: Use wait_event_killable -->
<!--X-From-R13: Wna Yrag &#60;eniraNgurznj.arg> -->
<!--X-Date: Mon, 19 Mar 2018 19:53:15 &#45;0700 -->
<!--X-Message-Id: daecdffe&#45;b768&#45;9c69&#45;8609&#45;b899ddde720c@themaw.net -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20180319191609.23880&#45;1&#45;willy@infradead.org -->
<!--X-Reference: alpine.DEB.2.20.1803191218210.114201@chino.kir.corp.google.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re: [PATCH] autofs4: Use wait_event_killable &mdash; Linux AutoFS">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH] autofs4: Use wait_event_killable &mdash; Linux AutoFS</title>
<link rel="alternate" type="application/rss+xml" title="Linux AutoFS" href="//feeds.feedburner.com/autofs">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com/cse" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:isdiegq275o" />
    <input type="hidden" name="ie" value="ISO-8859-1" />
    <input type="text" name="q" size="37" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH] autofs4: Use wait_event_killable</h1>
[<a href="msg01872.html">Date Prev</a>][<a href="msg01874.html">Date Next</a>][<a href="msg01871.html">Thread Prev</a>][<a href="msg01872.html">Thread Next</a>][<a href="maillist.html#01873">Date Index</a>][<a href="index.html#01873">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: David Rientjes &lt;rientjes@xxxxxxxxxx&gt;,        Matthew Wilcox &lt;willy@xxxxxxxxxxxxx&gt;</li>
<li><em>Subject</em>: Re: [PATCH] autofs4: Use wait_event_killable</li>
<li><em>From</em>: Ian Kent &lt;raven@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 20 Mar 2018 10:42:34 +0800</li>
<li><em>Cc</em>: autofs@xxxxxxxxxxxxxxx, linux-fsdevel@xxxxxxxxxxxxxxx,        linux-kernel@xxxxxxxxxxxxxxx, Matthew Wilcox &lt;mawilcox@xxxxxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg01870.html">alpine.DEB.2.20.1803191218210.114201@chino.kir.corp.google.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg01869.html">20180319191609.23880-1-willy@infradead.org</a>&gt; &lt;<a href="msg01870.html">alpine.DEB.2.20.1803191218210.114201@chino.kir.corp.google.com</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Thunderbird/52.6.0</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On 20/03/18 03:25, David Rientjes wrote:
&gt; On Mon, 19 Mar 2018, Matthew Wilcox wrote:
&gt; 
&gt;&gt; diff --git a/fs/autofs4/waitq.c b/fs/autofs4/waitq.c
&gt;&gt; index a0c57c37fa21..c160e9b3aa0f 100644
&gt;&gt; --- a/fs/autofs4/waitq.c
&gt;&gt; +++ b/fs/autofs4/waitq.c
&gt;&gt; @@ -19,9 +19,6 @@
&gt;&gt;   */
&gt;&gt;  static autofs_wqt_t autofs4_next_wait_queue = 1;
&gt;&gt;  
&gt;&gt; -/* These are the signals we allow interrupting a pending mount */
&gt;&gt; -#define SHUTDOWN_SIGS	(sigmask(SIGKILL) | sigmask(SIGINT) | sigmask(SIGQUIT))
&gt;&gt; -
&gt;&gt;  void autofs4_catatonic_mode(struct autofs_sb_info *sbi)
&gt;&gt;  {
&gt;&gt;  	struct autofs_wait_queue *wq, *nwq;
&gt;&gt; @@ -486,29 +483,7 @@ int autofs4_wait(struct autofs_sb_info *sbi,
&gt;&gt;  	 * wq-&gt;name.name is NULL iff the lock is already released
&gt;&gt;  	 * or the mount has been made catatonic.
&gt;&gt;  	 */
&gt;&gt; -	if (wq-&gt;name.name) {
&gt;&gt; -		/* Block all but &quot;shutdown&quot; signals while waiting */
&gt;&gt; -		unsigned long shutdown_sigs_mask;
&gt;&gt; -		unsigned long irqflags;
&gt;&gt; -		sigset_t oldset;
&gt;&gt; -
&gt;&gt; -		spin_lock_irqsave(&amp;current-&gt;sighand-&gt;siglock, irqflags);
&gt;&gt; -		oldset = current-&gt;blocked;
&gt;&gt; -		shutdown_sigs_mask = SHUTDOWN_SIGS &amp; ~oldset.sig[0];
&gt;&gt; -		siginitsetinv(&amp;current-&gt;blocked, shutdown_sigs_mask);
&gt;&gt; -		recalc_sigpending();
&gt;&gt; -		spin_unlock_irqrestore(&amp;current-&gt;sighand-&gt;siglock, irqflags);
&gt;&gt; -
&gt;&gt; -		wait_event_interruptible(wq-&gt;queue, wq-&gt;name.name == NULL);
&gt;&gt; -
&gt;&gt; -		spin_lock_irqsave(&amp;current-&gt;sighand-&gt;siglock, irqflags);
&gt;&gt; -		current-&gt;blocked = oldset;
&gt;&gt; -		recalc_sigpending();
&gt;&gt; -		spin_unlock_irqrestore(&amp;current-&gt;sighand-&gt;siglock, irqflags);
&gt;&gt; -	} else {
&gt;&gt; -		pr_debug(&quot;skipped sleeping\n&quot;);
&gt;&gt; -	}
&gt;&gt; -
&gt;&gt; +	wait_event_killable(wq-&gt;queue, wq-&gt;name.name == NULL);
&gt;&gt;  	status = wq-&gt;status;
&gt;&gt;  
&gt;&gt;  	/*
&gt; 
&gt; I understand converting the wait_event_interruptible() to 
&gt; wait_event_killable(), but why was the above wait_event_interruptible() 
&gt; only called when wq-&gt;name.name != NULL?  

The code pre-dates my involvement in autofs too.

I always thought it was because wq-&gt;name.name can become NULL before
the wait is reached. Such as if the user space daemon manages to invoke
autofs4_wait_release() before the wait call.

And if the autofs mount is made catatonic before the wait is reached
wq-&gt;name.name will be set to NULL and wake up called for each waiter
so that doesn't seem to require the if conditional either.

Both of these cases to fit with what Matthew has already said and I
can't think of any others.

There may have been other reasons at some point, a lot has changed
over (a long) time.

Ian
--
To unsubscribe from this list: send the line &quot;unsubscribe autofs&quot; in


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="01869" href="msg01869.html">[PATCH] autofs4: Use wait_event_killable</a></strong>
<ul><li><em>From:</em> Matthew Wilcox</li></ul></li>
<li><strong><a name="01870" href="msg01870.html">Re: [PATCH] autofs4: Use wait_event_killable</a></strong>
<ul><li><em>From:</em> David Rientjes</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg01872.html">Re: [PATCH] autofs4: Use wait_event_killable</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg01874.html">Re: [PATCH] autofs4: Use wait_event_killable</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg01871.html">Re: [PATCH] autofs4: Use wait_event_killable</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg01872.html">Re: [PATCH] autofs4: Use wait_event_killable</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#01873"><strong>Date</strong></a></li>
<li><a href="index.html#01873"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-fsdevel/>[Linux&nbsp;Filesystem&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-ext4/>[Linux&nbsp;Ext4]</a>
&nbsp;
&nbsp;
<a href=/lists/arm-kernel/>[Linux&nbsp;ARM&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/arm/>[Linux&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;Omap]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-arm/>[Fedora&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/ietf-ann/>[IETF&nbsp;Annouce]</a>
&nbsp;
&nbsp;
<a href=/lists/security/>[Security]</a>
&nbsp;
&nbsp;
<a href=/lists/bugtraq/>[Bugtraq]</a>
&nbsp;
&nbsp;
<a href=/linux/>[Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;OMAP]</a>
&nbsp;
&nbsp;
<a href=/lists/mips/>[Linux&nbsp;MIPS]</a>
&nbsp;
&nbsp;
<a href=/lists/ecos/>[ECOS]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;Internet&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-api/>[Linux&nbsp;API]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

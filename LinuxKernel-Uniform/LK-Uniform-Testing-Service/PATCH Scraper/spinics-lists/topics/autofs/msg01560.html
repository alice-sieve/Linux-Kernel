<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH 07/34] autofs&#45;5.1.2 &#45; make set_direct_mount_catatonic() more general -->
<!--X-From-R13: Wna Yrag &#60;eniraNgurznj.arg> -->
<!--X-Date: Sun, 23 Apr 2017 18:06:06 &#45;0700 -->
<!--X-Message-Id: 149299564929.23475.1779708203895937564.stgit@pluto.themaw.net -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 149299547753.23475.9924538846721477415.stgit@pluto.themaw.net -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="[PATCH 07/34] autofs-5.1.2 - make set_direct_mount_catatonic() more general &mdash; Linux AutoFS">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[PATCH 07/34] autofs-5.1.2 - make set_direct_mount_catatonic() more general &mdash; Linux AutoFS</title>
<link rel="alternate" type="application/rss+xml" title="Linux AutoFS" href="//feeds.feedburner.com/autofs">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com/cse" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:isdiegq275o" />
    <input type="hidden" name="ie" value="ISO-8859-1" />
    <input type="text" name="q" size="37" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH 07/34] autofs-5.1.2 - make set_direct_mount_catatonic() more general</h1>
[<a href="msg01553.html">Date Prev</a>][<a href="msg01554.html">Date Next</a>][<a href="msg01552.html">Thread Prev</a>][<a href="msg01554.html">Thread Next</a>][<a href="maillist.html#01560">Date Index</a>][<a href="index.html#01560">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: autofs mailing list &lt;autofs@xxxxxxxxxxxxxxx&gt;</li>
<li><em>Subject</em>: [PATCH 07/34] autofs-5.1.2 - make set_direct_mount_catatonic() more general</li>
<li><em>From</em>: Ian Kent &lt;raven@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Mon, 24 Apr 2017 09:00:49 +0800</li>
<li><em>In-reply-to</em>: &lt;<a href="msg01553.html">149299547753.23475.9924538846721477415.stgit@pluto.themaw.net</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg01553.html">149299547753.23475.9924538846721477415.stgit@pluto.themaw.net</a>&gt;</li>
<li><em>User-agent</em>: StGit/0.17.1-dirty</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Setting direct mounts catatonic at exit doesn't go far enough.

To avoid possible hang on access of automount managed paths when
the daemon has exited all mounted autofs file systems must be set
catatonic when the daemon exits.

Start by making set_direct_mount_catatonic() able to handle the
different types of autofs mounts and move it to the mounts function
library.
---
 CHANGELOG        |    1 +
 daemon/direct.c  |   69 ++++--------------------------------------------------
 include/mounts.h |    1 +
 lib/mounts.c     |   64 ++++++++++++++++++++++++++++++++++++++++++++++++++
 4 files changed, 71 insertions(+), 64 deletions(-)

diff --git a/CHANGELOG b/CHANGELOG
index c43ebc9..8b7de5f 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -33,6 +33,7 @@ xx/xx/2016 autofs-5.1.3
 - don't return until after master map retry read.
 - make lookup_nss_read_master() return nss status.
 - check NFS server availability on local mount fallback.
+- make set_direct_mount_catatonic() more general.
 
 15/06/2016 autofs-5.1.2
 =======================
diff --git a/daemon/direct.c b/daemon/direct.c
index 3cce0db..81f6e67 100644
--- a/daemon/direct.c
+++ b/daemon/direct.c
@@ -82,65 +82,6 @@ static void mnts_cleanup(void *arg)
 	return;
 }
 
-/* When exiting direct mount triggers must be set catatonic, regardless
- * of whether they are busy on not, to avoid a hang on access once the
- * daemon has gone away.
- */
-static int set_direct_mount_catatonic(struct autofs_point *ap, struct mapent *me, int ioctlfd)
-{
-	struct ioctl_ops *ops = get_ioctl_ops();
-	unsigned int opened = 0;
-	char buf[MAX_ERR_BUF];
-	int fd = -1;
-	int error;
-
-	/* In case the miscellaneous device isn't being used try
-	 * and use an existing ioctl control fd. In this case if
-	 * we don't already have an ioctl fd the mount can't be
-	 * set catatonic if it's covered.
-	 */
-	if (ioctlfd &gt;= 0)
-		fd = ioctlfd;
-	else if (me-&gt;ioctlfd &gt;= 0)
-		fd = me-&gt;ioctlfd;
-	else {
-		error = ops-&gt;open(ap-&gt;logopt, &amp;fd, me-&gt;dev, me-&gt;key);
-		if (error == -1) {
-			int err = errno;
-			char *estr;
-
-			estr = strerror_r(errno, buf, MAX_ERR_BUF);
-			error(ap-&gt;logopt,
-			      &quot;failed to open ioctlfd for %s, error: %s&quot;,
-			      me-&gt;key, estr);
-			return err;
-		}
-		opened = 1;
-	}
-
-	if (fd &gt;= 0) {
-		error = ops-&gt;catatonic(ap-&gt;logopt, fd);
-		if (error == -1) {
-			int err = errno;
-			char *estr;
-
-			estr = strerror_r(errno, buf, MAX_ERR_BUF);
-			error(ap-&gt;logopt,
-			      &quot;failed to set %s catatonic, error: %s&quot;,
-			      me-&gt;key, estr);
-			if (opened)
-				ops-&gt;close(ap-&gt;logopt, fd);
-			return err;
-		}
-		if (opened)
-			ops-&gt;close(ap-&gt;logopt, fd);
-	}
-
-	debug(ap-&gt;logopt, &quot;set %s catatonic&quot;, me-&gt;key);
-
-	return 0;
-}
-
 int do_umount_autofs_direct(struct autofs_point *ap, struct mnt_list *mnts, struct mapent *me)
 {
 	struct ioctl_ops *ops = get_ioctl_ops();
@@ -190,19 +131,19 @@ int do_umount_autofs_direct(struct autofs_point *ap, struct mnt_list *mnts, stru
 				      &quot;ask umount returned busy for %s&quot;,
 				      me-&gt;key);
 				if (ap-&gt;state != ST_READMAP)
-					set_direct_mount_catatonic(ap, me, ioctlfd);
+					set_mount_catatonic(ap, me, ioctlfd);
 				if (opened)
 					ops-&gt;close(ap-&gt;logopt, ioctlfd);
 				return 1;
 			} else {
 				me-&gt;ioctlfd = -1;
-				set_direct_mount_catatonic(ap, me, ioctlfd);
+				set_mount_catatonic(ap, me, ioctlfd);
 				ops-&gt;close(ap-&gt;logopt, ioctlfd);
 				goto force_umount;
 			}
 		}
 		me-&gt;ioctlfd = -1;
-		set_direct_mount_catatonic(ap, me, ioctlfd);
+		set_mount_catatonic(ap, me, ioctlfd);
 		ops-&gt;close(ap-&gt;logopt, ioctlfd);
 	} else {
 		error(ap-&gt;logopt,
@@ -297,12 +238,12 @@ int umount_autofs_direct(struct autofs_point *ap)
 			if (!error)
 				goto done;
 
-			error = set_direct_mount_catatonic(ap, me, me-&gt;ioctlfd);
+			error = set_mount_catatonic(ap, me, me-&gt;ioctlfd);
 			if (!error)
 				goto done;
 
 			/* We really need to set this, last ditch attempt */
-			set_direct_mount_catatonic(ap, me, -1);
+			set_mount_catatonic(ap, me, -1);
 done:
 			me = cache_enumerate(mc, me);
 		}
diff --git a/include/mounts.h b/include/mounts.h
index 489025c..9ec6bd9 100644
--- a/include/mounts.h
+++ b/include/mounts.h
@@ -113,6 +113,7 @@ void set_tsd_user_vars(unsigned int, uid_t, gid_t);
 const char *mount_type_str(unsigned int);
 void notify_mount_result(struct autofs_point *, const char *, time_t, const char *);
 int try_remount(struct autofs_point *, struct mapent *, unsigned int);
+int set_mount_catatonic(struct autofs_point *, struct mapent *, int);
 int umount_ent(struct autofs_point *, const char *);
 int mount_multi_triggers(struct autofs_point *, struct mapent *, const char *, unsigned int, const char *);
 int umount_multi_triggers(struct autofs_point *, struct mapent *, char *, const char *);
diff --git a/lib/mounts.c b/lib/mounts.c
index d3d7345..44c907e 100644
--- a/lib/mounts.c
+++ b/lib/mounts.c
@@ -1855,6 +1855,70 @@ int try_remount(struct autofs_point *ap, struct mapent *me, unsigned int type)
 	return 0;
 }
 
+/*
+ * When exiting mounts need be set catatonic, regardless of whether they
+ * are busy on not, to avoid a hang on access once the daemon has gone
+ * away.
+ */
+int set_mount_catatonic(struct autofs_point *ap, struct mapent *me, int ioctlfd)
+{
+	struct ioctl_ops *ops = get_ioctl_ops();
+	unsigned int opened = 0;
+	char buf[MAX_ERR_BUF];
+	char *path;
+	int fd = -1;
+	int error;
+	dev_t dev;
+
+	path = ap-&gt;path;
+	dev = ap-&gt;dev;
+	if (me &amp;&amp; (ap-&gt;type == LKP_DIRECT || *me-&gt;key == '/')) {
+		path = me-&gt;key;
+		dev = me-&gt;dev;
+	}
+
+	if (ioctlfd &gt;= 0)
+		fd = ioctlfd;
+	else if (me &amp;&amp; me-&gt;ioctlfd &gt;= 0)
+		fd = me-&gt;ioctlfd;
+	else {
+		error = ops-&gt;open(ap-&gt;logopt, &amp;fd, dev, path);
+		if (error == -1) {
+			int err = errno;
+			char *estr;
+
+			estr = strerror_r(errno, buf, MAX_ERR_BUF);
+			error(ap-&gt;logopt,
+			      &quot;failed to open ioctlfd for %s, error: %s&quot;,
+			      path, estr);
+			return err;
+		}
+		opened = 1;
+	}
+
+	if (fd &gt;= 0) {
+		error = ops-&gt;catatonic(ap-&gt;logopt, fd);
+		if (error == -1) {
+			int err = errno;
+			char *estr;
+
+			estr = strerror_r(errno, buf, MAX_ERR_BUF);
+			error(ap-&gt;logopt,
+			      &quot;failed to set %s catatonic, error: %s&quot;,
+			      path, estr);
+			if (opened)
+				ops-&gt;close(ap-&gt;logopt, fd);
+			return err;
+		}
+		if (opened)
+			ops-&gt;close(ap-&gt;logopt, fd);
+	}
+
+	debug(ap-&gt;logopt, &quot;set %s catatonic&quot;, path);
+
+	return 0;
+}
+
 int umount_ent(struct autofs_point *ap, const char *path)
 {
 	int rv;

--
To unsubscribe from this list: send the line &quot;unsubscribe autofs&quot; in


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="01553" href="msg01553.html">[PATCH 00/34] fyi ... current patch list</a></strong>
<ul><li><em>From:</em> Ian Kent</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg01553.html">[PATCH 00/34] fyi ... current patch list</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg01554.html">[PATCH 08/34] autofs-5.1.2 - set autofs mounts catatonic at exit</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg01552.html">[PATCH 09/34] autofs-5.1.2 - honor last rw in mount options when doing a bind mount</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg01554.html">[PATCH 08/34] autofs-5.1.2 - set autofs mounts catatonic at exit</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#01560"><strong>Date</strong></a></li>
<li><a href="index.html#01560"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-fsdevel/>[Linux&nbsp;Filesystem&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-ext4/>[Linux&nbsp;Ext4]</a>
&nbsp;
&nbsp;
<a href=/lists/arm-kernel/>[Linux&nbsp;ARM&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/arm/>[Linux&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;Omap]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-arm/>[Fedora&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/ietf-ann/>[IETF&nbsp;Annouce]</a>
&nbsp;
&nbsp;
<a href=/lists/security/>[Security]</a>
&nbsp;
&nbsp;
<a href=/lists/bugtraq/>[Bugtraq]</a>
&nbsp;
&nbsp;
<a href=/linux/>[Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;OMAP]</a>
&nbsp;
&nbsp;
<a href=/lists/mips/>[Linux&nbsp;MIPS]</a>
&nbsp;
&nbsp;
<a href=/lists/ecos/>[ECOS]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;Internet&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-api/>[Linux&nbsp;API]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

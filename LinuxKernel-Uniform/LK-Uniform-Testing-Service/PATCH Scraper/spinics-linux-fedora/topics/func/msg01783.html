<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH] utils: Avoid returning loopback address from	get_hostname_by_route -->
<!--X-From-R13: Rnivq Ineq &#60;qnivq.jneqNyy.zvg.rqh> -->
<!--X-Date: Sun, 6 Mar 2011 13:57:41 &#45;0800 -->
<!--X-Message-Id: 1299448504&#45;2347&#45;1&#45;git&#45;send&#45;email&#45;david.ward@ll.mit.edu -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Fedora Universal Network Connector, [PATCH] utils: Avoid returning loopback address from	get_hostname_by_route">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Fedora Universal Network Connector &mdash; [PATCH] utils: Avoid returning loopback address from	get_hostname_by_route</title>
<link rel="alternate" type="application/rss+xml" title="Fedora Universal Network Connector" href="//feeds.feedburner.com/FedoraUniversalNetworkConnector">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH] utils: Avoid returning loopback address from	get_hostname_by_route</h1>
[<a href="msg01782.html">Date Prev</a>][<a href="msg01784.html">Date Next</a>][<a href="msg01779.html">Thread Prev</a>][<a href="msg01798.html">Thread Next</a>][<a href="maillist.html#01783">Date Index</a>][<a href="index.html#01783">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH] utils: Avoid returning loopback address from	get_hostname_by_route</li>
<li><em>From</em>: David Ward &lt;<a href="mailto:david.ward@DOMAIN.HIDDEN">david.ward@xxxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Sun, 6 Mar 2011 16:55:04 -0500</li>
<li><em>Cc</em>: David Ward &lt;<a href="mailto:david.ward@DOMAIN.HIDDEN">david.ward@xxxxxxxxxx</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Until recently, NetworkManager modified /etc/hosts and added the (real)
hostname as an alias to the loopback address 127.0.0.1, and also as an
alias to the IP address of the interface(s) it managed. In this situation,
func actually detected the hostname as &quot;127.0.0.1&quot;, which was then used by
certmaster as the key name in the certificate. Even though the current
NetworkManager does not touch /etc/hosts, func should be able to handle
this case. This change includes the needed fixes to get_hostname_by_route.

Other code in this function has been edited to improve clarity.

Signed-off-by: David Ward &lt;david.ward@xxxxxxxxxx&gt;
---
 func/utils.py |   45 +++++++++++++++------------------------------
 1 files changed, 15 insertions(+), 30 deletions(-)

diff --git a/func/utils.py b/func/utils.py
index fd456c1..41a75d8 100644
--- a/func/utils.py
+++ b/func/utils.py
@@ -80,8 +80,6 @@ def get_hostname_by_route():
     &quot;&quot;&quot;
     # FIXME: this code ignores http proxies (which granted, we don't
     #      support elsewhere either.
-    hostname = None
-    ip = None
 
     minion_config_file = '/etc/func/minion.conf'
     minion_config = read_config(minion_config_file, FuncdConfig)
@@ -98,50 +96,37 @@ def get_hostname_by_route():
     server = cm_config.certmaster
     port = cm_config.certmaster_port
 
+    s = socket.socket()
+    s.settimeout(5)
+    s.connect_ex((server, port))
+    (intf, port) = s.getsockname()
+    s.close()
+
     try:
-        s = socket.socket()
-        s.settimeout(5)
-        s.connect((server, port))
-        (intf, port) = s.getsockname()
-         # this can fail if there is no reverse DNS available
-        intf_hostname = socket.gethostbyaddr(intf)[0]
-        ip = socket.gethostbyname(intf_hostname)
-        # not talking via localhost? good enough...
-        if ip != '127.0.0.1':
-            s.close()
-            return intf_hostname.lower()
+        return socket.gethostbyaddr(intf)[0]
     except:
-        s.close()
-        # something failed, reverse dns, etc
+        pass
 
     # try to find the hostname of the ip we're listening on
     if minion_config.listen_addr:
         try:
-            (hostname, aliases, ips) = socket.gethostbyaddr(minion_config.listen_addr)
+            return socket.gethostbyaddr(minion_config.listen_addr)[0]
         except:
-            hostname = None
+            pass
 
     # in an ideal world, this would return exactly what we want: the most meaningful hostname
     # for a system, but that is often not that case
-    if hostname is None:
-        hostname = socket.gethostname()
-
-    # &quot;localhost&quot; is a really crappy hostname, so is pretty much anything attached
-    # to 127.0.0.1, so try for something better
     try:
+        hostname = socket.gethostname()
         ip = socket.gethostbyname(hostname)
+        if ip != &quot;127.0.0.1&quot; and ip != &quot;::1&quot;:
+            return hostname.lower()
     except:
-        hostname = None
-
-    # non loopback is about as good as we can do for a guess
-    if ip != &quot;127.0.0.1&quot; and hostname is not None:
-        return hostname.lower()
-
-
+        pass
 
     # all else has failed to get a good hostname, so just return
     # an ip address
-    return socket.gethostbyname(socket.gethostname()).lower() # yes I know it's an ip but I don't trust anything
+    return intf
 
 def find_files_by_hostname(hostglob, filepath, fileext=''):
     &quot;&quot;&quot;look for files in the given filepath with the given extension that
-- 
1.7.4

_______________________________________________
Func-list mailing list
Func-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/func-list">https://www.redhat.com/mailman/listinfo/func-list</a>

</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg01782.html">Re:  [PATCH] CPU module,	fixes to disk module and service module</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg01784.html">Re:  [PATCH] CPU module,	fixes to disk module and service module</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg01779.html">func on rhel/centos4 going forward</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg01798.html">Re:  [PATCH] utils: Avoid returning loopback address from get_hostname_by_route</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#01783"><strong>Date</strong></a></li>
<li><a href="index.html#01783"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/netdev/>[Linux&nbsp;Networking]</a>
&nbsp;
&nbsp;
<a href=/lists/fll/>[Fedora&nbsp;Legacy&nbsp;List]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z//biglist.html>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: PATCH: Add x509Extensions to cacert and slave certs -->
<!--X-From-R13: Oy Fborl &#60;gboregNtznvy.pbz> -->
<!--X-Date: Fri, 25 Mar 2011 14:56:11 &#45;0700 -->
<!--X-Message-Id: AANLkTinN2nwtmy0tzS6cui&#45;Y=+GGqNmGmmCaNZaNtsaS@mail.gmail.com -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Fedora Universal Network Connector, PATCH: Add x509Extensions to cacert and slave certs">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Fedora Universal Network Connector &mdash; PATCH: Add x509Extensions to cacert and slave certs</title>
<link rel="alternate" type="application/rss+xml" title="Fedora Universal Network Connector" href="//feeds.feedburner.com/FedoraUniversalNetworkConnector">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">PATCH: Add x509Extensions to cacert and slave certs</h1>
[<a href="msg01818.html">Date Prev</a>][<a href="msg01820.html">Date Next</a>][<a href="msg01810.html">Thread Prev</a>][<a href="msg01820.html">Thread Next</a>][<a href="maillist.html#01819">Date Index</a>][<a href="index.html#01819">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: PATCH: Add x509Extensions to cacert and slave certs</li>
<li><em>From</em>: Al Tobey &lt;<a href="mailto:tobert@DOMAIN.HIDDEN">tobert@xxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Fri, 25 Mar 2011 14:54:03 -0700</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<div><a rel="nofollow" href="https://github.com/tobert/certmaster/commit/21b55436bc7e9f154c637a4213266e67aa0b6577">https://github.com/tobert/certmaster/commit/21b55436bc7e9f154c637a4213266e67aa0b6577</a></div><div><br></div><div>This patch adds x509 extensions for dnsName and nsComment to certmaster. I&#39;ve only done light testing at this point, but it seems to work on my Fedora 14 machine. The try/catch should allow things to keep working on older distros with broken x509Extension support in pyOpenSSL. I&#39;ll be testing on CentOS 5.3 soon, since that&#39;s my target platform.</div>
<div><br></div><div>My goal is to get full mutual authentication working with rsyslog 4.2.2 TLS (4.2.2 is shipped with EL6).</div><div><br></div><div>From&#xC2;openssl x509 -in /etc/pki/certmaster/xxxxxx.cert -text</div><div>&#xC2; &#xC2; &#xC2; &#xC2; X509v3 extensions:</div>
<div><div>&#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; X509v3 Basic Constraints: critical</div><div>&#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; CA:FALSE</div><div>&#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; Netscape Comment:&#xC2;</div><div>&#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; Created by certmaster.</div><div>&#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; X509v3 Subject Alternative Name:&#xC2;</div>
<div>&#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; DNS:xxxxxx</div></div><div><br></div><div>And&#xC2;openssl x509 -in /etc/pki/certmaster/ca.cert -text</div><div>&#xC2; &#xC2; &#xC2; &#xC2; X509v3 extensions:</div><div><div>&#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; X509v3 Basic Constraints: critical</div>
<div>&#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; CA:TRUE</div><div>&#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; Netscape Comment:&#xC2;</div><div>&#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; Created by certmaster.</div><div>&#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; X509v3 Subject Alternative Name:&#xC2;</div><div>&#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; &#xC2; DNS:xxxxxx</div></div>
<div><br></div><div>Thanks,</div><div>-Al Tobey</div><div><br></div><div><div>commit 21b55436bc7e9f154c637a4213266e67aa0b6577</div><div>Author: Al Tobey &lt;<a rel="nofollow" href="mailto:tobert@xxxxxxxxx">tobert@xxxxxxxxx</a>&gt;</div>
<div>Date: &#xC2; Fri Mar 25 14:14:57 2011 -0700</div><div><br></div><div>&#xC2; &#xC2; Add x509 extensions for dnsName and nsComment.</div><div>&#xC2; &#xC2;&#xC2;</div><div>&#xC2; &#xC2; Many utilities that could use certmaster certs follow rules laid</div><div>
&#xC2; &#xC2; out in RFC3280. At the moment I&#39;m working on integrating rsyslog</div><div>&#xC2; &#xC2; TLS with mutual authentication. Certmaster certs currently only</div><div>&#xC2; &#xC2; work in &quot;anon&quot; mode where encryption is achieved, but no</div>
<div>&#xC2; &#xC2; authentication is performed.</div><div>&#xC2; &#xC2;&#xC2;</div><div>&#xC2; &#xC2; To that end, a function _build_extension_list() is implemented in</div><div>&#xC2; &#xC2; this patch that is now used by both create_ca() and</div><div>&#xC2; &#xC2; create_slave_certificate() that attempts to add the extensions to</div>
<div>&#xC2; &#xC2; the cert before signing.</div><div>&#xC2; &#xC2;&#xC2;</div><div>&#xC2; &#xC2; subjectKeyIdentifier will be explored in a subsequent patch.</div><div>&#xC2; &#xC2;&#xC2;</div></div><div><br></div>
<pre>From 21b55436bc7e9f154c637a4213266e67aa0b6577 Mon Sep 17 00:00:00 2001
From: Al Tobey &lt;tobert@xxxxxxxxx&gt;
Date: Fri, 25 Mar 2011 14:14:57 -0700
Subject: [PATCH] Add x509 extensions for dnsName and nsComment.

Many utilities that could use certmaster certs follow rules laid
out in RFC3280. At the moment I'm working on integrating rsyslog
TLS with mutual authentication. Certmaster certs currently only
work in &quot;anon&quot; mode where encryption is achieved, but no
authentication is performed.

To that end, a function _build_extension_list() is implemented in
this patch that is now used by both create_ca() and
create_slave_certificate() that attempts to add the extensions to
the cert before signing.

subjectKeyIdentifier will be explored in a subsequent patch.

Signed-off-by: Al Tobey &lt;tobert@xxxxxxxxx&gt;
---
 certmaster/certmaster.py |    2 +-
 certmaster/certs.py      |   34 +++++++++++++++++++++++++---------
 2 files changed, 26 insertions(+), 10 deletions(-)

diff --git a/certmaster/certmaster.py b/certmaster/certmaster.py
index 7b133df..2171ef8 100644
--- a/certmaster/certmaster.py
+++ b/certmaster/certmaster.py
@@ -72,7 +72,7 @@ class CertMaster(object):
             if not os.path.exists(self.cfg.cadir):
                 os.makedirs(self.cfg.cadir)
             if not os.path.exists(self.ca_key_file) and not os.path.exists(self.ca_cert_file):
-                certs.create_ca(CN=mycn, ca_key_file=self.ca_key_file, ca_cert_file=self.ca_cert_file)
+                certs.create_ca(CN=mycn, ca_key_file=self.ca_key_file, ca_cert_file=self.ca_cert_file, dnsname=usename)
         except (IOError, OSError), e:
             print 'Cannot make certmaster certificate authority keys/certs, aborting: %s' % e
             sys.exit(1)
diff --git a/certmaster/certs.py b/certmaster/certs.py
index d6f8b14..9e417ed 100644
--- a/certmaster/certs.py
+++ b/certmaster/certs.py
@@ -88,8 +88,30 @@ def retrieve_cert_from_file(certfile):
     cert = crypto.load_certificate(crypto.FILETYPE_PEM, buf)
     return cert
 
+def _build_extension_list(cert, dnsname=None, ca_enabled=False):
+    subject = cert.get_subject()
+    extensions = []
 
-def create_ca(CN=&quot;Certmaster Certificate Authority&quot;, ca_key_file=None, ca_cert_file=None):
+    if ca_enabled is True:
+        extensions.append(crypto.X509Extension('basicConstraints', 1,'CA:TRUE'))
+    else:
+        extensions.append(crypto.X509Extension('basicConstraints', 1,'CA:FALSE'))
+
+    if dnsname is None:
+        dnsname = subject.CN
+
+    # modeled after StoneVPN/app.py
+    try:
+        extensions.append(crypto.X509Extension('nsComment', 0, &quot;Created by certmaster.&quot;))
+        # set dnsName to commonName, which certmaster sets to the hostname
+        extensions.append(crypto.X509Extension('subjectAltName', 0, &quot;DNS:%s&quot; % dnsname))
+        # FIXME - add subjectkeyidentifier and authoritykeyidentifier extensions, too)
+    except ValueError:
+        print &quot;Your version of pyOpenSSL does not support x509Extension properly. Try &gt;= 0.9.&quot;
+
+    return extensions
+
+def create_ca(CN=&quot;Certmaster Certificate Authority&quot;, ca_key_file=None, ca_cert_file=None, dnsname=None):
     cakey = make_keypair(dest=ca_key_file)
     careq = make_csr(cakey, cn=CN)
     cacert = crypto.X509()
@@ -100,16 +122,13 @@ def create_ca(CN=&quot;Certmaster Certificate Authority&quot;, ca_key_file=None, ca_cert_f
     cacert.set_subject(careq.get_subject())
     cacert.set_pubkey(careq.get_pubkey())
     cacert.set_version(2)
-    xt = crypto.X509Extension('basicConstraints',1,'CA:TRUE')
-    # FIXME - add subjectkeyidentifier and authoritykeyidentifier extensions, too)
-    cacert.add_extensions((xt,))
+    cacert.add_extensions(_build_extension_list(cert=cacert, dnsname=dnsname, ca_enabled=True))
     cacert.sign(cakey, 'sha1')
     if ca_cert_file:
         destfo = open(ca_cert_file, 'w')
         destfo.write(crypto.dump_certificate(crypto.FILETYPE_PEM, cacert))
         destfo.close()
 
-
 def _get_serial_number(cadir):
     serial = '%s/serial.txt' % cadir
     i = 1
@@ -132,7 +151,6 @@ def _set_serial_number(cadir, last):
     f.write(str(last) + '\n')
     f.close()
 
-
 def create_slave_certificate(csr, cakey, cacert, cadir, slave_cert_file=None):
     cert = crypto.X509()
     cert.set_serial_number(_get_serial_number(cadir))
@@ -142,9 +160,7 @@ def create_slave_certificate(csr, cakey, cacert, cadir, slave_cert_file=None):
     cert.set_subject(csr.get_subject())
     cert.set_pubkey(csr.get_pubkey())
     cert.set_version(2)
-    xt = crypto.X509Extension('basicConstraints', False ,'CA:FALSE')
-    # FIXME - add subjectkeyidentifier and authoritykeyidentifier extensions, too)
-    cert.add_extensions((xt,))
+    cert.add_extensions(_build_extension_list(cert=cert))
     cert.sign(cakey, 'sha1')
     if slave_cert_file:
         destfo = open(slave_cert_file, 'w')
-- 
1.7.4

</pre><pre>_______________________________________________
Func-list mailing list
Func-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/func-list">https://www.redhat.com/mailman/listinfo/func-list</a></pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg01818.html">Re:  func-0.27 EPEL 5</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg01820.html">Re:  PATCH: Add x509Extensions to cacert and slave certs</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg01810.html">func-0.27 EPEL 5</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg01820.html">Re:  PATCH: Add x509Extensions to cacert and slave certs</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#01819"><strong>Date</strong></a></li>
<li><a href="index.html#01819"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/netdev/>[Linux&nbsp;Networking]</a>
&nbsp;
&nbsp;
<a href=/lists/fll/>[Fedora&nbsp;Legacy&nbsp;List]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z//biglist.html>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

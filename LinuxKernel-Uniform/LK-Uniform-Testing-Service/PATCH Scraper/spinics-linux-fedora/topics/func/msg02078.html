<!-- MHonArc v2.6.19 -->
<!--X-Subject: PATCH (Re: Changes to copyfile functionality) -->
<!--X-From-R13: [nephf Znhre &#60;znephfynhreNalp.ee.pbz> -->
<!--X-Date: Mon, 3 Sep 2012 13:29:40 &#45;0700 -->
<!--X-Message-Id: 2974980.53ogoT3kWX@workstation -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: 6043053.tietnCiud8@workstation -->
<!--X-Reference: CADTr3M=3CqPQvYppLaPi=hWfwEqa6q2PSH5WKLmXPPUi07ZjMA@mail.gmail.com -->
<!--X-Reference: 1516049.GHgS9JY1gj@workstation -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Fedora Universal Network Connector, PATCH (Re: Changes to copyfile functionality)">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Fedora Universal Network Connector &mdash; PATCH (Re: Changes to copyfile functionality)</title>
<link rel="alternate" type="application/rss+xml" title="Fedora Universal Network Connector" href="//feeds.feedburner.com/FedoraUniversalNetworkConnector">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">PATCH (Re: Changes to copyfile functionality)</h1>
[<a href="msg02077.html">Date Prev</a>][<a href="msg02079.html">Date Next</a>][<a href="msg02069.html">Thread Prev</a>][<a href="msg02081.html">Thread Next</a>][<a href="maillist.html#02078">Date Index</a>][<a href="index.html#02078">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: PATCH (Re: Changes to copyfile functionality)</li>
<li><em>From</em>: Marcus Lauer &lt;<a href="mailto:marcuslauer@DOMAIN.HIDDEN">marcuslauer@xxxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Mon, 03 Sep 2012 16:29:28 -0400</li>
<li><em>Delivered-to</em>: <a href="mailto:func@DOMAIN.HIDDEN">func@xxxxxxxxxxxxxxxxxxxxxx</a></li>
<li><em>In-reply-to</em>: &lt;1516049.GHgS9JY1gj@workstation&gt;</li>
<li><em>References</em>: &lt;6043053.tietnCiud8@workstation&gt;	&lt;CADTr3M=3CqPQvYppLaPi=hWfwEqa6q2PSH5WKLmXPPUi07ZjMA@mail.gmail.com&gt;	&lt;1516049.GHgS9JY1gj@workstation&gt;</li>
<li><em>Reply-to</em>: Marcus Lauer &lt;<a href="mailto:marcuslauer@DOMAIN.HIDDEN">marcuslauer@xxxxxxxxxx</a>&gt;, <a href="mailto:func@DOMAIN.HIDDEN">func@xxxxxxxxxxxxxxxxxxxxxx</a></li>
<li><em>User-agent</em>: KMail/4.7.2 (Linux/3.1.10-1.16-desktop; KDE/4.7.2; x86_64; ; )</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>        Since part #1 of my three-part plan is proving troublesome I moved 
ahead on #2.

        Although part #3 of my original plan borrows some code from #1 it does 
not require #1.  If this patch is accepted then I will move ahead on #3.

        This patch changes copyfile in two ways:

1. Copyfile now opens a tempfile on the minion and appends data to this 
tempfile, then moves the tempfile over the target file after all of the data 
has been appended.

        The advantage of this is that updating the target file is atomic, or 
as close to it as possible in python.  This minimizes the chance of some 
program accessing an empty or half-complete file.  If the file in question 
were a server config file... surely you can imagine how this could be a 
problem.

        The tempfiles are created in the same directory as the target file 
(for security) and have the same name as the target file but with the 
extension &quot;.functmp&quot;.  Permissions are set on this file during the &quot;open&quot; 
stage, while it is still zero-size.

2. Copyfile has a new option called &quot;retainperms&quot; (&quot;--retainperms&quot; at the 
command line).  It is &quot;False&quot; by default.

        Currently func tries to give the new file on the minion the same 
attributes (permissions and uid/gid) as the file on the overlord.  The SELinux 
context of the new file is not set (and does not change).  This overrides this 
behavior to make the permissions, flags, uid, gid and SELinux contexts of the 
new file identical to the existing file (if any) on the minion.

        This is intended to deal with the situation in which the file on the 
overlord has different permissions than the files on the minions and the user 
does not want to overwrite them.  Perhaps the overlord computer does not have 
the same users and groups as the minions?  I figured this might be useful for 
someone.


        On a related note, does anyone think it would be worthwhile to have 
copyfile copy the SELinux contexts of the source file to the target?  How 
about making command-line options to allow the user to specify the desired 
mode, uid, gid, contexts, etc.?

--
Marcus




On Saturday, August 25, 2012 04:55:09 PM Marcus Lauer wrote:
&gt;         Attached are my original patch and a git-patch which contains the
&gt; same code.  These implement  changes I called #1 in my previous e-mail.
&gt; 
&gt;         #2 doesn't seem too hard.  CopyFile.open will have to open a
&gt; tempfile rather than the target file.  It already returns the filepath on
&gt; success. Append already uses the return value of CopyFile.open as the file
&gt; to append to.  After appending has finished there needs to be a
&gt; CopyFile.move function called by the overlord which takes both paths and
&gt; moves the tempfile over the source file.  Making sure the
&gt; ownership/permissions/SELinux attributes of the target file do not change
&gt; could be is important so had better be careful about that.
&gt; 
&gt;         Once this is in place #3 is almost trivial.  The overlord needs to
&gt; calculate the MD5 of the source file.  The code for doing this is also
&gt; needed by #1 and is included in my patches.  That MD5 should be passed to
&gt; the CopyFile.move function.  It should calculate the MD5 of the tempfile
&gt; and if they don't match just delete the tempfile and return an error
&gt; instead of moving it.  I figure that this MD5 check should be optional so I
&gt; will also create a flag to enable it.
&gt; 
&gt;         Can anyone see any issues with this general design?  If not I'll get
&gt; working on it when I have the time.
&gt; 
&gt; --
&gt; Marcus
&gt; 
&gt; On Friday, August 24, 2012 07:32:14 PM you wrote:
&gt; &gt; Copyfile could most certainly use some TLC, so let me know if I can
&gt; &gt; help,
&gt; &gt; that would certainly be of help if you'd like to work on that.  The list
&gt; &gt; has indeed changed to lists.fedorahosted.com, so definitely use that
&gt; &gt; one.
&gt; &gt; 
&gt; &gt; Would you mind shooting me your original patch as well?  Thanks very
&gt; &gt; much!&gt; 
&gt; &gt; On Fri, Aug 24, 2012 at 7:22 PM, Marcus Lauer 
&lt;marcuslauer@xxxxxxxxxx&gt;wrote:
&gt; &gt; &gt;          It seems to me that there are at least three
&gt; &gt; &gt;          improvements which
&gt; &gt; &gt; 
&gt; &gt; &gt; should be made to copyfile:
&gt; &gt; &gt; 
&gt; &gt; &gt; 1. If the file on the overlord and minion are the same, that file
&gt; &gt; &gt; should not
&gt; &gt; &gt; be copied.  This saves bandwidth/processing time.
&gt; &gt; &gt; 
&gt; &gt; &gt; 2. Overwriting the file on the minion should be atomic, e.g. the
&gt; &gt; &gt; file on the
&gt; &gt; &gt; overlord should be copied to a tempfile on the minion then moved to
&gt; &gt; &gt; overwrite
&gt; &gt; &gt; the target file as a final step.  Right now if funcd dies or
&gt; &gt; &gt; something
&gt; &gt; &gt; goes wrong mid-copy you end up with half a file on the minion.
&gt; &gt; &gt; 
&gt; &gt; &gt; 3. There should be an option (off by default) such that if the file
&gt; &gt; &gt; which
&gt; &gt; &gt; has
&gt; &gt; &gt; been copied over to the minion is not identical to the file on the
&gt; &gt; &gt; overlord it
&gt; &gt; &gt; is re-copied, or at least does not overwrite the file on the minion.
&gt; &gt; &gt; This won't work for some files (busy logfiles) but for most files it
&gt; &gt; &gt; seems like an
&gt; &gt; &gt; extra bit of reliability which most people would want in most
&gt; &gt; &gt; situations.
&gt; &gt; &gt; 
&gt; &gt; &gt;         I submitted a patch (though not a git-patch... my
&gt; &gt; &gt;         bad!)
&gt; &gt; &gt;         back in
&gt; &gt; &gt; 
&gt; &gt; &gt; January 2011 which implements #1, but imperfectly.  The overlord
&gt; &gt; &gt; still
&gt; &gt; &gt; has to
&gt; &gt; &gt; send a (small) packet to the minion for each 60KB chunk of target
&gt; &gt; &gt; file.
&gt; &gt; &gt; 
&gt; &gt; &gt;        Would anyone be bothered terribly if I worked on #2
&gt; &gt; &gt;        and
&gt; &gt; &gt;        #3?  While
&gt; &gt; &gt; 
&gt; &gt; &gt; I am
&gt; &gt; &gt; at it I will try to find a way to fix up my patch for #1 as well. 
&gt; &gt; &gt; There is some overlap between these patches.  Both will involve
&gt; &gt; &gt; calculating an MD5 hash
&gt; &gt; &gt; of the file on the overlord, for example.
&gt; &gt; &gt; 
&gt; &gt; &gt;         P.S. Is the new mailing list on fedorahosted.org
&gt; &gt; &gt;         live
&gt; &gt; &gt;         yet?  I am
&gt; &gt; &gt; 
&gt; &gt; &gt; sending this message to both just in case.
&gt; &gt; &gt; 
&gt; &gt; &gt; --
&gt; &gt; &gt; Marcus
&gt; &gt; &gt; _______________________________________________
&gt; &gt; &gt; func mailing list
&gt; &gt; &gt; func@xxxxxxxxxxxxxxxxxxxxxx
&gt; &gt; &gt; <a  rel="nofollow" href="https://lists.fedorahosted.org/mailman/listinfo/func">https://lists.fedorahosted.org/mailman/listinfo/func</a>
&gt; &gt; 
&gt; &gt; --
&gt; &gt; Steve Salevan
&gt; &gt; steve@xxxxxxxxxx</pre><pre>&gt;From 8af5bac2039459124b0084ab9fba445c3f56733e Mon Sep 17 00:00:00 2001
From: Marcus Lauer &lt;marcuslauer@xxxxxxxxxx&gt;
Date: Mon, 3 Sep 2012 13:38:25 -0400
Subject: [PATCH 1/4] Make copyfile write to a tempfile on the minion then
 move the file at the end

---
 func/minion/modules/copyfile.py   |   85 +++++++++++++++++++++++++++++--------
 func/overlord/modules/copyfile.py |    6 ++-
 2 files changed, 71 insertions(+), 20 deletions(-)

diff --git a/func/minion/modules/copyfile.py b/func/minion/modules/copyfile.py
index 61c6a4f..8281747 100644
--- a/func/minion/modules/copyfile.py
+++ b/func/minion/modules/copyfile.py
@@ -26,12 +26,12 @@ import time
 import shutil
 
 import func_module
-
+from func import utils as func_utils
 
 class CopyFile(func_module.FuncModule):
 
     version = &quot;0.0.1&quot;
-    api_version = &quot;0.0.2&quot;
+    api_version = &quot;0.0.3&quot;
     description = &quot;Allows for smart copying of a file.&quot;
 
     def _checksum_blob(self, blob):
@@ -40,7 +40,6 @@ class CopyFile(func_module.FuncModule):
         return thissum.hexdigest()
 
     def checksum(self, thing):
-
         CHUNK=2**16
         thissum = hashlib.new('sha1')
         if os.path.exists(thing):
@@ -62,7 +61,9 @@ class CopyFile(func_module.FuncModule):
         if not os.path.exists(dirpath):
             os.makedirs(dirpath)
 
-        # Create empty file
+        # Create an empty tempfile in the target directory.
+	writetarget = filepath + '.functmp'
+
         try:
             fo = open(filepath, 'w')
             fo.close()
@@ -71,33 +72,81 @@ class CopyFile(func_module.FuncModule):
             # XXX logger output here
             return -1
 
-        try:
-            # we could intify the mode here if it's a string
-            if mode:
-                os.chmod(filepath, mode)
-            if uid != -1 or gid != -1:
-                os.chown(filepath, uid, gid)
-        except (IOError, OSError), e:
-            return -1
+        &quot;&quot;&quot;
+        Set the mode and ownership of the tempfile if requested.
+	If not set them to match the target file if the target 
+	file exists.
+	&quot;&quot;&quot;
+	if mode or uid != -1 or gid != -1:
+            try:
+                # we could intify the mode here if it's a string
+                if mode:
+                    os.chmod(filepath, mode)
+                if uid != -1 or gid != -1:
+                    os.chown(filepath, uid, gid)
+            except (IOError, OSError), e:
+		return -1
+	elif os.path.exists(filepath):
+            # Copy the mode of the existing file.
+            shutil.copystat(filepath,writetarget)
 
-        return filepath
+            # Copy the uid/gid of the existing file.
+            fileinfo = os.stat(filepath)
+            os.chown(writetarget,fileinfo[4],fileinfo[5])
 
-    def append(self, filepath, filebuf):
-        if not os.path.exists(filepath):
-            # file disaperead
+            # Copy the SELinux attribs of the existing file.
+            import subprocess
+	    try:
+		subprocess.check_call([&quot;chcon&quot;, &quot;--reference=&quot; + filepath, writetarget])
+            except (OSError), e:
+                # Do nothing. Presumably SELinux is not enabled on this system.
+
+        return writetarget
+
+    def append(self, open_result, filebuf):
+        hostname = func_utils.get_hostname_by_route()
+        writetarget = open_result[hostname]
+
+	# If the result of the open function was 0 (or -1), do not append, return the same value.
+        if type(writetarget) == type(0):
+            return writetarget
+
+        if not os.path.exists(writetarget):
+            # file disappeared
             return -1
 
         try:
-            fo = open(filepath, 'a')
+            fo = open(writetarget, 'a')
             fo.write(filebuf.data)
             fo.close()
             del fo
         except (IOError, OSError), e:
-            # XXX logger output here
+            # Clean up by removing the tempfile, then return an error.
+            os.unlink(writetarget)
             return -1
 
         return 1
 
+    def move(self, filepath, append_result)
+        hostname = func_utils.get_hostname_by_route()
+	writetarget = append_result[hostname]
+
+        # If the result of the append function was 0 (or -1), just return the same value.
+	if type(filepath) == type(0):
+	    return filepath
+
+        if not os.path.exists(filepath):
+            # file disappeared
+            return -1
+
+        try:
+	    shutil.move(writetarget,filepath)
+	except (IOError, OSError), e:
+	    # Clean up by removing the tempfile, then return an error.
+	    os.unlink(writetarget)
+            return -1
+
+	return 1
 
     def copyfile(self, filepath, filebuf, mode=0644, uid=0, gid=0, force=None):
         # -1 = problem file was not copied
diff --git a/func/overlord/modules/copyfile.py b/func/overlord/modules/copyfile.py
index 9f385a9..9a2bf2b 100644
--- a/func/overlord/modules/copyfile.py
+++ b/func/overlord/modules/copyfile.py
@@ -19,13 +19,15 @@ class copyfile(overlord_module.BaseModule):
         uid = st.st_uid
         gid = st.st_gid
 
-        self.parent.run(&quot;copyfile&quot;, &quot;open&quot;, [remotepath, mode, uid, gid])
+        open_result = self.parent.run(&quot;copyfile&quot;, &quot;open&quot;, [remotepath, mode, uid, gid])
 
         while True:
             data=f.read(bufsize)
             if data:
-                self.parent.run(&quot;copyfile&quot;, &quot;append&quot;, [remotepath, xmlrpclib.Binary(data)])
+                append_result = self.parent.run(&quot;copyfile&quot;, &quot;append&quot;, [open_result, xmlrpclib.Binary(data)])
             else:
                 break
 
+	self.parent.run(&quot;copyfile&quot;, &quot;move&quot;, [remotepath, append_result])
+
         return True
-- 
1.7.7


&gt;From 1f16288e1f47e20ef4e35029eda8dd7d6fdab28d Mon Sep 17 00:00:00 2001
From: Marcus Lauer &lt;marcuslauer@xxxxxxxxxx&gt;
Date: Mon, 3 Sep 2012 13:40:15 -0400
Subject: [PATCH 2/4] Make copyfile write to a tempfile on the minion then
 move the file at the end

---
 func/minion/modules/copyfile.py   |   13 +++++++------
 func/overlord/modules/copyfile.py |    1 +
 2 files changed, 8 insertions(+), 6 deletions(-)

diff --git a/func/minion/modules/copyfile.py b/func/minion/modules/copyfile.py
index 8281747..b8e6d99 100644
--- a/func/minion/modules/copyfile.py
+++ b/func/minion/modules/copyfile.py
@@ -65,7 +65,7 @@ class CopyFile(func_module.FuncModule):
 	writetarget = filepath + '.functmp'
 
         try:
-            fo = open(filepath, 'w')
+            fo = open(writetarget, 'w')
             fo.close()
             del fo
         except (IOError, OSError), e:
@@ -100,6 +100,7 @@ class CopyFile(func_module.FuncModule):
 		subprocess.check_call([&quot;chcon&quot;, &quot;--reference=&quot; + filepath, writetarget])
             except (OSError), e:
                 # Do nothing. Presumably SELinux is not enabled on this system.
+		pass
 
         return writetarget
 
@@ -125,17 +126,17 @@ class CopyFile(func_module.FuncModule):
             os.unlink(writetarget)
             return -1
 
-        return 1
+        return writetarget
 
-    def move(self, filepath, append_result)
+    def move(self, filepath, append_result):
         hostname = func_utils.get_hostname_by_route()
 	writetarget = append_result[hostname]
 
         # If the result of the append function was 0 (or -1), just return the same value.
-	if type(filepath) == type(0):
-	    return filepath
+	if type(writetarget) == type(0):
+	    return writetarget
 
-        if not os.path.exists(filepath):
+        if not os.path.exists(writetarget):
             # file disappeared
             return -1
 
diff --git a/func/overlord/modules/copyfile.py b/func/overlord/modules/copyfile.py
index 9a2bf2b..148d5b1 100644
--- a/func/overlord/modules/copyfile.py
+++ b/func/overlord/modules/copyfile.py
@@ -5,6 +5,7 @@ import sys
 import xmlrpclib
 
 from func.overlord import overlord_module
+import func.minion.modules.copyfile as copyfile
 
 class copyfile(overlord_module.BaseModule):
     def send(self, localpath, remotepath, bufsize=60000):
-- 
1.7.7


&gt;From 67c89de4ec644f4f8ad695750f05abd4b883d4e2 Mon Sep 17 00:00:00 2001
From: Marcus Lauer &lt;marcuslauer@xxxxxxxxxx&gt;
Date: Mon, 3 Sep 2012 15:49:12 -0400
Subject: [PATCH 3/4] More work on making copyfile write to a tempfile on the
 minion

---
 func/minion/modules/copyfile.py       |   46 +++++++++++++++------------------
 func/overlord/cmd_modules/copyfile.py |    4 ++-
 func/overlord/modules/copyfile.py     |    4 +-
 3 files changed, 26 insertions(+), 28 deletions(-)

diff --git a/func/minion/modules/copyfile.py b/func/minion/modules/copyfile.py
index b8e6d99..582e21b 100644
--- a/func/minion/modules/copyfile.py
+++ b/func/minion/modules/copyfile.py
@@ -56,7 +56,7 @@ class CopyFile(func_module.FuncModule):
 
         return thissum.hexdigest()
 
-    def open(self, filepath, mode=None, uid=-1, gid=-1):
+    def open(self, filepath, retainperms, mode=None, uid=-1, gid=-1):
         dirpath = os.path.dirname(filepath)
         if not os.path.exists(dirpath):
             os.makedirs(dirpath)
@@ -72,35 +72,31 @@ class CopyFile(func_module.FuncModule):
             # XXX logger output here
             return -1
 
-        &quot;&quot;&quot;
-        Set the mode and ownership of the tempfile if requested.
-	If not set them to match the target file if the target 
-	file exists.
-	&quot;&quot;&quot;
-	if mode or uid != -1 or gid != -1:
+	if retainperms:
+            # Make the attributes of the tempfile match the target file.
+            if os.path.isfile(filepath):
+                # Copy the mode of the existing file.
+                shutil.copystat(filepath,writetarget)
+
+                # Copy the uid/gid of the existing file.
+                fileinfo = os.stat(filepath)
+                os.chown(writetarget,fileinfo[4],fileinfo[5])
+
+                # Copy the SELinux attribs of the existing file.
+                import subprocess
+                refstring = &quot;--reference=&quot; + filepath
+                selinx_result = subprocess.call([&quot;chcon&quot;, refstring, writetarget], stdout=None, stderr=None)
+
+        else:
+            # Set the mode and ownership of the file to match the server.
             try:
                 # we could intify the mode here if it's a string
                 if mode:
-                    os.chmod(filepath, mode)
+                    os.chmod(writetarget, mode)
                 if uid != -1 or gid != -1:
-                    os.chown(filepath, uid, gid)
+                    os.chown(writetarget, uid, gid)
             except (IOError, OSError), e:
-		return -1
-	elif os.path.exists(filepath):
-            # Copy the mode of the existing file.
-            shutil.copystat(filepath,writetarget)
-
-            # Copy the uid/gid of the existing file.
-            fileinfo = os.stat(filepath)
-            os.chown(writetarget,fileinfo[4],fileinfo[5])
-
-            # Copy the SELinux attribs of the existing file.
-            import subprocess
-	    try:
-		subprocess.check_call([&quot;chcon&quot;, &quot;--reference=&quot; + filepath, writetarget])
-            except (OSError), e:
-                # Do nothing. Presumably SELinux is not enabled on this system.
-		pass
+                return -1
 
         return writetarget
 
diff --git a/func/overlord/cmd_modules/copyfile.py b/func/overlord/cmd_modules/copyfile.py
index 3f2263d..3796515 100644
--- a/func/overlord/cmd_modules/copyfile.py
+++ b/func/overlord/cmd_modules/copyfile.py
@@ -38,6 +38,8 @@ class CopyFile(base_command.BaseCommand):
                                action=&quot;store_true&quot;)
         self.parser.add_option(&quot;-v&quot;, &quot;--verbose&quot;, dest=&quot;verbose&quot;,
                                action=&quot;store_true&quot;)
+        self.parser.add_option(&quot;&quot;, &quot;--retainperms&quot;, dest=&quot;retainperms&quot;,
+                               action=&quot;store_true&quot;)
 
     def handleOptions(self, options):
         self.verbose = self.options.verbose
@@ -50,4 +52,4 @@ class CopyFile(base_command.BaseCommand):
         self.server_spec = self.parentCommand.server_spec
         self.getOverlord()
 
-        return self.overlord_obj.local.copyfile.send(self.options.filename, self.options.remotepath)
+        return self.overlord_obj.local.copyfile.send(self.options.filename, self.options.remotepath, self.options.retainperms)
diff --git a/func/overlord/modules/copyfile.py b/func/overlord/modules/copyfile.py
index 148d5b1..bef3740 100644
--- a/func/overlord/modules/copyfile.py
+++ b/func/overlord/modules/copyfile.py
@@ -8,7 +8,7 @@ from func.overlord import overlord_module
 import func.minion.modules.copyfile as copyfile
 
 class copyfile(overlord_module.BaseModule):
-    def send(self, localpath, remotepath, bufsize=60000):
+    def send(self, localpath, remotepath, retainperms, bufsize=60000):
         try:
             f = open(localpath, &quot;r&quot;)
         except IOError, e:
@@ -20,7 +20,7 @@ class copyfile(overlord_module.BaseModule):
         uid = st.st_uid
         gid = st.st_gid
 
-        open_result = self.parent.run(&quot;copyfile&quot;, &quot;open&quot;, [remotepath, mode, uid, gid])
+        open_result = self.parent.run(&quot;copyfile&quot;, &quot;open&quot;, [remotepath, retainperms, mode, uid, gid])
 
         while True:
             data=f.read(bufsize)
-- 
1.7.7


&gt;From 9988429a94e613dae6f33c7383797cc7ec922a05 Mon Sep 17 00:00:00 2001
From: Marcus Lauer &lt;marcuslauer@xxxxxxxxxx&gt;
Date: Mon, 3 Sep 2012 16:02:04 -0400
Subject: [PATCH 4/4] Make False the default for new retainperms flag in
 copyfile

---
 func/overlord/modules/copyfile.py |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/func/overlord/modules/copyfile.py b/func/overlord/modules/copyfile.py
index bef3740..6ac97a6 100644
--- a/func/overlord/modules/copyfile.py
+++ b/func/overlord/modules/copyfile.py
@@ -8,7 +8,7 @@ from func.overlord import overlord_module
 import func.minion.modules.copyfile as copyfile
 
 class copyfile(overlord_module.BaseModule):
-    def send(self, localpath, remotepath, retainperms, bufsize=60000):
+    def send(self, localpath, remotepath, retainperms=False, bufsize=60000):
         try:
             f = open(localpath, &quot;r&quot;)
         except IOError, e:
-- 
1.7.7

</pre><pre>_______________________________________________
func mailing list
func@xxxxxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://lists.fedorahosted.org/mailman/listinfo/func">https://lists.fedorahosted.org/mailman/listinfo/func</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg02077.html">Re: Changes to copyfile functionality.</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg02079.html">PATCH: Improve help info for copyfile</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg02069.html">Re: Changes to copyfile functionality.</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg02081.html">PATCH (Re: Changes to copyfile functionality)</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#02078"><strong>Date</strong></a></li>
<li><a href="index.html#02078"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/netdev/>[Linux&nbsp;Networking]</a>
&nbsp;
&nbsp;
<a href=/lists/fll/>[Fedora&nbsp;Legacy&nbsp;List]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z//biglist.html>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

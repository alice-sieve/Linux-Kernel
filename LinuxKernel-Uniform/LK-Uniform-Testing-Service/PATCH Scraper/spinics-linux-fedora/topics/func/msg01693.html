<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH] Add checksumming feature to copyfile module -->
<!--X-From-R13: [nephf Znhre &#60;znephfynhreNalp.ee.pbz> -->
<!--X-Date: Fri, 26 Nov 2010 10:04:01 &#45;0800 -->
<!--X-Message-Id: 201011261252.15837.marcuslauer@nyc.rr.com -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Fedora Universal Network Connector, [PATCH] Add checksumming feature to copyfile module">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Fedora Universal Network Connector &mdash; [PATCH] Add checksumming feature to copyfile module</title>
<link rel="alternate" type="application/rss+xml" title="Fedora Universal Network Connector" href="//feeds.feedburner.com/FedoraUniversalNetworkConnector">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH] Add checksumming feature to copyfile module</h1>
[<a href="msg01692.html">Date Prev</a>][<a href="msg01694.html">Date Next</a>][<a href="msg01691.html">Thread Prev</a>][<a href="msg01701.html">Thread Next</a>][<a href="maillist.html#01693">Date Index</a>][<a href="index.html#01693">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH] Add checksumming feature to copyfile module</li>
<li><em>From</em>: Marcus Lauer &lt;<a href="mailto:marcuslauer@DOMAIN.HIDDEN">marcuslauer@xxxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Fri, 26 Nov 2010 12:52:15 -0500</li>
<li><em>Reply-to</em>: <a href="mailto:marcuslauer@DOMAIN.HIDDEN">marcuslauer@xxxxxxxxxx</a></li>
<li><em>User-agent</em>: KMail/1.13.3 (Linux/2.6.33.7-desktop-2mnb; KDE/4.4.3; x86_64; ; )</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>        I have added checksumming to the current &quot;chunked&quot; implementation of 
copyfile.  If the source file on the Overlord and target file on the Minion 
have the same checksum, the target is not overwritten.

        My understanding is that copyfile originally calculated a checksum for 
the source and target files and only overwrote the target if the checksums 
differed.  The &quot;copyfile&quot; method of the CopyFile object on the Minion side 
handled this.

        Currently copyfile always overwrites the target file.  It appears that 
when copyfile was modified to write files in chunks (avoiding out-of-memory 
situations when copying large files) this feature vanished.  Instead of 
calling a single &quot;copyfile&quot; method there are two methods: &quot;open&quot; to truncate 
(or create) the target file and &quot;append&quot; to keep adding data to it.  Both of 
these methods are always applied.

        I have changed the &quot;open&quot; method so that it compares the checksums of 
the source and target.  It just returns zero and does not truncate the target 
file if the checksums match.  If they do not match it still truncates the 
target and returns the file path, as before.

        I have changed the &quot;append&quot; method to look up the return code from 
&quot;open&quot; each time it is called.  If the return code was zero or any number 
instead of the file path, it does not append anything to the target file.  
Note that &quot;append&quot; is still called repeatedly even on a Minion which is not 
going to do any appending to that particular file.  This is inefficient but it 
works.

        There should be a better way of adding the checksumming code to both 
the Overlord and Minion copyfile.py files.  I'll look into that next.  Also, 
it should now be relatively easy to re-implement the --force argument (skip 
checksumming) and to create a new --backup argument (backup the target before 
overwriting like the original copyfile method did).

        Based on the experience of writing this code I would like to make a 
feature suggestion.  It would be useful if the &quot;run&quot; method in the &quot;Overlord&quot; 
class could take an optional &quot;mask&quot; argument which could instruct it to skip 
certain Minions.  The mask could be a dictionary with minion names as the keys 
and something like True/False as the data.  Coincidentally this is almost 
exactly the same structure which is returned by the &quot;run&quot; method in the 
&quot;Overlord&quot; class itself.  This feature would make it easy and efficient to 
write functions which have multiple &quot;run&quot; calls which are dependent upon one 
another.

--
Marcus

</pre><pre>diff -rupN func/func//minion/modules/copyfile.py func.new/func//minion/modules/copyfile.py
--- func/func//minion/modules/copyfile.py	2010-11-25 20:16:50.000000000 -0500
+++ func.new/func//minion/modules/copyfile.py	2010-11-25 19:55:28.000000000 -0500
@@ -26,6 +26,7 @@ import time
 import shutil
 
 import func_module
+from func import utils as func_utils
 
 
 class CopyFile(func_module.FuncModule):
@@ -40,28 +41,35 @@ class CopyFile(func_module.FuncModule):
         return thissum.hexdigest()
 
     def checksum(self, thing):
-
         CHUNK=2**16
         thissum = hashlib.new('sha1')
         if os.path.exists(thing):
-            fo = open(thing, 'r', CHUNK)
-            chunk = fo.read
-            while chunk:
+            fo = open(thing, 'r')
+            while True:
                 chunk = fo.read(CHUNK)
+                if not chunk:
+                    break
                 thissum.update(chunk)
             fo.close()
             del fo
         else:
-            # assuming it's a string of some kind
+	    # assuming it's a string of some kind
             thissum.update(thing)
 
-        return thissum.hexdigest()
+        hexdig = thissum.hexdigest()
+        return hexdig
 
-    def open(self, filepath, mode=None, uid=-1, gid=-1):
+    def open(self, filepath, remote_sum, mode=None, uid=-1, gid=-1):
         dirpath = os.path.dirname(filepath)
         if not os.path.exists(dirpath):
             os.makedirs(dirpath)
 
+        if os.path.exists(filepath):
+            local_sum = self.checksum(filepath)
+
+	    if remote_sum == local_sum:
+                return 0
+
         # Create empty file
         try:
             fo = open(filepath, 'w')
@@ -82,7 +90,14 @@ class CopyFile(func_module.FuncModule):
 
         return filepath
 
-    def append(self, filepath, filebuf):
+    def append(self, open_result, filebuf):
+        hostname = func_utils.get_hostname_by_route()
+        filepath = open_result[hostname]
+
+        # If the result of the open function was 0 (or -1), do not append, return the same value.
+	if type(filepath) == type(0):
+	    return filepath
+
         if not os.path.exists(filepath):
             # file disaperead
             return -1
diff -rupN func/func//overlord/modules/copyfile.py func.new/func//overlord/modules/copyfile.py
--- func/func//overlord/modules/copyfile.py	2010-11-25 20:16:50.000000000 -0500
+++ func.new/func//overlord/modules/copyfile.py	2010-11-25 19:42:51.000000000 -0500
@@ -4,9 +4,40 @@ import stat
 import sys
 import xmlrpclib
 
+try:
+    import hashlib
+except ImportError:
+    # Python-2.4.z ... gah! (or even 2.3!)
+    import sha
+    class hashlib:
+        @staticmethod
+        def new(algo):
+            if algo == 'sha1':
+                return sha.new()
+            raise ValueError, &quot;Bad checksum type&quot;
+
 from func.overlord import overlord_module
 
 class copyfile(overlord_module.BaseModule):
+    def checksum(self, thing):
+        CHUNK=2**16
+        thissum = hashlib.new('sha1')
+        if os.path.exists(thing):
+            fo = open(thing, 'r')
+            while True:
+                chunk = fo.read(CHUNK)
+		if not chunk:
+		    break
+                thissum.update(chunk)
+            fo.close()
+            del fo
+        else:
+            # assuming it's a string of some kind
+            thissum.update(thing)
+
+        hexdig = thissum.hexdigest()
+        return hexdig
+
     def send(self, localpath, remotepath, bufsize=60000):
         try:
             f = open(localpath, &quot;r&quot;)
@@ -18,13 +49,14 @@ class copyfile(overlord_module.BaseModul
         mode = stat.S_IMODE(st.st_mode)
         uid = st.st_uid
         gid = st.st_gid
+	local_sum = self.checksum(localpath)
 
-        self.parent.run(&quot;copyfile&quot;, &quot;open&quot;, [remotepath, mode, uid, gid])
+        open_result = self.parent.run(&quot;copyfile&quot;, &quot;open&quot;, [remotepath, local_sum, mode, uid, gid])
 
         while True:
             data=f.read(bufsize)
             if data:
-                self.parent.run(&quot;copyfile&quot;, &quot;append&quot;, [remotepath, xmlrpclib.Binary(data)])
+                self.parent.run(&quot;copyfile&quot;, &quot;append&quot;, [open_result, xmlrpclib.Binary(data)])
             else:
                 break
 
</pre><pre>_______________________________________________
Func-list mailing list
Func-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/func-list">https://www.redhat.com/mailman/listinfo/func-list</a></pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg01692.html">Re:  New func module for file management</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg01694.html">Re:  Func-list Digest, Vol 39, Issue 7</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg01691.html">New func module for file management</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg01701.html">Re:  [PATCH] Add checksumming feature to copyfile module</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#01693"><strong>Date</strong></a></li>
<li><a href="index.html#01693"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/netdev/>[Linux&nbsp;Networking]</a>
&nbsp;
&nbsp;
<a href=/lists/fll/>[Fedora&nbsp;Legacy&nbsp;List]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z//biglist.html>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

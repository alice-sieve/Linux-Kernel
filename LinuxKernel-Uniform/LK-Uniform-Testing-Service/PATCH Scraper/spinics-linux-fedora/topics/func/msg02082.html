<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: PATCH (Re: Changes to copyfile functionality) -->
<!--X-From-R13: [nephf Znhre &#60;znephfynhreNalp.ee.pbz> -->
<!--X-Date: Sat, 29 Sep 2012 11:01:58 &#45;0700 -->
<!--X-Message-Id: 17760015.j26s8grH5L@workstation -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: 6043053.tietnCiud8@workstation -->
<!--X-Reference: 2974980.53ogoT3kWX@workstation -->
<!--X-Reference: 5490746.zctAery5dJ@workstation -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Fedora Universal Network Connector, Re: PATCH (Re: Changes to copyfile functionality)">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Fedora Universal Network Connector &mdash; Re: PATCH (Re: Changes to copyfile functionality)</title>
<link rel="alternate" type="application/rss+xml" title="Fedora Universal Network Connector" href="//feeds.feedburner.com/FedoraUniversalNetworkConnector">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: PATCH (Re: Changes to copyfile functionality)</h1>
[<a href="msg02081.html">Date Prev</a>][<a href="msg02083.html">Date Next</a>][<a href="msg02081.html">Thread Prev</a>][<a href="msg02077.html">Thread Next</a>][<a href="maillist.html#02082">Date Index</a>][<a href="index.html#02082">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: PATCH (Re: Changes to copyfile functionality)</li>
<li><em>From</em>: Marcus Lauer &lt;<a href="mailto:marcuslauer@DOMAIN.HIDDEN">marcuslauer@xxxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Sat, 29 Sep 2012 14:01:27 -0400</li>
<li><em>Delivered-to</em>: <a href="mailto:func@DOMAIN.HIDDEN">func@xxxxxxxxxxxxxxxxxxxxxx</a></li>
<li><em>In-reply-to</em>: &lt;5490746.zctAery5dJ@workstation&gt;</li>
<li><em>References</em>: &lt;6043053.tietnCiud8@workstation&gt; &lt;2974980.53ogoT3kWX@workstation&gt;	&lt;5490746.zctAery5dJ@workstation&gt;</li>
<li><em>Reply-to</em>: Marcus Lauer &lt;<a href="mailto:marcuslauer@DOMAIN.HIDDEN">marcuslauer@xxxxxxxxxx</a>&gt;, <a href="mailto:func@DOMAIN.HIDDEN">func@xxxxxxxxxxxxxxxxxxxxxx</a></li>
<li><em>User-agent</em>: KMail/4.7.2 (Linux/3.1.10-1.16-desktop; KDE/4.7.2; x86_64; ; )</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>        I really should have made the &quot;retainperms&quot; argument to copyfile.send 
optional.  This small patch does so by assigning it a default value of 
&quot;False&quot;.  The patch should be applied after my previous patch of September 
18th.

--
Marcus





On Tuesday, September 18, 2012 08:01:41 PM Marcus Lauer wrote:
&gt;         Attached is an updated version of this patch which makes two more
&gt; changes to the CopyFile minion.
&gt; 
&gt;         One major change is that it now tries to use the pyxattr library to
&gt; copy extended attributes (including SELinux contexts) from the target file
&gt; to the tempfile.  Pyxattr is not a core library but it is packaged for
&gt; RHEL5 and 6.  If this library is not available then it falls back to
&gt; calling chcon.
&gt; 
&gt;         The other major change is that it explicitly looks for a SELinux
&gt; config file.  If one is present then it will consider a failure to copy the
&gt; SELinux contexts from the target file to the tempfile to be an error and
&gt; will exit.  Previously it just kept going when this failed.
&gt; 
&gt;         The remaining changes are organizational, e.g. moving the &quot;from
&gt; subprocess import...&quot; to the top.
&gt; 
&gt; --
&gt; Marcus
&gt; 
&gt; On Monday, September 03, 2012 04:29:28 PM Marcus Lauer wrote:
&gt; &gt;         Since part #1 of my three-part plan is proving
&gt; &gt;         troublesome I moved&gt; 
&gt; &gt; ahead on #2.
&gt; &gt; 
&gt; &gt;         Although part #3 of my original plan borrows some code
&gt; &gt;         from #1 it
&gt; &gt; 
&gt; &gt; does not require #1.  If this patch is accepted then I will move ahead
&gt; &gt; on
&gt; &gt; #3.
&gt; &gt; 
&gt; &gt;         This patch changes copyfile in two ways:
&gt; &gt; 1. Copyfile now opens a tempfile on the minion and appends data to this
&gt; &gt; tempfile, then moves the tempfile over the target file after all of the
&gt; &gt; data has been appended.
&gt; &gt; 
&gt; &gt;         The advantage of this is that updating the target file
&gt; &gt;         is atomic, or&gt; 
&gt; &gt; as close to it as possible in python.  This minimizes the chance of some
&gt; &gt; program accessing an empty or half-complete file.  If the file in
&gt; &gt; question were a server config file... surely you can imagine how this
&gt; &gt; could be a problem.
&gt; &gt; 
&gt; &gt;         The tempfiles are created in the same directory as the
&gt; &gt;         target file&gt; 
&gt; &gt; (for security) and have the same name as the target file but with the
&gt; &gt; extension &quot;.functmp&quot;.  Permissions are set on this file during the
&gt; &gt; &quot;open&quot;
&gt; &gt; stage, while it is still zero-size.
&gt; &gt; 
&gt; &gt; 2. Copyfile has a new option called &quot;retainperms&quot; (&quot;--retainperms&quot; at
&gt; &gt; the
&gt; &gt; command line).  It is &quot;False&quot; by default.
&gt; &gt; 
&gt; &gt;         Currently func tries to give the new file on the minion
&gt; &gt;         the same
&gt; &gt; 
&gt; &gt; attributes (permissions and uid/gid) as the file on the overlord.  The
&gt; &gt; SELinux context of the new file is not set (and does not change).  This
&gt; &gt; overrides this behavior to make the permissions, flags, uid, gid and
&gt; &gt; SELinux contexts of the new file identical to the existing file (if any)
&gt; &gt; on the minion.
&gt; &gt; 
&gt; &gt;         This is intended to deal with the situation in which the
&gt; &gt;         file on the&gt; 
&gt; &gt; overlord has different permissions than the files on the minions and the
&gt; &gt; user does not want to overwrite them.  Perhaps the overlord computer
&gt; &gt; does
&gt; &gt; not have the same users and groups as the minions?  I figured this might
&gt; &gt; be useful for someone.
&gt; &gt; 
&gt; &gt;         On a related note, does anyone think it would be
&gt; &gt;         worthwhile to have&gt; 
&gt; &gt; copyfile copy the SELinux contexts of the source file to the target? 
&gt; &gt; How
&gt; &gt; about making command-line options to allow the user to specify the
&gt; &gt; desired mode, uid, gid, contexts, etc.?
&gt; &gt; 
&gt; &gt; --
&gt; &gt; Marcus
&gt; &gt; 
&gt; &gt; On Saturday, August 25, 2012 04:55:09 PM Marcus Lauer wrote:
&gt; &gt; &gt;         Attached are my original patch and a git-patch which
&gt; &gt; &gt;         contains the
&gt; &gt; &gt; 
&gt; &gt; &gt; same code.  These implement  changes I called #1 in my previous
&gt; &gt; &gt; e-mail.
&gt; &gt; &gt; 
&gt; &gt; &gt;         #2 doesn't seem too hard.  CopyFile.open will have
&gt; &gt; &gt;         to
&gt; &gt; &gt;         open a
&gt; &gt; &gt; 
&gt; &gt; &gt; tempfile rather than the target file.  It already returns the
&gt; &gt; &gt; filepath
&gt; &gt; &gt; on
&gt; &gt; &gt; success. Append already uses the return value of CopyFile.open as
&gt; &gt; &gt; the
&gt; &gt; &gt; file to append to.  After appending has finished there needs to be a
&gt; &gt; &gt; CopyFile.move function called by the overlord which takes both paths
&gt; &gt; &gt; and moves the tempfile over the source file.  Making sure the
&gt; &gt; &gt; ownership/permissions/SELinux attributes of the target file do not
&gt; &gt; &gt; change
&gt; &gt; &gt; could be is important so had better be careful about that.
&gt; &gt; &gt; 
&gt; &gt; &gt;         Once this is in place #3 is almost trivial.  The
&gt; &gt; &gt;         overlord needs to&gt;
&gt; &gt; &gt; 
&gt; &gt; &gt; calculate the MD5 of the source file.  The code for doing this is
&gt; &gt; &gt; also
&gt; &gt; &gt; needed by #1 and is included in my patches.  That MD5 should be
&gt; &gt; &gt; passed
&gt; &gt; &gt; to
&gt; &gt; &gt; the CopyFile.move function.  It should calculate the MD5 of the
&gt; &gt; &gt; tempfile and if they don't match just delete the tempfile and
&gt; &gt; &gt; return an error instead of moving it.  I figure that this MD5 check
&gt; &gt; &gt; should be optional so I will also create a flag to enable it.
&gt; &gt; &gt; 
&gt; &gt; &gt;         Can anyone see any issues with this general design? 
&gt; &gt; &gt;         If
&gt; &gt; &gt;         not I'll get&gt;
&gt; &gt; &gt; 
&gt; &gt; &gt; working on it when I have the time.
&gt; &gt; &gt; 
&gt; &gt; &gt; --
&gt; &gt; &gt; Marcus
&gt; &gt; &gt; 
&gt; &gt; &gt; On Friday, August 24, 2012 07:32:14 PM you wrote:
&gt; &gt; &gt; &gt; Copyfile could most certainly use some TLC, so let me know if I
&gt; &gt; &gt; &gt; can
&gt; &gt; &gt; &gt; help,
&gt; &gt; &gt; &gt; that would certainly be of help if you'd like to work on that. 
&gt; &gt; &gt; &gt; The
&gt; &gt; &gt; &gt; list has indeed changed to lists.fedorahosted.com, so definitely
&gt; &gt; &gt; &gt; use that one.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; Would you mind shooting me your original patch as well?  Thanks
&gt; &gt; &gt; &gt; very
&gt; &gt; &gt; &gt; much!&gt;
&gt; &gt; &gt; &gt; On Fri, Aug 24, 2012 at 7:22 PM, Marcus Lauer
&gt; &gt; 
&gt; &gt; &lt;marcuslauer@xxxxxxxxxx&gt;wrote:
&gt; &gt; &gt; &gt; &gt;          It seems to me that there are at least
&gt; &gt; &gt; &gt; &gt;          three
&gt; &gt; &gt; &gt; &gt;          improvements which
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; should be made to copyfile:
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; 1. If the file on the overlord and minion are the same, that
&gt; &gt; &gt; &gt; &gt; file
&gt; &gt; &gt; &gt; &gt; should not
&gt; &gt; &gt; &gt; &gt; be copied.  This saves bandwidth/processing time.
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; 2. Overwriting the file on the minion should be atomic, e.g.
&gt; &gt; &gt; &gt; &gt; the
&gt; &gt; &gt; &gt; &gt; file on the
&gt; &gt; &gt; &gt; &gt; overlord should be copied to a tempfile on the minion then
&gt; &gt; &gt; &gt; &gt; moved
&gt; &gt; &gt; &gt; &gt; to
&gt; &gt; &gt; &gt; &gt; overwrite
&gt; &gt; &gt; &gt; &gt; the target file as a final step.  Right now if funcd dies or
&gt; &gt; &gt; &gt; &gt; something
&gt; &gt; &gt; &gt; &gt; goes wrong mid-copy you end up with half a file on the
&gt; &gt; &gt; &gt; &gt; minion.
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; 3. There should be an option (off by default) such that if
&gt; &gt; &gt; &gt; &gt; the
&gt; &gt; &gt; &gt; &gt; file
&gt; &gt; &gt; &gt; &gt; which
&gt; &gt; &gt; &gt; &gt; has
&gt; &gt; &gt; &gt; &gt; been copied over to the minion is not identical to the file
&gt; &gt; &gt; &gt; &gt; on
&gt; &gt; &gt; &gt; &gt; the
&gt; &gt; &gt; &gt; &gt; overlord it
&gt; &gt; &gt; &gt; &gt; is re-copied, or at least does not overwrite the file on the
&gt; &gt; &gt; &gt; &gt; minion.
&gt; &gt; &gt; &gt; &gt; This won't work for some files (busy logfiles) but for most
&gt; &gt; &gt; &gt; &gt; files it
&gt; &gt; &gt; &gt; &gt; seems like an
&gt; &gt; &gt; &gt; &gt; extra bit of reliability which most people would want in
&gt; &gt; &gt; &gt; &gt; most
&gt; &gt; &gt; &gt; &gt; situations.
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt;         I submitted a patch (though not a
&gt; &gt; &gt; &gt; &gt;         git-patch...
&gt; &gt; &gt; &gt; &gt;         my
&gt; &gt; &gt; &gt; &gt;         bad!)
&gt; &gt; &gt; &gt; &gt;         back in
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; January 2011 which implements #1, but imperfectly.  The
&gt; &gt; &gt; &gt; &gt; overlord
&gt; &gt; &gt; &gt; &gt; still
&gt; &gt; &gt; &gt; &gt; has to
&gt; &gt; &gt; &gt; &gt; send a (small) packet to the minion for each 60KB chunk of
&gt; &gt; &gt; &gt; &gt; target
&gt; &gt; &gt; &gt; &gt; file.
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt;        Would anyone be bothered terribly if I worked
&gt; &gt; &gt; &gt; &gt;        on
&gt; &gt; &gt; &gt; &gt;        #2
&gt; &gt; &gt; &gt; &gt;        and
&gt; &gt; &gt; &gt; &gt;        #3?  While
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; I am
&gt; &gt; &gt; &gt; &gt; at it I will try to find a way to fix up my patch for #1 as
&gt; &gt; &gt; &gt; &gt; well.
&gt; &gt; &gt; &gt; &gt; There is some overlap between these patches.  Both will
&gt; &gt; &gt; &gt; &gt; involve
&gt; &gt; &gt; &gt; &gt; calculating an MD5 hash
&gt; &gt; &gt; &gt; &gt; of the file on the overlord, for example.
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt;         P.S. Is the new mailing list on
&gt; &gt; &gt; &gt; &gt;         fedorahosted.org
&gt; &gt; &gt; &gt; &gt;         live
&gt; &gt; &gt; &gt; &gt;         yet?  I am
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; sending this message to both just in case.
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; --
&gt; &gt; &gt; &gt; &gt; Marcus
&gt; &gt; &gt; &gt; &gt; _______________________________________________
&gt; &gt; &gt; &gt; &gt; func mailing list
&gt; &gt; &gt; &gt; &gt; func@xxxxxxxxxxxxxxxxxxxxxx
&gt; &gt; &gt; &gt; &gt; <a  rel="nofollow" href="https://lists.fedorahosted.org/mailman/listinfo/func">https://lists.fedorahosted.org/mailman/listinfo/func</a>
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; --
&gt; &gt; &gt; &gt; Steve Salevan
&gt; &gt; &gt; &gt; steve@xxxxxxxxxx</pre><pre>&gt;From b421285ec76b27aeebe1c2bbb9299ad2db540b86 Mon Sep 17 00:00:00 2001
From: Marcus Lauer &lt;marcuslauer@xxxxxxxxxx&gt;
Date: Sat, 29 Sep 2012 13:53:44 -0400
Subject: [PATCH] CopyFile: Make the restoreperms argument to copyfile.send
 optional

---
 func/overlord/modules/copyfile.py |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/func/overlord/modules/copyfile.py b/func/overlord/modules/copyfile.py
index e9c0a1d..bee00ac 100644
--- a/func/overlord/modules/copyfile.py
+++ b/func/overlord/modules/copyfile.py
@@ -8,7 +8,7 @@ from func.overlord import overlord_module
 import func.minion.modules.copyfile as CopyFile
 
 class copyfile(overlord_module.BaseModule):
-    def send(self, localpath, remotepath, retainperms, bufsize=60000):
+    def send(self, localpath, remotepath, retainperms=False, bufsize=60000):
         try:
             f = open(localpath, &quot;r&quot;)
         except IOError, e:
-- 
1.7.7

</pre><pre>_______________________________________________
func mailing list
func@xxxxxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://lists.fedorahosted.org/mailman/listinfo/func">https://lists.fedorahosted.org/mailman/listinfo/func</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg02081.html">PATCH (Re: Changes to copyfile functionality)</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg02083.html">Taking over orphaned Func and Certmaster packages</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg02081.html">PATCH (Re: Changes to copyfile functionality)</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg02077.html">Re: Changes to copyfile functionality.</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#02082"><strong>Date</strong></a></li>
<li><a href="index.html#02082"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/netdev/>[Linux&nbsp;Networking]</a>
&nbsp;
&nbsp;
<a href=/lists/fll/>[Fedora&nbsp;Legacy&nbsp;List]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z//biglist.html>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

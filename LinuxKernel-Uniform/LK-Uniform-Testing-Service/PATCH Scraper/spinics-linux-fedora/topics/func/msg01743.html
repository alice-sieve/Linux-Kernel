<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH] CPU module, fixes to disk module and service module -->
<!--X-From-R13: Fbznf Sqjneqffba &#60;gbzzvNgbzzv.bet> -->
<!--X-Date: Fri, 4 Feb 2011 02:27:27 &#45;0800 -->
<!--X-Message-Id: 11643153.14.1296815228266.JavaMail.root@zimbra.ok.is -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: 1296795803.2472.156.camel@oliver -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Fedora Universal Network Connector, Re:  [PATCH] CPU module, fixes to disk module and service module">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Fedora Universal Network Connector &mdash; Re:  [PATCH] CPU module, fixes to disk module and service module</title>
<link rel="alternate" type="application/rss+xml" title="Fedora Universal Network Connector" href="//feeds.feedburner.com/FedoraUniversalNetworkConnector">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [PATCH] CPU module, fixes to disk module and service module</h1>
[<a href="msg01742.html">Date Prev</a>][<a href="msg01744.html">Date Next</a>][<a href="msg01742.html">Thread Prev</a>][<a href="msg01782.html">Thread Next</a>][<a href="maillist.html#01743">Date Index</a>][<a href="index.html#01743">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH] CPU module, fixes to disk module and service module</li>
<li><em>From</em>: Tomas Edwardsson &lt;<a href="mailto:tommi@DOMAIN.HIDDEN">tommi@xxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Fri, 4 Feb 2011 10:27:08 +0000 (GMT)</li>
<li><em>Cc</em>: <a href="mailto:func-list@DOMAIN.HIDDEN">func-list@xxxxxxxxxx</a></li>
<li><em>In-reply-to</em>: &lt;<a href="mailto:1296795803.2472.156.camel@DOMAIN.HIDDEN"><a href="msg01742.html">1296795803.2472.156.camel@oliver</a></a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>----- Original Message -----
&gt; On Fri, 2011-02-04 at 01:16 +0000, Tomas Edwardsson wrote:
&gt; &gt; This patch introduces a new module, cpu.py and includes fixes for
&gt; &gt; disk.py and service.py.
&gt; &gt;
&gt; &gt; cpu.py exposes cpu information. It has two methods:
&gt; &gt; * cpu_sample_percentage - gets the average cpu usage, returns per
&gt; &gt; cpu
&gt; &gt; percentage for user, nice, system, idle, iowait and irq.
&gt; &gt; * jiffies - fetches cpu statistics from /proc/stat and returns them
&gt; 
&gt; this looks fine.
&gt; 
&gt; &gt; disk.py modifications
&gt; &gt; * Add filesystem type returned by disk.usage()
&gt; 
&gt; also fine
&gt; 
&gt; &gt;
&gt; &gt; service.py modifications
&gt; &gt; * chkconfig and /sbin/service now run with environment variable
&gt; &gt; LANG=C, tools were returning internationalized strings which
&gt; &gt; wouldn't
&gt; &gt; parse correctly.
&gt; 
&gt; this looks like a good idea.
&gt; 
&gt; &gt; * Rewrote get_running(), now lists scripts from /etc/init.d and runs
&gt; &gt; status itself instead of running /sbin/service
&gt; &gt; --status-all. /sbin/service was returning internationalized strings
&gt; &gt; and ignoring LANG variable.
&gt; 
&gt; A little worried here. Using /etc/init.d directly is kinda contrary to
&gt; the whole point of chkconfig and /sbin/service. I'm also not in love
&gt; with the hardcoded list of things to skip. Feels like it is going to
&gt; be
&gt; annoying to maintain.

I agree that using /sbin/service would be cleanest, but since /sbin/service does not honor the LANG variable and that seems to be the intended (see <a  rel="nofollow" href="https://bugzilla.redhat.com/show_bug.cgi?id=422141">https://bugzilla.redhat.com/show_bug.cgi?id=422141</a>) I see no other way if the intent is to have the service module work with non US machines.

# func lnxmgmt call service get_running
{'lnxmgmt.ok.is': [['certmaster', 'running'],
                   ['/usr/bin/funcd', 'running'],
                   ['Monthly', 'disabled.'],
                   ['sysvik-data', 'running'],
                   ['vmware-guestd', 'running']]}
# service --status-all|tail -3
xinetd (pid  2037) er &#xC3; gangi...
ypbind hefur veri&#xC3; st&#xC3;&#xC3;va&#xC3;
yum-updatesd (pid 2518) er &#xC3; gangi...

# LANG=C service --status-all|tail -3
wpa_supplicant (pid  1583) er &#xC3; gangi...
ypbind hefur veri&#xC3; st&#xC3;&#xC3;va&#xC3;
zvbid hefur veri&#xC3; st&#xC3;&#xC3;va&#xC3;

As you see this does not work at all on non-US locale machines. An alternative way which I can implement this is by running get_enabled() and then running /etc/init.d/&lt;service&gt; status from the output. That way we do not need the hardcoded list.

Another thing, instead of relying on the string output we could catch the return code of the service.

New patch attached which implements this.

&gt; 
&gt; Maybe just run the ones and catch the error if it lacks a 'status'?
&gt; 
&gt; What's the impact if we raise properly?
&gt; 
&gt; -sv
</pre><pre>diff --git a/func/minion/modules/service.py b/func/minion/modules/service.py
index 38de51c..05b92af 100644
--- a/func/minion/modules/service.py
+++ b/func/minion/modules/service.py
@@ -28,9 +28,9 @@ class Service(func_module.FuncModule):
 
         service_name = service_name.strip() # remove useless spaces
 
-        filename = os.path.join(&quot;/etc/rc.d/init.d/&quot;,service_name)
+        filename = os.path.join(&quot;/etc/init.d/&quot;,service_name)
         if os.path.exists(filename):
-            return sub_process.call([&quot;/sbin/service&quot;, service_name, command], close_fds=True)
+            return sub_process.call([&quot;/sbin/service&quot;, service_name, command], close_fds=True, env={ 'LANG':'C' })
         else:
             raise codes.FuncException(&quot;Service not installed: %s&quot; % service_name)
 
@@ -87,7 +87,7 @@ class Service(func_module.FuncModule):
         only provide whether or not they are running, not specific runlevel info.
         &quot;&quot;&quot;
 
-        chkconfig = sub_process.Popen([&quot;/sbin/chkconfig&quot;, &quot;--list&quot;], stdout=sub_process.PIPE, close_fds=True)
+        chkconfig = sub_process.Popen([&quot;/sbin/chkconfig&quot;, &quot;--list&quot;], stdout=sub_process.PIPE, close_fds=True, env={ &quot;LANG&quot;: &quot;C&quot; })
         data = chkconfig.communicate()[0]
         results = []
         for line in data.split(&quot;\n&quot;):
@@ -106,13 +106,29 @@ class Service(func_module.FuncModule):
         &quot;&quot;&quot;
         Get a list of which services are running, stopped, or disabled.
         &quot;&quot;&quot;
-        chkconfig = sub_process.Popen([&quot;/sbin/service&quot;, &quot;--status-all&quot;], stdout=sub_process.PIPE, close_fds=True)
-        data = chkconfig.communicate()[0]
         results = []
-        for line in data.split(&quot;\n&quot;):
-            if line.find(&quot; is &quot;) != -1:
-                tokens = line.split()
-                results.append((tokens[0], tokens[-1].replace(&quot;...&quot;,&quot;&quot;)))
+
+        # Get services
+        services = self.get_enabled()
+
+        init_return_codes = { 0: 'running', 1: 'dead', 2:'locked', 3:'stopped' }
+
+        for service in services:
+            filename = os.path.join(&quot;/etc/init.d/&quot;,service[0])
+            # Run status for service
+            try:
+                init_exec = sub_process.Popen([filename, &quot;status&quot;], stdout=sub_process.PIPE, close_fds=True, env={ &quot;LANG&quot;: &quot;C&quot; })
+            except Exception, e:
+                raise codes.FuncException(&quot;Service status error %s on initscript %s&quot; % (e, filename))
+
+            # Get status output
+            data = init_exec.communicate()[0]
+
+            # Wait for command to complete
+            init_exec.wait()
+
+            # Append the result, service name, return status and status output
+            results.append((service[0], init_return_codes[init_exec.returncode], data))
         return results
 
     def register_method_args(self):
@@ -143,3 +159,5 @@ class Service(func_module.FuncModule):
 
 
                 }
+
+# vi: ts=4 expandtab
</pre><pre>_______________________________________________
Func-list mailing list
Func-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/func-list">https://www.redhat.com/mailman/listinfo/func-list</a></pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg01742.html">Re:  [PATCH] CPU module, fixes to disk module and service module</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg01744.html">Simple Architecture Diagram?</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg01742.html">Re:  [PATCH] CPU module, fixes to disk module and service module</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg01782.html">Re:  [PATCH] CPU module,	fixes to disk module and service module</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#01743"><strong>Date</strong></a></li>
<li><a href="index.html#01743"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/netdev/>[Linux&nbsp;Networking]</a>
&nbsp;
&nbsp;
<a href=/lists/fll/>[Fedora&nbsp;Legacy&nbsp;List]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z//biglist.html>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

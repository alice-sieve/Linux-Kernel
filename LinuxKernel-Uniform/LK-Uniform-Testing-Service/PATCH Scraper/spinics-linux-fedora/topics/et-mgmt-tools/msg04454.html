<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH] Add support for Solaris PV -->
<!--X-From-R13: wbua.yribaNfha.pbz -->
<!--X-Date: Wed, 3 Dec 2008 20:31:47 &#45;0800 -->
<!--X-Message-Id: 35baacfe79834400949e.1228365088@xenbld.SFBay.Sun.COM -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Fedora Management Tools, [PATCH] Add support for Solaris PV">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<link rel="alternate" type="application/rss+xml" title="Fedora Management Tools" href="//feedproxy.google.com/Fedora/linuxManagementTools">
<title>Fedora Management Tools -- [PATCH] Add support for Solaris PV</title>
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH] Add support for Solaris PV</h1>
[<a href="msg04453.html">Date Prev</a>][<a href="msg04455.html">Date Next</a>][<a href="msg04453.html">Thread Prev</a>][<a href="msg04471.html">Thread Next</a>][<a href="maillist.html#04454">Date Index</a>][<a href="index.html#04454">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH] Add support for Solaris PV</li>
<li><em>From</em>: <a href="mailto:john.levon@DOMAIN.HIDDEN">john.levon@xxxxxxx</a></li>
<li><em>Date</em>: Wed, 03 Dec 2008 20:31:28 -0800</li>
<li><em>Reply-to</em>: Fedora/Linux Management Tools &lt;<a href="mailto:et-mgmt-tools@DOMAIN.HIDDEN">et-mgmt-tools@xxxxxxxxxx</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre># HG changeset patch
# User john.levon@xxxxxxx
# Date 1228365031 28800
# Node ID 35baacfe79834400949ebdba69f952ed873ae442
# Parent  7dd32b4d7915937025f42c3519711db50e5a7ce3
Add support for Solaris PV

Solaris PV comes in two flavours: Nevada and OpenSolaris.  In order to
correctly build network installs for Nevada, we need to pass down guest
options into OSDistro.

os_type was horribly overloaded between the Installer and Guest classes,
meaning two different things ('solaris' or 'hvm'). Clean this up by
naming the latter 'virt_type'.

Signed-off-by: John Levon &lt;john.levon@xxxxxxx&gt;

diff --git a/virt-install b/virt-install
--- a/virt-install
+++ b/virt-install
@@ -510,27 +510,27 @@ def main():
         fail(_(&quot;Can't do both --hvm and --paravirt&quot;))
 
     if options.fullvirt:
-        os_type = &quot;hvm&quot;
+        virt_type = &quot;hvm&quot;
     elif options.paravirt:
-        os_type = &quot;xen&quot;
+        virt_type = &quot;xen&quot;
     else:
         # This should force capabilities to give us the most sensible default
-        os_type = None
-
-    logging.debug(&quot;Requesting virt method '%s'&quot; % (os_type and os_type or \
+        virt_type = None
+
+    logging.debug(&quot;Requesting virt method '%s'&quot; % (virt_type and virt_type or \
                                                   _(&quot;default&quot;)))
 
-    guest = capabilities.guestForOSType(type=os_type, arch=options.arch)
+    guest = capabilities.guestForVirtType(type=virt_type, arch=options.arch)
     if guest is None:
-        msg = _(&quot;Unsupported virtualization type '%s' &quot; % (os_type and os_type
+        msg = _(&quot;Unsupported virtualization type '%s' &quot; % (virt_type and virt_type
                                                            or _(&quot;default&quot;)))
         if options.arch:
             msg += _(&quot;for arch '%s'&quot; % options.arch)
         fail(msg)
 
-    os_type = guest.os_type
-    logging.debug(&quot;Received virt method '%s'&quot; % os_type)
-    if os_type == &quot;hvm&quot;:
+    virt_type = guest.virt_type
+    logging.debug(&quot;Received virt method '%s'&quot; % virt_type)
+    if virt_type == &quot;hvm&quot;:
         hvm = True
     else:
         hvm = False
@@ -540,13 +540,13 @@ def main():
     logging.debug(&quot;Hypervisor type is '%s'&quot; % htype)
 
     if options.livecd:
-        installer = virtinst.LiveCDInstaller(type = htype, os_type = os_type,
+        installer = virtinst.LiveCDInstaller(type = htype, virt_type = virt_type,
                                              conn = conn)
     elif options.pxe:
-        installer = virtinst.PXEInstaller(type = htype, os_type = os_type,
+        installer = virtinst.PXEInstaller(type = htype, virt_type = virt_type,
                                           conn = conn)
     else:
-        installer = virtinst.DistroInstaller(type = htype, os_type = os_type,
+        installer = virtinst.DistroInstaller(type = htype, virt_type = virt_type,
                                              conn = conn)
 
     if hvm:
diff --git a/virtinst/CapabilitiesParser.py b/virtinst/CapabilitiesParser.py
--- a/virtinst/CapabilitiesParser.py
+++ b/virtinst/CapabilitiesParser.py
@@ -121,7 +121,7 @@ class Guest(object):
 class Guest(object):
     def __init__(self, node = None):
         # e.g. &quot;xen&quot; or &quot;hvm&quot;
-        self.os_type = None
+        self.virt_type = None
         # e.g. &quot;i686&quot; or &quot;x86_64&quot;
         self.arch = None
 
@@ -135,8 +135,9 @@ class Guest(object):
     def parseXML(self, node):
         child = node.children
         while child:
+            # In the XML, os_type really means virt_type
             if child.name == &quot;os_type&quot;:
-                self.os_type = child.content
+                self.virt_type = child.content
             elif child.name == &quot;features&quot;:
                 self.features = CapabilityFeatures(child)
             elif child.name == &quot;arch&quot;:
@@ -260,7 +261,7 @@ class Capabilities(object):
 
         self._fixBrokenEmulator()
 
-    def guestForOSType(self, type = None, arch = None):
+    def guestForVirtType(self, type = None, arch = None):
         if self.host is None:
             return None
 
@@ -270,7 +271,7 @@ class Capabilities(object):
             archs = [arch]
         for a in archs:
             for g in self.guests:
-                if (type is None or g.os_type == type) and \
+                if (type is None or g.virt_type == type) and \
                    (a is None or g.arch == a):
                     return g
 
@@ -283,7 +284,7 @@ class Capabilities(object):
 
         fixEmulator = None
         for g in self.guests:
-            if g.os_type != &quot;hvm&quot; or g.arch != &quot;x86_64&quot;:
+            if g.virt_type != &quot;hvm&quot; or g.arch != &quot;x86_64&quot;:
                 continue
             for d in g.domains:
                 if d.emulator.find(&quot;lib64&quot;) != -1:
@@ -293,7 +294,7 @@ class Capabilities(object):
             return
 
         for g in self.guests:
-            if g.os_type != &quot;hvm&quot; or g.arch != &quot;i686&quot;:
+            if g.virt_type != &quot;hvm&quot; or g.arch != &quot;i686&quot;:
                 continue
             for d in g.domains:
                 if d.emulator.find(&quot;lib64&quot;) == -1:
diff --git a/virtinst/DistroManager.py b/virtinst/DistroManager.py
--- a/virtinst/DistroManager.py
+++ b/virtinst/DistroManager.py
@@ -41,6 +41,8 @@ from OSDistro import DebianDistro
 from OSDistro import DebianDistro
 from OSDistro import UbuntuDistro
 from OSDistro import MandrivaDistro
+from OSDistro import SolarisDistro
+from OSDistro import OpenSolarisDistro
 from OSDistro import GenericDistro
 
 def _fetcherForURI(uri, scratchdir=None):
@@ -87,6 +89,11 @@ def _storeForDistro(fetcher, baseuri, ty
         stores.append(UbuntuDistro(baseuri, typ, scratchdir, arch))
     if distro == &quot;mandriva&quot; or distro is None:
         stores.append(MandrivaDistro(baseuri, typ, scratchdir, arch))
+    # XXX: this is really &quot;nevada&quot;
+    if distro == &quot;solaris&quot; or distro is None:
+        stores.append(SolarisDistro(baseuri, type, scratchdir))
+    if distro == &quot;solaris&quot; or distro is None:
+        stores.append(OpenSolarisDistro(baseuri, type, scratchdir))
 
     stores.append(GenericDistro(baseuri, typ, scratchdir, arch))
 
@@ -98,24 +105,6 @@ def _storeForDistro(fetcher, baseuri, ty
 
     raise ValueError, _(&quot;Could not find an installable distribution at '%s'&quot; % baseuri) 
 
-
-# Method to fetch a kernel &amp; initrd pair for a particular distro / HV type
-def acquireKernel(baseuri, progresscb, scratchdir=&quot;/var/tmp&quot;, type=None,
-                  distro=None, arch=None):
-    fetcher = _fetcherForURI(baseuri, scratchdir)
-
-    try:
-        fetcher.prepareLocation()
-    except ValueError, e:
-        raise ValueError, _(&quot;Invalid install location: &quot;) + str(e)
-
-    try:
-        store = _storeForDistro(fetcher=fetcher, baseuri=baseuri, typ=type,
-                                progresscb=progresscb, distro=distro,
-                                scratchdir=scratchdir, arch=arch)
-        return store.acquireKernel(fetcher, progresscb)
-    finally:
-        fetcher.cleanupLocation()
 
 # Method to fetch a bootable ISO image for a particular distro / HV type
 def acquireBootDisk(baseuri, progresscb, scratchdir=&quot;/var/tmp&quot;, type=None,
@@ -137,9 +126,9 @@ def acquireBootDisk(baseuri, progresscb,
 
 class DistroInstaller(Guest.Installer):
     def __init__(self, type = &quot;xen&quot;, location = None, boot = None,
-                 extraargs = None, os_type = None, conn = None):
+                 extraargs = None, virt_type = None, conn = None):
         Guest.Installer.__init__(self, type, location, boot, extraargs,
-                                 os_type, conn=conn)
+                                 virt_type, conn=conn)
 
         self.install = {
             &quot;kernel&quot; : &quot;&quot;,
@@ -226,6 +215,27 @@ class DistroInstaller(Guest.Installer):
                                          readOnly=True,
                                          transient=True)
 
+    # Method to fetch a kernel &amp; initrd pair for a particular distro / HV type
+    def _acquire_kernel(self, guest, progresscb, distro=None, arch=None):
+        fetcher = _fetcherForURI(self.location, self.scratchdir)
+
+        try:
+            fetcher.prepareLocation()
+        except ValueError, e:
+            raise ValueError, _(&quot;Invalid install location: &quot;) + str(e)
+
+        try:
+            store = _storeForDistro(fetcher=fetcher, baseuri=self.location,
+                                    typ=self.virt_type, progresscb=progresscb,
+                                    distro=distro, scratchdir=self.scratchdir,
+                                    arch=arch)
+
+            os_type = store.os_type
+
+            return store.acquireKernel(guest, fetcher, progresscb), os_type
+        finally:
+            fetcher.cleanupLocation()
+
     def _prepare_kernel_and_initrd(self, guest, distro, meter):
         if self.boot is not None:
             # Got a local kernel/initrd already
@@ -239,26 +249,29 @@ class DistroInstaller(Guest.Installer):
             arch = os.uname()[4]
             if hasattr(guest, &quot;arch&quot;):
                 arch = guest.arch
-            (kernelfn, initrdfn, args) = acquireKernel(self.location,
-                                                       meter,
-                                                       scratchdir = self.scratchdir,
-                                                       type = self.os_type,
-                                                       distro = distro,
-                                                       arch=arch)
+
+            (kernelfn, initrdfn, args), os_type = \
+                self._acquire_kernel(guest, meter, distro = distro, arch = arch)
+
+            guest.os_type = os_type
             self.install[&quot;kernel&quot;] = kernelfn
             self.install[&quot;initrd&quot;] = initrdfn
-            if not self.extraargs is None:
-                self.install[&quot;extraargs&quot;] = self.extraargs + &quot; &quot; + args
-            else:
-                self.install[&quot;extraargs&quot;] = args
+            self.install[&quot;extraargs&quot;] = args
 
             self._tmpfiles.append(kernelfn)
             self._tmpfiles.append(initrdfn)
 
         # If they're installing off a local file/device, we map it
-        # through to a virtual harddisk
-        if self.location is not None and self.location.startswith(&quot;/&quot;) and not os.path.isdir(self.location):
+        # through to a virtual CD or disk
+
+        if (self.location is not None and self.location.startswith(&quot;/&quot;)
+            and not os.path.isdir(self.location)):
+            device = Guest.VirtualDisk.DEVICE_DISK
+            if guest._lookup_osdict_key('pv_cdrom_install'):
+                device = Guest.VirtualDisk.DEVICE_CDROM
+
             self._install_disk = VirtualDisk(self.location,
+                                             device=device,
                                              readOnly=True,
                                              transient=True)
 
@@ -294,9 +307,9 @@ class DistroInstaller(Guest.Installer):
 
 class PXEInstaller(Guest.Installer):
     def __init__(self, type = &quot;xen&quot;, location = None, boot = None,
-                 extraargs = None, os_type = None, conn = None):
+                 extraargs = None, virt_type = None, conn = None):
         Guest.Installer.__init__(self, type, location, boot, extraargs,
-                                 os_type, conn=conn)
+                                 virt_type, conn=conn)
 
     def prepare(self, guest, meter, distro = None):
         pass
diff --git a/virtinst/FullVirtGuest.py b/virtinst/FullVirtGuest.py
--- a/virtinst/FullVirtGuest.py
+++ b/virtinst/FullVirtGuest.py
@@ -35,7 +35,7 @@ class FullVirtGuest(Guest):
 
     def __init__(self, type=None, arch=None, connection=None, hypervisorURI=None, emulator=None, installer=None):
         if not installer:
-            installer = DistroManager.DistroInstaller(type = type, os_type = &quot;hvm&quot;)
+            installer = DistroManager.DistroInstaller(type = type, virt_type = &quot;hvm&quot;)
         Guest.__init__(self, type, connection, hypervisorURI, installer)
         self.disknode = &quot;hd&quot;
         self.features = { &quot;acpi&quot;: None, &quot;pae&quot;:
@@ -46,7 +46,7 @@ class FullVirtGuest(Guest):
 
         self.emulator = emulator
         self.loader = None
-        guest = self._caps.guestForOSType(type=self.installer.os_type,
+        guest = self._caps.guestForVirtType(type=self.installer.virt_type,
                                           arch=self.arch)
         if (not self.emulator) and guest:
             for dom in guest.domains:
diff --git a/virtinst/Guest.py b/virtinst/Guest.py
--- a/virtinst/Guest.py
+++ b/virtinst/Guest.py
@@ -305,12 +305,12 @@ class VirtualGraphics(object):
 
 class Installer(object):
     def __init__(self, type = &quot;xen&quot;, location = None, boot = None,
-                 extraargs = None, os_type = None, conn = None):
+                 extraargs = None, virt_type = None, conn = None):
         self._location = None
         self._extraargs = None
         self._boot = None
         self._cdrom = False
-        self._os_type = os_type
+        self._virt_type = virt_type
         self._conn = conn
         self._install_disk = None   # VirtualDisk that contains install media
 
@@ -341,11 +341,11 @@ class Installer(object):
         self._type = val
     type = property(get_type, set_type)
 
-    def get_os_type(self):
-        return self._os_type
-    def set_os_type(self, val):
-        self._os_type = val
-    os_type = property(get_os_type, set_os_type)
+    def get_virt_type(self):
+        return self._virt_type
+    def set_virt_type(self, val):
+        self._virt_type = val
+    virt_type = property(get_virt_type, set_virt_type)
 
     def get_scratchdir(self):
         if platform.system() == 'SunOS':
@@ -411,15 +411,15 @@ class Installer(object):
 
         osblob = &quot;&lt;os&gt;\n&quot;
 
-        os_type = self.os_type
+        virt_type = self.virt_type
         # Hack for older libvirt Xen driver
-        if os_type == &quot;xen&quot; and self.type == &quot;xen&quot;:
-            os_type = &quot;linux&quot;
+        if virt_type == &quot;xen&quot; and self.type == &quot;xen&quot;:
+            virt_type = &quot;linux&quot;
 
         if arch:
-            osblob += &quot;    &lt;type arch='%s'&gt;%s&lt;/type&gt;\n&quot; % (arch, os_type)
-        else:
-            osblob += &quot;    &lt;type&gt;%s&lt;/type&gt;\n&quot; % os_type
+            osblob += &quot;    &lt;type arch='%s'&gt;%s&lt;/type&gt;\n&quot; % (arch, virt_type)
+        else:
+            osblob += &quot;    &lt;type&gt;%s&lt;/type&gt;\n&quot; % virt_type
 
         if loader:
             osblob += &quot;    &lt;loader&gt;%s&lt;/loader&gt;\n&quot; % loader
diff --git a/virtinst/ImageManager.py b/virtinst/ImageManager.py
--- a/virtinst/ImageManager.py
+++ b/virtinst/ImageManager.py
@@ -111,18 +111,18 @@ class ImageInstaller(Guest.Installer):
         osblob = &quot;&lt;os&gt;\n&quot;
 
         if hvm:
-            os_type = &quot;hvm&quot;
+            virt_type = &quot;hvm&quot;
         else:
             # Hack for older libvirt Xen driver
             if self.type == &quot;xen&quot;:
-                os_type = &quot;linux&quot;
+                virt_type = &quot;linux&quot;
             else:
-                os_type = &quot;xen&quot;
+                virt_type = &quot;xen&quot;
 
         if arch:
-            osblob += &quot;    &lt;type arch='%s'&gt;%s&lt;/type&gt;\n&quot; % (arch, os_type)
+            osblob += &quot;    &lt;type arch='%s'&gt;%s&lt;/type&gt;\n&quot; % (arch, virt_type)
         else:
-            osblob += &quot;    &lt;type&gt;%s&lt;/type&gt;\n&quot; % os_type
+            osblob += &quot;    &lt;type&gt;%s&lt;/type&gt;\n&quot; % virt_type
 
         if loader:
             osblob += &quot;    &lt;loader&gt;%s&lt;/loader&gt;\n&quot; % loader
@@ -154,7 +154,7 @@ def match_boots(capabilities, boots):
 def match_boots(capabilities, boots):
     for b in boots:
         for g in capabilities.guests:
-            if b.type == g.os_type and b.arch == g.arch:
+            if b.type == g.virt_type and b.arch == g.arch:
                 found = True
                 for bf in b.features.names():
                     if not b.features[bf] &amp; g.features[bf]:
diff --git a/virtinst/LiveCDInstaller.py b/virtinst/LiveCDInstaller.py
--- a/virtinst/LiveCDInstaller.py
+++ b/virtinst/LiveCDInstaller.py
@@ -29,10 +29,10 @@ class LiveCDInstallerException(Exception
         Exception.__init__(self, msg)
 
 class LiveCDInstaller(Guest.Installer):
-    def __init__(self, type = &quot;xen&quot;, location = None, os_type = None,
+    def __init__(self, type = &quot;xen&quot;, location = None, virt_type = None,
                  conn = None):
         Guest.Installer.__init__(self, type=type, location=location,
-                                 os_type=os_type, conn=conn)
+                                 virt_type=virt_type, conn=conn)
 
     def prepare(self, guest, meter, distro = None):
         self.cleanup()
@@ -41,7 +41,7 @@ class LiveCDInstaller(Guest.Installer):
 
         found = False
         for guest_caps in capabilities.guests:
-            if guest_caps.os_type == &quot;hvm&quot;:
+            if guest_caps.virt_type == &quot;hvm&quot;:
                 found = True
                 break
 
diff --git a/virtinst/OSDistro.py b/virtinst/OSDistro.py
--- a/virtinst/OSDistro.py
+++ b/virtinst/OSDistro.py
@@ -25,8 +25,10 @@ import re
 import re
 import tempfile
 import platform
+import socket
 import ConfigParser
 
+from virtinst import util
 from virtinst import _virtinst as _
 
 def distroFromTreeinfo(fetcher, progresscb, uri, vmtype=None,
@@ -83,7 +85,7 @@ class Distro:
         &quot;&quot;&quot;Determine if uri points to a tree of the store's distro&quot;&quot;&quot;
         raise NotImplementedError
 
-    def acquireKernel(self, fetcher, progresscb):
+    def acquireKernel(self, guest, fetcher, progresscb):
         kernelpath = None
         initrdpath = None
         if self._hasTreeinfo(fetcher, progresscb):
@@ -106,7 +108,7 @@ class Distro:
                                  &quot;%(distro)s tree.&quot;) % \
                                  { &quot;distro&quot;: self.name, &quot;type&quot; : self.type })
 
-        return self._kernelFetchHelper(fetcher, progresscb, kernelpath,
+        return self._kernelFetchHelper(fetcher, guest, progresscb, kernelpath,
                                        initrdpath)
 
     def acquireBootDisk(self, fetcher, progresscb):
@@ -172,18 +174,21 @@ class Distro:
 
         return False
 
-    def _kernelFetchHelper(self, fetcher, progresscb, kernelpath, initrdpath):
+    def _kernelFetchHelper(self, fetcher, guest, progresscb, kernelpath, initrdpath):
         # Simple helper for fetching kernel + initrd and performing
         # cleanup if neccessary
         kernel = fetcher.acquireFile(kernelpath, progresscb)
+        args = ''
+
+        if not fetcher.location.startswith(&quot;/&quot;):
+            args += &quot;method=&quot; + fetcher.location
+
+        if guest.extraargs:
+            args += guest.extraargs
+
         try:
             initrd = fetcher.acquireFile(initrdpath, progresscb)
-            if fetcher.location.startswith(&quot;/&quot;):
-                # Local host path, so can't pass a location to guest
-                #for install method
-                return (kernel, initrd, &quot;&quot;)
-            else:
-                return (kernel, initrd, &quot;method=&quot; + fetcher.location)
+            return kernel, initrd, args
         except:
             os.unlink(kernel)
 
@@ -193,6 +198,7 @@ class GenericDistro(Distro):
        as a last resort if we can't recognize any actual distro&quot;&quot;&quot;
 
     name = &quot;Generic&quot;
+    os_type = &quot;linux&quot;
     uses_treeinfo = True
 
     _xen_paths = [ (&quot;images/xen/vmlinuz&quot;,
@@ -249,12 +255,12 @@ class GenericDistro(Distro):
             return True
         return False
 
-    def acquireKernel(self, fetcher, progresscb):
+    def acquireKernel(self, guest, fetcher, progresscb):
         if self._valid_kernel_path == None:
             raise ValueError(_(&quot;Could not find a kernel path for virt type &quot;
                                &quot;'%s'&quot; % self.type))
 
-        return self._kernelFetchHelper(fetcher, progresscb,
+        return self._kernelFetchHelper(fetcher, guest, progresscb,
                                        self._valid_kernel_path[0],
                                        self._valid_kernel_path[1])
 
@@ -270,6 +276,7 @@ class RedHatDistro(Distro):
 class RedHatDistro(Distro):
 
     name = &quot;Red Hat&quot;
+    os_type = &quot;linux&quot;
     uses_treeinfo = True
     _boot_iso_paths   = [ &quot;images/boot.iso&quot; ]
     _hvm_kernel_paths = [ (&quot;images/pxeboot/vmlinuz&quot;,
@@ -285,6 +292,7 @@ class FedoraDistro(RedHatDistro):
 class FedoraDistro(RedHatDistro):
 
     name = &quot;Fedora&quot;
+    os_type = &quot;linux&quot;
 
     def isValidStore(self, fetcher, progresscb):
         if self._hasTreeinfo(fetcher, progresscb):
@@ -300,6 +308,7 @@ class RHELDistro(RedHatDistro):
 class RHELDistro(RedHatDistro):
 
     name = &quot;Red Hat Enterprise Linux&quot;
+    os_type = &quot;linux&quot;
 
     def isValidStore(self, fetcher, progresscb):
         if self._hasTreeinfo(fetcher, progresscb):
@@ -322,6 +331,7 @@ class CentOSDistro(RedHatDistro):
 class CentOSDistro(RedHatDistro):
 
     name = &quot;CentOS&quot;
+    os_type = &quot;linux&quot;
 
     def isValidStore(self, fetcher, progresscb):
         if self._hasTreeinfo(fetcher, progresscb):
@@ -338,6 +348,7 @@ class SLDistro(RedHatDistro):
 class SLDistro(RedHatDistro):
 
     name = &quot;Scientific Linux&quot;
+    os_type = &quot;linux&quot;
     _boot_iso_paths = RedHatDistro._boot_iso_paths + [ &quot;images/SL/boot.iso&quot; ]
     _hvm_kernel_paths = RedHatDistro._hvm_kernel_paths + \
                         [ (&quot;images/SL/pxeboot/vmlinuz&quot;,
@@ -361,6 +372,7 @@ class SuseDistro(Distro):
 class SuseDistro(Distro):
 
     name = &quot;SUSE&quot;
+    os_type = &quot;linux&quot;
     _boot_iso_paths   = [ &quot;boot/boot.iso&quot; ]
     _hvm_kernel_paths = []
     _xen_kernel_paths = []
@@ -385,11 +397,11 @@ class SuseDistro(Distro):
             return True
         return False
 
-    def acquireKernel(self, fetcher, progresscb):
+    def acquireKernel(self, guest, fetcher, progresscb):
         # If installing a fullvirt guest
         if self.type is None or self.type == &quot;hvm&quot; or \
            fetcher.hasFile(&quot;boot/%s/vmlinuz-xen&quot; % self.arch):
-            return Distro.acquireKernel(self, fetcher, progresscb)
+            return Distro.acquireKernel(self, guest, fetcher, progresscb)
 
         # For Opensuse &lt;= 10.2, we need to perform some heinous stuff
         logging.debug(&quot;Trying Opensuse 10 PV rpm hacking&quot;)
@@ -590,6 +602,7 @@ class DebianDistro(Distro):
     # daily builds: <a  rel="nofollow" href="http://people.debian.org/~joeyh/d-i/">http://people.debian.org/~joeyh/d-i/</a>
 
     name = &quot;Debian&quot;
+    os_type = &quot;linux&quot;
 
     def __init__(self, uri, vmtype=None, scratchdir=None, arch=None):
         Distro.__init__(self, uri, vmtype, scratchdir, arch)
@@ -642,6 +655,7 @@ class UbuntuDistro(DebianDistro):
 class UbuntuDistro(DebianDistro):
 
     name = &quot;Ubuntu&quot;
+    os_type = &quot;linux&quot;
 
     def _set_media_paths(self):
         DebianDistro._set_media_paths(self)
@@ -672,6 +686,7 @@ class MandrivaDistro(Distro):
     # Ex. <a  rel="nofollow" href="ftp://ftp.uwsg.indiana.edu/linux/mandrake/official/2007.1/x86_64/">ftp://ftp.uwsg.indiana.edu/linux/mandrake/official/2007.1/x86_64/</a>
 
     name = &quot;Mandriva&quot;
+    os_type = &quot;linux&quot;
     _boot_iso_paths = [ &quot;install/images/boot.iso&quot; ]
     # Kernels for HVM: valid for releases 2007.1, 2008.*, 2009.0
     _hvm_kernel_paths = [ (&quot;isolinux/alt0/vmlinuz&quot;, &quot;isolinux/alt0/all.rdz&quot;)]
@@ -692,3 +707,194 @@ class MandrivaDistro(Distro):
 
         return False
 
+# Solaris and OpenSolaris distros
+class SunDistro(Distro):
+
+    name = &quot;Solaris&quot;
+    os_type = &quot;solaris&quot;
+
+    def isValidStore(self, fetcher, progresscb):
+        &quot;&quot;&quot;Determine if uri points to a tree of the store's distro&quot;&quot;&quot;
+        raise NotImplementedError
+
+    def acquireBootDisk(self, fetcher, progresscb):
+        return fetcher.acquireFile(&quot;images/solarisdvd.iso&quot;, progresscb)
+
+    def process_extra_args(self, argstr):
+        &quot;&quot;&quot;Collect additional arguments.&quot;&quot;&quot;
+        if not argstr:
+            return (None, None, None, None)
+
+        kopts = ''
+        kargs = ''
+        smfargs = ''
+        Bargs = ''
+
+        args = argstr.split()
+        i = 0
+        while i &lt; len(args):
+            exarg = args[i]
+            if exarg == '-B':
+                i += 1
+                if i == len(args):
+                    continue
+
+                if not Bargs:
+                    Bargs = args[i]
+                else:
+                    Bargs = ','.join([Bargs, args[i]])
+        
+            elif exarg == '-m':
+                i += 1
+                if i == len(args):
+                    continue
+                smfargs = args[i]
+            elif exarg.startswith('-'):
+                if kopts is None:
+                    kopts = exarg[1:]
+                else:
+                    kopts = kopts + exarg[1:]
+            else:
+                if kargs is None:
+                    kargs = exarg
+                else:
+                    kargs = kargs + ' ' + exarg
+            i += 1
+
+        return kopts, kargs, smfargs, Bargs
+
+class SolarisDistro(SunDistro):
+    kernelpath = &quot;boot/platform/i86xpv/kernel/unix&quot;
+    initrdpath = &quot;boot/x86.miniroot&quot;
+
+    def isValidStore(self, fetcher, progresscb):
+        if fetcher.hasFile(self.kernelpath):
+            logging.debug(&quot;Detected Solaris&quot;)
+            return True
+        return False
+
+    def install_args(self, guest):
+        &quot;&quot;&quot;Construct kernel cmdline args for the installer, consisting of:
+           the pathname of the kernel (32/64) to load, kernel options
+           and args, and '-B' boot properties.&quot;&quot;&quot;
+
+        # XXX: ignoring smfargs for the time being
+        (kopts, kargs, smfargs, kbargs) = \
+            self.process_extra_args(guest.extraargs)
+
+        bargs = ''
+        if kopts:
+            bargs += '-' + kopts + ' -'
+
+        if guest.graphics['enabled'] == False:
+            bargs += ' nowin'
+
+        if guest.autocf:
+            bargs += ' install'
+
+        if kargs:
+            bargs += ' ' + kargs
+
+        if guest.location.startswith('nfs:'):
+            try:
+                guestIP = socket.gethostbyaddr(guest.name)[2][0]
+            except:
+                bargs += ' dhcp'
+            else:
+                iserver = guest.location.split(':')[1]
+                ipath = guest.location.split(':')[2]
+                iserverIP = socket.gethostbyaddr(iserver)[2][0]
+                bargs += &quot; -B install_media=&quot; + iserverIP + &quot;:&quot; + ipath
+                bargs += &quot;,host-ip=&quot; + guestIP
+                droute = util.default_route(guest.nics[0].bridge)
+                if droute is not None:
+                    bargs += &quot;,router-ip=&quot; + droute
+                if guest.nics[0].macaddr is not None:
+                    en = guest.nics[0].macaddr.split(':')
+                    for i in range(len(en)):
+                        # remove leading '0' from mac address element
+                        if len(en[i]) &gt; 1 and en[i][0] == '0':
+                            en[i] = en[i][1]
+                    boot_mac = &quot;:&quot;.join(en)
+                    bargs += &quot;,boot-mac=&quot; + boot_mac
+                if guest.autocf:
+                    acf_host = guest.autocf.split(&quot;:&quot;)[1]
+                    acf_path = guest.autocf.split(&quot;:&quot;)[2]
+                    try:
+                        acf_hostip = socket.gethostbyaddr(acf_host)[2][0]
+                        bargs += &quot;,sysid_config=&quot; + acf_hostip + &quot;:&quot; + acf_path
+                        bargs += &quot;,install_config=&quot; + acf_hostip + &quot;:&quot; + acf_path
+                    except:
+                        print &quot;failed to lookup host %s&quot; % acf_host
+        else:
+            bargs += &quot; -B install_media=cdrom&quot;
+
+        if kbargs:
+            bargs += &quot;,&quot; + kbargs
+
+        return bargs
+
+    def acquireKernel(self, guest, fetcher, progresscb):
+
+        try:
+            kernel = fetcher.acquireFile(self.kernelpath, progresscb)
+        except:
+            raise RuntimeError(&quot;Solaris PV kernel not found at %s&quot; %
+                self.kernelpath)
+
+        # strip boot from the kernel path
+        kpath = self.kernelpath.split('/')[1:]
+        args = &quot;/&quot; + &quot;/&quot;.join(kpath) + self.install_args(guest)
+
+        try:
+            initrd = fetcher.acquireFile(self.initrdpath, progresscb)
+            return (kernel, initrd, args)
+        except:
+            os.unlink(kernel)
+            raise RuntimeError(_(&quot;Solaris miniroot not found at %s&quot;) %
+                self.initrdpath)
+
+class OpenSolarisDistro(SunDistro):
+    kernelpath = &quot;platform/i86xpv/kernel/unix&quot;
+    initrdpath = &quot;boot/x86.microroot&quot;
+
+    def isValidStore(self, fetcher, progresscb):
+        if fetcher.hasFile(self.kernelpath):
+            logging.debug(&quot;Detected OpenSolaris&quot;)
+            return True
+        return False
+
+    def install_args(self, guest):
+        &quot;&quot;&quot;Construct kernel cmdline args for the installer, consisting of:
+           the pathname of the kernel (32/64) to load, kernel options
+           and args, and '-B' boot properties.&quot;&quot;&quot;
+
+        # XXX: ignoring smfargs and kargs for the time being
+        (kopts, kargs, smfargs, kbargs) = \
+            self.process_extra_args(guest.extraargs)
+
+        bargs = ''
+        if kopts:
+            bargs += ' -' + kopts
+        if kbargs:
+            bargs += ' -B ' + kbargs
+
+        return bargs
+
+    def acquireKernel(self, guest, fetcher, progresscb):
+
+        try:
+            kernel = fetcher.acquireFile(self.kernelpath, progresscb)
+        except:
+            raise RuntimeError(_(&quot;OpenSolaris PV kernel not found at %s&quot;) %
+                self.kernelpath)
+
+        args = &quot;/&quot; + self.kernelpath + self.install_args(guest)
+
+        try:
+            initrd = fetcher.acquireFile(self.initrdpath, progresscb)
+            return (kernel, initrd, args)
+        except:
+            os.unlink(kernel)
+            raise RuntimeError(_(&quot;OpenSolaris microroot not found at %s&quot;) %
+                self.initrdpath)
diff --git a/virtinst/ParaVirtGuest.py b/virtinst/ParaVirtGuest.py
--- a/virtinst/ParaVirtGuest.py
+++ b/virtinst/ParaVirtGuest.py
@@ -26,7 +26,7 @@ class ParaVirtGuest(Guest):
 class ParaVirtGuest(Guest):
     def __init__(self, type=None, connection=None, hypervisorURI=None, installer=None):
         if not installer:
-            installer = DistroInstaller(type = type, os_type = &quot;linux&quot;)
+            installer = DistroInstaller(type = type, virt_type = &quot;linux&quot;)
         Guest.__init__(self, type, connection, hypervisorURI, installer)
         self.disknode = &quot;xvd&quot;
 
diff --git a/virtinst/VirtualDisk.py b/virtinst/VirtualDisk.py
--- a/virtinst/VirtualDisk.py
+++ b/virtinst/VirtualDisk.py
@@ -519,6 +519,9 @@ class VirtualDisk(VirtualDevice):
 
         if self.target:
             disknode = self.target
+        if self.device == VirtualDisk.DEVICE_CDROM and disknode.startswith('xvd'):
+            disknode = disknode + ':cdrom'
+
         if not disknode:
             raise ValueError(_(&quot;'disknode' or self.target must be set!&quot;))
 
diff --git a/virtinst/osdict.py b/virtinst/osdict.py
--- a/virtinst/osdict.py
+++ b/virtinst/osdict.py
@@ -31,6 +31,7 @@ DEFAULTS = { \
     &quot;continue&quot;: False,
     &quot;distro&quot;: None,
     &quot;label&quot;: None,
+    &quot;pv_cdrom_install&quot;: False,
     &quot;devices&quot; : {
      #  &quot;devname&quot; : { &quot;attribute&quot; : [( [&quot;applicable&quot;, &quot;hv-type&quot;, list&quot;],
      #                               &quot;recommended value for hv-types&quot; ),]},
@@ -110,6 +111,7 @@ OS_TYPES = {\
 &quot;solaris&quot;: {
     &quot;label&quot;: &quot;Solaris&quot;,
     &quot;clock&quot;: &quot;localtime&quot;,
+    &quot;pv_cdrom_install&quot;: True,
     &quot;variants&quot;: {
         &quot;solaris9&quot;: { &quot;label&quot;: &quot;Sun Solaris 9&quot;, },
         &quot;solaris10&quot;: { &quot;label&quot;: &quot;Sun Solaris 10&quot;,
diff --git a/virtinst/util.py b/virtinst/util.py
--- a/virtinst/util.py
+++ b/virtinst/util.py
@@ -38,7 +38,17 @@ KEYBOARD_DIR = &quot;/etc/sysconfig/keyboard&quot;
 KEYBOARD_DIR = &quot;/etc/sysconfig/keyboard&quot;
 XORG_CONF = &quot;/etc/X11/xorg.conf&quot;
 
-def default_route():
+def default_route(nic = None):
+    if platform.system() == 'SunOS':
+        cmd = '/usr/bin/netstat -rn'
+        if nic:
+            cmd += ' -I %s' % nic
+        for i in os.popen(cmd):
+            line = i.split()
+            if len(line) &gt; 1 and line[0] == 'default':
+                return line[1]
+        return None
+
     route_file = &quot;/proc/net/route&quot;
     d = file(route_file)
 

_______________________________________________
et-mgmt-tools mailing list
et-mgmt-tools@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/et-mgmt-tools">https://www.redhat.com/mailman/listinfo/et-mgmt-tools</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="04471" href="msg04471.html">Re:  [PATCH] Add support for Solaris PV</a></strong>
<ul><li><em>From:</em> Daniel P. Berrange</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg04453.html">[PATCH] Solaris HVM support</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg04455.html">[PATCH] Fix regression with --mac option</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg04453.html">[PATCH] Solaris HVM support</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg04471.html">Re:  [PATCH] Add support for Solaris PV</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#04454"><strong>Date</strong></a></li>
<li><a href="index.html#04454"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fll/>[Fedora&nbsp;Legacy&nbsp;List]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-maintainers/>[Fedora&nbsp;Maintainers]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.html>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

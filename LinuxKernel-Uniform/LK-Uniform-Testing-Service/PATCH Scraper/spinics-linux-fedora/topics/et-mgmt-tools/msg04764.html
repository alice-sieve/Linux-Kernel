<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH] virt&#45;manager: Storage aware delete dialog -->
<!--X-From-R13: Qbyr Dbovafba &#60;pebovafbNerqung.pbz> -->
<!--X-Date: Fri, 6 Mar 2009 07:29:31 &#45;0800 -->
<!--X-Message-Id: 49B140D6.9060301@redhat.com -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Fedora Management Tools, [PATCH] virt-manager: Storage aware delete dialog">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<link rel="alternate" type="application/rss+xml" title="Fedora Management Tools" href="//feedproxy.google.com/Fedora/linuxManagementTools">
<title>Fedora Management Tools -- [PATCH] virt-manager: Storage aware delete dialog</title>
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH] virt-manager: Storage aware delete dialog</h1>
[<a href="msg04763.html">Date Prev</a>][<a href="msg04765.html">Date Next</a>][<a href="msg04761.html">Thread Prev</a>][<a href="msg04774.html">Thread Next</a>][<a href="maillist.html#04764">Date Index</a>][<a href="index.html#04764">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH] virt-manager: Storage aware delete dialog</li>
<li><em>From</em>: Cole Robinson &lt;<a href="mailto:crobinso@DOMAIN.HIDDEN">crobinso@xxxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Fri, 06 Mar 2009 10:27:18 -0500</li>
<li><em>Reply-to</em>: Fedora/Linux Management Tools &lt;<a href="mailto:et-mgmt-tools@DOMAIN.HIDDEN">et-mgmt-tools@xxxxxxxxxx</a>&gt;</li>
<li><em>User-agent</em>: Thunderbird 2.0.0.19 (X11/20090105)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Hi all,

The attached patch adds a storage aware delete dialog to virt-manager.
When deleting a VM, we are presented with a list of storage attached to
it, with an option to remove individual disks as part of the delete process.

Some screenshots:

<a  rel="nofollow" href="http://fedorapeople.org/~crobinso/virt-manager/delete/vmm-delete-2.1.png">http://fedorapeople.org/~crobinso/virt-manager/delete/vmm-delete-2.1.png</a>

The dialog's look when it is launched (we make the user opt in to delete
storage).

<a  rel="nofollow" href="http://fedorapeople.org/~crobinso/virt-manager/delete/vmm-delete-2.2.png">http://fedorapeople.org/~crobinso/virt-manager/delete/vmm-delete-2.2.png</a>

Even when the user opts in, we don't select all disks for deletion by
default. We won't select a disk by default if:

It is marked as read-only in the xml
It is marked as shareable in the xml
It is in use by another VM on the same connection

A tooltip to this effect is shown when hovering over the warning icon.

<a  rel="nofollow" href="http://fedorapeople.org/~crobinso/virt-manager/delete/vmm-delete-2.4.png">http://fedorapeople.org/~crobinso/virt-manager/delete/vmm-delete-2.4.png</a>

If we think we can't delete certain storage, the check box is marked as
inconsistent. There are multiple reasons we can't delete (no
permissions, storage is an iSCSI volume, storage isn't managed and we
are on a remote connection, etc.) The reasoning is also shown in a tooltip.

If any storage deletion fails, we continue with the process, and just
show all aggregated errors to the user at the end. The VM removal will
be attempted regardless.

That's about it. Questions or comments appreciated.

Thanks,
Cole
</pre><pre># HG changeset patch
# User Cole Robinson &lt;crobinso@xxxxxxxxxx&gt;
# Node ID bc56a6f4f2d08a11f8b9101441c5abe6d34d0c75
# Parent  311a239d48af9913ad1a553d15490444155e4f56
Storage aware 'Delete VM' dialog.

diff -r 311a239d48af -r bc56a6f4f2d0 src/virtManager/connection.py
--- a/src/virtManager/connection.py	Thu Mar 05 10:44:26 2009 -0500
+++ b/src/virtManager/connection.py	Thu Mar 05 11:23:54 2009 -0500
@@ -315,6 +315,19 @@
                 return pool
         return None
 
+    def get_pool_by_name(self, name):
+        for p in self.pools.values():
+            if p.get_name() == name:
+                return p
+        return None
+
+    def get_vol_by_path(self, path):
+        for pool in self.pools.values():
+            for vol in pool.get_volumes().values():
+                if vol.get_path() == path:
+                    return vol
+        return None
+
     def open(self):
         if self.state != self.STATE_DISCONNECTED:
             return
diff -r 311a239d48af -r bc56a6f4f2d0 src/virtManager/delete.py
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/src/virtManager/delete.py	Thu Mar 05 11:23:54 2009 -0500
@@ -0,0 +1,384 @@
+#
+# Copyright (C) 2009 Red Hat, Inc.
+# Copyright (C) 2009 Cole Robinson &lt;crobinso@xxxxxxxxxx&gt;
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
+# MA 02110-1301 USA.
+#
+
+import gobject
+import gtk.glade
+
+import os, stat
+import traceback
+import logging
+
+import libvirt
+import virtinst
+
+from virtManager.error import vmmErrorDialog
+from virtManager.asyncjob import vmmAsyncJob
+from virtManager.createmeter import vmmCreateMeter
+
+STORAGE_ROW_CONFIRM = 0
+STORAGE_ROW_CANT_DELETE = 1
+STORAGE_ROW_PATH = 2
+STORAGE_ROW_TARGET = 3
+STORAGE_ROW_ICON_SHOW = 4
+STORAGE_ROW_ICON = 5
+STORAGE_ROW_ICON_SIZE = 6
+STORAGE_ROW_TOOLTIP = 7
+
+class vmmDeleteDialog(gobject.GObject):
+    __gsignals__ = {
+        #&quot;vol-created&quot;: (gobject.SIGNAL_RUN_FIRST, gobject.TYPE_NONE, [])
+    }
+
+    def __init__(self, config, vm):
+        self.__gobject_init__()
+        self.window = gtk.glade.XML(config.get_glade_dir() + \
+                                    &quot;/vmm-delete.glade&quot;,
+                                    &quot;vmm-delete&quot;, domain=&quot;virt-manager&quot;)
+        self.config = config
+        self.vm = vm
+        self.conn = vm.connection
+
+        self.topwin = self.window.get_widget(&quot;vmm-delete&quot;)
+        self.err = vmmErrorDialog(self.topwin,
+                                  0, gtk.MESSAGE_ERROR, gtk.BUTTONS_CLOSE,
+                                  _(&quot;Unexpected Error&quot;),
+                                  _(&quot;An unexpected error occurred&quot;))
+        self.topwin.hide()
+
+        self.window.signal_autoconnect({
+            &quot;on_vmm_delete_delete_event&quot; : self.close,
+            &quot;on_delete_cancel_clicked&quot; : self.close,
+            &quot;on_delete_ok_clicked&quot; : self.finish,
+            &quot;on_delete_remove_storage_toggled&quot; : self.toggle_remove_storage,
+        })
+
+        prepare_storage_list(self.window.get_widget(&quot;delete-storage-list&quot;))
+
+    def toggle_remove_storage(self, src):
+        dodel = src.get_active()
+        self.window.get_widget(&quot;delete-storage-list&quot;).set_sensitive(dodel)
+
+
+    def show(self):
+        self.reset_state()
+        self.topwin.show()
+        self.topwin.present()
+
+    def close(self, ignore1=None, ignore2=None):
+        self.topwin.hide()
+        return 1
+
+    def reset_state(self):
+
+        # Set VM name in title'
+        title_str = (&quot;&lt;span size='x-large'&gt;%s '%s'&lt;/span&gt;&quot; %
+                     (_(&quot;Delete&quot;), self.vm.get_name()))
+        self.window.get_widget(&quot;delete-main-label&quot;).set_markup(title_str)
+
+        # Disable storage removal by default
+        self.window.get_widget(&quot;delete-remove-storage&quot;).set_active(False)
+        self.window.get_widget(&quot;delete-remove-storage&quot;).toggled()
+
+        populate_storage_list(self.window.get_widget(&quot;delete-storage-list&quot;),
+                              self.vm, self.conn)
+
+    def set_vm(self, vm):
+        self.vm = vm
+        self.conn = vm.connection
+        self.reset_state()
+
+    def get_config_format(self):
+        format_combo = self.window.get_widget(&quot;vol-format&quot;)
+        model = format_combo.get_model()
+        if format_combo.get_active_iter() != None:
+            model = format_combo.get_model()
+            return model.get_value(format_combo.get_active_iter(), 0)
+        return None
+
+    def get_paths_to_delete(self):
+        del_list = self.window.get_widget(&quot;delete-storage-list&quot;)
+        model = del_list.get_model()
+
+        paths = []
+        if self.window.get_widget(&quot;delete-remove-storage&quot;).get_active():
+            for row in model:
+                if (not row[STORAGE_ROW_CANT_DELETE] and
+                    row[STORAGE_ROW_CONFIRM]):
+                    paths.append(row[STORAGE_ROW_PATH])
+        return paths
+
+    def finish(self, src):
+        devs = self.get_paths_to_delete()
+
+        self.error_msg = None
+        self.error_details = None
+        self.topwin.set_sensitive(False)
+        self.topwin.window.set_cursor(gtk.gdk.Cursor(gtk.gdk.WATCH))
+
+        title = _(&quot;Deleting virtual machine '%s'&quot;) % self.vm.get_name()
+        text = title
+        if devs:
+            text = title + _(&quot; and selected storage (this may take a while&quot;)
+
+        progWin = vmmAsyncJob(self.config, self._async_delete, [devs],
+                              title=title, text=text)
+        progWin.run()
+
+        self.topwin.set_sensitive(True)
+        self.topwin.window.set_cursor(gtk.gdk.Cursor(gtk.gdk.TOP_LEFT_ARROW))
+        self.close()
+
+        if self.error_msg is not None:
+            self.err.show_err(self.error_msg, self.error_details)
+
+        self.conn.tick(noStatsUpdate=True)
+
+
+    def _async_delete(self, paths, asyncjob):
+        newconn = None
+        storage_errors = []
+
+        try:
+            # Open a seperate connection to install on since this is async
+            logging.debug(&quot;Threading off connection to delete vol.&quot;)
+            #newconn = vmmConnection(self.config, self.conn.get_uri(),
+            #                        self.conn.is_read_only())
+            #newconn.open()
+            #newconn.connectThreadEvent.wait()
+            newconn = libvirt.open(self.conn.get_uri())
+            meter = vmmCreateMeter(asyncjob)
+
+            for path in paths:
+                try:
+                    logging.debug(&quot;Deleting path: %s&quot; % path)
+                    meter.start(text = _(&quot;Deleting path '%s'&quot;) % path)
+                    self._async_delete_path(newconn, path, meter)
+                except Exception, e:
+                    storage_errors.append((str(e),
+                                          &quot;&quot;.join(traceback.format_exc())))
+                meter.end(0)
+
+            logging.debug(&quot;Removing VM '%s'&quot; % self.vm.get_name())
+            self.vm.delete()
+
+        except Exception, e:
+            self.error_msg = (_(&quot;Error deleting virtual machine '%s': %s&quot;) %
+                              (self.vm.get_name(), str(e)))
+            self.error_details = &quot;&quot;.join(traceback.format_exc())
+            logging.error(self.error_msg + &quot;\n&quot; + self.error_details)
+
+        storage_errstr = &quot;&quot;
+        for errinfo in storage_errors:
+            storage_errstr += &quot;%s\n%s\n&quot; % (errinfo[0], errinfo[1])
+
+        if not storage_errstr:
+            return
+
+        # We had extra storage errors. If there was another error message,
+        # errors to it. Otherwise, build the main error around them.
+        if self.error_details:
+            self.error_details += &quot;\n\n&quot;
+            self.error_details += _(&quot;Additionally, there were errors removing&quot;
+                                    &quot; certain storage devices: \n&quot;)
+            self.error_details += storage_errstr
+        else:
+            self.error_msg = _(&quot;Errors encountered while removing certain &quot;
+                               &quot;storage devices.&quot;)
+            self.error_details = storage_errstr
+
+    def _async_delete_path(self, conn, path, ignore):
+        vol = None
+
+        try:
+            vol = conn.storageVolLookupByPath(path)
+        except:
+            logging.debug(&quot;Path '%s' is not managed. Deleting locally.&quot; % path)
+
+        if vol:
+            vol.delete(0)
+        else:
+            os.unlink(path)
+
+
+def populate_storage_list(storage_list, vm, conn):
+    model = storage_list.get_model()
+    model.clear()
+
+    for disk in vm.get_disk_devices():
+        vol = None
+
+        target = disk[1]
+        path = disk[3]
+        ro = disk[6]
+        shared = disk[7]
+
+        # There are a few pieces here
+        # 1) Can we even delete the storage? If not, make the checkbox
+        #    inconsistent. self.can_delete decides this for us, and if
+        #    we can't delete, gives us a nice message to show the user
+        #    for that row.
+        #
+        # 2) If we can delete, do we want to delete this storage by
+        #    default? Reasons not to, are if the storage is marked
+        #    readonly or sharable, or is in use by another VM.
+
+        if not path or path == &quot;-&quot;:
+            continue
+
+        default = False
+        definfo = None
+        vol = conn.get_vol_by_path(path)
+        can_del, delinfo = can_delete(conn, vol, path)
+
+        if can_del:
+            default, definfo = do_we_default(conn, vm.get_name(), vol,
+                                             path, ro, shared)
+
+        info = None
+        if not can_del:
+            info = delinfo
+        elif not default:
+            info = definfo
+
+        icon = gtk.STOCK_DIALOG_WARNING
+        icon_size = gtk.ICON_SIZE_LARGE_TOOLBAR
+
+        row = [default, not can_del, path, target,
+               bool(info), icon, icon_size, info]
+        model.append(row)
+
+
+def prepare_storage_list(storage_list):
+    # Checkbox, deleteable?, storage path, target (hda), icon stock,
+    # icon size, tooltip
+    model = gtk.ListStore(bool, bool, str, str, bool, str, int, str)
+    storage_list.set_model(model)
+    try:
+        storage_list.set_tooltip_column(STORAGE_ROW_TOOLTIP)
+    except:
+        # FIXME: use tooltip wrapper for this
+        pass
+
+    confirmCol = gtk.TreeViewColumn()
+    pathCol = gtk.TreeViewColumn(_(&quot;Storage Path&quot;))
+    targetCol = gtk.TreeViewColumn(_(&quot;Target&quot;))
+    infoCol = gtk.TreeViewColumn()
+
+    storage_list.append_column(confirmCol)
+    storage_list.append_column(pathCol)
+    storage_list.append_column(targetCol)
+    storage_list.append_column(infoCol)
+
+    chkbox = gtk.CellRendererToggle()
+    chkbox.connect('toggled', storage_item_toggled, storage_list)
+    confirmCol.pack_start(chkbox, False)
+    confirmCol.add_attribute(chkbox, 'active', STORAGE_ROW_CONFIRM)
+    confirmCol.add_attribute(chkbox, 'inconsistent',
+                             STORAGE_ROW_CANT_DELETE)
+    confirmCol.set_sort_column_id(STORAGE_ROW_CANT_DELETE)
+
+    path_txt = gtk.CellRendererText()
+    pathCol.pack_start(path_txt, True)
+    pathCol.add_attribute(path_txt, 'text', STORAGE_ROW_PATH)
+    pathCol.set_sort_column_id(STORAGE_ROW_PATH)
+
+    target_txt = gtk.CellRendererText()
+    targetCol.pack_start(target_txt, False)
+    targetCol.add_attribute(target_txt, 'text', STORAGE_ROW_TARGET)
+    targetCol.set_sort_column_id(STORAGE_ROW_TARGET)
+
+    info_img = gtk.CellRendererPixbuf()
+    infoCol.pack_start(info_img, False)
+    infoCol.add_attribute(info_img, 'visible', STORAGE_ROW_ICON_SHOW)
+    infoCol.add_attribute(info_img, 'stock-id', STORAGE_ROW_ICON)
+    infoCol.add_attribute(info_img, 'stock-size', STORAGE_ROW_ICON_SIZE)
+    infoCol.set_sort_column_id(STORAGE_ROW_ICON)
+
+def storage_item_toggled(src, index, storage_list):
+    active = src.get_active()
+
+    model = storage_list.get_model()
+    model[index][STORAGE_ROW_CONFIRM] = not active
+
+def can_delete(conn, vol, path):
+    &quot;&quot;&quot;Is the passed path even deleteable&quot;&quot;&quot;
+    ret = True
+    msg = None
+
+    if vol:
+        # Managed storage
+        if (vol.get_pool().get_type() ==
+            virtinst.Storage.StoragePool.TYPE_ISCSI):
+            msg = _(&quot;Cannot delete iscsi share.&quot;)
+    else:
+        if conn.is_remote():
+            msg = _(&quot;Cannot delete unmanaged remote storage.&quot;)
+        elif not os.path.exists(path):
+            msg = _(&quot;Path does not exist.&quot;)
+        elif not os.access(os.path.dirname(path), os.W_OK):
+            msg = _(&quot;No write access to parent directory.&quot;)
+        elif stat.S_ISBLK(os.stat(path)[stat.ST_MODE]):
+            msg = _(&quot;Cannot delete unmanaged block device.&quot;)
+
+    if msg:
+        ret = False
+
+    return (ret, msg)
+
+def do_we_default(conn, vm_name, vol, path, ro, shared):
+    &quot;&quot;&quot; Returns (do we delete by default?, info string if not)&quot;&quot;&quot;
+    info = &quot;&quot;
+
+    def append_str(str1, str2, delim=&quot;\n&quot;):
+        if not str2:
+            return str1
+        if str1:
+            str1 += delim
+        str1 += str2
+        return str1
+
+    if ro:
+        info = append_str(info, _(&quot;Storage is read-only.&quot;))
+    elif not vol and not os.access(path, os.W_OK):
+        info = append_str(info, _(&quot;No write access to path.&quot;))
+
+    if shared:
+        info = append_str(info, _(&quot;Storage is marked as shareable.&quot;))
+
+    # Check if disk is actually in use by other VMs. For useful err
+    # reporting, we need more info from VirtualDisk is_conflict_disk
+    try:
+        d = virtinst.VirtualDisk(conn=conn.vmm, path=path,
+                                 readOnly=ro, shareable=shared)
+        names = d.is_conflict_disk(conn.vmm, return_names=True)
+
+        if len(names) &gt; 1:
+            namestr = &quot;&quot;
+            names.remove(vm_name)
+            for name in names:
+                namestr = append_str(namestr, name, delim=&quot;, &quot;)
+            info = append_str(info, _(&quot;Storage is in use by the following &quot;
+                                      &quot;virtual machines: %s&quot; % namestr))
+    except Exception, e:
+        logging.exception(&quot;Failed checking disk conflict: %s&quot; % str(e))
+
+    return (not info, info)
+
+gobject.type_register(vmmDeleteDialog)
diff -r 311a239d48af -r bc56a6f4f2d0 src/virtManager/manager.py
--- a/src/virtManager/manager.py	Thu Mar 05 10:44:26 2009 -0500
+++ b/src/virtManager/manager.py	Thu Mar 05 11:23:54 2009 -0500
@@ -22,7 +22,6 @@
 import gtk
 import gtk.glade
 import logging
-import traceback
 
 import sparkline
 import libvirt
@@ -30,6 +29,7 @@
 from virtManager.connection import vmmConnection
 from virtManager.asyncjob import vmmAsyncJob
 from virtManager.error import vmmErrorDialog
+from virtManager.delete import vmmDeleteDialog
 from virtManager import util as util
 
 VMLIST_SORT_ID = 1
@@ -118,6 +118,9 @@
                                   _(&quot;An unexpected error occurred&quot;))
         self.config = config
         self.engine = engine
+
+        self.delete_dialog = None
+
         self.prepare_vmlist()
 
         self.config.on_vmlist_domain_id_visible_changed(self.toggle_domain_id_visible_widget)
@@ -806,32 +809,31 @@
         conn = self.current_connection()
         vm = self.current_vm()
         if vm is None:
-            # Delete the connection handle
-            if conn is None:
-                return
+            self._do_delete_connection(conn)
+        else:
+            self._do_delete_vm(vm)
 
-            result = self.err.yes_no(_(&quot;Are you sure you want to permanently delete the connection %s?&quot;) % self.rows[conn.get_uri()][ROW_NAME])
-            if not result:
-                return
-            self.engine.remove_connection(conn.get_uri())
+    def _do_delete_connection(self, conn):
+        if conn is None:
+            return
+
+        result = self.err.yes_no(_(&quot;This will remove the connection \&quot;%s\&quot;,&quot;
+                                   &quot;are you sure?&quot;) %
+                                   self.rows[conn.get_uri()][ROW_NAME])
+        if not result:
+            return
+        self.engine.remove_connection(conn.get_uri())
+
+    def _do_delete_vm(self, vm):
+        if vm.is_active():
+            return
+
+        if not self.delete_dialog:
+            self.delete_dialog = vmmDeleteDialog(self.config, vm)
         else:
-            # Delete the VM itself
+            self.delete_dialog.set_vm(vm)
 
-            if vm.is_active():
-                return
-
-            # are you sure you want to delete this VM?
-            result = self.err.yes_no(_(&quot;Are you sure you want to permanently delete the virtual machine %s?&quot;) % vm.get_name())
-            if not result:
-                return
-            conn = vm.get_connection()
-            try:
-                vm.delete()
-            except Exception, e:
-                self.err.show_err(_(&quot;Error deleting domain: %s&quot; % str(e)),\
-                                  &quot;&quot;.join(traceback.format_exc()))
-                return
-            conn.tick(noStatsUpdate=True)
+        self.delete_dialog.show()
 
     def show_about(self, src):
         self.emit(&quot;action-show-about&quot;)
diff -r 311a239d48af -r bc56a6f4f2d0 src/virtManager/storagevol.py
--- a/src/virtManager/storagevol.py	Thu Mar 05 10:44:26 2009 -0500
+++ b/src/virtManager/storagevol.py	Thu Mar 05 11:23:54 2009 -0500
@@ -42,6 +42,10 @@
     def get_path(self):
         return self.vol.path()
 
+    def get_pool(self):
+        pobj = self.vol.storagePoolLookupByVolume()
+        return self.connection.get_pool_by_name(pobj.name())
+
     def delete(self):
         self.vol.delete(0)
         del(self.vol)
diff -r 311a239d48af -r bc56a6f4f2d0 src/vmm-delete.glade
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/src/vmm-delete.glade	Thu Mar 05 11:23:54 2009 -0500
@@ -0,0 +1,151 @@
+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;
+&lt;!DOCTYPE glade-interface SYSTEM &quot;glade-2.0.dtd&quot;&gt;
+&lt;!--Generated with glade3 3.4.5 on Wed Feb 25 17:45:14 2009 --&gt;
+&lt;glade-interface&gt;
+  &lt;widget class=&quot;GtkDialog&quot; id=&quot;vmm-delete&quot;&gt;
+    &lt;property name=&quot;width_request&quot;&gt;500&lt;/property&gt;
+    &lt;property name=&quot;height_request&quot;&gt;300&lt;/property&gt;
+    &lt;property name=&quot;border_width&quot;&gt;5&lt;/property&gt;
+    &lt;property name=&quot;title&quot; translatable=&quot;yes&quot;&gt;Delete Confirmation&lt;/property&gt;
+    &lt;property name=&quot;window_position&quot;&gt;GTK_WIN_POS_CENTER_ON_PARENT&lt;/property&gt;
+    &lt;property name=&quot;type_hint&quot;&gt;GDK_WINDOW_TYPE_HINT_DIALOG&lt;/property&gt;
+    &lt;property name=&quot;has_separator&quot;&gt;False&lt;/property&gt;
+    &lt;signal name=&quot;delete_event&quot; handler=&quot;on_vmm_delete_delete_event&quot;/&gt;
+    &lt;child internal-child=&quot;vbox&quot;&gt;
+      &lt;widget class=&quot;GtkVBox&quot; id=&quot;dialog-vbox1&quot;&gt;
+        &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+        &lt;property name=&quot;spacing&quot;&gt;2&lt;/property&gt;
+        &lt;child&gt;
+          &lt;widget class=&quot;GtkVBox&quot; id=&quot;vbox1&quot;&gt;
+            &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+            &lt;property name=&quot;border_width&quot;&gt;6&lt;/property&gt;
+            &lt;property name=&quot;spacing&quot;&gt;6&lt;/property&gt;
+            &lt;child&gt;
+              &lt;widget class=&quot;GtkVBox&quot; id=&quot;vbox3&quot;&gt;
+                &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+                &lt;property name=&quot;spacing&quot;&gt;3&lt;/property&gt;
+                &lt;child&gt;
+                  &lt;widget class=&quot;GtkVBox&quot; id=&quot;vbox2&quot;&gt;
+                    &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+                    &lt;property name=&quot;spacing&quot;&gt;10&lt;/property&gt;
+                    &lt;child&gt;
+                      &lt;widget class=&quot;GtkHBox&quot; id=&quot;hbox6&quot;&gt;
+                        &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+                        &lt;property name=&quot;spacing&quot;&gt;3&lt;/property&gt;
+                        &lt;child&gt;
+                          &lt;widget class=&quot;GtkImage&quot; id=&quot;image1&quot;&gt;
+                            &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+                            &lt;property name=&quot;xalign&quot;&gt;0.059999998658895493&lt;/property&gt;
+                            &lt;property name=&quot;yalign&quot;&gt;0&lt;/property&gt;
+                            &lt;property name=&quot;stock&quot;&gt;gtk-delete&lt;/property&gt;
+                          &lt;/widget&gt;
+                          &lt;packing&gt;
+                            &lt;property name=&quot;expand&quot;&gt;False&lt;/property&gt;
+                          &lt;/packing&gt;
+                        &lt;/child&gt;
+                        &lt;child&gt;
+                          &lt;widget class=&quot;GtkLabel&quot; id=&quot;delete-main-label&quot;&gt;
+                            &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+                            &lt;property name=&quot;xalign&quot;&gt;0&lt;/property&gt;
+                            &lt;property name=&quot;yalign&quot;&gt;0&lt;/property&gt;
+                            &lt;property name=&quot;label&quot;&gt;&amp;lt;span size='x-large'&amp;gt;Delete 'foo'&amp;lt;/span&amp;gt;&lt;/property&gt;
+                            &lt;property name=&quot;use_markup&quot;&gt;True&lt;/property&gt;
+                          &lt;/widget&gt;
+                          &lt;packing&gt;
+                            &lt;property name=&quot;expand&quot;&gt;False&lt;/property&gt;
+                            &lt;property name=&quot;fill&quot;&gt;False&lt;/property&gt;
+                            &lt;property name=&quot;position&quot;&gt;1&lt;/property&gt;
+                          &lt;/packing&gt;
+                        &lt;/child&gt;
+                      &lt;/widget&gt;
+                      &lt;packing&gt;
+                        &lt;property name=&quot;expand&quot;&gt;False&lt;/property&gt;
+                      &lt;/packing&gt;
+                    &lt;/child&gt;
+                    &lt;child&gt;
+                      &lt;widget class=&quot;GtkCheckButton&quot; id=&quot;delete-remove-storage&quot;&gt;
+                        &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+                        &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
+                        &lt;property name=&quot;label&quot; translatable=&quot;yes&quot;&gt;Delete associated storage files&lt;/property&gt;
+                        &lt;property name=&quot;response_id&quot;&gt;0&lt;/property&gt;
+                        &lt;property name=&quot;draw_indicator&quot;&gt;True&lt;/property&gt;
+                        &lt;signal name=&quot;toggled&quot; handler=&quot;on_delete_remove_storage_toggled&quot;/&gt;
+                      &lt;/widget&gt;
+                      &lt;packing&gt;
+                        &lt;property name=&quot;expand&quot;&gt;False&lt;/property&gt;
+                        &lt;property name=&quot;position&quot;&gt;1&lt;/property&gt;
+                      &lt;/packing&gt;
+                    &lt;/child&gt;
+                  &lt;/widget&gt;
+                  &lt;packing&gt;
+                    &lt;property name=&quot;expand&quot;&gt;False&lt;/property&gt;
+                  &lt;/packing&gt;
+                &lt;/child&gt;
+              &lt;/widget&gt;
+              &lt;packing&gt;
+                &lt;property name=&quot;expand&quot;&gt;False&lt;/property&gt;
+              &lt;/packing&gt;
+            &lt;/child&gt;
+            &lt;child&gt;
+              &lt;widget class=&quot;GtkScrolledWindow&quot; id=&quot;scrolledwindow1&quot;&gt;
+                &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+                &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
+                &lt;property name=&quot;hscrollbar_policy&quot;&gt;GTK_POLICY_AUTOMATIC&lt;/property&gt;
+                &lt;property name=&quot;vscrollbar_policy&quot;&gt;GTK_POLICY_AUTOMATIC&lt;/property&gt;
+                &lt;property name=&quot;shadow_type&quot;&gt;GTK_SHADOW_ETCHED_IN&lt;/property&gt;
+                &lt;child&gt;
+                  &lt;widget class=&quot;GtkTreeView&quot; id=&quot;delete-storage-list&quot;&gt;
+                    &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+                    &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
+                    &lt;property name=&quot;headers_clickable&quot;&gt;True&lt;/property&gt;
+                  &lt;/widget&gt;
+                &lt;/child&gt;
+              &lt;/widget&gt;
+              &lt;packing&gt;
+                &lt;property name=&quot;position&quot;&gt;1&lt;/property&gt;
+              &lt;/packing&gt;
+            &lt;/child&gt;
+          &lt;/widget&gt;
+          &lt;packing&gt;
+            &lt;property name=&quot;position&quot;&gt;1&lt;/property&gt;
+          &lt;/packing&gt;
+        &lt;/child&gt;
+        &lt;child internal-child=&quot;action_area&quot;&gt;
+          &lt;widget class=&quot;GtkHButtonBox&quot; id=&quot;dialog-action_area1&quot;&gt;
+            &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+            &lt;property name=&quot;layout_style&quot;&gt;GTK_BUTTONBOX_END&lt;/property&gt;
+            &lt;child&gt;
+              &lt;widget class=&quot;GtkButton&quot; id=&quot;delete-ok&quot;&gt;
+                &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+                &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
+                &lt;property name=&quot;receives_default&quot;&gt;True&lt;/property&gt;
+                &lt;property name=&quot;label&quot; translatable=&quot;yes&quot;&gt;gtk-delete&lt;/property&gt;
+                &lt;property name=&quot;use_stock&quot;&gt;True&lt;/property&gt;
+                &lt;property name=&quot;response_id&quot;&gt;0&lt;/property&gt;
+                &lt;signal name=&quot;clicked&quot; handler=&quot;on_delete_ok_clicked&quot;/&gt;
+              &lt;/widget&gt;
+            &lt;/child&gt;
+            &lt;child&gt;
+              &lt;widget class=&quot;GtkButton&quot; id=&quot;delete-cancel&quot;&gt;
+                &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+                &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
+                &lt;property name=&quot;receives_default&quot;&gt;True&lt;/property&gt;
+                &lt;property name=&quot;label&quot; translatable=&quot;yes&quot;&gt;gtk-cancel&lt;/property&gt;
+                &lt;property name=&quot;use_stock&quot;&gt;True&lt;/property&gt;
+                &lt;property name=&quot;response_id&quot;&gt;0&lt;/property&gt;
+                &lt;signal name=&quot;clicked&quot; handler=&quot;on_delete_cancel_clicked&quot;/&gt;
+              &lt;/widget&gt;
+              &lt;packing&gt;
+                &lt;property name=&quot;position&quot;&gt;1&lt;/property&gt;
+              &lt;/packing&gt;
+            &lt;/child&gt;
+          &lt;/widget&gt;
+          &lt;packing&gt;
+            &lt;property name=&quot;expand&quot;&gt;False&lt;/property&gt;
+            &lt;property name=&quot;pack_type&quot;&gt;GTK_PACK_END&lt;/property&gt;
+          &lt;/packing&gt;
+        &lt;/child&gt;
+      &lt;/widget&gt;
+    &lt;/child&gt;
+  &lt;/widget&gt;
+&lt;/glade-interface&gt;
</pre><pre>_______________________________________________
et-mgmt-tools mailing list
et-mgmt-tools@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/et-mgmt-tools">https://www.redhat.com/mailman/listinfo/et-mgmt-tools</a></pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="04774" href="msg04774.html">Re:  [PATCH] virt-manager: Storage aware delete dialog</a></strong>
<ul><li><em>From:</em> Cole Robinson</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg04763.html">Re:  Configuration of the virt-manager</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg04765.html">[PATCH] virt-manager: Redesigned 'New VM' wizard	ver 2</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg04761.html">There seems to be an issue with the 'file browse'	button</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg04774.html">Re:  [PATCH] virt-manager: Storage aware delete dialog</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#04764"><strong>Date</strong></a></li>
<li><a href="index.html#04764"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fll/>[Fedora&nbsp;Legacy&nbsp;List]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-maintainers/>[Fedora&nbsp;Maintainers]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.html>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH] virt&#45;install: Add &#45;&#45;serial and &#45;&#45;parallel	options -->
<!--X-From-R13: Qbyr Dbovafba &#60;pebovafbNerqung.pbz> -->
<!--X-Date: Thu, 9 Jul 2009 12:21:58 &#45;0700 -->
<!--X-Message-Id: 4A56445A.9000009@redhat.com -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Fedora Management Tools, [PATCH] virt-install: Add --serial and --parallel	options">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<link rel="alternate" type="application/rss+xml" title="Fedora Management Tools" href="//feedproxy.google.com/Fedora/linuxManagementTools">
<title>Fedora Management Tools -- [PATCH] virt-install: Add --serial and --parallel	options</title>
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH] virt-install: Add --serial and --parallel	options</h1>
[<a href="msg05016.html">Date Prev</a>][<a href="msg05018.html">Date Next</a>][<a href="msg05016.html">Thread Prev</a>][<a href="msg05029.html">Thread Next</a>][<a href="maillist.html#05017">Date Index</a>][<a href="index.html#05017">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH] virt-install: Add --serial and --parallel	options</li>
<li><em>From</em>: Cole Robinson &lt;<a href="mailto:crobinso@DOMAIN.HIDDEN">crobinso@xxxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Thu, 09 Jul 2009 15:26:18 -0400</li>
<li><em>Reply-to</em>: Fedora/Linux Management Tools &lt;<a href="mailto:et-mgmt-tools@DOMAIN.HIDDEN">et-mgmt-tools@xxxxxxxxxx</a>&gt;</li>
<li><em>User-agent</em>: Thunderbird 2.0.0.21 (X11/20090320)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>The attached patch adds --serial and --parallel options to virt-install, for
attaching the respective devices to the new VM. Isn't much to say here, some
examples explain it all:

Serial PTY:

--serial pty

Parallel to a file:

--serial file,path=/tmp/foo.log

TCP net console in server mode, using telnet format:

--serial tcp,host=0.0.0.0:2222,mode=bind,protocol=telnet

UDP net console, sending output to the specified host:

--serial udp,host=192.168.10.20:4444

The man page has examples for several other types as well. --serial and
--parallel share the same option format, as they do in the libvirt xml.

Any questions or comments appreciated.

- Cole
</pre><pre># HG changeset patch
# User Cole Robinson &lt;crobinso@xxxxxxxxxx&gt;
# Date 1247102899 14400
# Node ID 7751290d749d678e6a97a32ea5455af6e2226e78
# Parent  77b5e67be942bd75e5226612ee5fa5ab36c8a56d
virt-install: Add --serial and --parallel options.

Options take the same form of OPT1=VAL1,OPT2=VAL2,... similar to the --disk
option. The docs describe the rest.

diff -r 77b5e67be942 -r 7751290d749d man/en/virt-install.pod.in
--- a/man/en/virt-install.pod.in	Wed Jul 08 21:23:32 2009 -0400
+++ b/man/en/virt-install.pod.in	Wed Jul 08 21:28:19 2009 -0400
@@ -150,6 +150,82 @@
 
 Attach a virtual audio device to the guest.
 
+=item --parallel=CHAROPTS
+
+=item --serial=CHAROPTS
+
+Specifies a serial device to attach to the guest, with various options. The
+general format of a serial string is
+
+    --serial type,opt1=val1,opt2=val2,...
+
+--serial and --parallel devices share all the same options, unless otherwise
+noted. Some of the types of character device redirection are:
+
+=over 4
+
+=item B&lt;--serial pty&gt;
+
+Psuedo TTY. The allocated pty will be listed in the running guests XML
+description.
+
+=item B&lt;--serial dev,path=HOSTPATH&gt;
+
+Host device. For serial devices, this could be /dev/ttyS0. For parallel
+devices, this could be /dev/parport0.
+
+=item B&lt;--serial file,path=FILENAME&gt;
+
+Write output to FILENAME.
+
+=item B&lt;--serial pipe,path=PIPEPATH&gt;
+
+Named pipe (see pipe(7))
+
+=item B&lt;--serial tcp,host=HOST:PORT,mode=MODE,protocol=PROTOCOL&gt;
+
+TCP net console. MODE is either 'bind' (wait for connections on HOST:PORT)
+or 'connect' (send output to HOST:PORT), default is 'connect'. HOST defaults
+to '127.0.0.1', but PORT is required. PROTOCOL can be either 'raw' or 'telnet'
+(default 'raw'). If 'telnet', the port acts like a telnet server or client.
+Some examples:
+
+Connect to localhost, port 1234:
+
+--serial tcp,host=:1234
+
+Wait for connections on any address, port 4567:
+
+--serial tcp,host=0.0.0.0:4567,mode=bind
+
+Wait for telnet connection on localhost, port 2222. The user could then
+connect interactively to this console via 'telnet localhost 2222':
+
+--serial tcp,host=:2222,mode=bind,protocol=telnet
+
+=item B&lt;--serial udp,host=CONNECT_HOST:PORT,bind_port=BIND_HOST:BIND_PORT&gt;
+
+UDP net console. HOST:PORT is the destination to send output to (default
+HOST is '127.0.0.1', PORT is required. BIND_HOST:PORT is the optional local
+address to bind to (default BIND_HOST is 127.0.0.1, but is only set if
+BIND_PORT is specified.) Some examples:
+
+Send output to default syslog port (may need to edit /etc/rsyslog.conf
+accordingly):
+
+--serial udp,host=:514
+
+Send output to remote host 192.168.10.20, port 4444 (this output can be
+read on the remote host using 'nc -u -l 4444':
+
+--serial udp,host=192.168.10.20:4444
+
+=item B&lt;--serial unix,path=UNIXPATH,mode=MODE&gt;
+
+Unix socket (see unix(7). MODE has similar behavior and defaults as 'tcp'.
+
+=back
+
 =item  --noapic
 
 Override the OS type / variant to disables the APIC setting for fully
diff -r 77b5e67be942 -r 7751290d749d tests/clitest.py
--- a/tests/clitest.py	Wed Jul 08 21:23:32 2009 -0400
+++ b/tests/clitest.py	Wed Jul 08 21:28:19 2009 -0400
@@ -211,6 +211,36 @@
 
      }, # category &quot;graphics&quot;
 
+    &quot;char&quot; : {
+     &quot;char_args&quot;: &quot;--hvm --nographics --noautoconsole --nodisks --pxe&quot;,
+
+     &quot;valid&quot;: [
+        # Simple devs
+        &quot;--serial pty --parallel null&quot;,
+        # Some with options
+        &quot;--serial file,path=/tmp/foo --parallel unix,path=/tmp/foo --parallel null&quot;,
+        # UDP
+        &quot;--parallel udp,host=0.0.0.0:1234,bind_host=127.0.0.1:1234&quot;,
+        # TCP
+        &quot;--serial tcp,mode=bind,host=0.0.0.0:1234&quot;,
+        # Unix
+        &quot;--parallel unix,path=/tmp/foo-socket&quot;,
+        # TCP w/ telnet
+        &quot;--serial tcp,host=:1234,protocol=telnet&quot;,
+     ],
+     &quot;invalid&quot; : [
+        # Bogus device type
+        &quot;--parallel foobah&quot;,
+        # Unix with no path
+        &quot;--serial unix&quot;,
+        # Path where it doesn't belong
+        &quot;--serial null,path=/tmp/foo&quot;,
+        # Nonexistent argument
+        &quot;--serial udp,host=:1234,frob=baz&quot;,
+     ],
+
+     }, # category 'char'
+
      &quot;misc&quot;: {
       &quot;misc_args&quot;: &quot;--nographics --noautoconsole&quot;,
 
diff -r 77b5e67be942 -r 7751290d749d virt-install
--- a/virt-install	Wed Jul 08 21:23:32 2009 -0400
+++ b/virt-install	Wed Jul 08 21:28:19 2009 -0400
@@ -33,6 +33,8 @@
 import virtinst
 import virtinst.CapabilitiesParser
 import virtinst.cli as cli
+from virtinst.VirtualCharDevice import VirtualCharDevice
+from virtinst.VirtualDevice import VirtualDevice
 from virtinst.cli import fail
 
 import gettext
@@ -45,6 +47,17 @@
 DEFAULT_POOL_PATH = &quot;/var/lib/libvirt/images&quot;
 DEFAULT_POOL_NAME = &quot;default&quot;
 
+def partition(string, sep):
+    if not string:
+        return (None, None, None)
+
+    if string.count(sep):
+        splitres = string.split(sep, 1)
+        ret = (splitres[0], sep, splitres[1])
+    else:
+        ret = (string, None, None)
+    return ret
+
 def build_default_pool(guest):
 
     if not virtinst.util.is_storage_capable(guest.conn):
@@ -71,6 +84,70 @@
         raise RuntimeError(_(&quot;Couldn't create default storage pool '%s': %s&quot;) %
                              (DEFAULT_POOL_PATH, str(e)))
 
+def parse_char_option(guest, char_type, optstring):
+    &quot;&quot;&quot;
+    Helper to parse --serial/--parallel options
+    &quot;&quot;&quot;
+    # Peel the char type off the front
+    dev_type, ignore, optstring = partition(optstring, &quot;,&quot;)
+
+    opts = cli.parse_optstr(optstring)
+
+    dev = VirtualCharDevice.get_dev_instance(guest.conn, char_type, dev_type)
+
+    def set_param(paramname, dictname, val=None):
+        if not val:
+            if opts.has_key(dictname):
+                val = opts[dictname]
+                del(opts[dictname])
+            else:
+                return
+
+        if not hasattr(dev, paramname):
+            raise ValueError(_(&quot;%(chartype)s type %(devtype)s does not &quot;
+                                &quot;support '%(optname)s' option.&quot;) %
+                                {&quot;chartype&quot; : char_type, &quot;devtype&quot;: dev_type,
+                                 &quot;optname&quot; : dictname} )
+        setattr(dev, paramname, val)
+
+    def parse_host(key):
+        host, ignore, port = partition(opts.get(key), &quot;:&quot;)
+        if opts.has_key(key):
+            del(opts[key])
+
+        return host, port
+
+    host, port = parse_host(&quot;host&quot;)
+    bind_host, bind_port = parse_host(&quot;bind_host&quot;)
+
+    set_param(&quot;source_path&quot;, &quot;path&quot;)
+    set_param(&quot;source_mode&quot;, &quot;mode&quot;)
+    set_param(&quot;protocol&quot;,   &quot;protocol&quot;)
+    set_param(&quot;source_host&quot;, &quot;host&quot;, host)
+    set_param(&quot;source_port&quot;, &quot;host&quot;, port)
+    set_param(&quot;bind_host&quot;, &quot;bind_host&quot;, bind_host)
+    set_param(&quot;bind_port&quot;, &quot;bind_host&quot;, bind_port)
+
+    # If extra parameters, then user passed some garbage param
+    if opts:
+        raise ValueError(_(&quot;Unknown option(s) %s&quot;) % opts.keys())
+
+    # Try to generate dev XML to perform upfront validation
+    dev.get_xml_config()
+
+    return dev
+
+def get_chardevs(char_type, opts, guest):
+
+    for optstr in cli.listify(opts):
+        try:
+            dev = parse_char_option(guest, char_type, optstr)
+            guest.add_device(dev)
+        except Exception, e:
+            fail(_(&quot;Error in %(chartype)s device parameters: %(err)s&quot;) %
+                 {&quot;chartype&quot;: char_type, &quot;err&quot;: str(e) })
+
+
 def parse_disk_option(guest, path, size):
     &quot;&quot;&quot;helper to properly parse --disk options&quot;&quot;&quot;
     abspath = None
@@ -81,14 +158,6 @@
     sparse = True
     option_whitelist = [&quot;perms&quot;, &quot;cache&quot;, &quot;bus&quot;, &quot;device&quot;, &quot;size&quot;, &quot;sparse&quot;]
 
-    def partition(string, sep):
-        if string.count(sep):
-            splitres = string.split(sep, 1)
-            ret = (splitres[0], sep, splitres[1])
-        else:
-            ret = (string, None, None)
-        return ret
-
     # Strip media type
     path, ignore, optstr = partition(path, &quot;,&quot;)
     if path.startswith(&quot;path=&quot;):
@@ -459,6 +528,12 @@
                       action=&quot;callback&quot;, callback=cli.check_before_store,
                       help=_(&quot;The OS variant for fully virtualized guests, &quot;
                              &quot;e.g. 'fedora6', 'rhel5', 'solaris10', 'win2k'&quot;))
+    geng.add_option(&quot;&quot;, &quot;--serial&quot;, type=&quot;string&quot;, dest=&quot;serials&quot;,
+                    action=&quot;callback&quot;, callback=cli.check_before_append,
+                    help=_(&quot;Add a serial device to the domain.&quot;))
+    geng.add_option(&quot;&quot;, &quot;--parallel&quot;, type=&quot;string&quot;, dest=&quot;parallels&quot;,
+                    action=&quot;callback&quot;, callback=cli.check_before_append,
+                    help=_(&quot;Add a parallel device to the domain.&quot;))
     geng.add_option(&quot;&quot;, &quot;--host-device&quot;, type=&quot;string&quot;, dest=&quot;hostdevs&quot;,
                     action=&quot;callback&quot;, callback=cli.check_before_append,
                     help=_(&quot;Physical host device to attach to the domain.&quot;))
@@ -549,7 +624,6 @@
     netg.add_option(&quot;-m&quot;, &quot;--mac&quot;, type=&quot;string&quot;, dest=&quot;mac&quot;,
                     action=&quot;callback&quot;, callback=cli.check_before_append,
                     help=optparse.SUPPRESS_HELP)
-
     parser.add_option_group(netg)
 
     vncg = cli.graphics_option_group(parser)
@@ -661,6 +735,9 @@
     cli.get_cpuset(options.cpuset, guest.memory, guest, conn)
     if ishvm:
         cli.get_sound(options.sound, guest)
+        get_chardevs(VirtualDevice.VIRTUAL_DEV_SERIAL, options.serials, guest)
+        get_chardevs(VirtualDevice.VIRTUAL_DEV_PARALLEL, options.parallels,
+                     guest)
 
     # set up disks
     get_disks(options.file_path, options.diskopts, options.disksize,
diff -r 77b5e67be942 -r 7751290d749d virtinst/cli.py
--- a/virtinst/cli.py	Wed Jul 08 21:23:32 2009 -0400
+++ b/virtinst/cli.py	Wed Jul 08 21:28:19 2009 -0400
@@ -452,6 +452,14 @@
 # Ask for attributes
 #
 
+def listify(l):
+    if l is None:
+        return []
+    elif type(l) != list:
+        return [ l ]
+    else:
+        return l
+
 def get_name(name, guest, image_name=None):
     prompt_txt = _(&quot;What is the name of your virtual machine?&quot;)
     err_txt = _(&quot;A name is required for the virtual machine.&quot;)
@@ -614,14 +622,6 @@
              &quot;network&quot; : network_name, &quot;model&quot; : model , &quot;macaddr&quot; : mac }
 
 def digest_networks(conn, macs, bridges, networks, nics = 0):
-    def listify(l):
-        if l is None:
-            return []
-        elif type(l) != list:
-            return [ l ]
-        else:
-            return l
-
     macs     = listify(macs)
     bridges  = listify(bridges)
     networks = listify(networks)
</pre><pre>_______________________________________________
et-mgmt-tools mailing list
et-mgmt-tools@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/et-mgmt-tools">https://www.redhat.com/mailman/listinfo/et-mgmt-tools</a></pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="05029" href="msg05029.html">Re:  [PATCH] virt-install: Add --serial and --parallel	options</a></strong>
<ul><li><em>From:</em> Cole Robinson</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg05016.html">virt-df compilation under Debian GNU/Linux</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg05018.html">[PATCH] virt-install: Add --video option</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg05016.html">virt-df compilation under Debian GNU/Linux</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg05029.html">Re:  [PATCH] virt-install: Add --serial and --parallel	options</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#05017"><strong>Date</strong></a></li>
<li><a href="index.html#05017"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fll/>[Fedora&nbsp;Legacy&nbsp;List]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-maintainers/>[Fedora&nbsp;Maintainers]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.html>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

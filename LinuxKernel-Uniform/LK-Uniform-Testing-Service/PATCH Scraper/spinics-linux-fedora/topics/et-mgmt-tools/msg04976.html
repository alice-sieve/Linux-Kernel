<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH] virt&#45;manager: Make virt&#45;manager remember	last image directory -->
<!--X-From-R13: [vpuny @bibgal &#60;zvabibgaNerqung.pbz> -->
<!--X-Date: Thu, 18 Jun 2009 02:15:23 &#45;0700 -->
<!--X-Message-Id: 4A3A05B4.9050107@redhat.com -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: 4A37ABA0.4010903@redhat.com -->
<!--X-Reference: 4A39A423.3030707@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Fedora Management Tools, Re:  [PATCH] virt-manager: Make virt-manager remember	last image directory">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<link rel="alternate" type="application/rss+xml" title="Fedora Management Tools" href="//feedproxy.google.com/Fedora/linuxManagementTools">
<title>Fedora Management Tools -- Re:  [PATCH] virt-manager: Make virt-manager remember	last image directory</title>
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [PATCH] virt-manager: Make virt-manager remember	last image directory</h1>
[<a href="msg04975.html">Date Prev</a>][<a href="msg04977.html">Date Next</a>][<a href="msg04975.html">Thread Prev</a>][<a href="msg04978.html">Thread Next</a>][<a href="maillist.html#04976">Date Index</a>][<a href="index.html#04976">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH] virt-manager: Make virt-manager remember	last image directory</li>
<li><em>From</em>: Michal Novotny &lt;<a href="mailto:minovotn@DOMAIN.HIDDEN">minovotn@xxxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Thu, 18 Jun 2009 11:15:32 +0200</li>
<li><em>Cc</em>: Fedora/Linux Management Tools &lt;<a href="mailto:et-mgmt-tools@DOMAIN.HIDDEN">et-mgmt-tools@xxxxxxxxxx</a>&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="mailto:4A39A423.3030707@DOMAIN.HIDDEN">4A39A423.3030707@xxxxxxxxxx</a>&gt;</li>
<li><em>References</em>: &lt;<a href="mailto:4A37ABA0.4010903@DOMAIN.HIDDEN">4A37ABA0.4010903@xxxxxxxxxx</a>&gt; &lt;<a href="mailto:4A39A423.3030707@DOMAIN.HIDDEN">4A39A423.3030707@xxxxxxxxxx</a>&gt;</li>
<li><em>Reply-to</em>: Fedora/Linux Management Tools &lt;<a href="mailto:et-mgmt-tools@DOMAIN.HIDDEN">et-mgmt-tools@xxxxxxxxxx</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; U; Linux x86_64; en-US;	rv:1.9.1b3pre) Gecko/20090513 Fedora/3.0-2.3.beta2.fc11	Thunderbird/3.0b2</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<table width="100%"><tr><td bgcolor="#ffffff" style="background-color: #ffffff; color: #000000; "><font color="#000000">



On 06/18/2009 04:19 AM, Cole Robinson wrote:
<blockquote cite="" type="cite">
  <pre wrap="">On 06/16/2009 10:26 AM, Michal Novotny wrote:
  </pre>
  <blockquote type="cite">
    <pre wrap=""># HG changeset patch
# User Michal Novotny <a rel="nofollow" class="moz-txt-link-rfc2396E" href="mailto:minovotn@xxxxxxxxxx">&lt;minovotn@xxxxxxxxxx&gt;</a>
# Date 1245162093 -7200
# Node ID 73427fcfc222006d7f74ce79277f8432d74d7c52
# Parent  74f1f8309b139af9d84edfb1f0186c2306c0f332
Make virt-manager remember last chosen image directory

Virt-manager never remembers last image directory after choosing file an image
file to be appended to any domain. Since I am having all the domain image files
in the same directory that is not default, this patch saves the last image path
to gconf configuration file and offers it as startfolder next time.

    </pre>
  </blockquote>
  <pre wrap=""><!---->
I like the idea in principle, but I think it needs to be a bit smarter.

I have a fix pending that will enable the storage browser for install media on
a local connection. We won't want the storage browser squashing the
default_image_path in that case, since there's a good chance that their media
directory and image directory are not the same.
  </pre>
</blockquote>
Ok, basically I agree. Is there a way to get to know whether we're
choosing media or an image in StorageBrowser (SB, for short) class ?<br>
<blockquote cite="" type="cite">
  <pre wrap="">
We should have two gconf entries: /paths/last_image_path and
/paths/last_media_path, and give the storage_browser a flag or something to
allow the caller to opt in on which gconf entry we want to store. There's
probably a smarter way to do it but I can't think right now.
  </pre>
</blockquote>
Yeah, that's exactly why I ask. So, if there is no flag, there is a
need to add some for SB. The SB itself stores the data in my code...
Anyway you said you have one patch pending, right? What exactly about?<br>
<blockquote cite="" type="cite">
  <pre wrap="">
A general comment: the gconf entries should change the virt-manager.schema.in.
You can probably just use a default value of "", that way gconf won't throw an
exception the first time you try to access the key.
  </pre>
</blockquote>
Ok, I didn't know that. This needs further study but now I need to
solve things about Xen that I am primarily working on.<br>
<blockquote cite="" type="cite">
  <pre wrap="">
Some comments in line
  </pre>
</blockquote>
Ok, I'll comment it too.<br>
<blockquote cite="" type="cite">
  <blockquote type="cite">
    <pre wrap="">diff -r 74f1f8309b13 -r 73427fcfc222 src/virtManager/addhardware.py
--- a/src/virtManager/addhardware.py	Mon Jun 15 15:54:56 2009 +0200
+++ b/src/virtManager/addhardware.py	Tue Jun 16 16:21:33 2009 +0200
@@ -674,7 +674,7 @@
 
     def browse_storage_file_address(self, src, ignore=None):
         textent = self.window.get_widget("storage-file-address")
-        folder = self.config.get_default_image_dir(self.vm.get_connection())
+        folder = self.config.get_user_default_image_dir(self.vm.get_connection())
         filename = self._browse_file(_("Locate or Create New Storage File"),
                                      textent, folder=folder,
                                      confirm_overwrite=True)
diff -r 74f1f8309b13 -r 73427fcfc222 src/virtManager/config.py
--- a/src/virtManager/config.py	Mon Jun 15 15:54:56 2009 +0200
+++ b/src/virtManager/config.py	Tue Jun 16 16:21:33 2009 +0200
@@ -237,7 +237,15 @@
     def is_vmlist_network_traffic_visible(self):
         return self.conf.get_bool(self.conf_dir + "/vmlist-fields/network_traffic")
 
+    def get_user_default_image_dir(self, conn):
+        try:
+            return self.conf.get_value(self.conf_dir + "/paths/default_image_path")
+        except ValueError:
+            return self.get_default_image_dir(conn)
 
+    def set_user_default_image_dir(self, dir):
+        self.conf.set_value(self.conf_dir + "/paths/default_image_path", dir)
+        logging.debug("Setting path to %s", dir)
 
     def set_vmlist_domain_id_visible(self, state):
         self.conf.set_bool(self.conf_dir + "/vmlist-fields/domain_id", state)
@@ -556,6 +564,14 @@
 
 
     def get_default_image_dir(self, connection):
+        # Exception for case connection argument is str (happens when
+        # creating new domains because we don't have connection object)
+        if str(connection) == connection:
+            if connection == "Xen":
+                return DEFAULT_XEN_IMAGE_DIR
+            else:
+                return DEFAULT_VIRT_IMAGE_DIR
+
         if connection.get_type() == "Xen":
             return DEFAULT_XEN_IMAGE_DIR
 
    </pre>
  </blockquote>
  <pre wrap=""><!---->
The hack shouldn't be necessary (see below).
  </pre>
</blockquote>
I see, so there's a valid connection object in self.conn that provides
"vmmConnection" (or some) object even when we are creating the domain
(ie. it doesn't exist yet) ?<br>
<blockquote cite="" type="cite">
  <pre wrap="">
  </pre>
  <blockquote type="cite">
    <pre wrap="">diff -r 74f1f8309b13 -r 73427fcfc222 src/virtManager/create.py
--- a/src/virtManager/create.py	Mon Jun 15 15:54:56 2009 +0200
+++ b/src/virtManager/create.py	Tue Jun 16 16:21:33 2009 +0200
@@ -1004,7 +1004,8 @@
         self.window.get_widget("config-storage-box").set_sensitive(src.get_active())
 
     def browse_storage(self, ignore1):
-        f = self._browse_file(_("Locate existing storage"))
+        folder = self.config.get_user_default_image_dir( self.capsdomain.hypervisor_type )
+        f = self._browse_file(_("Locate existing storage"), folder=folder)
         if f != None:
             self.window.get_widget("config-storage-entry").set_text(f)

    </pre>
  </blockquote>
  <pre wrap=""><!---->
'self.conn' contains the active connection, so you should use that rather than
self.capsdomain...

  </pre>
</blockquote>
Ok, even in domain creation we have this object ?<br>
<blockquote cite="" type="cite">
  <pre wrap=""></pre>
  <blockquote type="cite">
    <pre wrap="">@@ -1653,7 +1654,6 @@
             self.detectedDistro = (None, None)
 
     def _browse_file(self, dialog_name, folder=None, is_media=False):
-
         if self.conn.is_remote() or not is_media:
             if self.storage_browser == None:
                 self.storage_browser = vmmStorageBrowser(self.config,
diff -r 74f1f8309b13 -r 73427fcfc222 src/virtManager/storagebrowse.py
--- a/src/virtManager/storagebrowse.py	Mon Jun 15 15:54:56 2009 +0200
+++ b/src/virtManager/storagebrowse.py	Tue Jun 16 16:21:33 2009 +0200
@@ -20,6 +20,7 @@
 
 import gobject
 import gtk.glade
+import os.path
 
 import traceback
 import logging
@@ -242,6 +243,11 @@
     def _do_finish(self, path=None):
         if not path:
             path = self.current_vol().get_path()
+
+        # Save path to config if we use file as storage
+        if "/dev" not in path:
+            self.config.set_user_default_image_dir( os.path.dirname(path) )
+
    </pre>
  </blockquote>
  <pre wrap=""><!---->
A couple things here: This will match any path which contains "/dev", you
probably want path.startswith(). Also, this will store the directory of a
chosen storage volume, which isn't what we want. If you make this chunk the
first thing that happens in the function, it should be fine.

  </pre>
</blockquote>
Oh, right. This is right. I didn't realized that function would be
better, thanks for your input. This isn't what we won't ? Why not? I
thought we want to strip eg. /disk2/vms/vm1/image.img to get
/disk2/vms/vm1/ and this is what we want, right ? Or could you give me
an example why not this approach?<br>
<blockquote cite="" type="cite">
  <pre wrap=""></pre>
  <blockquote type="cite">
    <pre wrap="">         self.emit("storage-browse-finish", path)
         self.close()
    </pre>
  </blockquote>
  <pre wrap=""><!---->
Thanks,
Cole
  </pre>
</blockquote>
Thanks,<br>
Michal<br>


</font></td></tr></table><pre>_______________________________________________
et-mgmt-tools mailing list
et-mgmt-tools@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/et-mgmt-tools">https://www.redhat.com/mailman/listinfo/et-mgmt-tools</a></pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="04980" href="msg04980.html">Re:  [PATCH] virt-manager: Make virt-manager remember	last image directory</a></strong>
<ul><li><em>From:</em> Michal Novotny</li></ul></li>
<li><strong><a name="04978" href="msg04978.html">Re:  [PATCH] virt-manager: Make virt-manager remember	last image directory</a></strong>
<ul><li><em>From:</em> Cole Robinson</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="04964" href="msg04964.html">[PATCH] virt-manager: Make virt-manager remember	last image directory</a></strong>
<ul><li><em>From:</em> Michal Novotny</li></ul></li>
<li><strong><a name="04975" href="msg04975.html">Re:  [PATCH] virt-manager: Make virt-manager remember	last image directory</a></strong>
<ul><li><em>From:</em> Cole Robinson</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg04975.html">Re:  [PATCH] virt-manager: Make virt-manager remember	last image directory</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg04977.html">Re:  tftp config for virt-manager or virt-install</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg04975.html">Re:  [PATCH] virt-manager: Make virt-manager remember	last image directory</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg04978.html">Re:  [PATCH] virt-manager: Make virt-manager remember	last image directory</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#04976"><strong>Date</strong></a></li>
<li><a href="index.html#04976"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fll/>[Fedora&nbsp;Legacy&nbsp;List]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-maintainers/>[Fedora&nbsp;Maintainers]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.html>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

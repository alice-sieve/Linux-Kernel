<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH] virt&#45;manager: Make virt&#45;manager remember	last image directory -->
<!--X-From-R13: Qbyr Dbovafba &#60;pebovafbNerqung.pbz> -->
<!--X-Date: Thu, 18 Jun 2009 05:39:16 &#45;0700 -->
<!--X-Message-Id: 4A3A3571.9000303@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 4A37ABA0.4010903@redhat.com -->
<!--X-Reference: 4A39A423.3030707@redhat.com -->
<!--X-Reference: 4A3A05B4.9050107@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Fedora Management Tools, Re:  [PATCH] virt-manager: Make virt-manager remember	last image directory">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<link rel="alternate" type="application/rss+xml" title="Fedora Management Tools" href="//feedproxy.google.com/Fedora/linuxManagementTools">
<title>Fedora Management Tools -- Re:  [PATCH] virt-manager: Make virt-manager remember	last image directory</title>
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [PATCH] virt-manager: Make virt-manager remember	last image directory</h1>
[<a href="msg04977.html">Date Prev</a>][<a href="msg04979.html">Date Next</a>][<a href="msg04976.html">Thread Prev</a>][<a href="msg04980.html">Thread Next</a>][<a href="maillist.html#04978">Date Index</a>][<a href="index.html#04978">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH] virt-manager: Make virt-manager remember	last image directory</li>
<li><em>From</em>: Cole Robinson &lt;<a href="mailto:crobinso@DOMAIN.HIDDEN">crobinso@xxxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Thu, 18 Jun 2009 08:39:13 -0400</li>
<li><em>Cc</em>: Fedora/Linux Management Tools &lt;<a href="mailto:et-mgmt-tools@DOMAIN.HIDDEN">et-mgmt-tools@xxxxxxxxxx</a>&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="mailto:4A3A05B4.9050107@DOMAIN.HIDDEN">4A3A05B4.9050107@xxxxxxxxxx</a>&gt;</li>
<li><em>References</em>: &lt;<a href="mailto:4A37ABA0.4010903@DOMAIN.HIDDEN">4A37ABA0.4010903@xxxxxxxxxx</a>&gt; &lt;<a href="mailto:4A39A423.3030707@DOMAIN.HIDDEN">4A39A423.3030707@xxxxxxxxxx</a>&gt;	&lt;<a href="mailto:4A3A05B4.9050107@DOMAIN.HIDDEN">4A3A05B4.9050107@xxxxxxxxxx</a>&gt;</li>
<li><em>Reply-to</em>: Fedora/Linux Management Tools &lt;<a href="mailto:et-mgmt-tools@DOMAIN.HIDDEN">et-mgmt-tools@xxxxxxxxxx</a>&gt;</li>
<li><em>User-agent</em>: Thunderbird 2.0.0.19 (X11/20090105)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Michal Novotny wrote:
&gt; On 06/18/2009 04:19 AM, Cole Robinson wrote:
&gt;&gt; On 06/16/2009 10:26 AM, Michal Novotny wrote:
&gt;&gt;    
&gt;&gt;&gt; # HG changeset patch
&gt;&gt;&gt; # User Michal Novotny&lt;minovotn@xxxxxxxxxx&gt;
&gt;&gt;&gt; # Date 1245162093 -7200
&gt;&gt;&gt; # Node ID 73427fcfc222006d7f74ce79277f8432d74d7c52
&gt;&gt;&gt; # Parent  74f1f8309b139af9d84edfb1f0186c2306c0f332
&gt;&gt;&gt; Make virt-manager remember last chosen image directory
&gt;&gt;&gt;
&gt;&gt;&gt; Virt-manager never remembers last image directory after choosing file an image
&gt;&gt;&gt; file to be appended to any domain. Since I am having all the domain image files
&gt;&gt;&gt; in the same directory that is not default, this patch saves the last image path
&gt;&gt;&gt; to gconf configuration file and offers it as startfolder next time.
&gt;&gt;&gt;
&gt;&gt;&gt;      
&gt;&gt; I like the idea in principle, but I think it needs to be a bit smarter.
&gt;&gt;
&gt;&gt; I have a fix pending that will enable the storage browser for install media on
&gt;&gt; a local connection. We won't want the storage browser squashing the
&gt;&gt; default_image_path in that case, since there's a good chance that their media
&gt;&gt; directory and image directory are not the same.
&gt;&gt;    
&gt; Ok, basically I agree. Is there a way to get to know whether we're 
&gt; choosing media or an image in StorageBrowser (SB, for short) class ?

Nope, your patch will need to deal with that somehow (or move the gconf
setting out of the browser and into the caller, but then you'll want to
differentiate between a local directory and a storage directory, so it's
kind of hairy).

&gt;&gt; We should have two gconf entries: /paths/last_image_path and
&gt;&gt; /paths/last_media_path, and give the storage_browser a flag or something to
&gt;&gt; allow the caller to opt in on which gconf entry we want to store. There's
&gt;&gt; probably a smarter way to do it but I can't think right now.
&gt;&gt;    
&gt; Yeah, that's exactly why I ask. So, if there is no flag, there is a need 
&gt; to add some for SB. The SB itself stores the data in my code... Anyway 
&gt; you said you have one patch pending, right? What exactly about?

My patch doesn't alter the storage browser at all, it just turns it on
for local install media and cdrom changing. I'll push it today, it will
conflict with your patch a bit though, so you'll have to rebase.

&gt;&gt; A general comment: the gconf entries should change the virt-manager.schema.in.
&gt;&gt; You can probably just use a default value of &quot;&quot;, that way gconf won't throw an
&gt;&gt; exception the first time you try to access the key.
&gt;&gt;    
&gt; Ok, I didn't know that. This needs further study but now I need to solve 
&gt; things about Xen that I am primarily working on.
&gt;&gt; Some comments in line
&gt;&gt;    
&gt; Ok, I'll comment it too.
&gt;&gt;&gt; diff -r 74f1f8309b13 -r 73427fcfc222 src/virtManager/addhardware.py
&gt;&gt;&gt; --- a/src/virtManager/addhardware.py	Mon Jun 15 15:54:56 2009 +0200
&gt;&gt;&gt; +++ b/src/virtManager/addhardware.py	Tue Jun 16 16:21:33 2009 +0200
&gt;&gt;&gt; @@ -674,7 +674,7 @@
&gt;&gt;&gt;
&gt;&gt;&gt;       def browse_storage_file_address(self, src, ignore=None):
&gt;&gt;&gt;           textent = self.window.get_widget(&quot;storage-file-address&quot;)
&gt;&gt;&gt; -        folder = self.config.get_default_image_dir(self.vm.get_connection())
&gt;&gt;&gt; +        folder = self.config.get_user_default_image_dir(self.vm.get_connection())
&gt;&gt;&gt;           filename = self._browse_file(_(&quot;Locate or Create New Storage File&quot;),
&gt;&gt;&gt;                                        textent, folder=folder,
&gt;&gt;&gt;                                        confirm_overwrite=True)
&gt;&gt;&gt; diff -r 74f1f8309b13 -r 73427fcfc222 src/virtManager/config.py
&gt;&gt;&gt; --- a/src/virtManager/config.py	Mon Jun 15 15:54:56 2009 +0200
&gt;&gt;&gt; +++ b/src/virtManager/config.py	Tue Jun 16 16:21:33 2009 +0200
&gt;&gt;&gt; @@ -237,7 +237,15 @@
&gt;&gt;&gt;       def is_vmlist_network_traffic_visible(self):
&gt;&gt;&gt;           return self.conf.get_bool(self.conf_dir + &quot;/vmlist-fields/network_traffic&quot;)
&gt;&gt;&gt;
&gt;&gt;&gt; +    def get_user_default_image_dir(self, conn):
&gt;&gt;&gt; +        try:
&gt;&gt;&gt; +            return self.conf.get_value(self.conf_dir + &quot;/paths/default_image_path&quot;)
&gt;&gt;&gt; +        except ValueError:
&gt;&gt;&gt; +            return self.get_default_image_dir(conn)
&gt;&gt;&gt;
&gt;&gt;&gt; +    def set_user_default_image_dir(self, dir):
&gt;&gt;&gt; +        self.conf.set_value(self.conf_dir + &quot;/paths/default_image_path&quot;, dir)
&gt;&gt;&gt; +        logging.debug(&quot;Setting path to %s&quot;, dir)
&gt;&gt;&gt;
&gt;&gt;&gt;       def set_vmlist_domain_id_visible(self, state):
&gt;&gt;&gt;           self.conf.set_bool(self.conf_dir + &quot;/vmlist-fields/domain_id&quot;, state)
&gt;&gt;&gt; @@ -556,6 +564,14 @@
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;       def get_default_image_dir(self, connection):
&gt;&gt;&gt; +        # Exception for case connection argument is str (happens when
&gt;&gt;&gt; +        # creating new domains because we don't have connection object)
&gt;&gt;&gt; +        if str(connection) == connection:
&gt;&gt;&gt; +            if connection == &quot;Xen&quot;:
&gt;&gt;&gt; +                return DEFAULT_XEN_IMAGE_DIR
&gt;&gt;&gt; +            else:
&gt;&gt;&gt; +                return DEFAULT_VIRT_IMAGE_DIR
&gt;&gt;&gt; +
&gt;&gt;&gt;           if connection.get_type() == &quot;Xen&quot;:
&gt;&gt;&gt;               return DEFAULT_XEN_IMAGE_DIR
&gt;&gt;&gt;
&gt;&gt;&gt;      
&gt;&gt; The hack shouldn't be necessary (see below).
&gt;&gt;    
&gt; I see, so there's a valid connection object in self.conn that provides 
&gt; &quot;vmmConnection&quot; (or some) object even when we are creating the domain 
&gt; (ie. it doesn't exist yet) ?

Yes, domain installation requires an active libvirt connection.

&gt;&gt;    
&gt;&gt;&gt; diff -r 74f1f8309b13 -r 73427fcfc222 src/virtManager/create.py
&gt;&gt;&gt; --- a/src/virtManager/create.py	Mon Jun 15 15:54:56 2009 +0200
&gt;&gt;&gt; +++ b/src/virtManager/create.py	Tue Jun 16 16:21:33 2009 +0200
&gt;&gt;&gt; @@ -1004,7 +1004,8 @@
&gt;&gt;&gt;           self.window.get_widget(&quot;config-storage-box&quot;).set_sensitive(src.get_active())
&gt;&gt;&gt;
&gt;&gt;&gt;       def browse_storage(self, ignore1):
&gt;&gt;&gt; -        f = self._browse_file(_(&quot;Locate existing storage&quot;))
&gt;&gt;&gt; +        folder = self.config.get_user_default_image_dir( self.capsdomain.hypervisor_type )
&gt;&gt;&gt; +        f = self._browse_file(_(&quot;Locate existing storage&quot;), folder=folder)
&gt;&gt;&gt;           if f != None:
&gt;&gt;&gt;               self.window.get_widget(&quot;config-storage-entry&quot;).set_text(f)
&gt;&gt;&gt;
&gt;&gt;&gt;      
&gt;&gt; 'self.conn' contains the active connection, so you should use that rather than
&gt;&gt; self.capsdomain...
&gt;&gt;
&gt;&gt;    
&gt; Ok, even in domain creation we have this object ?

Yes, you can't even launch the VM wizard without an active connection.

&gt;&gt;&gt; @@ -1653,7 +1654,6 @@
&gt;&gt;&gt;               self.detectedDistro = (None, None)
&gt;&gt;&gt;
&gt;&gt;&gt;       def _browse_file(self, dialog_name, folder=None, is_media=False):
&gt;&gt;&gt; -
&gt;&gt;&gt;           if self.conn.is_remote() or not is_media:
&gt;&gt;&gt;               if self.storage_browser == None:
&gt;&gt;&gt;                   self.storage_browser = vmmStorageBrowser(self.config,
&gt;&gt;&gt; diff -r 74f1f8309b13 -r 73427fcfc222 src/virtManager/storagebrowse.py
&gt;&gt;&gt; --- a/src/virtManager/storagebrowse.py	Mon Jun 15 15:54:56 2009 +0200
&gt;&gt;&gt; +++ b/src/virtManager/storagebrowse.py	Tue Jun 16 16:21:33 2009 +0200
&gt;&gt;&gt; @@ -20,6 +20,7 @@
&gt;&gt;&gt;
&gt;&gt;&gt;   import gobject
&gt;&gt;&gt;   import gtk.glade
&gt;&gt;&gt; +import os.path
&gt;&gt;&gt;
&gt;&gt;&gt;   import traceback
&gt;&gt;&gt;   import logging
&gt;&gt;&gt; @@ -242,6 +243,11 @@
&gt;&gt;&gt;       def _do_finish(self, path=None):
&gt;&gt;&gt;           if not path:
&gt;&gt;&gt;               path = self.current_vol().get_path()
&gt;&gt;&gt; +
&gt;&gt;&gt; +        # Save path to config if we use file as storage
&gt;&gt;&gt; +        if &quot;/dev&quot; not in path:
&gt;&gt;&gt; +            self.config.set_user_default_image_dir( os.path.dirname(path) )
&gt;&gt;&gt; +
&gt;&gt;&gt;      
&gt;&gt; A couple things here: This will match any path which contains &quot;/dev&quot;, you
&gt;&gt; probably want path.startswith(). Also, this will store the directory of a
&gt;&gt; chosen storage volume, which isn't what we want. If you make this chunk the
&gt;&gt; first thing that happens in the function, it should be fine.
&gt;&gt;
&gt;&gt;    
&gt; Oh, right. This is right. I didn't realized that function would be 
&gt; better, thanks for your input. This isn't what we won't ? Why not? I 
&gt; thought we want to strip eg. /disk2/vms/vm1/image.img to get 
&gt; /disk2/vms/vm1/ and this is what we want, right ? Or could you give me 
&gt; an example why not this approach?

We really only want to store directories returned from the regular GTK
file chooser, not from the libvirt storage browser. So if the path comes
from current_vol(), we don't want to store it. The gconf entries should
only be for when they manually select an unmanaged path.

Thanks,
Cole

_______________________________________________
et-mgmt-tools mailing list
et-mgmt-tools@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/et-mgmt-tools">https://www.redhat.com/mailman/listinfo/et-mgmt-tools</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="04964" href="msg04964.html">[PATCH] virt-manager: Make virt-manager remember	last image directory</a></strong>
<ul><li><em>From:</em> Michal Novotny</li></ul></li>
<li><strong><a name="04975" href="msg04975.html">Re:  [PATCH] virt-manager: Make virt-manager remember	last image directory</a></strong>
<ul><li><em>From:</em> Cole Robinson</li></ul></li>
<li><strong><a name="04976" href="msg04976.html">Re:  [PATCH] virt-manager: Make virt-manager remember	last image directory</a></strong>
<ul><li><em>From:</em> Michal Novotny</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg04977.html">Re:  tftp config for virt-manager or virt-install</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg04979.html">Re:  tftp config for virt-manager or virt-install</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg04976.html">Re:  [PATCH] virt-manager: Make virt-manager remember	last image directory</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg04980.html">Re:  [PATCH] virt-manager: Make virt-manager remember	last image directory</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#04978"><strong>Date</strong></a></li>
<li><a href="index.html#04978"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fll/>[Fedora&nbsp;Legacy&nbsp;List]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-maintainers/>[Fedora&nbsp;Maintainers]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.html>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

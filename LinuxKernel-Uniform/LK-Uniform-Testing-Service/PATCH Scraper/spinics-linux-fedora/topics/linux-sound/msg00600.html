<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH] ALSA: intel8x0: Add clock quirk entry for AD1981B on IBM ThinkPad X41. -->
<!--X-From-R13: Fnxnfuv Wjnv &#60;gvjnvNfhfr.qr> -->
<!--X-Date: Mon, 14 Mar 2016 00:30:33 &#45;0700 -->
<!--X-Message-Id: s5hegbdy0ru.wl&#45;tiwai@suse.de -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: linux&#45;patch&#45;20160313&#45;1@vittgam.net -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Linux Sound: Re: [PATCH] ALSA: intel8x0: Add clock quirk entry for AD1981B on IBM ThinkPad X41.">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Linux Sound &mdash; Re: [PATCH] ALSA: intel8x0: Add clock quirk entry for AD1981B on IBM ThinkPad X41.</title>
<link rel="alternate" type="application/rss+xml" title="Linux Sound" href="//feeds.feedburner.com/LinuxSound">
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:6612422167" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH] ALSA: intel8x0: Add clock quirk entry for AD1981B on IBM ThinkPad X41.</h1>
[<a href="msg00599.html">Date Prev</a>][<a href="msg00601.html">Date Next</a>][<a href="msg00599.html">Thread Prev</a>][<a href="msg00601.html">Thread Next</a>][<a href="maillist.html#00600">Date Index</a>][<a href="index.html#00600">Thread Index</a>]
<script src="https://apis.google.com/js/platform.js" async defer></script>
<g:plusone size="small"></g:plusone>
<p>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH] ALSA: intel8x0: Add clock quirk entry for AD1981B on IBM ThinkPad X41.</li>
<li><em>From</em>: Takashi Iwai &lt;tiwai@xxxxxxx&gt;</li>
<li><em>Date</em>: Mon, 14 Mar 2016 08:30:29 +0100</li>
<li><em>Cc</em>: &lt;linux-sound@xxxxxxxxxxxxxxx&gt;, &lt;alsa-devel@xxxxxxxxxxxxxxxx&gt;,        &lt;stable@xxxxxxxxxxxxxxx&gt;, Jaroslav Kysela &lt;perex@xxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg00599.html">linux-patch-20160313-1@vittgam.net</a>&gt;</li>
<li><em>User-agent</em>: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka) FLIM/1.14.9 (Goj&#x14D;) APEL/10.8 Emacs/24.5 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Sun, 13 Mar 2016 22:19:34 +0100,
Vittorio Gambaletta (VittGam) wrote:
&gt; 
&gt; The clock measurement on the AC'97 audio card found in the IBM ThinkPad X41
&gt; will often fail, so add a quirk entry to fix it.
&gt; 
&gt; Bugzilla: <a  rel="nofollow" href="https://bugzilla.redhat.com/show_bug.cgi?id=441087">https://bugzilla.redhat.com/show_bug.cgi?id=441087</a>
&gt; Cc: &lt;stable@xxxxxxxxxxxxxxx&gt;
&gt; Cc: Jaroslav Kysela &lt;perex@xxxxxxxx&gt;
&gt; Cc: Takashi Iwai &lt;tiwai@xxxxxxx&gt;
&gt; Signed-off-by: Vittorio Gambaletta &lt;linuxbugs@xxxxxxxxxxx&gt;
&gt; ---
&gt; 
&gt; When the clock measurement doesn't fail, the `pos` variable after line 2861
&gt; will be around 48367, but when it does fail it will be somewhere between
&gt; 45000 and 47500. So the bus clock gets set between 48500 and 52000 (!),
&gt; resulting in faster audio for rates with final clocks below 48000, and
&gt; distorted audio for rates with final clocks above 48000.
&gt; 
&gt; The problem is always reproducible on kernel 4.4.5, but very rarely on 3.13.

Hrm, does this mean that the ktime() isn't accurate enough, or do we
sample too short time?  i.e. Is it improved if we enlarge the
measurement time?

&gt; This patch fixes the problem for my computer, and will also speed up module
&gt; loading a bit as said on Bugzilla, but I've got some questions regarding
&gt; other hardware...
&gt; 
&gt; Do we want to protect against overclock for all hardware, by never setting
&gt; the measured bus clock higher than 48000? Do we actually risk burning or
&gt; otherwise permanently ruining something here, or not? Does hardware clocked
&gt; above 48000 exist?
&gt; 
&gt; Also, is line 2874 actually correct? As `pos` gets higher, the bus clock gets
&gt; lower, and vice versa. Note that in this function the bus clock is always
&gt; 48000 before it gets updated here; so the code first computes 48000 * 48000,
&gt; and then it divides the result by `pos`. It doesn't seem right to me... By the
&gt; way, the history of that line goes beyond Git (so before kernel 2.6.12-rc2).

I don't remember of any machines with clock &gt; 48k, so I guess the code
never hits on any real machines, and I'm not sure whether it's really
correct at a quick glance.

In anyway, I applied your patch now.  Thanks.


Takashi
--
To unsubscribe from this list: send the line &quot;unsubscribe linux-sound&quot; in
the body of a message to majordomo@xxxxxxxxxxxxxxx
More majordomo info at  <a  rel="nofollow" href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00599" href="msg00599.html">[PATCH] ALSA: intel8x0: Add clock quirk entry for AD1981B on IBM ThinkPad X41.</a></strong>
<ul><li><em>From:</em> Vittorio Gambaletta (VittGam)</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00599.html">[PATCH] ALSA: intel8x0: Add clock quirk entry for AD1981B on IBM ThinkPad X41.</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00601.html">[PATCH] ALSA: usb-audio: Fix double-free in snd_usb_add_audio_stream()</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00599.html">[PATCH] ALSA: intel8x0: Add clock quirk entry for AD1981B on IBM ThinkPad X41.</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00601.html">[PATCH] ALSA: usb-audio: Fix double-free in snd_usb_add_audio_stream()</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00600"><strong>Date</strong></a></li>
<li><a href="index.html#00600"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/Pulseaudio/>[Pulseaudio]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/alsa-devel/>[ALSA&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.html>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width="100%">
<tr>
<td valign=top align=left>&nbsp;</td>
<td valign=top align=right>
<a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr></table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

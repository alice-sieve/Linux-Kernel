<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH] ALSA: intel8x0: Add clock quirk entry for AD1981B on IBM ThinkPad X41. -->
<!--X-From-R13: "Hvggbevb Unzonyrggn (HvggUnz)" &#60;yvahkohtfNivggtnz.arg> -->
<!--X-Date: Sun, 13 Mar 2016 14:28:46 &#45;0700 -->
<!--X-Message-Id: linux&#45;patch&#45;20160313&#45;1@vittgam.net -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Linux Sound: [PATCH] ALSA: intel8x0: Add clock quirk entry for AD1981B on IBM ThinkPad X41.">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Linux Sound &mdash; [PATCH] ALSA: intel8x0: Add clock quirk entry for AD1981B on IBM ThinkPad X41.</title>
<link rel="alternate" type="application/rss+xml" title="Linux Sound" href="//feeds.feedburner.com/LinuxSound">
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:6612422167" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH] ALSA: intel8x0: Add clock quirk entry for AD1981B on IBM ThinkPad X41.</h1>
[<a href="msg00598.html">Date Prev</a>][<a href="msg00600.html">Date Next</a>][<a href="msg00597.html">Thread Prev</a>][<a href="msg00600.html">Thread Next</a>][<a href="maillist.html#00599">Date Index</a>][<a href="index.html#00599">Thread Index</a>]
<script src="https://apis.google.com/js/platform.js" async defer></script>
<g:plusone size="small"></g:plusone>
<p>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH] ALSA: intel8x0: Add clock quirk entry for AD1981B on IBM ThinkPad X41.</li>
<li><em>From</em>: &quot;Vittorio Gambaletta (VittGam)&quot; &lt;linuxbugs@xxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Sun, 13 Mar 2016 22:19:34 +0100</li>
<li><em>Authentication-results</em>: mail.vittgam.net; dkim=none (no signature);	dkim-adsp=none (insecure policy)</li>
<li><em>Cc</em>: &lt;stable@xxxxxxxxxxxxxxx&gt;, Jaroslav Kysela &lt;perex@xxxxxxxx&gt;,        Takashi Iwai &lt;tiwai@xxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>The clock measurement on the AC'97 audio card found in the IBM ThinkPad X41
will often fail, so add a quirk entry to fix it.

Bugzilla: <a  rel="nofollow" href="https://bugzilla.redhat.com/show_bug.cgi?id=441087">https://bugzilla.redhat.com/show_bug.cgi?id=441087</a>
Cc: &lt;stable@xxxxxxxxxxxxxxx&gt;
Cc: Jaroslav Kysela &lt;perex@xxxxxxxx&gt;
Cc: Takashi Iwai &lt;tiwai@xxxxxxx&gt;
Signed-off-by: Vittorio Gambaletta &lt;linuxbugs@xxxxxxxxxxx&gt;
---

When the clock measurement doesn't fail, the `pos` variable after line 2861
will be around 48367, but when it does fail it will be somewhere between
45000 and 47500. So the bus clock gets set between 48500 and 52000 (!),
resulting in faster audio for rates with final clocks below 48000, and
distorted audio for rates with final clocks above 48000.

The problem is always reproducible on kernel 4.4.5, but very rarely on 3.13.

This patch fixes the problem for my computer, and will also speed up module
loading a bit as said on Bugzilla, but I've got some questions regarding
other hardware...

Do we want to protect against overclock for all hardware, by never setting
the measured bus clock higher than 48000? Do we actually risk burning or
otherwise permanently ruining something here, or not? Does hardware clocked
above 48000 exist?

Also, is line 2874 actually correct? As `pos` gets higher, the bus clock gets
lower, and vice versa. Note that in this function the bus clock is always
48000 before it gets updated here; so the code first computes 48000 * 48000,
and then it divides the result by `pos`. It doesn't seem right to me... By the
way, the history of that line goes beyond Git (so before kernel 2.6.12-rc2).

--- a/sound/pci/intel8x0.c
+++ b/sound/pci/intel8x0.c
@@ -2879,6 +2879,7 @@
 
 static struct snd_pci_quirk intel8x0_clock_list[] = {
 	SND_PCI_QUIRK(0x0e11, 0x008a, &quot;AD1885&quot;, 41000),
+	SND_PCI_QUIRK(0x1014, 0x0581, &quot;AD1981B&quot;, 48000),
 	SND_PCI_QUIRK(0x1028, 0x00be, &quot;AD1885&quot;, 44100),
 	SND_PCI_QUIRK(0x1028, 0x0177, &quot;AD1980&quot;, 48000),
 	SND_PCI_QUIRK(0x1028, 0x01ad, &quot;AD1981B&quot;, 48000),
--
To unsubscribe from this list: send the line &quot;unsubscribe linux-sound&quot; in
the body of a message to majordomo@xxxxxxxxxxxxxxx
More majordomo info at  <a  rel="nofollow" href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00600" href="msg00600.html">Re: [PATCH] ALSA: intel8x0: Add clock quirk entry for AD1981B on IBM ThinkPad X41.</a></strong>
<ul><li><em>From:</em> Takashi Iwai</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00598.html">Re: [PATCH] ASoC: codecs: tas2552: fix dBscale-min declaration</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00600.html">Re: [PATCH] ALSA: intel8x0: Add clock quirk entry for AD1981B on IBM ThinkPad X41.</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00597.html">[PATCH] ASoC: codecs: tas2552: fix dBscale-min declaration</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00600.html">Re: [PATCH] ALSA: intel8x0: Add clock quirk entry for AD1981B on IBM ThinkPad X41.</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00599"><strong>Date</strong></a></li>
<li><a href="index.html#00599"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/Pulseaudio/>[Pulseaudio]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/alsa-devel/>[ALSA&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.html>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width="100%">
<tr>
<td valign=top align=left>&nbsp;</td>
<td valign=top align=right>
<a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr></table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

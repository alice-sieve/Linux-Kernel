<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH 3/4] enhance dev command to extract	NT_VMCOREDD from ELF vmcore -->
<!--X-From-R13: Eheraqen [bovln &#60;fheraqenNpuryfvb.pbz> -->
<!--X-Date: Thu, 18 Apr 2019 06:14:18 &#45;0700 -->
<!--X-Message-Id: dbda5327d9a2ec87fb42fdf714c90432f7e9a922.1555587451.git.surendra@chelsio.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: cover.1555587451.git.surendra@chelsio.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="[PATCH 3/4] enhance dev command to extract	NT_VMCOREDD from ELF vmcore &mdash; Red Hat Crash Utility">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Red Hat Crash Utility &mdash;  [PATCH 3/4] enhance dev command to extract	NT_VMCOREDD from ELF vmcore</title>
<link rel="alternate" type="application/rss+xml" title="Red Hat Crash Utility" href="//feeds.feedburner.com/RedHatCrashUtility">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH 3/4] enhance dev command to extract	NT_VMCOREDD from ELF vmcore</h1>
[<a href="msg07719.html">Date Prev</a>][<a href="msg07720.html">Date Next</a>][<a href="msg07719.html">Thread Prev</a>][<a href="msg07721.html">Thread Next</a>][<a href="maillist.html#07718">Date Index</a>][<a href="index.html#07718">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH 3/4] enhance dev command to extract	NT_VMCOREDD from ELF vmcore</li>
<li><em>From</em>: Surendra Mobiya &lt;surendra@xxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 18 Apr 2019 18:43:30 +0530</li>
<li><em>Cc</em>: indranil@xxxxxxxxxxx, nirranjan@xxxxxxxxxxx, surendra@xxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg07720.html">cover.1555587451.git.surendra@chelsio.com</a>&gt;</li>
<li><em>Reply-to</em>: &quot;Discussion list for crash utility usage,	maintenance and development&quot; &lt;crash-utility@xxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" defer async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Enhanced dev command to analyze and extract hardware specific
device dumps in ELF vmcore.

    -V  list all device dumps present in vmcore
    -v  &lt;index&gt; [-r file] select and display one device dump, either in
                          human-readable format to the screen by default,
                          or optionally copy it raw to a file

Signed-off-by: Surendra Mobiya &lt;surendra@xxxxxxxxxxx&gt;
Signed-off-by: Rahul Lakkireddy &lt;rahul.lakkireddy@xxxxxxxxxxx&gt;
---
rfc:
- Moved logic to extract device dumps from &quot;devdump&quot; to &quot;dev&quot; command.
- By default, device dumps are output to screen as hexdump, if output
  file is not provided.

 defs.h    |  5 ++++
 dev.c     | 76 +++++++++++++++++++++++++++++++++++++++++++++++++++++--
 help.c    | 23 ++++++++++++++++-
 memory.c  | 10 ++++++++
 netdump.c | 69 ++++++++++++++++++++++++++++++++++++++++++++++++++
 5 files changed, 180 insertions(+), 3 deletions(-)

diff --git a/defs.h b/defs.h
index 0925a46..a6a0d8a 100644
--- a/defs.h
+++ b/defs.h
@@ -5277,6 +5277,7 @@ char *format_stack_entry(struct bt_info *bt, char *, ulong, ulong);
 int in_user_stack(ulong, ulong);
 int dump_inode_page(ulong);
 ulong valid_section_nr(ulong);
+void display_memory_from_file_offset(ulonglong, long, void *);
 
 
 /*
@@ -5686,6 +5687,8 @@ enum {
  */
 void dev_init(void);
 void dump_dev_table(void);
+void devdump_extract(void *, ulonglong, char *, FILE *);
+void devdump_info(void *, ulonglong, FILE *);
 
 /*
  *  ipcs.c
@@ -6400,6 +6403,8 @@ void *netdump_get_prstatus_percpu(int);
 int kdump_kaslr_check(void);
 void display_vmcoredd_note(void *ptr, FILE *ofp);
 QEMUCPUState *kdump_get_qemucpustate(int);
+void kdump_device_dump_info(FILE *);
+void kdump_device_dump_extract(int, char *, FILE *);
 #define PRSTATUS_NOTE (1)
 #define QEMU_NOTE     (2)
 
diff --git a/dev.c b/dev.c
index 24efea2..08bb010 100644
--- a/dev.c
+++ b/dev.c
@@ -16,6 +16,7 @@
  */
 
 #include &quot;defs.h&quot;
+#include &quot;vmcore.h&quot;
 
 static void dump_blkdevs(ulong);
 static void dump_chrdevs(ulong);
@@ -104,12 +105,13 @@ dev_init(void)
 void
 cmd_dev(void)
 {
-        int c;
+	int c, index = -1;
+	char *outputfile = NULL;
 	ulong flags;
 
 	flags = 0;
 
-        while ((c = getopt(argcnt, args, &quot;dDpi&quot;)) != EOF) {
+	while ((c = getopt(argcnt, args, &quot;dDpiVv:r:&quot;)) != EOF) {
                 switch(c)
                 {
 		case 'd':
@@ -137,6 +139,21 @@ cmd_dev(void)
 				option_not_supported(c);
 			return;
 
+		case 'V':
+			if (KDUMP_DUMPFILE())
+				kdump_device_dump_info(fp);
+			else
+				error(WARNING, &quot;KDUMP flag not found&quot;);
+			return;
+
+		case 'v':
+			index = atoi(optarg);
+			break;
+
+		case 'r':
+			outputfile = optarg;
+			break;
+
                 default:
                         argerrs++;
                         break;
@@ -146,6 +163,14 @@ cmd_dev(void)
         if (argerrs)
                 cmd_usage(pc-&gt;curcmd, SYNOPSIS);
 
+	if (index &gt;= 0) {
+		if (KDUMP_DUMPFILE())
+			kdump_device_dump_extract(index, outputfile, fp);
+		else
+			error(WARNING, &quot;KDUMP flag not found&quot;);
+		return;
+	}
+
 	dump_chrdevs(flags);
 	fprintf(fp, &quot;\n&quot;);
 	dump_blkdevs(flags);
@@ -4519,3 +4544,50 @@ diskio_option(ulong flags)
 	diskio_init();
 	display_all_diskio(flags);
 }
+
+void
+devdump_extract(void *_note, ulonglong offset, char *dump_file, FILE *ofp)
+{
+	struct vmcoredd_header *vh = (struct vmcoredd_header *)_note;
+	ulong dump_size;
+	FILE *tmpfp;
+
+	if (vh-&gt;n_type != NT_VMCOREDD) {
+		error(WARNING, &quot;Unsupported note type 0x%x&quot;, vh-&gt;n_type);
+		return;
+	}
+
+	dump_size = vh-&gt;n_descsz - VMCOREDD_MAX_NAME_BYTES;
+
+	if (dump_file) {
+		tmpfp = fopen(dump_file, &quot;w&quot;);
+		if (!tmpfp) {
+			error(FATAL, &quot;cannot open output file: %s\n&quot;,
+			      dump_file);
+			return;
+		}
+		set_tmpfile2(tmpfp);
+	}
+	fprintf(ofp, &quot;Device Dump: %s\n&quot;, vh-&gt;dump_name);
+	display_memory_from_file_offset(offset + sizeof(struct vmcoredd_header),
+					dump_size, dump_file);
+}
+
+void devdump_info(void *_note, ulonglong offset, FILE *ofp)
+{
+	struct vmcoredd_header *vh = (struct vmcoredd_header *)_note;
+	char buf[BUFSIZE];
+	ulong dump_size;
+
+	if (vh-&gt;n_type != NT_VMCOREDD)
+		return;
+
+	dump_size = vh-&gt;n_descsz - VMCOREDD_MAX_NAME_BYTES;
+
+	fprintf(ofp, &quot;0x%s  &quot;, mkstring(buf, LONG_LONG_PRLEN, LJUST | LONG_HEX,
+					MKSTR(offset + sizeof(struct vmcoredd_header))));
+	fprintf(ofp, &quot;%s  &quot;, mkstring(buf, LONG_PRLEN, LJUST | LONG_DEC,
+				      MKSTR(dump_size)));
+	fprintf(ofp, &quot;%s\n&quot;, mkstring(buf, VMCOREDD_MAX_NAME_BYTES, LJUST,
+				      (char *)vh-&gt;dump_name));
+}
diff --git a/help.c b/help.c
index 47058ed..e9bf1b9 100644
--- a/help.c
+++ b/help.c
@@ -3207,7 +3207,7 @@ NULL
 char *help_dev[] = {
 &quot;dev&quot;,
 &quot;device data&quot;,
-&quot;[-i | -p | -d | -D]&quot;,
+&quot;[-i | -p | -d | -D | -V ] [-v index [-r file]]&quot;,
 &quot;  If no argument is entered, this command dumps character and block&quot;,
 &quot;  device data.\n&quot;,
 &quot;    -i  display I/O port usage; on 2.4 kernels, also display I/O memory usage.&quot;,
@@ -3222,6 +3222,11 @@ char *help_dev[] = {
 &quot;                If the device driver uses blk-mq interface, this field&quot;,
 &quot;                shows N/A(MQ).  If not available, this column is not shown.&quot;,
 &quot;    -D  same as -d, but filter out disks with no in-progress I/O requests.&quot;,
+&quot;    -V  list all device dumps present in vmcore&quot;,
+&quot;    -v  &lt;index&gt; [-r file] select and display one device dump, either in&quot;,
+&quot;                          human-readable format to the screen by default,&quot;,
+&quot;                          or optionally copy it raw to a file&quot;,
+
 &quot;\nEXAMPLES&quot;,
 &quot;  Display character and block device data:\n&quot;,
 &quot;    %s&gt; dev&quot;,
@@ -3353,6 +3358,22 @@ char *help_dev[] = {
 &quot;        8 ffff81012dc77000   sdb      ffff81012d8b5740       0     0     0     0&quot;,
 &quot;        8 ffff81012d8d0c00   sdc      ffff81012d8ae9c0       0     0     0     0&quot;,
 
+&quot;\n  Display the available device dumps:\n&quot;,
+&quot;    %s&gt; dev -V&quot;,
+&quot;    INDEX     OFFSET              SIZE              NAME&quot;,
+&quot;    0         0x240               33558464          cxgb4_0000:02:00.4&quot;,
+&quot;    1         0x2001240           33558464          cxgb4_0000:03:00.4&quot;,
+
+&quot;\n  Extract device dump at specified index to file:\n&quot;,
+&quot;    %s&gt; dev -v 0 -r device_dump_0.bin&quot;,
+&quot;    Device Dump: cxgb4_0000:02:00.4&quot;,
+&quot;    33558464 bytes copied from 0x240 to device_dump_0.bin&quot;,
+
+&quot;\n  Format and display device dump output to screen using rd command:\n&quot;,
+&quot;    %s&gt; rd -f 0x240 -32 8&quot;,
+&quot;    240:  040b69e2 00000038 000e0001 00675fd4   .i..8........_g.&quot;,
+&quot;    250:  00000000 21600047 00000000 00000000   ....G.`!........&quot;,
+
 NULL               
 };
 
diff --git a/memory.c b/memory.c
index ab561b3..1395413 100644
--- a/memory.c
+++ b/memory.c
@@ -1793,6 +1793,16 @@ display_memory(ulonglong addr, long count, ulong flag, int memtype, void *opt)
 		fprintf(fp,&quot;\n&quot;);
 }
 
+void
+display_memory_from_file_offset(ulonglong addr, long count, void *file)
+{
+	if (file)
+		display_memory(addr, count, DISPLAY_RAW, FILEADDR, file);
+	else
+		display_memory(addr, count, DISPLAY_64 | ASCII_ENDLINE | HEXADECIMAL,
+			       FILEADDR, file);
+}
+
 /*
  *  cmd_wr() is the sister routine of cmd_rd(), used to modify the contents
  *  of memory.  Like the &quot;rd&quot; command, the starting address may be entered 
diff --git a/netdump.c b/netdump.c
index c4e9b3e..cd950e4 100644
--- a/netdump.c
+++ b/netdump.c
@@ -5082,3 +5082,72 @@ kdump_get_qemucpustate(int cpu)
 	return (QEMUCPUState *)nd-&gt;nt_qemu_percpu[cpu];
 }
 #endif
+
+static void *
+get_kdump_device_dump_offset(void)
+{
+	void *elf_base;
+
+	if (DUMPFILE_FORMAT(nd-&gt;flags) == KDUMP_ELF64) {
+		elf_base = (void *)nd-&gt;elf64;
+	} else if (DUMPFILE_FORMAT(nd-&gt;flags) == KDUMP_ELF32) {
+		elf_base = (void *)nd-&gt;elf32;
+	} else {
+		error(WARNING, &quot;Unsupported Dumpfile Format: 0x%x&quot;,
+		      DUMPFILE_FORMAT(nd-&gt;flags));
+		return NULL;
+	}
+
+	return elf_base;
+}
+
+/*
+ * extract hardware specific device dumps from coredump.
+ */
+void
+kdump_device_dump_extract(int index, char *outfile, FILE *ofp)
+{
+	ulonglong offset;
+	void *elf_base;
+
+	if (index &gt;= nd-&gt;num_vmcoredd_notes) {
+		error(WARNING, &quot;No device dump found at index: %d&quot;, index);
+		return;
+	}
+
+	elf_base = get_kdump_device_dump_offset();
+	if (!elf_base)
+		return;
+
+	offset = nd-&gt;nt_vmcoredd_array[index] - elf_base;
+
+	devdump_extract(nd-&gt;nt_vmcoredd_array[index], offset, outfile, ofp);
+}
+
+/*
+ * list all hardware specific device dumps present in coredump.
+ */
+void kdump_device_dump_info(FILE *ofp)
+{
+	ulonglong offset;
+	char buf[BUFSIZE];
+	void *elf_base;
+	ulong i;
+
+	fprintf(fp, &quot;%s  &quot;, mkstring(buf, INT_PRLEN, LJUST, &quot;INDEX&quot;));
+	fprintf(fp, &quot;%s  &quot;, mkstring(buf, LONG_LONG_PRLEN, LJUST, &quot;OFFSET&quot;));
+	fprintf(fp, &quot;  %s  &quot;, mkstring(buf, LONG_PRLEN, LJUST, &quot;SIZE&quot;));
+	fprintf(fp, &quot;%s\n&quot;, mkstring(buf, VMCOREDD_MAX_NAME_BYTES, LJUST,
+				     &quot;NAME&quot;));
+
+	elf_base = get_kdump_device_dump_offset();
+	if (!elf_base)
+		return;
+
+	for (i = 0; i &lt; nd-&gt;num_vmcoredd_notes; i++) {
+		fprintf(fp, &quot;%s  &quot;, mkstring(buf, INT_PRLEN, LJUST | INT_DEC,
+					     MKSTR(i)));
+		offset = nd-&gt;nt_vmcoredd_array[i] - elf_base;
+		devdump_info(nd-&gt;nt_vmcoredd_array[i], offset, ofp);
+	}
+}
-- 
2.21.0

--
Crash-utility mailing list
Crash-utility@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/crash-utility">https://www.redhat.com/mailman/listinfo/crash-utility</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="07720" href="msg07720.html">[PATCH 0/4] Add support to extract hardware device	dumps from vmcore</a></strong>
<ul><li><em>From:</em> Surendra Mobiya</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg07719.html">[PATCH 1/4] parse NT_VMCOREDD ELF notes in ELF	vmcore</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg07720.html">[PATCH 0/4] Add support to extract hardware device	dumps from vmcore</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg07719.html">[PATCH 1/4] parse NT_VMCOREDD ELF notes in ELF	vmcore</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg07721.html">[PATCH 4/4] enhance dev command to extract	NT_VMCOREDD from KDUMP vmcore</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#07718"><strong>Date</strong></a></li>
<li><a href="index.html#07718"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-devel/>[Fedora&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width="100%">
<tr>
<td align=left>&nbsp;</td>
<td valign=top align=right><H1><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></H1></td>
</tr></table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH 3/4] remove unreachable (and slow) code -->
<!--X-From-R13: Rnir Oaqrefba &#60;naqrefbaNerqung.pbz> -->
<!--X-Date: Mon, 9 Apr 2018 11:32:04 &#45;0700 -->
<!--X-Message-Id: 562399787.18154080.1523298716315.JavaMail.zimbra@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20180406151504.88066&#45;1&#45;gthelen@google.com -->
<!--X-Reference: 20180406151504.88066&#45;4&#45;gthelen@google.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re:  [PATCH 3/4] remove unreachable (and slow) code &mdash; Red Hat Crash Utility">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Red Hat Crash Utility &mdash;  Re:  [PATCH 3/4] remove unreachable (and slow) code</title>
<link rel="alternate" type="application/rss+xml" title="Red Hat Crash Utility" href="//feeds.feedburner.com/RedHatCrashUtility">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [PATCH 3/4] remove unreachable (and slow) code</h1>
[<a href="msg07430.html">Date Prev</a>][<a href="msg07432.html">Date Next</a>][<a href="msg07426.html">Thread Prev</a>][<a href="msg07432.html">Thread Next</a>][<a href="maillist.html#07431">Date Index</a>][<a href="index.html#07431">Thread Index</a>]
<script src="https://apis.google.com/js/platform.js" async defer></script>
<g:plusone size="small"></g:plusone>
<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH 3/4] remove unreachable (and slow) code</li>
<li><em>From</em>: Dave Anderson &lt;anderson@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Mon, 9 Apr 2018 14:31:56 -0400 (EDT)</li>
<li><em>In-reply-to</em>: &lt;<a href="msg07426.html">20180406151504.88066-4-gthelen@google.com</a>&gt;</li>
<li><em>Reply-to</em>: &quot;Discussion list for crash utility usage,	maintenance and development&quot; &lt;crash-utility@xxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" defer async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>

----- Original Message -----
&gt;<i> task_exists() scans known tasks for a given task address.</i>
&gt;<i> </i>
&gt;<i> refresh_radix_tree_task_table() looks like:</i>
&gt;<i>   hq_open()</i>
&gt;<i>   for cpus {</i>
&gt;<i>     hq_enter(per_cpu_idle_thread)</i>
&gt;<i>   }</i>
&gt;<i>   for ... {</i>
&gt;<i>     hq_enter(task)</i>
&gt;<i>   }</i>
&gt;<i>   hq_close()</i>
&gt;<i> </i>
&gt;<i>   tt-&gt;running_tasks = 0</i>
&gt;<i>   for task in retrieve_list(hq_entries) {</i>
&gt;<i>     if (task_exists()) {</i>
&gt;<i>        duplicate task address</i>
&gt;<i>        continue</i>
&gt;<i>     }</i>
&gt;<i>     add_context()</i>
&gt;<i>   }</i>
&gt;<i> </i>
&gt;<i> Because retrieve_list returns unique tasks, the above task_exists()</i>
&gt;<i> check will never find a duplicate task.  So remove the check.  This</i>
&gt;<i> converts the above loop from O(N^2) to O(N) which saves considerable</i>
&gt;<i> startup time when there are a large number of tasks.  On a 1M task dump</i>
&gt;<i> this patch reduces startup time: 44m =&gt; 1m.</i>
&gt;<i> </i>
&gt;<i> I was not able to test the other pid table routines, but I suspect they</i>
&gt;<i> may also benefit from similar removal.</i>

Hi Greg,

I'm thinking that the task_exists() removal may be the most beneficial
piece of the patch set, right?

I have a set of ~250 vmcore files gathered over the years, but only 2 of
them are from kernels using the idr radix tree scheme.  I timed how long
it took to simply bring up all 250 vmcores to their crash prompt and then
quit immediately.  These are the total times running with and without your
patch:

without the patch:

  real	46m44.023s
  user	17m29.956s
  sys	0m58.940s

with your patch applied:

  real	46m39.752s
  user	17m36.496s
  sys	0m58.269s

But as you've noted, given that all of the various refresh_xxx functions 
use hq_enter(), the task_exists() call is pretty much useless.  

I'm going to remove the task_exists() call from the remaining refresh_xxx
functions, rerun the test, and see how it affects the numbers.  I suspect
it will help a bit, although the task count in the ~250 vmcores range from
22 to 4178, with only ~20 dumpfiles having more than 1000 tasks.

Thanks,
  Dave






&gt;<i> </i>
&gt;<i> Signed-off-by: Greg Thelen &lt;gthelen@xxxxxxxxxx&gt;</i>
&gt;<i> ---</i>
&gt;<i>  task.c | 10 ----------</i>
&gt;<i>  1 file changed, 10 deletions(-)</i>
&gt;<i> </i>
&gt;<i> diff --git a/task.c b/task.c</i>
&gt;<i> index 82fa015805cb..cddc1f5b651a 100644</i>
&gt;<i> --- a/task.c</i>
&gt;<i> +++ b/task.c</i>
&gt;<i> @@ -2473,16 +2473,6 @@ retry_radix_tree:</i>
&gt;<i>  			goto retry_radix_tree;</i>
&gt;<i>  		}</i>
&gt;<i>  </i>
&gt;<i> -		if (task_exists(*tlp)) {</i>
&gt;<i> -			error(WARNING,</i>
&gt;<i> -		           &quot;%sduplicate task address found in task list: %lx\n&quot;,</i>
&gt;<i> -				DUMPFILE() ? &quot;\n&quot; : &quot;&quot;, *tlp);</i>
&gt;<i> -			if (DUMPFILE())</i>
&gt;<i> -				continue;</i>
&gt;<i> -			retries++;</i>
&gt;<i> -			goto retry_radix_tree;</i>
&gt;<i> -		}</i>
&gt;<i> -</i>
&gt;<i>  		if (!(tp = fill_task_struct(*tlp))) {</i>
&gt;<i>  			if (DUMPFILE())</i>
&gt;<i>  				continue;</i>
&gt;<i> --</i>
&gt;<i> 2.17.0.484.g0c8726318c-goog</i>
&gt;<i> </i>
&gt;<i> --</i>
&gt;<i> Crash-utility mailing list</i>
&gt;<i> Crash-utility@xxxxxxxxxx</i>
&gt;<i> <a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/crash-utility">https://www.redhat.com/mailman/listinfo/crash-utility</a></i>
&gt;<i> </i>

--
Crash-utility mailing list
Crash-utility@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/crash-utility">https://www.redhat.com/mailman/listinfo/crash-utility</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="07433" href="msg07433.html">Re:  [PATCH 3/4] remove unreachable (and slow) code</a></strong>
<ul><li><em>From:</em> Dave Anderson</li></ul></li>
<li><strong><a name="07432" href="msg07432.html">Re:  [PATCH 3/4] remove unreachable (and slow) code</a></strong>
<ul><li><em>From:</em> Greg Thelen</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="07424" href="msg07424.html">[PATCH 0/4] speed up handling of dumps with many	tasks</a></strong>
<ul><li><em>From:</em> Greg Thelen</li></ul></li>
<li><strong><a name="07426" href="msg07426.html">[PATCH 3/4] remove unreachable (and slow) code</a></strong>
<ul><li><em>From:</em> Greg Thelen</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg07430.html">Re:  [PATCH 0/4] speed up handling of dumps with	many tasks</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg07432.html">Re:  [PATCH 3/4] remove unreachable (and slow) code</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg07426.html">[PATCH 3/4] remove unreachable (and slow) code</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg07432.html">Re:  [PATCH 3/4] remove unreachable (and slow) code</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#07431"><strong>Date</strong></a></li>
<li><a href="index.html#07431"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-devel/>[Fedora&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width="100%">
<tr>
<td align=left>&nbsp;</td>
<td valign=top align=right><H1><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></H1></td>
</tr></table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

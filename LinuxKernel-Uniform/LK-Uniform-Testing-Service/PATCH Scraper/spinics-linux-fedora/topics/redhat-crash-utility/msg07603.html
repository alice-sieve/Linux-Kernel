<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH] kmem: update n option to dump memory block -->
<!--X-From-R13: [nfnlbfuv [vmhzn &#60;zflf.zvmhznNtznvy.pbz> -->
<!--X-Date: Tue, 2 Oct 2018 14:38:39 &#45;0700 -->
<!--X-Message-Id: 20181002213824.k3jk2tczmdyrkg6q@gabell -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20181001190020.29435&#45;1&#45;msys.mizuma@gmail.com -->
<!--X-Reference: 108236892.40659831.1538496155862.JavaMail.zimbra@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re:  [PATCH] kmem: update n option to dump memory block &mdash; Red Hat Crash Utility">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Red Hat Crash Utility &mdash;  Re:  [PATCH] kmem: update n option to dump memory block</title>
<link rel="alternate" type="application/rss+xml" title="Red Hat Crash Utility" href="//feeds.feedburner.com/RedHatCrashUtility">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [PATCH] kmem: update n option to dump memory block</h1>
[<a href="msg07602.html">Date Prev</a>][<a href="msg07604.html">Date Next</a>][<a href="msg07602.html">Thread Prev</a>][<a href="msg07604.html">Thread Next</a>][<a href="maillist.html#07603">Date Index</a>][<a href="index.html#07603">Thread Index</a>]
<script src="https://apis.google.com/js/platform.js" async defer></script>
<g:plusone size="small"></g:plusone>
<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH] kmem: update n option to dump memory block</li>
<li><em>From</em>: Masayoshi Mizuma &lt;msys.mizuma@xxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 2 Oct 2018 17:38:25 -0400</li>
<li><em>Cc</em>: Masayoshi Mizuma &lt;m.mizuma@xxxxxxxxxxxxxx&gt;,        &quot;Discussion list for crash utility usage,	maintenance and development&quot; &lt;crash-utility@xxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg07602.html">108236892.40659831.1538496155862.JavaMail.zimbra@redhat.com</a>&gt;</li>
<li><em>Reply-to</em>: &quot;Discussion list for crash utility usage,	maintenance and development&quot; &lt;crash-utility@xxxxxxxxxx&gt;</li>
<li><em>User-agent</em>: NeoMutt/20180716</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" defer async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Hi Dave,

Thank you for your comment.

On Tue, Oct 02, 2018 at 12:02:35PM -0400, Dave Anderson wrote:
&gt;<i> </i>
&gt;<i> </i>
&gt;<i> ----- Original Message -----</i>
&gt;<i> &gt; From: Masayoshi Mizuma &lt;m.mizuma@xxxxxxxxxxxxxx&gt;</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; Update for the &quot;kmem -n&quot; option to also dump memory block.</i>
&gt;<i> &gt; Currently, &quot;kmem -n&quot; shows the memory section only. This</i>
&gt;<i> &gt; patch gets available the memory block as well if 'memory_block'</i>
&gt;<i> &gt; structure and 'memory_subsys' symbol exist.</i>
&gt;<i> &gt; The memory block information is useful to investigate memory</i>
&gt;<i> &gt; hot-plug issue.</i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i> Hello Masa,</i>
&gt;<i> </i>
&gt;<i> First let me say that I appreciate the work you've done to add this new information.</i>
&gt;<i> </i>
&gt;<i> However, I don't like the new output format...</i>
&gt;<i> </i>
&gt;<i> Taking a simple example, the current display looks like this:</i>
&gt;<i> </i>
&gt;<i> NR      SECTION        CODED_MEM_MAP        MEM_MAP       PFN</i>
&gt;<i>  0  ffff880002664000  ffffea0000000000  ffffea0000000000  0</i>
&gt;<i>  1  ffff880002664020  ffffea0000000000  ffffea0000340000  32768</i>
&gt;<i>  2  ffff880002664040  ffffea0000000000  ffffea0000680000  65536</i>
&gt;<i>  3  ffff880002664060  ffffea0000000000  ffffea00009c0000  98304</i>
&gt;<i>  4  ffff880002664080  ffffea0000000000  ffffea0000d00000  131072</i>
&gt;<i>  5  ffff8800026640a0  ffffea0000000000  ffffea0001040000  163840</i>
&gt;<i>  6  ffff8800026640c0  ffffea0000000000  ffffea0001380000  196608</i>
&gt;<i>  7  ffff8800026640e0  ffffea0000000000  ffffea00016c0000  229376</i>
&gt;<i> </i>
&gt;<i> With your patch on a system without memory blocks, it looks like this:</i>
&gt;<i> </i>
&gt;<i> NR         SECTION        CODED_MEM_MAP        MEM_MAP           PFN      STATE</i>
&gt;<i>     0  ffff880002664000  ffffea0000000000  ffffea0000000000  0            PRESENT|HAS_MEMMAP</i>
&gt;<i>     1  ffff880002664020  ffffea0000000000  ffffea0000340000  32768        PRESENT|HAS_MEMMAP</i>
&gt;<i>     2  ffff880002664040  ffffea0000000000  ffffea0000680000  65536        PRESENT|HAS_MEMMAP</i>
&gt;<i>     3  ffff880002664060  ffffea0000000000  ffffea00009c0000  98304        PRESENT|HAS_MEMMAP</i>
&gt;<i>     4  ffff880002664080  ffffea0000000000  ffffea0000d00000  131072       PRESENT|HAS_MEMMAP</i>
&gt;<i>     5  ffff8800026640a0  ffffea0000000000  ffffea0001040000  163840       PRESENT|HAS_MEMMAP</i>
&gt;<i>     6  ffff8800026640c0  ffffea0000000000  ffffea0001380000  196608       PRESENT|HAS_MEMMAP</i>
&gt;<i>     7  ffff8800026640e0  ffffea0000000000  ffffea00016c0000  229376       PRESENT|HAS_MEMMAP</i>
&gt;<i> </i>
&gt;<i> Your patch stretches the output well beyond the preferred 80 column maximum,</i>
&gt;<i> which I try to avoid if at all possible.</i>
&gt;<i> </i>
&gt;<i> Could you please:</i>
&gt;<i> </i>
&gt;<i>  (1) restore the original display size w/respect to the &quot;NR&quot; column</i>
&gt;<i>  (2) restore the left-justified &quot;PFN&quot; header string.</i>

&gt;<i>  (3) put the new &quot;STATE&quot; column as a fixed-size column somewhere</i>
&gt;<i>      before the &quot;PFN&quot; column, and instead of using the PRESENT, </i>
&gt;<i>      HAS_MEMMAP, and ONLINE strings, use &quot;P&quot;, &quot;M&quot; and &quot;O&quot;.</i>

I think (3) is nice idea!

&gt;<i> </i>
&gt;<i> That will keep it under 80 columns, and the &quot;P&quot;, &quot;M&quot; and &quot;O&quot; should</i>
&gt;<i> be described in the &quot;kmem&quot; help page for the -n option (which </i>
&gt;<i> currently doesn't even have the memory section in the example).</i>
&gt;<i> </i>
&gt;<i> Now, when memory blocks are supported, the output is really difficult</i>
&gt;<i> to read, mainly because each of the (possible hundreds of) entries </i>
&gt;<i> has two headers. </i>
&gt;<i> </i>
&gt;<i> I understand that you want to link the memory sections with the memory</i>
&gt;<i> blocks, but here's what I suggest the output should be.  To clarify their</i>
&gt;<i> relationship, you could add a &quot;NR&quot; column to your memory block display,</i>
&gt;<i> and separate the two sections, to look like this:</i>
&gt;<i>  </i>
&gt;<i> crash&gt; kmem -n</i>
&gt;<i> ... [ cut ] ...</i>
&gt;<i> </i>
&gt;<i> NR      SECTION        CODED_MEM_MAP        MEM_MAP       STATE  PFN </i>
&gt;<i>  0  ffff88047e5d6000  ffffea0000000000  ffffea0000000000   PM    0    </i>
&gt;<i>  1  ffff88047e5d6020  ffffea0000000000  ffffea0000200000   PM    32768</i>
&gt;<i>  2  ffff88047e5d6040  ffffea0000000000  ffffea0000400000   PM    65536</i>
&gt;<i>  3  ffff88047e5d6060  ffffea0000000000  ffffea0000600000   PM    98304</i>
&gt;<i> ...</i>
&gt;<i> </i>
&gt;<i> NR      MEM_BLOCK     NAME         PHYSICAL RANGE      STATE</i>
&gt;<i>  0  ffff880181e59000  memory0           0 -  7ffffff   ONLINE        </i>
&gt;<i>  1  ffff880181e58c00  memory1     8000000 -  fffffff   ONLINE        </i>
&gt;<i>  2  ffff88047e268000  memory2    10000000 - 17ffffff   ONLINE        </i>
&gt;<i>  3  ffff88047e268400  memory3    18000000 - 1fffffff   ONLINE        </i>
&gt;<i> ...</i>

How about the following layout? The following shows the sections
which belong to the memory block.

crash&gt; kmem -n
...
NR      SECTION        CODED_MEM_MAP        MEM_MAP       STATE  PFN 
 0  ffff88047e5d6000  ffffea0000000000  ffffea0000000000   PM    0    
 1  ffff88047e5d6020  ffffea0000000000  ffffea0000200000   PM    32768
 2  ffff88047e5d6040  ffffea0000000000  ffffea0000400000   PM    65536
 3  ffff88047e5d6060  ffffea0000000000  ffffea0000600000   PM    98304
...

    MEM_BLOCK     NAME         PHYSICAL RANGE      STATE   SECTIONS
ffff880181e59000  memory0           0 -  7ffffff   ONLINE  0-3
ffff880181e58c00  memory1     8000000 -  fffffff   ONLINE  4-7
ffff88047e268000  memory2    10000000 - 17ffffff   ONLINE  8-11
ffff88047e268400  memory3    18000000 - 1fffffff   ONLINE  12-15
...

&gt;<i> </i>
&gt;<i> Also, I would prefer that you separate the functionality for the</i>
&gt;<i> sake of clarity and maintainability, for example:</i>
&gt;<i> </i>
&gt;<i> @@ -16355,7 +16357,7 @@ dump_memory_nodes(int initialize)</i>
&gt;<i>         }</i>
&gt;<i> </i>
&gt;<i>         if (IS_SPARSEMEM())</i>
&gt;<i> -               dump_mem_sections(initialize);</i>
&gt;<i> +               dump_mem_block_and_sections(initialize);</i>
&gt;<i>  }</i>
&gt;<i> </i>
&gt;<i> Could you create a separate dump_memory_blocks() function?  I understand </i>
&gt;<i> that other functions can and should be utilized by both functions.</i>

Got it.

&gt;<i> </i>
&gt;<i> Lastly, for any new additions to the offset_table, please add them</i>
&gt;<i> to the dump_offset_table() function in symbols.c for &quot;help -o&quot;.</i>
&gt;<i> I mistakenly forgot to mention that when accepting your &quot;dev -p&quot; patch,</i>
&gt;<i> but I subsequently added them.</i>

Thanks, got it.

- Masa

&gt;<i> </i>
&gt;<i> Thanks,</i>
&gt;<i>   Dave</i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i> &gt; </i>
&gt;<i> &gt; Signed-off-by: Masayoshi Mizuma &lt;m.mizuma@xxxxxxxxxxxxxx&gt;</i>
&gt;<i> &gt; ---</i>
&gt;<i> &gt;  defs.h   |   8 ++</i>
&gt;<i> &gt;  memory.c | 412 +++++++++++++++++++++++++++++++++++++++++++++++++------</i>
&gt;<i> &gt;  2 files changed, 379 insertions(+), 41 deletions(-)</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; diff --git a/defs.h b/defs.h</i>
&gt;<i> &gt; index 5b64bb7..f707c64 100644</i>
&gt;<i> &gt; --- a/defs.h</i>
&gt;<i> &gt; +++ b/defs.h</i>
&gt;<i> &gt; @@ -2049,6 +2049,14 @@ struct offset_table {                    /* stash of</i>
&gt;<i> &gt; commonly-used offsets */</i>
&gt;<i> &gt;          long pci_bus_self;</i>
&gt;<i> &gt;  	long device_kobj;</i>
&gt;<i> &gt;  	long kobject_name;</i>
&gt;<i> &gt; +	long memory_block_dev;</i>
&gt;<i> &gt; +	long memory_block_start_section_nr;</i>
&gt;<i> &gt; +	long mem_section_pageblock_flags;</i>
&gt;<i> &gt; +	long memory_block_state;</i>
&gt;<i> &gt; +	long memory_block_nid;</i>
&gt;<i> &gt; +	long bus_type_p;</i>
&gt;<i> &gt; +	long device_private_device;</i>
&gt;<i> &gt; +	long device_private_knode_bus;</i>
&gt;<i> &gt;  };</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt;  struct size_table {         /* stash of commonly-used sizes */</i>
&gt;<i> &gt; diff --git a/memory.c b/memory.c</i>
&gt;<i> &gt; index ea25047..c7a4787 100644</i>
&gt;<i> &gt; --- a/memory.c</i>
&gt;<i> &gt; +++ b/memory.c</i>
&gt;<i> &gt; @@ -254,14 +254,16 @@ static void PG_reserved_flag_init(void);</i>
&gt;<i> &gt;  static void PG_slab_flag_init(void);</i>
&gt;<i> &gt;  static ulong nr_blockdev_pages(void);</i>
&gt;<i> &gt;  void sparse_mem_init(void);</i>
&gt;<i> &gt; -void dump_mem_sections(int);</i>
&gt;<i> &gt; +void dump_mem_block_and_sections(int);</i>
&gt;<i> &gt; +void _dump_mem_block_and_sections(void);</i>
&gt;<i> &gt; +void dump_mem_sections(void);</i>
&gt;<i> &gt;  void list_mem_sections(void);</i>
&gt;<i> &gt;  ulong sparse_decode_mem_map(ulong, ulong);</i>
&gt;<i> &gt;  char *read_mem_section(ulong);</i>
&gt;<i> &gt;  ulong nr_to_section(ulong);</i>
&gt;<i> &gt;  int valid_section(ulong);</i>
&gt;<i> &gt;  int section_has_mem_map(ulong);</i>
&gt;<i> &gt; -ulong section_mem_map_addr(ulong);</i>
&gt;<i> &gt; +ulong section_mem_map_addr(ulong, int);</i>
&gt;<i> &gt;  ulong valid_section_nr(ulong);</i>
&gt;<i> &gt;  ulong pfn_to_map(ulong);</i>
&gt;<i> &gt;  static int get_nodes_online(void);</i>
&gt;<i> &gt; @@ -5528,7 +5530,7 @@ dump_mem_map_SPARSEMEM(struct meminfo *mi)</i>
&gt;<i> &gt;  			pc-&gt;curcmd_flags |= HEADER_PRINTED;</i>
&gt;<i> &gt;  		}</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt; -		pp = section_mem_map_addr(section);</i>
&gt;<i> &gt; +		pp = section_mem_map_addr(section, 0);</i>
&gt;<i> &gt;  		pp = sparse_decode_mem_map(pp, section_nr);</i>
&gt;<i> &gt;  		phys = (physaddr_t) section_nr * PAGES_PER_SECTION() * PAGESIZE();</i>
&gt;<i> &gt;  		section_size = PAGES_PER_SECTION();</i>
&gt;<i> &gt; @@ -13389,7 +13391,7 @@ is_page_ptr(ulong addr, physaddr_t *phys)</i>
&gt;<i> &gt;  		nr_mem_sections = vt-&gt;max_mem_section_nr+1;</i>
&gt;<i> &gt;  	        for (nr = 0; nr &lt; nr_mem_sections ; nr++) {</i>
&gt;<i> &gt;  	                if ((sec_addr = valid_section_nr(nr))) {</i>
&gt;<i> &gt; -	                        coded_mem_map = section_mem_map_addr(sec_addr);</i>
&gt;<i> &gt; +	                        coded_mem_map = section_mem_map_addr(sec_addr, 0);</i>
&gt;<i> &gt;  	                        mem_map = sparse_decode_mem_map(coded_mem_map, nr);</i>
&gt;<i> &gt;  				end_mem_map = mem_map + (PAGES_PER_SECTION() * SIZE(page));</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt; @@ -16355,7 +16357,7 @@ dump_memory_nodes(int initialize)</i>
&gt;<i> &gt;  	}</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt;  	if (IS_SPARSEMEM())</i>
&gt;<i> &gt; -		dump_mem_sections(initialize);</i>
&gt;<i> &gt; +		dump_mem_block_and_sections(initialize);</i>
&gt;<i> &gt;  }</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt;  /*</i>
&gt;<i> &gt; @@ -17140,7 +17142,7 @@ section_has_mem_map(ulong addr)</i>
&gt;<i> &gt;  }</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt;  ulong</i>
&gt;<i> &gt; -section_mem_map_addr(ulong addr)</i>
&gt;<i> &gt; +section_mem_map_addr(ulong addr, int raw)</i>
&gt;<i> &gt;  {</i>
&gt;<i> &gt;  	char *mem_section;</i>
&gt;<i> &gt;  	ulong map;</i>
&gt;<i> &gt; @@ -17148,7 +17150,8 @@ section_mem_map_addr(ulong addr)</i>
&gt;<i> &gt;  	if ((mem_section = read_mem_section(addr))) {</i>
&gt;<i> &gt;  		map = ULONG(mem_section +</i>
&gt;<i> &gt;  			OFFSET(mem_section_section_mem_map));</i>
&gt;<i> &gt; -		map &amp;= SECTION_MAP_MASK;</i>
&gt;<i> &gt; +		if (!raw)</i>
&gt;<i> &gt; +			map &amp;= SECTION_MAP_MASK;</i>
&gt;<i> &gt;  		return map;</i>
&gt;<i> &gt;  	}</i>
&gt;<i> &gt;  	return 0;</i>
&gt;<i> &gt; @@ -17179,7 +17182,7 @@ pfn_to_map(ulong pfn)</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt;  	if (section_has_mem_map(section)) {</i>
&gt;<i> &gt;  		page_offset = pfn - section_nr_to_pfn(section_nr);</i>
&gt;<i> &gt; -		coded_mem_map = section_mem_map_addr(section);</i>
&gt;<i> &gt; +		coded_mem_map = section_mem_map_addr(section, 0);</i>
&gt;<i> &gt;  		mem_map = sparse_decode_mem_map(coded_mem_map, section_nr) +</i>
&gt;<i> &gt;  			(page_offset * SIZE(page));</i>
&gt;<i> &gt;  		return mem_map;</i>
&gt;<i> &gt; @@ -17188,16 +17191,365 @@ pfn_to_map(ulong pfn)</i>
&gt;<i> &gt;  	return 0;</i>
&gt;<i> &gt;  }</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt; -void</i>
&gt;<i> &gt; -dump_mem_sections(int initialize)</i>
&gt;<i> &gt; +struct memory_block_info {</i>
&gt;<i> &gt; +	ulong memory_block;</i>
&gt;<i> &gt; +	ulong start_sec;</i>
&gt;<i> &gt; +	ulong start_pfn;</i>
&gt;<i> &gt; +	ulong nid;</i>
&gt;<i> &gt; +	char state[24];</i>
&gt;<i> &gt; +	char name[32];</i>
&gt;<i> &gt; +};</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +#define MIN_MEMORY_BLOCK_SIZE     (1UL &lt;&lt; _SECTION_SIZE_BITS)</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +#define MEM_ONLINE              (1&lt;&lt;0)</i>
&gt;<i> &gt; +#define MEM_GOING_OFFLINE       (1&lt;&lt;1)</i>
&gt;<i> &gt; +#define MEM_OFFLINE             (1&lt;&lt;2)</i>
&gt;<i> &gt; +#define MEM_GOING_ONLINE        (1&lt;&lt;3)</i>
&gt;<i> &gt; +#define MEM_CANCEL_ONLINE       (1&lt;&lt;4)</i>
&gt;<i> &gt; +#define MEM_CANCEL_OFFLINE      (1&lt;&lt;5)</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +static void</i>
&gt;<i> &gt; +fill_memory_block_state(ulong memblock, char *buf)</i>
&gt;<i> &gt;  {</i>
&gt;<i> &gt; -	ulong nr, max, addr;</i>
&gt;<i> &gt; -	ulong nr_mem_sections;</i>
&gt;<i> &gt; +	ulong state;</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	memset(buf, 0, sizeof(*buf) * BUFSIZE);</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	readmem(memblock + OFFSET(memory_block_state), KVADDR, &amp;state,</i>
&gt;<i> &gt; +		sizeof(void *), &quot;memory_block state&quot;, FAULT_ON_ERROR);</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	switch (state) {</i>
&gt;<i> &gt; +	case MEM_ONLINE:</i>
&gt;<i> &gt; +		sprintf(buf, &quot;%s&quot;, &quot;ONLINE&quot;);</i>
&gt;<i> &gt; +		break;</i>
&gt;<i> &gt; +	case MEM_GOING_OFFLINE:</i>
&gt;<i> &gt; +		sprintf(buf, &quot;%s&quot;, &quot;GOING_OFFLINE&quot;);</i>
&gt;<i> &gt; +		break;</i>
&gt;<i> &gt; +	case MEM_OFFLINE:</i>
&gt;<i> &gt; +		sprintf(buf, &quot;%s&quot;, &quot;OFFLINE&quot;);</i>
&gt;<i> &gt; +		break;</i>
&gt;<i> &gt; +	case MEM_GOING_ONLINE:</i>
&gt;<i> &gt; +		sprintf(buf, &quot;%s&quot;, &quot;GOING_ONLINE&quot;);</i>
&gt;<i> &gt; +		break;</i>
&gt;<i> &gt; +	case MEM_CANCEL_ONLINE:</i>
&gt;<i> &gt; +		sprintf(buf, &quot;%s&quot;, &quot;CANCEL_ONLINE&quot;);</i>
&gt;<i> &gt; +		break;</i>
&gt;<i> &gt; +	case MEM_CANCEL_OFFLINE:</i>
&gt;<i> &gt; +		sprintf(buf, &quot;%s&quot;,  &quot;CANCEL_OFFLINE&quot;);</i>
&gt;<i> &gt; +		break;</i>
&gt;<i> &gt; +	default:</i>
&gt;<i> &gt; +		sprintf(buf, &quot;%s&quot;, &quot;UNKNOWN&quot;);</i>
&gt;<i> &gt; +	}</i>
&gt;<i> &gt; +}</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +static void</i>
&gt;<i> &gt; +fill_mem_section_state(ulong state, char *buf)</i>
&gt;<i> &gt; +{</i>
&gt;<i> &gt; +	int bufidx = 0, others = 0;</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	memset(buf, 0, sizeof(*buf) * BUFSIZE);</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +#define printflag(X) sprintf(buf + bufidx, X, others++ ? &quot;|&quot; : &quot;&quot;)</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	if (state &amp; SECTION_MARKED_PRESENT)</i>
&gt;<i> &gt; +		bufidx += printflag(&quot;%sPRESENT&quot;);</i>
&gt;<i> &gt; +	if (state &amp; SECTION_HAS_MEM_MAP)</i>
&gt;<i> &gt; +		bufidx += printflag(&quot;%sHAS_MEMMAP&quot;);</i>
&gt;<i> &gt; +	if (state &amp; SECTION_IS_ONLINE)</i>
&gt;<i> &gt; +		bufidx += printflag(&quot;%sONLINE&quot;);</i>
&gt;<i> &gt; +}</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +static ulong</i>
&gt;<i> &gt; +pfn_to_phys(ulong pfn)</i>
&gt;<i> &gt; +{</i>
&gt;<i> &gt; +	return pfn &lt;&lt; PAGE_SHIFT;</i>
&gt;<i> &gt; +}</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +static ulong</i>
&gt;<i> &gt; +get_memory_block_size(void)</i>
&gt;<i> &gt; +{</i>
&gt;<i> &gt; +	static ulong blksz;</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	if (blksz)</i>
&gt;<i> &gt; +		return blksz;</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	if (symbol_exists(&quot;memory_block_size_probed&quot;))</i>
&gt;<i> &gt; +		get_symbol_data(&quot;memory_block_size_probed&quot;, sizeof(ulong),</i>
&gt;<i> &gt; +				&amp;blksz);</i>
&gt;<i> &gt; +	else</i>
&gt;<i> &gt; +		blksz = MIN_MEMORY_BLOCK_SIZE;</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	return blksz;</i>
&gt;<i> &gt; +}</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +static void</i>
&gt;<i> &gt; +fill_memory_block_name(ulong memblock, char *name)</i>
&gt;<i> &gt; +{</i>
&gt;<i> &gt; +	ulong kobj, value;</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	memset(name, 0, sizeof(*name) * BUFSIZE);</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	kobj = memblock + OFFSET(memory_block_dev) + OFFSET(device_kobj);</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	readmem(kobj + OFFSET(kobject_name),</i>
&gt;<i> &gt; +		KVADDR, &amp;value, sizeof(void *), &quot;kobject name&quot;,</i>
&gt;<i> &gt; +		FAULT_ON_ERROR);</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	read_string(value, name, BUFSIZE-1);</i>
&gt;<i> &gt; +}</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +static void</i>
&gt;<i> &gt; +fill_memory_block_info(ulong mb, struct memory_block_info *mbi)</i>
&gt;<i> &gt; +{</i>
&gt;<i> &gt; +	ulong start, start_pfn, nid;</i>
&gt;<i> &gt; +	char statebuf[BUFSIZE];</i>
&gt;<i> &gt; +	char name[BUFSIZE];</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	readmem(mb + OFFSET(memory_block_start_section_nr), KVADDR,</i>
&gt;<i> &gt; +		&amp;start, sizeof(void *), &quot;memory_block start_section_nr&quot;,</i>
&gt;<i> &gt; +		FAULT_ON_ERROR);</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	start_pfn = section_nr_to_pfn(start);</i>
&gt;<i> &gt; +	fill_memory_block_state(mb, statebuf);</i>
&gt;<i> &gt; +	fill_memory_block_name(mb, name);</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	mbi-&gt;memory_block = mb;</i>
&gt;<i> &gt; +	mbi-&gt;start_sec = start;</i>
&gt;<i> &gt; +	mbi-&gt;start_pfn = start_pfn;</i>
&gt;<i> &gt; +	strncpy(mbi-&gt;state, statebuf, sizeof(mbi-&gt;state));</i>
&gt;<i> &gt; +	strncpy(mbi-&gt;name, name, sizeof(mbi-&gt;name));</i>
&gt;<i> &gt; +	if (MEMBER_EXISTS(&quot;memory_block&quot;, &quot;nid&quot;)) {</i>
&gt;<i> &gt; +		readmem(mb + OFFSET(memory_block_nid), KVADDR, &amp;nid,</i>
&gt;<i> &gt; +			sizeof(void *), &quot;memory_block nid&quot;, FAULT_ON_ERROR);</i>
&gt;<i> &gt; +		mbi-&gt;nid = nid;</i>
&gt;<i> &gt; +	}</i>
&gt;<i> &gt; +}</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +static void</i>
&gt;<i> &gt; +init_memory_block(void)</i>
&gt;<i> &gt; +{</i>
&gt;<i> &gt; +	MEMBER_OFFSET_INIT(bus_type_p, &quot;bus_type&quot;, &quot;p&quot;);</i>
&gt;<i> &gt; +	MEMBER_OFFSET_INIT(subsys_private_klist_devices,</i>
&gt;<i> &gt; +				&quot;subsys_private&quot;, &quot;klist_devices&quot;);</i>
&gt;<i> &gt; +	MEMBER_OFFSET_INIT(klist_k_list, &quot;klist&quot;, &quot;k_list&quot;);</i>
&gt;<i> &gt; +	MEMBER_OFFSET_INIT(klist_node_n_node, &quot;klist_node&quot;, &quot;n_node&quot;);</i>
&gt;<i> &gt; +	MEMBER_OFFSET_INIT(device_private_knode_bus,</i>
&gt;<i> &gt; +				&quot;device_private&quot;, &quot;knode_bus&quot;);</i>
&gt;<i> &gt; +	MEMBER_OFFSET_INIT(device_private_device, &quot;device_private&quot;, &quot;device&quot;);</i>
&gt;<i> &gt; +	MEMBER_OFFSET_INIT(memory_block_dev, &quot;memory_block&quot;, &quot;dev&quot;);</i>
&gt;<i> &gt; +	MEMBER_OFFSET_INIT(memory_block_start_section_nr,</i>
&gt;<i> &gt; +				&quot;memory_block&quot;, &quot;start_section_nr&quot;);</i>
&gt;<i> &gt; +	MEMBER_OFFSET_INIT(memory_block_state, &quot;memory_block&quot;, &quot;state&quot;);</i>
&gt;<i> &gt; +	if (MEMBER_EXISTS(&quot;memory_block&quot;, &quot;nid&quot;))</i>
&gt;<i> &gt; +		MEMBER_OFFSET_INIT(memory_block_nid, &quot;memory_block&quot;, &quot;nid&quot;);</i>
&gt;<i> &gt; +}</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +static struct memory_block_info*</i>
&gt;<i> &gt; +parse_memory_block(void)</i>
&gt;<i> &gt; +{</i>
&gt;<i> &gt; +	ulong memory_subsys = symbol_value(&quot;memory_subsys&quot;);</i>
&gt;<i> &gt; +	ulong private, klist, memory_block, device;</i>
&gt;<i> &gt; +	ulong *klistbuf;</i>
&gt;<i> &gt; +	int klistcnt, i;</i>
&gt;<i> &gt; +	struct list_data list_data, *ld;</i>
&gt;<i> &gt; +	struct memory_block_info *memory_block_info;</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	init_memory_block();</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	readmem(memory_subsys + OFFSET(bus_type_p), KVADDR, &amp;private,</i>
&gt;<i> &gt; +		sizeof(void *), &quot;memory_subsys.private&quot;, FAULT_ON_ERROR);</i>
&gt;<i> &gt; +	klist = private + OFFSET(subsys_private_klist_devices) +</i>
&gt;<i> &gt; +					OFFSET(klist_k_list);</i>
&gt;<i> &gt; +	ld = &amp;list_data;</i>
&gt;<i> &gt; +	BZERO(ld, sizeof(struct list_data));</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	ld-&gt;start = klist;</i>
&gt;<i> &gt; +	ld-&gt;end = klist;</i>
&gt;<i> &gt; +	ld-&gt;list_head_offset = OFFSET(klist_node_n_node) +</i>
&gt;<i> &gt; +					OFFSET(device_private_knode_bus);</i>
&gt;<i> &gt; +	hq_open();</i>
&gt;<i> &gt; +	klistcnt = do_list(ld);</i>
&gt;<i> &gt; +	klistbuf = (ulong *)GETBUF(klistcnt * sizeof(ulong));</i>
&gt;<i> &gt; +	klistcnt = retrieve_list(klistbuf, klistcnt);</i>
&gt;<i> &gt; +	hq_close();</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	memory_block_info = calloc(klistcnt + 1,</i>
&gt;<i> &gt; +					sizeof(struct memory_block_info));</i>
&gt;<i> &gt; +	if (!memory_block_info)</i>
&gt;<i> &gt; +		error(FATAL, &quot;cannot allocate memory for memory_block_info\n&quot;);</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	for (i = 0; i &lt; klistcnt; i++) {</i>
&gt;<i> &gt; +		readmem(klistbuf[i] + OFFSET(device_private_device), KVADDR,</i>
&gt;<i> &gt; +			&amp;device, sizeof(void *), &quot;device_private device&quot;,</i>
&gt;<i> &gt; +			FAULT_ON_ERROR);</i>
&gt;<i> &gt; +		memory_block = device - OFFSET(memory_block_dev);</i>
&gt;<i> &gt; +		fill_memory_block_info(memory_block, &amp;memory_block_info[i]);</i>
&gt;<i> &gt; +	}</i>
&gt;<i> &gt; +	FREEBUF(klistbuf);</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	return memory_block_info;</i>
&gt;<i> &gt; +}</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +static struct memory_block_info*</i>
&gt;<i> &gt; +get_memory_block_info(ulong pfn, struct memory_block_info *mbi_tbl)</i>
&gt;<i> &gt; +{</i>
&gt;<i> &gt; +	int i;</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	for (i = 0; mbi_tbl[i].memory_block != 0; i++)</i>
&gt;<i> &gt; +		if (pfn == mbi_tbl[i].start_pfn)</i>
&gt;<i> &gt; +			return &amp;mbi_tbl[i];</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	return NULL;</i>
&gt;<i> &gt; +}</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +static int</i>
&gt;<i> &gt; +is_memory_block_head(ulong pfn)</i>
&gt;<i> &gt; +{</i>
&gt;<i> &gt; +	ulong nr_pages = get_memory_block_size() / PAGE_SIZE;</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	return (pfn % nr_pages) == 0;</i>
&gt;<i> &gt; +}</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +static void</i>
&gt;<i> &gt; +print_memory_block(ulong pfn, ulong nr_mb_pages, struct memory_block_info</i>
&gt;<i> &gt; *mbi)</i>
&gt;<i> &gt; +{</i>
&gt;<i> &gt; +	char buf1[BUFSIZE];</i>
&gt;<i> &gt; +	char buf2[BUFSIZE];</i>
&gt;<i> &gt; +	char buf3[BUFSIZE];</i>
&gt;<i> &gt; +	char buf4[BUFSIZE];</i>
&gt;<i> &gt; +	char buf5[BUFSIZE];</i>
&gt;<i> &gt; +	char buf6[BUFSIZE];</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	if (MEMBER_EXISTS(&quot;memory_block&quot;, &quot;nid&quot;))</i>
&gt;<i> &gt; +		fprintf(fp, &quot; %s %s %s - %s %s %s\n&quot;,</i>
&gt;<i> &gt; +			mkstring(buf1, VADDR_PRLEN, LJUST|LONG_HEX,</i>
&gt;<i> &gt; +			MKSTR(mbi-&gt;memory_block)),</i>
&gt;<i> &gt; +			mkstring(buf2, 12, CENTER, mbi-&gt;name),</i>
&gt;<i> &gt; +			mkstring(buf3, PADDR_PRLEN, RJUST|LONG_HEX,</i>
&gt;<i> &gt; +			MKSTR(pfn_to_phys(pfn))),</i>
&gt;<i> &gt; +			mkstring(buf4, PADDR_PRLEN, LJUST|LONG_HEX,</i>
&gt;<i> &gt; +			MKSTR(pfn_to_phys(pfn + nr_mb_pages) - 1)),</i>
&gt;<i> &gt; +			mkstring(buf5, strlen(&quot;NODE&quot;), CENTER|LONG_DEC,</i>
&gt;<i> &gt; +			MKSTR(mbi-&gt;nid)),</i>
&gt;<i> &gt; +			mkstring(buf6, strlen(&quot;CANCEL_OFFLINE&quot;), LJUST,</i>
&gt;<i> &gt; +			mbi-&gt;state));</i>
&gt;<i> &gt; +	else</i>
&gt;<i> &gt; +		fprintf(fp, &quot; %s %s %s - %s %s\n&quot;,</i>
&gt;<i> &gt; +			mkstring(buf1, VADDR_PRLEN, LJUST|LONG_HEX,</i>
&gt;<i> &gt; +			MKSTR(mbi-&gt;memory_block)),</i>
&gt;<i> &gt; +			mkstring(buf2, 10, CENTER, mbi-&gt;name),</i>
&gt;<i> &gt; +			mkstring(buf3, PADDR_PRLEN, RJUST|LONG_HEX,</i>
&gt;<i> &gt; +			MKSTR(pfn_to_phys(pfn))),</i>
&gt;<i> &gt; +			mkstring(buf4, PADDR_PRLEN, LJUST|LONG_HEX,</i>
&gt;<i> &gt; +			MKSTR(pfn_to_phys(pfn + nr_mb_pages) - 1)),</i>
&gt;<i> &gt; +			mkstring(buf5, strlen(&quot;CANCEL_OFFLINE&quot;), LJUST,</i>
&gt;<i> &gt; +			mbi-&gt;state));</i>
&gt;<i> &gt; +}</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +static void</i>
&gt;<i> &gt; +do_mem_block_and_sections(int print_memblk, struct memory_block_info</i>
&gt;<i> &gt; *mbi_tbl)</i>
&gt;<i> &gt; +{</i>
&gt;<i> &gt; +	ulong nr, addr;</i>
&gt;<i> &gt; +	ulong nr_mem_sections, nr_mb_pages;</i>
&gt;<i> &gt;  	ulong coded_mem_map, mem_map, pfn;</i>
&gt;<i> &gt; +	struct memory_block_info *mbi;</i>
&gt;<i> &gt; +	char mb_hdr[BUFSIZE];</i>
&gt;<i> &gt; +	char ms_hdr[BUFSIZE];</i>
&gt;<i> &gt; +	char statebuf[BUFSIZE];</i>
&gt;<i> &gt;  	char buf1[BUFSIZE];</i>
&gt;<i> &gt;  	char buf2[BUFSIZE];</i>
&gt;<i> &gt;  	char buf3[BUFSIZE];</i>
&gt;<i> &gt;  	char buf4[BUFSIZE];</i>
&gt;<i> &gt; +	char buf5[BUFSIZE];</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	nr_mb_pages = PAGES_PER_SECTION() *</i>
&gt;<i> &gt; +			get_memory_block_size() / MIN_MEMORY_BLOCK_SIZE;</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	if (MEMBER_EXISTS(&quot;memory_block&quot;, &quot;nid&quot;))</i>
&gt;<i> &gt; +		sprintf(mb_hdr, &quot;\n%s %s %s     %s %s\n&quot;,</i>
&gt;<i> &gt; +			mkstring(buf1, VADDR_PRLEN, CENTER|LJUST, &quot;MEM_BLOCK&quot;),</i>
&gt;<i> &gt; +			mkstring(buf2, 10, CENTER, &quot;NAME&quot;),</i>
&gt;<i> &gt; +			mkstring(buf3, PADDR_PRLEN*2 + 2, CENTER, &quot;PHYSICAL RANGE&quot;),</i>
&gt;<i> &gt; +			mkstring(buf4, strlen(&quot;NODE&quot;), CENTER, &quot;NODE&quot;),</i>
&gt;<i> &gt; +			mkstring(buf5, strlen(&quot;CANCEL_OFFLINE&quot;), LJUST, &quot;STATE&quot;));</i>
&gt;<i> &gt; +	else</i>
&gt;<i> &gt; +		sprintf(mb_hdr, &quot;\n%s %s %s     %s\n&quot;,</i>
&gt;<i> &gt; +			mkstring(buf1, VADDR_PRLEN, CENTER|LJUST, &quot;MEM_BLOCK&quot;),</i>
&gt;<i> &gt; +			mkstring(buf2, 10, CENTER, &quot;NAME&quot;),</i>
&gt;<i> &gt; +			mkstring(buf3, PADDR_PRLEN*2, CENTER, &quot;PHYSICAL RANGE&quot;),</i>
&gt;<i> &gt; +			mkstring(buf4, strlen(&quot;CANCEL_OFFLINE&quot;), LJUST, &quot;STATE&quot;));</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	sprintf(ms_hdr, &quot;NR     %s  %s  %s  %s %s\n&quot;,</i>
&gt;<i> &gt; +		mkstring(buf1, VADDR_PRLEN, CENTER|LJUST, &quot;SECTION&quot;),</i>
&gt;<i> &gt; +		mkstring(buf2, MAX(VADDR_PRLEN, strlen(&quot;CODED_MEM_MAP&quot;)),</i>
&gt;<i> &gt; +		CENTER|LJUST, &quot;CODED_MEM_MAP&quot;),</i>
&gt;<i> &gt; +		mkstring(buf3, VADDR_PRLEN, CENTER|LJUST, &quot;MEM_MAP&quot;),</i>
&gt;<i> &gt; +		mkstring(buf4, 12, CENTER, &quot;PFN&quot;),</i>
&gt;<i> &gt; +		mkstring(buf5, 12, LJUST, &quot;STATE&quot;));</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	if (!print_memblk)</i>
&gt;<i> &gt; +		fprintf(fp, &quot;%s&quot;, ms_hdr);</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	nr_mem_sections = NR_MEM_SECTIONS();</i>
&gt;<i> &gt; +	for (nr = 0; nr &lt; nr_mem_sections ; nr++) {</i>
&gt;<i> &gt; +		addr = valid_section_nr(nr);</i>
&gt;<i> &gt; +		if (addr) {</i>
&gt;<i> &gt; +			coded_mem_map = section_mem_map_addr(addr, 0);</i>
&gt;<i> &gt; +			mem_map = sparse_decode_mem_map(coded_mem_map, nr);</i>
&gt;<i> &gt; +			pfn = section_nr_to_pfn(nr);</i>
&gt;<i> &gt; +			fill_mem_section_state(section_mem_map_addr(addr, 1),</i>
&gt;<i> &gt; +						statebuf);</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +			if ((print_memblk) &amp;&amp; (is_memory_block_head(pfn))) {</i>
&gt;<i> &gt; +				mbi = get_memory_block_info(pfn, mbi_tbl);</i>
&gt;<i> &gt; +				fprintf(fp, &quot;%s&quot;, mb_hdr);</i>
&gt;<i> &gt; +				print_memory_block(pfn, nr_mb_pages, mbi);</i>
&gt;<i> &gt; +				fprintf(fp, &quot;%s&quot;, ms_hdr);</i>
&gt;<i> &gt; +			}</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +			fprintf(fp, &quot;%5ld  %s  %s  %s  %s %s\n&quot;,</i>
&gt;<i> &gt; +				nr,</i>
&gt;<i> &gt; +				mkstring(buf1, VADDR_PRLEN,</i>
&gt;<i> &gt; +				CENTER|LONG_HEX, MKSTR(addr)),</i>
&gt;<i> &gt; +				mkstring(buf2, MAX(VADDR_PRLEN,</i>
&gt;<i> &gt; +				strlen(&quot;CODED_MEM_MAP&quot;)),</i>
&gt;<i> &gt; +				CENTER|LONG_HEX|RJUST, MKSTR(coded_mem_map)),</i>
&gt;<i> &gt; +				mkstring(buf3, VADDR_PRLEN,</i>
&gt;<i> &gt; +				CENTER|LONG_HEX|RJUST, MKSTR(mem_map)),</i>
&gt;<i> &gt; +				pc-&gt;output_radix == 10 ?</i>
&gt;<i> &gt; +				mkstring(buf4, 12,</i>
&gt;<i> &gt; +				LONG_DEC|LJUST, MKSTR(pfn)) :</i>
&gt;<i> &gt; +				mkstring(buf4, 12,</i>
&gt;<i> &gt; +				LONG_HEX|LJUST, MKSTR(pfn)),</i>
&gt;<i> &gt; +				mkstring(buf5, 12, LJUST, statebuf));</i>
&gt;<i> &gt; +		}</i>
&gt;<i> &gt; +	}</i>
&gt;<i> &gt; +}</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +void</i>
&gt;<i> &gt; +dump_mem_sections(void)</i>
&gt;<i> &gt; +{</i>
&gt;<i> &gt; +	do_mem_block_and_sections(0, NULL);</i>
&gt;<i> &gt; +}</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +void</i>
&gt;<i> &gt; +_dump_mem_block_and_sections(void)</i>
&gt;<i> &gt; +{</i>
&gt;<i> &gt; +	struct memory_block_info *mbi_tbl;</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +	mbi_tbl = parse_memory_block();</i>
&gt;<i> &gt; +	do_mem_block_and_sections(1, mbi_tbl);</i>
&gt;<i> &gt; +	free(mbi_tbl);</i>
&gt;<i> &gt; +}</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +void</i>
&gt;<i> &gt; +dump_mem_block_and_sections(int initialize)</i>
&gt;<i> &gt; +{</i>
&gt;<i> &gt; +	ulong nr, max;</i>
&gt;<i> &gt; +	ulong nr_mem_sections;</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt;  	nr_mem_sections = NR_MEM_SECTIONS();</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt; @@ -17212,34 +17564,12 @@ dump_mem_sections(int initialize)</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt;  	fprintf(fp, &quot;\n&quot;);</i>
&gt;<i> &gt;  	pad_line(fp, BITS32() ? 59 : 67, '-');</i>
&gt;<i> &gt; -        fprintf(fp, &quot;\n\nNR  %s  %s  %s  PFN\n&quot;,</i>
&gt;<i> &gt; -                mkstring(buf1, VADDR_PRLEN, CENTER|LJUST, &quot;SECTION&quot;),</i>
&gt;<i> &gt; -                mkstring(buf2, MAX(VADDR_PRLEN,strlen(&quot;CODED_MEM_MAP&quot;)),</i>
&gt;<i> &gt; -		CENTER|LJUST, &quot;CODED_MEM_MAP&quot;),</i>
&gt;<i> &gt; -                mkstring(buf3, VADDR_PRLEN, CENTER|LJUST, &quot;MEM_MAP&quot;));</i>
&gt;<i> &gt; -</i>
&gt;<i> &gt; -	for (nr = 0; nr &lt; nr_mem_sections ; nr++) {</i>
&gt;<i> &gt; -		if ((addr = valid_section_nr(nr))) {</i>
&gt;<i> &gt; -			coded_mem_map = section_mem_map_addr(addr);</i>
&gt;<i> &gt; -			mem_map = sparse_decode_mem_map(coded_mem_map,nr);</i>
&gt;<i> &gt; -			pfn = section_nr_to_pfn(nr);</i>
&gt;<i> &gt; -</i>
&gt;<i> &gt; -        		fprintf(fp, &quot;%2ld  %s  %s  %s  %s\n&quot;,</i>
&gt;<i> &gt; -                		nr,</i>
&gt;<i> &gt; -                		mkstring(buf1, VADDR_PRLEN,</i>
&gt;<i> &gt; -                        	CENTER|LONG_HEX, MKSTR(addr)),</i>
&gt;<i> &gt; -                		mkstring(buf2, MAX(VADDR_PRLEN,</i>
&gt;<i> &gt; -				strlen(&quot;CODED_MEM_MAP&quot;)),</i>
&gt;<i> &gt; -                        	CENTER|LONG_HEX|RJUST, MKSTR(coded_mem_map)),</i>
&gt;<i> &gt; -                		mkstring(buf3, VADDR_PRLEN,</i>
&gt;<i> &gt; -                        	CENTER|LONG_HEX|RJUST, MKSTR(mem_map)),</i>
&gt;<i> &gt; -				pc-&gt;output_radix == 10 ?</i>
&gt;<i> &gt; -                		mkstring(buf4, VADDR_PRLEN,</i>
&gt;<i> &gt; -                        	LONG_DEC|LJUST, MKSTR(pfn)) :</i>
&gt;<i> &gt; -                		mkstring(buf4, VADDR_PRLEN,</i>
&gt;<i> &gt; -                        	LONG_HEX|LJUST, MKSTR(pfn)));</i>
&gt;<i> &gt; -		}</i>
&gt;<i> &gt; -	}</i>
&gt;<i> &gt; +	fprintf(fp, &quot;\n\n&quot;);</i>
&gt;<i> &gt; +	if ((!STRUCT_EXISTS(&quot;memory_block&quot;)) ||</i>
&gt;<i> &gt; +				(!symbol_exists(&quot;memory_subsys&quot;)))</i>
&gt;<i> &gt; +		dump_mem_sections();</i>
&gt;<i> &gt; +	else</i>
&gt;<i> &gt; +		_dump_mem_block_and_sections();</i>
&gt;<i> &gt;  }</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt;  void</i>
&gt;<i> &gt; @@ -17251,7 +17581,7 @@ list_mem_sections(void)</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt;  	for (nr = 0; nr &lt;= nr_mem_sections ; nr++) {</i>
&gt;<i> &gt;  		if ((addr = valid_section_nr(nr))) {</i>
&gt;<i> &gt; -			coded_mem_map = section_mem_map_addr(addr);</i>
&gt;<i> &gt; +			coded_mem_map = section_mem_map_addr(addr, 0);</i>
&gt;<i> &gt;  			fprintf(fp,</i>
&gt;<i> &gt;  			    &quot;nr=%ld section = %lx coded_mem_map=%lx pfn=%ld mem_map=%lx\n&quot;,</i>
&gt;<i> &gt;  				nr,</i>
&gt;<i> &gt; --</i>
&gt;<i> &gt; 2.19.0</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; --</i>
&gt;<i> &gt; Crash-utility mailing list</i>
&gt;<i> &gt; Crash-utility@xxxxxxxxxx</i>
&gt;<i> &gt; <a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/crash-utility">https://www.redhat.com/mailman/listinfo/crash-utility</a></i>
&gt;<i> &gt; </i>
&gt;<i> </i>
&gt;<i> --</i>
&gt;<i> Crash-utility mailing list</i>
&gt;<i> Crash-utility@xxxxxxxxxx</i>
&gt;<i> <a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/crash-utility">https://www.redhat.com/mailman/listinfo/crash-utility</a></i>

--
Crash-utility mailing list
Crash-utility@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/crash-utility">https://www.redhat.com/mailman/listinfo/crash-utility</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="07604" href="msg07604.html">Re:  [PATCH] kmem: update n option to dump memory block</a></strong>
<ul><li><em>From:</em> Dave Anderson</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="07600" href="msg07600.html">[PATCH] kmem: update n option to dump memory block</a></strong>
<ul><li><em>From:</em> Masayoshi Mizuma</li></ul></li>
<li><strong><a name="07602" href="msg07602.html">Re:  [PATCH] kmem: update n option to dump memory block</a></strong>
<ul><li><em>From:</em> Dave Anderson</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg07602.html">Re:  [PATCH] kmem: update n option to dump memory block</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg07604.html">Re:  [PATCH] kmem: update n option to dump memory block</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg07602.html">Re:  [PATCH] kmem: update n option to dump memory block</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg07604.html">Re:  [PATCH] kmem: update n option to dump memory block</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#07603"><strong>Date</strong></a></li>
<li><a href="index.html#07603"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-devel/>[Fedora&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width="100%">
<tr>
<td align=left>&nbsp;</td>
<td valign=top align=right><H1><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></H1></td>
</tr></table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH v2 0/4] Generalize KASLR calculation and	use it for KDUMPs -->
<!--X-From-R13: Eretvb Zbcrm &#60;fycNerqung.pbz> -->
<!--X-Date: Mon, 19 Mar 2018 05:50:48 &#45;0700 -->
<!--X-Message-Id: 20180319125037.n7buxfc4uknswncm@dritchie -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20180316173107.31203&#45;1&#45;slp@redhat.com -->
<!--X-Reference: 1715367817.11987518.1521232421643.JavaMail.zimbra@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re:  [PATCH v2 0/4] Generalize KASLR calculation and	use it for KDUMPs &mdash; Red Hat Crash Utility">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Red Hat Crash Utility &mdash;  Re:  [PATCH v2 0/4] Generalize KASLR calculation and	use it for KDUMPs</title>
<link rel="alternate" type="application/rss+xml" title="Red Hat Crash Utility" href="//feeds.feedburner.com/RedHatCrashUtility">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [PATCH v2 0/4] Generalize KASLR calculation and	use it for KDUMPs</h1>
[<a href="msg07380.html">Date Prev</a>][<a href="msg07382.html">Date Next</a>][<a href="msg07379.html">Thread Prev</a>][<a href="msg07382.html">Thread Next</a>][<a href="maillist.html#07381">Date Index</a>][<a href="index.html#07381">Thread Index</a>]
<script src="https://apis.google.com/js/platform.js" async defer></script>
<g:plusone size="small"></g:plusone>
<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH v2 0/4] Generalize KASLR calculation and	use it for KDUMPs</li>
<li><em>From</em>: Sergio Lopez &lt;slp@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Mon, 19 Mar 2018 13:50:37 +0100</li>
<li><em>Cc</em>: crash-utility@xxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg07379.html">1715367817.11987518.1521232421643.JavaMail.zimbra@redhat.com</a>&gt;</li>
<li><em>Reply-to</em>: &quot;Discussion list for crash utility usage,	maintenance and development&quot; &lt;crash-utility@xxxxxxxxxx&gt;</li>
<li><em>User-agent</em>: NeoMutt/20171215</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" defer async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Fri, Mar 16, 2018 at 04:33:41PM -0400, Dave Anderson wrote:
&gt;<i>   </i>
&gt;<i> Hi Sergio,</i>
&gt;<i> </i>
&gt;<i> A few initial comments/questions/concerns about this patch...</i>
&gt;<i> </i>
&gt;<i> &gt; diff --git a/diskdump.c b/diskdump.c</i>
&gt;<i> &gt; index b08a46c..1ec4bcf 100644</i>
&gt;<i> &gt; --- a/diskdump.c</i>
&gt;<i> &gt; +++ b/diskdump.c</i>
&gt;<i> &gt; @@ -56,6 +56,7 @@ struct diskdump_data {</i>
&gt;<i> &gt;          void        **nt_prstatus_percpu;</i>
&gt;<i> &gt;          uint        num_prstatus_notes;</i>
&gt;<i> &gt;          void        **nt_qemu_percpu;</i>
&gt;<i> &gt; +        void        **nt_qemucs_percpu;</i>
&gt;<i> &gt;          uint        num_qemu_notes;</i>
&gt;<i> &gt; </i>
&gt;<i> &gt;          /* page cache */</i>
&gt;<i> &gt; @@ -72,6 +73,7 @@ struct diskdump_data {</i>
&gt;<i> &gt;          ulong  *valid_pages;</i>
&gt;<i> &gt;          ulong   accesses;</i>
&gt;<i> &gt;          ulong        snapshot_task;</i>
&gt;<i> &gt; +        ulong        kaslr_phys_base;</i>
&gt;<i> &gt;  };</i>
&gt;<i> </i>
&gt;<i> Generally speaking, there already is an sd-&gt;phys_base, and you've</i>
&gt;<i> added an nd-&gt;phys_base, but I don't understand why you also added </i>
&gt;<i> a new dd-&gt;kaslr_phys_base member and new diskdump_kaslr_phys_base()</i>
&gt;<i> function?  Is there any reason that you can't continue to use the </i>
&gt;<i> currently-existing dd-&gt;sub_header_kdump-&gt;phys_base member and the</i>
&gt;<i> diskdump_phys_base() function?  I just find the concept of a</i>
&gt;<i> &quot;kaslr_phys_base&quot; confusing, i.e., as if there are two different</i>
&gt;<i> types of phys_base in the kernel.  Can you please try to utilize</i>
&gt;<i> the existing member and function?  </i>
&gt;<i> </i>
&gt;<i> Also related, your diskdump_kaslr_phys_base() and kdump_phys_base() functions</i>
&gt;<i> don't account for (return FALSE) with a legitimate phys_base value of 0.</i>
&gt;<i> In fact I have a sample RHEL7 ELF vmcore generated by virsh dump which</i>
&gt;<i> has a phys_base of 0.  More on that below...</i>

Both of these are the consequence of trying to avoid changing the current
SADUMP's implementation while keeping NETDUMP's and DISKDUMP's as similar as
possible.

But if there's no problem in changing SADUMP's, I would change the setters to
succeed unconditionally, and remove the &quot;if (base-&gt;phys_base)&quot; check from the
getters. This would make them semantically equivalent to current's
&quot;diskdump_phys_base&quot;, which is the main reason I've added kaslr_phys_base,
allowing me to use the existing dd-&gt;sub_header_kdump-&gt;phys_base.

&gt;<i> &gt; diff --git a/kaslr_helper.c b/kaslr_helper.c</i>
&gt;<i> &gt; index 1079863..5b71e3e 100644</i>
&gt;<i> &gt; --- a/kaslr_helper.c</i>
&gt;<i> &gt; +++ b/kaslr_helper.c</i>
&gt;<i> &gt; @@ -386,6 +386,9 @@ calc_kaslr_offset(ulong *kaslr_offset, ulong *phys_base)</i>
&gt;<i> &gt;  		if (KDUMP_DUMPFILE()) {</i>
&gt;<i> &gt;  			idtr = kdump_get_idtr();</i>
&gt;<i> &gt;  			cr3 = kdump_get_cr3();</i>
&gt;<i> &gt; +		} else if (DISKDUMP_DUMPFILE()) {</i>
&gt;<i> &gt; +			idtr = diskdump_get_idtr();</i>
&gt;<i> &gt; +			cr3 = diskdump_get_cr3();</i>
&gt;<i> </i>
&gt;<i> All 4 of these new functions above can fail and return 0.  Probably</i>
&gt;<i> unlikely, but shouldn't there be a FALSE return if either one is 0,</i>
&gt;<i> rather than continuing and using them?</i>

Again, I was trying to keep in sync with current SADUMP's implementation.
Otherwise, I'd prefer implementing a single function like this:

int [diskdump|kdump|sadump]_get_idtr_cr3(uint64_t *idtr, uint64_t *cr3);

That would allow me to write some like:

if ((KDUMP_DUMPFILE() &amp;&amp; !kdump_get_idtr_cr3(&amp;idtr, &amp;cr3)) ||
    (DISKDUMP_DUMPFILE() &amp;&amp; !diskdump_get_idtr_cr3(&amp;idtr, &amp;cr3))) {
        return FALSE;
}

What do you think?

&gt;<i> &gt;  		} else {</i>
&gt;<i> &gt;  			return FALSE;</i>
&gt;<i> &gt;  		}</i>
&gt;<i> </i>
&gt;<i> &gt; diff --git a/x86_64.c b/x86_64.c</i>
&gt;<i> &gt; index ed5985a..3c492e4 100644</i>
&gt;<i> &gt; --- a/x86_64.c</i>
&gt;<i> &gt; +++ b/x86_64.c</i>
&gt;<i> &gt; @@ -6632,8 +6632,15 @@ x86_64_calc_phys_base(void)</i>
&gt;<i> &gt;  	 *  Get relocation value from whatever dumpfile format is being used.</i>
&gt;<i> &gt;  	 */</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt; -	if (QEMU_MEM_DUMP_NO_VMCOREINFO() &amp;&amp; KDUMP_DUMPFILE()) {</i>
&gt;<i> &gt; -		if (kdump_phys_base(&amp;phys_base)) {</i>
&gt;<i> &gt; +	if (QEMU_MEM_DUMP_NO_VMCOREINFO()) {</i>
&gt;<i> &gt; +		int ret;</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +		if (KDUMP_DUMPFILE())</i>
&gt;<i> &gt; +			ret = kdump_phys_base(&amp;phys_base);</i>
&gt;<i> &gt; +		else if (DISKDUMP_DUMPFILE())</i>
&gt;<i> &gt; +			ret = diskdump_kaslr_phys_base(&amp;phys_base);</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +		if (ret) {</i>
&gt;<i> &gt;  			machdep-&gt;machspec-&gt;phys_base = phys_base;</i>
&gt;<i> &gt;  			if (CRASHDEBUG(1))</i>
&gt;<i> &gt;  				fprintf(fp, &quot;kdump-novmci: phys base: %lx\n&quot;,</i>
&gt;<i> &gt; --</i>
&gt;<i> &gt; 2.14.3</i>
&gt;<i> </i>
&gt;<i> This is where the &quot;0 phys_base&quot; issue comes into play.  I think the section</i>
&gt;<i> above should do the same thing as the following &quot;if (DISKDUMP_DUMPFILE())&quot; </i>
&gt;<i> does, where diskump_phys_base() is only concerned if the dumpfile itself </i>
&gt;<i> is valid.  It may return 0 as a phys_base, and that's OK, because it </i>
&gt;<i> unconditionally calls x86_64_virt_phys_base() -- which serves a dual</i>
&gt;<i> purpose, either to:</i>
&gt;<i>  </i>
&gt;<i>    (1) verify it, or</i>
&gt;<i>    (2) if it's bogus, it checks whether plus-or-minus 16MB works.</i>

After switching to using dd-&gt;sub_header_kdump-&gt;phys_base, do you think we can
just leave QEMU_MEM_DUMP_COMPRESSED to be dealt by the DISKDUMP_DUMPFILE
section, and add another equivalent one for QEMU_MEM_DUMP_ELF &amp;&amp; !VMCOREINFO?

Sergio.

--
Crash-utility mailing list
Crash-utility@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/crash-utility">https://www.redhat.com/mailman/listinfo/crash-utility</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="07382" href="msg07382.html">Re:  [PATCH v2 0/4] Generalize KASLR calculation and use it for KDUMPs</a></strong>
<ul><li><em>From:</em> Dave Anderson</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="07374" href="msg07374.html">[PATCH v2 0/4] Generalize KASLR calculation and use	it for KDUMPs</a></strong>
<ul><li><em>From:</em> Sergio Lopez</li></ul></li>
<li><strong><a name="07379" href="msg07379.html">Re:  [PATCH v2 0/4] Generalize KASLR calculation and use it for KDUMPs</a></strong>
<ul><li><em>From:</em> Dave Anderson</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg07380.html">Re:  modules loaded from wrong directory</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg07382.html">Re:  [PATCH v2 0/4] Generalize KASLR calculation and use it for KDUMPs</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg07379.html">Re:  [PATCH v2 0/4] Generalize KASLR calculation and use it for KDUMPs</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg07382.html">Re:  [PATCH v2 0/4] Generalize KASLR calculation and use it for KDUMPs</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#07381"><strong>Date</strong></a></li>
<li><a href="index.html#07381"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-devel/>[Fedora&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width="100%">
<tr>
<td align=left>&nbsp;</td>
<td valign=top align=right><H1><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></H1></td>
</tr></table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH] fix for "sys &#45;c" option for certain	vmcores -->
<!--X-From-R13: Rnir Oaqrefba &#60;naqrefbaNerqung.pbz> -->
<!--X-Date: Thu, 30 May 2019 14:03:36 &#45;0700 -->
<!--X-Message-Id: 1395958351.26092828.1559250199522.JavaMail.zimbra@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 33142207&#45;b10f&#45;31a2&#45;c52f&#45;6fe94fe1b2ad@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re:  [PATCH] fix for &quot;sys -c&quot; option for certain	vmcores &mdash; Red Hat Crash Utility">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Red Hat Crash Utility &mdash;  Re:  [PATCH] fix for &quot;sys -c&quot; option for certain	vmcores</title>
<link rel="alternate" type="application/rss+xml" title="Red Hat Crash Utility" href="//feeds.feedburner.com/RedHatCrashUtility">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [PATCH] fix for &quot;sys -c&quot; option for certain	vmcores</h1>
[<a href="msg07767.html">Date Prev</a>][<a href="msg07769.html">Date Next</a>][<a href="msg07767.html">Thread Prev</a>][<a href="msg07769.html">Thread Next</a>][<a href="maillist.html#07768">Date Index</a>][<a href="index.html#07768">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH] fix for &quot;sys -c&quot; option for certain	vmcores</li>
<li><em>From</em>: Dave Anderson &lt;anderson@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 30 May 2019 17:03:19 -0400 (EDT)</li>
<li><em>Cc</em>: &quot;Discussion list for crash utility usage,	maintenance and development&quot; &lt;crash-utility@xxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg07767.html">33142207-b10f-31a2-c52f-6fe94fe1b2ad@redhat.com</a>&gt;</li>
<li><em>Reply-to</em>: &quot;Discussion list for crash utility usage,	maintenance and development&quot; &lt;crash-utility@xxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" defer async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>

----- Original Message -----
&gt;<i> Hi Dave,</i>
&gt;<i> </i>
&gt;<i> I don't know why this difference arises, but with certain kernel configurations,</i>
&gt;<i> the source file and line information of the schedule() function becomes the</i>
&gt;<i> following, not &quot;/kernel/sched/core.c&quot;.</i>
&gt;<i> </i>
&gt;<i>   crash&gt; sym schedule</i>
&gt;<i>   ffffffffab0d3666 (T) schedule</i>
&gt;<i>   /share/src/linux-5.0.1/./arch/x86/include/asm/current.h: 15</i>

Yeah, presumably happens because your kernel doesn't have the ftrace nop compiled
into the beginning of each function.  When it does, the first address in the
schedule function would be in kernel/sched/core.c:

  crash&gt; sym schedule
  ffffffffa22b5dc0 (T) schedule /usr/src/debug/kernel-5.2.0-0.rc2.1.elrdy/linux-5.2.0-0.rc2.1.elrdy.x86_64/kernel/sched/core.c: 3503
  crash&gt; dis -l schedule
  /usr/src/debug/kernel-5.2.0-0.rc2.1.elrdy/linux-5.2.0-0.rc2.1.elrdy.x86_64/kernel/sched/core.c: 3503
  0xffffffffa22b5dc0 &lt;schedule&gt;:  nopl   0x0(%rax,%rax,1) [FTRACE NOP]
  /usr/src/debug/kernel-5.2.0-0.rc2.1.elrdy/linux-5.2.0-0.rc2.1.elrdy.x86_64/./arch/x86/include/asm/current.h: 15
  0xffffffffa22b5dc5 &lt;schedule+5&gt;:        push   %rbx
  0xffffffffa22b5dc6 &lt;schedule+6&gt;:        mov    %gs:0x15f00,%rbx
  /usr/src/debug/kernel-5.2.0-0.rc2.1.elrdy/linux-5.2.0-0.rc2.1.elrdy.x86_64/kernel/sched/core.c: 3506
  0xffffffffa22b5dcf &lt;schedule+15&gt;:       mov    0x10(%rbx),%rax
  0xffffffffa22b5dd3 &lt;schedule+19&gt;:       test   %rax,%rax
  0xffffffffa22b5dd6 &lt;schedule+22&gt;:       je     0xffffffffa22b5de2 &lt;schedule+34&gt;
  ...

If ftrace is not enabled, then it would show asm/current.h because the first instruction
in schedule() is the evaluation of &quot;current&quot;: 

  asmlinkage __visible void __sched schedule(void)
  {
          struct task_struct *tsk = current;

which is #define'd in asm/current.h:

  #define get_current() (current_thread_info()-&gt;task)
  #define current get_current()

Anyway, I'll take a look and test the patch tomorrow.

Thanks,
  Dave

&gt;<i> </i>
&gt;<i> This causes the &quot;sys -c&quot; option not to print the information of system calls,</i>
&gt;<i> and makes it very slow.</i>
&gt;<i> </i>
&gt;<i>   crash&gt; sys -c | sh -c 'time cat'</i>
&gt;<i>   NUM  SYSTEM CALL                FILE AND LINE NUMBER</i>
&gt;<i>     0  __x64_sys_read</i>
&gt;<i>     1  __x64_sys_write</i>
&gt;<i>     2  __x64_sys_open</i>
&gt;<i>   ...</i>
&gt;<i>   333  __x64_sys_io_pgetevents</i>
&gt;<i>   334  __x64_sys_rseq</i>
&gt;<i> </i>
&gt;<i>   real    2m32.669s</i>
&gt;<i>   user    0m0.002s</i>
&gt;<i>   sys     0m0.022s</i>
&gt;<i> </i>
&gt;<i> With this patch, the option can print the information in not too long time:</i>
&gt;<i> </i>
&gt;<i>   crash&gt; sys -c | sh -c 'time cat'</i>
&gt;<i>   NUM  SYSTEM CALL                FILE AND LINE NUMBER</i>
&gt;<i>     0  __x64_sys_read             ../fs/read_write.c: 588</i>
&gt;<i>     1  __x64_sys_write            ../fs/read_write.c: 610</i>
&gt;<i>     2  __x64_sys_open             ../fs/open.c: 1079</i>
&gt;<i>   ...</i>
&gt;<i>   333  __x64_sys_io_pgetevents    ../fs/aio.c: 2139</i>
&gt;<i>   334  __x64_sys_rseq             ../kernel/rseq.c: 308</i>
&gt;<i> </i>
&gt;<i>   real    0m10.905s</i>
&gt;<i>   user    0m0.000s</i>
&gt;<i>   sys     0m0.024s</i>
&gt;<i> </i>
&gt;<i> Also, in dump_sys_call_table(), it looks like there is no need to call</i>
&gt;<i> get_build_directory() for each system call, so moving it out of the loop</i>
&gt;<i> makes it faster.</i>
&gt;<i> </i>
&gt;<i> [without moving the get_build_directory()]</i>
&gt;<i>   real    0m15.862s</i>
&gt;<i>   user    0m0.003s</i>
&gt;<i>   sys     0m0.020s</i>
&gt;<i> </i>
&gt;<i> Signed-off-by: Kazuhito Hagio &lt;k-hagio@xxxxxxxxxxxxx&gt;</i>
&gt;<i> ---</i>
&gt;<i>  kernel.c  | 2 +-</i>
&gt;<i>  symbols.c | 2 +-</i>
&gt;<i>  2 files changed, 2 insertions(+), 2 deletions(-)</i>
&gt;<i> </i>
&gt;<i> diff --git a/kernel.c b/kernel.c</i>
&gt;<i> index db25f22e4ec6..22909d28cefc 100644</i>
&gt;<i> --- a/kernel.c</i>
&gt;<i> +++ b/kernel.c</i>
&gt;<i> @@ -5679,6 +5679,7 @@ dump_sys_call_table(char *spec, int cnt)</i>
&gt;<i>  </i>
&gt;<i>  	fprintf(fp, &quot;%s&quot;, sys_call_hdr);</i>
&gt;<i>  </i>
&gt;<i> +	get_build_directory(buf2);</i>
&gt;<i>          for (i = 0, sct = sys_call_table; i &lt; NR_syscalls; i++, sct++) {</i>
&gt;<i>                  if (!(scp = value_symbol(*sct))) {</i>
&gt;<i>  			if (confirmed || CRASHDEBUG(1)) {</i>
&gt;<i> @@ -5710,7 +5711,6 @@ dump_sys_call_table(char *spec, int cnt)</i>
&gt;<i>  	  	 */</i>
&gt;<i>                  sp = value_search(*sct, NULL);</i>
&gt;<i>                  spn = next_symbol(NULL, sp);</i>
&gt;<i> -		get_build_directory(buf2);</i>
&gt;<i>  </i>
&gt;<i>  		for (addr = *sct; sp &amp;&amp; spn &amp;&amp; (addr &lt; spn-&gt;value); addr++) {</i>
&gt;<i>  			BZERO(buf1, BUFSIZE);</i>
&gt;<i> diff --git a/symbols.c b/symbols.c</i>
&gt;<i> index 863d1f0a8e25..3ce8692fd397 100644</i>
&gt;<i> --- a/symbols.c</i>
&gt;<i> +++ b/symbols.c</i>
&gt;<i> @@ -4296,7 +4296,7 @@ get_build_directory(char *buf)</i>
&gt;<i>  		get_line_number(symbol_value(&quot;do_schedule&quot;), buf, FALSE);</i>
&gt;<i>  	else</i>
&gt;<i>  		return NULL;</i>
&gt;<i> -	if ((p = strstr(buf, &quot;/kernel/&quot;)))</i>
&gt;<i> +	if ((p = strstr(buf, &quot;/kernel/&quot;)) || (p = strstr(buf, &quot;/./arch/&quot;)))</i>
&gt;<i>  		*p = NULLCHAR;</i>
&gt;<i>  	else</i>
&gt;<i>  		return(NULL);</i>
&gt;<i> --</i>
&gt;<i> 2.18.1</i>
&gt;<i> </i>

--
Crash-utility mailing list
Crash-utility@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/crash-utility">https://www.redhat.com/mailman/listinfo/crash-utility</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="07769" href="msg07769.html">Re:  [PATCH] fix for &quot;sys -c&quot; option for certain vmcores</a></strong>
<ul><li><em>From:</em> Kazuhito Hagio</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="07767" href="msg07767.html">[PATCH] fix for &quot;sys -c&quot; option for certain vmcores</a></strong>
<ul><li><em>From:</em> Kazuhito Hagio</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg07767.html">[PATCH] fix for &quot;sys -c&quot; option for certain vmcores</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg07769.html">Re:  [PATCH] fix for &quot;sys -c&quot; option for certain vmcores</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg07767.html">[PATCH] fix for &quot;sys -c&quot; option for certain vmcores</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg07769.html">Re:  [PATCH] fix for &quot;sys -c&quot; option for certain vmcores</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#07768"><strong>Date</strong></a></li>
<li><a href="index.html#07768"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-devel/>[Fedora&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width="100%">
<tr>
<td align=left>&nbsp;</td>
<td valign=top align=right><H1><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></H1></td>
</tr></table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

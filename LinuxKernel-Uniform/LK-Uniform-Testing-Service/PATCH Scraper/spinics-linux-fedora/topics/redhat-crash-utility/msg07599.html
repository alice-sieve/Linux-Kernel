<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH 2/2] ppc64/opal: Improve bt output when R1 falls in OPAL range -->
<!--X-From-R13: Vnev Pnguvav &#60;uonguvavNyvahk.voz.pbz> -->
<!--X-Date: Mon, 1 Oct 2018 10:23:06 &#45;0700 -->
<!--X-Message-Id: 153841457041.16766.4777728998179656100.stgit@hbathini.in.ibm.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 153841456342.16766.4457806001165659285.stgit@hbathini.in.ibm.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="[PATCH 2/2] ppc64/opal: Improve bt output when R1 falls in OPAL range &mdash; Red Hat Crash Utility">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Red Hat Crash Utility &mdash;  [PATCH 2/2] ppc64/opal: Improve bt output when R1 falls in OPAL range</title>
<link rel="alternate" type="application/rss+xml" title="Red Hat Crash Utility" href="//feeds.feedburner.com/RedHatCrashUtility">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH 2/2] ppc64/opal: Improve bt output when R1 falls in OPAL range</h1>
[<a href="msg07598.html">Date Prev</a>][<a href="msg07600.html">Date Next</a>][<a href="msg07598.html">Thread Prev</a>][<a href="msg07600.html">Thread Next</a>][<a href="maillist.html#07599">Date Index</a>][<a href="index.html#07599">Thread Index</a>]
<script src="https://apis.google.com/js/platform.js" async defer></script>
<g:plusone size="small"></g:plusone>
<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH 2/2] ppc64/opal: Improve bt output when R1 falls in OPAL range</li>
<li><em>From</em>: Hari Bathini &lt;hbathini@xxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Mon, 01 Oct 2018 22:52:50 +0530</li>
<li><em>Cc</em>: crash-utility &lt;crash-utility@xxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg07598.html">153841456342.16766.4457806001165659285.stgit@hbathini.in.ibm.com</a>&gt;</li>
<li><em>Reply-to</em>: &quot;Discussion list for crash utility usage,	maintenance and development&quot; &lt;crash-utility@xxxxxxxxxx&gt;</li>
<li><em>User-agent</em>: StGit/0.17.1-dirty</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" defer async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On OPAL based systems, when a thread is running an OPAL API, the stack
pointer and instruction pointer would be pointing at OPAL address but
'bt' output for such thread would complain that the stack pointer is
invalid. Update error/log message for better context.

Signed-off-by: Hari Bathini &lt;hbathini@xxxxxxxxxxxxx&gt;
---
 ppc64.c |   36 ++++++++++++++++++++++++++++++++----
 1 file changed, 32 insertions(+), 4 deletions(-)

diff --git a/ppc64.c b/ppc64.c
index cf41765..041480b 100644
--- a/ppc64.c
+++ b/ppc64.c
@@ -65,8 +65,26 @@ static ulong hugepage_dir(ulong pte);
 static ulong pgd_page_vaddr_l4(ulong pgd);
 static ulong pud_page_vaddr_l4(ulong pud);
 static ulong pmd_page_vaddr_l4(ulong pmd);
+static int is_opal_context(ulong sp, ulong nip);
 void opalmsg(void);
 
+static int is_opal_context(ulong sp, ulong nip)
+{
+	uint64_t opal_start, opal_end;
+
+	if (!(machdep-&gt;flags &amp; OPAL_FW))
+		return FALSE;
+
+	opal_start = machdep-&gt;machspec-&gt;opal.base;
+	opal_end   = opal_start + machdep-&gt;machspec-&gt;opal.size;
+
+	if (((sp &gt;= opal_start) &amp;&amp; (sp &lt; opal_end)) ||
+	    ((nip &gt;= opal_start) &amp;&amp; (nip &lt; opal_end)))
+		return TRUE;
+
+	return FALSE;
+}
+
 static inline int is_hugepage(ulong pte)
 {
 	if ((machdep-&gt;flags &amp; BOOK3E) ||
@@ -2270,7 +2288,11 @@ ppc64_vmcore_stack_frame(struct bt_info *bt_in, ulong *nip, ulong *ksp)
 {
 	struct ppc64_pt_regs *pt_regs;
 	unsigned long unip;
-	int in_user_space = FALSE;
+	/*
+	 * TRUE: task is running in a different context (userspace, OPAL..)
+	 * FALSE: task is probably running in kernel space.
+	 */
+	int out_of_context = FALSE;
 
 	pt_regs = (struct ppc64_pt_regs *)bt_in-&gt;machdep;
 	if (!pt_regs || !pt_regs-&gt;gpr[1]) {
@@ -2283,20 +2305,25 @@ ppc64_vmcore_stack_frame(struct bt_info *bt_in, ulong *nip, ulong *ksp)
 			bt_in-&gt;task);
 		return FALSE;
 	}
+
 	*ksp = pt_regs-&gt;gpr[1];
 	if (IS_KVADDR(*ksp)) {
 		readmem(*ksp+16, KVADDR, &amp;unip, sizeof(ulong), &quot;Regs NIP value&quot;,
 			FAULT_ON_ERROR);
 		*nip = unip;
 	} else {
+		*nip = pt_regs-&gt;nip;
 		if (IN_TASK_VMA(bt_in-&gt;task, *ksp)) {
 			fprintf(fp, &quot;%0lx: Task is running in user space\n&quot;,
 				bt_in-&gt;task);
-			in_user_space = TRUE;
+			out_of_context = TRUE;
+		} else if (is_opal_context(*ksp, *nip)) {
+			fprintf(fp, &quot;%0lx: Task is running in OPAL (firmware) context\n&quot;,
+				bt_in-&gt;task);
+			out_of_context = TRUE;
 		} else
 			fprintf(fp, &quot;%0lx: Invalid Stack Pointer %0lx\n&quot;,
 				bt_in-&gt;task, *ksp);
-		*nip = pt_regs-&gt;nip;
 	}
 
 	if (bt_in-&gt;flags &amp;&amp;
@@ -2307,7 +2334,8 @@ ppc64_vmcore_stack_frame(struct bt_info *bt_in, ulong *nip, ulong *ksp)
 	 * Print the collected regs for the active task
 	 */
 	ppc64_print_regs(pt_regs);
-	if (in_user_space)
+
+	if (out_of_context)
 		return TRUE;
 	if (!IS_KVADDR(*ksp))
 		return FALSE;

--
Crash-utility mailing list
Crash-utility@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/crash-utility">https://www.redhat.com/mailman/listinfo/crash-utility</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="07598" href="msg07598.html">[PATCH 1/2] ppc64/opal: add a flag to determine if the kernel is running on OPAL firmware</a></strong>
<ul><li><em>From:</em> Hari Bathini</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg07598.html">[PATCH 1/2] ppc64/opal: add a flag to determine if the kernel is running on OPAL firmware</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg07600.html">[PATCH] kmem: update n option to dump memory block</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg07598.html">[PATCH 1/2] ppc64/opal: add a flag to determine if the kernel is running on OPAL firmware</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg07600.html">[PATCH] kmem: update n option to dump memory block</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#07599"><strong>Date</strong></a></li>
<li><a href="index.html#07599"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-devel/>[Fedora&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width="100%">
<tr>
<td align=left>&nbsp;</td>
<td valign=top align=right><H1><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></H1></td>
</tr></table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

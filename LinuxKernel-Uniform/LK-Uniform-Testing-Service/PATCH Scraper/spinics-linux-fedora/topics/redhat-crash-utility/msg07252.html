<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH 0/5] Second phase of future support for x86_64 5&#45;level page tables -->
<!--X-From-R13: Rnir Oaqrefba &#60;naqrefbaNerqung.pbz> -->
<!--X-Date: Thu, 11 Jan 2018 12:56:32 &#45;0800 -->
<!--X-Message-Id: 379099494.4826745.1515704168544.JavaMail.zimbra@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20180111073126.953&#45;1&#45;douly.fnst@cn.fujitsu.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re:  [PATCH 0/5] Second phase of future support for x86_64 5-level page tables &mdash; Red Hat Crash Utility">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Red Hat Crash Utility &mdash;  Re:  [PATCH 0/5] Second phase of future support for x86_64 5-level page tables</title>
<link rel="alternate" type="application/rss+xml" title="Red Hat Crash Utility" href="//feeds.feedburner.com/RedHatCrashUtility">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [PATCH 0/5] Second phase of future support for x86_64 5-level page tables</h1>
[<a href="msg07251.html">Date Prev</a>][<a href="msg07253.html">Date Next</a>][<a href="msg07251.html">Thread Prev</a>][<a href="msg07254.html">Thread Next</a>][<a href="maillist.html#07252">Date Index</a>][<a href="index.html#07252">Thread Index</a>]
<script src="https://apis.google.com/js/platform.js" async defer></script>
<g:plusone size="small"></g:plusone>
<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH 0/5] Second phase of future support for x86_64 5-level page tables</li>
<li><em>From</em>: Dave Anderson &lt;anderson@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 11 Jan 2018 15:56:08 -0500 (EST)</li>
<li><em>Cc</em>: fnstml-iaas@xxxxxxxxxxxxxx, crash-utility@xxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg07250.html">20180111073126.953-1-douly.fnst@cn.fujitsu.com</a>&gt;</li>
<li><em>Reply-to</em>: &quot;Discussion list for crash utility usage,	maintenance and development&quot; &lt;crash-utility@xxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" defer async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>

----- Original Message -----
&gt;<i> I found Dave had alread done the first phase of future support for x86_64</i>
&gt;<i> 5-level page tables(commit 307e7f35f510). when I asked him about the</i>
&gt;<i> state of this work, he gave me a more detailed answer and suggestion.</i>
&gt;<i> I follow his advice, and do the following job.</i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i> 1. Refine the original logical:</i>
&gt;<i>   1) Create some new common function for getting the offset of page table</i>
&gt;<i>   2) Repace the PML4 and UPML with the common PGD:</i>
&gt;<i>      machdep-&gt;machspec-&gt;pml4/upml ==&gt; machdep-&gt;pdg</i>
&gt;<i>   3) Using the PUD in x86_64</i>
&gt;<i> </i>
&gt;<i> 2. Add 5-level page tables support for x86_64_k/uvtop()</i>
&gt;<i> </i>
&gt;<i> This patchset is the second phase of the work, As Dave said, we need to be</i>
&gt;<i> a manner of determining very early on whether the kernel page tables are</i>
&gt;<i> using 5-level and  whether each user-space task is using 4- or 5-level page</i>
&gt;<i> tables. These will be done after this phase.</i>
&gt;<i> </i>
&gt;<i> About test work:</i>
&gt;<i> </i>
&gt;<i> I have tested this patchset with 4-level and 5-level paging table.</i>
&gt;<i> </i>
&gt;<i> sadump/ Xen/ Old Linux / RHEL4 are not be tested.</i>

Hello Dou,

Thank you very much for the work you have done so far.  I have not spent
any time looking at the patches in detail, but instead I first ran a quick
test of the patch on a set of ~250 kernels that I keep around for testing, 
where I just ran the &quot;mod&quot; command to at least verify that kernel virtual
addresses could be translated.  

Now, as always, backwards compatibility must be maintained.  I do not have
any sadump dumpfiles, but obviously you (Fujitsu) can test those.  However
I do have some older Xen and RHEL4-era kernels in my sample set.  

As it turns out, *all* RHEL4 kernels failed (i.e. any kernel version 
earlier than 2.6.9), which report &quot;WARNING: cannot access vmalloc'd 
module memory&quot; during initialization when trying to gather the kernel
module list.

For all of the 2.6.9 and earlier kernels, they show the &quot;WARNING: cannot
access vmalloc'd module memory&quot; message during session initialization:

  $ crash vmlinux-2.6.9-42.0.2.ELsmp.gz vmcore
  
  crash 7.2.1rc26
  Copyright (C) 2002-2017  Red Hat, Inc.
  Copyright (C) 2004, 2005, 2006, 2010  IBM Corporation
  Copyright (C) 1999-2006  Hewlett-Packard Co
  Copyright (C) 2005, 2006, 2011, 2012  Fujitsu Limited
  Copyright (C) 2006, 2007  VA Linux Systems Japan K.K.
  Copyright (C) 2005, 2011  NEC Corporation
  Copyright (C) 1999, 2002, 2007  Silicon Graphics, Inc.
  Copyright (C) 1999, 2000, 2001, 2002  Mission Critical Linux, Inc.
  This program is free software, covered by the GNU General Public License,
  and you are welcome to change it and/or distribute copies of it under
  certain conditions.  Enter &quot;help copying&quot; to see the conditions.
  This program has absolutely no warranty.  Enter &quot;help warranty&quot; for details.
   
  GNU gdb (GDB) 7.6
  Copyright (C) 2013 Free Software Foundation, Inc.
  License GPLv3+: GNU GPL version 3 or later &lt;<a  rel="nofollow" href="http://gnu.org/licenses/gpl.html">http://gnu.org/licenses/gpl.html</a>&gt;
  This is free software: you are free to change and redistribute it.
  There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;
  and &quot;show warranty&quot; for details.
  This GDB was configured as &quot;x86_64-unknown-linux-gnu&quot;...
  
  please wait... (gathering module symbol data)   
  WARNING: cannot access vmalloc'd module memory
  
        KERNEL: vmlinux-2.6.9-42.0.2.ELsmp.gz
      DUMPFILE: vmcore
          CPUS: 8
          DATE: Tue Nov 21 19:14:17 2006
        UPTIME: 6 days, 01:23:25
  LOAD AVERAGE: 24.34, 7.89, 4.46
         TASKS: 865
      NODENAME: lonrs00268
       RELEASE: 2.6.9-42.0.2.ELsmp
       VERSION: #1 SMP Thu Aug 17 17:57:31 EDT 2006
       MACHINE: x86_64  (2199 Mhz)
        MEMORY: 16 GB
         PANIC: &quot;Kernel BUG at panic:75&quot;
           PID: 20046
       COMMAND: &quot;oracle&quot;
          TASK: 101c6b047f0  [THREAD_INFO: 101a428a000]
           CPU: 7
         STATE: TASK_RUNNING (NMI)
  
  crash&gt; 
  
If I run the session with &quot;crash -d4 vmlinux-2.6.9-42.0.2.ELsmp.gz vmcore&quot;,
you can see that it it reads a &quot;pud page&quot;, but then fails:
  
  ...
  please wait... (gathering module symbol data)module: ffffffffa0634180
  &lt;readmem: ffffffffa0634180, KVADDR, &quot;module struct&quot;, 1408, (ROE|Q), f73780&gt;
  &lt;readmem: 4f8000, PHYSADDR, &quot;pud page&quot;, 4096, (FOE), 2080b40&gt;
  &lt;read_diskdump: addr: 4f8000 paddr: 4f8000 cnt: 4096&gt;
  
  crash: invalid kernel virtual address: ffffffffa0634180  type: &quot;module struct&quot;
  
  WARNING: cannot access vmalloc'd module memory
  ...

Without the patch, the module virtual address translation succeeds:

  ...
  please wait... (gathering module symbol data)module: ffffffffa0634180
  &lt;readmem: ffffffffa0634180, KVADDR, &quot;module struct&quot;, 1408, (ROE|Q), f705e0&gt;
  &lt;readmem: 103000, PHYSADDR, &quot;pgd page&quot;, 4096, (FOE), 25d7b50&gt;
  &lt;read_diskdump: addr: 103000 paddr: 103000 cnt: 4096&gt;
  &lt;readmem: 105000, PHYSADDR, &quot;pmd page&quot;, 4096, (FOE), 25d8b60&gt;
  &lt;read_diskdump: addr: 105000 paddr: 105000 cnt: 4096&gt;
  &lt;readmem: d9bfb0000, PHYSADDR, &quot;page table&quot;, 4096, (FOE), 25d9b70&gt;
  &lt;read_diskdump: addr: d9bfb0000 paddr: d9bfb0000 cnt: 4096&gt;
  &lt;read_diskdump: addr: ffffffffa0634180 paddr: d9bfb3180 cnt: 1408&gt;
  ...

So it appears to be reading from the wrong starting page table location,
i.e., from &quot;pud page 4f8000&quot; instead of &quot;pgd page 103000&quot;.

Also, several Xen kernels failed with segmentation violations during
session initialization.  They all fail here in x86_64_xendump_load_page(),
when &quot;*pgd&quot; gets referenced:

  static char *
  x86_64_xendump_load_page(ulong kvaddr, struct xendump_data *xd)
  {
          ulong mfn;
          ulong *pgd, *pud, *pmd, *ptep;
  
          pgd = ((ulong *)machdep-&gt;pgd) + pgd_index(kvaddr);
          mfn = ((*pgd) &amp; PHYSICAL_PAGE_MASK) &gt;&gt; PAGESHIFT();  
                  ^^^^
  
Here is the relevant part of the gdb trace of a 2.6.18-based xen
kernel:

Program terminated with signal 11, Segmentation fault.
#0  0x0000000000502748 in x86_64_xendump_load_page (kvaddr=kvaddr@entry=18446744071568498888, xd=0xf521a0 &lt;xendump_data&gt;, 
    xd=0xf521a0 &lt;xendump_data&gt;) at x86_64.c:7003
7003		mfn = ((*pgd) &amp; PHYSICAL_PAGE_MASK) &gt;&gt; PAGESHIFT();
Missing separate debuginfos, use: debuginfo-install glibc-2.17-157.el7.x86_64 libgcc-4.8.5-11.el7.x86_64 libstdc++-4.8.5-11.el7.x86_64 lzo-2.06-8.el7.x86_64 ncurses-libs-5.9-13.20130511.el7.x86_64 snappy-1.1.0-3.el7.x86_64 xz-libs-5.2.2-1.el7.x86_64 zlib-1.2.7-17.el7.x86_64
(gdb) bt
#0  0x0000000000502748 in x86_64_xendump_load_page (kvaddr=kvaddr@entry=18446744071568498888, xd=0xf521a0 &lt;xendump_data&gt;, 
    xd=0xf521a0 &lt;xendump_data&gt;) at x86_64.c:7003
#1  0x0000000000503191 in x86_64_xendump_p2m_create (xd=0xf521a0 &lt;xendump_data&gt;) at x86_64.c:6749
#2  0x0000000000565d4e in xc_core_create_pfn_tables () at xendump.c:1258
#3  xc_core_read (addr=&lt;optimized out&gt;, paddr=7080864, cnt=32, bufptr=0xf70f80 &lt;shared_bufs&gt;) at xendump.c:168
#4  read_xendump (fd=&lt;optimized out&gt;, bufptr=0xf70f80 &lt;shared_bufs&gt;, cnt=32, addr=&lt;optimized out&gt;, paddr=7080864) at xendump.c:836
#5  0x000000000047b038 in readmem (addr=18446744071569148832, memtype=memtype@entry=1, buffer=buffer@entry=0xf70f80 &lt;shared_bufs&gt;, 
    size=size@entry=32, type=type@entry=0x94dcc3 &quot;possible&quot;, error_handle=error_handle@entry=2) at memory.c:2233
#6  0x00000000004ea33e in cpu_maps_init () at kernel.c:903
#7  kernel_init () at kernel.c:118
#8  0x0000000000467e5a in main_loop () at main.c:768
#9  0x000000000069dad3 in captured_command_loop (data=data@entry=0x0) at main.c:258
#10 0x000000000069c37a in catch_errors (func=func@entry=0x69dac0 &lt;captured_command_loop&gt;, func_args=func_args@entry=0x0, 
    errstring=errstring@entry=0x8e713f &quot;&quot;, mask=mask@entry=6) at exceptions.c:557
#11 0x000000000069ea66 in captured_main (data=data@entry=0x7ffd637c92a0) at main.c:1064
#12 0x000000000069c37a in catch_errors (func=func@entry=0x69dda0 &lt;captured_main&gt;, func_args=func_args@entry=0x7ffd637c92a0, 
    errstring=errstring@entry=0x8e713f &quot;&quot;, mask=mask@entry=6) at exceptions.c:557
#13 0x000000000069edc7 in gdb_main (args=0x7ffd637c92a0) at main.c:1079
#14 gdb_main_entry (argc=&lt;optimized out&gt;, argv=argv@entry=0x7ffd637c9408) at main.c:1099
#15 0x00000000004f0604 in gdb_main_loop (argc=&lt;optimized out&gt;, argc@entry=3, argv=argv@entry=0x7ffd637c9408) at gdb_interface.c:76
#16 0x00000000004662c5 in main (argc=3, argv=0x7ffd637c9408) at main.c:707
(gdb) p pgd
$1 = (ulong *) 0xfffffffc054f4210
(gdb) 

I haven't investigated further, but in all of the xen cases, the
value of &quot;pgd&quot; above was a kernel virtual address as shown in the 
example above.

However, without the patch, the function looks like this, and with 
my debug printf of &quot;pml4&quot;, the address is a user-space address as
expected:

  static char *
  x86_64_xendump_load_page(ulong kvaddr, struct xendump_data *xd)
  {
          ulong mfn;
          ulong *pml4, *pgd, *pmd, *ptep;
  
          pml4 = ((ulong *)machdep-&gt;machspec-&gt;pml4) + pml4_index(kvaddr);
          mfn = ((*pml4) &amp; PHYSICAL_PAGE_MASK) &gt;&gt; PAGESHIFT();

  fprintf(fp, &quot;x86_64_xendump_load_page: pml4: %lx\n&quot;, pml4);
  
  ...

So for example, with the debug statement, I see this:
  
  # crash vmlinux-2.6.18-1.2714.el5xen.gz xguest-crashdump
  
  crash 7.2.1rc26
  Copyright (C) 2002-2017  Red Hat, Inc.
  Copyright (C) 2004, 2005, 2006, 2010  IBM Corporation
  Copyright (C) 1999-2006  Hewlett-Packard Co
  Copyright (C) 2005, 2006, 2011, 2012  Fujitsu Limited
  Copyright (C) 2006, 2007  VA Linux Systems Japan K.K.
  Copyright (C) 2005, 2011  NEC Corporation
  Copyright (C) 1999, 2002, 2007  Silicon Graphics, Inc.
  Copyright (C) 1999, 2000, 2001, 2002  Mission Critical Linux, Inc.
  This program is free software, covered by the GNU General Public License,
  and you are welcome to change it and/or distribute copies of it under
  certain conditions.  Enter &quot;help copying&quot; to see the conditions.
  This program has absolutely no warranty.  Enter &quot;help warranty&quot; for details.
   
  GNU gdb (GDB) 7.6                                                                   
  Copyright (C) 2013 Free Software Foundation, Inc.
  License GPLv3+: GNU GPL version 3 or later &lt;<a  rel="nofollow" href="http://gnu.org/licenses/gpl.html">http://gnu.org/licenses/gpl.html</a>&gt;
  This is free software: you are free to change and redistribute it.
  There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;
  and &quot;show warranty&quot; for details.
  This GDB was configured as &quot;x86_64-unknown-linux-gnu&quot;...
  
  x86_64_xendump_load_page: pml4: 25d6c08
  x86_64_xendump_load_page: pml4: 25d6c08
        KERNEL: vmlinux-2.6.18-1.2714.el5xen.gz
      DUMPFILE: xguest-crashdump
  ...


In a private email, I will send you a pointer to where I have temporarily 
stored the 2 vmlinux/vmcore pairs shown above.  I'm thinking that it will
probably be fairly easy for you to figure out what's happening in both cases.

Again, I very much appreciate the work you have undertaken here.

Thanks,
  Dave


--
Crash-utility mailing list
Crash-utility@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/crash-utility">https://www.redhat.com/mailman/listinfo/crash-utility</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="07254" href="msg07254.html">Re:  [PATCH 0/5] Second phase of future support for x86_64 5-level page tables</a></strong>
<ul><li><em>From:</em> Dou Liyang</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="07250" href="msg07250.html">[PATCH 0/5] Second phase of future support for	x86_64 5-level page tables</a></strong>
<ul><li><em>From:</em> Dou Liyang</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg07251.html">[PATCH 2/5] x86_64: Extract public page table	mapping code</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg07253.html">Re:  [PATCH 1/5] defs.h: Fix the PHYSICAL_PAGE_MASK	macro</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg07251.html">[PATCH 2/5] x86_64: Extract public page table	mapping code</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg07254.html">Re:  [PATCH 0/5] Second phase of future support for x86_64 5-level page tables</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#07252"><strong>Date</strong></a></li>
<li><a href="index.html#07252"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-devel/>[Fedora&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width="100%">
<tr>
<td align=left>&nbsp;</td>
<td valign=top align=right><H1><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></H1></td>
</tr></table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

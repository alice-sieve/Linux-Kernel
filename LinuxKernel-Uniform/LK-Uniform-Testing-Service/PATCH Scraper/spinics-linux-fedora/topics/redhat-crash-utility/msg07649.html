<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH] Add &#45;T option to configure task table via a	file -->
<!--X-From-R13: "Vngnlnzn, Rnvfhxr" &#60;q.ungnlnznNwc.shwvgfh.pbz> -->
<!--X-Date: Tue, 22 Jan 2019 00:58:09 &#45;0800 -->
<!--X-Message-Id: 33710E6CAA200E4583255F4FB666C4E21BBDC14F@G01JPEXMBYT03 -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 33710E6CAA200E4583255F4FB666C4E21BBBD093@G01JPEXMBYT03 -->
<!--X-Reference: 2083408547.70456555.1547652787664.JavaMail.zimbra@redhat.com -->
<!--X-Reference: 33710E6CAA200E4583255F4FB666C4E21BBC5246@G01JPEXMBYT03 -->
<!--X-Reference: 751016197.70770443.1547734624309.JavaMail.zimbra@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re:  [PATCH] Add -T option to configure task table via a	file &mdash; Red Hat Crash Utility">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Red Hat Crash Utility &mdash;  Re:  [PATCH] Add -T option to configure task table via a	file</title>
<link rel="alternate" type="application/rss+xml" title="Red Hat Crash Utility" href="//feeds.feedburner.com/RedHatCrashUtility">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [PATCH] Add -T option to configure task table via a	file</h1>
[<a href="msg07648.html">Date Prev</a>][<a href="msg07650.html">Date Next</a>][<a href="msg07644.html">Thread Prev</a>][<a href="msg07640.html">Thread Next</a>][<a href="maillist.html#07649">Date Index</a>][<a href="index.html#07649">Thread Index</a>]
<script src="https://apis.google.com/js/platform.js" async defer></script>
<g:plusone size="small"></g:plusone>
<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH] Add -T option to configure task table via a	file</li>
<li><em>From</em>: &quot;Hatayama, Daisuke&quot; &lt;d.hatayama@xxxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 22 Jan 2019 08:57:45 +0000</li>
<li><em>Accept-language</em>: ja-JP, en-US</li>
<li><em>In-reply-to</em>: &lt;<a href="msg07644.html">751016197.70770443.1547734624309.JavaMail.zimbra@redhat.com</a>&gt;</li>
<li><em>Reply-to</em>: &quot;Discussion list for crash utility usage,	maintenance and development&quot; &lt;crash-utility@xxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" defer async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>
&gt;<i> -----Original Message-----</i>
&gt;<i> From: crash-utility-bounces@xxxxxxxxxx</i>
&gt;<i> [<a  rel="nofollow" href="mailto:crash-utility-bounces@xxxxxxxxxx">mailto:crash-utility-bounces@xxxxxxxxxx</a>] On Behalf Of Dave Anderson</i>
&gt;<i> Sent: Thursday, January 17, 2019 11:17 PM</i>
&gt;<i> To: Discussion list for crash utility usage, maintenance and development</i>
&gt;<i> &lt;crash-utility@xxxxxxxxxx&gt;</i>
&gt;<i> Subject: Re:  [PATCH] Add -T option to configure task table via</i>
&gt;<i> a file</i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i> ----- Original Message -----</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; &gt; -----Original Message-----</i>
&gt;<i> &gt; &gt; ----- Original Message -----</i>
&gt;<i> &gt; &gt; &gt; I faced an incomplete vmcore previous week which was generated because</i>
&gt;<i> &gt; &gt; &gt; system running in kdump kernel was somehow rebooted in the middle of</i>
&gt;<i> &gt; &gt; &gt; copying vmcore.</i>
&gt;<i> &gt; &gt; &gt;</i>
&gt;<i> &gt; &gt; &gt; Unfortunately, in the incomplete vmcore, most of the tasks failed to</i>
&gt;<i> &gt; &gt; &gt; be detected via PID hash table because the objects relevant to PID</i>
&gt;<i> &gt; &gt; &gt; hash including ptes needed to refer to the objects were lost.</i>
&gt;<i> &gt; &gt; &gt;</i>
&gt;<i> &gt; &gt; &gt; Although I successfully found many of objects of task_struct from</i>
&gt;<i> &gt; &gt; &gt; another data structure such as via a circular list of task_struct::tasks</i>
&gt;<i> &gt; &gt; &gt; and via run queue, crash sub-commands never work with the following</i>
&gt;<i> &gt; &gt; &gt; message if a given object is not contained in the task table:</i>
&gt;<i> &gt; &gt; &gt;</i>
&gt;<i> &gt; &gt; &gt;     crash&gt; bt 0xffffffff00000000</i>
&gt;<i> &gt; &gt; &gt;     bt: invalid task or pid value: 0xffffffff00000000</i>
&gt;<i> &gt; &gt; &gt;</i>
&gt;<i> &gt; &gt; &gt; To address this issue, I made a patch to add a command-line option</i>
&gt;<i> &gt; &gt; &gt; to pass a list of addresses of task_struct objects to make crash</i>
&gt;<i> &gt; &gt; &gt; try to detect them in task table.</i>
&gt;<i> &gt; &gt; &gt;</i>
&gt;<i> &gt; &gt; &gt; I made this in very short time and there may be better interface</i>
&gt;<i> &gt; &gt; &gt; than command-line option.</i>
&gt;<i> &gt; &gt; &gt;</i>
&gt;<i> &gt; &gt; &gt; Tested on top of crash-7.2.5.</i>
&gt;<i> &gt; &gt;</i>
&gt;<i> &gt; &gt; Yeah, what bothers me about this patch is that even though it worked for</i>
&gt;<i> &gt; &gt; your</i>
&gt;<i> &gt; &gt; particular half-baked vmcore, it may never be of any help to anybody else</i>
&gt;<i> &gt; &gt; in the future.</i>
&gt;<i> &gt; &gt;</i>
&gt;<i> &gt; &gt; It's similar in nature to patches that have posted that address a</i>
&gt;<i> &gt; &gt; particular</i>
&gt;<i> &gt; &gt; unique kernel bug that was seen in one vmcore, but it would be highly</i>
&gt;<i> &gt; &gt; unlikely</i>
&gt;<i> &gt; &gt; that the circumstances would ever be seen again.</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; I'm posting this patch because I think this could be useful for everyone...</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; It was unfortunate that incomplete vmcore was generated and sent to us but</i>
&gt;<i> &gt; there's case where engineers have to investigate issues based on the</i>
&gt;<i> &gt; incomplete vmcore.</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; I also think there would other cases where restoring task_struct could fail</i>
&gt;<i> &gt; due to pure software issues, for example, memory corruption bugs, and think</i>
&gt;<i> &gt; it natural that crash doesn't behave as expected when kernel data structures</i>
&gt;<i> &gt; are abnormal state.</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; I think options such as --minimal and --no_kmem_cache are to deal with</i>
&gt;<i> &gt; such cases and this feature is similar in this sense.</i>
&gt;<i> </i>
&gt;<i> Yes, but --minimal is for extreme situations, and doesn't really apply in this</i>
&gt;<i> case</i>
&gt;<i> given the small subset of available commands.  --no_kmem_cache is more for</i>
&gt;<i> situations where for whatever reason the slab subsystem initialization fails</i>
&gt;<i> but it's not necessary to kill the whole session.</i>
&gt;<i> </i>
&gt;<i> There is &quot;crash --active&quot;, which gathers just the active tasks on each cpu</i>
&gt;<i> without using the normal task-gathering function.  Were you aware of that</i>
&gt;<i> option?</i>

I didn't know the option. But in this time I needed to gather inactive tasks
so the option would have been insufficient.

&gt;<i> </i>
&gt;<i> &gt;</i>
&gt;<i> &gt; By the way, I feel like I saw vmcores where some error messages</i>
&gt;<i> &gt; were output during &quot;(gathering task table data)&quot; in the past and</i>
&gt;<i> &gt; I guess some tasks were missing there but this was the first case I actually</i>
&gt;<i> &gt; needed to try to restore them.</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; &gt;</i>
&gt;<i> &gt; &gt; But in this case, it's even more unlikely given that it's dealing with</i>
&gt;<i> &gt; &gt; an incomplete vmcore.  You were lucky that you were able to even</i>
&gt;<i> &gt; &gt; bring up a crash session at all -- and then were able to generate</i>
&gt;<i> &gt; &gt; a task list after that.</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; It was incomplete but was complete about 98%. The detection from PID</i>
&gt;<i> &gt; hash was affected by loss of the remaining 2%.</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; &gt;</i>
&gt;<i> &gt; &gt; Following the task_struct.tasks list doesn't gather all of the</i>
&gt;<i> &gt; &gt; tasks in a task group, so it doesn't create a fully populated task</i>
&gt;<i> &gt; &gt; list, correct?</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; Yes, I needed to repeat iterating successfully detected task_struct</i>
&gt;<i> &gt; objects in order until all the target tasks were covered, and as your</i>
&gt;<i> &gt; guess, there's no guarantee that I found all the task_struct objects,</i>
&gt;<i> &gt; so I said 'many of'.</i>
&gt;<i> </i>
&gt;<i> Ok, I suppose it's useful but not necessary to gather all tasks.  As I mentioned</i>
&gt;<i> before, --active will gather the tasks running at the time of the crash, which</i>
&gt;<i> are typically the most important.</i>
&gt;<i> </i>
&gt;<i> But I understand your point, where there may be other non-active tasks whose</i>
&gt;<i> backtrace or whatever may be useful.</i>

Yes, actually, I found in this time an inactive task that entered sleep
due to some kernel bug, and the inactive task was initially not gathered.

&gt;<i> </i>
&gt;<i> &gt;</i>
&gt;<i> &gt; &gt;</i>
&gt;<i> &gt; &gt; Plus it doesn't make sense to add it unless it's documented *how* to</i>
&gt;<i> &gt; &gt; create the task list to begin with.</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; How about writing use case in help message or/and manual page?</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;   -T file</i>
&gt;<i> &gt;       Make crash detect task_struct objects listed in file as in</i>
&gt;<i> &gt;       task table. This is useful when your interesting tasks are</i>
&gt;<i> &gt;       missing in task table. You may find your interesting</i>
&gt;<i> &gt;       task_struct objects from various kernel data structures:</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;       From task_struct::tasks:</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;         crash&gt; list task_struct.tasks -s task_struct.pid,comm -h</i>
&gt;<i> &gt;         ffff88003daa8000</i>
&gt;<i> &gt;         ffff88003daa8000</i>
&gt;<i> &gt;           pid = 1</i>
&gt;<i> &gt;           comm = &quot;systemd\000\060\000\000\000\000\000\000&quot;</i>
&gt;<i> &gt;         ffff88003daa8fd0</i>
&gt;<i> &gt;           pid = 2</i>
&gt;<i> &gt;           comm = &quot;kthreadd\000\000\000\000\000\000\000&quot;</i>
&gt;<i> &gt;         ffff88003daa9fa0</i>
&gt;<i> &gt;           pid = 3</i>
&gt;<i> &gt;           comm = &quot;ksoftirqd/0\000\000\000\000&quot;</i>
&gt;<i> &gt;         ...&lt;snip&gt;...</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;       From runqueue:</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;         crash&gt; runq</i>
&gt;<i> &gt;         CPU 0 RUNQUEUE: ffff88003fc16cc0</i>
&gt;<i> &gt;           CURRENT: PID: 2188   TASK: ffff8800360f8000  COMMAND:</i>
&gt;<i> &quot;foobar.sh&quot;</i>
&gt;<i> &gt;           RT PRIO_ARRAY: ffff88003fc16e50</i>
&gt;<i> &gt;              [no tasks queued]</i>
&gt;<i> &gt;           CFS RB_ROOT: ffff88003fc16d68</i>
&gt;<i> &gt;              [no tasks queued]</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;         CPU 1 RUNQUEUE: ffff88003fd16cc0</i>
&gt;<i> &gt;           CURRENT: PID: 1      TASK: ffff88003daa8000  COMMAND: &quot;systemd&quot;</i>
&gt;<i> &gt;           RT PRIO_ARRAY: ffff88003fd16e50</i>
&gt;<i> &gt;              [no tasks queued]</i>
&gt;<i> &gt;           CFS RB_ROOT: ffff88003fd16d68</i>
&gt;<i> &gt;              [120] PID: 19054  TASK: ffff88000b684f10  COMMAND:</i>
&gt;<i> &quot;kworker/1:0&quot;</i>
&gt;<i> &gt;              [120] PID: 3863   TASK: ffff88003bd02f70  COMMAND: &quot;emacs&quot;</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; This might be lengthy under option section.</i>
&gt;<i> </i>
&gt;<i> Right, it could be more verbose under the help page section, but less so in</i>
&gt;<i> the</i>
&gt;<i> man page and in &quot;crash --help&quot;.</i>
&gt;<i> </i>

I see.

&gt;<i> &gt;</i>
&gt;<i> &gt; &gt;</i>
&gt;<i> &gt; &gt; I don't know, let me think about this...</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; I don't think the current design is best.</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; For example, it might be better to be able to update task table at runtime</i>
&gt;<i> &gt; by some crash sub-command. Looking at source code, it appears that</i>
&gt;<i> &gt; task table is updated at command execution when needed, so it's not</i>
&gt;<i> &gt; so difficult?</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; void</i>
&gt;<i> &gt; exec_command(void)</i>
&gt;<i> &gt; {</i>
&gt;<i> &gt; ...&lt;snip&gt;...</i>
&gt;<i> &gt;         if ((ct = get_command_table_entry(args[0]))) {</i>
&gt;<i> &gt;                 if (ct-&gt;flags &amp; REFRESH_TASK_TABLE) {</i>
&gt;<i> &gt;                         if (XEN_HYPER_MODE()) {</i>
&gt;<i> &gt; #ifdef XEN_HYPERVISOR_ARCH</i>
&gt;<i> &gt;</i>
&gt;<i> xen_hyper_refresh_domain_context_space();</i>
&gt;<i> &gt;                                 xen_hyper_refresh_vcpu_context_space();</i>
&gt;<i> &gt; #else</i>
&gt;<i> &gt;                                 error(FATAL,</i>
&gt;<i> XEN_HYPERVISOR_NOT_SUPPORTED);</i>
&gt;<i> &gt; #endif</i>
&gt;<i> &gt;                         } else if (!(pc-&gt;flags &amp; MINIMAL_MODE)) {</i>
&gt;<i> &gt;                                 tt-&gt;refresh_task_table()</i>
&gt;<i> &gt;                                 sort_context_array();</i>
&gt;<i> &gt;                                 sort_tgid_array();</i>
&gt;<i> &gt;                         }</i>
&gt;<i> &gt;                 }</i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i> Right, although each of the several task table gathering plugin functions</i>
&gt;<i> only run one time if it's a dumpfile.  But that could be adjusted for a</i>
&gt;<i> run-time command option that wants to add one or more tasks to the table.</i>
&gt;<i> </i>
&gt;<i> Perhaps refresh_active_task_table() could be modified to allow the addition</i>
&gt;<i> of extra tasks, either by command line option, or allowing the function to be</i>
&gt;<i> re-run during runtime as directed by a &quot;task -a task-address&quot; or &quot;task -A file&quot;</i>
&gt;<i> option.</i>

Thanks for the idea.
I'll try to make a patch based on the idea.

By the way, I guess that would be next week or later in the current schedule.

Thanks.
HATAYAMA, Dais

--
Crash-utility mailing list
Crash-utility@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/crash-utility">https://www.redhat.com/mailman/listinfo/crash-utility</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="07639" href="msg07639.html">[PATCH] Add -T option to configure task table via a	file</a></strong>
<ul><li><em>From:</em> Hatayama, Daisuke</li></ul></li>
<li><strong><a name="07641" href="msg07641.html">Re:  [PATCH] Add -T option to configure task table via a	file</a></strong>
<ul><li><em>From:</em> Dave Anderson</li></ul></li>
<li><strong><a name="07643" href="msg07643.html">Re:  [PATCH] Add -T option to configure task table via a	file</a></strong>
<ul><li><em>From:</em> Hatayama, Daisuke</li></ul></li>
<li><strong><a name="07644" href="msg07644.html">Re:  [PATCH] Add -T option to configure task table via a	file</a></strong>
<ul><li><em>From:</em> Dave Anderson</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg07648.html">Re:  Not compatible with d52888aa2753 (&quot;x86/mm: Move LDT remap out of KASLR region on 5-level paging&quot;)</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg07650.html">crash: read error: kernel virtual address: ...</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg07644.html">Re:  [PATCH] Add -T option to configure task table via a	file</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg07640.html">Not compatible with d52888aa2753 (&quot;x86/mm: Move LDT remap out of KASLR region on 5-level paging&quot;)</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#07649"><strong>Date</strong></a></li>
<li><a href="index.html#07649"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-devel/>[Fedora&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width="100%">
<tr>
<td align=left>&nbsp;</td>
<td valign=top align=right><H1><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></H1></td>
</tr></table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

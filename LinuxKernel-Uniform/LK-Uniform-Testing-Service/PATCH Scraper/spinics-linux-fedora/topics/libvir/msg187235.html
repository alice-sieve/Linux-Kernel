<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH] virsh emulatorpin,	vcpupin: omit offline CPUs from affinity map -->
<!--X-From-R13: Epbgg Qurybun &#60;purybunNyvahk.iarg.voz.pbz> -->
<!--X-Date: Thu, 11 Jul 2019 11:29:24 &#45;0700 -->
<!--X-Message-Id: 20190711164630.12730&#45;1&#45;cheloha@linux.vnet.ibm.com -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; [PATCH] virsh emulatorpin,	vcpupin: omit offline CPUs from affinity map</title>
<meta name="description" content="libvirt: [PATCH] virsh emulatorpin,	vcpupin: omit offline CPUs from affinity map">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>[PATCH] virsh emulatorpin,	vcpupin: omit offline CPUs from affinity map</h1>
[<a href="msg187234.html">Date Prev</a>][<a href="msg187236.html">Date Next</a>][<a href="msg187198.html">Thread Prev</a>][<a href="msg187236.html">Thread Next</a>][<a href="maillist.html#187235">Date Index</a>][<a href="index.html#187235">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH] virsh emulatorpin,	vcpupin: omit offline CPUs from affinity map</li>
<li><em>From</em>: Scott Cheloha &lt;cheloha@xxxxxxxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 11 Jul 2019 11:46:30 -0500</li>
<li><em>Cc</em>: Scott Cheloha &lt;cheloha@xxxxxxxxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Each host CPU is not necessarily online.  Including CPUs that are
known to be offline in the default affinity map doesn't make much
sense.  We can try to omit those CPUs if the host supports CPU
bitmaps, i.e.  virHostCPUHasBitmap() is true.  Otherwise we can
return a full map as we do now.

For example, given the following lscpu(1):

Architecture:          ppc64le
Byte Order:            Little Endian
CPU(s):                128
On-line CPU(s) list:   0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120
Off-line CPU(s) list:  1-7,9-15,17-23,25-31,33-39,41-47,49-55,57-63,65-71,73-79,81-87,89-95,97-103,105-111,113-119,121-127
Thread(s) per core:    1
Core(s) per socket:    4
Socket(s):             4
NUMA node(s):          4
Model:                 2.1 (pvr 004b 0201)
Model name:            POWER8E (raw), altivec supported
CPU max MHz:           4322.0000
CPU min MHz:           2061.0000
L1d cache:             64K
L1i cache:             32K
L2 cache:              512K
L3 cache:              8192K
NUMA node0 CPU(s):     0,8,16,24
NUMA node1 CPU(s):     32,40,48,56
NUMA node16 CPU(s):    64,72,80,88
NUMA node17 CPU(s):    96,104,112,120

the current behavior for a guest with no VCPU configuration is:

$ virsh vcpupin myvm
----------------------------------
   0: 0-127

but this patch instead you get:

VCPU   CPU Affinity
----------------------------------
 0      0,8,16,24,32,40,48,56,64,72,80,88,96,104,112,120

which is more consistent with the lscpu(1) output.

Fixes: ibm bz174632 (rhbz#1434276)

Signed-off-by: Scott Cheloha &lt;cheloha@xxxxxxxxxxxxxxxxxx&gt;
---
I'm unsure whether it's better to automatically fall back
to the full map if virHostCPUGetOnlineBitmap() fails, or to
fail loudly as I do in this patch.

Preferences?

 src/conf/domain_conf.c | 8 ++++++++
 src/qemu/qemu_driver.c | 4 ++++
 2 files changed, 12 insertions(+)

diff --git a/src/conf/domain_conf.c b/src/conf/domain_conf.c
index 3323c9a5b1..0ea6f69574 100644
--- a/src/conf/domain_conf.c
+++ b/src/conf/domain_conf.c
@@ -1989,6 +1989,7 @@ virDomainDefGetVcpuPinInfoHelper(virDomainDefPtr def,
     int maxvcpus = virDomainDefGetVcpusMax(def);
     size_t i;
     VIR_AUTOPTR(virBitmap) allcpumap = NULL;
+    VIR_AUTOPTR(virBitmap) onlinemap = NULL;
 
     if (hostcpus &lt; 0)
         return -1;
@@ -1998,6 +1999,11 @@ virDomainDefGetVcpuPinInfoHelper(virDomainDefPtr def,
 
     virBitmapSetAll(allcpumap);
 
+    if (virHostCPUHasBitmap()) {
+        if (!(onlinemap = virHostCPUGetOnlineBitmap()))
+            return -1;
+    }
+
     for (i = 0; i &lt; maxvcpus &amp;&amp; i &lt; ncpumaps; i++) {
         virDomainVcpuDefPtr vcpu = virDomainDefGetVcpu(def, i);
         virBitmapPtr bitmap = NULL;
@@ -2009,6 +2015,8 @@ virDomainDefGetVcpuPinInfoHelper(virDomainDefPtr def,
             bitmap = autoCpuset;
         else if (def-&gt;cpumask)
             bitmap = def-&gt;cpumask;
+        else if (onlinemap)
+            bitmap = onlinemap;
         else
             bitmap = allcpumap;
 
diff --git a/src/qemu/qemu_driver.c b/src/qemu/qemu_driver.c
index 5a75f23981..2c59513929 100644
--- a/src/qemu/qemu_driver.c
+++ b/src/qemu/qemu_driver.c
@@ -5377,6 +5377,10 @@ qemuDomainGetEmulatorPinInfo(virDomainPtr dom,
     } else if (vm-&gt;def-&gt;placement_mode == VIR_DOMAIN_CPU_PLACEMENT_MODE_AUTO &amp;&amp;
                autoCpuset) {
         cpumask = autoCpuset;
+    } else if (virHostCPUHasBitmap()) {
+        if (!(bitmap = virHostCPUGetOnlineBitmap()))
+            goto cleanup;
+        cpumask = bitmap;
     } else {
         if (!(bitmap = virBitmapNew(hostcpus)))
             goto cleanup;
-- 
2.20.1

--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187234.html">Re:  [PATCH v2 16/21] utils: Extend virCommandProcessIO to including the send buffers</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187236.html">[PATCH v4 00/23] Add support for vTPM state encryption</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187198.html">[PATCH 00/29] Split the libvirtd daemon into per-driver	daemons</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187236.html">[PATCH v4 00/23] Add support for vTPM state encryption</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187235"><strong>Date</strong></a></li>
<li><a href="index.html#187235"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH v1 23/31] qemu_domain: Introduce NVMe path getting	helpers -->
<!--X-From-R13: [vpuny Bevibmavx &#60;zcevibmaNerqung.pbz> -->
<!--X-Date: Thu, 11 Jul 2019 08:55:06 &#45;0700 -->
<!--X-Message-Id: 7e389b790d3d56ba988ebb785a692f23cc9ce538.1562859733.git.mprivozn@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: cover.1562859733.git.mprivozn@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; [PATCH v1 23/31] qemu_domain: Introduce NVMe path getting	helpers</title>
<meta name="description" content="libvirt: [PATCH v1 23/31] qemu_domain: Introduce NVMe path getting	helpers">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>[PATCH v1 23/31] qemu_domain: Introduce NVMe path getting	helpers</h1>
[<a href="msg187182.html">Date Prev</a>][<a href="msg187184.html">Date Next</a>][<a href="msg187481.html">Thread Prev</a>][<a href="msg187487.html">Thread Next</a>][<a href="maillist.html#187183">Date Index</a>][<a href="index.html#187183">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH v1 23/31] qemu_domain: Introduce NVMe path getting	helpers</li>
<li><em>From</em>: Michal Privoznik &lt;mprivozn@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 11 Jul 2019 17:54:10 +0200</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187163.html">cover.1562859733.git.mprivozn@redhat.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187163.html">cover.1562859733.git.mprivozn@redhat.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Couple of places in the QEMU driver will want to know what paths
are associated with NVMe disks (for instance CGroup code or
namespaces code). Introduce helpers which return desired paths
(for instance /dev/vfio/vfio and /dev/vfio/N).

Signed-off-by: Michal Privoznik &lt;mprivozn@xxxxxxxxxx&gt;
---
 src/qemu/qemu_domain.c | 44 ++++++++++++++++++++++++++++++++++++++++++
 src/qemu/qemu_domain.h |  6 ++++++
 2 files changed, 50 insertions(+)

diff --git a/src/qemu/qemu_domain.c b/src/qemu/qemu_domain.c
index 2a7f09ce24..949bbace88 100644
--- a/src/qemu/qemu_domain.c
+++ b/src/qemu/qemu_domain.c
@@ -11723,6 +11723,50 @@ qemuDomainSupportsVideoVga(virDomainVideoDefPtr video,
 }
 
 
+char *
+qemuDomainGetNVMeDiskPath(const virStorageSourceNVMeDef *nvme)
+{
+    VIR_AUTOPTR(virPCIDevice) pci = NULL;
+
+    /* All NVMe devices are VFIO PCI devices */
+    if (!(pci = virPCIDeviceNew(nvme-&gt;pciAddr.domain,
+                                nvme-&gt;pciAddr.bus,
+                                nvme-&gt;pciAddr.slot,
+                                nvme-&gt;pciAddr.function)))
+        return NULL;
+
+    return virPCIDeviceGetIOMMUGroupDev(pci);
+}
+
+
+char **
+qemuDomainGetDiskNVMePaths(const virDomainDef *def,
+                           const virStorageSource *src,
+                           bool teardown)
+{
+    VIR_AUTOFREE(char *) iommuGroup = NULL;
+    VIR_AUTOSTRINGLIST paths = NULL;
+    bool includeVFIO = !teardown;
+
+    if (!(iommuGroup = qemuDomainGetNVMeDiskPath(src-&gt;nvme)))
+        return NULL;
+
+    if (virStringListAdd(&amp;paths, iommuGroup) &lt; 0)
+        return NULL;
+
+    if (teardown &amp;&amp; def &amp;&amp;
+        !virDomainDefHasNVMeDisk(def) &amp;&amp;
+        !virDomainDefHasVFIOHostdev(def))
+        includeVFIO = true;
+
+    if (includeVFIO &amp;&amp;
+        virStringListAdd(&amp;paths, QEMU_DEV_VFIO) &lt; 0)
+        return NULL;
+
+    VIR_RETURN_PTR(paths);
+}
+
+
 /**
  * qemuDomainGetHostdevPath:
  * @def: domain definition
diff --git a/src/qemu/qemu_domain.h b/src/qemu/qemu_domain.h
index 3eea8b0f96..82e225088d 100644
--- a/src/qemu/qemu_domain.h
+++ b/src/qemu/qemu_domain.h
@@ -1011,6 +1011,12 @@ int qemuDomainCheckMonitor(virQEMUDriverPtr driver,
 bool qemuDomainSupportsVideoVga(virDomainVideoDefPtr video,
                                 virQEMUCapsPtr qemuCaps);
 
+char * qemuDomainGetNVMeDiskPath(const virStorageSourceNVMeDef *nvme);
+
+char ** qemuDomainGetDiskNVMePaths(const virDomainDef *def,
+                                   const virStorageSource *src,
+                                   bool teardown);
+
 int qemuDomainGetHostdevPath(virDomainDefPtr def,
                              virDomainHostdevDefPtr dev,
                              bool teardown,
-- 
2.21.0

--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187182.html">[PATCH v1 17/31] virhostdevtest: Test virNVMeDevice	assignment</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187184.html">[PATCH v1 26/31] security_selinux: Simplify	virSecuritySELinuxSetImageLabelInternal</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187481.html">Re:  [PATCH v1 17/31] virhostdevtest: Test virNVMeDevice assignment</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187487.html">Re:  [PATCH v1 23/31] qemu_domain: Introduce NVMe path getting helpers</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187183"><strong>Date</strong></a></li>
<li><a href="index.html#187183"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

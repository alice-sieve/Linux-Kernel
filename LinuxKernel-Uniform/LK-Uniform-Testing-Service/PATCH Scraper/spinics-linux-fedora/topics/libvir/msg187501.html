<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH Rust 1/4] connect: cleanup around	Connect::open_auth()'s method -->
<!--X-From-R13: Enuvq Aeragvab Treqwnbhv &#60;fnuvq.sreqwnbhvNpnabavpny.pbz> -->
<!--X-Date: Wed, 17 Jul 2019 02:00:37 &#45;0700 -->
<!--X-Message-Id: 20190717085933.3121&#45;1&#45;sahid.ferdjaoui@canonical.com -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; [PATCH Rust 1/4] connect: cleanup around	Connect::open_auth()'s method</title>
<meta name="description" content="libvirt: [PATCH Rust 1/4] connect: cleanup around	Connect::open_auth()'s method">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>[PATCH Rust 1/4] connect: cleanup around	Connect::open_auth()'s method</h1>
[<a href="msg187500.html">Date Prev</a>][<a href="msg187502.html">Date Next</a>][<a href="msg187500.html">Thread Prev</a>][<a href="msg187502.html">Thread Next</a>][<a href="maillist.html#187501">Date Index</a>][<a href="index.html#187501">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH Rust 1/4] connect: cleanup around	Connect::open_auth()'s method</li>
<li><em>From</em>: Sahid Orentino Ferdjaoui &lt;sahid.ferdjaoui@xxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Wed, 17 Jul 2019 08:59:30 +0000</li>
<li><em>Cc</em>: Sahid Orentino Ferdjaoui &lt;sahid.ferdjaoui@xxxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>In this refactor we avoid to enclose all the code with unsafe tags and
just use it when necessary. Also we add annotations to explain why
it's safe to use.

The integrations tests related are also been reviewed to avoid using
panic.

Signed-off-by: Sahid Orentino Ferdjaoui &lt;sahid.ferdjaoui@xxxxxxxxxxxxx&gt;
---
 src/connect.rs            | 91 ++++++++++++++++++++++-----------------
 tests/integration_qemu.rs | 16 +++----
 2 files changed, 56 insertions(+), 51 deletions(-)

diff --git a/src/connect.rs b/src/connect.rs
index 0fa8551..108224d 100644
--- a/src/connect.rs
+++ b/src/connect.rs
@@ -240,6 +240,41 @@ extern &quot;C&quot; {
                                         -&gt; *mut libc::c_char;
 }
 
+extern &quot;C&quot; fn connectCallback(ccreds: sys::virConnectCredentialPtr,
+                              ncred: libc::c_uint,
+                              cbdata: *mut libc::c_void)
+                              -&gt; libc::c_int {
+    let callback: ConnectAuthCallback = unsafe {
+        // Safe because connectCallback is private and only used by
+        // Connect::open_auth(). In open_auth() we transmute the
+        // callback allocate in *void.
+        mem::transmute(cbdata)
+    };
+    let mut rcreds: Vec&lt;ConnectCredential&gt; = Vec::new();
+    for i in 0..ncred as isize {
+        unsafe {
+            // Safe because ccreds is allocated.
+            let c = ConnectCredential::from_ptr(ccreds.offset(i));
+            rcreds.push(c);
+        }
+    }
+    callback(&amp;mut rcreds);
+    for i in 0..ncred as isize {
+        if rcreds[i as usize].result.is_some() {
+            if let Some(ref result) = rcreds[i as usize].result {
+                unsafe {
+                    // Safe because ccreds is allocated and the result
+                    // is comming from Rust calls.
+                    (*ccreds.offset(i)).resultlen = result.len() as libc::c_uint;
+                    (*ccreds.offset(i)).result = string_to_mut_c_chars!(result.clone());
+                }
+            }
+        }
+    }
+    0
+}
+
+
 pub type ConnectFlags = self::libc::c_uint;
 pub const VIR_CONNECT_RO: ConnectFlags = 1 &lt;&lt; 0;
 pub const VIR_CONNECT_NO_ALIASES: ConnectFlags = 1 &lt;&lt; 1;
@@ -412,39 +447,6 @@ impl ConnectAuth {
             callback: callback,
         }
     }
-
-    fn to_cstruct(&amp;mut self) -&gt; sys::virConnectAuth {
-        unsafe extern &quot;C&quot; fn wrapper(ccreds: sys::virConnectCredentialPtr,
-                                     ncred: libc::c_uint,
-                                     cbdata: *mut libc::c_void)
-                                     -&gt; libc::c_int {
-            let callback: ConnectAuthCallback = mem::transmute(cbdata);
-            let mut rcreds: Vec&lt;ConnectCredential&gt; = Vec::new();
-            for i in 0..ncred as isize {
-                let c = ConnectCredential::from_ptr(ccreds.offset(i));
-                rcreds.push(c);
-            }
-            callback(&amp;mut rcreds);
-            for i in 0..ncred as isize {
-                if rcreds[i as usize].result.is_some() {
-                    if let Some(ref result) = rcreds[i as usize].result {
-                        (*ccreds.offset(i)).resultlen = result.len() as libc::c_uint;
-                        (*ccreds.offset(i)).result = string_to_mut_c_chars!(result.clone());
-                    }
-                }
-            }
-            0
-        }
-
-        unsafe {
-            sys::virConnectAuth {
-                credtype: &amp;mut self.creds[0],
-                ncredtype: self.creds.len() as u32,
-                cb: wrapper,
-                cbdata: mem::transmute(self.callback),
-            }
-        }
-    }
 }
 
 /// Provides APIs for the management of hosts.
@@ -554,14 +556,23 @@ impl Connect {
                      auth: &amp;mut ConnectAuth,
                      flags: ConnectFlags)
                      -&gt; Result&lt;Connect, Error&gt; {
-        unsafe {
-            let mut cauth = auth.to_cstruct();
-            let c = virConnectOpenAuth(string_to_c_chars!(uri), &amp;mut cauth, flags as libc::c_uint);
-            if c.is_null() {
-                return Err(Error::new());
-            }
-            return Ok(Connect::new(c));
+        let mut cauth = unsafe {
+            // Safe because Rust forces to allocate all attributes of
+            // the struct ConnectAuth.
+            sys::virConnectAuth {
+                credtype: &amp;mut auth.creds[0],
+                ncredtype: auth.creds.len() as libc::c_uint,
+                cb: connectCallback,
+                cbdata: mem::transmute(auth.callback),
+            }
+        };
+        let c = unsafe {
+            virConnectOpenAuth(string_to_c_chars!(uri), &amp;mut cauth, flags as libc::c_uint)
+        };
+        if c.is_null() {
+            return Err(Error::new());
         }
+        return Ok(Connect::new(c));
     }
 
 
diff --git a/tests/integration_qemu.rs b/tests/integration_qemu.rs
index 49e07c4..79aa2bd 100644
--- a/tests/integration_qemu.rs
+++ b/tests/integration_qemu.rs
@@ -108,14 +108,9 @@ fn test_connection_with_auth() {
     let mut auth = ConnectAuth::new(vec![::virt::connect::VIR_CRED_AUTHNAME,
                                          ::virt::connect::VIR_CRED_PASSPHRASE],
                                     callback);
-    match Connect::open_auth(&quot;test+tcp://127.0.0.1/default&quot;, &amp;mut auth, 0) {
-        Ok(c) =&gt; common::close(c),
-        Err(e) =&gt; {
-            panic!(&quot;open_auth did not work: code {}, message: {}&quot;,
-                   e.code,
-                   e.message)
-        }
-    }
+    let c = Connect::open_auth(&quot;test+tcp://127.0.0.1/default&quot;, &amp;mut auth, 0);
+    assert_eq!(true, c.is_ok());
+    common::close(c.unwrap());
 }
 
 
@@ -141,9 +136,8 @@ fn test_connection_with_auth_wrong() {
     let mut auth = ConnectAuth::new(vec![::virt::connect::VIR_CRED_AUTHNAME,
                                          ::virt::connect::VIR_CRED_PASSPHRASE],
                                     callback);
-    if Connect::open_auth(&quot;test+tcp://127.0.0.1/default&quot;, &amp;mut auth, 0).is_ok() {
-        panic!(&quot;open_auth did not work: code {}, message:&quot;);
-    }
+    let c = Connect::open_auth(&quot;test+tcp://127.0.0.1/default&quot;, &amp;mut auth, 0);
+    assert_eq!(false, c.is_ok());
 }
 
 #[test]
-- 
2.17.1

--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187500.html">[PATCH] test_driver: implement virDomainMemoryStats</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187502.html">[PATCH Rust 4/4] fix email address in Cargo.toml + update	README</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187500.html">[PATCH] test_driver: implement virDomainMemoryStats</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187502.html">[PATCH Rust 4/4] fix email address in Cargo.toml + update	README</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187501"><strong>Date</strong></a></li>
<li><a href="index.html#187501"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

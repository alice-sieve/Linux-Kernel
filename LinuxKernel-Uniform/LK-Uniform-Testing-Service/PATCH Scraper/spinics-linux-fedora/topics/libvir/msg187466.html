<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH v1 05/31] virpcimock: Create driver_override file in device dirs -->
<!--X-From-R13: Brgre Yerzcn &#60;cxerzcnNerqung.pbz> -->
<!--X-Date: Tue, 16 Jul 2019 05:14:07 &#45;0700 -->
<!--X-Message-Id: 20190716121354.GM2061@angien.pipo.sk -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: cover.1562859733.git.mprivozn@redhat.com -->
<!--X-Reference: 883546a6872fb3afc83ea184d901bdb274b1000f.1562859733.git.mprivozn@redhat.com -->
<!--X-Derived: pgpxZ12BvF1Y5.pgp -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; Re:  [PATCH v1 05/31] virpcimock: Create driver_override file in device dirs</title>
<meta name="description" content="libvirt: Re:  [PATCH v1 05/31] virpcimock: Create driver_override file in device dirs">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>Re:  [PATCH v1 05/31] virpcimock: Create driver_override file in device dirs</h1>
[<a href="msg187465.html">Date Prev</a>][<a href="msg187467.html">Date Next</a>][<a href="msg187169.html">Thread Prev</a>][<a href="msg187489.html">Thread Next</a>][<a href="maillist.html#187466">Date Index</a>][<a href="index.html#187466">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH v1 05/31] virpcimock: Create driver_override file in device dirs</li>
<li><em>From</em>: Peter Krempa &lt;pkrempa@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 16 Jul 2019 14:13:54 +0200</li>
<li><em>Cc</em>: libvir-list@xxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187169.html">883546a6872fb3afc83ea184d901bdb274b1000f.1562859733.git.mprivozn@redhat.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187163.html">cover.1562859733.git.mprivozn@redhat.com</a>&gt;	&lt;<a href="msg187169.html">883546a6872fb3afc83ea184d901bdb274b1000f.1562859733.git.mprivozn@redhat.com</a>&gt;</li>
<li><em>User-agent</em>: Mutt/1.12.0 (2019-05-25)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Thu, Jul 11, 2019 at 17:53:52 +0200, Michal Privoznik wrote:
&gt; Newer kernels (v3.16-rc1~29^2~6^4) have 'driver_override' file
&gt; which simplifies way of binding a PCI device to desired driver.
&gt; Libvirt has support for this for some time too (v2.3.0-rc1~236),
&gt; but not our virpcimock. So far we did not care because our code
&gt; is designed to deal with this situation. Except for one.
&gt; hypothetical case: binding a device to the vfio-pci driver can be
&gt; successful only via driver_override. Any attempt to bind a PCI
&gt; device to vfio-pci driver using old method (new_id + unbind +
&gt; bind) will fail because of b803b29c1a5. While on vanilla kernel

You've reverted the mentioned commit just before this patch.

Also I did not understand what this is supposed to do from the commit
message. Perhaps due to my limited understanding of the pci detachment
code. So either somebody else reviews this or you'll need to reprhase
the commit message.

&gt; I'm able to use the old method successfully, it's failing on RHEL
&gt; kernels (not sure why).

This does not inspire confidence.

&gt; 
&gt; Signed-off-by: Michal Privoznik &lt;mprivozn@xxxxxxxxxx&gt;
&gt; ---
&gt;  tests/virpcimock.c | 57 +++++++++++++++++++++++++++++++++++++++++-----
&gt;  1 file changed, 51 insertions(+), 6 deletions(-)
&gt; 
&gt; diff --git a/tests/virpcimock.c b/tests/virpcimock.c
&gt; index 6865f992dc..18d06d11d4 100644
&gt; --- a/tests/virpcimock.c
&gt; +++ b/tests/virpcimock.c
&gt; @@ -87,6 +87,11 @@ char *fakesysfspcidir;
&gt;   *   Probe for a driver that handles the specified device.
&gt;   *   Data in format &quot;DDDD:BB:DD.F&quot; (Domain:Bus:Device.Function).
&gt;   *
&gt; + * /sys/bus/pci/devices/&lt;device&gt;/driver_override
&gt; + *   Name of a driver that overrides preferred driver can be written
&gt; + *   here. The device will be attached to it on drivers_probe event.
&gt; + *   Writing an empty string (or &quot;\n&quot;) clears the override.
&gt; + *
&gt;   * As a little hack, we are not mocking write to these files, but close()
&gt;   * instead. The advantage is we don't need any self growing array to hold the
&gt;   * partial writes and construct them back. We can let all the writes finish,
&gt; @@ -147,6 +152,7 @@ static struct pciDevice *pci_device_find_by_content(const char *path);
&gt;  static void pci_driver_new(const char *name, int fail, ...);
&gt;  static struct pciDriver *pci_driver_find_by_dev(struct pciDevice *dev);
&gt;  static struct pciDriver *pci_driver_find_by_path(const char *path);
&gt; +static struct pciDriver *pci_driver_find_by_driver_override(struct pciDevice *dev);
&gt;  static int pci_driver_bind(struct pciDriver *driver, struct pciDevice *dev);
&gt;  static int pci_driver_unbind(struct pciDriver *driver, struct pciDevice *dev);
&gt;  static int pci_driver_handle_change(int fd, const char *path);
&gt; @@ -202,7 +208,8 @@ make_symlink(const char *path,
&gt;  static int
&gt;  pci_read_file(const char *path,
&gt;                char *buf,
&gt; -              size_t buf_size)
&gt; +              size_t buf_size,
&gt; +              bool truncate)
&gt;  {
&gt;      int ret = -1;
&gt;      int fd = -1;
&gt; @@ -224,7 +231,8 @@ pci_read_file(const char *path,
&gt;          goto cleanup;
&gt;      }
&gt;  
&gt; -    if (ftruncate(fd, 0) &lt; 0)
&gt; +    if (truncate &amp;&amp;
&gt; +        ftruncate(fd, 0) &lt; 0)
&gt;          goto cleanup;
&gt;  
&gt;      ret = 0;
&gt; @@ -398,6 +406,8 @@ pci_device_new_from_stub(const struct pciDevice *data)
&gt;          ABORT(&quot;@tmp overflow&quot;);
&gt;      make_file(devpath, &quot;class&quot;, tmp, -1);
&gt;  
&gt; +    make_file(devpath, &quot;driver_override&quot;, NULL, -1);
&gt; +
&gt;      if (snprintf(tmp, sizeof(tmp),
&gt;                   &quot;%s/../../../kernel/iommu_groups/%d&quot;,
&gt;                   devpath, dev-&gt;iommuGroup) &lt; 0) {
&gt; @@ -441,7 +451,7 @@ pci_device_find_by_content(const char *path)
&gt;  {
&gt;      char tmp[32];
&gt;  
&gt; -    if (pci_read_file(path, tmp, sizeof(tmp)) &lt; 0)
&gt; +    if (pci_read_file(path, tmp, sizeof(tmp), true) &lt; 0)
&gt;          return NULL;
&gt;  
&gt;      return pci_device_find_by_id(tmp);
&gt; @@ -450,7 +460,10 @@ pci_device_find_by_content(const char *path)
&gt;  static int
&gt;  pci_device_autobind(struct pciDevice *dev)
&gt;  {
&gt; -    struct pciDriver *driver = pci_driver_find_by_dev(dev);
&gt; +    struct pciDriver *driver = pci_driver_find_by_driver_override(dev);
&gt; +
&gt; +    if (!driver)
&gt; +        driver = pci_driver_find_by_dev(dev);
&gt;  
&gt;      if (!driver) {
&gt;          /* No driver found. Nothing to do */
&gt; @@ -544,6 +557,36 @@ pci_driver_find_by_path(const char *path)
&gt;      return NULL;
&gt;  }
&gt;  
&gt; +static struct pciDriver *
&gt; +pci_driver_find_by_driver_override(struct pciDevice *dev)
&gt; +{
&gt; +    struct pciDriver *ret = NULL;
&gt; +    char *path = NULL;
&gt; +    char tmp[32];
&gt; +    size_t i;
&gt; +
&gt; +    if (virAsprintfQuiet(&amp;path,
&gt; +                         SYSFS_PCI_PREFIX &quot;devices/%s/driver_override&quot;,
&gt; +                         dev-&gt;id) &lt; 0)
&gt; +        return NULL;
&gt; +
&gt; +    if (pci_read_file(path, tmp, sizeof(tmp), false) &lt; 0)
&gt; +        goto cleanup;
&gt; +
&gt; +    for (i = 0; i &lt; nPCIDrivers; i++) {
&gt; +        struct pciDriver *driver = pciDrivers[i];
&gt; +
&gt; +        if (STREQ(tmp, driver-&gt;name)) {
&gt; +            ret = driver;
&gt; +            break;
&gt; +        }
&gt; +    }
&gt; +
&gt; + cleanup:
&gt; +    VIR_FREE(path);

VIR_AUTOFREE should be available.

&gt; +    return ret;
&gt; +}
&gt; +
&gt;  static int
&gt;  pci_driver_bind(struct pciDriver *driver,
&gt;                  struct pciDevice *dev)
&gt; @@ -657,6 +700,8 @@ pci_driver_handle_change(int fd ATTRIBUTE_UNUSED, const char *path)
&gt;          ret = pci_driver_handle_remove_id(path);
&gt;      else if (STREQ(file, &quot;drivers_probe&quot;))
&gt;          ret = pci_driver_handle_drivers_probe(path);
&gt; +    else if (STREQ(file, &quot;driver_override&quot;))
&gt; +        ret = 0; /* nada */
&gt;      else
&gt;          ABORT(&quot;Not handled write to: %s&quot;, path);
&gt;      return ret;
&gt; @@ -711,7 +756,7 @@ pci_driver_handle_new_id(const char *path)
&gt;          goto cleanup;
&gt;      }
&gt;  
&gt; -    if (pci_read_file(path, buf, sizeof(buf)) &lt; 0)
&gt; +    if (pci_read_file(path, buf, sizeof(buf), true) &lt; 0)
&gt;          goto cleanup;
&gt;  
&gt;      if (sscanf(buf, &quot;%x %x&quot;, &amp;vendor, &amp;device) &lt; 2) {
&gt; @@ -766,7 +811,7 @@ pci_driver_handle_remove_id(const char *path)
&gt;          goto cleanup;
&gt;      }
&gt;  
&gt; -    if (pci_read_file(path, buf, sizeof(buf)) &lt; 0)
&gt; +    if (pci_read_file(path, buf, sizeof(buf), true) &lt; 0)
&gt;          goto cleanup;
&gt;  
&gt;      if (sscanf(buf, &quot;%x %x&quot;, &amp;vendor, &amp;device) &lt; 2) {
&gt; -- 
&gt; 2.21.0
&gt; 
&gt; --
&gt; libvir-list mailing list
&gt; libvir-list@xxxxxxxxxx
&gt; <a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>
</pre><p><strong>Attachment:
<a href="attachments/pgpxZ12BvF1Y5.pgp" ><tt>signature.asc</tt></a></strong><br>
<em>Description:</em> PGP signature</p>
<pre>--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a></pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187465.html">Re:  [PATCH v1 03/31] virpcimock: Move actions checking one level up</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187467.html">Re:  [PATCH v1 06/31] virPCIDeviceAddressEqual: Fix const correctness</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187169.html">[PATCH v1 05/31] virpcimock: Create driver_override file	in device dirs</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187489.html">Re:  [PATCH v1 05/31] virpcimock: Create driver_override file in device dirs</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187466"><strong>Date</strong></a></li>
<li><a href="index.html#187466"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

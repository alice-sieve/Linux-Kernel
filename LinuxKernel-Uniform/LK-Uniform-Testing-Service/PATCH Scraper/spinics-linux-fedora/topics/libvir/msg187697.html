<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH v1 3/3] virhostdev: remove	virHostdevReattachPCIDevice -->
<!--X-From-R13: Rnavry Vraevdhr Pneobmn &#60;qnavryuo413Ntznvy.pbz> -->
<!--X-Date: Thu, 18 Jul 2019 13:10:26 &#45;0700 -->
<!--X-Message-Id: 20190718201007.28571&#45;4&#45;danielhb413@gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190718201007.28571&#45;1&#45;danielhb413@gmail.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; [PATCH v1 3/3] virhostdev: remove	virHostdevReattachPCIDevice</title>
<meta name="description" content="libvirt: [PATCH v1 3/3] virhostdev: remove	virHostdevReattachPCIDevice">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>[PATCH v1 3/3] virhostdev: remove	virHostdevReattachPCIDevice</h1>
[<a href="msg187696.html">Date Prev</a>][<a href="msg187698.html">Date Next</a>][<a href="msg187743.html">Thread Prev</a>][<a href="msg187735.html">Thread Next</a>][<a href="maillist.html#187697">Date Index</a>][<a href="index.html#187697">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH v1 3/3] virhostdev: remove	virHostdevReattachPCIDevice</li>
<li><em>From</em>: Daniel Henrique Barboza &lt;danielhb413@xxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 18 Jul 2019 17:10:07 -0300</li>
<li><em>Cc</em>: Daniel Henrique Barboza &lt;danielhb413@xxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187696.html">20190718201007.28571-1-danielhb413@gmail.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187696.html">20190718201007.28571-1-danielhb413@gmail.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>We have 3 pieces of code that do slightly the same thing, but
it varies depending on where it is called:

- virPCIDeviceReattach(). This is where the actual re-attach
work happens;

- virHostdevReattachPCIDevice(). This is a static function from
virhostdev.c that calls virPCIDeviceReattach() after waiting
for device cleanup for the KVM PCI stub driver;

- virHostdevPCINodeDeviceReAttach(). This function also
calls virPCIDeviceReattach(), but setting some device properties
beforehand.

All these extra operations that are done before virPCIDeviceReattach()
can be moved inside the function itself,  allowing for the
same re-attach behavior everywhere.

This patch consolidates all these pre-conditions inside the
body of virPCIDeviceReattach(). With that, virHostdevReattachPCIDevice()
can be removed and the callers can use virPCIDeviceReattach()
directly instead.

Signed-off-by: Daniel Henrique Barboza &lt;danielhb413@xxxxxxxxx&gt;
---
 src/util/virhostdev.c | 43 +++++++++----------------------------------
 src/util/virpci.c     | 29 ++++++++++++++++++++++++++---
 2 files changed, 35 insertions(+), 37 deletions(-)

diff --git a/src/util/virhostdev.c b/src/util/virhostdev.c
index 53aacb59b4..23be037a39 100644
--- a/src/util/virhostdev.c
+++ b/src/util/virhostdev.c
@@ -613,33 +613,6 @@ virHostdevRestoreNetConfig(virDomainHostdevDefPtr hostdev,
     }
 }
 
-/*
- * Pre-condition: inactivePCIHostdevs &amp; activePCIHostdevs
- * are locked
- */
-static void
-virHostdevReattachPCIDevice(virHostdevManagerPtr mgr,
-                            virPCIDevicePtr actual)
-{
-    /* Wait for device cleanup if it is qemu/kvm */
-    if (virPCIDeviceGetStubDriver(actual) == VIR_PCI_STUB_DRIVER_KVM) {
-        int retries = 100;
-        while (virPCIDeviceWaitForCleanup(actual, &quot;kvm_assigned_device&quot;)
-               &amp;&amp; retries) {
-            usleep(100*1000);
-            retries--;
-        }
-    }
-
-    VIR_DEBUG(&quot;Reattaching PCI device %s&quot;, virPCIDeviceGetName(actual));
-    if (virPCIDeviceReattach(actual, mgr-&gt;activePCIHostdevs,
-                             mgr-&gt;inactivePCIHostdevs) &lt; 0) {
-        VIR_ERROR(_(&quot;Failed to re-attach PCI device: %s&quot;),
-                  virGetLastErrorMessage());
-        virResetLastError();
-    }
-}
-
 static void
 virHostdevReattachAllPCIDevices(virPCIDeviceListPtr pcidevs,
                                 virHostdevManagerPtr mgr)
@@ -655,11 +628,17 @@ virHostdevReattachAllPCIDevices(virPCIDeviceListPtr pcidevs,
         if (!(actual = virPCIDeviceListFind(mgr-&gt;inactivePCIHostdevs, pci)))
             continue;
 
-        if (virPCIDeviceGetManaged(actual))
-            virHostdevReattachPCIDevice(mgr, actual);
-        else
+        if (virPCIDeviceGetManaged(actual)) {
+            if (virPCIDeviceReattach(actual, mgr-&gt;activePCIHostdevs,
+                                     mgr-&gt;inactivePCIHostdevs) &lt; 0) {
+                VIR_ERROR(_(&quot;Failed to re-attach PCI device: %s&quot;),
+                          virGetLastErrorMessage());
+                virResetLastError();
+            }
+        } else {
             VIR_DEBUG(&quot;Not reattaching unmanaged PCI device %s&quot;,
                       virPCIDeviceGetName(actual));
+        }
     }
 }
 
@@ -2050,10 +2029,6 @@ virHostdevPCINodeDeviceReAttach(virHostdevManagerPtr mgr,
     if (virHostdevIsPCINodeDeviceUsed(virPCIDeviceGetAddress(pci), &amp;data))
         goto cleanup;
 
-    virPCIDeviceSetUnbindFromStub(pci, true);
-    virPCIDeviceSetRemoveSlot(pci, true);
-    virPCIDeviceSetReprobe(pci, true);
-
     if (virPCIDeviceReattach(pci, mgr-&gt;activePCIHostdevs,
                              mgr-&gt;inactivePCIHostdevs) &lt; 0)
         goto cleanup;
diff --git a/src/util/virpci.c b/src/util/virpci.c
index 75e8daadd5..4594643d3c 100644
--- a/src/util/virpci.c
+++ b/src/util/virpci.c
@@ -1509,19 +1509,39 @@ virPCIDeviceDetach(virPCIDevicePtr dev,
     return 0;
 }
 
+/*
+ * Pre-condition: inactivePCIHostdevs &amp; activePCIHostdevs
+ * are locked
+ */
 int
 virPCIDeviceReattach(virPCIDevicePtr dev,
                      virPCIDeviceListPtr activeDevs,
                      virPCIDeviceListPtr inactiveDevs)
 {
+    int ret = -1;
+
     if (activeDevs &amp;&amp; virPCIDeviceListFind(activeDevs, dev)) {
         virReportError(VIR_ERR_INTERNAL_ERROR,
                        _(&quot;Not reattaching active device %s&quot;), dev-&gt;name);
-        return -1;
+        goto exit;
+    }
+
+    virPCIDeviceSetUnbindFromStub(dev, true);
+    virPCIDeviceSetRemoveSlot(dev, true);
+    virPCIDeviceSetReprobe(dev, true);
+
+    /* Wait for device cleanup if it is qemu/kvm */
+    if (virPCIDeviceGetStubDriver(dev) == VIR_PCI_STUB_DRIVER_KVM) {
+        int retries = 100;
+        while (virPCIDeviceWaitForCleanup(dev, &quot;kvm_assigned_device&quot;)
+               &amp;&amp; retries) {
+            usleep(100*1000);
+            retries--;
+        }
     }
 
     if (virPCIDeviceUnbindFromStub(dev) &lt; 0)
-        return -1;
+        goto exit;
 
     /* Steal the dev from list inactiveDevs */
     if (inactiveDevs) {
@@ -1529,7 +1549,10 @@ virPCIDeviceReattach(virPCIDevicePtr dev,
         virPCIDeviceListDel(inactiveDevs, dev);
     }
 
-    return 0;
+    ret = 0;
+
+ exit:
+    return ret;
 }
 
 /* Certain hypervisors (like qemu/kvm) map the PCI bar(s) on
-- 
2.21.0

--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187696.html">[PATCH v1 0/3] misc virhostdevs cleanups</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187698.html">[PATCH v1 1/3] virhostdev: introduce	virHostdevResetAllPCIDevices</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187743.html">Re:  [PATCH v1 2/3] virhostdev: introduce virHostdevReattachAllPCIDevices</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187735.html">Re:  [PATCH v1 3/3] virhostdev: remove virHostdevReattachPCIDevice</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187697"><strong>Date</strong></a></li>
<li><a href="index.html#187697"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

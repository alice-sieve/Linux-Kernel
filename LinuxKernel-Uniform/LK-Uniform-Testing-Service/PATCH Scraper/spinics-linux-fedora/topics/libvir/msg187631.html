<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH 2/2] virSecurityManagerMetadataLock: Skip over	duplicate paths -->
<!--X-From-R13: [vpuny Bevibmavx &#60;zcevibmaNerqung.pbz> -->
<!--X-Date: Thu, 18 Jul 2019 02:15:05 &#45;0700 -->
<!--X-Message-Id: b6e8d014badbbba6a0fbc52230825c6bfeea6b92.1563441249.git.mprivozn@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: cover.1563441249.git.mprivozn@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; [PATCH 2/2] virSecurityManagerMetadataLock: Skip over	duplicate paths</title>
<meta name="description" content="libvirt: [PATCH 2/2] virSecurityManagerMetadataLock: Skip over	duplicate paths">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>[PATCH 2/2] virSecurityManagerMetadataLock: Skip over	duplicate paths</h1>
[<a href="msg187630.html">Date Prev</a>][<a href="msg187632.html">Date Next</a>][<a href="msg187633.html">Thread Prev</a>][<a href="msg187635.html">Thread Next</a>][<a href="maillist.html#187631">Date Index</a>][<a href="index.html#187631">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH 2/2] virSecurityManagerMetadataLock: Skip over	duplicate paths</li>
<li><em>From</em>: Michal Privoznik &lt;mprivozn@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 18 Jul 2019 11:14:49 +0200</li>
<li><em>Cc</em>: danielhb413@xxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187633.html">cover.1563441249.git.mprivozn@redhat.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187633.html">cover.1563441249.git.mprivozn@redhat.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>If there are two paths on the list that are the same we need to
lock it only once. Because when we try to lock it the second time
then open() fails. And if it didn't, locking it the second time
would fail for sure. After all, it is sufficient to lock all
paths just once satisfy the caller.

Reported-by: Daniel Henrique Barboza &lt;danielhb413@xxxxxxxxx&gt;
Signed-off-by: Michal Privoznik &lt;mprivozn@xxxxxxxxxx&gt;
---
 src/security/security_manager.c | 23 +++++++++++++++++++++--
 1 file changed, 21 insertions(+), 2 deletions(-)

diff --git a/src/security/security_manager.c b/src/security/security_manager.c
index ade2c96141..7c905f0785 100644
--- a/src/security/security_manager.c
+++ b/src/security/security_manager.c
@@ -1294,16 +1294,35 @@ virSecurityManagerMetadataLock(virSecurityManagerPtr mgr ATTRIBUTE_UNUSED,
      * paths A B and there's another that is trying to lock them
      * in reversed order a deadlock might occur.  But if we sort
      * the paths alphabetically then both processes will try lock
-     * paths in the same order and thus no deadlock can occur. */
+     * paths in the same order and thus no deadlock can occur.
+     * Lastly, it makes searching for duplicate paths below
+     * simpler. */
     qsort(paths, npaths, sizeof(*paths), cmpstringp);
 
     for (i = 0; i &lt; npaths; i++) {
         const char *p = paths[i];
         struct stat sb;
+        size_t j;
         int retries = 10 * 1000;
         int fd;
 
-        if (!p || stat(p, &amp;sb) &lt; 0)
+        if (!p)
+            continue;
+
+        /* If there's a duplicate path on the list, skip it over.
+         * Not only we would fail open()-ing it the second time,
+         * we would deadlock with ourselves trying to lock it the
+         * second time. After all, we've locked it when iterating
+         * over it the first time. */
+        for (j = 0; j &lt; i; j++) {
+            if (STREQ_NULLABLE(p, paths[j]))
+                break;
+        }
+
+        if (i != j)
+            continue;
+
+        if (stat(p, &amp;sb) &lt; 0)
             continue;
 
         if (S_ISDIR(sb.st_mode)) {
-- 
2.21.0

--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187630.html">Re:  [PATCH 0/5] network: xmlns dnsmasq option passthrough</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187632.html">[PATCH 1/2] virSecurityManagerMetadataLock: Expand the	comment on deadlocks</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187633.html">[PATCH 0/2] virSecurityManagerMetadataLock: Skip over	duplicate paths</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187635.html">Re:  [PATCH 2/2] virSecurityManagerMetadataLock: Skip over duplicate paths</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187631"><strong>Date</strong></a></li>
<li><a href="index.html#187631"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

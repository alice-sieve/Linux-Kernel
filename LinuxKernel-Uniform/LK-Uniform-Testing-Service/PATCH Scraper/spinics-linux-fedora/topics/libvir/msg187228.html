<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH 28/29] all: don't wait for driver lock during	startup -->
<!--X-From-R13: =?GFT&#45;8?d?Rnavry=20B=2S=20Preenat=Q3=O9?= &#60;oreenatrNerqung.pbz> -->
<!--X-Date: Thu, 11 Jul 2019 09:06:17 &#45;0700 -->
<!--X-Message-Id: 20190711160516.2130&#45;29&#45;berrange@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190711160516.2130&#45;1&#45;berrange@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; [PATCH 28/29] all: don't wait for driver lock during	startup</title>
<meta name="description" content="libvirt: [PATCH 28/29] all: don't wait for driver lock during	startup">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>[PATCH 28/29] all: don't wait for driver lock during	startup</h1>
[<a href="msg187227.html">Date Prev</a>][<a href="msg187229.html">Date Next</a>][<a href="msg187285.html">Thread Prev</a>][<a href="msg187287.html">Thread Next</a>][<a href="maillist.html#187228">Date Index</a>][<a href="index.html#187228">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH 28/29] all: don't wait for driver lock during	startup</li>
<li><em>From</em>: Daniel P. Berrang&#xE9; &lt;berrange@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 11 Jul 2019 17:05:15 +0100</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187198.html">20190711160516.2130-1-berrange@redhat.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187198.html">20190711160516.2130-1-berrange@redhat.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>When the drivers acquire their pidfile lock we don't want to wait if the
lock is already held. We need the driver to immediately report error,
causing the daemon to exit.

Signed-off-by: Daniel P. Berrang&#xE9; &lt;berrange@xxxxxxxxxx&gt;
---
 src/bhyve/bhyve_driver.c                | 2 +-
 src/interface/interface_backend_netcf.c | 2 +-
 src/interface/interface_backend_udev.c  | 2 +-
 src/libxl/libxl_driver.c                | 2 +-
 src/lxc/lxc_driver.c                    | 2 +-
 src/network/leaseshelper.c              | 2 +-
 src/node_device/node_device_hal.c       | 2 +-
 src/node_device/node_device_udev.c      | 2 +-
 src/nwfilter/nwfilter_driver.c          | 2 +-
 src/qemu/qemu_driver.c                  | 2 +-
 src/secret/secret_driver.c              | 2 +-
 src/vz/vz_driver.c                      | 2 +-
 12 files changed, 12 insertions(+), 12 deletions(-)

diff --git a/src/bhyve/bhyve_driver.c b/src/bhyve/bhyve_driver.c
index cfcf4e1fba..5387ac5570 100644
--- a/src/bhyve/bhyve_driver.c
+++ b/src/bhyve/bhyve_driver.c
@@ -1280,7 +1280,7 @@ bhyveStateInitialize(bool privileged,
     }
 
     if ((bhyve_driver-&gt;lockFD =
-         virPidFileAcquire(BHYVE_STATE_DIR, &quot;driver&quot;, true, getpid())) &lt; 0)
+         virPidFileAcquire(BHYVE_STATE_DIR, &quot;driver&quot;, false, getpid())) &lt; 0)
         goto cleanup;
 
     if (virDomainObjListLoadAllConfigs(bhyve_driver-&gt;domains,
diff --git a/src/interface/interface_backend_netcf.c b/src/interface/interface_backend_netcf.c
index 868e49c56e..f575768c4c 100644
--- a/src/interface/interface_backend_netcf.c
+++ b/src/interface/interface_backend_netcf.c
@@ -120,7 +120,7 @@ netcfStateInitialize(bool privileged,
     }
 
     if ((driver-&gt;lockFD =
-         virPidFileAcquire(driver-&gt;stateDir, &quot;driver&quot;, true, getpid())) &lt; 0)
+         virPidFileAcquire(driver-&gt;stateDir, &quot;driver&quot;, false, getpid())) &lt; 0)
         goto error;
 
     /* open netcf */
diff --git a/src/interface/interface_backend_udev.c b/src/interface/interface_backend_udev.c
index fcd7f1c04a..2feaeb95b7 100644
--- a/src/interface/interface_backend_udev.c
+++ b/src/interface/interface_backend_udev.c
@@ -1199,7 +1199,7 @@ udevStateInitialize(bool privileged,
     }
 
     if ((driver-&gt;lockFD =
-         virPidFileAcquire(driver-&gt;stateDir, &quot;driver&quot;, true, getpid())) &lt; 0)
+         virPidFileAcquire(driver-&gt;stateDir, &quot;driver&quot;, false, getpid())) &lt; 0)
         goto cleanup;
 
     driver-&gt;udev = udev_new();
diff --git a/src/libxl/libxl_driver.c b/src/libxl/libxl_driver.c
index a99c7471bb..492028c487 100644
--- a/src/libxl/libxl_driver.c
+++ b/src/libxl/libxl_driver.c
@@ -747,7 +747,7 @@ libxlStateInitialize(bool privileged,
     }
 
     if ((libxl_driver-&gt;lockFD =
-         virPidFileAcquire(cfg-&gt;stateDir, &quot;driver&quot;, true, getpid())) &lt; 0)
+         virPidFileAcquire(cfg-&gt;stateDir, &quot;driver&quot;, false, getpid())) &lt; 0)
         goto error;
 
     if (!(libxl_driver-&gt;lockManager =
diff --git a/src/lxc/lxc_driver.c b/src/lxc/lxc_driver.c
index 3982c24f34..d0b6703101 100644
--- a/src/lxc/lxc_driver.c
+++ b/src/lxc/lxc_driver.c
@@ -1607,7 +1607,7 @@ static int lxcStateInitialize(bool privileged,
     }
 
     if ((lxc_driver-&gt;lockFD =
-         virPidFileAcquire(cfg-&gt;stateDir, &quot;driver&quot;, true, getpid())) &lt; 0)
+         virPidFileAcquire(cfg-&gt;stateDir, &quot;driver&quot;, false, getpid())) &lt; 0)
         goto cleanup;
 
     /* Get all the running persistent or transient configs first */
diff --git a/src/network/leaseshelper.c b/src/network/leaseshelper.c
index 89d9a003e2..2a10fbf33a 100644
--- a/src/network/leaseshelper.c
+++ b/src/network/leaseshelper.c
@@ -164,7 +164,7 @@ main(int argc, char **argv)
         goto cleanup;
 
     /* Try to claim the pidfile, exiting if we can't */
-    if ((pid_file_fd = virPidFileAcquirePath(pid_file, true, getpid())) &lt; 0)
+    if ((pid_file_fd = virPidFileAcquirePath(pid_file, false, getpid())) &lt; 0)
         goto cleanup;
 
     /* Since interfaces can be hot plugged, we need to make sure that the
diff --git a/src/node_device/node_device_hal.c b/src/node_device/node_device_hal.c
index 1920f4566e..1f3f867599 100644
--- a/src/node_device/node_device_hal.c
+++ b/src/node_device/node_device_hal.c
@@ -637,7 +637,7 @@ nodeStateInitialize(bool privileged ATTRIBUTE_UNUSED,
     }
 
     if ((driver-&gt;lockFD =
-         virPidFileAcquire(driver-&gt;stateDir, &quot;driver&quot;, true, getpid())) &lt; 0)
+         virPidFileAcquire(driver-&gt;stateDir, &quot;driver&quot;, false, getpid())) &lt; 0)
         goto failure;
 
     if (!(driver-&gt;devs = virNodeDeviceObjListNew()))
diff --git a/src/node_device/node_device_udev.c b/src/node_device/node_device_udev.c
index d883462948..8bc63c506c 100644
--- a/src/node_device/node_device_udev.c
+++ b/src/node_device/node_device_udev.c
@@ -1848,7 +1848,7 @@ nodeStateInitialize(bool privileged,
     }
 
     if ((driver-&gt;lockFD =
-         virPidFileAcquire(driver-&gt;stateDir, &quot;driver&quot;, true, getpid())) &lt; 0)
+         virPidFileAcquire(driver-&gt;stateDir, &quot;driver&quot;, false, getpid())) &lt; 0)
         goto cleanup;
 
     if (!(driver-&gt;devs = virNodeDeviceObjListNew()) ||
diff --git a/src/nwfilter/nwfilter_driver.c b/src/nwfilter/nwfilter_driver.c
index 43561241f6..530e4f5872 100644
--- a/src/nwfilter/nwfilter_driver.c
+++ b/src/nwfilter/nwfilter_driver.c
@@ -215,7 +215,7 @@ nwfilterStateInitialize(bool privileged,
     }
 
     if ((driver-&gt;lockFD =
-         virPidFileAcquire(driver-&gt;stateDir, &quot;driver&quot;, true, getpid())) &lt; 0)
+         virPidFileAcquire(driver-&gt;stateDir, &quot;driver&quot;, false, getpid())) &lt; 0)
         goto error;
 
     if (virNWFilterIPAddrMapInit() &lt; 0)
diff --git a/src/qemu/qemu_driver.c b/src/qemu/qemu_driver.c
index a52b54b9d8..9793ada367 100644
--- a/src/qemu/qemu_driver.c
+++ b/src/qemu/qemu_driver.c
@@ -677,7 +677,7 @@ qemuStateInitialize(bool privileged,
     }
 
     if ((qemu_driver-&gt;lockFD =
-         virPidFileAcquire(cfg-&gt;stateDir, &quot;driver&quot;, true, getpid())) &lt; 0)
+         virPidFileAcquire(cfg-&gt;stateDir, &quot;driver&quot;, false, getpid())) &lt; 0)
         goto error;
 
     qemu_driver-&gt;qemuImgBinary = virFindFileInPath(&quot;qemu-img&quot;);
diff --git a/src/secret/secret_driver.c b/src/secret/secret_driver.c
index 9344948db4..0af2bcef96 100644
--- a/src/secret/secret_driver.c
+++ b/src/secret/secret_driver.c
@@ -504,7 +504,7 @@ secretStateInitialize(bool privileged,
     }
 
     if ((driver-&gt;lockFD =
-         virPidFileAcquire(driver-&gt;stateDir, &quot;driver&quot;, true, getpid())) &lt; 0)
+         virPidFileAcquire(driver-&gt;stateDir, &quot;driver&quot;, false, getpid())) &lt; 0)
         goto error;
 
     if (!(driver-&gt;secrets = virSecretObjListNew()))
diff --git a/src/vz/vz_driver.c b/src/vz/vz_driver.c
index 75430fb0d9..f5d05a7f43 100644
--- a/src/vz/vz_driver.c
+++ b/src/vz/vz_driver.c
@@ -4129,7 +4129,7 @@ vzStateInitialize(bool privileged,
     }
 
     if ((vz_driver_lock_fd =
-         virPidFileAcquire(VZ_STATEDIR, &quot;driver&quot;, true, getpid())) &lt; 0)
+         virPidFileAcquire(VZ_STATEDIR, &quot;driver&quot;, false, getpid())) &lt; 0)
         return -1;
 
     if (prlsdkInit() &lt; 0) {
-- 
2.21.0

--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187227.html">[PATCH 27/29] remote: switch to connect to per-driver	daemons by default</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187229.html">Re:  [PATCH v1 11/31] conf: Format and parse NVMe type disk</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187285.html">Re:  [PATCH 27/29] remote: switch to connect to per-driver daemons by default</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187287.html">Re:  [PATCH 00/29] Split the libvirtd daemon into per-driver daemons</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187228"><strong>Date</strong></a></li>
<li><a href="index.html#187228"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

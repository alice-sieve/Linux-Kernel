<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH 18/25] qemu: blockjob: Add modern block job event handler -->
<!--X-From-R13: =?vfb&#45;8859&#45;1?P?EhTh?= Fbzxb &#60;wgbzxbNerqung.pbz> -->
<!--X-Date: Mon, 15 Jul 2019 08:35:21 &#45;0700 -->
<!--X-Message-Id: 20190715153551.GT8317@lpt -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: cover.1562947283.git.pkrempa@redhat.com -->
<!--X-Reference: cc5dd98ec002a4eff63cc5165372d9485365c52b.1562947284.git.pkrempa@redhat.com -->
<!--X-Derived: pgpSnYQoWEuLv.pgp -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; Re:  [PATCH 18/25] qemu: blockjob: Add modern block job event handler</title>
<meta name="description" content="libvirt: Re:  [PATCH 18/25] qemu: blockjob: Add modern block job event handler">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>Re:  [PATCH 18/25] qemu: blockjob: Add modern block job event handler</h1>
[<a href="msg187428.html">Date Prev</a>][<a href="msg187430.html">Date Next</a>][<a href="msg187332.html">Thread Prev</a>][<a href="msg187333.html">Thread Next</a>][<a href="maillist.html#187429">Date Index</a>][<a href="index.html#187429">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH 18/25] qemu: blockjob: Add modern block job event handler</li>
<li><em>From</em>: J&#xE1;n Tomko &lt;jtomko@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Mon, 15 Jul 2019 17:35:51 +0200</li>
<li><em>Cc</em>: libvir-list@xxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187332.html">cc5dd98ec002a4eff63cc5165372d9485365c52b.1562947284.git.pkrempa@redhat.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187317.html">cover.1562947283.git.pkrempa@redhat.com</a>&gt;	&lt;<a href="msg187332.html">cc5dd98ec002a4eff63cc5165372d9485365c52b.1562947284.git.pkrempa@redhat.com</a>&gt;</li>
<li><em>User-agent</em>: Mutt/1.11.3 (2019-02-01)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
On Fri, Jul 12, 2019 at 06:05:59PM +0200, Peter Krempa wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Add the infrastructure to handle block job events in the -blockdev era.

Some complexity is required as qemu does not bother to notify whether
the job was concluded successfully or failed. Thus it's necessary to
re-query the monitor.

To minimize the possibility of stuck jobs save the state into the XML
prior to handling everything so that the reconnect code can potentially
continue with the cleanup.

Signed-off-by: Peter Krempa &lt;pkrempa@xxxxxxxxxx&gt;
---
src/qemu/qemu_blockjob.c | 168 ++++++++++++++++++++++++++++++++++++++-
1 file changed, 167 insertions(+), 1 deletion(-)

diff --git a/src/qemu/qemu_blockjob.c b/src/qemu/qemu_blockjob.c
index dd6071dae1..8b142f1aba 100644
--- a/src/qemu/qemu_blockjob.c
+++ b/src/qemu/qemu_blockjob.c
+static void
+qemuBlockJobEventProcessConcluded(qemuBlockJobDataPtr job,
+                                  virQEMUDriverPtr driver,
+                                  virDomainObjPtr vm,
+                                  qemuDomainAsyncJob asyncJob)
+{
+    qemuMonitorJobInfoPtr *jobinfo = NULL;
+    size_t njobinfo = 0;
+    size_t i;
+    int rc = 0;
+    bool dismissed = false;
+    bool refreshed = false;
+
+    if (qemuDomainObjEnterMonitorAsync(driver, vm, asyncJob) &lt; 0)
+        goto cleanup;
+
+    /* we need to fetch the error state as the event does not propagate it */
+    if (job-&gt;newstate == QEMU_BLOCKJOB_STATE_CONCLUDED &amp;&amp;
+        (rc = qemuMonitorGetJobInfo(qemuDomainGetMonitor(vm), &amp;jobinfo, &amp;njobinfo)) == 0) {
+
+        for (i = 0; i &lt; njobinfo; i++) {
+            if (STRNEQ_NULLABLE(job-&gt;name, jobinfo[i]-&gt;id))
+                continue;
+
+            if (VIR_STRDUP(job-&gt;errmsg, jobinfo[i]-&gt;error) &lt; 0)
+                rc = -1;
+
+            if (job-&gt;errmsg)
+                job-&gt;newstate = QEMU_BLOCKJOB_STATE_FAILED;
+            else
+                job-&gt;newstate = QEMU_BLOCKJOB_STATE_COMPLETED;
+
+            refreshed = true;
+
+            break;
+        }
+
+        if (i == njobinfo) {
+            VIR_WARN(&quot;failed to refresh job '%s'&quot;, job-&gt;name);
+            rc = -1;
+        }
+    }
+
+    /* dismiss job in qemu */
+    if (rc &gt;= 0) {
+        if ((rc = qemuMonitorJobDismiss(qemuDomainGetMonitor(vm), job-&gt;name)) &gt;= 0)
+            dismissed = true;
+    }
+
+    if (job-&gt;invalidData) {
+        VIR_WARN(&quot;terminating job '%s' with invalid data&quot;, job-&gt;name);
+        goto cleanup;
+    }
+
+    if (qemuDomainObjExitMonitor(driver, vm) &lt; 0 || rc &lt; 0)
+        goto cleanup;
+
+    if (refreshed)
+        qemuDomainSaveStatus(vm);
+
+    VIR_DEBUG(&quot;handling job '%s' state '%d' newstate '%d'&quot;, job-&gt;name, job-&gt;state, job-&gt;newstate);
+
+    qemuBlockJobEventProcessConcludedTransition(job, driver, vm, asyncJob);
+
+ cleanup:
+    if (dismissed) {
+        qemuBlockJobUnregister(job, vm);
+        job = NULL;
</pre></blockquote><pre style="margin: 0em;">

job is a local parameter here so this statement has no real effect.
Moreover, I'd expect that the caller of the function still holds a
reference.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
+        qemuDomainSaveConfig(vm);
+    }
+
+    for (i = 0; i &lt; njobinfo; i++)
+        qemuMonitorJobInfoFree(jobinfo[i]);
+    VIR_FREE(jobinfo);
+}
+
+
</pre></blockquote><pre style="margin: 0em;">

Reviewed-by: J&#xE1;n Tomko &lt;jtomko@xxxxxxxxxx&gt;

Jano
</pre><p><strong>Attachment:
<a href="attachments/pgpSnYQoWEuLv.pgp" ><tt>signature.asc</tt></a></strong><br>
<em>Description:</em> PGP signature</p>
<pre>--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a></pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187428.html">Re:  [PATCH 17/25] qemu: Add handler for job state change event</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187430.html">Re:  [PATCH 19/25] qemu: process: Refresh -blockdev based blockjobs on reconnect to qemu</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187332.html">[PATCH 18/25] qemu: blockjob: Add modern block job event	handler</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187333.html">[PATCH 19/25] qemu: process: Refresh -blockdev based	blockjobs on reconnect to qemu</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187429"><strong>Date</strong></a></li>
<li><a href="index.html#187429"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH v4 4/8] qemu_driver: hook up	query&#45;cpu&#45;model&#45;baseline -->
<!--X-From-R13: Qbyyva Inyyvat &#60;jnyyvatNyvahk.voz.pbz> -->
<!--X-Date: Wed, 17 Jul 2019 07:04:01 &#45;0700 -->
<!--X-Message-Id: 1563372209&#45;23466&#45;5&#45;git&#45;send&#45;email&#45;walling@linux.ibm.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 1563372209&#45;23466&#45;1&#45;git&#45;send&#45;email&#45;walling@linux.ibm.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; [PATCH v4 4/8] qemu_driver: hook up	query-cpu-model-baseline</title>
<meta name="description" content="libvirt: [PATCH v4 4/8] qemu_driver: hook up	query-cpu-model-baseline">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>[PATCH v4 4/8] qemu_driver: hook up	query-cpu-model-baseline</h1>
[<a href="msg187569.html">Date Prev</a>][<a href="msg187573.html">Date Next</a>][<a href="msg187569.html">Thread Prev</a>][<a href="msg187573.html">Thread Next</a>][<a href="maillist.html#187570">Date Index</a>][<a href="index.html#187570">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH v4 4/8] qemu_driver: hook up	query-cpu-model-baseline</li>
<li><em>From</em>: Collin Walling &lt;walling@xxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Wed, 17 Jul 2019 10:03:25 -0400</li>
<li><em>Cc</em>: bwalk@xxxxxxxxxxxxx, jdenemar@xxxxxxxxxx, danielhb413@xxxxxxxxx,        david@xxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187571.html">1563372209-23466-1-git-send-email-walling@linux.ibm.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187571.html">1563372209-23466-1-git-send-email-walling@linux.ibm.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>This command is hooked into the virsh hypervisor-cpu-baseline command.
As such, the CPU models provided in the XML sent to the command will be
baselined with the CPU contained in the QEMU capabilities file for the
appropriate QEMU binary (for s390x, this CPU definition can be observed
via virsh domcapabilities).

Signed-off-by: Collin Walling &lt;walling@xxxxxxxxxxxxx&gt;
Reviewed-by: Daniel Henrique Barboza &lt;danielh413@xxxxxxxxx&gt;
---
 src/qemu/qemu_capabilities.c | 84 ++++++++++++++++++++++++++++++++++++++++++++
 src/qemu/qemu_capabilities.h |  7 ++++
 src/qemu/qemu_driver.c       | 27 ++++++++++++++
 3 files changed, 118 insertions(+)

diff --git a/src/qemu/qemu_capabilities.c b/src/qemu/qemu_capabilities.c
index b898113..ab337fa 100644
--- a/src/qemu/qemu_capabilities.c
+++ b/src/qemu/qemu_capabilities.c
@@ -5574,3 +5574,87 @@ virQEMUCapsStripMachineAliases(virQEMUCapsPtr qemuCaps)
     for (i = 0; i &lt; qemuCaps-&gt;nmachineTypes; i++)
         VIR_FREE(qemuCaps-&gt;machineTypes[i].alias);
 }
+
+
+static int
+virQEMUCapsStealCPUModelFromInfo(virCPUDefPtr dst,
+                                 qemuMonitorCPUModelInfoPtr *src)
+{
+    qemuMonitorCPUModelInfoPtr info = *src;
+    size_t i;
+
+    virCPUDefFreeModel(dst);
+
+    VIR_STEAL_PTR(dst-&gt;model, info-&gt;name);
+
+    for (i = 0; i &lt; info-&gt;nprops; i++) {
+        char *name = info-&gt;props[i].name;
+        int policy = VIR_CPU_FEATURE_REQUIRE;
+
+        if (info-&gt;props[i].type == QEMU_MONITOR_CPU_PROPERTY_BOOLEAN &amp;&amp;
+            !info-&gt;props[i].value.boolean)
+            policy = VIR_CPU_FEATURE_DISABLE;
+
+        if (virCPUDefAddFeature(dst, name, policy) &lt; 0)
+            goto error;
+    }
+
+    qemuMonitorCPUModelInfoFree(info);
+    *src = NULL;
+    return 0;
+
+ error:
+    virCPUDefFree(dst);
+    return -1;
+}
+
+
+virCPUDefPtr
+virQEMUCapsCPUModelBaseline(virQEMUCapsPtr qemuCaps,
+                            const char *libDir,
+                            uid_t runUid,
+                            gid_t runGid,
+                            int ncpus,
+                            virCPUDefPtr *cpus)
+{
+    qemuMonitorCPUModelInfoPtr result = NULL;
+    qemuProcessQMPPtr proc = NULL;
+    virCPUDefPtr cpu = NULL;
+    virCPUDefPtr baseline = NULL;
+    size_t i;
+
+    if (VIR_ALLOC(cpu) &lt; 0)
+        goto cleanup;
+
+    if (virCPUDefCopyModel(cpu, cpus[0], false))
+        goto cleanup;
+
+    if (!(proc = qemuProcessQMPNew(qemuCaps-&gt;binary, libDir,
+                                   runUid, runGid, false)))
+        goto cleanup;
+
+    if (qemuProcessQMPStart(proc) &lt; 0)
+        goto cleanup;
+
+    for (i = 1; i &lt; ncpus; i++) {
+        if (qemuMonitorGetCPUModelBaseline(proc-&gt;mon, cpu-&gt;model,
+                                           cpu-&gt;nfeatures, cpu-&gt;features,
+                                           cpus[i]-&gt;model, cpus[i]-&gt;nfeatures,
+                                           cpus[i]-&gt;features, &amp;result) &lt; 0)
+            goto cleanup;
+
+        if (virQEMUCapsStealCPUModelFromInfo(cpu, &amp;result) &lt; 0)
+            goto cleanup;
+    }
+
+    VIR_STEAL_PTR(baseline, cpu);
+
+ cleanup:
+    if (!baseline)
+        virQEMUCapsLogProbeFailure(qemuCaps-&gt;binary);
+
+    qemuMonitorCPUModelInfoFree(result);
+    qemuProcessQMPFree(proc);
+    virCPUDefFree(cpu);
+    return baseline;
+}
diff --git a/src/qemu/qemu_capabilities.h b/src/qemu/qemu_capabilities.h
index 8dde759..b49c0b9 100644
--- a/src/qemu/qemu_capabilities.h
+++ b/src/qemu/qemu_capabilities.h
@@ -665,3 +665,10 @@ virQEMUCapsGetSEVCapabilities(virQEMUCapsPtr qemuCaps);
 
 virArch virQEMUCapsArchFromString(const char *arch);
 const char *virQEMUCapsArchToString(virArch arch);
+
+virCPUDefPtr virQEMUCapsCPUModelBaseline(virQEMUCapsPtr qemuCaps,
+                                        const char *libDir,
+                                        uid_t runUid,
+                                        gid_t runGid,
+                                        int ncpus,
+                                        virCPUDefPtr *cpus);
diff --git a/src/qemu/qemu_driver.c b/src/qemu/qemu_driver.c
index d3a144a..37b9c75 100644
--- a/src/qemu/qemu_driver.c
+++ b/src/qemu/qemu_driver.c
@@ -13553,6 +13553,7 @@ qemuConnectBaselineHypervisorCPU(virConnectPtr conn,
                                  unsigned int flags)
 {
     virQEMUDriverPtr driver = conn-&gt;privateData;
+    virQEMUDriverConfigPtr config = driver-&gt;config;
     virCPUDefPtr *cpus = NULL;
     virQEMUCapsPtr qemuCaps = NULL;
     virArch arch;
@@ -13607,6 +13608,32 @@ qemuConnectBaselineHypervisorCPU(virConnectPtr conn,
         if (!(cpu = virCPUBaseline(arch, cpus, ncpus, cpuModels,
                                    (const char **)features, migratable)))
             goto cleanup;
+    } else if (ARCH_IS_S390(arch) &amp;&amp;
+               virQEMUCapsGet(qemuCaps, QEMU_CAPS_QUERY_CPU_MODEL_BASELINE)) {
+        /* Add a copy of the hypervisor CPU to the list */
+        virCPUDefPtr hvCPU, tmp;
+        size_t allocated = ncpus + 1;
+
+        hvCPU = virQEMUCapsGetHostModel(qemuCaps, virttype,
+                                        VIR_QEMU_CAPS_HOST_CPU_REPORTED);
+        if (VIR_ALLOC(tmp) &lt; 0)
+             goto cleanup;
+
+        if (virCPUDefCopyModel(tmp, hvCPU, false))
+             goto cleanup;
+
+        if (VIR_INSERT_ELEMENT(cpus, ncpus, allocated, tmp) &lt; 0)
+             goto cleanup;
+
+        ncpus++;
+
+        if (!(cpu = virQEMUCapsCPUModelBaseline(qemuCaps, config-&gt;libDir,
+                                                config-&gt;user, config-&gt;group,
+                                                ncpus, cpus)))
+            goto cleanup;
+
+        if (!(flags &amp; VIR_CONNECT_BASELINE_CPU_EXPAND_FEATURES))
+            virCPUDefFreeFeatures(cpu);
     } else {
         virReportError(VIR_ERR_OPERATION_UNSUPPORTED,
                        _(&quot;computing baseline hypervisor CPU is not supported &quot;
-- 
2.7.4

--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187569.html">[PATCH v4 7/8] cpu_conf: xml to cpu definition parse	helper</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187573.html">[PATCH v4 6/8] qemu_capabilities: introduce	QEMU_CAPS_QUERY_CPU_MODEL_COMPARISON</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187569.html">[PATCH v4 7/8] cpu_conf: xml to cpu definition parse	helper</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187573.html">[PATCH v4 6/8] qemu_capabilities: introduce	QEMU_CAPS_QUERY_CPU_MODEL_COMPARISON</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187570"><strong>Date</strong></a></li>
<li><a href="index.html#187570"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH v1 11/31] conf: Format and parse NVMe type disk -->
<!--X-From-R13: Brgre Yerzcn &#60;cxerzcnNerqung.pbz> -->
<!--X-Date: Thu, 11 Jul 2019 09:05:23 &#45;0700 -->
<!--X-Message-Id: 20190711160517.GE2061@angien.pipo.sk -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: cover.1562859733.git.mprivozn@redhat.com -->
<!--X-Reference: ff5dbd208442af172c661aa470d828cb11878c50.1562859733.git.mprivozn@redhat.com -->
<!--X-Derived: pgpJftjP9r1vB.pgp -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; Re:  [PATCH v1 11/31] conf: Format and parse NVMe type disk</title>
<meta name="description" content="libvirt: Re:  [PATCH v1 11/31] conf: Format and parse NVMe type disk">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>Re:  [PATCH v1 11/31] conf: Format and parse NVMe type disk</h1>
[<a href="msg187198.html">Date Prev</a>][<a href="msg187200.html">Date Next</a>][<a href="msg187171.html">Thread Prev</a>][<a href="msg187229.html">Thread Next</a>][<a href="maillist.html#187199">Date Index</a>][<a href="index.html#187199">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH v1 11/31] conf: Format and parse NVMe type disk</li>
<li><em>From</em>: Peter Krempa &lt;pkrempa@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 11 Jul 2019 18:05:17 +0200</li>
<li><em>Cc</em>: libvir-list@xxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187171.html">ff5dbd208442af172c661aa470d828cb11878c50.1562859733.git.mprivozn@redhat.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187163.html">cover.1562859733.git.mprivozn@redhat.com</a>&gt;	&lt;<a href="msg187171.html">ff5dbd208442af172c661aa470d828cb11878c50.1562859733.git.mprivozn@redhat.com</a>&gt;</li>
<li><em>User-agent</em>: Mutt/1.12.0 (2019-05-25)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Thu, Jul 11, 2019 at 17:53:58 +0200, Michal Privoznik wrote:
&gt; To simplify implementation, some restrictions are added. For
&gt; instance, an NVMe disk can't go to any bus but virtio and has to
&gt; be type of 'disk' and can't have startupPolicy set.
&gt; 
&gt; Signed-off-by: Michal Privoznik &lt;mprivozn@xxxxxxxxxx&gt;
&gt; ---
&gt;  src/conf/domain_conf.c                 | 129 +++++++++++++++++++++++++
&gt;  src/libvirt_private.syms               |   1 +
&gt;  src/qemu/qemu_block.c                  |   1 +
&gt;  src/qemu/qemu_command.c                |   1 +
&gt;  src/qemu/qemu_driver.c                 |   4 +
&gt;  src/qemu/qemu_migration.c              |   1 +
&gt;  src/util/virstoragefile.c              |  59 +++++++++++
&gt;  src/util/virstoragefile.h              |  15 +++
&gt;  src/xenconfig/xen_xl.c                 |   1 +
&gt;  tests/qemuxml2argvdata/disk-nvme.xml   |  12 ++-
&gt;  tests/qemuxml2xmloutdata/disk-nvme.xml |   1 +
&gt;  tests/qemuxml2xmltest.c                |   1 +
&gt;  12 files changed, 224 insertions(+), 2 deletions(-)
&gt;  create mode 120000 tests/qemuxml2xmloutdata/disk-nvme.xml
&gt; 
&gt; diff --git a/src/conf/domain_conf.c b/src/conf/domain_conf.c
&gt; index 3323c9a5b1..73f5e1fa0f 100644
&gt; --- a/src/conf/domain_conf.c
&gt; +++ b/src/conf/domain_conf.c
&gt; @@ -5088,6 +5088,11 @@ virDomainDiskDefPostParse(virDomainDiskDefPtr disk,
&gt;          return -1;
&gt;      }
&gt;  
&gt; +    if (disk-&gt;src-&gt;type == VIR_STORAGE_TYPE_NVME) {
&gt; +        if (disk-&gt;src-&gt;nvme-&gt;managed == VIR_TRISTATE_BOOL_ABSENT)
&gt; +            disk-&gt;src-&gt;nvme-&gt;managed = VIR_TRISTATE_BOOL_YES;
&gt; +    }
&gt; +
&gt;      if (disk-&gt;info.type == VIR_DOMAIN_DEVICE_ADDRESS_TYPE_NONE &amp;&amp;
&gt;          virDomainDiskDefAssignAddress(xmlopt, disk, def) &lt; 0) {
&gt;          return -1;
&gt; @@ -5938,6 +5943,38 @@ virDomainDiskDefValidate(const virDomainDiskDef *disk)
&gt;          return -1;
&gt;      }
&gt;  
&gt; +    if (disk-&gt;src-&gt;type == VIR_STORAGE_TYPE_NVME) {

Note that this can potentially happen in the backing chain as well, so
this should be checked throughout the whole backing chain.

Also this seems all to belong to the qemu specific post parse callback.

&gt; +        /* These might not be valid for all hypervisors, but be
&gt; +         * strict now and possibly refine in the future. */
&gt; +        if (disk-&gt;device != VIR_DOMAIN_DISK_DEVICE_DISK) {
&gt; +            virReportError(VIR_ERR_CONFIG_UNSUPPORTED,
&gt; +                           _(&quot;Unsupported disk type '%s' for NVMe disk&quot;),
&gt; +                           virDomainDiskDeviceTypeToString(disk-&gt;device));
&gt; +            return -1;
&gt; +        }
&gt; +
&gt; +        if (disk-&gt;bus != VIR_DOMAIN_DISK_BUS_VIRTIO) {
&gt; +            virReportError(VIR_ERR_CONFIG_UNSUPPORTED,
&gt; +                           _(&quot;Unsupported bus '%s' for NVMe disk&quot;),
&gt; +                           virDomainDiskBusTypeToString(disk-&gt;bus));
&gt; +            return -1;
&gt; +        }
&gt; +
&gt; +        if (disk-&gt;startupPolicy != VIR_DOMAIN_STARTUP_POLICY_DEFAULT &amp;&amp;
&gt; +            disk-&gt;startupPolicy != VIR_DOMAIN_STARTUP_POLICY_MANDATORY) {
&gt; +            virReportError(VIR_ERR_CONFIG_UNSUPPORTED,
&gt; +                           _(&quot;Unsupported startup policy '%s' for NVMe disk&quot;),
&gt; +                           virDomainStartupPolicyTypeToString(disk-&gt;startupPolicy));
&gt; +            return -1;
&gt; +        }
&gt; +
&gt; +        if (disk-&gt;src-&gt;shared) {
&gt; +            virReportError(VIR_ERR_CONFIG_UNSUPPORTED, &quot;%s&quot;,
&gt; +                           _(&quot;Unsupported &lt;shareable/&gt; for NVMe disk&quot;));
&gt; +            return -1;
&gt; +        }
&gt; +    }
&gt; +
</pre><p><strong>Attachment:
<a href="attachments/pgpJftjP9r1vB.pgp" ><tt>signature.asc</tt></a></strong><br>
<em>Description:</em> PGP signature</p>
<pre>--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a></pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187198.html">[PATCH 00/29] Split the libvirtd daemon into per-driver	daemons</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187200.html">[PATCH 03/29] logging: pass binary name not logfile name	when enabling logging</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187171.html">[PATCH v1 11/31] conf: Format and parse NVMe type disk</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187229.html">Re:  [PATCH v1 11/31] conf: Format and parse NVMe type disk</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187199"><strong>Date</strong></a></li>
<li><a href="index.html#187199"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

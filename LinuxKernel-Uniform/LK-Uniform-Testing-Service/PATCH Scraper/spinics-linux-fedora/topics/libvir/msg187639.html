<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH 1/1] Revert "Revert "qemu: Temporary disable owner remembering"" -->
<!--X-From-R13: Rnavry Vraevdhr Pneobmn &#60;qnavryuo413Ntznvy.pbz> -->
<!--X-Date: Thu, 18 Jul 2019 03:18:00 &#45;0700 -->
<!--X-Message-Id: 71166592&#45;7b8b&#45;74f1&#45;c117&#45;7c953de62503@gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190717172004.666&#45;1&#45;danielhb413@gmail.com -->
<!--X-Reference: b6adae3a&#45;f8f5&#45;62f8&#45;fc87&#45;319b3896e987@redhat.com -->
<!--X-Reference: 0c30a8ea&#45;3ec9&#45;b61e&#45;d8e0&#45;a610cc92d7af@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; Re:  [PATCH 1/1] Revert &quot;Revert &quot;qemu: Temporary disable owner remembering&quot;&quot;</title>
<meta name="description" content="libvirt: Re:  [PATCH 1/1] Revert &quot;Revert &quot;qemu: Temporary disable owner remembering&quot;&quot;">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>Re:  [PATCH 1/1] Revert &quot;Revert &quot;qemu: Temporary disable owner remembering&quot;&quot;</h1>
[<a href="msg187638.html">Date Prev</a>][<a href="msg187640.html">Date Next</a>][<a href="msg187629.html">Thread Prev</a>][<a href="msg187614.html">Thread Next</a>][<a href="maillist.html#187639">Date Index</a>][<a href="index.html#187639">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH 1/1] Revert &quot;Revert &quot;qemu: Temporary disable owner remembering&quot;&quot;</li>
<li><em>From</em>: Daniel Henrique Barboza &lt;danielhb413@xxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 18 Jul 2019 07:17:46 -0300</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187629.html">0c30a8ea-3ec9-b61e-d8e0-a610cc92d7af@redhat.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187607.html">20190717172004.666-1-danielhb413@gmail.com</a>&gt;	&lt;<a href="msg187627.html">b6adae3a-f8f5-62f8-fc87-319b3896e987@redhat.com</a>&gt;	&lt;<a href="msg187629.html">0c30a8ea-3ec9-b61e-d8e0-a610cc92d7af@redhat.com</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101	Thunderbird/60.7.2</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">


On 7/18/19 5:48 AM, Michal Privoznik wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On 7/18/19 8:46 AM, Michal Privoznik wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On 7/17/19 7:20 PM, Daniel Henrique Barboza wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
After this commit, QEMU domains with PCI hostdevs running with
managed=true started to fail to launch with the following error:

</pre><tt>error : virProcessRunInFork:1170 : internal error: child reported 
</tt><tt>(status=125): unable to open /dev/vfio/1: Device or resource busy
</tt><pre style="margin: 0em;">

One way to avoid this issue is to disable this new feature
in qemu.conf, setting remember_owner=0. However, given that
this feature is enabled by default and it is breaking domains that
were running before it, it is best to revert the change until
it is fixed for this scenario as well.

</pre></blockquote><pre style="margin: 0em;">

</pre><tt>Well, ideally, we want the feature to be turned on by default, just 
</tt><tt>like namespaces for instance. I've temporarily disabled the feature 
</tt><tt>back in the day because we were close to release and it turned out 
</tt><tt>the feature was not ready. But now there is still plenty of time to 
</tt><tt>fix it.
</tt><pre style="margin: 0em;">

</pre><tt>Anyway, I'll investigate. Meanwhile, can you share your &lt;hostdev/&gt; 
</tt><tt>config or even better the full domain definition please?
</tt><pre style="margin: 0em;">

</pre></blockquote><pre style="margin: 0em;">

</pre><tt>Okay, so I think I know what is going on. You have two &lt;hostdev/&gt;-s in 
</tt><tt>your domain and both of them belong to the same IOMMU group, right?
</tt></blockquote><pre style="margin: 0em;">

</pre><tt>Yes. I forgot to mention that in this reversal patch, sorry. The error 
</tt><tt>is reproduced
</tt><tt>with a VM using a PCI Multifunction card - alll 4 functions in the IOMMU 
</tt><tt>group 1.
</tt><pre style="margin: 0em;">

</pre><tt>I'll test your already proposed fix in a few moments. Just need a hit of 
</tt><tt>coffee first :)
</tt><pre style="margin: 0em;">



Thanks,

DHB





</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><tt>If that is the case, then the same path appears twice in the list of 
</tt><tt>paths passed to virSecurityManagerMetadataLock(). For instance, in my 
</tt><tt>case:
</tt><pre style="margin: 0em;">

</pre><tt>Thread 2.1 &quot;libvirtd&quot; hit Breakpoint 3, virSecurityManagerMetadataLock 
</tt><tt>(mgr=0x7f365c026660, paths=0x7f36a001c1e0, npaths=6) at 
</tt><tt>security/security_manager.c:1283
</tt><pre style="margin: 0em;">
1283&#xA0;&#xA0;&#xA0; {
virSecurityManagerMetadataLock 1 # p *paths@npaths
$6 = {0x7f36a0027720 &quot;/var/lib/libvirt/images/fedora.qcow2&quot;,
&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; 0x7f36a001a660 &quot;/var/lib/libvirt/images/fd.img&quot;,
</pre><tt>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; 0x7f36a001c470 
</tt><tt>&quot;/dev/disk/by-path/ip-10.37.132.232:3260-iscsi-iqn.2017-03.com.mprivozn:server-lun-1&quot;,
</tt><pre style="margin: 0em;">
&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; 0x7f36a00262b0 &quot;/dev/vfio/9&quot;,
&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; 0x7f36a0025e20 &quot;/dev/vfio/9&quot;,
</pre><tt>&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; 0x7f36a001d880 
</tt><tt>&quot;/var/lib/libvirt/qemu/channel/target/domain-1-fedora/org.qemu.guest_agent.0&quot;}
</tt><pre style="margin: 0em;">


</pre><tt>The &quot;/dev/vfio/9&quot; path is there twice because I have this graphics 
</tt><tt>card that has two functions and I'm passing them both into the domain. 
</tt><tt>The problem here is that when virSecurityManagerMetadataLock() gets to 
</tt><tt>first /dev/vfio/9 path, it opens it and locks it. Then it wants to 
</tt><tt>process the next path (which is the same path), but it fails 
</tt><tt>open()-ing the path, because it's locked. Honestly, I don't know if 
</tt><tt>that is expected behaviour, but even it if wasn't then we would fail 
</tt><tt>to lock the path second time. I'm proposing a fix in no time.
</tt><pre style="margin: 0em;">

Michal
</pre></blockquote><pre style="margin: 0em;">

--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187638.html">[PATCH] test_driver: implement virDomainGetCPUStats</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187640.html">Re:  [PATCH v3] qapi: add dirty-bitmaps to	query-named-block-nodes result</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187629.html">Re:  [PATCH 1/1] Revert &quot;Revert &quot;qemu: Temporary disable owner remembering&quot;&quot;</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187614.html">[PATCH v3] qapi: add dirty-bitmaps to	query-named-block-nodes result</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187639"><strong>Date</strong></a></li>
<li><a href="index.html#187639"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

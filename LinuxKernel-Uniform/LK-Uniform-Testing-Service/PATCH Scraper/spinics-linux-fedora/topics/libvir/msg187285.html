<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH 27/29] remote: switch to connect to per&#45;driver daemons by default -->
<!--X-From-R13: [vpuny Bevibmavx &#60;zcevibmaNerqung.pbz> -->
<!--X-Date: Fri, 12 Jul 2019 06:37:13 &#45;0700 -->
<!--X-Message-Id: 05a9548e&#45;40ed&#45;48c6&#45;ff45&#45;23d8b1e5d043@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190711160516.2130&#45;1&#45;berrange@redhat.com -->
<!--X-Reference: 20190711160516.2130&#45;28&#45;berrange@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; Re:  [PATCH 27/29] remote: switch to connect to per-driver daemons by default</title>
<meta name="description" content="libvirt: Re:  [PATCH 27/29] remote: switch to connect to per-driver daemons by default">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>Re:  [PATCH 27/29] remote: switch to connect to per-driver daemons by default</h1>
[<a href="msg187284.html">Date Prev</a>][<a href="msg187286.html">Date Next</a>][<a href="msg187227.html">Thread Prev</a>][<a href="msg187228.html">Thread Next</a>][<a href="maillist.html#187285">Date Index</a>][<a href="index.html#187285">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH 27/29] remote: switch to connect to per-driver daemons by default</li>
<li><em>From</em>: Michal Privoznik &lt;mprivozn@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Fri, 12 Jul 2019 15:36:57 +0200</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187227.html">20190711160516.2130-28-berrange@redhat.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187198.html">20190711160516.2130-1-berrange@redhat.com</a>&gt;	&lt;<a href="msg187227.html">20190711160516.2130-28-berrange@redhat.com</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101	Thunderbird/60.7.2</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
On 7/11/19 6:05 PM, Daniel P. Berrang&#xE9; wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Historically URIs handled by the remote driver will always connect to
the libvirtd UNIX socket. There will now be one daemon per driver, and
each of these has its own UNIX sockets to connect to.

It will still be possible to run the traditional monolithic libvirtd too
which will have the original UNIX socket path.

In addition there is a virproxyd daemon that doesn't run any drivers,
but provides proxying for clients accessing libvirt over IP sockets, or
tunnelling to the legacy libvirtd UNIX socket path.

Finally when running inside a daemon, the remote driver must not reject
connections unconditionally. For example, the QEMU driver needs to be
able to connect to the network driver. The remote driver must thus be
willing to handle connections even when inside the daemon, provided no
local driver is registered.

This refactoring causes the remote driver to prefer connecting to the
per-driver daemons. The URI parameter &quot;no_direct=1&quot; can be used to
force connecting to the legacy libvirtd UNIX socket.

The remote driver will only ever spawn the per-driver daemons, or
the legacy libvirtd. It won't ever try to spawn virtproxyd, as
that is only there for IP based connectivity, or for access from
legacy remote clients.

The $HOME/.config/libvirt/libvirt.conf can also be set to have a
parameter 'remote_direct=0|1' to hardcode the behaviour for all
clients.

Signed-off-by: Daniel P. Berrang&#xE9; &lt;berrange@xxxxxxxxxx&gt;
---
  src/driver.h               |   2 +
  src/libvirt.c              |  24 +++++
  src/remote/remote_driver.c | 202 +++++++++++++++++++++++++++++++++----
  src/remote/remote_driver.h |   3 -
  4 files changed, 207 insertions(+), 24 deletions(-)

diff --git a/src/driver.h b/src/driver.h
index 898fb96df4..f7d667a03c 100644
--- a/src/driver.h
+++ b/src/driver.h
@@ -108,6 +108,8 @@ int virSetSharedNWFilterDriver(virNWFilterDriverPtr driver) ATTRIBUTE_RETURN_CHE
  int virSetSharedSecretDriver(virSecretDriverPtr driver) ATTRIBUTE_RETURN_CHECK;
  int virSetSharedStorageDriver(virStorageDriverPtr driver) ATTRIBUTE_RETURN_CHECK;
</pre><tt>  
</tt><tt>+bool virHasDriverForURIScheme(const char *scheme);
</tt><pre style="margin: 0em;">
+
  int virDriverLoadModule(const char *name,
                          const char *regfunc,
                          bool required);
diff --git a/src/libvirt.c b/src/libvirt.c
index 7e665b6cba..e21cad0e2e 100644
--- a/src/libvirt.c
+++ b/src/libvirt.c
@@ -601,6 +601,30 @@ virRegisterConnectDriver(virConnectDriverPtr driver,
  }
</pre><tt>  
</tt><tt>  
</tt><tt>+/**
</tt><pre style="margin: 0em;">
+ * virHasDriverForURIScheme:
+ * @scheme: the URI scheme
+ *
+ * Determine if there is a driver registered that explicitly
+ * handles URIs with the scheme @scheme.
+ *
+ * Returns: true if a driver is registered
+ */
+bool virHasDriverForURIScheme(const char *scheme)
+{
+    size_t i, j;
+    for (i = 0; i &lt; virConnectDriverTabCount; i++) {
+        if (!virConnectDriverTab[i]-&gt;uriSchemes)
+            continue;
+        for (j = 0; virConnectDriverTab[i]-&gt;uriSchemes[j]; j++) {
+            if (STREQ(virConnectDriverTab[i]-&gt;uriSchemes[j], scheme))
+                return true;
+        }
+    }
+
+    return false;
+}
+
  /**
   * virRegisterStateDriver:
   * @driver: pointer to a driver block
diff --git a/src/remote/remote_driver.c b/src/remote/remote_driver.c
index c6905dffff..98a165e163 100644
--- a/src/remote/remote_driver.c
+++ b/src/remote/remote_driver.c
@@ -72,6 +72,22 @@ VIR_ENUM_IMPL(remoteDriverTransport,
                REMOTE_DRIVER_TRANSPORT_LAST,
                &quot;tls&quot;, &quot;unix&quot;, &quot;ssh&quot;, &quot;libssh2&quot;, &quot;ext&quot;, &quot;tcp&quot;, &quot;libssh&quot;);
</pre><tt>  
</tt><tt>+typedef enum {
</tt><pre style="margin: 0em;">
+    /* Prefer per-driver virt*d daemons, but fallback to legacy libvirtd */
+    REMOTE_DRIVER_MODE_AUTO,
+    /* Always use the legacy libvirtd */
+    REMOTE_DRIVER_MODE_LEGACY,
+    /* Always use the per-driver virt*d daemons */
+    REMOTE_DRIVER_MODE_DIRECT,
+
+    REMOTE_DRIVER_MODE_LAST
+} remoteDriverMode;
+
+VIR_ENUM_DECL(remoteDriverMode);
+VIR_ENUM_IMPL(remoteDriverMode,
+              REMOTE_DRIVER_MODE_LAST,
+              &quot;auto&quot;, &quot;legacy&quot;, &quot;direct&quot;);
+
  #if SIZEOF_LONG &lt; 8
  # define HYPER_TO_TYPE(_type, _to, _from) \
      do { \
@@ -92,6 +108,7 @@ VIR_ENUM_IMPL(remoteDriverTransport,
</pre><tt>  
</tt><tt>  static bool inside_daemon;
</tt><tt>  
</tt><tt>+
</tt><pre style="margin: 0em;">
  struct private_data {
      virMutex lock;
</pre><tt>  
</tt><tt>@@ -740,8 +757,9 @@ remoteConnectSupportsFeatureUnlocked(virConnectPtr conn,
</tt><tt>  
</tt><tt>  
</tt><tt>  static char *
</tt><pre style="margin: 0em;">
-remoteGetUNIXSocket(remoteDriverTransport transport,
-                    unsigned int flags)
+remoteGetUNIXSocketHelper(remoteDriverTransport transport,
+                          const char *sock_prefix,
+                          unsigned int flags)
  {
      char *sockname = NULL;
      VIR_AUTOFREE(char *userdir);
@@ -758,21 +776,125 @@ remoteGetUNIXSocket(remoteDriverTransport transport,
          if (!(userdir = virGetUserRuntimeDirectory()))
              return NULL;
</pre><tt>  
</tt><tt>-        if (virAsprintf(&amp;sockname,
</tt><pre style="margin: 0em;">
-                        &quot;%s/&quot; LIBVIRTD_USER_UNIX_SOCKET, userdir) &lt; 0)
+        if (virAsprintf(&amp;sockname, &quot;%s/%s-sock&quot;,
+                        userdir, sock_prefix) &lt; 0)
              return NULL;
      } else {
-        if (VIR_STRDUP(sockname,
-                       flags &amp; VIR_DRV_OPEN_REMOTE_RO ?
-                       LIBVIRTD_PRIV_UNIX_SOCKET_RO :
-                       LIBVIRTD_PRIV_UNIX_SOCKET) &lt; 0)
+        if (virAsprintf(&amp;sockname, &quot;%s/run/libvirt/%s-%s&quot;,
+                        LOCALSTATEDIR, sock_prefix,
+                        flags &amp; VIR_DRV_OPEN_REMOTE_RO ?
+                        &quot;sock-ro&quot; : &quot;sock&quot;) &lt; 0)
              return NULL;
      }
</pre><tt>  
</tt><tt>-    VIR_DEBUG(&quot;Chosen UNIX sockname %s&quot;, sockname);
</tt><pre style="margin: 0em;">
+    VIR_DEBUG(&quot;Built UNIX sockname %s for transport %s prefix %s flags=0x%x&quot;,
+              sockname, remoteDriverTransportTypeToString(transport),
+              sock_prefix, flags);
      return sockname;
  }
</pre><tt>  
</tt><tt>+
</tt><pre style="margin: 0em;">
+#define DRIVER_SCHEME_CHRS &quot;abcdefghijklmnopqrstuvwxyz&quot;
+static char *
+remoteGetUNIXSocket(remoteDriverTransport transport,
+                    remoteDriverMode mode,
+                    const char *driver,
+                    char **daemon,
+                    unsigned int flags)
+{
+    char *sock_name = NULL;
+    VIR_AUTOFREE(char *) direct_daemon = NULL;
+    VIR_AUTOFREE(char *) legacy_daemon = NULL;
+    VIR_AUTOFREE(char *) direct_sock_name = NULL;
+    VIR_AUTOFREE(char *) legacy_sock_name = NULL;
+
+    if (strspn(driver, DRIVER_SCHEME_CHRS) &lt; strlen(driver)) {
</pre></blockquote><pre style="margin: 0em;">

</pre><tt>Note that if no connection URI was provided then @driver is going to be 
</tt><tt>NULL here and thus calling strlen() over it is going to crash.
</tt><pre style="margin: 0em;">

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
+        virReportError(VIR_ERR_INVALID_ARG,
+                       _(&quot;Invalid character in driver '%s'&quot;), driver);
+        return NULL;
+    }
</pre></blockquote><pre style="margin: 0em;">

Michal

--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187284.html">Re:  [PATCH 0/4] qemu: blockdev-related cleanups and refactors (blockdev-add saga)</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187286.html">Re:  [PATCH 26/29] remote: refactor the code for choosing the UNIX socket path</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187227.html">[PATCH 27/29] remote: switch to connect to per-driver	daemons by default</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187228.html">[PATCH 28/29] all: don't wait for driver lock during	startup</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187285"><strong>Date</strong></a></li>
<li><a href="index.html#187285"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

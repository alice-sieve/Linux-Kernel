<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH v1 11/31] conf: Format and parse NVMe type disk -->
<!--X-From-R13: [vpuny Bevibmavx &#60;zcevibmaNerqung.pbz> -->
<!--X-Date: Thu, 11 Jul 2019 08:54:50 &#45;0700 -->
<!--X-Message-Id: ff5dbd208442af172c661aa470d828cb11878c50.1562859733.git.mprivozn@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: cover.1562859733.git.mprivozn@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; [PATCH v1 11/31] conf: Format and parse NVMe type disk</title>
<meta name="description" content="libvirt: [PATCH v1 11/31] conf: Format and parse NVMe type disk">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>[PATCH v1 11/31] conf: Format and parse NVMe type disk</h1>
[<a href="msg187170.html">Date Prev</a>][<a href="msg187172.html">Date Next</a>][<a href="msg187467.html">Thread Prev</a>][<a href="msg187199.html">Thread Next</a>][<a href="maillist.html#187171">Date Index</a>][<a href="index.html#187171">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH v1 11/31] conf: Format and parse NVMe type disk</li>
<li><em>From</em>: Michal Privoznik &lt;mprivozn@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 11 Jul 2019 17:53:58 +0200</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187163.html">cover.1562859733.git.mprivozn@redhat.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187163.html">cover.1562859733.git.mprivozn@redhat.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>To simplify implementation, some restrictions are added. For
instance, an NVMe disk can't go to any bus but virtio and has to
be type of 'disk' and can't have startupPolicy set.

Signed-off-by: Michal Privoznik &lt;mprivozn@xxxxxxxxxx&gt;
---
 src/conf/domain_conf.c                 | 129 +++++++++++++++++++++++++
 src/libvirt_private.syms               |   1 +
 src/qemu/qemu_block.c                  |   1 +
 src/qemu/qemu_command.c                |   1 +
 src/qemu/qemu_driver.c                 |   4 +
 src/qemu/qemu_migration.c              |   1 +
 src/util/virstoragefile.c              |  59 +++++++++++
 src/util/virstoragefile.h              |  15 +++
 src/xenconfig/xen_xl.c                 |   1 +
 tests/qemuxml2argvdata/disk-nvme.xml   |  12 ++-
 tests/qemuxml2xmloutdata/disk-nvme.xml |   1 +
 tests/qemuxml2xmltest.c                |   1 +
 12 files changed, 224 insertions(+), 2 deletions(-)
 create mode 120000 tests/qemuxml2xmloutdata/disk-nvme.xml

diff --git a/src/conf/domain_conf.c b/src/conf/domain_conf.c
index 3323c9a5b1..73f5e1fa0f 100644
--- a/src/conf/domain_conf.c
+++ b/src/conf/domain_conf.c
@@ -5088,6 +5088,11 @@ virDomainDiskDefPostParse(virDomainDiskDefPtr disk,
         return -1;
     }
 
+    if (disk-&gt;src-&gt;type == VIR_STORAGE_TYPE_NVME) {
+        if (disk-&gt;src-&gt;nvme-&gt;managed == VIR_TRISTATE_BOOL_ABSENT)
+            disk-&gt;src-&gt;nvme-&gt;managed = VIR_TRISTATE_BOOL_YES;
+    }
+
     if (disk-&gt;info.type == VIR_DOMAIN_DEVICE_ADDRESS_TYPE_NONE &amp;&amp;
         virDomainDiskDefAssignAddress(xmlopt, disk, def) &lt; 0) {
         return -1;
@@ -5938,6 +5943,38 @@ virDomainDiskDefValidate(const virDomainDiskDef *disk)
         return -1;
     }
 
+    if (disk-&gt;src-&gt;type == VIR_STORAGE_TYPE_NVME) {
+        /* These might not be valid for all hypervisors, but be
+         * strict now and possibly refine in the future. */
+        if (disk-&gt;device != VIR_DOMAIN_DISK_DEVICE_DISK) {
+            virReportError(VIR_ERR_CONFIG_UNSUPPORTED,
+                           _(&quot;Unsupported disk type '%s' for NVMe disk&quot;),
+                           virDomainDiskDeviceTypeToString(disk-&gt;device));
+            return -1;
+        }
+
+        if (disk-&gt;bus != VIR_DOMAIN_DISK_BUS_VIRTIO) {
+            virReportError(VIR_ERR_CONFIG_UNSUPPORTED,
+                           _(&quot;Unsupported bus '%s' for NVMe disk&quot;),
+                           virDomainDiskBusTypeToString(disk-&gt;bus));
+            return -1;
+        }
+
+        if (disk-&gt;startupPolicy != VIR_DOMAIN_STARTUP_POLICY_DEFAULT &amp;&amp;
+            disk-&gt;startupPolicy != VIR_DOMAIN_STARTUP_POLICY_MANDATORY) {
+            virReportError(VIR_ERR_CONFIG_UNSUPPORTED,
+                           _(&quot;Unsupported startup policy '%s' for NVMe disk&quot;),
+                           virDomainStartupPolicyTypeToString(disk-&gt;startupPolicy));
+            return -1;
+        }
+
+        if (disk-&gt;src-&gt;shared) {
+            virReportError(VIR_ERR_CONFIG_UNSUPPORTED, &quot;%s&quot;,
+                           _(&quot;Unsupported &lt;shareable/&gt; for NVMe disk&quot;));
+            return -1;
+        }
+    }
+
     return 0;
 }
 
@@ -9184,6 +9221,76 @@ virDomainDiskSourceNetworkParse(xmlNodePtr node,
 }
 
 
+static int
+virDomainDiskSourceNVMeParse(xmlNodePtr node,
+                             xmlXPathContextPtr ctxt,
+                             virStorageSourcePtr src)
+{
+    VIR_AUTOPTR(virStorageSourceNVMeDef) nvme = NULL;
+    VIR_AUTOFREE(char *) type = NULL;
+    VIR_AUTOFREE(char *) namespace = NULL;
+    VIR_AUTOFREE(char *) managed = NULL;
+    xmlNodePtr address;
+
+    if (VIR_ALLOC(nvme) &lt; 0)
+        return -1;
+
+    if (!(type = virXMLPropString(node, &quot;type&quot;))) {
+        virReportError(VIR_ERR_XML_ERROR, &quot;%s&quot;,
+                       _(&quot;missing 'type' attribute to disk source&quot;));
+        return -1;
+    }
+
+    if (STRNEQ(type, &quot;pci&quot;)) {
+        virReportError(VIR_ERR_XML_ERROR,
+                       _(&quot;unsupported source type '%s'&quot;),
+                       type);
+        return -1;
+    }
+
+    if (!(namespace = virXMLPropString(node, &quot;namespace&quot;))) {
+        virReportError(VIR_ERR_XML_ERROR, &quot;%s&quot;,
+                       _(&quot;missing 'namespace' attribute to disk source&quot;));
+        return -1;
+    }
+
+    if (virStrToLong_ul(namespace, NULL, 10, &amp;nvme-&gt;namespace) &lt; 0) {
+        virReportError(VIR_ERR_XML_ERROR,
+                       _(&quot;malformed namespace '%s'&quot;),
+                       namespace);
+        return -1;
+    }
+
+    /* NVMe namespaces start from 1 */
+    if (nvme-&gt;namespace == 0) {
+        virReportError(VIR_ERR_XML_ERROR, &quot;%s&quot;,
+                       _(&quot;NVMe namespace can't be zero&quot;));
+        return -1;
+    }
+
+    if ((managed = virXMLPropString(node, &quot;managed&quot;))) {
+        if ((nvme-&gt;managed = virTristateBoolTypeFromString(managed)) &lt;= 0) {
+            virReportError(VIR_ERR_XML_ERROR,
+                           _(&quot;malformed managed value '%s'&quot;),
+                           managed);
+            return -1;
+        }
+    }
+
+    if (!(address = virXPathNode(&quot;./address&quot;, ctxt))) {
+        virReportError(VIR_ERR_XML_ERROR, &quot;%s&quot;,
+                       _(&quot;NVMe disk source is missing address&quot;));
+        return -1;
+    }
+
+    if (virPCIDeviceAddressParseXML(address, &amp;nvme-&gt;pciAddr) &lt; 0)
+        return -1;
+
+    VIR_STEAL_PTR(src-&gt;nvme, nvme);
+    return 0;
+}
+
+
 static int
 virDomainDiskSourcePRParse(xmlNodePtr node,
                            xmlXPathContextPtr ctxt,
@@ -9284,6 +9391,10 @@ virDomainStorageSourceParse(xmlNodePtr node,
         if (virDomainDiskSourcePoolDefParse(node, &amp;src-&gt;srcpool) &lt; 0)
             return -1;
         break;
+    case VIR_STORAGE_TYPE_NVME:
+        if (virDomainDiskSourceNVMeParse(node, ctxt, src) &lt; 0)
+            return -1;
+        break;
     case VIR_STORAGE_TYPE_NONE:
     case VIR_STORAGE_TYPE_LAST:
         virReportError(VIR_ERR_INTERNAL_ERROR,
@@ -23922,6 +24033,19 @@ virDomainDiskSourceFormatNetwork(virBufferPtr attrBuf,
 }
 
 
+static void
+virDomainDiskSourceNVMeFormat(virBufferPtr attrBuf,
+                              virBufferPtr childBuf,
+                              const virStorageSourceNVMeDef *nvme)
+{
+    virBufferAddLit(attrBuf, &quot; type='pci'&quot;);
+    virBufferAsprintf(attrBuf, &quot; managed='%s'&quot;,
+                      virTristateBoolTypeToString(nvme-&gt;managed));
+    virBufferAsprintf(attrBuf, &quot; namespace='%ld'&quot;, nvme-&gt;namespace);
+    virPCIDeviceAddressFormat(childBuf, nvme-&gt;pciAddr, false);
+}
+
+
 static int
 virDomainDiskSourceFormatPrivateData(virBufferPtr buf,
                                      virStorageSourcePtr src,
@@ -24008,6 +24132,11 @@ virDomainDiskSourceFormat(virBufferPtr buf,
 
         break;
 
+    case VIR_STORAGE_TYPE_NVME:
+        if (src-&gt;nvme)
+            virDomainDiskSourceNVMeFormat(&amp;attrBuf, &amp;childBuf, src-&gt;nvme);
+        break;
+
     case VIR_STORAGE_TYPE_NONE:
     case VIR_STORAGE_TYPE_LAST:
         virReportError(VIR_ERR_INTERNAL_ERROR,
diff --git a/src/libvirt_private.syms b/src/libvirt_private.syms
index 6cef8d20fe..350b638193 100644
--- a/src/libvirt_private.syms
+++ b/src/libvirt_private.syms
@@ -2994,6 +2994,7 @@ virStorageSourceNetworkAssignDefaultPorts;
 virStorageSourceNew;
 virStorageSourceNewFromBacking;
 virStorageSourceNewFromBackingAbsolute;
+virStorageSourceNVMeDefFree;
 virStorageSourceParseRBDColonString;
 virStorageSourcePoolDefFree;
 virStorageSourcePoolModeTypeFromString;
diff --git a/src/qemu/qemu_block.c b/src/qemu/qemu_block.c
index 0a6522577d..5eeb3757f1 100644
--- a/src/qemu/qemu_block.c
+++ b/src/qemu/qemu_block.c
@@ -1050,6 +1050,7 @@ qemuBlockStorageSourceGetBackendProps(virStorageSourcePtr src,
         break;
 
     case VIR_STORAGE_TYPE_VOLUME:
+    case VIR_STORAGE_TYPE_NVME:
     case VIR_STORAGE_TYPE_NONE:
     case VIR_STORAGE_TYPE_LAST:
         return NULL;
diff --git a/src/qemu/qemu_command.c b/src/qemu/qemu_command.c
index 688dc324c6..927641cf46 100644
--- a/src/qemu/qemu_command.c
+++ b/src/qemu/qemu_command.c
@@ -1184,6 +1184,7 @@ qemuGetDriveSourceString(virStorageSourcePtr src,
         break;
 
     case VIR_STORAGE_TYPE_VOLUME:
+    case VIR_STORAGE_TYPE_NVME:
     case VIR_STORAGE_TYPE_NONE:
     case VIR_STORAGE_TYPE_LAST:
         break;
diff --git a/src/qemu/qemu_driver.c b/src/qemu/qemu_driver.c
index a52b54b9d8..9bf12ea20d 100644
--- a/src/qemu/qemu_driver.c
+++ b/src/qemu/qemu_driver.c
@@ -14637,6 +14637,7 @@ qemuDomainSnapshotPrepareDiskExternalInactive(virDomainSnapshotDiskDefPtr snapdi
 
     case VIR_STORAGE_TYPE_DIR:
     case VIR_STORAGE_TYPE_VOLUME:
+    case VIR_STORAGE_TYPE_NVME:
     case VIR_STORAGE_TYPE_NONE:
     case VIR_STORAGE_TYPE_LAST:
         virReportError(VIR_ERR_INTERNAL_ERROR,
@@ -14653,6 +14654,7 @@ qemuDomainSnapshotPrepareDiskExternalInactive(virDomainSnapshotDiskDefPtr snapdi
     case VIR_STORAGE_TYPE_NETWORK:
     case VIR_STORAGE_TYPE_DIR:
     case VIR_STORAGE_TYPE_VOLUME:
+    case VIR_STORAGE_TYPE_NVME:
     case VIR_STORAGE_TYPE_NONE:
     case VIR_STORAGE_TYPE_LAST:
         virReportError(VIR_ERR_INTERNAL_ERROR,
@@ -14715,6 +14717,7 @@ qemuDomainSnapshotPrepareDiskExternalActive(virDomainSnapshotDiskDefPtr snapdisk
 
     case VIR_STORAGE_TYPE_DIR:
     case VIR_STORAGE_TYPE_VOLUME:
+    case VIR_STORAGE_TYPE_NVME:
     case VIR_STORAGE_TYPE_NONE:
     case VIR_STORAGE_TYPE_LAST:
         virReportError(VIR_ERR_INTERNAL_ERROR,
@@ -14837,6 +14840,7 @@ qemuDomainSnapshotPrepareDiskInternal(virDomainDiskDefPtr disk,
 
     case VIR_STORAGE_TYPE_DIR:
     case VIR_STORAGE_TYPE_VOLUME:
+    case VIR_STORAGE_TYPE_NVME:
     case VIR_STORAGE_TYPE_NONE:
     case VIR_STORAGE_TYPE_LAST:
         virReportError(VIR_ERR_INTERNAL_ERROR,
diff --git a/src/qemu/qemu_migration.c b/src/qemu/qemu_migration.c
index 2436f5051b..87adccab3d 100644
--- a/src/qemu/qemu_migration.c
+++ b/src/qemu/qemu_migration.c
@@ -227,6 +227,7 @@ qemuMigrationDstPrecreateDisk(virConnectPtr conn,
 
     case VIR_STORAGE_TYPE_BLOCK:
     case VIR_STORAGE_TYPE_DIR:
+    case VIR_STORAGE_TYPE_NVME:
     case VIR_STORAGE_TYPE_NONE:
     case VIR_STORAGE_TYPE_LAST:
         virReportError(VIR_ERR_INTERNAL_ERROR,
diff --git a/src/util/virstoragefile.c b/src/util/virstoragefile.c
index 269d0050fd..18aa33fe05 100644
--- a/src/util/virstoragefile.c
+++ b/src/util/virstoragefile.c
@@ -57,6 +57,7 @@ VIR_ENUM_IMPL(virStorage,
               &quot;dir&quot;,
               &quot;network&quot;,
               &quot;volume&quot;,
+              &quot;nvme&quot;,
 );
 
 VIR_ENUM_IMPL(virStorageFileFormat,
@@ -2114,6 +2115,48 @@ virStoragePRDefCopy(virStoragePRDefPtr src)
 }
 
 
+static virStorageSourceNVMeDefPtr
+virStorageSourceNVMeDefCopy(const virStorageSourceNVMeDef *src)
+{
+    VIR_AUTOPTR(virStorageSourceNVMeDef) ret = NULL;
+
+    if (VIR_ALLOC(ret) &lt; 0)
+        return NULL;
+
+    *ret = *src;
+    VIR_RETURN_PTR(ret);
+}
+
+
+static bool
+virStorageSourceNVMeDefIsEqual(const virStorageSourceNVMeDef *a,
+                               const virStorageSourceNVMeDef *b)
+{
+    if (!a &amp;&amp; !b)
+        return true;
+
+    if (!a || !b)
+        return false;
+
+    if (a-&gt;namespace != b-&gt;namespace ||
+        a-&gt;managed != b-&gt;managed ||
+        !virPCIDeviceAddressEqual(&amp;a-&gt;pciAddr, &amp;b-&gt;pciAddr))
+        return false;
+
+    return true;
+}
+
+
+void
+virStorageSourceNVMeDefFree(virStorageSourceNVMeDefPtr def)
+{
+    if (!def)
+        return;
+
+    VIR_FREE(def);
+}
+
+
 virSecurityDeviceLabelDefPtr
 virStorageSourceGetSecurityLabelDef(virStorageSourcePtr src,
                                     const char *model)
@@ -2323,6 +2366,10 @@ virStorageSourceCopy(const virStorageSource *src,
         !(def-&gt;pr = virStoragePRDefCopy(src-&gt;pr)))
         return NULL;
 
+    if (src-&gt;nvme &amp;&amp;
+        !(def-&gt;nvme = virStorageSourceNVMeDefCopy(src-&gt;nvme)))
+        return NULL;
+
     if (virStorageSourceInitiatorCopy(&amp;def-&gt;initiator, &amp;src-&gt;initiator))
         return NULL;
 
@@ -2376,6 +2423,10 @@ virStorageSourceIsSameLocation(virStorageSourcePtr a,
         }
     }
 
+    if (a-&gt;type == VIR_STORAGE_TYPE_NVME &amp;&amp;
+        !virStorageSourceNVMeDefIsEqual(a-&gt;nvme, b-&gt;nvme))
+        return false;
+
     return true;
 }
 
@@ -2463,6 +2514,7 @@ virStorageSourceIsLocalStorage(const virStorageSource *src)
 
     case VIR_STORAGE_TYPE_NETWORK:
     case VIR_STORAGE_TYPE_VOLUME:
+    case VIR_STORAGE_TYPE_NVME:
     case VIR_STORAGE_TYPE_LAST:
     case VIR_STORAGE_TYPE_NONE:
         return false;
@@ -2493,6 +2545,10 @@ virStorageSourceIsEmpty(virStorageSourcePtr src)
         src-&gt;protocol == VIR_STORAGE_NET_PROTOCOL_NONE)
         return true;
 
+    if (src-&gt;type == VIR_STORAGE_TYPE_NVME &amp;&amp;
+        !src-&gt;nvme)
+        return true;
+
     return false;
 }
 
@@ -2548,6 +2604,7 @@ virStorageSourceClear(virStorageSourcePtr def)
     VIR_FREE(def-&gt;compat);
     virStorageEncryptionFree(def-&gt;encryption);
     virStoragePRDefFree(def-&gt;pr);
+    virStorageSourceNVMeDefFree(def-&gt;nvme);
     virStorageSourceSeclabelsClear(def);
     virStoragePermsFree(def-&gt;perms);
     VIR_FREE(def-&gt;timestamps);
@@ -3776,6 +3833,7 @@ virStorageSourceUpdatePhysicalSize(virStorageSourcePtr src,
 
     /* We shouldn't get VOLUME, but the switch requires all cases */
     case VIR_STORAGE_TYPE_VOLUME:
+    case VIR_STORAGE_TYPE_NVME:
     case VIR_STORAGE_TYPE_NONE:
     case VIR_STORAGE_TYPE_LAST:
         virReportError(VIR_ERR_INTERNAL_ERROR,
@@ -4242,6 +4300,7 @@ virStorageSourceIsRelative(virStorageSourcePtr src)
 
     case VIR_STORAGE_TYPE_NETWORK:
     case VIR_STORAGE_TYPE_VOLUME:
+    case VIR_STORAGE_TYPE_NVME:
     case VIR_STORAGE_TYPE_NONE:
     case VIR_STORAGE_TYPE_LAST:
         return false;
diff --git a/src/util/virstoragefile.h b/src/util/virstoragefile.h
index 38ba901858..a1294ea608 100644
--- a/src/util/virstoragefile.h
+++ b/src/util/virstoragefile.h
@@ -31,6 +31,7 @@
 #include &quot;virsecret.h&quot;
 #include &quot;virautoclean.h&quot;
 #include &quot;virenum.h&quot;
+#include &quot;virpci.h&quot;
 
 /* Minimum header size required to probe all known formats with
  * virStorageFileProbeFormat, or obtain metadata from a known format.
@@ -52,6 +53,7 @@ typedef enum {
     VIR_STORAGE_TYPE_DIR,
     VIR_STORAGE_TYPE_NETWORK,
     VIR_STORAGE_TYPE_VOLUME,
+    VIR_STORAGE_TYPE_NVME,
 
     VIR_STORAGE_TYPE_LAST
 } virStorageType;
@@ -231,6 +233,14 @@ struct _virStorageSourceInitiatorDef {
     char *iqn; /* Initiator IQN */
 };
 
+typedef struct _virStorageSourceNVMeDef virStorageSourceNVMeDef;
+typedef virStorageSourceNVMeDef *virStorageSourceNVMeDefPtr;
+struct _virStorageSourceNVMeDef {
+    unsigned long namespace;
+    int managed; /* enum virTristateBool */
+    virPCIDeviceAddress pciAddr;
+};
+
 typedef struct _virStorageDriverData virStorageDriverData;
 typedef virStorageDriverData *virStorageDriverDataPtr;
 
@@ -262,6 +272,8 @@ struct _virStorageSource {
     bool encryptionInherited;
     virStoragePRDefPtr pr;
 
+    virStorageSourceNVMeDefPtr nvme; /* type == VIR_STORAGE_TYPE_NVME */
+
     virStorageSourceInitiatorDef initiator;
 
     virObjectPtr privateData;
@@ -416,6 +428,9 @@ bool virStoragePRDefIsManaged(virStoragePRDefPtr prd);
 bool
 virStorageSourceChainHasManagedPR(virStorageSourcePtr src);
 
+void virStorageSourceNVMeDefFree(virStorageSourceNVMeDefPtr def);
+VIR_DEFINE_AUTOPTR_FUNC(virStorageSourceNVMeDef, virStorageSourceNVMeDefFree);
+
 virSecurityDeviceLabelDefPtr
 virStorageSourceGetSecurityLabelDef(virStorageSourcePtr src,
                                     const char *model);
diff --git a/src/xenconfig/xen_xl.c b/src/xenconfig/xen_xl.c
index ca094d30c2..fa15e4e2a5 100644
--- a/src/xenconfig/xen_xl.c
+++ b/src/xenconfig/xen_xl.c
@@ -1662,6 +1662,7 @@ xenFormatXLDiskSrc(virStorageSourcePtr src, char **srcstr)
         break;
 
     case VIR_STORAGE_TYPE_VOLUME:
+    case VIR_STORAGE_TYPE_NVME:
     case VIR_STORAGE_TYPE_NONE:
     case VIR_STORAGE_TYPE_LAST:
         break;
diff --git a/tests/qemuxml2argvdata/disk-nvme.xml b/tests/qemuxml2argvdata/disk-nvme.xml
index 0b3dbad4eb..fe956d5ab6 100644
--- a/tests/qemuxml2argvdata/disk-nvme.xml
+++ b/tests/qemuxml2argvdata/disk-nvme.xml
@@ -20,6 +20,7 @@
         &lt;address domain='0x0000' bus='0x01' slot='0x00' function='0x0'/&gt;
       &lt;/source&gt;
       &lt;target dev='vda' bus='virtio'/&gt;
+      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/&gt;
     &lt;/disk&gt;
     &lt;disk type='nvme' device='disk'&gt;
       &lt;driver name='qemu' type='raw'/&gt;
@@ -27,6 +28,7 @@
         &lt;address domain='0x0000' bus='0x01' slot='0x00' function='0x0'/&gt;
       &lt;/source&gt;
       &lt;target dev='vdb' bus='virtio'/&gt;
+      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/&gt;
     &lt;/disk&gt;
     &lt;disk type='nvme' device='disk'&gt;
       &lt;driver name='qemu' type='raw'/&gt;
@@ -34,6 +36,7 @@
         &lt;address domain='0x0000' bus='0x02' slot='0x00' function='0x0'/&gt;
       &lt;/source&gt;
       &lt;target dev='vdc' bus='virtio'/&gt;
+      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x06' function='0x0'/&gt;
     &lt;/disk&gt;
     &lt;disk type='nvme' device='disk'&gt;
       &lt;driver name='qemu' type='raw'/&gt;
@@ -44,10 +47,15 @@
         &lt;/encryption&gt;
       &lt;/source&gt;
       &lt;target dev='vdd' bus='virtio'/&gt;
+      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x07' function='0x0'/&gt;
     &lt;/disk&gt;
-    &lt;controller type='usb' index='0'/&gt;
+    &lt;controller type='usb' index='0'&gt;
+      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x2'/&gt;
+    &lt;/controller&gt;
     &lt;controller type='pci' index='0' model='pci-root'/&gt;
-    &lt;controller type='scsi' index='0' model='virtio-scsi'/&gt;
+    &lt;controller type='scsi' index='0' model='virtio-scsi'&gt;
+      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/&gt;
+    &lt;/controller&gt;
     &lt;input type='mouse' bus='ps2'/&gt;
     &lt;input type='keyboard' bus='ps2'/&gt;
     &lt;memballoon model='none'/&gt;
diff --git a/tests/qemuxml2xmloutdata/disk-nvme.xml b/tests/qemuxml2xmloutdata/disk-nvme.xml
new file mode 120000
index 0000000000..ea9eb267ac
--- /dev/null
+++ b/tests/qemuxml2xmloutdata/disk-nvme.xml
@@ -0,0 +1 @@
+../qemuxml2argvdata/disk-nvme.xml
\ No newline at end of file
diff --git a/tests/qemuxml2xmltest.c b/tests/qemuxml2xmltest.c
index 6d808e172f..c9f3a8dbfa 100644
--- a/tests/qemuxml2xmltest.c
+++ b/tests/qemuxml2xmltest.c
@@ -336,6 +336,7 @@ mymain(void)
     DO_TEST(&quot;disk-network-sheepdog&quot;, NONE);
     DO_TEST(&quot;disk-network-vxhs&quot;, NONE);
     DO_TEST(&quot;disk-network-tlsx509&quot;, NONE);
+    DO_TEST(&quot;disk-nvme&quot;, QEMU_CAPS_VIRTIO_SCSI);
     DO_TEST(&quot;disk-scsi&quot;, QEMU_CAPS_SCSI_LSI, QEMU_CAPS_SCSI_MEGASAS,
             QEMU_CAPS_SCSI_MPTSAS1068, QEMU_CAPS_SCSI_DISK_WWN);
     DO_TEST(&quot;disk-virtio-scsi-reservations&quot;,
-- 
2.21.0

--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187170.html">[PATCH v1 06/31] virPCIDeviceAddressEqual: Fix const	correctness</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187172.html">[PATCH v1 08/31] virpci: Introduce virPCIDeviceAddressCopy</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187467.html">Re:  [PATCH v1 06/31] virPCIDeviceAddressEqual: Fix const correctness</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187199.html">Re:  [PATCH v1 11/31] conf: Format and parse NVMe type disk</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187171"><strong>Date</strong></a></li>
<li><a href="index.html#187171"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

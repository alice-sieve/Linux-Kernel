<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH 3/4] qemu: Refactor variables for extracting flags	in qemuDomainBlockCopyCommon -->
<!--X-From-R13: Brgre Yerzcn &#60;cxerzcnNerqung.pbz> -->
<!--X-Date: Thu, 11 Jul 2019 07:56:20 &#45;0700 -->
<!--X-Message-Id: e4eafd177b5921803bfbcdc26cae96c9eb4e3d0d.1562856896.git.pkrempa@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: cover.1562856896.git.pkrempa@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; [PATCH 3/4] qemu: Refactor variables for extracting flags	in qemuDomainBlockCopyCommon</title>
<meta name="description" content="libvirt: [PATCH 3/4] qemu: Refactor variables for extracting flags	in qemuDomainBlockCopyCommon">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>[PATCH 3/4] qemu: Refactor variables for extracting flags	in qemuDomainBlockCopyCommon</h1>
[<a href="msg187157.html">Date Prev</a>][<a href="msg187159.html">Date Next</a>][<a href="msg187157.html">Thread Prev</a>][<a href="msg187159.html">Thread Next</a>][<a href="maillist.html#187158">Date Index</a>][<a href="index.html#187158">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH 3/4] qemu: Refactor variables for extracting flags	in qemuDomainBlockCopyCommon</li>
<li><em>From</em>: Peter Krempa &lt;pkrempa@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 11 Jul 2019 16:56:04 +0200</li>
<li><em>Cc</em>: Peter Krempa &lt;pkrempa@xxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187157.html">cover.1562856896.git.pkrempa@redhat.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187157.html">cover.1562856896.git.pkrempa@redhat.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Add separate booleans for extracting VIR_DOMAIN_BLOCK_COPY_REUSE_EXT and
VIR_DOMAIN_BLOCK_COPY_SHALLOW from '@flags' and also change 'reuse' into
'existing'.

qemuMonitorDriveMirror requires the unmodified state of the flags to
pass to qemu and also we use the value a few times internally. Extract
it separately now.

The 'reuse' flag did not indicate reusing of the file as much as the
fact that the storage is existing and thus should not be created, so
modify the name to reflect this.

Signed-off-by: Peter Krempa &lt;pkrempa@xxxxxxxxxx&gt;
---
 src/qemu/qemu_driver.c | 20 ++++++++++----------
 1 file changed, 10 insertions(+), 10 deletions(-)

diff --git a/src/qemu/qemu_driver.c b/src/qemu/qemu_driver.c
index 140896f329..1955e871ec 100644
--- a/src/qemu/qemu_driver.c
+++ b/src/qemu/qemu_driver.c
@@ -17507,7 +17507,9 @@ qemuDomainBlockCopyCommon(virDomainObjPtr vm,
     bool need_unlink = false;
     VIR_AUTOUNREF(virQEMUDriverConfigPtr) cfg = virQEMUDriverGetConfig(driver);
     const char *format = NULL;
-    bool reuse = !!(flags &amp; VIR_DOMAIN_BLOCK_COPY_REUSE_EXT);
+    bool mirror_reuse = !!(flags &amp; VIR_DOMAIN_BLOCK_COPY_REUSE_EXT);
+    bool mirror_shallow = !!(flags &amp; VIR_DOMAIN_BLOCK_COPY_SHALLOW);
+    bool existing = mirror_reuse;
     qemuBlockJobDataPtr job = NULL;
     VIR_AUTOUNREF(virStorageSourcePtr) mirror = mirrorsrc;
     bool blockdev = virQEMUCapsGet(priv-&gt;qemuCaps, QEMU_CAPS_BLOCKDEV);
@@ -17571,8 +17573,7 @@ qemuDomainBlockCopyCommon(virDomainObjPtr vm,

     /* unless the user provides a pre-created file, shallow copy into a raw
      * file is not possible */
-    if ((flags &amp; VIR_DOMAIN_BLOCK_COPY_SHALLOW) &amp;&amp; !reuse &amp;&amp;
-        mirror-&gt;format == VIR_STORAGE_FILE_RAW) {
+    if (mirror_shallow &amp;&amp; !existing &amp;&amp; mirror-&gt;format == VIR_STORAGE_FILE_RAW) {
         virReportError(VIR_ERR_CONFIG_UNSUPPORTED,
                        _(&quot;shallow copy of disk '%s' into a raw file &quot;
                          &quot;is not possible&quot;),
@@ -17591,11 +17592,11 @@ qemuDomainBlockCopyCommon(virDomainObjPtr vm,
     if (qemuDomainStorageFileInit(driver, vm, mirror, NULL) &lt; 0)
         goto endjob;

-    if (qemuDomainBlockCopyValidateMirror(mirror, disk-&gt;dst, &amp;reuse) &lt; 0)
+    if (qemuDomainBlockCopyValidateMirror(mirror, disk-&gt;dst, &amp;existing) &lt; 0)
         goto endjob;

     if (!mirror-&gt;format) {
-        if (!(flags &amp; VIR_DOMAIN_BLOCK_COPY_REUSE_EXT)) {
+        if (!mirror_reuse) {
             mirror-&gt;format = disk-&gt;src-&gt;format;
         } else {
             /* If the user passed the REUSE_EXT flag, then either they
@@ -17618,7 +17619,7 @@ qemuDomainBlockCopyCommon(virDomainObjPtr vm,
     }

     /* pre-create the image file */
-    if (!reuse) {
+    if (!existing) {
         if (virStorageFileCreate(mirror) &lt; 0) {
             virReportSystemError(errno, &quot;%s&quot;, _(&quot;failed to create copy target&quot;));
             goto endjob;
@@ -17636,7 +17637,7 @@ qemuDomainBlockCopyCommon(virDomainObjPtr vm,

     /* If reusing an external image that includes a backing file but the user
      * did not enumerate the chain in the XML we need to detect the chain */
-    if (flags &amp; VIR_DOMAIN_BLOCK_COPY_REUSE_EXT &amp;&amp;
+    if (mirror_reuse &amp;&amp;
         mirror-&gt;format &gt;= VIR_STORAGE_FILE_BACKING &amp;&amp;
         mirror-&gt;backingStore == NULL &amp;&amp;
         qemuDomainDetermineDiskChain(driver, vm, disk, mirror, true) &lt; 0)
@@ -17653,11 +17654,10 @@ qemuDomainBlockCopyCommon(virDomainObjPtr vm,
     /* Actually start the mirroring */
     qemuDomainObjEnterMonitor(driver, vm);
     /* qemuMonitorDriveMirror needs to honor the REUSE_EXT flag as specified
-     * by the user regardless of how @reuse was modified */
+     * by the user */
     ret = qemuMonitorDriveMirror(priv-&gt;mon, device, mirror-&gt;path, format,
                                  bandwidth, granularity, buf_size,
-                                 flags &amp; VIR_DOMAIN_BLOCK_COPY_SHALLOW,
-                                 flags &amp; VIR_DOMAIN_BLOCK_COPY_REUSE_EXT);
+                                 mirror_shallow, mirror_reuse);
     virDomainAuditDisk(vm, NULL, mirror, &quot;mirror&quot;, ret &gt;= 0);
     if (qemuDomainObjExitMonitor(driver, vm) &lt; 0)
         ret = -1;
-- 
2.21.0

--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187157.html">[PATCH 0/4] qemu: blockdev-related cleanups and refactors	(blockdev-add saga)</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187159.html">[PATCH 4/4] qemu: block: Split up	qemuBlockStorageSourceAttachApply</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187157.html">[PATCH 0/4] qemu: blockdev-related cleanups and refactors	(blockdev-add saga)</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187159.html">[PATCH 4/4] qemu: block: Split up	qemuBlockStorageSourceAttachApply</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187158"><strong>Date</strong></a></li>
<li><a href="index.html#187158"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

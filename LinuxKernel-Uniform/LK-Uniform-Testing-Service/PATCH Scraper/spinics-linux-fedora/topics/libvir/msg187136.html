<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH v2 02/19] util: add APIs for facilitating use of	systemd activation FDs -->
<!--X-From-R13: =?GFT&#45;8?d?Rnavry=20B=2S=20Preenat=Q3=O9?= &#60;oreenatrNerqung.pbz> -->
<!--X-Date: Thu, 11 Jul 2019 07:07:55 &#45;0700 -->
<!--X-Message-Id: 20190711140742.31029&#45;3&#45;berrange@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190711140742.31029&#45;1&#45;berrange@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; [PATCH v2 02/19] util: add APIs for facilitating use of	systemd activation FDs</title>
<meta name="description" content="libvirt: [PATCH v2 02/19] util: add APIs for facilitating use of	systemd activation FDs">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>[PATCH v2 02/19] util: add APIs for facilitating use of	systemd activation FDs</h1>
[<a href="msg187135.html">Date Prev</a>][<a href="msg187137.html">Date Next</a>][<a href="msg187135.html">Thread Prev</a>][<a href="msg187137.html">Thread Next</a>][<a href="maillist.html#187136">Date Index</a>][<a href="index.html#187136">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH v2 02/19] util: add APIs for facilitating use of	systemd activation FDs</li>
<li><em>From</em>: Daniel P. Berrang&#xE9; &lt;berrange@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 11 Jul 2019 15:07:25 +0100</li>
<li><em>Cc</em>: J&#xE1;n Tomko &lt;jtomko@xxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187133.html">20190711140742.31029-1-berrange@redhat.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187133.html">20190711140742.31029-1-berrange@redhat.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>When receiving multiple FDs from systemd during service activation it is
neccessary to identify which purpose each FD is used for. While this
could be inferred by looking for the specific IP ports or UNIX socket
paths, this requires the systemd config to always match what is expected
by the code. Using systemd FD names we can remove this restriction and
simply identify FDs based on an arbitrary name.

The FD names are passed by systemd in the LISTEN_FDNAMES env variable
which is populated with the socket unit file names, unless overriden
by using the FileDescriptorName setting.

This is supported since the system 227 release and unfortunately RHEL7
lacks this version. Thus the code has some back compat support whereby
we look at the TCP ports or the UNIX socket paths to identify what
socket maps to which name. This back compat code is written such that
is it easly deleted when we are able to mandate newer systemd.

Reviewed-by: J&#xE1;n Tomko &lt;jtomko@xxxxxxxxxx&gt;
Signed-off-by: Daniel P. Berrang&#xE9; &lt;berrange@xxxxxxxxxx&gt;
---
 src/libvirt_private.syms |   5 +
 src/util/virsystemd.c    | 362 +++++++++++++++++++++++++++++++++++++++
 src/util/virsystemd.h    |  32 ++++
 tests/virsystemdtest.c   | 169 ++++++++++++++++++
 4 files changed, 568 insertions(+)

diff --git a/src/libvirt_private.syms b/src/libvirt_private.syms
index 02d5b7acce..a19ba1d798 100644
--- a/src/libvirt_private.syms
+++ b/src/libvirt_private.syms
@@ -3086,10 +3086,15 @@ virSysinfoReadS390;
 
 
 # util/virsystemd.h
+virSystemdActivationClaimFDs;
+virSystemdActivationComplete;
+virSystemdActivationFree;
+virSystemdActivationHasName;
 virSystemdCanHibernate;
 virSystemdCanHybridSleep;
 virSystemdCanSuspend;
 virSystemdCreateMachine;
+virSystemdGetActivation;
 virSystemdGetMachineNameByPID;
 virSystemdHasMachinedResetCachedValue;
 virSystemdMakeScopeName;
diff --git a/src/util/virsystemd.c b/src/util/virsystemd.c
index 3f03e3bd63..ae8401343d 100644
--- a/src/util/virsystemd.c
+++ b/src/util/virsystemd.c
@@ -39,6 +39,8 @@
 #include &quot;virlog.h&quot;
 #include &quot;virerror.h&quot;
 #include &quot;virfile.h&quot;
+#include &quot;virhash.h&quot;
+#include &quot;virsocketaddr.h&quot;
 
 #define VIR_FROM_THIS VIR_FROM_SYSTEMD
 
@@ -48,6 +50,18 @@ VIR_LOG_INIT(&quot;util.systemd&quot;);
 # define MSG_NOSIGNAL 0
 #endif
 
+struct _virSystemdActivation {
+    virHashTablePtr fds;
+};
+
+typedef struct _virSystemdActivationEntry virSystemdActivationEntry;
+typedef virSystemdActivationEntry *virSystemdActivationEntryPtr;
+
+struct _virSystemdActivationEntry {
+    int *fds;
+    size_t nfds;
+};
+
 static void virSystemdEscapeName(virBufferPtr buf,
                                  const char *name)
 {
@@ -561,3 +575,351 @@ int virSystemdCanHybridSleep(bool *result)
 {
     return virSystemdPMSupportTarget(&quot;CanHybridSleep&quot;, result);
 }
+
+
+static void
+virSystemdActivationEntryFree(void *data, const void *name)
+{
+    virSystemdActivationEntryPtr ent = data;
+    size_t i;
+
+    VIR_DEBUG(&quot;Closing activation FDs for %s&quot;, (const char *)name);
+    for (i = 0; i &lt; ent-&gt;nfds; i++) {
+        VIR_DEBUG(&quot;Closing activation FD %d&quot;, ent-&gt;fds[i]);
+        VIR_FORCE_CLOSE(ent-&gt;fds[i]);
+    }
+
+    VIR_FREE(ent-&gt;fds);
+    VIR_FREE(ent);
+}
+
+
+static int
+virSystemdActivationAddFD(virSystemdActivationPtr act,
+                          const char *name,
+                          int fd)
+{
+    virSystemdActivationEntryPtr ent = virHashLookup(act-&gt;fds, name);
+
+    if (!ent) {
+        if (VIR_ALLOC(ent) &lt; 0)
+            return -1;
+
+        if (VIR_ALLOC_N(ent-&gt;fds, 1) &lt; 0) {
+            virSystemdActivationEntryFree(ent, name);
+            return -1;
+        }
+
+        ent-&gt;fds[ent-&gt;nfds++] = fd;
+
+        VIR_DEBUG(&quot;Record first FD %d with name %s&quot;, fd, name);
+        if (virHashAddEntry(act-&gt;fds, name, ent) &lt; 0) {
+            virSystemdActivationEntryFree(ent, name);
+            return -1;
+        }
+
+        return 0;
+    }
+
+    if (VIR_EXPAND_N(ent-&gt;fds, ent-&gt;nfds, 1) &lt; 0)
+        return -1;
+
+    VIR_DEBUG(&quot;Record extra FD %d with name %s&quot;, fd, name);
+    ent-&gt;fds[ent-&gt;nfds - 1] = fd;
+
+    return 0;
+}
+
+
+static int
+virSystemdActivationInitFromNames(virSystemdActivationPtr act,
+                                  int nfds,
+                                  const char *fdnames)
+{
+    VIR_AUTOSTRINGLIST fdnamelistptr = NULL;
+    char **fdnamelist;
+    size_t nfdnames;
+    size_t i;
+    int nextfd = STDERR_FILENO + 1;
+
+    VIR_DEBUG(&quot;FD names %s&quot;, fdnames);
+
+    if (!(fdnamelistptr = virStringSplitCount(fdnames, &quot;:&quot;, 0, &amp;nfdnames)))
+        goto error;
+
+    if (nfdnames != nfds) {
+        virReportError(VIR_ERR_INTERNAL_ERROR,
+                       _(&quot;Expecting %d FD names but got %zu&quot;),
+                       nfds, nfdnames);
+        goto error;
+    }
+
+    fdnamelist = fdnamelistptr;
+    while (nfds) {
+        if (virSystemdActivationAddFD(act, *fdnamelist, nextfd) &lt; 0)
+            goto error;
+
+        fdnamelist++;
+        nextfd++;
+        nfds--;
+    }
+
+    return 0;
+
+ error:
+    for (i = 0; i &lt; nfds; i++) {
+        int fd = nextfd + i;
+        VIR_FORCE_CLOSE(fd);
+    }
+    return -1;
+}
+
+
+/*
+ * Back compat for systemd &lt; v227 which lacks LISTEN_FDNAMES.
+ * Delete when min systemd is increased ie RHEL7 dropped
+ */
+static int
+virSystemdActivationInitFromMap(virSystemdActivationPtr act,
+                                int nfds,
+                                virSystemdActivationMap *map,
+                                size_t nmap)
+{
+    int nextfd = STDERR_FILENO + 1;
+    size_t i;
+
+    while (nfds) {
+        virSocketAddr addr;
+        const char *name = NULL;
+
+        memset(&amp;addr, 0, sizeof(addr));
+
+        addr.len = sizeof(addr.data);
+        if (getsockname(nextfd, &amp;addr.data.sa, &amp;addr.len) &lt; 0) {
+            virReportSystemError(errno, &quot;%s&quot;, _(&quot;Unable to get local socket name&quot;));
+            goto error;
+        }
+
+        for (i = 0; i &lt; nmap &amp;&amp; !name; i++) {
+            if (map[i].name == NULL)
+                continue;
+
+            if (addr.data.sa.sa_family == AF_INET) {
+                if (map[i].family == AF_INET &amp;&amp;
+                    addr.data.inet4.sin_port == htons(map[i].port))
+                    name = map[i].name;
+            } else if (addr.data.sa.sa_family == AF_INET6) {
+                /* NB use of AF_INET here is correct. The &quot;map&quot; struct
+                 * only refers to AF_INET. The socket may be AF_INET
+                 * or AF_INET6
+                 */
+                if (map[i].family == AF_INET &amp;&amp;
+                    addr.data.inet6.sin6_port == htons(map[i].port))
+                    name = map[i].name;
+#ifndef WIN32
+            } else if (addr.data.sa.sa_family == AF_UNIX) {
+                if (map[i].family == AF_UNIX &amp;&amp;
+                    STREQLEN(map[i].path,
+                             addr.data.un.sun_path,
+                             sizeof(addr.data.un.sun_path)))
+                    name = map[i].name;
+#endif
+            } else {
+                virReportError(VIR_ERR_INTERNAL_ERROR,
+                               _(&quot;Unexpected socket family %d&quot;),
+                               addr.data.sa.sa_family);
+                goto error;
+            }
+        }
+
+        if (!name) {
+            virReportError(VIR_ERR_INTERNAL_ERROR,
+                           _(&quot;Cannot find name for FD %d socket family %d&quot;),
+                           nextfd, addr.data.sa.sa_family);
+            goto error;
+        }
+
+        if (virSystemdActivationAddFD(act, name, nextfd) &lt; 0)
+            goto error;
+
+        nfds--;
+        nextfd++;
+    }
+
+    return 0;
+
+ error:
+    for (i = 0; i &lt; nfds; i++) {
+        int fd = nextfd + i;
+        VIR_FORCE_CLOSE(fd);
+    }
+    return -1;
+}
+
+
+static virSystemdActivationPtr
+virSystemdActivationNew(virSystemdActivationMap *map,
+                        size_t nmap,
+                        int nfds)
+{
+    virSystemdActivationPtr act;
+    const char *fdnames;
+
+    VIR_DEBUG(&quot;Activated with %d FDs&quot;, nfds);
+    if (VIR_ALLOC(act) &lt; 0)
+        return NULL;
+
+    if (!(act-&gt;fds = virHashCreate(10, virSystemdActivationEntryFree)))
+        goto error;
+
+    fdnames = virGetEnvAllowSUID(&quot;LISTEN_FDNAMES&quot;);
+    if (fdnames) {
+        if (virSystemdActivationInitFromNames(act, nfds, fdnames) &lt; 0)
+            goto error;
+    } else {
+        if (virSystemdActivationInitFromMap(act, nfds, map, nmap) &lt; 0)
+            goto error;
+    }
+
+    VIR_DEBUG(&quot;Created activation object for %d FDs&quot;, nfds);
+    return act;
+
+ error:
+    virSystemdActivationFree(&amp;act);
+    return NULL;
+}
+
+
+/**
+ * virSystemdGetActivation:
+ * @map: mapping of socket addresses to names
+ * @nmap: number of entries in @map
+ * @act: filled with allocated activation object
+ *
+ * Acquire an object for handling systemd activation.
+ * If no activation FDs have been provided the returned object
+ * will be NULL, indicating normal sevice setup can be performed
+ * If the returned object is non-NULL then at least one file
+ * descriptor will be present. No normal service setup should
+ * be performed.
+ *
+ * Returns: 0 on success, -1 on failure
+ */
+int
+virSystemdGetActivation(virSystemdActivationMap *map,
+                        size_t nmap,
+                        virSystemdActivationPtr *act)
+{
+    int nfds = 0;
+
+    if ((nfds = virGetListenFDs()) &lt; 0)
+        return -1;
+
+    if (nfds == 0) {
+        VIR_DEBUG(&quot;No activation FDs present&quot;);
+        *act = NULL;
+        return 0;
+    }
+
+    *act = virSystemdActivationNew(map, nmap, nfds);
+    return 0;
+}
+
+
+/**
+ * virSystemdActivationHasName:
+ * @act: the activation object
+ * @name: the file descriptor name
+ *
+ * Check whether there is a file descriptor present
+ * for the requested name.
+ *
+ * Returns: true if a FD is present, false otherwise
+ */
+bool
+virSystemdActivationHasName(virSystemdActivationPtr act,
+                            const char *name)
+{
+    return virHashLookup(act-&gt;fds, name) != NULL;
+}
+
+
+/**
+ * virSystemdActivationComplete:
+ * @act: the activation object
+ *
+ * Indicate that processing of activation has been
+ * completed. All provided file descriptors should
+ * have been claimed. If any are unclaimed then
+ * an error will be reported
+ *
+ * Returns: 0 on success, -1 if some FDs are unclaimed
+ */
+int
+virSystemdActivationComplete(virSystemdActivationPtr act)
+{
+    if (virHashSize(act-&gt;fds) != 0) {
+        virReportError(VIR_ERR_INTERNAL_ERROR, &quot;%s&quot;,
+                       _(&quot;Some activation file descriptors are unclaimed&quot;));
+        return -1;
+    }
+
+    return 0;
+}
+
+
+/**
+ * virSystemdActivationClaimFDs:
+ * @act: the activation object
+ * @name: the file descriptor name
+ * @fds: to be filled with claimed FDs
+ * @nfds: to be filled with number of FDs in @fds
+ *
+ * Claims the file descriptors associated with
+ * @name.
+ *
+ * The caller is responsible for closing all
+ * returned file descriptors when they are no
+ * longer required. The caller must also free
+ * the array memory in @fds.
+ */
+void
+virSystemdActivationClaimFDs(virSystemdActivationPtr act,
+                             const char *name,
+                             int **fds,
+                             size_t *nfds)
+{
+    virSystemdActivationEntryPtr ent = virHashSteal(act-&gt;fds, name);
+
+    if (!ent) {
+        *fds = NULL;
+        *nfds = 0;
+        VIR_DEBUG(&quot;No FD with name %s&quot;, name);
+        return;
+    }
+
+    VIR_DEBUG(&quot;Found %zu FDs with name %s&quot;, ent-&gt;nfds, name);
+    *fds = ent-&gt;fds;
+    *nfds = ent-&gt;nfds;
+
+    VIR_FREE(ent);
+}
+
+
+/**
+ * virSystemdActivationFree:
+ * @act: the activation object
+ *
+ * Free memory and close unclaimed file descriptors
+ * associated with the activation object
+ */
+void
+virSystemdActivationFree(virSystemdActivationPtr *act)
+{
+    if (!*act)
+        return;
+
+    virHashFree((*act)-&gt;fds);
+
+    VIR_FREE(*act);
+}
diff --git a/src/util/virsystemd.h b/src/util/virsystemd.h
index db4ecbff60..5d56c78835 100644
--- a/src/util/virsystemd.h
+++ b/src/util/virsystemd.h
@@ -23,6 +23,20 @@
 
 #include &quot;internal.h&quot;
 
+typedef struct _virSystemdActivation virSystemdActivation;
+typedef virSystemdActivation *virSystemdActivationPtr;
+
+/*
+ * Back compat for systemd &lt; v227 which lacks LISTEN_FDNAMES.
+ * Delete when min systemd is increased ie RHEL7 dropped
+ */
+typedef struct _virSystemdActivationMap {
+    const char *name;
+    int family;
+    int port; /* if family == AF_INET/AF_INET6 */
+    const char *path; /* if family == AF_UNIX */
+} virSystemdActivationMap;
+
 char *virSystemdMakeScopeName(const char *name,
                               const char *drivername,
                               bool legacy_behaviour);
@@ -49,3 +63,21 @@ int virSystemdCanHibernate(bool *result);
 int virSystemdCanHybridSleep(bool *result);
 
 char *virSystemdGetMachineNameByPID(pid_t pid);
+
+int virSystemdGetActivation(virSystemdActivationMap *map,
+                            size_t nmap,
+                            virSystemdActivationPtr *act);
+
+bool virSystemdActivationHasName(virSystemdActivationPtr act,
+                                 const char *name);
+
+int virSystemdActivationComplete(virSystemdActivationPtr act);
+
+void virSystemdActivationClaimFDs(virSystemdActivationPtr act,
+                                  const char *name,
+                                  int **fds,
+                                  size_t *nfds);
+
+void virSystemdActivationFree(virSystemdActivationPtr *act);
+
+#define virSystemdActivationAutoPtrFree virSystemdActivationFree
diff --git a/tests/virsystemdtest.c b/tests/virsystemdtest.c
index 82c02decd1..586c512fca 100644
--- a/tests/virsystemdtest.c
+++ b/tests/virsystemdtest.c
@@ -31,6 +31,8 @@
 # include &quot;virdbus.h&quot;
 # include &quot;virlog.h&quot;
 # include &quot;virmock.h&quot;
+# include &quot;rpc/virnetsocket.h&quot;
+# include &quot;intprops.h&quot;
 # define VIR_FROM_THIS VIR_FROM_NONE
 
 VIR_LOG_INIT(&quot;tests.systemdtest&quot;);
@@ -507,6 +509,166 @@ static int testPMSupportSystemdNotRunning(const void *opaque)
     return 0;
 }
 
+
+static int
+testActivationCreateFDs(virNetSocketPtr *sockUNIX,
+                        virNetSocketPtr **sockIP,
+                        size_t *nsockIP)
+{
+    *sockUNIX = NULL;
+    *sockIP = NULL;
+    *nsockIP = 0;
+
+    if (virNetSocketNewListenUNIX(&quot;virsystemdtest.sock&quot;,
+                                  0777,
+                                  0,
+                                  0,
+                                  sockUNIX) &lt; 0)
+        return -1;
+
+    if (virNetSocketNewListenTCP(&quot;localhost&quot;,
+                                 NULL,
+                                 AF_UNSPEC,
+                                 sockIP,
+                                 nsockIP) &lt; 0) {
+        virObjectUnref(*sockUNIX);
+        return -1;
+    }
+
+    return 0;
+}
+
+
+static int
+testActivation(bool useNames)
+{
+    virNetSocketPtr sockUNIX;
+    virNetSocketPtr *sockIP;
+    size_t nsockIP;
+    int ret = -1;
+    size_t i;
+    const char *names2 = &quot;demo-unix.socket:demo-ip.socket&quot;;
+    const char *names3 = &quot;demo-unix.socket:demo-ip.socket:demo-ip.socket&quot;;
+    char nfdstr[INT_BUFSIZE_BOUND(size_t)];
+    char pidstr[INT_BUFSIZE_BOUND(pid_t)];
+    virSystemdActivationMap map[2];
+    int *fds = NULL;
+    size_t nfds = 0;
+    VIR_AUTOPTR(virSystemdActivation) act = NULL;
+
+    if (testActivationCreateFDs(&amp;sockUNIX, &amp;sockIP, &amp;nsockIP) &lt; 0)
+        return -1;
+
+    if (nsockIP != 1 &amp;&amp; nsockIP != 2) {
+        fprintf(stderr, &quot;Got %zu IP sockets but expected only 1 or 2\n&quot;, nsockIP);
+        goto cleanup;
+    }
+
+    snprintf(nfdstr, sizeof(nfdstr), &quot;%zu&quot;, 1 + nsockIP);
+    snprintf(pidstr, sizeof(pidstr), &quot;%lld&quot;, (long long)getpid());
+
+    setenv(&quot;LISTEN_FDS&quot;, nfdstr, 1);
+    setenv(&quot;LISTEN_PID&quot;, pidstr, 1);
+
+    if (useNames)
+        setenv(&quot;LISTEN_FDNAMES&quot;, nsockIP == 1 ? names2 : names3, 1);
+    else
+        unsetenv(&quot;LISTEN_FDNAMES&quot;);
+
+    map[0].name = &quot;demo-unix.socket&quot;;
+    map[0].family = AF_UNIX;
+    map[0].path = virNetSocketGetPath(sockUNIX);
+
+    map[1].name = &quot;demo-ip.socket&quot;;
+    map[1].family = AF_INET;
+    map[1].port = virNetSocketGetPort(sockIP[0]);
+
+    if (virSystemdGetActivation(map, ARRAY_CARDINALITY(map), &amp;act) &lt; 0)
+        goto cleanup;
+
+    if (act == NULL) {
+        fprintf(stderr, &quot;Activation object was not created: %s&quot;, virGetLastErrorMessage());
+        goto cleanup;
+    }
+
+    if (virSystemdActivationComplete(act) == 0) {
+        fprintf(stderr, &quot;Activation did not report unclaimed FDs&quot;);
+        goto cleanup;
+    }
+
+    virSystemdActivationClaimFDs(act, &quot;demo-unix.socket&quot;, &amp;fds, &amp;nfds);
+
+    if (nfds != 1) {
+        fprintf(stderr, &quot;Expected 1 UNIX fd, but got %zu\n&quot;, nfds);
+        goto cleanup;
+    }
+    VIR_FREE(fds);
+
+    virSystemdActivationClaimFDs(act, &quot;demo-ip.socket&quot;, &amp;fds, &amp;nfds);
+
+    if (nfds != nsockIP) {
+        fprintf(stderr, &quot;Expected %zu IP fd, but got %zu\n&quot;, nsockIP, nfds);
+        goto cleanup;
+    }
+    VIR_FREE(fds);
+
+    virSystemdActivationClaimFDs(act, &quot;demo-ip-alt.socket&quot;, &amp;fds, &amp;nfds);
+
+    if (nfds != 0) {
+        fprintf(stderr, &quot;Expected 0 IP fd, but got %zu\n&quot;, nfds);
+        goto cleanup;
+    }
+
+    if (virSystemdActivationComplete(act) &lt; 0) {
+        fprintf(stderr, &quot;Action was not complete: %s\n&quot;, virGetLastErrorMessage());
+        goto cleanup;
+    }
+
+    ret = 0;
+ cleanup:
+    virObjectUnref(sockUNIX);
+    for (i = 0; i &lt; nsockIP; i++)
+        virObjectUnref(sockIP[i]);
+    VIR_FREE(sockIP);
+    VIR_FREE(fds);
+    return ret;
+}
+
+
+static int
+testActivationEmpty(const void *opaque ATTRIBUTE_UNUSED)
+{
+    virSystemdActivationPtr act;
+
+    unsetenv(&quot;LISTEN_FDS&quot;);
+
+    if (virSystemdGetActivation(NULL, 0, &amp;act) &lt; 0)
+        return -1;
+
+    if (act != NULL) {
+        fprintf(stderr, &quot;Unexpectedly got activation object&quot;);
+        virSystemdActivationFree(&amp;act);
+        return -1;
+    }
+
+    return 0;
+}
+
+
+static int
+testActivationFDNames(const void *opaque ATTRIBUTE_UNUSED)
+{
+    return testActivation(true);
+}
+
+
+static int
+testActivationFDAddrs(const void *opaque ATTRIBUTE_UNUSED)
+{
+    return testActivation(false);
+}
+
+
 static int
 mymain(void)
 {
@@ -598,6 +760,13 @@ mymain(void)
     TESTS_PM_SUPPORT_HELPER(&quot;canHibernate&quot;, &amp;virSystemdCanHibernate);
     TESTS_PM_SUPPORT_HELPER(&quot;canHybridSleep&quot;, &amp;virSystemdCanHybridSleep);
 
+    if (virTestRun(&quot;Test activation empty&quot;, testActivationEmpty, NULL) &lt; 0)
+        ret = -1;
+    if (virTestRun(&quot;Test activation names&quot;, testActivationFDNames, NULL) &lt; 0)
+        ret = -1;
+    if (virTestRun(&quot;Test activation addrs&quot;, testActivationFDAddrs, NULL) &lt; 0)
+        ret = -1;
+
     return ret == 0 ? EXIT_SUCCESS : EXIT_FAILURE;
 }
 
-- 
2.21.0

--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187135.html">[PATCH v2 07/19] rpc: add API for checking whether an	auth scheme is in use on a server</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187137.html">[PATCH v2 10/19] rpc: remove unused API for creating	services from FDs</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187135.html">[PATCH v2 07/19] rpc: add API for checking whether an	auth scheme is in use on a server</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187137.html">[PATCH v2 10/19] rpc: remove unused API for creating	services from FDs</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187136"><strong>Date</strong></a></li>
<li><a href="index.html#187136"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH 2.6.19 3/6] tgafb: Support the DirectColor visual -->
<!--X-From-R13: "[npvrw I. Dbmlpxv" &#60;znpebNyvahk&#45;zvcf.bet> -->
<!--X-Date: Wed, 13 Dec 2006 12:10:54 &#45;0500 -->
<!--X-Message-Id: Pine.LNX.4.64N.0612131605320.24220@blysk.ds.pg.gda.pl -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<title>Linux AXP &mdash; [PATCH 2.6.19 3/6] tgafb: Support the DirectColor visual</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Linux AXP, [PATCH 2.6.19 3/6] tgafb: Support the DirectColor visual">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<meta name="keywords" content="[PATCH 2.6.19 3/6] tgafb: Support the DirectColor visual, fedora, red hat, linux, rpm, package, packaging, archive">
<link rel="alternate" type="application/rss+xml" title="Linux AXP" href="maillist.rdf">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="35" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH 2.6.19 3/6] tgafb: Support the DirectColor visual</h1>
[<a href="msg41606.html">Date Prev</a>][<a href="msg41608.html">Date Next</a>][<a href="msg41606.html">Thread Prev</a>][<a href="msg41608.html">Thread Next</a>][<a href="maillist.html#41607">Date Index</a>][<a href="index.html#41607">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH 2.6.19 3/6] tgafb: Support the DirectColor visual</li>
<li><em>From</em>: &quot;Maciej W. Rozycki&quot; &lt;<a href="mailto:macro@DOMAIN.HIDDEN">macro@xxxxxxxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Wed, 13 Dec 2006 17:10:43 +0000 (GMT)</li>
<li><em>Cc</em>: <a href="mailto:axp-list@DOMAIN.HIDDEN">axp-list@xxxxxxxxxx</a>, <a href="mailto:linux-fbdev-devel@DOMAIN.HIDDEN">linux-fbdev-devel@xxxxxxxxxxxxxxxxxxxxx</a>,	<a href="mailto:linux-kernel@DOMAIN.HIDDEN">linux-kernel@xxxxxxxxxxxxxxx</a></li>
<li><em>Reply-to</em>: Linux on Alpha processors &lt;<a href="mailto:axp-list@DOMAIN.HIDDEN">axp-list@xxxxxxxxxx</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18"></script>
<!-- AddThis Button END -->
<hr>
<script type="text/javascript"><!--
google_ad_client = "ca-pub-3422782820843221";
/* lists link unit 728x15, created 7/7/08 */
google_ad_slot = "9367657018";
google_ad_width = 728;
google_ad_height = 15;
//-->
</script>
<script type="text/javascript"
src="//pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre> The 32-plane variations of the TGA use the Bt463 RAMDAC and are therefore 
DirectColor rather than TrueColor adapters.  This is a set of changes to 
implement the necessary bits to support this model.  A couple of fixes to 
fix accesses to the RAMDAC are included as a side-effect.

Signed-off-by: Maciej W. Rozycki &lt;macro@xxxxxxxxxxxxxx&gt;
---

 This is the most intrusive change in this set of patches.  It was tested 
both with the console, including the bootstrap logo, and X11 to make sure 
palette handling is correct.

 Please apply.

  Maciej

patch-mips-2.6.18-20060920-tgafb-directcolor-1
diff -up --recursive --new-file linux-mips-2.6.18-20060920.macro/drivers/video/tgafb.c linux-mips-2.6.18-20060920/drivers/video/tgafb.c
--- linux-mips-2.6.18-20060920.macro/drivers/video/tgafb.c	2006-09-20 20:50:52.000000000 +0000
+++ linux-mips-2.6.18-20060920/drivers/video/tgafb.c	2006-12-12 14:28:22.000000000 +0000
@@ -98,6 +98,12 @@ tgafb_check_var(struct fb_var_screeninfo
 		if (var-&gt;bits_per_pixel != 32)
 			return -EINVAL;
 	}
+	var-&gt;red.length = var-&gt;green.length = var-&gt;blue.length = 8;
+	if (var-&gt;bits_per_pixel == 32) {
+		var-&gt;red.offset = 16;
+		var-&gt;green.offset = 8;
+		var-&gt;blue.offset = 0;
+	}
 
 	if (var-&gt;xres_virtual != var-&gt;xres || var-&gt;yres_virtual != var-&gt;yres)
 		return -EINVAL;
@@ -151,7 +157,7 @@ tgafb_set_par(struct fb_info *info)
 	struct tga_par *par = (struct tga_par *) info-&gt;par;
 	u32 htimings, vtimings, pll_freq;
 	u8 tga_type;
-	int i, j;
+	int i;
 
 	/* Encode video timings.  */
 	htimings = (((info-&gt;var.xres/4) &amp; TGA_HORIZ_ACT_LSB)
@@ -226,8 +232,10 @@ tgafb_set_par(struct fb_info *info)
 		BT485_WRITE(par, 0x00, BT485_ADDR_PAL_WRITE);
 		TGA_WRITE_REG(par, BT485_DATA_PAL, TGA_RAMDAC_SETUP_REG);
 
+#ifdef CONFIG_HW_CONSOLE
 		for (i = 0; i &lt; 16; i++) {
-			j = color_table[i];
+			int j = color_table[i];
+
 			TGA_WRITE_REG(par, default_red[j]|(BT485_DATA_PAL&lt;&lt;8),
 				      TGA_RAMDAC_REG);
 			TGA_WRITE_REG(par, default_grn[j]|(BT485_DATA_PAL&lt;&lt;8),
@@ -235,14 +243,17 @@ tgafb_set_par(struct fb_info *info)
 			TGA_WRITE_REG(par, default_blu[j]|(BT485_DATA_PAL&lt;&lt;8),
 				      TGA_RAMDAC_REG);
 		}
-		for (i = 0; i &lt; 240*3; i += 4) {
-			TGA_WRITE_REG(par, 0x55|(BT485_DATA_PAL&lt;&lt;8),
+		for (i = 0; i &lt; 240 * 3; i += 4) {
+#else
+		for (i = 0; i &lt; 256 * 3; i += 4) {
+#endif
+			TGA_WRITE_REG(par, 0x55 | (BT485_DATA_PAL &lt;&lt; 8),
 				      TGA_RAMDAC_REG);
-			TGA_WRITE_REG(par, 0x00|(BT485_DATA_PAL&lt;&lt;8),
+			TGA_WRITE_REG(par, 0x00 | (BT485_DATA_PAL &lt;&lt; 8),
 				      TGA_RAMDAC_REG);
-			TGA_WRITE_REG(par, 0x00|(BT485_DATA_PAL&lt;&lt;8),
+			TGA_WRITE_REG(par, 0x00 | (BT485_DATA_PAL &lt;&lt; 8),
 				      TGA_RAMDAC_REG);
-			TGA_WRITE_REG(par, 0x00|(BT485_DATA_PAL&lt;&lt;8),
+			TGA_WRITE_REG(par, 0x00 | (BT485_DATA_PAL &lt;&lt; 8),
 				      TGA_RAMDAC_REG);
 		}
 
@@ -266,26 +277,24 @@ tgafb_set_par(struct fb_info *info)
 
 		/* Fill the palette.  */
 		BT463_LOAD_ADDR(par, 0x0000);
-		TGA_WRITE_REG(par, BT463_PALETTE&lt;&lt;2, TGA_RAMDAC_REG);
+		TGA_WRITE_REG(par, BT463_PALETTE &lt;&lt; 2, TGA_RAMDAC_SETUP_REG);
 
+#ifdef CONFIG_HW_CONSOLE
 		for (i = 0; i &lt; 16; i++) {
-			j = color_table[i];
-			TGA_WRITE_REG(par, default_red[j]|(BT463_PALETTE&lt;&lt;10),
-				      TGA_RAMDAC_REG);
-			TGA_WRITE_REG(par, default_grn[j]|(BT463_PALETTE&lt;&lt;10),
-				      TGA_RAMDAC_REG);
-			TGA_WRITE_REG(par, default_blu[j]|(BT463_PALETTE&lt;&lt;10),
-				      TGA_RAMDAC_REG);
-		}
-		for (i = 0; i &lt; 512*3; i += 4) {
-			TGA_WRITE_REG(par, 0x55|(BT463_PALETTE&lt;&lt;10),
-				      TGA_RAMDAC_REG);
-			TGA_WRITE_REG(par, 0x00|(BT463_PALETTE&lt;&lt;10),
-				      TGA_RAMDAC_REG);
-			TGA_WRITE_REG(par, 0x00|(BT463_PALETTE&lt;&lt;10),
-				      TGA_RAMDAC_REG);
-			TGA_WRITE_REG(par, 0x00|(BT463_PALETTE&lt;&lt;10),
-				      TGA_RAMDAC_REG);
+			int j = color_table[i];
+
+			TGA_WRITE_REG(par, default_red[j], TGA_RAMDAC_REG);
+			TGA_WRITE_REG(par, default_grn[j], TGA_RAMDAC_REG);
+			TGA_WRITE_REG(par, default_blu[j], TGA_RAMDAC_REG);
+		}
+		for (i = 0; i &lt; 512 * 3; i += 4) {
+#else
+		for (i = 0; i &lt; 528 * 3; i += 4) {
+#endif
+			TGA_WRITE_REG(par, 0x55, TGA_RAMDAC_REG);
+			TGA_WRITE_REG(par, 0x00, TGA_RAMDAC_REG);
+			TGA_WRITE_REG(par, 0x00, TGA_RAMDAC_REG);
+			TGA_WRITE_REG(par, 0x00, TGA_RAMDAC_REG);
 		}
 
 		/* Fill window type table after start of vertical retrace.  */
@@ -298,15 +307,12 @@ tgafb_set_par(struct fb_info *info)
 		TGA_WRITE_REG(par, 0x01, TGA_INTR_STAT_REG);
 
 		BT463_LOAD_ADDR(par, BT463_WINDOW_TYPE_BASE);
-		TGA_WRITE_REG(par, BT463_REG_ACC&lt;&lt;2, TGA_RAMDAC_SETUP_REG);
+		TGA_WRITE_REG(par, BT463_REG_ACC &lt;&lt; 2, TGA_RAMDAC_SETUP_REG);
 
 		for (i = 0; i &lt; 16; i++) {
-			TGA_WRITE_REG(par, 0x00|(BT463_REG_ACC&lt;&lt;10),
-				      TGA_RAMDAC_REG);
-			TGA_WRITE_REG(par, 0x01|(BT463_REG_ACC&lt;&lt;10),
-				      TGA_RAMDAC_REG);
-			TGA_WRITE_REG(par, 0x80|(BT463_REG_ACC&lt;&lt;10),
-				      TGA_RAMDAC_REG);
+			TGA_WRITE_REG(par, 0x00, TGA_RAMDAC_REG);
+			TGA_WRITE_REG(par, 0x01, TGA_RAMDAC_REG);
+			TGA_WRITE_REG(par, 0x00, TGA_RAMDAC_REG);
 		}
 
 	}
@@ -434,9 +440,16 @@ tgafb_setcolreg(unsigned regno, unsigned
 		TGA_WRITE_REG(par, red|(BT485_DATA_PAL&lt;&lt;8),TGA_RAMDAC_REG);
 		TGA_WRITE_REG(par, green|(BT485_DATA_PAL&lt;&lt;8),TGA_RAMDAC_REG);
 		TGA_WRITE_REG(par, blue|(BT485_DATA_PAL&lt;&lt;8),TGA_RAMDAC_REG);
-	} else if (regno &lt; 16) {
-		u32 value = (red &lt;&lt; 16) | (green &lt;&lt; 8) | blue;
-		((u32 *)info-&gt;pseudo_palette)[regno] = value;
+	} else {
+		if (regno &lt; 16) {
+			u32 value = (regno &lt;&lt; 16) | (regno &lt;&lt; 8) | regno;
+			((u32 *)info-&gt;pseudo_palette)[regno] = value;
+		}
+		BT463_LOAD_ADDR(par, regno);
+		TGA_WRITE_REG(par, BT463_PALETTE &lt;&lt; 2, TGA_RAMDAC_SETUP_REG);
+		TGA_WRITE_REG(par, red, TGA_RAMDAC_REG);
+		TGA_WRITE_REG(par, green, TGA_RAMDAC_REG);
+		TGA_WRITE_REG(par, blue, TGA_RAMDAC_REG);
 	}
 
 	return 0;
@@ -1351,7 +1364,7 @@ tgafb_init_fix(struct fb_info *info)
 	info-&gt;fix.type_aux = 0;
 	info-&gt;fix.visual = (tga_type == TGA_TYPE_8PLANE
 			    ? FB_VISUAL_PSEUDOCOLOR
-			    : FB_VISUAL_TRUECOLOR);
+			    : FB_VISUAL_DIRECTCOLOR);
 
 	info-&gt;fix.line_length = par-&gt;xres * (par-&gt;bits_per_pixel &gt;&gt; 3);
 	info-&gt;fix.smem_start = (size_t) par-&gt;tga_fb_base;

</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
[<a href="msg41606.html">Date Prev</a>][<a href="msg41608.html">Date Next</a>][<a href="msg41606.html">Thread Prev</a>][<a href="msg41608.html">Thread Next</a>][<a href="maillist.html#41607">Date Index</a>][<a href="index.html#41607">Thread Index</a>]
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg41606.html">[PATCH 2.6.19 2/6] tgafb: Fix copying overlapping areas</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg41608.html">[PATCH 2.6.19 5/6] tgafb: Module support fixes</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg41606.html">[PATCH 2.6.19 2/6] tgafb: Fix copying overlapping areas</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg41608.html">[PATCH 2.6.19 5/6] tgafb: Module support fixes</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#41607"><strong>Date</strong></a></li>
<li><a href="index.html#41607"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-devel/>[Fedora&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=/linux/biglist.html>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<!--X-User-Footer-End-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH v5 11/12] S.A.R.A.: /proc/*/mem write limitation -->
<!--X-From-R13: Xnaa Vbea &#60;wnaauNtbbtyr.pbz> -->
<!--X-Date: Sat, 6 Jul 2019 11:21:13 &#45;0700 -->
<!--X-Message-Id: CAG48ez0uFX4AniOk1W0Vs6j=7Q5QfSFQTrBBzC2qL2bpWn_yCg@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 1562410493&#45;8661&#45;1&#45;git&#45;send&#45;email&#45;s.mesoraca16@gmail.com -->
<!--X-Reference: 1562410493&#45;8661&#45;12&#45;git&#45;send&#45;email&#45;s.mesoraca16@gmail.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Linux Security Module, Re: [PATCH v5 11/12] S.A.R.A.: /proc/*/mem write limitation">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Linux Security Module -- Re: [PATCH v5 11/12] S.A.R.A.: /proc/*/mem write limitation</title>
<link rel="alternate" type="application/rss+xml" title="Linux Security Module" href="//feeds.feedburner.com/LinuxSecurityModule">
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH v5 11/12] S.A.R.A.: /proc/*/mem write limitation</h1>
[<a href="msg29734.html">Date Prev</a>][<a href="msg29736.html">Date Next</a>][<a href="msg29718.html">Thread Prev</a>][<a href="msg29746.html">Thread Next</a>][<a href="maillist.html#29735">Date Index</a>][<a href="index.html#29735">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH v5 11/12] S.A.R.A.: /proc/*/mem write limitation</li>
<li><em>From</em>: Jann Horn &lt;jannh@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Sat, 6 Jul 2019 20:20:35 +0200</li>
<li><em>Cc</em>: kernel list &lt;linux-kernel@xxxxxxxxxxxxxxx&gt;,        Kernel Hardening &lt;kernel-hardening@xxxxxxxxxxxxxxxxxx&gt;,        Linux-MM &lt;linux-mm@xxxxxxxxx&gt;,        linux-security-module &lt;linux-security-module@xxxxxxxxxxxxxxx&gt;,        Alexander Viro &lt;viro@xxxxxxxxxxxxxxxxxx&gt;,        Brad Spengler &lt;spender@xxxxxxxxxxxxxx&gt;,        Casey Schaufler &lt;casey@xxxxxxxxxxxxxxxx&gt;,        Christoph Hellwig &lt;hch@xxxxxxxxxxxxx&gt;,        James Morris &lt;james.l.morris@xxxxxxxxxx&gt;,        Kees Cook &lt;keescook@xxxxxxxxxxxx&gt;, PaX Team &lt;pageexec@xxxxxxxxxxx&gt;,        &quot;Serge E. Hallyn&quot; &lt;serge@xxxxxxxxxx&gt;,        Thomas Gleixner &lt;tglx@xxxxxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg29718.html">1562410493-8661-12-git-send-email-s.mesoraca16@gmail.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg29714.html">1562410493-8661-1-git-send-email-s.mesoraca16@gmail.com</a>&gt; &lt;<a href="msg29718.html">1562410493-8661-12-git-send-email-s.mesoraca16@gmail.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Sat, Jul 6, 2019 at 12:55 PM Salvatore Mesoraca
&lt;s.mesoraca16@xxxxxxxxx&gt; wrote:
&gt; Prevent a task from opening, in &quot;write&quot; mode, any /proc/*/mem
&gt; file that operates on the task's mm.
&gt; A process could use it to overwrite read-only memory, bypassing
&gt; S.A.R.A. restrictions.
[...]
&gt; +static void sara_task_to_inode(struct task_struct *t, struct inode *i)
&gt; +{
&gt; +       get_sara_inode_task(i) = t;

This looks bogus. Nothing is actually holding a reference to `t` here, right?

&gt; +}
&gt; +
&gt;  static struct security_hook_list data_hooks[] __lsm_ro_after_init = {
&gt;         LSM_HOOK_INIT(cred_prepare, sara_cred_prepare),
&gt;         LSM_HOOK_INIT(cred_transfer, sara_cred_transfer),
&gt;         LSM_HOOK_INIT(shm_alloc_security, sara_shm_alloc_security),
&gt; +       LSM_HOOK_INIT(task_to_inode, sara_task_to_inode),
&gt;  };
[...]
&gt; +static int sara_file_open(struct file *file)
&gt; +{
&gt; +       struct task_struct *t;
&gt; +       struct mm_struct *mm;
&gt; +       u16 sara_wxp_flags = get_current_sara_wxp_flags();
&gt; +
&gt; +       /*
&gt; +        * Prevent write access to /proc/.../mem
&gt; +        * if it operates on the mm_struct of the
&gt; +        * current process: it could be used to
&gt; +        * bypass W^X.
&gt; +        */
&gt; +
&gt; +       if (!sara_enabled ||
&gt; +           !wxprot_enabled ||
&gt; +           !(sara_wxp_flags &amp; SARA_WXP_WXORX) ||
&gt; +           !(file-&gt;f_mode &amp; FMODE_WRITE))
&gt; +               return 0;
&gt; +
&gt; +       t = get_sara_inode_task(file_inode(file));
&gt; +       if (unlikely(t != NULL &amp;&amp;
&gt; +                    strcmp(file-&gt;f_path.dentry-&gt;d_name.name,
&gt; +                           &quot;mem&quot;) == 0)) {

This should probably at least have a READ_ONCE() somewhere in case the
file concurrently gets renamed?

&gt; +               get_task_struct(t);
&gt; +               mm = get_task_mm(t);
&gt; +               put_task_struct(t);

Getting and dropping a reference to the task_struct here is completely
useless. Either you have a reference, in which case you don't need to
take another one, or you don't have a reference, in which case you
also can't take one.

&gt; +               if (unlikely(mm == current-&gt;mm))
&gt; +                       sara_warn_or_goto(error,
&gt; +                                         &quot;write access to /proc/*/mem&quot;);

Why is the current process so special that it must be protected more
than other processes? Is the idea here to rely on other protections to
protect all other tasks? This should probably come with a comment that
explains this choice.

&gt; +               mmput(mm);
&gt; +       }
&gt; +       return 0;
&gt; +error:
&gt; +       mmput(mm);
&gt; +       return -EACCES;
&gt; +}


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="29746" href="msg29746.html">Re: [PATCH v5 11/12] S.A.R.A.: /proc/*/mem write limitation</a></strong>
<ul><li><em>From:</em> Salvatore Mesoraca</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="29714" href="msg29714.html">[PATCH v5 00/12] S.A.R.A. a new stacked LSM</a></strong>
<ul><li><em>From:</em> Salvatore Mesoraca</li></ul></li>
<li><strong><a name="29718" href="msg29718.html">[PATCH v5 11/12] S.A.R.A.: /proc/*/mem write limitation</a></strong>
<ul><li><em>From:</em> Salvatore Mesoraca</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg29734.html">Re: [PATCH v5 01/12] S.A.R.A.: add documentation</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg29736.html">Re: [PATCH v5 04/12] S.A.R.A.: generic DFA for string matching</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg29718.html">[PATCH v5 11/12] S.A.R.A.: /proc/*/mem write limitation</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg29746.html">Re: [PATCH v5 11/12] S.A.R.A.: /proc/*/mem write limitation</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#29735"><strong>Date</strong></a></li>
<li><a href="index.html#29735"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH v12 06/11] ima: Factor xattr_verify() out of ima_appraise_measurement() -->
<!--X-From-R13: Fuvntb Xhat Pnhreznaa &#60;onhreznaNyvahk.voz.pbz> -->
<!--X-Date: Thu, 27 Jun 2019 19:21:07 &#45;0700 -->
<!--X-Message-Id: 20190628021934.4260&#45;7&#45;bauerman@linux.ibm.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190628021934.4260&#45;1&#45;bauerman@linux.ibm.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Linux Security Module, [PATCH v12 06/11] ima: Factor xattr_verify() out of ima_appraise_measurement()">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Linux Security Module -- [PATCH v12 06/11] ima: Factor xattr_verify() out of ima_appraise_measurement()</title>
<link rel="alternate" type="application/rss+xml" title="Linux Security Module" href="//feeds.feedburner.com/LinuxSecurityModule">
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH v12 06/11] ima: Factor xattr_verify() out of ima_appraise_measurement()</h1>
[<a href="msg29529.html">Date Prev</a>][<a href="msg29531.html">Date Next</a>][<a href="msg29529.html">Thread Prev</a>][<a href="msg29531.html">Thread Next</a>][<a href="maillist.html#29530">Date Index</a>][<a href="index.html#29530">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH v12 06/11] ima: Factor xattr_verify() out of ima_appraise_measurement()</li>
<li><em>From</em>: Thiago Jung Bauermann &lt;bauerman@xxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 27 Jun 2019 23:19:29 -0300</li>
<li><em>Cc</em>: linux-security-module@xxxxxxxxxxxxxxx, keyrings@xxxxxxxxxxxxxxx,        linux-crypto@xxxxxxxxxxxxxxx, linuxppc-dev@xxxxxxxxxxxxxxxx,        linux-doc@xxxxxxxxxxxxxxx, linux-kernel@xxxxxxxxxxxxxxx,        Mimi Zohar &lt;zohar@xxxxxxxxxxxxx&gt;,        Dmitry Kasatkin &lt;dmitry.kasatkin@xxxxxxxxx&gt;,        James Morris &lt;jmorris@xxxxxxxxx&gt;, &quot;Serge E. Hallyn&quot; &lt;serge@xxxxxxxxxx&gt;,        David Howells &lt;dhowells@xxxxxxxxxx&gt;,        David Woodhouse &lt;dwmw2@xxxxxxxxxxxxx&gt;, Jessica Yu &lt;jeyu@xxxxxxxxxx&gt;,        Herbert Xu &lt;herbert@xxxxxxxxxxxxxxxxxxx&gt;,        &quot;David S. Miller&quot; &lt;davem@xxxxxxxxxxxxx&gt;,        Jonathan Corbet &lt;corbet@xxxxxxx&gt;,        &quot;AKASHI, Takahiro&quot; &lt;takahiro.akashi@xxxxxxxxxx&gt;,        Thiago Jung Bauermann &lt;bauerman@xxxxxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg29521.html">20190628021934.4260-1-bauerman@linux.ibm.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg29521.html">20190628021934.4260-1-bauerman@linux.ibm.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Verify xattr signature in a separate function so that the logic in
ima_appraise_measurement() remains clear when it gains the ability to also
verify an appended module signature.

The code in the switch statement is unchanged except for having to
dereference the status and cause variables (since they're now pointers),
and fixing the style of a block comment to appease checkpatch.

Suggested-by: Mimi Zohar &lt;zohar@xxxxxxxxxxxxx&gt;
Signed-off-by: Thiago Jung Bauermann &lt;bauerman@xxxxxxxxxxxxx&gt;
Reviewed-by: Mimi Zohar &lt;zohar@xxxxxxxxxxxxx&gt;
---
 security/integrity/ima/ima_appraise.c | 141 +++++++++++++++-----------
 1 file changed, 81 insertions(+), 60 deletions(-)

diff --git a/security/integrity/ima/ima_appraise.c b/security/integrity/ima/ima_appraise.c
index 18bbe753421a..5d4772f39757 100644
--- a/security/integrity/ima/ima_appraise.c
+++ b/security/integrity/ima/ima_appraise.c
@@ -202,6 +202,83 @@ int ima_read_xattr(struct dentry *dentry,
 	return ret;
 }
 
+/*
+ * xattr_verify - verify xattr digest or signature
+ *
+ * Verify whether the hash or signature matches the file contents.
+ *
+ * Return 0 on success, error code otherwise.
+ */
+static int xattr_verify(enum ima_hooks func, struct integrity_iint_cache *iint,
+			struct evm_ima_xattr_data *xattr_value, int xattr_len,
+			enum integrity_status *status, const char **cause)
+{
+	int rc = -EINVAL, hash_start = 0;
+
+	switch (xattr_value-&gt;type) {
+	case IMA_XATTR_DIGEST_NG:
+		/* first byte contains algorithm id */
+		hash_start = 1;
+		/* fall through */
+	case IMA_XATTR_DIGEST:
+		if (iint-&gt;flags &amp; IMA_DIGSIG_REQUIRED) {
+			*cause = &quot;IMA-signature-required&quot;;
+			*status = INTEGRITY_FAIL;
+			break;
+		}
+		clear_bit(IMA_DIGSIG, &amp;iint-&gt;atomic_flags);
+		if (xattr_len - sizeof(xattr_value-&gt;type) - hash_start &gt;=
+				iint-&gt;ima_hash-&gt;length)
+			/*
+			 * xattr length may be longer. md5 hash in previous
+			 * version occupied 20 bytes in xattr, instead of 16
+			 */
+			rc = memcmp(&amp;xattr_value-&gt;data[hash_start],
+				    iint-&gt;ima_hash-&gt;digest,
+				    iint-&gt;ima_hash-&gt;length);
+		else
+			rc = -EINVAL;
+		if (rc) {
+			*cause = &quot;invalid-hash&quot;;
+			*status = INTEGRITY_FAIL;
+			break;
+		}
+		*status = INTEGRITY_PASS;
+		break;
+	case EVM_IMA_XATTR_DIGSIG:
+		set_bit(IMA_DIGSIG, &amp;iint-&gt;atomic_flags);
+		rc = integrity_digsig_verify(INTEGRITY_KEYRING_IMA,
+					     (const char *)xattr_value,
+					     xattr_len,
+					     iint-&gt;ima_hash-&gt;digest,
+					     iint-&gt;ima_hash-&gt;length);
+		if (rc == -EOPNOTSUPP) {
+			*status = INTEGRITY_UNKNOWN;
+			break;
+		}
+		if (IS_ENABLED(CONFIG_INTEGRITY_PLATFORM_KEYRING) &amp;&amp; rc &amp;&amp;
+		    func == KEXEC_KERNEL_CHECK)
+			rc = integrity_digsig_verify(INTEGRITY_KEYRING_PLATFORM,
+						     (const char *)xattr_value,
+						     xattr_len,
+						     iint-&gt;ima_hash-&gt;digest,
+						     iint-&gt;ima_hash-&gt;length);
+		if (rc) {
+			*cause = &quot;invalid-signature&quot;;
+			*status = INTEGRITY_FAIL;
+		} else {
+			*status = INTEGRITY_PASS;
+		}
+		break;
+	default:
+		*status = INTEGRITY_UNKNOWN;
+		*cause = &quot;unknown-ima-data&quot;;
+		break;
+	}
+
+	return rc;
+}
+
 /*
  * ima_appraise_measurement - appraise file measurement
  *
@@ -221,7 +298,7 @@ int ima_appraise_measurement(enum ima_hooks func,
 	struct dentry *dentry = file_dentry(file);
 	struct inode *inode = d_backing_inode(dentry);
 	enum integrity_status status = INTEGRITY_UNKNOWN;
-	int rc = xattr_len, hash_start = 0;
+	int rc = xattr_len;
 
 	if (!(inode-&gt;i_opflags &amp; IOP_XATTR))
 		return INTEGRITY_UNKNOWN;
@@ -259,65 +336,9 @@ int ima_appraise_measurement(enum ima_hooks func,
 		WARN_ONCE(true, &quot;Unexpected integrity status %d\n&quot;, status);
 	}
 
-	switch (xattr_value-&gt;type) {
-	case IMA_XATTR_DIGEST_NG:
-		/* first byte contains algorithm id */
-		hash_start = 1;
-		/* fall through */
-	case IMA_XATTR_DIGEST:
-		if (iint-&gt;flags &amp; IMA_DIGSIG_REQUIRED) {
-			cause = &quot;IMA-signature-required&quot;;
-			status = INTEGRITY_FAIL;
-			break;
-		}
-		clear_bit(IMA_DIGSIG, &amp;iint-&gt;atomic_flags);
-		if (xattr_len - sizeof(xattr_value-&gt;type) - hash_start &gt;=
-				iint-&gt;ima_hash-&gt;length)
-			/* xattr length may be longer. md5 hash in previous
-			   version occupied 20 bytes in xattr, instead of 16
-			 */
-			rc = memcmp(&amp;xattr_value-&gt;data[hash_start],
-				    iint-&gt;ima_hash-&gt;digest,
-				    iint-&gt;ima_hash-&gt;length);
-		else
-			rc = -EINVAL;
-		if (rc) {
-			cause = &quot;invalid-hash&quot;;
-			status = INTEGRITY_FAIL;
-			break;
-		}
-		status = INTEGRITY_PASS;
-		break;
-	case EVM_IMA_XATTR_DIGSIG:
-		set_bit(IMA_DIGSIG, &amp;iint-&gt;atomic_flags);
-		rc = integrity_digsig_verify(INTEGRITY_KEYRING_IMA,
-					     (const char *)xattr_value,
-					     xattr_len,
-					     iint-&gt;ima_hash-&gt;digest,
-					     iint-&gt;ima_hash-&gt;length);
-		if (rc == -EOPNOTSUPP) {
-			status = INTEGRITY_UNKNOWN;
-			break;
-		}
-		if (IS_ENABLED(CONFIG_INTEGRITY_PLATFORM_KEYRING) &amp;&amp; rc &amp;&amp;
-		    func == KEXEC_KERNEL_CHECK)
-			rc = integrity_digsig_verify(INTEGRITY_KEYRING_PLATFORM,
-						     (const char *)xattr_value,
-						     xattr_len,
-						     iint-&gt;ima_hash-&gt;digest,
-						     iint-&gt;ima_hash-&gt;length);
-		if (rc) {
-			cause = &quot;invalid-signature&quot;;
-			status = INTEGRITY_FAIL;
-		} else {
-			status = INTEGRITY_PASS;
-		}
-		break;
-	default:
-		status = INTEGRITY_UNKNOWN;
-		cause = &quot;unknown-ima-data&quot;;
-		break;
-	}
+	if (xattr_value)
+		rc = xattr_verify(func, iint, xattr_value, xattr_len, &amp;status,
+				  &amp;cause);
 
 out:
 	/*


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="29521" href="msg29521.html">[PATCH v12 00/11] Appended signatures support for IMA appraisal</a></strong>
<ul><li><em>From:</em> Thiago Jung Bauermann</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg29529.html">[PATCH v12 10/11] ima: Store the measurement again when appraising a modsig</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg29531.html">[PATCH v12 03/11] PKCS#7: Introduce pkcs7_get_digest()</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg29529.html">[PATCH v12 10/11] ima: Store the measurement again when appraising a modsig</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg29531.html">[PATCH v12 03/11] PKCS#7: Introduce pkcs7_get_digest()</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#29530"><strong>Date</strong></a></li>
<li><a href="index.html#29530"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

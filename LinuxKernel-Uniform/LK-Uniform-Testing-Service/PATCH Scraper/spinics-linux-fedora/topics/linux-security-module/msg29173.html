<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH v3 21/24] Audit: Store LSM audit information in an lsmblob -->
<!--X-From-R13: Qnfrl Epunhsyre &#60;pnfrlNfpunhsyre&#45;pn.pbz> -->
<!--X-Date: Fri, 21 Jun 2019 11:53:28 &#45;0700 -->
<!--X-Message-Id: 20190621185233.6766&#45;22&#45;casey@schaufler&#45;ca.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190621185233.6766&#45;1&#45;casey@schaufler&#45;ca.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Linux Security Module, [PATCH v3 21/24] Audit: Store LSM audit information in an lsmblob">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Linux Security Module -- [PATCH v3 21/24] Audit: Store LSM audit information in an lsmblob</title>
<link rel="alternate" type="application/rss+xml" title="Linux Security Module" href="//feeds.feedburner.com/LinuxSecurityModule">
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH v3 21/24] Audit: Store LSM audit information in an lsmblob</h1>
[<a href="msg29172.html">Date Prev</a>][<a href="msg29174.html">Date Next</a>][<a href="msg29307.html">Thread Prev</a>][<a href="msg29234.html">Thread Next</a>][<a href="maillist.html#29173">Date Index</a>][<a href="index.html#29173">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH v3 21/24] Audit: Store LSM audit information in an lsmblob</li>
<li><em>From</em>: Casey Schaufler &lt;casey@xxxxxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Fri, 21 Jun 2019 11:52:30 -0700</li>
<li><em>Cc</em>: casey@xxxxxxxxxxxxxxxx, keescook@xxxxxxxxxxxx,        john.johansen@xxxxxxxxxxxxx, penguin-kernel@xxxxxxxxxxxxxxxxxxx,        paul@xxxxxxxxxxxxxx, sds@xxxxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg29154.html">20190621185233.6766-1-casey@schaufler-ca.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg29154.html">20190621185233.6766-1-casey@schaufler-ca.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Change the audit code to store full lsmblob data instead of
a single u32 secid. This allows for multiple security modules
to use the audit system at the same time. It also allows the
removal of scaffolding code that was included during the
revision of LSM interfaces.

Signed-off-by: Casey Schaufler &lt;casey@xxxxxxxxxxxxxxxx&gt;
---
 kernel/audit.h   |  6 +++---
 kernel/auditsc.c | 38 +++++++++++---------------------------
 2 files changed, 14 insertions(+), 30 deletions(-)

diff --git a/kernel/audit.h b/kernel/audit.h
index 29e29c6f4afb..a8dd479e9556 100644
--- a/kernel/audit.h
+++ b/kernel/audit.h
@@ -91,7 +91,7 @@ struct audit_names {
 	kuid_t			uid;
 	kgid_t			gid;
 	dev_t			rdev;
-	u32			osid;
+	struct lsmblob		olsm;
 	struct audit_cap_data	fcap;
 	unsigned int		fcap_ver;
 	unsigned char		type;		/* record type */
@@ -148,7 +148,7 @@ struct audit_context {
 	kuid_t		    target_auid;
 	kuid_t		    target_uid;
 	unsigned int	    target_sessionid;
-	struct lsmblob   target_lsm;
+	struct lsmblob	    target_lsm;
 	char		    target_comm[TASK_COMM_LEN];
 
 	struct audit_tree_refs *trees, *first_trees;
@@ -165,7 +165,7 @@ struct audit_context {
 			kuid_t			uid;
 			kgid_t			gid;
 			umode_t			mode;
-			u32			osid;
+			struct lsmblob		olsm;
 			int			has_perm;
 			uid_t			perm_uid;
 			gid_t			perm_gid;
diff --git a/kernel/auditsc.c b/kernel/auditsc.c
index 0478680cd0a8..d3ad13f11788 100644
--- a/kernel/auditsc.c
+++ b/kernel/auditsc.c
@@ -646,17 +646,15 @@ static int audit_filter_rules(struct task_struct *tsk,
 			if (f-&gt;lsm_rule) {
 				/* Find files that match */
 				if (name) {
-					lsmblob_init(&amp;blob, name-&gt;osid);
 					result = security_audit_rule_match(
-								&amp;blob,
+								&amp;name-&gt;olsm,
 								f-&gt;type,
 								f-&gt;op,
 								f-&gt;lsm_rule);
 				} else if (ctx) {
 					list_for_each_entry(n, &amp;ctx-&gt;names_list, list) {
-						lsmblob_init(&amp;blob, n-&gt;osid);
 						if (security_audit_rule_match(
-								&amp;blob,
+								&amp;n-&gt;olsm,
 								f-&gt;type,
 								f-&gt;op,
 								f-&gt;lsm_rule)) {
@@ -668,8 +666,7 @@ static int audit_filter_rules(struct task_struct *tsk,
 				/* Find ipc objects that match */
 				if (!ctx || ctx-&gt;type != AUDIT_IPC)
 					break;
-				lsmblob_init(&amp;blob, ctx-&gt;ipc.osid);
-				if (security_audit_rule_match(&amp;blob,
+				if (security_audit_rule_match(&amp;ctx-&gt;ipc.olsm,
 							      f-&gt;type, f-&gt;op,
 							      f-&gt;lsm_rule))
 					++result;
@@ -1187,21 +1184,18 @@ static void show_special(struct audit_context *context, int *call_panic)
 				context-&gt;socketcall.args[i]);
 		break; }
 	case AUDIT_IPC: {
-		u32 osid = context-&gt;ipc.osid;
+		struct lsmblob *olsm = &amp;context-&gt;ipc.olsm;
 
 		audit_log_format(ab, &quot;ouid=%u ogid=%u mode=%#ho&quot;,
 				 from_kuid(&amp;init_user_ns, context-&gt;ipc.uid),
 				 from_kgid(&amp;init_user_ns, context-&gt;ipc.gid),
 				 context-&gt;ipc.mode);
-		if (osid) {
+		if (lsmblob_is_set(olsm)) {
 			struct lsmcontext lsmcxt;
-			struct lsmblob blob;
 
-			lsmblob_init(&amp;blob, osid);
-			if (security_secid_to_secctx(&amp;blob, &amp;lsmcxt)) {
-				audit_log_format(ab, &quot; osid=%u&quot;, osid);
+			if (security_secid_to_secctx(olsm, &amp;lsmcxt))
 				*call_panic = 1;
-			} else {
+			else {
 				audit_log_format(ab, &quot; obj=%s&quot;, lsmcxt.context);
 				security_release_secctx(&amp;lsmcxt);
 			}
@@ -1346,13 +1340,10 @@ static void audit_log_name(struct audit_context *context, struct audit_names *n,
 				 from_kgid(&amp;init_user_ns, n-&gt;gid),
 				 MAJOR(n-&gt;rdev),
 				 MINOR(n-&gt;rdev));
-	if (n-&gt;osid != 0) {
-		struct lsmblob blob;
+	if (lsmblob_is_set(&amp;n-&gt;olsm)) {
 		struct lsmcontext lsmctx;
 
-		lsmblob_init(&amp;blob, n-&gt;osid);
-		if (security_secid_to_secctx(&amp;blob, &amp;lsmctx)) {
-			audit_log_format(ab, &quot; osid=%u&quot;, n-&gt;osid);
+		if (security_secid_to_secctx(&amp;n-&gt;olsm, &amp;lsmctx)) {
 			if (call_panic)
 				*call_panic = 2;
 		} else {
@@ -1906,17 +1897,13 @@ static inline int audit_copy_fcaps(struct audit_names *name,
 void audit_copy_inode(struct audit_names *name, const struct dentry *dentry,
 		      struct inode *inode, unsigned int flags)
 {
-	struct lsmblob blob;
-
 	name-&gt;ino   = inode-&gt;i_ino;
 	name-&gt;dev   = inode-&gt;i_sb-&gt;s_dev;
 	name-&gt;mode  = inode-&gt;i_mode;
 	name-&gt;uid   = inode-&gt;i_uid;
 	name-&gt;gid   = inode-&gt;i_gid;
 	name-&gt;rdev  = inode-&gt;i_rdev;
-	security_inode_getsecid(inode, &amp;blob);
-	/* scaffolding until osid is updated */
-	name-&gt;osid = blob.secid[0];
+	security_inode_getsecid(inode, &amp;name-&gt;olsm);
 	if (flags &amp; AUDIT_INODE_NOEVAL) {
 		name-&gt;fcap_ver = -1;
 		return;
@@ -2266,14 +2253,11 @@ void __audit_mq_getsetattr(mqd_t mqdes, struct mq_attr *mqstat)
 void __audit_ipc_obj(struct kern_ipc_perm *ipcp)
 {
 	struct audit_context *context = audit_context();
-	struct lsmblob blob;
 	context-&gt;ipc.uid = ipcp-&gt;uid;
 	context-&gt;ipc.gid = ipcp-&gt;gid;
 	context-&gt;ipc.mode = ipcp-&gt;mode;
 	context-&gt;ipc.has_perm = 0;
-	security_ipc_getsecid(ipcp, &amp;blob);
-	/* scaffolding on the [0] - change &quot;osid&quot; to a lsmblob */
-	context-&gt;ipc.osid = blob.secid[0];
+	security_ipc_getsecid(ipcp, &amp;context-&gt;ipc.olsm);
 	context-&gt;type = AUDIT_IPC;
 }
 
-- 
2.20.1



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="29301" href="msg29301.html">Re: [PATCH v3 21/24] Audit: Store LSM audit information in an lsmblob</a></strong>
<ul><li><em>From:</em> John Johansen</li></ul></li>
<li><strong><a name="29234" href="msg29234.html">Re: [PATCH v3 21/24] Audit: Store LSM audit information in an lsmblob</a></strong>
<ul><li><em>From:</em> Kees Cook</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="29154" href="msg29154.html">[PATCH v3 00/24] LSM: Module stacking for AppArmor</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg29172.html">[PATCH v3 18/24] LSM: Use lsmcontext in security_dentry_init_security</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg29174.html">[PATCH v3 20/24] LSM: security_secid_to_secctx in netlink netfilter</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg29307.html">[PATCH v3 18/24] LSM: Use lsmcontext in security_dentry_init_security</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg29234.html">Re: [PATCH v3 21/24] Audit: Store LSM audit information in an lsmblob</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#29173"><strong>Date</strong></a></li>
<li><a href="index.html#29173"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

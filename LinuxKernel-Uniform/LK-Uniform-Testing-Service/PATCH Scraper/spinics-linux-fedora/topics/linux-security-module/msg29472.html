<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH bpf&#45;next v9 05/10] bpf,landlock: Add a new map type: inode -->
<!--X-From-R13: Oy Hveb &#60;ivebNmravi.yvahk.bet.hx> -->
<!--X-Date: Thu, 27 Jun 2019 09:57:32 &#45;0700 -->
<!--X-Message-Id: 20190627165640.GQ17978@ZenIV.linux.org.uk -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190625215239.11136&#45;1&#45;mic@digikod.net -->
<!--X-Reference: 20190625215239.11136&#45;6&#45;mic@digikod.net -->
<!--X-Reference: 20190625225201.GJ17978@ZenIV.linux.org.uk -->
<!--X-Reference: 79bac827&#45;4092&#45;8a4d&#45;9dc6&#45;6019419b2486@ssi.gouv.fr -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Linux Security Module, Re: [PATCH bpf-next v9 05/10] bpf,landlock: Add a new map type: inode">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Linux Security Module -- Re: [PATCH bpf-next v9 05/10] bpf,landlock: Add a new map type: inode</title>
<link rel="alternate" type="application/rss+xml" title="Linux Security Module" href="//feeds.feedburner.com/LinuxSecurityModule">
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH bpf-next v9 05/10] bpf,landlock: Add a new map type: inode</h1>
[<a href="msg29471.html">Date Prev</a>][<a href="msg29473.html">Date Next</a>][<a href="msg29468.html">Thread Prev</a>][<a href="msg29545.html">Thread Next</a>][<a href="maillist.html#29472">Date Index</a>][<a href="index.html#29472">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH bpf-next v9 05/10] bpf,landlock: Add a new map type: inode</li>
<li><em>From</em>: Al Viro &lt;viro@xxxxxxxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 27 Jun 2019 17:56:40 +0100</li>
<li><em>Cc</em>: Micka&#xEB;l Sala&#xFC;n &lt;mic@xxxxxxxxxxx&gt;,        linux-kernel@xxxxxxxxxxxxxxx, Aleksa Sarai &lt;cyphar@xxxxxxxxxx&gt;,        Alexei Starovoitov &lt;ast@xxxxxxxxxx&gt;,        Andrew Morton &lt;akpm@xxxxxxxxxxxxxxxxxxxx&gt;,        Andy Lutomirski &lt;luto@xxxxxxxxxxxxxx&gt;,        Arnaldo Carvalho de Melo &lt;acme@xxxxxxxxxx&gt;,        Casey Schaufler &lt;casey@xxxxxxxxxxxxxxxx&gt;,        Daniel Borkmann &lt;daniel@xxxxxxxxxxxxx&gt;,        David Drysdale &lt;drysdale@xxxxxxxxxx&gt;,        &quot;David S . Miller&quot; &lt;davem@xxxxxxxxxxxxx&gt;,        &quot;Eric W . Biederman&quot; &lt;ebiederm@xxxxxxxxxxxx&gt;,        James Morris &lt;jmorris@xxxxxxxxx&gt;, Jann Horn &lt;jann@xxxxxxxxx&gt;,        John Johansen &lt;john.johansen@xxxxxxxxxxxxx&gt;,        Jonathan Corbet &lt;corbet@xxxxxxx&gt;, Kees Cook &lt;keescook@xxxxxxxxxxxx&gt;,        Michael Kerrisk &lt;mtk.manpages@xxxxxxxxx&gt;,        Paul Moore &lt;paul@xxxxxxxxxxxxxx&gt;, Sargun Dhillon &lt;sargun@xxxxxxxxx&gt;,        &quot;Serge E . Hallyn&quot; &lt;serge@xxxxxxxxxx&gt;, Shuah Khan &lt;shuah@xxxxxxxxxx&gt;,        Stephen Smalley &lt;sds@xxxxxxxxxxxxx&gt;, Tejun Heo &lt;tj@xxxxxxxxxx&gt;,        Tetsuo Handa &lt;penguin-kernel@xxxxxxxxxxxxxxxxxxx&gt;,        Thomas Graf &lt;tgraf@xxxxxxx&gt;, Tycho Andersen &lt;tycho@xxxxxxxx&gt;,        Will Drewry &lt;wad@xxxxxxxxxxxx&gt;, kernel-hardening@xxxxxxxxxxxxxxxxxx,        linux-api@xxxxxxxxxxxxxxx, linux-fsdevel@xxxxxxxxxxxxxxx,        linux-security-module@xxxxxxxxxxxxxxx, netdev@xxxxxxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg29468.html">79bac827-4092-8a4d-9dc6-6019419b2486@ssi.gouv.fr</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg29352.html">20190625215239.11136-1-mic@digikod.net</a>&gt; &lt;<a href="msg29353.html">20190625215239.11136-6-mic@digikod.net</a>&gt; &lt;<a href="msg29354.html">20190625225201.GJ17978@ZenIV.linux.org.uk</a>&gt; &lt;<a href="msg29468.html">79bac827-4092-8a4d-9dc6-6019419b2486@ssi.gouv.fr</a>&gt;</li>
<li><em>User-agent</em>: Mutt/1.11.3 (2019-02-01)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Thu, Jun 27, 2019 at 06:18:12PM +0200, Micka&#xEB;l Sala&#xFC;n wrote:

&gt; &gt;&gt; +/* called from syscall */
&gt; &gt;&gt; +static int sys_inode_map_delete_elem(struct bpf_map *map, struct inode *key)
&gt; &gt;&gt; +{
&gt; &gt;&gt; +    struct inode_array *array = container_of(map, struct inode_array, map);
&gt; &gt;&gt; +    struct inode *inode;
&gt; &gt;&gt; +    int i;
&gt; &gt;&gt; +
&gt; &gt;&gt; +    WARN_ON_ONCE(!rcu_read_lock_held());
&gt; &gt;&gt; +    for (i = 0; i &lt; array-&gt;map.max_entries; i++) {
&gt; &gt;&gt; +            if (array-&gt;elems[i].inode == key) {
&gt; &gt;&gt; +                    inode = xchg(&amp;array-&gt;elems[i].inode, NULL);
&gt; &gt;&gt; +                    array-&gt;nb_entries--;
&gt; &gt;
&gt; &gt; Umm...  Is that intended to be atomic in any sense?
&gt; 
&gt; nb_entries is not used as a bound check but to avoid walking uselessly
&gt; through the (pre-allocated) array when adding a new element, but I'll
&gt; use an atomic to avoid inconsistencies anyway.


&gt; &gt; Wait a sec...  So we have those beasties that can have long-term
&gt; &gt; references to arbitrary inodes stuck in them?  What will happen
&gt; &gt; if you get umount(2) called while such a thing exists?
&gt; 
&gt; I though an umount would be denied but no, we get a self-destructed busy
&gt; inode and a bug!
&gt; What about wrapping the inode's superblock-&gt;s_op-&gt;destroy_inode() to
&gt; first remove the element from the map and then call the real
&gt; destroy_inode(), if any?

What do you mean, _the_ map?  I don't see anything to prevent insertion
of references to the same inode into any number of those...

&gt; Or I could update fs/inode.c:destroy_inode() to call inode-&gt;free_inode()
&gt; if it is set, and set it when such inode is referenced by a map?
&gt; Or maybe I could hold the referencing file in the map and then wrap its
&gt; f_op?

First of all, anything including the word &quot;wrap&quot; is a non-starter.
We really don't need the headache associated with the locking needed
to replace the method tables on the fly, or with the code checking that
-&gt;f_op points to given method table, etc.  That's not going to fly,
especially since you'd end up _chaining_ those (again, the same reference
can go in more than once).

Nothing is allowed to change the method tables of live objects, period.
Once a struct file is opened, its -&gt;f_op is never going to change and
it entirely belongs to the device driver or filesystem it resides on.
Nothing else (not VFS, not VM, not some LSM module, etc.) has any business
touching that.  The same goes for inodes, dentries, etc.

What kind of behaviour do you want there?  Do you want the inodes you've
referenced there to be forgotten on e.g. memory pressure?  The thing is,
I don't see how &quot;it's getting freed&quot; could map onto any semantics that
might be useful for you - it looks like the wrong event for that.


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="29545" href="msg29545.html">Re: [PATCH bpf-next v9 05/10] bpf,landlock: Add a new map type: inode</a></strong>
<ul><li><em>From:</em> Micka&#xEB;l Sala&#xFC;n</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="29352" href="msg29352.html">[PATCH bpf-next v9 00/10] Landlock LSM: Toward unprivileged sandboxing</a></strong>
<ul><li><em>From:</em> Micka&#xEB;l Sala&#xFC;n</li></ul></li>
<li><strong><a name="29353" href="msg29353.html">[PATCH bpf-next v9 05/10] bpf,landlock: Add a new map type: inode</a></strong>
<ul><li><em>From:</em> Micka&#xEB;l Sala&#xFC;n</li></ul></li>
<li><strong><a name="29354" href="msg29354.html">Re: [PATCH bpf-next v9 05/10] bpf,landlock: Add a new map type: inode</a></strong>
<ul><li><em>From:</em> Al Viro</li></ul></li>
<li><strong><a name="29468" href="msg29468.html">Re: [PATCH bpf-next v9 05/10] bpf,landlock: Add a new map type: inode</a></strong>
<ul><li><em>From:</em> Micka&#xEB;l Sala&#xFC;n</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg29471.html">Re: [PATCH v9 1/2] mm: security: introduce init_on_alloc=1 and init_on_free=1 boot options</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg29473.html">Re: [PATCH v4 00/23] LSM: Module stacking for AppArmor</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg29468.html">Re: [PATCH bpf-next v9 05/10] bpf,landlock: Add a new map type: inode</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg29545.html">Re: [PATCH bpf-next v9 05/10] bpf,landlock: Add a new map type: inode</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#29472"><strong>Date</strong></a></li>
<li><a href="index.html#29472"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

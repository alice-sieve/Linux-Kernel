<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH v3 00/24] LSM: Module stacking for AppArmor -->
<!--X-From-R13: Qnfrl Epunhsyre &#60;pnfrlNfpunhsyre&#45;pn.pbz> -->
<!--X-Date: Fri, 21 Jun 2019 11:52:41 &#45;0700 -->
<!--X-Message-Id: 20190621185233.6766&#45;1&#45;casey@schaufler&#45;ca.com -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Linux Security Module, [PATCH v3 00/24] LSM: Module stacking for AppArmor">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Linux Security Module -- [PATCH v3 00/24] LSM: Module stacking for AppArmor</title>
<link rel="alternate" type="application/rss+xml" title="Linux Security Module" href="//feeds.feedburner.com/LinuxSecurityModule">
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH v3 00/24] LSM: Module stacking for AppArmor</h1>
[<a href="msg29153.html">Date Prev</a>][<a href="msg29155.html">Date Next</a>][<a href="msg29117.html">Thread Prev</a>][<a href="msg29155.html">Thread Next</a>][<a href="maillist.html#29154">Date Index</a>][<a href="index.html#29154">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH v3 00/24] LSM: Module stacking for AppArmor</li>
<li><em>From</em>: Casey Schaufler &lt;casey@xxxxxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Fri, 21 Jun 2019 11:52:09 -0700</li>
<li><em>Cc</em>: casey@xxxxxxxxxxxxxxxx, keescook@xxxxxxxxxxxx,        john.johansen@xxxxxxxxxxxxx, penguin-kernel@xxxxxxxxxxxxxxxxxxx,        paul@xxxxxxxxxxxxxx, sds@xxxxxxxxxxxxx</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>This patchset provides the changes required for
the AppArmor security module to stack safely with any other.

v3: Incorporate feedback from v2
    - Make lsmblob parameter and variable names more
      meaningful, changing &quot;le&quot; and &quot;l&quot; to &quot;blob&quot;.
    - Improve consistency of constant naming.
    - Do more sanity checking during LSM initialization.
    - Be a bit clearer about what is temporary scaffolding.
    - Rather than clutter security_getpeersec_dgram with
      otherwise unnecessary checks remove the apparmor
      stub, which does nothing useful.

Patches 0001-0003 complete the process of moving managment
of security blobs that might be shared from the individual
modules to the infrastructure.

Patches 0004-0014 replace system use of a &quot;secid&quot; with
a structure &quot;lsmblob&quot; containing information from the
security modules to be held and reused later. At this
point lsmblob contains an array of u32 secids, one &quot;slot&quot;
for each of the security modules compiled into the
kernel that used secids. A &quot;slot&quot; is allocated when
a security module registers a hook for one of the interfaces
that uses a secid or a security context. The infrastructure
is changed to use the slot number to pass the correct
secid to or from the security module hooks.

It is important that the lsmblob be a fixed size entity
that does not have to be allocated. Several of the places
where it is used would have performance and/or locking
issues with dynamic allocation.

Patch 0015 provides a mechanism for a process to
identify which security module's hooks should be used
when displaying or converting a security context string.
A new interface /proc/.../attr/display contains the name
of the security module to show. Reading from this file
will present the name of the module, while writing to
it will set the value. Only names of active security
modules are accepted. Internally, the name is translated
to the appropriate &quot;slot&quot; number for the module which
is then stored in the task security blob.

Patch 0016 Starts the process of changing how a security
context is represented. Since it is possible for a
security context to have been generated by more than one
security module it is now necessary to note which module
created a security context so that the correct &quot;release&quot;
hook can be called. There are several places where the
module that created a security context cannot be inferred.

This is achieved by introducing a &quot;lsmcontext&quot; structure
which contains the context string, its length and the
&quot;slot&quot; number of the security module that created it.
The security_release_secctx() interface is changed,
replacing the (string,len) pointer pair with a lsmcontext
pointer.

Patches 0012-0021 convert the security interfaces from
(string,len) pointer pairs to a lsmcontext pointer.
The slot number identifying the creating module is
added by the infrastructure. Where the security context
is stored for extended periods the data type is changed.

Patch 0022 provides a simple way for a security module
to know its &quot;slot&quot; number. The security_add_hooks()
initialization function returns the slot number, and the
security module need but stash the value for later use,
as is required by the Netlabel subsystem. The Netlabel
code is converted to save lsmblob structures instead
of secids in Patch 0023.

Finally, with all interference on the AppArmor hooks
removed, Patch 0024 removes the exclusive bit from
AppArmor. An unnecessary stub hook was also removed.

The Ubuntu project is using an earlier version of
this patchset in their distribution to enable stacking
for containers.

Performance measurements to date have the change
within the &quot;noise&quot;. Better benchmarks are in the
works.

<a  rel="nofollow" href="https://github.com/cschaufler/lsm-stacking.git#stack-5.2-v3-apparmor">https://github.com/cschaufler/lsm-stacking.git#stack-5.2-v3-apparmor</a>

Signed-off-by: Casey Schaufler &lt;casey@xxxxxxxxxxxxxxxx&gt;
---
 drivers/android/binder.c                |  24 +-
 fs/kernfs/dir.c                         |   5 +-
 fs/kernfs/inode.c                       |  35 ++-
 fs/kernfs/kernfs-internal.h             |   3 +-
 fs/nfs/nfs4proc.c                       |  22 +-
 fs/nfsd/nfs4xdr.c                       |  20 +-
 fs/proc/base.c                          |   1 +
 include/linux/cred.h                    |   3 +-
 include/linux/lsm_hooks.h               |   8 +-
 include/linux/security.h                | 165 ++++++++++---
 include/net/af_unix.h                   |   2 +-
 include/net/netlabel.h                  |   8 +-
 include/net/scm.h                       |  14 +-
 kernel/audit.c                          |  34 +--
 kernel/audit.h                          |   9 +-
 kernel/auditfilter.c                    |   6 +-
 kernel/auditsc.c                        |  79 +++----
 kernel/cred.c                           |  12 +-
 net/ipv4/cipso_ipv4.c                   |   6 +-
 net/ipv4/ip_sockglue.c                  |  12 +-
 net/netfilter/nf_conntrack_netlink.c    |  20 +-
 net/netfilter/nf_conntrack_standalone.c |  11 +-
 net/netfilter/nfnetlink_queue.c         |  26 ++-
 net/netfilter/nft_meta.c                |  13 +-
 net/netfilter/xt_SECMARK.c              |   5 +-
 net/netlabel/netlabel_kapi.c            |   6 +-
 net/netlabel/netlabel_unlabeled.c       |  95 ++++----
 net/netlabel/netlabel_unlabeled.h       |   2 +-
 net/netlabel/netlabel_user.c            |  13 +-
 net/netlabel/netlabel_user.h            |   6 +-
 net/unix/af_unix.c                      |   6 +-
 security/apparmor/include/net.h         |   6 +-
 security/apparmor/lsm.c                 |  66 ++----
 security/integrity/ima/ima.h            |  14 +-
 security/integrity/ima/ima_api.c        |   9 +-
 security/integrity/ima/ima_appraise.c   |   6 +-
 security/integrity/ima/ima_main.c       |  36 +--
 security/integrity/ima/ima_policy.c     |  19 +-
 security/security.c                     | 396 ++++++++++++++++++++++++++++----
 security/selinux/hooks.c                | 164 ++++++-------
 security/selinux/include/objsec.h       |  18 ++
 security/selinux/include/security.h     |   1 +
 security/selinux/netlabel.c             |  25 +-
 security/selinux/ss/services.c          |   7 +-
 security/smack/smack.h                  |  19 ++
 security/smack/smack_lsm.c              | 154 ++++++-------
 security/smack/smack_netfilter.c        |   8 +-
 security/smack/smackfs.c                |  10 +-
 48 files changed, 1017 insertions(+), 612 deletions(-)


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="29178" href="msg29178.html">[PATCH v3 02/24] LSM: Infrastructure management of the sock security</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29177" href="msg29177.html">[PATCH v3 23/24] NET: Store LSM netlabel data in a lsmblob</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29176" href="msg29176.html">[PATCH v3 24/24] AppArmor: Remove the exclusive flag</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29175" href="msg29175.html">[PATCH v3 22/24] LSM: Return the lsmblob slot on initialization</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29174" href="msg29174.html">[PATCH v3 20/24] LSM: security_secid_to_secctx in netlink netfilter</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29173" href="msg29173.html">[PATCH v3 21/24] Audit: Store LSM audit information in an lsmblob</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29172" href="msg29172.html">[PATCH v3 18/24] LSM: Use lsmcontext in security_dentry_init_security</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29171" href="msg29171.html">[PATCH v3 19/24] LSM: Use lsmcontext in security_inode_getsecctx</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29170" href="msg29170.html">[PATCH v3 15/24] LSM: Specify which LSM to display</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29169" href="msg29169.html">[PATCH v3 16/24] LSM: Ensure the correct LSM context releaser</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29168" href="msg29168.html">[PATCH v3 17/24] LSM: Use lsmcontext in security_secid_to_secctx</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29167" href="msg29167.html">[PATCH v3 14/24] IMA: Change internal interfaces to use lsmblobs</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29166" href="msg29166.html">[PATCH v3 13/24] LSM: Use lsmblob in security_cred_getsecid</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29165" href="msg29165.html">[PATCH v3 11/24] LSM: Use lsmblob in security_task_getsecid</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29164" href="msg29164.html">[PATCH v3 12/24] LSM: Use lsmblob in security_inode_getsecid</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29163" href="msg29163.html">[PATCH v3 10/24] Use lsmblob in security_ipc_getsecid</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29162" href="msg29162.html">[PATCH v3 09/24] LSM: Use lsmblob in security_secid_to_secctx</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29161" href="msg29161.html">[PATCH v3 06/24] LSM: Use lsmblob in security_kernel_act_as</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29160" href="msg29160.html">[PATCH v3 08/24] LSM: Use lsmblob in security_secctx_to_secid</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29159" href="msg29159.html">[PATCH v3 05/24] Use lsmblob in security_audit_rule_match</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29158" href="msg29158.html">[PATCH v3 07/24] net: Prepare UDS for secuirty module stacking</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29157" href="msg29157.html">[PATCH v3 04/24] LSM: Create and manage the lsmblob data structure.</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29156" href="msg29156.html">[PATCH v3 03/24] LSM: Infrastructure management of the key blob</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29155" href="msg29155.html">[PATCH v3 01/24] LSM: Infrastructure management of the superblock</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg29153.html">RE: [RFC PATCH v4 12/12] LSM: x86/sgx: Show line of sight to LSM support SGX2's EAUG</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg29155.html">[PATCH v3 01/24] LSM: Infrastructure management of the superblock</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg29117.html">[RFC PATCH v4 00/12] security: x86/sgx: SGX vs. LSM</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg29155.html">[PATCH v3 01/24] LSM: Infrastructure management of the superblock</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#29154"><strong>Date</strong></a></li>
<li><a href="index.html#29154"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH v2 2/4] devfreq: exynos&#45;bus: convert to use dev_pm_opp_set_rate() -->
<!--X-From-R13: Pnegybzvrw Lbyavrexvrjvpm &#60;o.mbyavrexvrNfnzfhat.pbz> -->
<!--X-Date: Tue, 16 Jul 2019 03:17:09 &#45;0700 -->
<!--X-Message-Id: 3d1687b7&#45;4825&#45;ad82&#45;2706&#45;a712c30e530b@samsung.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190715120416.3561&#45;1&#45;k.konieczny@partner.samsung.com -->
<!--X-Reference: CGME20190715120431eucas1p215eae81d0ca772d7e2a22a803669068a@eucas1p2.samsung.com -->
<!--X-Reference: 20190715120416.3561&#45;3&#45;k.konieczny@partner.samsung.com -->
<!--X-Reference: 7f7cf551&#45;005a&#45;c647&#45;d571&#45;77eb5426478a@samsung.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<meta name="description" content="Linux ARM, OMAP, Xscale Kernel: Re: [PATCH v2 2/4] devfreq: exynos-bus: convert to use dev_pm_opp_set_rate()">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Re: [PATCH v2 2/4] devfreq: exynos-bus: convert to use dev_pm_opp_set_rate() &mdash; ARM, OMAP, Xscale Linux Kernel</title>
<link rel="alternate" type="application/rss+xml" title="Linux ARM Kernel" href="//feedproxy.google.com/LinuxArmKernel">
<link rel="alternate" type="application/rss+xml" title="Linux ARM Kernel" href="//feeds.feedburner.com/LinuxArmxscaleEtc">
<link rel="alternate" type="application/rss+xml" title="Fedora ARM" href="//feeds.feedburner.com/FedoraArm">
<link rel="alternate" type="application/rss+xml" title="Linux for OMAP" href="//feedproxy.google.com/LinuxOmap">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<td align=right><form action="//www.google.com/cse" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:isdiegq275o" />
    <input type="hidden" name="ie" value="ISO-8859-1" />
    <input type="text" name="q" size="37" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/cse/brand?form=cse-search-box&amp;lang=en" async></script>
<h1 itemprop="name">Re: [PATCH v2 2/4] devfreq: exynos-bus: convert to use dev_pm_opp_set_rate()</h1>
[<a href="msg741293.html">Date Prev</a>][<a href="msg741295.html">Date Next</a>][<a href="msg741240.html">Thread Prev</a>][<a href="msg741300.html">Thread Next</a>][<a href="maillist.html#741294">Date Index</a>][<a href="threads.html#741294">Thread Index</a>] 
<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH v2 2/4] devfreq: exynos-bus: convert to use dev_pm_opp_set_rate()</li>
<li><em>From</em>: Bartlomiej Zolnierkiewicz &lt;b.zolnierkie@xxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 16 Jul 2019 12:13:12 +0200</li>
<li><em>Cms-type</em>: 201P</li>
<li><em>In-reply-to</em>: &lt;<a href="msg741240.html">7f7cf551-005a-c647-d571-77eb5426478a@samsung.com</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Thunderbird/60.6.1</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>
Hi Chanwoo,

On 7/16/19 5:56 AM, Chanwoo Choi wrote:
&gt;<i> Hi Kamil,</i>
&gt;<i> </i>
&gt;<i> Looks good to me. But, this patch has some issue.</i>
&gt;<i> I added the detailed reviews.</i>
&gt;<i> </i>
&gt;<i> I recommend that you make the separate patches as following</i>
&gt;<i> in order to clarify the role of which apply the dev_pm_opp_* function.</i>
&gt;<i> </i>
&gt;<i> First patch,</i>
&gt;<i> Need to consolidate the following two function into one function.</i>
&gt;<i> because the original exynos-bus.c has the problem that the regulator</i>
&gt;<i> of parent devfreq device have to be enabled before enabling the clock.</i>
&gt;<i> This issue did not happen because bootloader enables the bus-related</i>
&gt;<i> regulators before kernel booting.</i>
&gt;<i> - exynos_bus_parse_of()</i>
&gt;<i> - exynos_bus_parent_parse_of()</i>
&gt;<i> &gt; Second patch,</i>
&gt;<i> Apply dev_pm_opp_set_regulators() and dev_pm_opp_set_rate()</i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i> On 19. 7. 15. &#xC624;&#xD6C4; 9:04, Kamil Konieczny wrote:</i>
&gt;<i>&gt; Reuse opp core code for setting bus clock and voltage. As a side</i>
&gt;<i>&gt; effect this allow useage of coupled regulators feature (required</i>
&gt;<i>&gt; for boards using Exynos5422/5800 SoCs) because dev_pm_opp_set_rate()</i>
&gt;<i>&gt; uses regulator_set_voltage_triplet() for setting regulator voltage</i>
&gt;<i>&gt; while the old code used regulator_set_voltage_tol() with fixed</i>
&gt;<i>&gt; tolerance. This patch also removes no longer needed parsing of DT</i>
&gt;<i>&gt; property &quot;exynos,voltage-tolerance&quot; (no Exynos devfreq DT node uses</i>
&gt;<i>&gt; it).</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; Signed-off-by: Kamil Konieczny &lt;k.konieczny@xxxxxxxxxxxxxxxxxxx&gt;</i>
&gt;<i>&gt; ---</i>
&gt;<i>&gt;  drivers/devfreq/exynos-bus.c | 172 ++++++++++++++---------------------</i>
&gt;<i>&gt;  1 file changed, 66 insertions(+), 106 deletions(-)</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; diff --git a/drivers/devfreq/exynos-bus.c b/drivers/devfreq/exynos-bus.c</i>
&gt;<i>&gt; index 486cc5b422f1..7fc4f76bd848 100644</i>
&gt;<i>&gt; --- a/drivers/devfreq/exynos-bus.c</i>
&gt;<i>&gt; +++ b/drivers/devfreq/exynos-bus.c</i>
&gt;<i>&gt; @@ -25,7 +25,6 @@</i>
&gt;<i>&gt;  #include &lt;linux/slab.h&gt;</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt;  #define DEFAULT_SATURATION_RATIO	40</i>
&gt;<i>&gt; -#define DEFAULT_VOLTAGE_TOLERANCE	2</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt;  struct exynos_bus {</i>
&gt;<i>&gt;  	struct device *dev;</i>
&gt;<i>&gt; @@ -37,9 +36,9 @@ struct exynos_bus {</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt;  	unsigned long curr_freq;</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt; -	struct regulator *regulator;</i>
&gt;<i>&gt; +	struct opp_table *opp_table;</i>
&gt;<i>&gt; +</i>
&gt;<i>&gt;  	struct clk *clk;</i>
&gt;<i>&gt; -	unsigned int voltage_tolerance;</i>
&gt;<i>&gt;  	unsigned int ratio;</i>
&gt;<i>&gt;  };</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt; @@ -99,56 +98,25 @@ static int exynos_bus_target(struct device *dev, unsigned long *freq, u32 flags)</i>
&gt;<i>&gt;  {</i>
&gt;<i>&gt;  	struct exynos_bus *bus = dev_get_drvdata(dev);</i>
&gt;<i>&gt;  	struct dev_pm_opp *new_opp;</i>
&gt;<i>&gt; -	unsigned long old_freq, new_freq, new_volt, tol;</i>
&gt;<i>&gt;  	int ret = 0;</i>
&gt;<i>&gt; -</i>
&gt;<i>&gt; -	/* Get new opp-bus instance according to new bus clock */</i>
&gt;<i>&gt; +	/*</i>
&gt;<i>&gt; +	 * New frequency for bus may not be exactly matched to opp, adjust</i>
&gt;<i>&gt; +	 * *freq to correct value.</i>
&gt;<i>&gt; +	 */</i>
&gt;<i> </i>
&gt;<i> You better to change this comment with following styles</i>
&gt;<i> to keep the consistency:</i>
&gt;<i> </i>
&gt;<i> 	/* Get correct frequency for bus ... */</i>
&gt;<i> </i>
&gt;<i>&gt;  	new_opp = devfreq_recommended_opp(dev, freq, flags);</i>
&gt;<i>&gt;  	if (IS_ERR(new_opp)) {</i>
&gt;<i>&gt;  		dev_err(dev, &quot;failed to get recommended opp instance\n&quot;);</i>
&gt;<i>&gt;  		return PTR_ERR(new_opp);</i>
&gt;<i>&gt;  	}</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt; -	new_freq = dev_pm_opp_get_freq(new_opp);</i>
&gt;<i>&gt; -	new_volt = dev_pm_opp_get_voltage(new_opp);</i>
&gt;<i>&gt;  	dev_pm_opp_put(new_opp);</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt; -	old_freq = bus-&gt;curr_freq;</i>
&gt;<i>&gt; -</i>
&gt;<i>&gt; -	if (old_freq == new_freq)</i>
&gt;<i>&gt; -		return 0;</i>
&gt;<i>&gt; -	tol = new_volt * bus-&gt;voltage_tolerance / 100;</i>
&gt;<i>&gt; -</i>
&gt;<i>&gt;  	/* Change voltage and frequency according to new OPP level */</i>
&gt;<i>&gt;  	mutex_lock(&amp;bus-&gt;lock);</i>
&gt;<i>&gt; +	ret = dev_pm_opp_set_rate(dev, *freq);</i>
&gt;<i>&gt; +	if (!ret)</i>
&gt;<i>&gt; +		bus-&gt;curr_freq = *freq;</i>
&gt;<i> </i>
&gt;<i> Have to print the error log if ret has minus error value.</i>

dev_pm_opp_set_rate() should print the error message on all
errors so wouldn't printing the error log also here be superfluous?

[ Please also note that the other user of dev_pm_opp_set_rate()
  (cpufreq-dt cpufreq driver) doesn't do this. ]

&gt;<i> Modify it as following:</i>
&gt;<i> </i>
&gt;<i> 	if (ret &lt; 0) {</i>
&gt;<i> 		dev_err(dev, &quot;failed to set bus rate\n&quot;);</i>
&gt;<i> 		goto err:</i>
&gt;<i> 	}</i>
&gt;<i> 	bus-&gt;curr_freq = *freq;</i>
&gt;<i> </i>
&gt;<i> err:</i>
&gt;<i> 	mutex_unlock(&amp;bus-&gt;lock);</i>
&gt;<i> 	</i>
&gt;<i> 	return ret;</i>
&gt;<i> </i>
&gt;<i>&gt;  </i>
&gt;<i>&gt; -	if (old_freq &lt; new_freq) {</i>
&gt;<i>&gt; -		ret = regulator_set_voltage_tol(bus-&gt;regulator, new_volt, tol);</i>
&gt;<i>&gt; -		if (ret &lt; 0) {</i>
&gt;<i>&gt; -			dev_err(bus-&gt;dev, &quot;failed to set voltage\n&quot;);</i>
&gt;<i>&gt; -			goto out;</i>
&gt;<i>&gt; -		}</i>
&gt;<i>&gt; -	}</i>
&gt;<i>&gt; -</i>
&gt;<i>&gt; -	ret = clk_set_rate(bus-&gt;clk, new_freq);</i>
&gt;<i>&gt; -	if (ret &lt; 0) {</i>
&gt;<i>&gt; -		dev_err(dev, &quot;failed to change clock of bus\n&quot;);</i>
&gt;<i>&gt; -		clk_set_rate(bus-&gt;clk, old_freq);</i>
&gt;<i>&gt; -		goto out;</i>
&gt;<i>&gt; -	}</i>
&gt;<i>&gt; -</i>
&gt;<i>&gt; -	if (old_freq &gt; new_freq) {</i>
&gt;<i>&gt; -		ret = regulator_set_voltage_tol(bus-&gt;regulator, new_volt, tol);</i>
&gt;<i>&gt; -		if (ret &lt; 0) {</i>
&gt;<i>&gt; -			dev_err(bus-&gt;dev, &quot;failed to set voltage\n&quot;);</i>
&gt;<i>&gt; -			goto out;</i>
&gt;<i>&gt; -		}</i>
&gt;<i>&gt; -	}</i>
&gt;<i>&gt; -	bus-&gt;curr_freq = new_freq;</i>
&gt;<i>&gt; -</i>
&gt;<i>&gt; -	dev_dbg(dev, &quot;Set the frequency of bus (%luHz -&gt; %luHz, %luHz)\n&quot;,</i>
&gt;<i>&gt; -			old_freq, new_freq, clk_get_rate(bus-&gt;clk));</i>
&gt;<i>&gt; -out:</i>
&gt;<i>&gt;  	mutex_unlock(&amp;bus-&gt;lock);</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt;  	return ret;</i>
&gt;<i>&gt; @@ -194,10 +162,11 @@ static void exynos_bus_exit(struct device *dev)</i>
&gt;<i>&gt;  	if (ret &lt; 0)</i>
&gt;<i>&gt;  		dev_warn(dev, &quot;failed to disable the devfreq-event devices\n&quot;);</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt; -	if (bus-&gt;regulator)</i>
&gt;<i>&gt; -		regulator_disable(bus-&gt;regulator);</i>
&gt;<i>&gt; +	if (bus-&gt;opp_table)</i>
&gt;<i>&gt; +		dev_pm_opp_put_regulators(bus-&gt;opp_table);</i>
&gt;<i> </i>
&gt;<i> Have to disable regulator after disabling the clock</i>
&gt;<i> to prevent the h/w fault.</i>
&gt;<i> </i>
&gt;<i> I think that you should call them with following sequence:</i>
&gt;<i> </i>
&gt;<i> 	clk_disable_unprepare(bus-&gt;clk);</i>
&gt;<i> 	if (bus-&gt;opp_table)</i>
&gt;<i> 		dev_pm_opp_put_regulators(bus-&gt;opp_table);</i>
&gt;<i> 	dev_pm_opp_of_remove_table(dev);</i>
&gt;<i> </i>
&gt;<i>&gt;  </i>
&gt;<i>&gt;  	dev_pm_opp_of_remove_table(dev);</i>
&gt;<i>&gt; +</i>
&gt;<i>&gt;  	clk_disable_unprepare(bus-&gt;clk);</i>
&gt;<i>&gt;  }</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt; @@ -209,39 +178,26 @@ static int exynos_bus_passive_target(struct device *dev, unsigned long *freq,</i>
&gt;<i>&gt;  {</i>
&gt;<i>&gt;  	struct exynos_bus *bus = dev_get_drvdata(dev);</i>
&gt;<i>&gt;  	struct dev_pm_opp *new_opp;</i>
&gt;<i>&gt; -	unsigned long old_freq, new_freq;</i>
&gt;<i>&gt; -	int ret = 0;</i>
&gt;<i>&gt; +	int ret;</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt; -	/* Get new opp-bus instance according to new bus clock */</i>
&gt;<i>&gt; +	/*</i>
&gt;<i>&gt; +	 * New frequency for bus may not be exactly matched to opp, adjust</i>
&gt;<i>&gt; +	 * *freq to correct value.</i>
&gt;<i>&gt; +	 */</i>
&gt;<i> </i>
&gt;<i> You better to change this comment with following styles</i>
&gt;<i> to keep the consistency:</i>
&gt;<i> </i>
&gt;<i> 	/* Get correct frequency for bus ... */</i>
&gt;<i> </i>
&gt;<i>&gt;  	new_opp = devfreq_recommended_opp(dev, freq, flags);</i>
&gt;<i>&gt;  	if (IS_ERR(new_opp)) {</i>
&gt;<i>&gt;  		dev_err(dev, &quot;failed to get recommended opp instance\n&quot;);</i>
&gt;<i>&gt;  		return PTR_ERR(new_opp);</i>
&gt;<i>&gt;  	}</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt; -	new_freq = dev_pm_opp_get_freq(new_opp);</i>
&gt;<i>&gt;  	dev_pm_opp_put(new_opp);</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt; -	old_freq = bus-&gt;curr_freq;</i>
&gt;<i>&gt; -</i>
&gt;<i>&gt; -	if (old_freq == new_freq)</i>
&gt;<i>&gt; -		return 0;</i>
&gt;<i>&gt; -</i>
&gt;<i>&gt;  	/* Change the frequency according to new OPP level */</i>
&gt;<i>&gt;  	mutex_lock(&amp;bus-&gt;lock);</i>
&gt;<i>&gt; +	ret = dev_pm_opp_set_rate(dev, *freq);</i>
&gt;<i>&gt; +	if (!ret)</i>
&gt;<i>&gt; +		bus-&gt;curr_freq = *freq;</i>
&gt;<i> </i>
&gt;<i> ditto. Have to print the error log, check above comment.</i>
&gt;<i> </i>
&gt;<i>&gt;  </i>
&gt;<i>&gt; -	ret = clk_set_rate(bus-&gt;clk, new_freq);</i>
&gt;<i>&gt; -	if (ret &lt; 0) {</i>
&gt;<i>&gt; -		dev_err(dev, &quot;failed to set the clock of bus\n&quot;);</i>
&gt;<i>&gt; -		goto out;</i>
&gt;<i>&gt; -	}</i>
&gt;<i>&gt; -</i>
&gt;<i>&gt; -	*freq = new_freq;</i>
&gt;<i>&gt; -	bus-&gt;curr_freq = new_freq;</i>
&gt;<i>&gt; -</i>
&gt;<i>&gt; -	dev_dbg(dev, &quot;Set the frequency of bus (%luHz -&gt; %luHz, %luHz)\n&quot;,</i>
&gt;<i>&gt; -			old_freq, new_freq, clk_get_rate(bus-&gt;clk));</i>
&gt;<i>&gt; -out:</i>
&gt;<i>&gt;  	mutex_unlock(&amp;bus-&gt;lock);</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt;  	return ret;</i>
&gt;<i>&gt; @@ -259,20 +215,7 @@ static int exynos_bus_parent_parse_of(struct device_node *np,</i>
&gt;<i>&gt;  					struct exynos_bus *bus)</i>
&gt;<i>&gt;  {</i>
&gt;<i>&gt;  	struct device *dev = bus-&gt;dev;</i>
&gt;<i>&gt; -	int i, ret, count, size;</i>
&gt;<i>&gt; -</i>
&gt;<i>&gt; -	/* Get the regulator to provide each bus with the power */</i>
&gt;<i>&gt; -	bus-&gt;regulator = devm_regulator_get(dev, &quot;vdd&quot;);</i>
&gt;<i>&gt; -	if (IS_ERR(bus-&gt;regulator)) {</i>
&gt;<i>&gt; -		dev_err(dev, &quot;failed to get VDD regulator\n&quot;);</i>
&gt;<i>&gt; -		return PTR_ERR(bus-&gt;regulator);</i>
&gt;<i>&gt; -	}</i>
&gt;<i>&gt; -</i>
&gt;<i>&gt; -	ret = regulator_enable(bus-&gt;regulator);</i>
&gt;<i>&gt; -	if (ret &lt; 0) {</i>
&gt;<i>&gt; -		dev_err(dev, &quot;failed to enable VDD regulator\n&quot;);</i>
&gt;<i>&gt; -		return ret;</i>
&gt;<i>&gt; -	}</i>
&gt;<i>&gt; +	int i, count, size;</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt;  	/*</i>
&gt;<i>&gt;  	 * Get the devfreq-event devices to get the current utilization of</i>
&gt;<i>&gt; @@ -281,24 +224,20 @@ static int exynos_bus_parent_parse_of(struct device_node *np,</i>
&gt;<i>&gt;  	count = devfreq_event_get_edev_count(dev);</i>
&gt;<i>&gt;  	if (count &lt; 0) {</i>
&gt;<i>&gt;  		dev_err(dev, &quot;failed to get the count of devfreq-event dev\n&quot;);</i>
&gt;<i>&gt; -		ret = count;</i>
&gt;<i>&gt; -		goto err_regulator;</i>
&gt;<i>&gt; +		return count;</i>
&gt;<i>&gt;  	}</i>
&gt;<i>&gt; +</i>
&gt;<i>&gt;  	bus-&gt;edev_count = count;</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt;  	size = sizeof(*bus-&gt;edev) * count;</i>
&gt;<i>&gt;  	bus-&gt;edev = devm_kzalloc(dev, size, GFP_KERNEL);</i>
&gt;<i>&gt; -	if (!bus-&gt;edev) {</i>
&gt;<i>&gt; -		ret = -ENOMEM;</i>
&gt;<i>&gt; -		goto err_regulator;</i>
&gt;<i>&gt; -	}</i>
&gt;<i>&gt; +	if (!bus-&gt;edev)</i>
&gt;<i>&gt; +		return -ENOMEM;</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt;  	for (i = 0; i &lt; count; i++) {</i>
&gt;<i>&gt;  		bus-&gt;edev[i] = devfreq_event_get_edev_by_phandle(dev, i);</i>
&gt;<i>&gt; -		if (IS_ERR(bus-&gt;edev[i])) {</i>
&gt;<i>&gt; -			ret = -EPROBE_DEFER;</i>
&gt;<i>&gt; -			goto err_regulator;</i>
&gt;<i>&gt; -		}</i>
&gt;<i>&gt; +		if (IS_ERR(bus-&gt;edev[i]))</i>
&gt;<i>&gt; +			return -EPROBE_DEFER;</i>
&gt;<i>&gt;  	}</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt;  	/*</i>
&gt;<i>&gt; @@ -314,22 +253,15 @@ static int exynos_bus_parent_parse_of(struct device_node *np,</i>
&gt;<i>&gt;  	if (of_property_read_u32(np, &quot;exynos,saturation-ratio&quot;, &amp;bus-&gt;ratio))</i>
&gt;<i>&gt;  		bus-&gt;ratio = DEFAULT_SATURATION_RATIO;</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt; -	if (of_property_read_u32(np, &quot;exynos,voltage-tolerance&quot;,</i>
&gt;<i>&gt; -					&amp;bus-&gt;voltage_tolerance))</i>
&gt;<i>&gt; -		bus-&gt;voltage_tolerance = DEFAULT_VOLTAGE_TOLERANCE;</i>
&gt;<i>&gt; -</i>
&gt;<i>&gt;  	return 0;</i>
&gt;<i>&gt; -</i>
&gt;<i>&gt; -err_regulator:</i>
&gt;<i>&gt; -	regulator_disable(bus-&gt;regulator);</i>
&gt;<i>&gt; -</i>
&gt;<i>&gt; -	return ret;</i>
&gt;<i>&gt;  }</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt;  static int exynos_bus_parse_of(struct device_node *np,</i>
&gt;<i>&gt; -			      struct exynos_bus *bus)</i>
&gt;<i>&gt; +			      struct exynos_bus *bus, bool passive)</i>
&gt;<i>&gt;  {</i>
&gt;<i>&gt;  	struct device *dev = bus-&gt;dev;</i>
&gt;<i>&gt; +	struct opp_table *opp_table;</i>
&gt;<i>&gt; +	const char *vdd = &quot;vdd&quot;;</i>
&gt;<i>&gt;  	struct dev_pm_opp *opp;</i>
&gt;<i>&gt;  	unsigned long rate;</i>
&gt;<i>&gt;  	int ret;</i>
&gt;<i>&gt; @@ -347,11 +279,22 @@ static int exynos_bus_parse_of(struct device_node *np,</i>
&gt;<i>&gt;  		return ret;</i>
&gt;<i>&gt;  	}</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt; +	if (!passive) {</i>
&gt;<i>&gt; +		opp_table = dev_pm_opp_set_regulators(dev, &amp;vdd, 1);</i>
&gt;<i>&gt; +		if (IS_ERR(opp_table)) {</i>
&gt;<i>&gt; +			ret = PTR_ERR(opp_table);</i>
&gt;<i>&gt; +			dev_err(dev, &quot;failed to set regulators %d\n&quot;, ret);</i>
&gt;<i>&gt; +			goto err_clk;/</i>
&gt;<i>&gt; +		}</i>
&gt;<i>&gt; +</i>
&gt;<i>&gt; +		bus-&gt;opp_table = opp_table;</i>
&gt;<i>&gt; +	}</i>
&gt;<i> </i>
&gt;<i> This driver has exynos_bus_parent_parse_of() function for parent devfreq device.</i>
&gt;<i> dev_pm_opp_set_regulators() have to be called in exynos_bus_parent_parse_of()</i>
&gt;<i> because the regulator is only used by parent devfreq device.</i>

exynos_bus_parse_of() is called for all devfreq devices (including
parent) and (as you've noticed) the regulator should be enabled before
enabling clock (which is done in exynos_bus_parse_of()) so adding
extra argument to exynos_bus_parse_of() (like it is done currently in
the patch) makes it possible to do the setup correctly without the need
of merging both functions into one huge function (which would be more
difficult to follow than two simpler functions IMHO). Is that approach
acceptable or do you prefer one big function?

&gt;<i>&gt; +</i>
&gt;<i>&gt;  	/* Get the freq and voltage from OPP table to scale the bus freq */</i>
&gt;<i>&gt;  	ret = dev_pm_opp_of_add_table(dev);</i>
&gt;<i>&gt;  	if (ret &lt; 0) {</i>
&gt;<i>&gt;  		dev_err(dev, &quot;failed to get OPP table\n&quot;);</i>
&gt;<i>&gt; -		goto err_clk;</i>
&gt;<i>&gt; +		goto err_regulator;</i>
&gt;<i>&gt;  	}</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt;  	rate = clk_get_rate(bus-&gt;clk);</i>
&gt;<i>&gt; @@ -362,6 +305,7 @@ static int exynos_bus_parse_of(struct device_node *np,</i>
&gt;<i>&gt;  		ret = PTR_ERR(opp);</i>
&gt;<i>&gt;  		goto err_opp;</i>
&gt;<i>&gt;  	}</i>
&gt;<i>&gt; +</i>
&gt;<i>&gt;  	bus-&gt;curr_freq = dev_pm_opp_get_freq(opp);</i>
&gt;<i>&gt;  	dev_pm_opp_put(opp);</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt; @@ -369,6 +313,13 @@ static int exynos_bus_parse_of(struct device_node *np,</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt;  err_opp:</i>
&gt;<i>&gt;  	dev_pm_opp_of_remove_table(dev);</i>
&gt;<i>&gt; +</i>
&gt;<i>&gt; +err_regulator:</i>
&gt;<i>&gt; +	if (bus-&gt;opp_table) {</i>
&gt;<i>&gt; +		dev_pm_opp_put_regulators(bus-&gt;opp_table);</i>
&gt;<i>&gt; +		bus-&gt;opp_table = NULL;</i>
&gt;<i>&gt; +	}</i>
&gt;<i> </i>
&gt;<i> As I mentioned above, it it wrong to call dev_pm_opp_put_regulators()</i>
&gt;<i> after removing the opp_table by dev_pm_opp_of_remove_table().</i>
&gt;<i> </i>
&gt;<i>&gt; +</i>
&gt;<i>&gt;  err_clk:</i>
&gt;<i>&gt;  	clk_disable_unprepare(bus-&gt;clk);</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt; @@ -386,6 +337,7 @@ static int exynos_bus_probe(struct platform_device *pdev)</i>
&gt;<i>&gt;  	struct exynos_bus *bus;</i>
&gt;<i>&gt;  	int ret, max_state;</i>
&gt;<i>&gt;  	unsigned long min_freq, max_freq;</i>
&gt;<i>&gt; +	bool passive = false;</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt;  	if (!np) {</i>
&gt;<i>&gt;  		dev_err(dev, &quot;failed to find devicetree node\n&quot;);</i>
&gt;<i>&gt; @@ -395,12 +347,18 @@ static int exynos_bus_probe(struct platform_device *pdev)</i>
&gt;<i>&gt;  	bus = devm_kzalloc(&amp;pdev-&gt;dev, sizeof(*bus), GFP_KERNEL);</i>
&gt;<i>&gt;  	if (!bus)</i>
&gt;<i>&gt;  		return -ENOMEM;</i>
&gt;<i>&gt; +</i>
&gt;<i>&gt;  	mutex_init(&amp;bus-&gt;lock);</i>
&gt;<i>&gt;  	bus-&gt;dev = &amp;pdev-&gt;dev;</i>
&gt;<i>&gt;  	platform_set_drvdata(pdev, bus);</i>
&gt;<i>&gt; +	node = of_parse_phandle(dev-&gt;of_node, &quot;devfreq&quot;, 0);</i>
&gt;<i>&gt; +	if (node) {</i>
&gt;<i>&gt; +		of_node_put(node);</i>
&gt;<i>&gt; +		passive = true;</i>
&gt;<i>&gt; +	}</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt;  	/* Parse the device-tree to get the resource information */</i>
&gt;<i>&gt; -	ret = exynos_bus_parse_of(np, bus);</i>
&gt;<i>&gt; +	ret = exynos_bus_parse_of(np, bus, passive);</i>
&gt;<i>&gt;  	if (ret &lt; 0)</i>
&gt;<i>&gt;  		return ret;</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt; @@ -410,13 +368,10 @@ static int exynos_bus_probe(struct platform_device *pdev)</i>
&gt;<i>&gt;  		goto err;</i>
&gt;<i>&gt;  	}</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt; -	node = of_parse_phandle(dev-&gt;of_node, &quot;devfreq&quot;, 0);</i>
&gt;<i>&gt; -	if (node) {</i>
&gt;<i>&gt; -		of_node_put(node);</i>
&gt;<i>&gt; +	if (passive)</i>
&gt;<i>&gt;  		goto passive;</i>
&gt;<i>&gt; -	} else {</i>
&gt;<i>&gt; -		ret = exynos_bus_parent_parse_of(np, bus);</i>
&gt;<i>&gt; -	}</i>
&gt;<i>&gt; +</i>
&gt;<i>&gt; +	ret = exynos_bus_parent_parse_of(np, bus);</i>
&gt;<i>&gt;  </i>
&gt;<i> </i>
&gt;<i> Remove unneeded blank line.</i>
&gt;<i> </i>
&gt;<i>&gt;  	if (ret &lt; 0)</i>
&gt;<i>&gt;  		goto err;</i>
&gt;<i>&gt; @@ -509,6 +464,11 @@ static int exynos_bus_probe(struct platform_device *pdev)</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt;  err:</i>
&gt;<i>&gt;  	dev_pm_opp_of_remove_table(dev);</i>
&gt;<i>&gt; +	if (bus-&gt;opp_table) {</i>
&gt;<i>&gt; +		dev_pm_opp_put_regulators(bus-&gt;opp_table);</i>
&gt;<i>&gt; +		bus-&gt;opp_table = NULL;</i>
&gt;<i>&gt; +	}</i>
&gt;<i>&gt; +</i>
&gt;<i> </i>
&gt;<i> ditto.</i>
&gt;<i> Have to disable regulator after disabling the clock</i>
&gt;<i> to prevent the h/w fault.</i>
&gt;<i> </i>
&gt;<i> I think that you should call them with following sequence:</i>
&gt;<i> </i>
&gt;<i> 	clk_disable_unprepare(bus-&gt;clk);</i>
&gt;<i> 	if (bus-&gt;opp_table)</i>
&gt;<i> 		dev_pm_opp_put_regulators(bus-&gt;opp_table);</i>
&gt;<i> 	dev_pm_opp_of_remove_table(dev);</i>
&gt;<i> </i>
&gt;<i>&gt;  	clk_disable_unprepare(bus-&gt;clk);</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt;  	return ret;</i>

Best regards,
--
Bartlomiej Zolnierkiewicz
Samsung R&amp;D Institute Poland
Samsung Electronics

_______________________________________________
linux-arm-kernel mailing list
linux-arm-kernel@xxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="http://lists.infradead.org/mailman/listinfo/linux-arm-kernel">http://lists.infradead.org/mailman/listinfo/linux-arm-kernel</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="741300" href="msg741300.html">Re: [PATCH v2 2/4] devfreq: exynos-bus: convert to use dev_pm_opp_set_rate()</a></strong>
<ul><li><em>From:</em> Chanwoo Choi</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="741091" href="msg741091.html">[PATCH v2 0/4] add coupled regulators for Exynos5422/5800</a></strong>
<ul><li><em>From:</em> Kamil Konieczny</li></ul></li>
<li><strong><a name="741094" href="msg741094.html">[PATCH v2 2/4] devfreq: exynos-bus: convert to use dev_pm_opp_set_rate()</a></strong>
<ul><li><em>From:</em> Kamil Konieczny</li></ul></li>
<li><strong><a name="741240" href="msg741240.html">Re: [PATCH v2 2/4] devfreq: exynos-bus: convert to use dev_pm_opp_set_rate()</a></strong>
<ul><li><em>From:</em> Chanwoo Choi</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg741293.html">Re: [PATCH v1 10/50] clk: samsung: change ACLK100_NOC clocks definitions Exynos5x</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg741295.html">Re: [PATCH] ARM: dts: at91: Avoid colliding 'display' node and property names</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg741240.html">Re: [PATCH v2 2/4] devfreq: exynos-bus: convert to use dev_pm_opp_set_rate()</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg741300.html">Re: [PATCH v2 2/4] devfreq: exynos-bus: convert to use dev_pm_opp_set_rate()</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#741294"><strong>Date</strong></a></li>
<li><a href="threads.html#741294"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-arm/>[Linux&nbsp;ARM&nbsp;(vger)]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-arm-msm/>[Linux&nbsp;ARM&nbsp;MSM]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;Omap]</a>
&nbsp;
&nbsp;
<a href=/lists/centos-arm-devel/>[CentOS&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/arm/>[Linux&nbsp;Arm]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-tegra/>[Linux&nbsp;Tegra]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-arm/>[Fedora&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;for&nbsp;Samsung&nbsp;SOC]</a>
&nbsp;
&nbsp;
<a href=/lists/ecos/>[eCos]</a>
&nbsp;
&nbsp;
<a href=/lists/fastboot/>[Linux&nbsp;Fastboot]</a>
&nbsp;
&nbsp;
<a href=/lists/gcchelp/>[Gcc&nbsp;Help]</a>
&nbsp;
&nbsp;
<a href=/lists/git/>[Git]</a>
&nbsp;
&nbsp;
<a href=/lists/dccp/>[DCCP]</a>
&nbsp;
&nbsp;
<a href=/lists/ietf-ann>[IETF&nbsp;Announce]</a>
&nbsp;
&nbsp;
<a href=/lists/security/>[Security]</a>
&nbsp;
&nbsp;
<a href=/lists/mips/>[Linux&nbsp;MIPS]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }

initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

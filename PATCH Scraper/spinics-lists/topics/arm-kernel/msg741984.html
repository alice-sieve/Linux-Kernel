<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH v10 6/9] namei: aggressively check for nd&#45;>root escape on ".." resolution -->
<!--X-From-R13: Oyrxfn Enenv &#60;plcuneNplcune.pbz> -->
<!--X-Date: Fri, 19 Jul 2019 09:45:49 &#45;0700 -->
<!--X-Message-Id: 20190719164225.27083&#45;7&#45;cyphar@cyphar.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190719164225.27083&#45;1&#45;cyphar@cyphar.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<meta name="description" content="Linux ARM, OMAP, Xscale Kernel: [PATCH v10 6/9] namei: aggressively check for nd-&gt;root escape on &quot;..&quot; resolution">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>[PATCH v10 6/9] namei: aggressively check for nd-&gt;root escape on &quot;..&quot; resolution &mdash; ARM, OMAP, Xscale Linux Kernel</title>
<link rel="alternate" type="application/rss+xml" title="Linux ARM Kernel" href="//feedproxy.google.com/LinuxArmKernel">
<link rel="alternate" type="application/rss+xml" title="Linux ARM Kernel" href="//feeds.feedburner.com/LinuxArmxscaleEtc">
<link rel="alternate" type="application/rss+xml" title="Fedora ARM" href="//feeds.feedburner.com/FedoraArm">
<link rel="alternate" type="application/rss+xml" title="Linux for OMAP" href="//feedproxy.google.com/LinuxOmap">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<td align=right><form action="//www.google.com/cse" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:isdiegq275o" />
    <input type="hidden" name="ie" value="ISO-8859-1" />
    <input type="text" name="q" size="37" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/cse/brand?form=cse-search-box&amp;lang=en" async></script>
<h1 itemprop="name">[PATCH v10 6/9] namei: aggressively check for nd-&gt;root escape on &quot;..&quot; resolution</h1>
[<a href="msg741983.html">Date Prev</a>][<a href="msg741985.html">Date Next</a>][<a href="msg741983.html">Thread Prev</a>][<a href="msg741985.html">Thread Next</a>][<a href="maillist.html#741984">Date Index</a>][<a href="threads.html#741984">Thread Index</a>] 
<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH v10 6/9] namei: aggressively check for nd-&gt;root escape on &quot;..&quot; resolution</li>
<li><em>From</em>: Aleksa Sarai &lt;cyphar@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Sat, 20 Jul 2019 02:42:22 +1000</li>
<li><em>In-reply-to</em>: &lt;<a href="msg741978.html">20190719164225.27083-1-cyphar@cyphar.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>This patch allows for LOOKUP_BENEATH and LOOKUP_IN_ROOT to safely permit
&quot;..&quot; resolution (in the case of LOOKUP_BENEATH the resolution will still
fail if &quot;..&quot; resolution would resolve a path outside of the root --
while LOOKUP_IN_ROOT will chroot(2)-style scope it). Magic-link jumps
are still disallowed entirely because now they could result in
inconsistent behaviour if resolution encounters a subsequent &quot;..&quot;[*].

The need for this patch is explained by observing there is a fairly
easy-to-exploit race condition with chroot(2) (and thus by extension
LOOKUP_IN_ROOT and LOOKUP_BENEATH if &quot;..&quot; is allowed) where a rename(2)
of a path can be used to &quot;skip over&quot; nd-&gt;root and thus escape to the
filesystem above nd-&gt;root.

  thread1 [attacker]:
    for (;;)
      renameat2(AT_FDCWD, &quot;/a/b/c&quot;, AT_FDCWD, &quot;/a/d&quot;, RENAME_EXCHANGE);
  thread2 [victim]:
    for (;;)
      resolveat(dirb, &quot;b/c/../../etc/shadow&quot;, RESOLVE_IN_ROOT);

With fairly significant regularity, thread2 will resolve to
&quot;/etc/shadow&quot; rather than &quot;/a/b/etc/shadow&quot;. There is also a similar
(though somewhat more privileged) attack using MS_MOVE.

With this patch, such cases will be detected *during* &quot;..&quot; resolution
(which is the weak point of chroot(2) -- since walking *into* a
subdirectory tautologically cannot result in you walking *outside*
nd-&gt;root -- except through a bind-mount or magic-link). By detecting
this at &quot;..&quot; resolution (rather than checking only at the end of the
entire resolution) we can both correct escapes by jumping back to the
root (in the case of LOOKUP_IN_ROOT), as well as avoid revealing to
attackers the structure of the filesystem outside of the root (through
timing attacks for instance).

In order to avoid a quadratic lookup with each &quot;..&quot; entry, we only
activate the slow path if a write through &amp;rename_lock or &amp;mount_lock
has occurred during path resolution (&amp;rename_lock and &amp;mount_lock are
re-taken to further optimise the lookup). Since the primary attack being
protected against is MS_MOVE or rename(2), not doing additional checks
unless a mount or rename have occurred avoids making the common case
slow.

The use of path_is_under() here might seem suspect, but on further
inspection of the most important race (a path was *inside* the root but
is now *outside*), there appears to be no attack potential:

  * If path_is_under() occurs before the rename, then the path will be
    resolved -- however the path was originally inside the root and thus
    there is no escape (and to userspace it'd look like the rename
    occurred after the path was resolved). If path_is_under() occurs
    afterwards, the resolution is blocked.

  * Subsequent &quot;..&quot; jumps are guaranteed to check path_is_under() -- by
    construction, &amp;rename_lock or &amp;mount_lock must have been taken by
    the attacker after path_is_under() returned in the victim. Thus &quot;..&quot;
    will not be able to escape from the previously-inside-root path.

  * Walking down in the moved path is still safe since the entire
    subtree was moved (either by rename(2) or MS_MOVE) and because (as
    discussed above) walking down is safe.

A variant of the above attack is included in the selftests for
openat2(2) later in this patch series. I've run this test on several
machines for several days and no instances of a breakout were detected.
While this is not concrete proof that this is safe, when combined with
the above argument it should lend some trustworthiness to this
construction.

[*] It may be acceptable in the future to do a path_is_under() check
    after resolving a magic-link and permit resolution if the
    nd_jump_link() result is still within the dirfd. However this seems
    unlikely to be a feature that people *really* need* -- it can be
    added later if it turns out a lot of people want it.

Cc: Al Viro &lt;viro@xxxxxxxxxxxxxxxxxx&gt;
Cc: Jann Horn &lt;jannh@xxxxxxxxxx&gt;
Cc: Kees Cook &lt;keescook@xxxxxxxxxxxx&gt;
Signed-off-by: Aleksa Sarai &lt;cyphar@xxxxxxxxxx&gt;
---
 fs/namei.c | 45 +++++++++++++++++++++++++++++++--------------
 1 file changed, 31 insertions(+), 14 deletions(-)

diff --git a/fs/namei.c b/fs/namei.c
index 617fc7d55977..b3abf5754ddd 100644
--- a/fs/namei.c
+++ b/fs/namei.c
@@ -491,7 +491,7 @@ struct nameidata {
 	struct path	root;
 	struct inode	*inode; /* path.dentry.d_inode */
 	unsigned int	flags;
-	unsigned	seq, m_seq;
+	unsigned	seq, m_seq, r_seq;
 	int		last_type;
 	unsigned	depth;
 	int		total_link_count;
@@ -1758,22 +1758,36 @@ static inline int handle_dots(struct nameidata *nd, int type)
 	if (type == LAST_DOTDOT) {
 		int error = 0;
 
-		/*
-		 * LOOKUP_BENEATH resolving &quot;..&quot; is not currently safe -- races can
-		 * cause our parent to have moved outside of the root and us to skip
-		 * over it.
-		 */
-		if (unlikely(nd-&gt;flags &amp; (LOOKUP_BENEATH | LOOKUP_IN_ROOT)))
-			return -EXDEV;
 		if (!nd-&gt;root.mnt) {
 			error = set_root(nd);
 			if (error)
 				return error;
 		}
-		if (nd-&gt;flags &amp; LOOKUP_RCU) {
-			return follow_dotdot_rcu(nd);
-		} else
-			return follow_dotdot(nd);
+		if (nd-&gt;flags &amp; LOOKUP_RCU)
+			error = follow_dotdot_rcu(nd);
+		else
+			error = follow_dotdot(nd);
+		if (error)
+			return error;
+
+		if (unlikely(nd-&gt;flags &amp; (LOOKUP_BENEATH | LOOKUP_IN_ROOT))) {
+			bool m_retry = read_seqretry(&amp;mount_lock, nd-&gt;m_seq);
+			bool r_retry = read_seqretry(&amp;rename_lock, nd-&gt;r_seq);
+
+			/*
+			 * Don't bother checking unless there's a racing
+			 * rename(2) or MS_MOVE.
+			 */
+			if (likely(!m_retry &amp;&amp; !r_retry))
+				return 0;
+
+			if (m_retry &amp;&amp; !(nd-&gt;flags &amp; LOOKUP_RCU))
+				nd-&gt;m_seq = read_seqbegin(&amp;mount_lock);
+			if (r_retry)
+				nd-&gt;r_seq = read_seqbegin(&amp;rename_lock);
+			if (!path_is_under(&amp;nd-&gt;path, &amp;nd-&gt;root))
+				return -EXDEV;
+		}
 	}
 	return 0;
 }
@@ -2245,6 +2259,11 @@ static const char *path_init(struct nameidata *nd, unsigned flags)
 	nd-&gt;last_type = LAST_ROOT; /* if there are only slashes... */
 	nd-&gt;flags = flags | LOOKUP_JUMPED | LOOKUP_PARENT;
 	nd-&gt;depth = 0;
+
+	nd-&gt;m_seq = read_seqbegin(&amp;mount_lock);
+	if (flags &amp; (LOOKUP_BENEATH | LOOKUP_IN_ROOT))
+		nd-&gt;r_seq = read_seqbegin(&amp;rename_lock);
+
 	if (flags &amp; LOOKUP_ROOT) {
 		struct dentry *root = nd-&gt;root.dentry;
 		struct inode *inode = root-&gt;d_inode;
@@ -2266,8 +2285,6 @@ static const char *path_init(struct nameidata *nd, unsigned flags)
 	nd-&gt;path.mnt = NULL;
 	nd-&gt;path.dentry = NULL;
 
-	nd-&gt;m_seq = read_seqbegin(&amp;mount_lock);
-
 	/* LOOKUP_IN_ROOT treats absolute paths as being relative-to-dirfd. */
 	if (flags &amp; LOOKUP_IN_ROOT)
 		while (*s == '/')
-- 
2.22.0


_______________________________________________
linux-arm-kernel mailing list
linux-arm-kernel@xxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="http://lists.infradead.org/mailman/listinfo/linux-arm-kernel">http://lists.infradead.org/mailman/listinfo/linux-arm-kernel</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="741978" href="msg741978.html">[PATCH v10 0/9] namei: openat2(2) path resolution restrictions</a></strong>
<ul><li><em>From:</em> Aleksa Sarai</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg741983.html">[PATCH v10 5/9] namei: LOOKUP_IN_ROOT: chroot-like path resolution</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg741985.html">[PATCH v10 7/9] open: openat2(2) syscall</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg741983.html">[PATCH v10 5/9] namei: LOOKUP_IN_ROOT: chroot-like path resolution</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg741985.html">[PATCH v10 7/9] open: openat2(2) syscall</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#741984"><strong>Date</strong></a></li>
<li><a href="threads.html#741984"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-arm/>[Linux&nbsp;ARM&nbsp;(vger)]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-arm-msm/>[Linux&nbsp;ARM&nbsp;MSM]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;Omap]</a>
&nbsp;
&nbsp;
<a href=/lists/centos-arm-devel/>[CentOS&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/arm/>[Linux&nbsp;Arm]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-tegra/>[Linux&nbsp;Tegra]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-arm/>[Fedora&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;for&nbsp;Samsung&nbsp;SOC]</a>
&nbsp;
&nbsp;
<a href=/lists/ecos/>[eCos]</a>
&nbsp;
&nbsp;
<a href=/lists/fastboot/>[Linux&nbsp;Fastboot]</a>
&nbsp;
&nbsp;
<a href=/lists/gcchelp/>[Gcc&nbsp;Help]</a>
&nbsp;
&nbsp;
<a href=/lists/git/>[Git]</a>
&nbsp;
&nbsp;
<a href=/lists/dccp/>[DCCP]</a>
&nbsp;
&nbsp;
<a href=/lists/ietf-ann>[IETF&nbsp;Announce]</a>
&nbsp;
&nbsp;
<a href=/lists/security/>[Security]</a>
&nbsp;
&nbsp;
<a href=/lists/mips/>[Linux&nbsp;MIPS]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }

initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

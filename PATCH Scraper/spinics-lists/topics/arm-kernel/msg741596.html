<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH] KVM: arm/arm64: Assign pmc&#45;>idx before kvm_pmu_stop_counter() -->
<!--X-From-R13: Xhyvra Fuvreel &#60;whyvra.guvreelNnez.pbz> -->
<!--X-Date: Wed, 17 Jul 2019 06:45:12 &#45;0700 -->
<!--X-Message-Id: 01fa98c1&#45;8274&#45;445c&#45;5e04&#45;219372920ba2@arm.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 1563366019&#45;31200&#45;1&#45;git&#45;send&#45;email&#45;yuzenghui@huawei.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<meta name="description" content="Linux ARM, OMAP, Xscale Kernel: Re: [PATCH] KVM: arm/arm64: Assign pmc-&gt;idx before kvm_pmu_stop_counter()">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Re: [PATCH] KVM: arm/arm64: Assign pmc-&gt;idx before kvm_pmu_stop_counter() &mdash; ARM, OMAP, Xscale Linux Kernel</title>
<link rel="alternate" type="application/rss+xml" title="Linux ARM Kernel" href="//feedproxy.google.com/LinuxArmKernel">
<link rel="alternate" type="application/rss+xml" title="Linux ARM Kernel" href="//feeds.feedburner.com/LinuxArmxscaleEtc">
<link rel="alternate" type="application/rss+xml" title="Fedora ARM" href="//feeds.feedburner.com/FedoraArm">
<link rel="alternate" type="application/rss+xml" title="Linux for OMAP" href="//feedproxy.google.com/LinuxOmap">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<td align=right><form action="//www.google.com/cse" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:isdiegq275o" />
    <input type="hidden" name="ie" value="ISO-8859-1" />
    <input type="text" name="q" size="37" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/cse/brand?form=cse-search-box&amp;lang=en" async></script>
<h1 itemprop="name">Re: [PATCH] KVM: arm/arm64: Assign pmc-&gt;idx before kvm_pmu_stop_counter()</h1>
[<a href="msg741595.html">Date Prev</a>][<a href="msg741597.html">Date Next</a>][<a href="msg741581.html">Thread Prev</a>][<a href="msg741604.html">Thread Next</a>][<a href="maillist.html#741596">Date Index</a>][<a href="threads.html#741596">Thread Index</a>] 
<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH] KVM: arm/arm64: Assign pmc-&gt;idx before kvm_pmu_stop_counter()</li>
<li><em>From</em>: Julien Thierry &lt;julien.thierry@xxxxxxx&gt;</li>
<li><em>Date</em>: Wed, 17 Jul 2019 14:44:59 +0100</li>
<li><em>In-reply-to</em>: &lt;<a href="msg741581.html">1563366019-31200-1-git-send-email-yuzenghui@huawei.com</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Thunderbird/60.6.1</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Hi Zenghui,

On 17/07/2019 13:20, Zenghui Yu wrote:
&gt;<i> We use &quot;pmc-&gt;idx&quot; and the &quot;chained&quot; bitmap to determine if the pmc is</i>
&gt;<i> chained, in kvm_pmu_pmc_is_chained().  But idx might be uninitialized</i>
&gt;<i> (and random) when we doing this decision, through a KVM_ARM_VCPU_INIT</i>
&gt;<i> ioctl -&gt; kvm_pmu_vcpu_reset(). And the test_bit() against this random</i>
&gt;<i> idx will potentially hit a KASAN BUG [1].</i>
&gt;<i> </i>
&gt;<i> Fix it by moving the assignment of idx before kvm_pmu_stop_counter().</i>
&gt;<i> </i>
&gt;<i> [1] <a  rel="nofollow" href="https://www.spinics.net/lists/kvm-arm/msg36700.html">https://www.spinics.net/lists/kvm-arm/msg36700.html</a></i>
&gt;<i> </i>
&gt;<i> Fixes: 80f393a23be6 (&quot;KVM: arm/arm64: Support chained PMU counters&quot;)</i>
&gt;<i> Suggested-by: Andrew Murray &lt;andrew.murray@xxxxxxx&gt;</i>
&gt;<i> Cc: Marc Zyngier &lt;maz@xxxxxxxxxx&gt;</i>
&gt;<i> Signed-off-by: Zenghui Yu &lt;yuzenghui@xxxxxxxxxx&gt;&gt; ---</i>
&gt;<i>  virt/kvm/arm/pmu.c | 2 +-</i>
&gt;<i>  1 file changed, 1 insertion(+), 1 deletion(-)</i>
&gt;<i> </i>
&gt;<i> diff --git a/virt/kvm/arm/pmu.c b/virt/kvm/arm/pmu.c</i>
&gt;<i> index 3dd8238..521bfdd 100644</i>
&gt;<i> --- a/virt/kvm/arm/pmu.c</i>
&gt;<i> +++ b/virt/kvm/arm/pmu.c</i>
&gt;<i> @@ -225,8 +225,8 @@ void kvm_pmu_vcpu_reset(struct kvm_vcpu *vcpu)</i>
&gt;<i>  	struct kvm_pmu *pmu = &amp;vcpu-&gt;arch.pmu;</i>
&gt;<i>  </i>
&gt;<i>  	for (i = 0; i &lt; ARMV8_PMU_MAX_COUNTERS; i++) {</i>
&gt;<i> -		kvm_pmu_stop_counter(vcpu, &amp;pmu-&gt;pmc[i]);</i>
&gt;<i>  		pmu-&gt;pmc[i].idx = i;</i>

Yes, this is kind of a static property that should really be part of a
&quot;kvm_pmu_vcpu_init()&quot; or &quot;kvm_pmu_vcpu_create()&quot; and is not expected to
be modified across resets...

There is no such function at the time and I'm unsure whether this
warrants creating that separate function (I would still suggest creating
it to make things clearer).

&gt;<i> +		kvm_pmu_stop_counter(vcpu, &amp;pmu-&gt;pmc[i]);</i>

Whatever other opinions are on splitting pmu_vcpu_init/reset, that
change makes sense and fixes the issue:

Acked-by: Julien Thierry &lt;julien.thierry@xxxxxxx&gt;

&gt;<i>  	}</i>
&gt;<i>  </i>
&gt;<i>  	bitmap_zero(vcpu-&gt;arch.pmu.chained, ARMV8_PMU_MAX_COUNTER_PAIRS);</i>
&gt;<i> </i>

Cheers,

-- 
Julien Thierry

_______________________________________________
linux-arm-kernel mailing list
linux-arm-kernel@xxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="http://lists.infradead.org/mailman/listinfo/linux-arm-kernel">http://lists.infradead.org/mailman/listinfo/linux-arm-kernel</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="741604" href="msg741604.html">Re: [PATCH] KVM: arm/arm64: Assign pmc-&gt;idx before kvm_pmu_stop_counter()</a></strong>
<ul><li><em>From:</em> Marc Zyngier</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="741581" href="msg741581.html">[PATCH] KVM: arm/arm64: Assign pmc-&gt;idx before kvm_pmu_stop_counter()</a></strong>
<ul><li><em>From:</em> Zenghui Yu</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg741595.html">Re: [PATCH v2 1/2] dt-bindings: mmc: Document Aspeed SD controller</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg741597.html">Re: [PATCH v3] arm64: dts: imx8mq: Add sai3 and sai6 nodes</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg741581.html">[PATCH] KVM: arm/arm64: Assign pmc-&gt;idx before kvm_pmu_stop_counter()</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg741604.html">Re: [PATCH] KVM: arm/arm64: Assign pmc-&gt;idx before kvm_pmu_stop_counter()</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#741596"><strong>Date</strong></a></li>
<li><a href="threads.html#741596"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-arm/>[Linux&nbsp;ARM&nbsp;(vger)]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-arm-msm/>[Linux&nbsp;ARM&nbsp;MSM]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;Omap]</a>
&nbsp;
&nbsp;
<a href=/lists/centos-arm-devel/>[CentOS&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/arm/>[Linux&nbsp;Arm]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-tegra/>[Linux&nbsp;Tegra]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-arm/>[Fedora&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;for&nbsp;Samsung&nbsp;SOC]</a>
&nbsp;
&nbsp;
<a href=/lists/ecos/>[eCos]</a>
&nbsp;
&nbsp;
<a href=/lists/fastboot/>[Linux&nbsp;Fastboot]</a>
&nbsp;
&nbsp;
<a href=/lists/gcchelp/>[Gcc&nbsp;Help]</a>
&nbsp;
&nbsp;
<a href=/lists/git/>[Git]</a>
&nbsp;
&nbsp;
<a href=/lists/dccp/>[DCCP]</a>
&nbsp;
&nbsp;
<a href=/lists/ietf-ann>[IETF&nbsp;Announce]</a>
&nbsp;
&nbsp;
<a href=/lists/security/>[Security]</a>
&nbsp;
&nbsp;
<a href=/lists/mips/>[Linux&nbsp;MIPS]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }

initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

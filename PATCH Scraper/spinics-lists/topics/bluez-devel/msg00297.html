<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH] Fixes for RFCOMM -->
<!--X-From-R13: Rravf YS@LWAD &#60;qravf.xramvbeNgebyygrpu.pbz> -->
<!--X-Date: Thu, 19 Jun 2008 21:09:39 &#45;0700 -->
<!--X-Message-Id: 200806201409.13306.denis.kenzior@trolltech.com -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Bluez Devel: [PATCH] Fixes for RFCOMM">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[PATCH] Fixes for RFCOMM &mdash; Bluez Devel</title>
<link rel="alternate" type="application/rss+xml" title="Bluez Devel" href="maillist.rdf">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH] Fixes for RFCOMM</h1>
[<a href="msg00296.html">Date Prev</a>][<a href="msg00298.html">Date Next</a>][<a href="msg00293.html">Thread Prev</a>][<a href="msg00298.html">Thread Next</a>][<a href="maillist.html#00297">Date Index</a>][<a href="index.html#00297">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH] Fixes for RFCOMM</li>
<li><em>From</em>: Denis KENZIOR &lt;<a href="mailto:denis.kenzior@DOMAIN.HIDDEN">denis.kenzior@xxxxxxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Fri, 20 Jun 2008 14:09:13 +1000</li>
<li><em>Reply-to</em>: BlueZ development &lt;<a href="mailto:bluez-devel@DOMAIN.HIDDEN">bluez-devel@xxxxxxxxxxxxxxxxxxxxx</a>&gt;</li>
<li><em>User-agent</em>: KMail/1.9.5</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" defer async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Marcel,

Here's a cleaned up version of the fixes for RFCOMM:

rfcomm-keep-tty-data:
    Fix the problem of disappearing packets when the socket is meant to be
    used as an rfcomm tty server.  The data needs to be queued since
    packets might arrive after the socket has been connected, but
    before the tty has been opened

rfcomm-tty-no-canonical:
    Let the tty driver be non-canonical by default.  Fixes some issues
    with canonical mode not being handled properly in rfcomm_tty_write.

rfcomm-keep-modem-status:
    Keep the modem status around in case the tty really needs it.

-Denis
</pre><pre>diff --git a/include/net/bluetooth/rfcomm.h b/include/net/bluetooth/rfcomm.h
index 98ec7a3..368628f 100644
--- a/include/net/bluetooth/rfcomm.h
+++ b/include/net/bluetooth/rfcomm.h
@@ -193,7 +193,8 @@ struct rfcomm_dlc {
 
 	void (*data_ready)(struct rfcomm_dlc *d, struct sk_buff *skb);
 	void (*state_change)(struct rfcomm_dlc *d, int err);
-	void (*modem_status)(struct rfcomm_dlc *d, u8 v24_sig);
+	void (*modem_status)(struct rfcomm_dlc *d);
+	u8            remote_v24_sig;
 };
 
 /* DLC and session flags */
diff --git a/net/bluetooth/rfcomm/core.c b/net/bluetooth/rfcomm/core.c
index e4142ea..6a97f02 100644
--- a/net/bluetooth/rfcomm/core.c
+++ b/net/bluetooth/rfcomm/core.c
@@ -1458,8 +1458,9 @@ static int rfcomm_recv_msc(struct rfcomm_session *s, int cr, struct sk_buff *skb
 			clear_bit(RFCOMM_TX_THROTTLED, &amp;d-&gt;flags);
 
 		rfcomm_dlc_lock(d);
+		d-&gt;remote_v24_sig = msc-&gt;v24_sig;
 		if (d-&gt;modem_status)
-			d-&gt;modem_status(d, msc-&gt;v24_sig);
+			d-&gt;modem_status(d);
 		rfcomm_dlc_unlock(d);
 
 		rfcomm_send_msc(s, 0, dlci, msc-&gt;v24_sig);
diff --git a/net/bluetooth/rfcomm/tty.c b/net/bluetooth/rfcomm/tty.c
index db27f3f..68023be 100644
--- a/net/bluetooth/rfcomm/tty.c
+++ b/net/bluetooth/rfcomm/tty.c
@@ -87,7 +87,7 @@ static DEFINE_RWLOCK(rfcomm_dev_lock);
 
 static void rfcomm_dev_data_ready(struct rfcomm_dlc *dlc, struct sk_buff *skb);
 static void rfcomm_dev_state_change(struct rfcomm_dlc *dlc, int err);
-static void rfcomm_dev_modem_status(struct rfcomm_dlc *dlc, u8 v24_sig);
+static void rfcomm_dev_modem_status(struct rfcomm_dlc *dlc);
 
 static void rfcomm_tty_wakeup(unsigned long arg);
 
@@ -292,6 +292,9 @@ static int rfcomm_dev_add(struct rfcomm_dev_req *req, struct rfcomm_dlc *dlc)
 
 	dlc-&gt;owner = dev;
 	dev-&gt;dlc   = dlc;
+
+	/* Update the modem_status, call under lock */
+	rfcomm_dev_modem_status(dlc);
 	rfcomm_dlc_unlock(dlc);
 
 	/* It's safe to call __module_get() here because socket already
@@ -619,9 +622,12 @@ static void rfcomm_dev_state_change(struct rfcomm_dlc *dlc, int err)
 	}
 }
 
-static void rfcomm_dev_modem_status(struct rfcomm_dlc *dlc, u8 v24_sig)
+/* This is called under dlc lock, so we can safely mess with dlc here */
+static void rfcomm_dev_modem_status(struct rfcomm_dlc *dlc)
 {
 	struct rfcomm_dev *dev = dlc-&gt;owner;
+	u8 v24_sig = dlc-&gt;remote_v24_sig;
+
 	if (!dev)
 		return;
 
</pre><pre>diff --git a/net/bluetooth/rfcomm/core.c b/net/bluetooth/rfcomm/core.c
index 0c2c937..e4142ea 100644
--- a/net/bluetooth/rfcomm/core.c
+++ b/net/bluetooth/rfcomm/core.c
@@ -457,7 +457,6 @@ int rfcomm_dlc_send(struct rfcomm_dlc *d, struct sk_buff *skb)
 	if (len &gt; d-&gt;mtu)
 		return -EINVAL;
 
-	rfcomm_make_uih(skb, d-&gt;addr);
 	skb_queue_tail(&amp;d-&gt;tx_queue, skb);
 
 	if (!test_bit(RFCOMM_TX_THROTTLED, &amp;d-&gt;flags))
@@ -1674,6 +1673,7 @@ static inline int rfcomm_process_tx(struct rfcomm_dlc *d)
 		return skb_queue_len(&amp;d-&gt;tx_queue);
 
 	while (d-&gt;tx_credits &amp;&amp; (skb = skb_dequeue(&amp;d-&gt;tx_queue))) {
+		rfcomm_make_uih(skb, d-&gt;addr);
 		err = rfcomm_send_frame(d-&gt;session, skb-&gt;data, skb-&gt;len);
 		if (err &lt; 0) {
 			skb_queue_head(&amp;d-&gt;tx_queue, skb);
diff --git a/net/bluetooth/rfcomm/tty.c b/net/bluetooth/rfcomm/tty.c
index c919187..f2a2e1c 100644
--- a/net/bluetooth/rfcomm/tty.c
+++ b/net/bluetooth/rfcomm/tty.c
@@ -77,6 +77,9 @@ struct rfcomm_dev {
 	struct device		*tty_dev;
 
 	atomic_t 		wmem_alloc;
+
+	struct sk_buff_head	rx_queue;
+	atomic_t		rxq_mem_alloc;
 };
 
 static LIST_HEAD(rfcomm_dev_list);
@@ -88,6 +91,8 @@ static void rfcomm_dev_modem_status(struct rfcomm_dlc *dlc, u8 v24_sig);
 
 static void rfcomm_tty_wakeup(unsigned long arg);
 
+static void rfcomm_tty_copy_buffered(struct rfcomm_dev *dev);
+
 /* ---- Device functions ---- */
 static void rfcomm_dev_destruct(struct rfcomm_dev *dev)
 {
@@ -207,6 +212,8 @@ static int rfcomm_dev_add(struct rfcomm_dev_req *req, struct rfcomm_dlc *dlc)
 	struct rfcomm_dev *dev;
 	struct list_head *head = &amp;rfcomm_dev_list, *p;
 	int err = 0;
+	struct sock *sk;
+	struct sk_buff *skb;
 
 	BT_DBG(&quot;id %d channel %d&quot;, req-&gt;dev_id, req-&gt;channel);
 
@@ -263,8 +270,20 @@ static int rfcomm_dev_add(struct rfcomm_dev_req *req, struct rfcomm_dlc *dlc)
 
 	init_waitqueue_head(&amp;dev-&gt;wait);
 	tasklet_init(&amp;dev-&gt;wakeup_task, rfcomm_tty_wakeup, (unsigned long) dev);
+	skb_queue_head_init(&amp;dev-&gt;rx_queue);
+	atomic_set(&amp;dev-&gt;rxq_mem_alloc, 0);
 
 	rfcomm_dlc_lock(dlc);
+
+	if ((req-&gt;flags &amp; (1 &lt;&lt; RFCOMM_REUSE_DLC)) &amp;&amp; (sk = dlc-&gt;owner)) {
+		while ((skb = skb_dequeue(&amp;sk-&gt;sk_receive_queue))) {
+			skb_orphan(skb);
+			atomic_sub(skb-&gt;len, &amp;sk-&gt;sk_rmem_alloc);
+			atomic_add(skb-&gt;len, &amp;dev-&gt;rxq_mem_alloc);
+			skb_queue_tail(&amp;dev-&gt;rx_queue, skb);
+		}
+	}
+
 	dlc-&gt;data_ready   = rfcomm_dev_data_ready;
 	dlc-&gt;state_change = rfcomm_dev_state_change;
 	dlc-&gt;modem_status = rfcomm_dev_modem_status;
@@ -539,11 +558,21 @@ static void rfcomm_dev_data_ready(struct rfcomm_dlc *dlc, struct sk_buff *skb)
 	struct rfcomm_dev *dev = dlc-&gt;owner;
 	struct tty_struct *tty;
 
-	if (!dev || !(tty = dev-&gt;tty)) {
+	if (!dev) {
 		kfree_skb(skb);
 		return;
 	}
 
+	if (!(tty = dev-&gt;tty) || !skb_queue_empty(&amp;dev-&gt;rx_queue)) {
+		atomic_add(skb-&gt;len, &amp;dev-&gt;rxq_mem_alloc);
+		skb_queue_tail(&amp;dev-&gt;rx_queue, skb);
+
+		if (atomic_read(&amp;dev-&gt;rxq_mem_alloc) &gt;= RFCOMM_MAX_CREDITS * RFCOMM_DEFAULT_MTU * 10)
+			rfcomm_dlc_throttle(dlc);
+
+		return;
+	}
+
 	BT_DBG(&quot;dlc %p tty %p len %d&quot;, dlc, tty, skb-&gt;len);
 
 	tty_insert_flip_string(tty, skb-&gt;data, skb-&gt;len);
@@ -627,6 +656,33 @@ static void rfcomm_tty_wakeup(unsigned long arg)
 #endif
 }
 
+static void rfcomm_tty_copy_buffered(struct rfcomm_dev *dev)
+{
+	struct tty_struct *tty = dev-&gt;tty;
+	struct sk_buff *skb;
+	int inserted;
+
+	if (!tty)
+		return;
+
+	BT_DBG(&quot;dev %p tty %p&quot;, dev, tty);
+
+	rfcomm_dlc_lock(dev-&gt;dlc);
+
+	inserted = 0;
+	while ((skb = skb_dequeue(&amp;dev-&gt;rx_queue))) {
+		inserted += tty_insert_flip_string(tty, skb-&gt;data, skb-&gt;len);
+		kfree_skb(skb);
+	}
+
+	rfcomm_dlc_unlock(dev-&gt;dlc);
+
+	if (inserted) {
+		tty_flip_buffer_push(tty);
+		rfcomm_dlc_unthrottle(dev-&gt;dlc);
+	}
+}
+
 static int rfcomm_tty_open(struct tty_struct *tty, struct file *filp)
 {
 	DECLARE_WAITQUEUE(wait, current);
@@ -691,6 +747,8 @@ static int rfcomm_tty_open(struct tty_struct *tty, struct file *filp)
 	if (err == 0)
 		device_move(dev-&gt;tty_dev, rfcomm_get_device(dev));
 
+	rfcomm_tty_copy_buffered(dev);
+
 	return err;
 }
 
</pre><pre>diff --git a/net/bluetooth/rfcomm/tty.c b/net/bluetooth/rfcomm/tty.c
index f2a2e1c..e1b7976 100644
--- a/net/bluetooth/rfcomm/tty.c
+++ b/net/bluetooth/rfcomm/tty.c
@@ -1181,6 +1181,7 @@ int rfcomm_init_ttys(void)
 	rfcomm_tty_driver-&gt;flags	= TTY_DRIVER_REAL_RAW | TTY_DRIVER_DYNAMIC_DEV;
 	rfcomm_tty_driver-&gt;init_termios	= tty_std_termios;
 	rfcomm_tty_driver-&gt;init_termios.c_cflag	= B9600 | CS8 | CREAD | HUPCL | CLOCAL;
+	rfcomm_tty_driver-&gt;init_termios.c_lflag &amp;= ~ICANON;
 	tty_set_operations(rfcomm_tty_driver, &amp;rfcomm_ops);
 
 	if (tty_register_driver(rfcomm_tty_driver)) {
</pre><pre>-------------------------------------------------------------------------
Check out the new SourceForge.net Marketplace.
It's the best place to buy or sell services for
just about anything Open Source.
<a  rel="nofollow" href="http://sourceforge.net/services/buy/index.php">http://sourceforge.net/services/buy/index.php</a></pre><pre>_______________________________________________
Bluez-devel mailing list
Bluez-devel@xxxxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://lists.sourceforge.net/lists/listinfo/bluez-devel">https://lists.sourceforge.net/lists/listinfo/bluez-devel</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00296.html">Re:  Fw: Next Release, and Device.DiscoverServices</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00298.html">[PATCH] Fixes for RFCOMM #2</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00293.html">Next Release, and Device.DiscoverServices</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00298.html">[PATCH] Fixes for RFCOMM #2</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00297"><strong>Date</strong></a></li>
<li><a href="index.html#00297"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-bluetooth/>[Linux&nbsp;Bluetooth&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/netdev/>[Network&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

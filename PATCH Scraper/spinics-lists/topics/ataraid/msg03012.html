<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH] Promise FastTrack metadata detection -->
<!--X-From-R13: [ngguvnf Ybravt &#60;zxbravtNfhfr.qr> -->
<!--X-Date: Wed, 12 Sep 2007 06:24:47 &#45;0700 -->
<!--X-Message-Id: n7xbqc88153.fsf@sor.suse.de -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="[PATCH] Promise FastTrack metadata detection &mdash; Linux ATA RAID Storage Archive">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Linux ATA RAID Storage &mdash; [PATCH] Promise FastTrack metadata detection</title>
<link rel="alternate" type="application/rss+xml" title="ATA RAID" href="//feeds2.feedburner.com/ataraid">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en" async defer></script>
<h1 itemprop="name">[PATCH] Promise FastTrack metadata detection</h1>
[<a href="msg03011.html">Date Prev</a>][<a href="msg03013.html">Date Next</a>][<a href="msg03005.html">Thread Prev</a>][<a href="msg03014.html">Thread Next</a>][<a href="maillist.html#03012">Date Index</a>][<a href="threads.html#03012">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH] Promise FastTrack metadata detection</li>
<li><em>From</em>: Matthias Koenig &lt;<a href="mailto:mkoenig@DOMAIN.HIDDEN">mkoenig@xxxxxxx</a>&gt;</li>
<li><em>Date</em>: Wed, 12 Sep 2007 15:27:20 +0200</li>
<li><em>Organization</em>: SUSE Linux Products GmbH, Nuernberg</li>
<li><em>User-agent</em>: Gnus/5.110006 (No Gnus v0.6) Emacs/22.1 (gnu/linux)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" defer async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Hi,

we noticed that dmraid has not been able to detect the metadata for the
following card:
  Model: &quot;Promise FastTrak100 TX2&quot;
  Vendor: pci 0x105a &quot;Promise Technology, Inc.&quot;
  Device: pci 0x6268 &quot;PDC20270 (FastTrak100 LP/TX2/TX4)&quot;
  SubVendor: pci 0x105a &quot;Promise Technology, Inc.&quot;
  SubDevice: pci 0x4d68 &quot;FastTrak100 TX2&quot;

with a disk size &gt; 128 GB.

The reason is that the BIOS setup tool only detects up to 268435377 sectors
(while the actual size of the tested device is 488397168 sectors).
So the metadata is written at sector 268435377, where it is not detected
by dmraid, because it has a list of offsets from the end of the device.

I am not sure if this limitation applies to more Promise cards. A patch which
works with our test machine is below. Of course it does not allow to use more
than the limit, but at least the metadata is detected and the device can be set
up.

Matthias

</pre><pre>Index: 1.0.0.rc14/lib/format/ataraid/pdc.c
===================================================================
--- 1.0.0.rc14.orig/lib/format/ataraid/pdc.c
+++ 1.0.0.rc14/lib/format/ataraid/pdc.c
@@ -155,6 +155,21 @@ static void *pdc_read_metadata(struct li
 			}
 		}
 
+		/* Some pdc card detect only PDC_MAX_SECTOR sectors, even
+		 * if the disk is bigger, this prevents dmraid from discovering
+		 * the metadata. This quirk searches for metadata at the
+		 * sector PDC_MAX_SECTOR
+		 */
+		if (di-&gt;sectors &gt;= PDC_MAX_SECTOR) {
+			if (read_file(lc, handler, di-&gt;path, ret, sizeof(*ret),
+				      PDC_MAX_SECTOR &lt;&lt; 9) &amp;&amp;
+			    !strncmp((const char*) ret-&gt;promise_id, PDC_MAGIC,
+				     PDC_ID_LENGTH)) {
+				info-&gt;u32 = PDC_MAX_SECTOR;
+				return (void*) ret;
+			}
+		}
+
 		dbg_free(ret);
 	}
 
Index: 1.0.0.rc14/lib/format/ataraid/pdc.h
===================================================================
--- 1.0.0.rc14.orig/lib/format/ataraid/pdc.h
+++ 1.0.0.rc14/lib/format/ataraid/pdc.h
@@ -16,6 +16,9 @@
 #define PDC_CONFIGOFFSETS	63,255,256,16,399,735
 #define	PDC_DATAOFFSET 0
 
+/* maximum device size (sectors) which can be detected by some pdc card */
+#define PDC_MAX_SECTOR 268435377UL
+
 /* Ondisk metadata for Promise Fastrack */
 struct pdc {
 #define PDC_ID_LENGTH	24
</pre><pre>_______________________________________________
Ataraid-list mailing list
Ataraid-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/ataraid-list">https://www.redhat.com/mailman/listinfo/ataraid-list</a></pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="03014" href="msg03014.html">Re: [PATCH] Promise FastTrack metadata detection</a></strong>
<ul><li><em>From:</em> Heinz Mauelshagen</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg03011.html">RE: Ataraid-list Digest, Vol 42, Issue 15</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg03013.html">Re: Ali/Uli 528(8|9) BIOSRAID?</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg03005.html">RE: Ataraid-list Digest, Vol 42, Issue 15</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg03014.html">Re: [PATCH] Promise FastTrack metadata detection</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#03012"><strong>Date</strong></a></li>
<li><a href="threads.html#03012"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/raid/>[Linux&nbsp;RAID]</a>
&nbsp;
&nbsp;
<a href=/lists/dm-devel/>[Linux&nbsp;Device&nbsp;Mapper]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-ide/>[Linux&nbsp;IDE]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Kernel]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art/z/biglist.php>[Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-admin/>[Linux&nbsp;Admin]</a>
&nbsp;
&nbsp;
<a href=/lists/gfs/>[GFS]</a>
&nbsp;
&nbsp;
<a href=/lists/rpm/>[RPM]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;Campgrounds]</a>
&nbsp;
&nbsp;
<a href=/lists/amd64/>[AMD&nbsp;64]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH 3/4] ALSA: compress: Don't allow drain operations on capture streams -->
<!--X-From-R13: Hvabq Ybhy &#60;ixbhyNxreary.bet> -->
<!--X-Date: Tue, 9 Jul 2019 04:40:46 &#45;0700 -->
<!--X-Message-Id: 20190709113633.GL2911@vkoul&#45;mobl -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190709105211.11741&#45;1&#45;ckeepax@opensource.cirrus.com -->
<!--X-Reference: 20190709105211.11741&#45;3&#45;ckeepax@opensource.cirrus.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re:  [PATCH 3/4] ALSA: compress: Don't allow drain operations on capture streams &mdash; ALSA Devel">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re:  [PATCH 3/4] ALSA: compress: Don't allow drain operations on capture streams &mdash; ALSA Devel</title>
<link rel="alternate" type="application/rss+xml" title="ALSA Devel" href="//feedproxy.google.com/AlsaDevel">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [PATCH 3/4] ALSA: compress: Don't allow drain operations on capture streams</h1>
[<a href="msg93631.html">Date Prev</a>][<a href="msg93633.html">Date Next</a>][<a href="msg93631.html">Thread Prev</a>][<a href="msg93638.html">Thread Next</a>][<a href="maillist.html#93632">Date Index</a>][<a href="threads.html#93632">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Charles Keepax &lt;ckeepax@xxxxxxxxxxxxxxxxxxxxx&gt;</li>
<li><em>Subject</em>: Re:  [PATCH 3/4] ALSA: compress: Don't allow drain operations on capture streams</li>
<li><em>From</em>: Vinod Koul &lt;vkoul@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 9 Jul 2019 17:06:33 +0530</li>
<li><em>Cc</em>: patches@xxxxxxxxxxxxxxxxxxxxx, alsa-devel@xxxxxxxxxxxxxxxx, tiwai@xxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg93631.html">20190709105211.11741-3-ckeepax@opensource.cirrus.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg93628.html">20190709105211.11741-1-ckeepax@opensource.cirrus.com</a>&gt; &lt;<a href="msg93631.html">20190709105211.11741-3-ckeepax@opensource.cirrus.com</a>&gt;</li>
<li><em>User-agent</em>: Mutt/1.11.3 (2019-02-01)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On 09-07-19, 11:52, Charles Keepax wrote:
&gt; Partial drain and next track are intended for gapless playback and
&gt; don't really have an obvious interpretation for a capture stream, so
&gt; makes sense to not allow those operations on capture streams. Drain

Sounds right

&gt; would make sense on a capture stream but currently the implementation
&gt; of drain involves the kernel waiting for the DSP to consume its
&gt; available data, whereas a capture drain would involve waiting for
&gt; user-space to consume the data available on the DSP. Disallow drain
&gt; on capture streams until that is implemented.

Well it in unclear to me about the support required in kernel! Kernel
issues drain request to DSP and waits for that to be done. When DSP has
encoded and copied the data the notification should make drain complete.
So I dont see anything in kernel required for that

&gt; 
&gt; Signed-off-by: Charles Keepax &lt;ckeepax@xxxxxxxxxxxxxxxxxxxxx&gt;
&gt; ---
&gt;  sound/core/compress_offload.c | 12 ++++++++++++
&gt;  1 file changed, 12 insertions(+)
&gt; 
&gt; diff --git a/sound/core/compress_offload.c b/sound/core/compress_offload.c
&gt; index e1a216fd832f9..c7d56cee0d510 100644
&gt; --- a/sound/core/compress_offload.c
&gt; +++ b/sound/core/compress_offload.c
&gt; @@ -829,6 +829,10 @@ static int snd_compr_drain(struct snd_compr_stream *stream)
&gt;  		break;
&gt;  	}
&gt;  
&gt; +	/* drain not implemented for capture streams yet */
&gt; +	if (stream-&gt;direction == SND_COMPRESS_CAPTURE)
&gt; +		return -EPERM;
&gt; +
&gt;  	retval = stream-&gt;ops-&gt;trigger(stream, SND_COMPR_TRIGGER_DRAIN);
&gt;  	if (retval) {
&gt;  		pr_debug(&quot;SND_COMPR_TRIGGER_DRAIN failed %d\n&quot;, retval);
&gt; @@ -847,6 +851,10 @@ static int snd_compr_next_track(struct snd_compr_stream *stream)
&gt;  	if (stream-&gt;runtime-&gt;state != SNDRV_PCM_STATE_RUNNING)
&gt;  		return -EPERM;
&gt;  
&gt; +	/* next track doesn't have any meaning for capture streams */
&gt; +	if (stream-&gt;direction == SND_COMPRESS_CAPTURE)
&gt; +		return -EPERM;
&gt; +
&gt;  	/* you can signal next track if this is intended to be a gapless stream
&gt;  	 * and current track metadata is set
&gt;  	 */
&gt; @@ -874,6 +882,10 @@ static int snd_compr_partial_drain(struct snd_compr_stream *stream)
&gt;  		break;
&gt;  	}
&gt;  
&gt; +	/* partial drain doesn't have any meaning for capture streams */
&gt; +	if (stream-&gt;direction == SND_COMPRESS_CAPTURE)
&gt; +		return -EPERM;
&gt; +
&gt;  	/* stream can be drained only when next track has been signalled */
&gt;  	if (stream-&gt;next_track == false)
&gt;  		return -EPERM;
&gt; -- 
&gt; 2.11.0

-- 
~Vinod
_______________________________________________
Alsa-devel mailing list
Alsa-devel@xxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://mailman.alsa-project.org/mailman/listinfo/alsa-devel">https://mailman.alsa-project.org/mailman/listinfo/alsa-devel</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="93638" href="msg93638.html">Re:  [PATCH 3/4] ALSA: compress: Don't allow drain operations on capture streams</a></strong>
<ul><li><em>From:</em> Charles Keepax</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="93628" href="msg93628.html">[PATCH 1/4] ALSA: compress: Fix regression on	compressed capture streams</a></strong>
<ul><li><em>From:</em> Charles Keepax</li></ul></li>
<li><strong><a name="93631" href="msg93631.html">[PATCH 3/4] ALSA: compress: Don't allow drain	operations on capture streams</a></strong>
<ul><li><em>From:</em> Charles Keepax</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg93631.html">[PATCH 3/4] ALSA: compress: Don't allow drain	operations on capture streams</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg93633.html">Re:  [PATCH] ASoC: Intel: Atom: read timestamp moved to	period_elapsed</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg93631.html">[PATCH 3/4] ALSA: compress: Don't allow drain	operations on capture streams</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg93638.html">Re:  [PATCH 3/4] ALSA: compress: Don't allow drain operations on capture streams</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#93632"><strong>Date</strong></a></li>
<li><a href="threads.html#93632"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/alsa-user/>[ALSA&nbsp;User]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/pulse-audio/>[Pulse&nbsp;Audio]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Kernel&nbsp;Archive]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=http://yosemitephotos.net/>[Photo&nbsp;Sharing]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/linux-sound/>[Linux&nbsp;Sound]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-media/>[Video&nbsp;4&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/gimp/>[Gimp]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

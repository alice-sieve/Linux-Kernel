<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [ALSA patch] [PATCH 1/2] alsa: pcm: add	unsupported OPS -->
<!--X-From-R13: "[vneghf, Oqnz (Oevba Drpehvgzrag; ORWFU/SE[)" &#60;nzvneghfNqr.nqvg&#45;wi.pbz> -->
<!--X-Date: Thu, 11 Jul 2019 07:59:44 &#45;0700 -->
<!--X-Message-Id: B174E9FCEE9A8C46B11E4DF2E32993627B83B9@HI2EXCH01.adit&#45;jv.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 1562583889&#45;2109&#45;1&#45;git&#45;send&#45;email&#45;amiartus@de.adit&#45;jv.com -->
<!--X-Reference: 1562583889&#45;2109&#45;2&#45;git&#45;send&#45;email&#45;amiartus@de.adit&#45;jv.com -->
<!--X-Reference: s5hy317tmxv.wl&#45;tiwai@suse.de -->
<!--X-Reference: B174E9FCEE9A8C46B11E4DF2E32993627B7FCA@HI2EXCH01.adit&#45;jv.com -->
<!--X-Reference: s5hftneq6ja.wl&#45;tiwai@suse.de -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re:  [ALSA patch] [PATCH 1/2] alsa: pcm: add	unsupported OPS &mdash; ALSA Devel">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re:  [ALSA patch] [PATCH 1/2] alsa: pcm: add	unsupported OPS &mdash; ALSA Devel</title>
<link rel="alternate" type="application/rss+xml" title="ALSA Devel" href="//feedproxy.google.com/AlsaDevel">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [ALSA patch] [PATCH 1/2] alsa: pcm: add	unsupported OPS</h1>
[<a href="msg93717.html">Date Prev</a>][<a href="msg93719.html">Date Next</a>][<a href="msg93688.html">Thread Prev</a>][<a href="msg93802.html">Thread Next</a>][<a href="maillist.html#93718">Date Index</a>][<a href="threads.html#93718">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Takashi Iwai &lt;tiwai@xxxxxxx&gt;</li>
<li><em>Subject</em>: Re:  [ALSA patch] [PATCH 1/2] alsa: pcm: add	unsupported OPS</li>
<li><em>From</em>: &quot;Miartus, Adam (Arion Recruitment; ADITG/ESM)&quot; &lt;amiartus@xxxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 11 Jul 2019 14:58:34 +0000</li>
<li><em>Cc</em>: &quot;alsa-devel@xxxxxxxxxxxxxxxx&quot; &lt;alsa-devel@xxxxxxxxxxxxxxxx&gt;,        &quot;Pape, Andreas \(ADITG/ESS1\)&quot; &lt;apape@xxxxxxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg93688.html">s5hftneq6ja.wl-tiwai@suse.de</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg93613.html">1562583889-2109-1-git-send-email-amiartus@de.adit-jv.com</a>&gt; &lt;<a href="msg93614.html">1562583889-2109-2-git-send-email-amiartus@de.adit-jv.com</a>&gt; &lt;<a href="msg93637.html">s5hy317tmxv.wl-tiwai@suse.de</a>&gt; &lt;<a href="msg93687.html">B174E9FCEE9A8C46B11E4DF2E32993627B7FCA@HI2EXCH01.adit-jv.com</a>&gt; &lt;<a href="msg93688.html">s5hftneq6ja.wl-tiwai@suse.de</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>&gt; -----Original Message-----
&gt; From: Takashi Iwai &lt;tiwai@xxxxxxx&gt;
&gt; Sent: Mittwoch, 10. Juli 2019 17:00
&gt; To: Miartus, Adam (Arion Recruitment; ADITG/ESM) &lt;amiartus@xxxxxxx-
&gt; jv.com&gt;
&gt; Cc: alsa-devel@xxxxxxxxxxxxxxxx; Pape, Andreas (ADITG/ESS1)
&gt; &lt;apape@xxxxxxxxxxxxxx&gt;
&gt; Subject: Re: [ALSA patch] [PATCH 1/2] alsa: pcm: add unsupported OPS
&gt; 
&gt; On Wed, 10 Jul 2019 16:58:06 +0200,
&gt; Miartus, Adam (Arion Recruitment; ADITG/ESM) wrote:
&gt; &gt;
&gt; &gt; &gt; -----Original Message-----
&gt; &gt; &gt; From: Takashi Iwai &lt;tiwai@xxxxxxx&gt;
&gt; &gt; &gt; Sent: Dienstag, 9. Juli 2019 14:25
&gt; &gt; &gt; To: Miartus, Adam (Arion Recruitment; ADITG/ESM) &lt;amiartus@xxxxxxx-
&gt; &gt; &gt; jv.com&gt;
&gt; &gt; &gt; Cc: alsa-devel@xxxxxxxxxxxxxxxx; Pape, Andreas (ADITG/ESS1)
&gt; &gt; &gt; &lt;apape@xxxxxxxxxxxxxx&gt;
&gt; &gt; &gt; Subject: Re: [ALSA patch] [PATCH 1/2] alsa: pcm: add unsupported OPS
&gt; &gt; &gt;
&gt; &gt; &gt; On Mon, 08 Jul 2019 13:04:48 +0200,
&gt; &gt; &gt; Adam Miartus wrote:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; From: Andreas Pape &lt;apape@xxxxxxxxxxxxxx&gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Signed-off-by: Andreas Pape &lt;apape@xxxxxxxxxxxxxx&gt;
&gt; &gt; &gt; &gt; Signed-off-by: Adam Miartus &lt;amiartus@xxxxxxxxxxxxxx&gt;
&gt; &gt; &gt;
&gt; &gt; &gt; No description isn't good at all.  There must be something you can
&gt; &gt; &gt; explain in details here.
&gt; &gt;
&gt; &gt; Certainly, I will add explanation in patch v2.
&gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; About the changes:
&gt; &gt; &gt;
&gt; &gt; &gt; &gt; +#define PCM_UNSUPPORTED_ERR (-ENOSYS)
&gt; &gt; &gt; &gt; +void snd_pcm_unsupported_dump(snd_pcm_t *pcm, snd_output_t
&gt; &gt; &gt; *out)
&gt; &gt; &gt; &gt; +{
&gt; &gt; &gt; &gt; +	snd_output_printf(out, &quot;unsupported\n&quot;);
&gt; &gt; &gt; &gt; +}
&gt; &gt; &gt;
&gt; &gt; &gt; IMO, we don't need to show anything if it's dummy.
&gt; &gt; &gt; And, maybe it's more straightforward to let the PCM core allow NULL
&gt; &gt; &gt; ops?
&gt; &gt; &gt;
&gt; &gt;
&gt; &gt; If you agree I could add following in patch v2, then we could drop
&gt; snd_pcm_unsupported_dump function altogether
&gt; &gt;
&gt; &gt; diff --git a/src/pcm/pcm.c b/src/pcm/pcm.c
&gt; &gt; index e0ceccc..4d91d4d 100644
&gt; &gt; --- a/src/pcm/pcm.c
&gt; &gt; +++ b/src/pcm/pcm.c
&gt; &gt; @@ -2277,7 +2277,8 @@ int snd_pcm_dump(snd_pcm_t *pcm,
&gt; snd_output_t *out)
&gt; &gt;  {
&gt; &gt;         assert(pcm);
&gt; &gt;         assert(out);
&gt; &gt; -       pcm-&gt;ops-&gt;dump(pcm-&gt;op_arg, out);
&gt; &gt; +       if (pcm-&gt;ops-&gt;dump)
&gt; &gt; +               pcm-&gt;ops-&gt;dump(pcm-&gt;op_arg, out);
&gt; &gt;         return 0;
&gt; &gt;  }
&gt; 
&gt; I *guess* this would be simpler in the end, although I'm fine with
&gt; your original idea, too.  Let's see and compare the both results.

Yes I agree, it would even be better to remove the pcm_unsupported.c altogether.
I had a look at how snd_pcm_ops_t and snd_pcm_fast_ops_t callbacks are used in alsa-lib
and in most cases (90% or more) it is assumed that the function pointer is valid without
checking for NULL.

Unfortunately, not all functions in ops and fast_ops share the same return type,
so checking for null pointer in a macro is not straightforward. One way I see is to add:

if (ops-&gt;callback == NULL)
	return -ENOSYS;

check in every occurrence of ops callback call in source code, then we could drop
pcm_unsupported.c file completely.

Optionally we could add a set of macros such as (it compiled both in gcc and in clang)

#define snd_callback_int(fpointer, ...) ({ \
	int result; \
	if (fpointer == NULL) \
		result = -ENOSYS; \
	else \
		result = fpointer(__VA_ARGS__); \
	result; \
})

For each ops function return types, currently these are:
int, void, snd_pcm_chmap_query_t**, snd_pcm_chmap_t *, 
snd_pcm_state_t, snd_pcm_sframes_t

So, the variants for macros would be:
snd_callback_void
snd_callback_int
snd_callback_ptr
snd_callback_sframes

This might seem like cumbersome approach but it would save lines of code
and provide a way to check for null callback pointer, which is currently not
done in most cases.

What do you think about these two approaches, what could you consider
correct and able to be merged?

Adam
_______________________________________________
Alsa-devel mailing list
Alsa-devel@xxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://mailman.alsa-project.org/mailman/listinfo/alsa-devel">https://mailman.alsa-project.org/mailman/listinfo/alsa-devel</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="93802" href="msg93802.html">Re:  [ALSA patch] [PATCH 1/2] alsa: pcm: add	unsupported OPS</a></strong>
<ul><li><em>From:</em> Takashi Iwai</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="93613" href="msg93613.html">[PATCH 0/2] expand dshare to allow audio clock when	not streaming data</a></strong>
<ul><li><em>From:</em> Adam Miartus</li></ul></li>
<li><strong><a name="93614" href="msg93614.html">[PATCH 1/2] alsa: pcm: add unsupported OPS</a></strong>
<ul><li><em>From:</em> Adam Miartus</li></ul></li>
<li><strong><a name="93637" href="msg93637.html">Re:  [ALSA patch] [PATCH 1/2] alsa: pcm: add	unsupported OPS</a></strong>
<ul><li><em>From:</em> Takashi Iwai</li></ul></li>
<li><strong><a name="93687" href="msg93687.html">Re:  [ALSA patch] [PATCH 1/2] alsa: pcm: add	unsupported OPS</a></strong>
<ul><li><em>From:</em> Miartus, Adam (Arion Recruitment; ADITG/ESM)</li></ul></li>
<li><strong><a name="93688" href="msg93688.html">Re:  [ALSA patch] [PATCH 1/2] alsa: pcm: add	unsupported OPS</a></strong>
<ul><li><em>From:</em> Takashi Iwai</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg93717.html">Re:  DW-DMA: Probe failures on broadwell</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg93719.html">Re:  [PATCH V4 2/2] ASoC: fsl_esai: recover the channel swap after xrun</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg93688.html">Re:  [ALSA patch] [PATCH 1/2] alsa: pcm: add	unsupported OPS</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg93802.html">Re:  [ALSA patch] [PATCH 1/2] alsa: pcm: add	unsupported OPS</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#93718"><strong>Date</strong></a></li>
<li><a href="threads.html#93718"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/alsa-user/>[ALSA&nbsp;User]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/pulse-audio/>[Pulse&nbsp;Audio]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Kernel&nbsp;Archive]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=http://yosemitephotos.net/>[Photo&nbsp;Sharing]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/linux-sound/>[Linux&nbsp;Sound]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-media/>[Video&nbsp;4&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/gimp/>[Gimp]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

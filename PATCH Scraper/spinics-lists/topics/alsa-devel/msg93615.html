<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH 2/2] alsa: dshare: allow missing bindings -->
<!--X-From-R13: Oqnz [vneghf &#60;nzvneghfNqr.nqvg&#45;wi.pbz> -->
<!--X-Date: Mon, 8 Jul 2019 04:07:48 &#45;0700 -->
<!--X-Message-Id: 1562583889&#45;2109&#45;3&#45;git&#45;send&#45;email&#45;amiartus@de.adit&#45;jv.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 1562583889&#45;2109&#45;1&#45;git&#45;send&#45;email&#45;amiartus@de.adit&#45;jv.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="[PATCH 2/2] alsa: dshare: allow missing bindings &mdash; ALSA Devel">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[PATCH 2/2] alsa: dshare: allow missing bindings &mdash; ALSA Devel</title>
<link rel="alternate" type="application/rss+xml" title="ALSA Devel" href="//feedproxy.google.com/AlsaDevel">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH 2/2] alsa: dshare: allow missing bindings</h1>
[<a href="msg93614.html">Date Prev</a>][<a href="msg93616.html">Date Next</a>][<a href="msg93802.html">Thread Prev</a>][<a href="msg93619.html">Thread Next</a>][<a href="maillist.html#93615">Date Index</a>][<a href="threads.html#93615">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: &lt;patch@xxxxxxxxxxxxxxxx&gt;</li>
<li><em>Subject</em>: [PATCH 2/2] alsa: dshare: allow missing bindings</li>
<li><em>From</em>: Adam Miartus &lt;amiartus@xxxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Mon, 8 Jul 2019 13:04:49 +0200</li>
<li><em>Cc</em>: alsa-devel@xxxxxxxxxxxxxxxx, Andreas Pape &lt;apape@xxxxxxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg93613.html">1562583889-2109-1-git-send-email-amiartus@de.adit-jv.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg93613.html">1562583889-2109-1-git-send-email-amiartus@de.adit-jv.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>From: Andreas Pape &lt;apape@xxxxxxxxxxxxxx&gt;

The general idea of this patch is to be able to open the device without
defined bindings. This would start the audio clock without blocking
any channel.

This might be useful for hardware that requires running clock early at
system start and to be available even without application streaming
audio data.

Signed-off-by: Andreas Pape &lt;apape@xxxxxxxxxxxxxx&gt;
Signed-off-by: Adam Miartus &lt;amiartus@xxxxxxxxxxxxxx&gt;
---
 src/pcm/pcm_dshare.c      | 72 +++++++++++++++++++++++++++++++++++++++--------
 src/pcm/pcm_unsupported.h |  1 +
 2 files changed, 62 insertions(+), 11 deletions(-)

diff --git a/src/pcm/pcm_dshare.c b/src/pcm/pcm_dshare.c
index b75809c..9008748 100644
--- a/src/pcm/pcm_dshare.c
+++ b/src/pcm/pcm_dshare.c
@@ -44,6 +44,7 @@
 #include &lt;sys/un.h&gt;
 #include &lt;sys/mman.h&gt;
 #include &quot;pcm_direct.h&quot;
+#include &quot;pcm_unsupported.h&quot;
 
 #ifndef PIC
 /* entry for static linking */
@@ -508,7 +509,8 @@ static int snd_pcm_dshare_close(snd_pcm_t *pcm)
 
 	if (dshare-&gt;timer)
 		snd_timer_close(dshare-&gt;timer);
-	do_silenca(pcm);
+	if (dshare-&gt;bindings)
+		do_silence(pcm);
 	snd_pcm_direct_semaphore_down(dshare, DIRECT_IPC_SEM_CLIENT);
 	dshare-&gt;shmptr-&gt;u.dshare.chn_mask &amp;= ~dshare-&gt;u.dshare.chn_mask;
 	snd_pcm_close(dshare-&gt;spcm);
@@ -621,6 +623,54 @@ static void snd_pcm_dshare_dump(snd_pcm_t *pcm, snd_output_t *out)
 		snd_pcm_dump(dshare-&gt;spcm, out);
 }
 
+static const snd_pcm_ops_t snd_pcm_dshare_dummy_ops = {
+	.close = snd_pcm_dshare_close,
+	.info = snd_pcm_unsupported_info,
+	.hw_refine = snd_pcm_unsupported_hw_refine,
+	.hw_params = snd_pcm_unsupported_hw_params,
+	.hw_free = snd_pcm_unsupported_hw_free,
+	.sw_params = snd_pcm_unsupported_sw_params,
+	.channel_info = snd_pcm_unsupported_channel_info,
+	.dump = snd_pcm_unsupported_dump,
+	.nonblock = snd_pcm_unsupported_nonblock,
+	.async = snd_pcm_unsupported_async,
+	.mmap = snd_pcm_unsupported_mmap,
+	.munmap = snd_pcm_unsupported_munmap,
+	.get_chmap = snd_pcm_unsupported_get_chmap,
+	.set_chmap = snd_pcm_unsupported_set_chmap,
+};
+
+static const snd_pcm_fast_ops_t snd_pcm_dshare_fast_dummy_ops = {
+	.status = snd_pcm_unsupported_status,
+	.state = snd_pcm_unsupported_state,
+	.hwsync = snd_pcm_unsupported_hwsync,
+	.delay = snd_pcm_unsupported_delay,
+	.prepare = snd_pcm_unsupported_prepare,
+	.reset = snd_pcm_unsupported_reset,
+	.start = snd_pcm_unsupported_start,
+	.drop = snd_pcm_unsupported_drop,
+	.drain = snd_pcm_unsupported_drain,
+	.pause = snd_pcm_unsupported_pause,
+	.rewindable = snd_pcm_unsupported_rewindable,
+	.rewind = snd_pcm_unsupported_rewind,
+	.forwardable = snd_pcm_unsupported_forwardable,
+	.forward = snd_pcm_unsupported_forward,
+	.resume = snd_pcm_unsupported_resume,
+	.link = NULL,
+	.link_slaves = NULL,
+	.unlink = NULL,
+	.writei = snd_pcm_unsupported_writei,
+	.writen = snd_pcm_unsupported_writen,
+	.readi = snd_pcm_unsupported_readi,
+	.readn = snd_pcm_unsupported_readn,
+	.avail_update = snd_pcm_unsupported_avail_update,
+	.mmap_commit = snd_pcm_unsupported_mmap_commit,
+	.htimestamp = snd_pcm_unsupported_htimestamp,
+	.poll_descriptors = snd_pcm_unsupported_poll_descriptors,
+	.poll_descriptors_count = NULL,
+	.poll_revents = snd_pcm_unsupported_poll_revents,
+};
+
 static const snd_pcm_ops_t snd_pcm_dshare_ops = {
 	.close = snd_pcm_dshare_close,
 	.info = snd_pcm_direct_info,
@@ -713,12 +763,7 @@ int snd_pcm_dshare_open(snd_pcm_t **pcmp, const char *name,
 	if (ret &lt; 0)
 		goto _err_nosem;
 		
-	if (!dshare-&gt;bindings) {
-		SNDERR(&quot;dshare: specify bindings!!!&quot;);
-		ret = -EINVAL;
-		goto _err_nosem;
-	}
-	
+
 	dshare-&gt;ipc_key = opts-&gt;ipc_key;
 	dshare-&gt;ipc_perm = opts-&gt;ipc_perm;
 	dshare-&gt;ipc_gid = opts-&gt;ipc_gid;
@@ -751,9 +796,14 @@ int snd_pcm_dshare_open(snd_pcm_t **pcmp, const char *name,
 		SNDERR(&quot;unable to create IPC shm instance&quot;);
 		goto _err;
 	}
-		
-	pcm-&gt;ops = &amp;snd_pcm_dshare_ops;
-	pcm-&gt;fast_ops = &amp;snd_pcm_dshare_fast_ops;
+
+	if (!dshare-&gt;bindings) {
+		pcm-&gt;ops = &amp;snd_pcm_dshare_dummy_ops;
+		pcm-&gt;fast_ops = &amp;snd_pcm_dshare_fast_dummy_ops;
+	} else {
+		pcm-&gt;ops = &amp;snd_pcm_dshare_ops;
+		pcm-&gt;fast_ops = &amp;snd_pcm_dshare_fast_ops;
+	}
 	pcm-&gt;private_data = dshare;
 	dshare-&gt;state = SND_PCM_STATE_OPEN;
 	dshare-&gt;slowptr = opts-&gt;slowptr;
@@ -843,7 +893,7 @@ int snd_pcm_dshare_open(snd_pcm_t **pcmp, const char *name,
 		dshare-&gt;spcm = spcm;
 	}
 
-	for (chn = 0; chn &lt; dshare-&gt;channels; chn++) {
+	for (chn = 0; dshare-&gt;bindings &amp;&amp; (chn &lt; dshare-&gt;channels); chn++) {
 		unsigned int dchn = dshare-&gt;bindings ? dshare-&gt;bindings[chn] : chn;
 		if (dchn != UINT_MAX)
 			dshare-&gt;u.dshare.chn_mask |= (1ULL &lt;&lt; dchn);
diff --git a/src/pcm/pcm_unsupported.h b/src/pcm/pcm_unsupported.h
index 13e4d1b..5783222 100644
--- a/src/pcm/pcm_unsupported.h
+++ b/src/pcm/pcm_unsupported.h
@@ -114,6 +114,7 @@
 #define snd_pcm_unsupported_may_wait_for_avail_min \
 	snd1_pcm_unsupported_may_wait_for_avail_min
 
+void snd_pcm_unsupported_dump(snd_pcm_t *pcm, snd_output_t *out);
 int snd_pcm_unsupported_close(snd_pcm_t *pcm);
 int snd_pcm_unsupported_nonblock(snd_pcm_t *pcm, int nonblock);
 int snd_pcm_unsupported_async(snd_pcm_t *pcm, int sig, pid_t pid);
-- 
2.7.4

_______________________________________________
Alsa-devel mailing list
Alsa-devel@xxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://mailman.alsa-project.org/mailman/listinfo/alsa-devel">https://mailman.alsa-project.org/mailman/listinfo/alsa-devel</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="93613" href="msg93613.html">[PATCH 0/2] expand dshare to allow audio clock when	not streaming data</a></strong>
<ul><li><em>From:</em> Adam Miartus</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg93614.html">[PATCH 1/2] alsa: pcm: add unsupported OPS</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg93616.html">Re:  [GIT PULL] ASoC updates for v5.3</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg93802.html">Re:  [ALSA patch] [PATCH 1/2] alsa: pcm: add	unsupported OPS</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg93619.html">[PATCH v2] ASoC: Intel: Skylake: Recover BXT FW on DSP	boot timeout error</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#93615"><strong>Date</strong></a></li>
<li><a href="threads.html#93615"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/alsa-user/>[ALSA&nbsp;User]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/pulse-audio/>[Pulse&nbsp;Audio]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Kernel&nbsp;Archive]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=http://yosemitephotos.net/>[Photo&nbsp;Sharing]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/linux-sound/>[Linux&nbsp;Sound]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-media/>[Video&nbsp;4&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/gimp/>[Gimp]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

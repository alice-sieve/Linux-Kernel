<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH 6/6] ALSA: hda/intel: stop probe if DMICS are	detected on Skylake+ platforms -->
<!--X-From-R13: Bvreer&#45;Zbhvf Pbffneg &#60;cvreer&#45;ybhvf.obffnegNyvahk.vagry.pbz> -->
<!--X-Date: Fri, 19 Jul 2019 10:11:38 &#45;0700 -->
<!--X-Message-Id: 20190719170610.17610&#45;7&#45;pierre&#45;louis.bossart@linux.intel.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190719170610.17610&#45;1&#45;pierre&#45;louis.bossart@linux.intel.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="[PATCH 6/6] ALSA: hda/intel: stop probe if DMICS are	detected on Skylake+ platforms &mdash; ALSA Devel">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[PATCH 6/6] ALSA: hda/intel: stop probe if DMICS are	detected on Skylake+ platforms &mdash; ALSA Devel</title>
<link rel="alternate" type="application/rss+xml" title="ALSA Devel" href="//feedproxy.google.com/AlsaDevel">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH 6/6] ALSA: hda/intel: stop probe if DMICS are	detected on Skylake+ platforms</h1>
[<a href="msg93947.html">Date Prev</a>][<a href="msg93949.html">Date Next</a>][<a href="msg93947.html">Thread Prev</a>][<a href="msg93952.html">Thread Next</a>][<a href="maillist.html#93948">Date Index</a>][<a href="threads.html#93948">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: alsa-devel@xxxxxxxxxxxxxxxx</li>
<li><em>Subject</em>: [PATCH 6/6] ALSA: hda/intel: stop probe if DMICS are	detected on Skylake+ platforms</li>
<li><em>From</em>: Pierre-Louis Bossart &lt;pierre-louis.bossart@xxxxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Fri, 19 Jul 2019 12:06:10 -0500</li>
<li><em>Cc</em>: tiwai@xxxxxxx, Pierre-Louis Bossart &lt;pierre-louis.bossart@xxxxxxxxxxxxxxx&gt;,        Daniel Drake &lt;drake@xxxxxxxxxxxx&gt;, Hui Wang &lt;hui.wang@xxxxxxxxxxxxx&gt;,        Curtis Malainey &lt;cujomalainey@xxxxxxxxxx&gt;, broonie@xxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg93942.html">20190719170610.17610-1-pierre-louis.bossart@linux.intel.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg93942.html">20190719170610.17610-1-pierre-louis.bossart@linux.intel.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>The legacy HD-Audio driver cannot handle Skylake+ platforms with
digital microphones. For those platforms, the SOF or SST drivers need
to be used.

This patch provides an automatic way of detecting the presence of
DMICs using NHTL information reported by the BIOS. A kernel kconfig
option or a kernel module parameter provide an opt-in means of
stopping the probe. The kernel would then look for an alternate driver
registered for the same PCI ID to probe.

With this capability, distros no longer have to blacklist
snd-hda-intel, but still need to make sure the SOF/SST drivers are
functional by providing the relevant firmware and topology files in
/lib/firmware/intel

The coexistence between SOF and SST drivers and their dynamic
detection is not addressed by this patch, different mechanisms need to
be used, e.g. DMI-based quirks.

Signed-off-by: Pierre-Louis Bossart &lt;pierre-louis.bossart@xxxxxxxxxxxxxxx&gt;
---
 sound/pci/hda/Kconfig     | 10 ++++++++++
 sound/pci/hda/hda_intel.c | 34 ++++++++++++++++++++++++++++++++++
 2 files changed, 44 insertions(+)

diff --git a/sound/pci/hda/Kconfig b/sound/pci/hda/Kconfig
index 35d934309cb2..b5966014b5f7 100644
--- a/sound/pci/hda/Kconfig
+++ b/sound/pci/hda/Kconfig
@@ -12,6 +12,7 @@ config SND_HDA_INTEL
 	tristate &quot;HD Audio PCI&quot;
 	depends on SND_PCI
 	select SND_HDA
+	select SND_INTEL_NHLT if ACPI
 	help
 	  Say Y here to include support for Intel &quot;High Definition
 	  Audio&quot; (Azalia) and its compatible devices.
@@ -22,6 +23,15 @@ config SND_HDA_INTEL
 	  To compile this driver as a module, choose M here: the module
 	  will be called snd-hda-intel.
 
+config SND_HDA_INTEL_DETECT_DMIC
+	bool &quot;DMIC detection and probe abort&quot;
+	depends on SND_HDA_INTEL
+	help
+	  Say Y to detect digital microphones on SKL+ devices. DMICs
+	  cannot be handled by the HDaudio legacy driver and are
+	  currently only supported by the SOF driver.
+	  If unsure say N.
+
 config SND_HDA_TEGRA
 	tristate &quot;NVIDIA Tegra HD Audio&quot;
 	depends on ARCH_TEGRA
diff --git a/sound/pci/hda/hda_intel.c b/sound/pci/hda/hda_intel.c
index cb8b0945547c..15244a06f634 100644
--- a/sound/pci/hda/hda_intel.c
+++ b/sound/pci/hda/hda_intel.c
@@ -46,6 +46,7 @@
 #include &lt;sound/initval.h&gt;
 #include &lt;sound/hdaudio.h&gt;
 #include &lt;sound/hda_i915.h&gt;
+#include &lt;sound/intel-nhlt.h&gt;
 #include &lt;linux/vgaarb.h&gt;
 #include &lt;linux/vga_switcheroo.h&gt;
 #include &lt;linux/firmware.h&gt;
@@ -124,6 +125,7 @@ static char *patch[SNDRV_CARDS];
 static bool beep_mode[SNDRV_CARDS] = {[0 ... (SNDRV_CARDS-1)] =
 					CONFIG_SND_HDA_INPUT_BEEP_MODE};
 #endif
+static int dmic_detect = -1;
 
 module_param_array(index, int, NULL, 0444);
 MODULE_PARM_DESC(index, &quot;Index value for Intel HD audio interface.&quot;);
@@ -158,6 +160,8 @@ module_param_array(beep_mode, bool, NULL, 0444);
 MODULE_PARM_DESC(beep_mode, &quot;Select HDA Beep registration mode &quot;
 			    &quot;(0=off, 1=on) (default=1).&quot;);
 #endif
+module_param(dmic_detect, bint, 0444);
+MODULE_PARM_DESC(dmic_detect, &quot;DMIC detect on SKL+ platforms&quot;);
 
 #ifdef CONFIG_PM
 static int param_set_xint(const char *val, const struct kernel_param *kp);
@@ -2025,6 +2029,25 @@ static const struct hda_controller_ops pci_hda_ops = {
 	.position_check = azx_position_check,
 };
 
+static int azx_check_dmic(struct pci_dev *pci, struct azx *chip)
+{
+	struct nhlt_acpi_table *nhlt;
+	int ret = 0;
+
+	if (chip-&gt;driver_type == AZX_DRIVER_SKL &amp;&amp;
+	    pci-&gt;class != 0x040300) {
+		nhlt = intel_nhlt_init(&amp;pci-&gt;dev);
+		if (nhlt) {
+			if (intel_nhlt_get_dmic_geo(&amp;pci-&gt;dev, nhlt)) {
+				ret = -ENODEV;
+				dev_dbg(&amp;pci-&gt;dev, &quot;Digital mics found on Skylake+ platform, aborting probe\n&quot;);
+			}
+			intel_nhlt_free(nhlt);
+		}
+	}
+	return ret;
+}
+
 static int azx_probe(struct pci_dev *pci,
 		     const struct pci_device_id *pci_id)
 {
@@ -2055,6 +2078,17 @@ static int azx_probe(struct pci_dev *pci,
 	card-&gt;private_data = chip;
 	hda = container_of(chip, struct hda_intel, chip);
 
+	/*
+	 * stop probe if digital microphones detected on Skylake+ platform
+	 * with the DSP enabled. This is an opt-in behavior defined at build
+	 * time or at run-time with a module parameter
+	 */
+	if (IS_ENABLED(CONFIG_SND_HDA_INTEL_DETECT_DMIC) || dmic_detect &gt;= 0) {
+		err = azx_check_dmic(pci, chip);
+		if (err &lt; 0)
+			goto out_free;
+	}
+
 	pci_set_drvdata(pci, card);
 
 	err = register_vga_switcheroo(chip);
-- 
2.20.1

_______________________________________________
Alsa-devel mailing list
Alsa-devel@xxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://mailman.alsa-project.org/mailman/listinfo/alsa-devel">https://mailman.alsa-project.org/mailman/listinfo/alsa-devel</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="93952" href="msg93952.html">Re:  [PATCH 6/6] ALSA: hda/intel: stop probe if DMICS	are detected on Skylake+ platforms</a></strong>
<ul><li><em>From:</em> Takashi Iwai</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="93942" href="msg93942.html">[PATCH 0/6] ALSA/HDA: abort probe when DMICs are	detected</a></strong>
<ul><li><em>From:</em> Pierre-Louis Bossart</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg93947.html">[PATCH 5/6] ASoC: Intel: Skylake: use common NHLT	module</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg93949.html">[PATCH] SoC: rockchip: rockchip_max98090: Enable	MICBIAS for headset keypress detection</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg93947.html">[PATCH 5/6] ASoC: Intel: Skylake: use common NHLT	module</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg93952.html">Re:  [PATCH 6/6] ALSA: hda/intel: stop probe if DMICS	are detected on Skylake+ platforms</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#93948"><strong>Date</strong></a></li>
<li><a href="threads.html#93948"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/alsa-user/>[ALSA&nbsp;User]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/pulse-audio/>[Pulse&nbsp;Audio]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Kernel&nbsp;Archive]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=http://yosemitephotos.net/>[Photo&nbsp;Sharing]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/linux-sound/>[Linux&nbsp;Sound]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-media/>[Video&nbsp;4&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/gimp/>[Gimp]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

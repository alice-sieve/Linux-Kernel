<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH 2/6] ASoC: wcd934x: add support to	wcd9340/wcd9341 codec -->
<!--X-From-R13: [nex Pebja &#60;oebbavrNxreary.bet> -->
<!--X-Date: Tue, 2 Jul 2019 07:45:11 &#45;0700 -->
<!--X-Message-Id: 20190702144411.GP2793@sirena.org.uk -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: 20190702080920.22623&#45;1&#45;srinivas.kandagatla@linaro.org -->
<!--X-Reference: 20190702080920.22623&#45;3&#45;srinivas.kandagatla@linaro.org -->
<!--X-Derived: pgpvZ9Qc6efiQ.pgp -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re:  [PATCH 2/6] ASoC: wcd934x: add support to	wcd9340/wcd9341 codec &mdash; ALSA Devel">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re:  [PATCH 2/6] ASoC: wcd934x: add support to	wcd9340/wcd9341 codec &mdash; ALSA Devel</title>
<link rel="alternate" type="application/rss+xml" title="ALSA Devel" href="//feedproxy.google.com/AlsaDevel">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [PATCH 2/6] ASoC: wcd934x: add support to	wcd9340/wcd9341 codec</h1>
[<a href="msg93444.html">Date Prev</a>][<a href="msg93446.html">Date Next</a>][<a href="msg93418.html">Thread Prev</a>][<a href="msg93450.html">Thread Next</a>][<a href="maillist.html#93445">Date Index</a>][<a href="threads.html#93445">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Srinivas Kandagatla &lt;srinivas.kandagatla@xxxxxxxxxx&gt;</li>
<li><em>Subject</em>: Re:  [PATCH 2/6] ASoC: wcd934x: add support to	wcd9340/wcd9341 codec</li>
<li><em>From</em>: Mark Brown &lt;broonie@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 2 Jul 2019 15:44:11 +0100</li>
<li><em>Cc</em>: mark.rutland@xxxxxxx, devicetree@xxxxxxxxxxxxxxx,        alsa-devel@xxxxxxxxxxxxxxxx, bgoswami@xxxxxxxxxxxxxx,        lgirdwood@xxxxxxxxx, vkoul@xxxxxxxxxx, robh+dt@xxxxxxxxxx,        srini@xxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg93418.html">20190702080920.22623-3-srinivas.kandagatla@linaro.org</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg93415.html">20190702080920.22623-1-srinivas.kandagatla@linaro.org</a>&gt; &lt;<a href="msg93418.html">20190702080920.22623-3-srinivas.kandagatla@linaro.org</a>&gt;</li>
<li><em>User-agent</em>: Mutt/1.10.1 (2018-07-13)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Tue, Jul 02, 2019 at 09:09:16AM +0100, Srinivas Kandagatla wrote:

&gt; +#define WCD_VERSION_WCD9341_1_1     5
&gt; +#define WCD_IS_1_0(wcd) \
&gt; +	((wcd-&gt;type == WCD934X) ? \
&gt; +	 ((wcd-&gt;version == WCD_VERSION_1_0 || \
&gt; +	   wcd-&gt;version == WCD_VERSION_WCD9340_1_0 || \
&gt; +	   wcd-&gt;version == WCD_VERSION_WCD9341_1_0) ? 1 : 0) : 0)

Eew.  If you really need these make them functions and write
normal code with switch statements rather than abusing the
ternery operator like this, it's really not terribly readable.

&gt; +static void wcd934x_update_reg_defaults(struct wcd934x_codec *wcd)
&gt; +{
&gt; +	struct regmap *rm = wcd-&gt;regmap;
&gt; +
&gt; +	regmap_update_bits(rm, WCD934X_BIAS_VBG_FINE_ADJ, 0xFF, 0x75);
&gt; +	regmap_update_bits(rm, WCD934X_CODEC_CPR_SVS_CX_VDD, 0xFF, 0x7C);

What's all this stuff doing?  Should you be uing a regmap patch?

&gt; +static int wcd934x_disable_master_bias(struct wcd934x_codec *data)
&gt; +{
&gt; +	if (data-&gt;master_bias_users &lt;= 0)
&gt; +		return 0;
&gt; +
&gt; +	data-&gt;master_bias_users--;

There's an awful lot of these refcounted things - are you sure
none of them could be supply widgets?

&gt; +static void wcd934x_get_version(struct wcd934x_codec *wcd)
&gt; +{
&gt; +	int val1, val2, version, ret;
&gt; +	struct regmap *regmap;
&gt; +	u16 id_minor;
&gt; +	u32 version_mask = 0;
&gt; +
&gt; +	regmap = wcd-&gt;regmap;
&gt; +	version = 0;
&gt; +
&gt; +	ret = regmap_bulk_read(regmap, WCD934X_CHIP_TIER_CTRL_CHIP_ID_BYTE0,
&gt; +			       (u8 *)&amp;id_minor, sizeof(u16));
&gt; +
&gt; +	if (ret)
&gt; +		return;

No error reporting at all?

&gt; +	regmap_read(regmap, WCD934X_CHIP_TIER_CTRL_EFUSE_VAL_OUT14, &amp;val1);
&gt; +	regmap_read(regmap, WCD934X_CHIP_TIER_CTRL_EFUSE_VAL_OUT15, &amp;val2);
&gt; +
&gt; +	dev_info(wcd-&gt;dev, &quot;%s: chip version :0x%x 0x:%x\n&quot;,
&gt; +		 __func__, val1, val2);

We don't report id_minor as part of the version?  Also the format
string there just seems mangled and not even internally
consistent.

&gt; +	version_mask |= (!!((u8)val1 &amp; 0x80)) &lt;&lt; DSD_DISABLED_MASK;
&gt; +	version_mask |= (!!((u8)val2 &amp; 0x01)) &lt;&lt; SLNQ_DISABLED_MASK;
&gt; +
&gt; +	switch (version_mask) {
&gt; +	case DSD_DISABLED | SLNQ_DISABLED:
&gt; +		if (id_minor == 0)
&gt; +			version = WCD_VERSION_WCD9340_1_0;
&gt; +		else if (id_minor == 0x01)
&gt; +			version = WCD_VERSION_WCD9340_1_1;

This looks like you're trying to write a switch statement on the
minor version...

&gt; +static void wcd934x_update_cpr_defaults(struct wcd934x_codec *data)
&gt; +{
&gt; +	int i;
&gt; +
&gt; +	__wcd934x_cdc_mclk_enable(data, true);
&gt; +
&gt; +	wcd934x_set_sido_input_src(data, SIDO_SOURCE_RCO_BG);
&gt; +	regmap_write(data-&gt;regmap, WCD934X_CODEC_CPR_SVS2_MIN_CX_VDD, 0x2C);
&gt; +	regmap_update_bits(data-&gt;regmap, WCD934X_CODEC_RPM_CLK_GATE,
&gt; +			   0x10, 0x00);
&gt; +
&gt; +	for (i = 0; i &lt; ARRAY_SIZE(cpr_defaults); i++) {
&gt; +		regmap_bulk_write(data-&gt;regmap,
&gt; +				  WCD934X_CODEC_CPR_WR_DATA_0,
&gt; +				(u8 *)&amp;cpr_defaults[i].wr_data, 4);
&gt; +		regmap_bulk_write(data-&gt;regmap,
&gt; +				  WCD934X_CODEC_CPR_WR_ADDR_0,
&gt; +				(u8 *)&amp;cpr_defaults[i].wr_addr, 4);

What is &quot;cpr&quot; and should you be using a regmap patch here?  Why
is this not with the other default updates?  You've got loads of
random undocumented sequences like this all through the driver,
are they patches or are they things that should be controllable
by the user?

&gt; +		if (tx_port &lt;= 8) {
&gt; +			if ((tx_mux_sel == 0x2) || (tx_mux_sel == 0x3))
&gt; +				decimator = tx_port;
&gt; +		} else if (tx_port &lt;= 10) {
&gt; +			if ((tx_mux_sel == 0x1) || (tx_mux_sel == 0x2))
&gt; +				decimator = ((tx_port == 9) ? 7 : 6);
&gt; +		} else if (tx_port == 11) {
&gt; +			if ((tx_mux_sel &gt;= 1) &amp;&amp; (tx_mux_sel &lt; 7))
&gt; +				decimator = tx_mux_sel - 1;
&gt; +		} else if (tx_port == 13) {
&gt; +			if ((tx_mux_sel == 0x1) || (tx_mux_sel == 0x2))
&gt; +				decimator = 5;
&gt; +		}

This looks like a switch statement, and it's not clear if there's
missing error handling.

&gt; +static int wcd934x_get_micbias_val(struct device *dev, const char *micbias)
&gt; +{
&gt; +	int mv;
&gt; +
&gt; +	if (of_property_read_u32(dev-&gt;of_node, micbias, &amp;mv))
&gt; +		mv = WCD934X_DEF_MICBIAS_MV;
&gt; +
&gt; +	if (mv &lt; 1000 || mv &gt; 2850)
&gt; +		mv = WCD934X_DEF_MICBIAS_MV;

This silently ignores errors, that's not good - people might
think they successfully configured their DT when they haven't.

&gt; +	for_each_set_bit(j, &amp;status, 32) {
&gt; +		tx = (j &gt;= 16 ? true : false);
&gt; +		port_id = (tx ? j - 16 : j);

Please write normal conditional statements to improve legibility.

&gt; +			/*
&gt; +			 * Ignore interrupts for ports for which the
&gt; +			 * interrupts are not specifically enabled.
&gt; +			 */
&gt; +			if (!(int_val &amp; (1 &lt;&lt; (port_id % 8))))
&gt; +				continue;

Is this expected to happen?

&gt; +	return of_platform_populate(wcd-&gt;dev-&gt;of_node, NULL, NULL, wcd-&gt;dev);

Why are we doing this?

&gt; +{
&gt; +	struct device *dev = wcd-&gt;dev;
&gt; +	struct device_node *np = dev-&gt;of_node;
&gt; +	int ret;
&gt; +	/*
&gt; +	 * INTR1 consists of all possible interrupt sources Ear OCP,

Missing blank line.

&gt; +	 * HPH OCP, MBHC, MAD, VBAT, and SVA
&gt; +	 * INTR2 is a subset of first interrupt sources MAD, VBAT, and SVA
&gt; +	 */
&gt; +	wcd-&gt;irq = of_irq_get_byname(wcd-&gt;dev-&gt;of_node, &quot;intr1&quot;);
&gt; +	if (wcd-&gt;irq &lt; 0) {
&gt; +		if (wcd-&gt;irq != -EPROBE_DEFER)
&gt; +			dev_err(wcd-&gt;dev, &quot;Unable to configure IRQ\n&quot;);

It's helpful to print what the error code was, it can help people
debug things.

&gt; +	wcd-&gt;reset_gpio = of_get_named_gpio(np,	&quot;reset-gpios&quot;, 0);
&gt; +	if (wcd-&gt;reset_gpio &lt; 0) {
&gt; +		dev_err(dev, &quot;Reset gpio missing in DT\n&quot;);
&gt; +		return wcd-&gt;reset_gpio;
&gt; +	}

devm_gpiod_get()

&gt; +static int wcd934x_bring_up(struct wcd934x_codec *wcd)
&gt; +{
&gt; +	struct regmap *wcd_regmap = wcd-&gt;regmap;
&gt; +	u16 id_minor, id_major;
&gt; +	int ret;

&gt; +	dev_info(wcd-&gt;dev, &quot;%s: wcd9xxx chip id major 0x%x, minor 0x%x\n&quot;,
&gt; +		 __func__, id_major, id_minor);
&gt; +

What was with the other verison parsing and printing code?
</pre><p><strong>Attachment:
<a href="attachments/pgpvZ9Qc6efiQ.pgp" ><tt>signature.asc</tt></a></strong><br>
<em>Description:</em> PGP signature</p>
<pre>_______________________________________________
Alsa-devel mailing list
Alsa-devel@xxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://mailman.alsa-project.org/mailman/listinfo/alsa-devel">https://mailman.alsa-project.org/mailman/listinfo/alsa-devel</a>
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="93450" href="msg93450.html">Re:  [PATCH 2/6] ASoC: wcd934x: add support to	wcd9340/wcd9341 codec</a></strong>
<ul><li><em>From:</em> Srinivas Kandagatla</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="93415" href="msg93415.html">[PATCH 0/6] ASoC: Add support to WCD9340/WCD9341 codec</a></strong>
<ul><li><em>From:</em> Srinivas Kandagatla</li></ul></li>
<li><strong><a name="93418" href="msg93418.html">[PATCH 2/6] ASoC: wcd934x: add support to	wcd9340/wcd9341 codec</a></strong>
<ul><li><em>From:</em> Srinivas Kandagatla</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg93444.html">[PATCH v2 resend 3/3] ASoC: SOF: Intel: implement	runtime idle for CNL/APL</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg93446.html">Re:  [PATCH] ALSA: usb-audio: fix Line6 Helix audio	format rates</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg93418.html">[PATCH 2/6] ASoC: wcd934x: add support to	wcd9340/wcd9341 codec</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg93450.html">Re:  [PATCH 2/6] ASoC: wcd934x: add support to	wcd9340/wcd9341 codec</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#93445"><strong>Date</strong></a></li>
<li><a href="threads.html#93445"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/alsa-user/>[ALSA&nbsp;User]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/pulse-audio/>[Pulse&nbsp;Audio]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Kernel&nbsp;Archive]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=http://yosemitephotos.net/>[Photo&nbsp;Sharing]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/linux-sound/>[Linux&nbsp;Sound]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-media/>[Video&nbsp;4&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/gimp/>[Gimp]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

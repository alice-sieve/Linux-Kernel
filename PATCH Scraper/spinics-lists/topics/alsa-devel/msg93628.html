<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH 1/4] ALSA: compress: Fix regression on	compressed capture streams -->
<!--X-From-R13: Quneyrf Yrrcnk &#60;pxrrcnkNbcrafbhepr.pveehf.pbz> -->
<!--X-Date: Tue, 9 Jul 2019 03:53:15 &#45;0700 -->
<!--X-Message-Id: 20190709105211.11741&#45;1&#45;ckeepax@opensource.cirrus.com -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="[PATCH 1/4] ALSA: compress: Fix regression on	compressed capture streams &mdash; ALSA Devel">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[PATCH 1/4] ALSA: compress: Fix regression on	compressed capture streams &mdash; ALSA Devel</title>
<link rel="alternate" type="application/rss+xml" title="ALSA Devel" href="//feedproxy.google.com/AlsaDevel">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH 1/4] ALSA: compress: Fix regression on	compressed capture streams</h1>
[<a href="msg93627.html">Date Prev</a>][<a href="msg93629.html">Date Next</a>][<a href="msg93625.html">Thread Prev</a>][<a href="msg93629.html">Thread Next</a>][<a href="maillist.html#93628">Date Index</a>][<a href="threads.html#93628">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: &lt;vkoul@xxxxxxxxxx&gt;, &lt;tiwai@xxxxxxxx&gt;</li>
<li><em>Subject</em>: [PATCH 1/4] ALSA: compress: Fix regression on	compressed capture streams</li>
<li><em>From</em>: Charles Keepax &lt;ckeepax@xxxxxxxxxxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 9 Jul 2019 11:52:08 +0100</li>
<li><em>Cc</em>: patches@xxxxxxxxxxxxxxxxxxxxx, alsa-devel@xxxxxxxxxxxxxxxx</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>A previous fix to the stop handling on compressed capture streams causes
some knock on issues. The previous fix updated snd_compr_drain_notify to
set the state back to PREPARED for capture streams. This causes some
issues however as the handling for snd_compr_poll differs between the
two states and some user-space applications were relying on the poll
failing after the stream had been stopped.

To correct this regression whilst still fixing the original problem the
patch was addressing, update the capture handling to skip the PREPARED
state rather than skipping the SETUP state as it has done until now.

Fixes: 4f2ab5e1d13d (&quot;ALSA: compress: Fix stop handling on compressed capture streams&quot;)
Signed-off-by: Charles Keepax &lt;ckeepax@xxxxxxxxxxxxxxxxxxxxx&gt;
---
 include/sound/compress_driver.h |  5 +----
 sound/core/compress_offload.c   | 16 +++++++++++-----
 2 files changed, 12 insertions(+), 9 deletions(-)

diff --git a/include/sound/compress_driver.h b/include/sound/compress_driver.h
index c5188ff724d12..bc88d6f964da9 100644
--- a/include/sound/compress_driver.h
+++ b/include/sound/compress_driver.h
@@ -173,10 +173,7 @@ static inline void snd_compr_drain_notify(struct snd_compr_stream *stream)
 	if (snd_BUG_ON(!stream))
 		return;
 
-	if (stream-&gt;direction == SND_COMPRESS_PLAYBACK)
-		stream-&gt;runtime-&gt;state = SNDRV_PCM_STATE_SETUP;
-	else
-		stream-&gt;runtime-&gt;state = SNDRV_PCM_STATE_PREPARED;
+	stream-&gt;runtime-&gt;state = SNDRV_PCM_STATE_SETUP;
 
 	wake_up(&amp;stream-&gt;runtime-&gt;sleep);
 }
diff --git a/sound/core/compress_offload.c b/sound/core/compress_offload.c
index a1a6fd75cfe50..f031495311ee4 100644
--- a/sound/core/compress_offload.c
+++ b/sound/core/compress_offload.c
@@ -587,10 +587,7 @@ snd_compr_set_params(struct snd_compr_stream *stream, unsigned long arg)
 		stream-&gt;metadata_set = false;
 		stream-&gt;next_track = false;
 
-		if (stream-&gt;direction == SND_COMPRESS_PLAYBACK)
-			stream-&gt;runtime-&gt;state = SNDRV_PCM_STATE_SETUP;
-		else
-			stream-&gt;runtime-&gt;state = SNDRV_PCM_STATE_PREPARED;
+		stream-&gt;runtime-&gt;state = SNDRV_PCM_STATE_SETUP;
 	} else {
 		return -EPERM;
 	}
@@ -706,8 +703,17 @@ static int snd_compr_start(struct snd_compr_stream *stream)
 {
 	int retval;
 
-	if (stream-&gt;runtime-&gt;state != SNDRV_PCM_STATE_PREPARED)
+	switch (stream-&gt;runtime-&gt;state) {
+	case SNDRV_PCM_STATE_SETUP:
+		if (stream-&gt;direction != SND_COMPRESS_CAPTURE)
+			return -EPERM;
+		break;
+	case SNDRV_PCM_STATE_PREPARED:
+		break;
+	default:
 		return -EPERM;
+	}
+
 	retval = stream-&gt;ops-&gt;trigger(stream, SNDRV_PCM_TRIGGER_START);
 	if (!retval)
 		stream-&gt;runtime-&gt;state = SNDRV_PCM_STATE_RUNNING;
-- 
2.11.0

_______________________________________________
Alsa-devel mailing list
Alsa-devel@xxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://mailman.alsa-project.org/mailman/listinfo/alsa-devel">https://mailman.alsa-project.org/mailman/listinfo/alsa-devel</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="93631" href="msg93631.html">[PATCH 3/4] ALSA: compress: Don't allow drain	operations on capture streams</a></strong>
<ul><li><em>From:</em> Charles Keepax</li></ul></li>
<li><strong><a name="93630" href="msg93630.html">[PATCH 4/4] ALSA: compress: Be more restrictive about	when a drain is allowed</a></strong>
<ul><li><em>From:</em> Charles Keepax</li></ul></li>
<li><strong><a name="93629" href="msg93629.html">[PATCH 2/4] ALSA: compress: Prevent bypasses of	set_params</a></strong>
<ul><li><em>From:</em> Charles Keepax</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg93627.html">[PATCH 1/2][RESEND] ASoC: adau1761: Add PGA Slew time	control</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg93629.html">[PATCH 2/4] ALSA: compress: Prevent bypasses of	set_params</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg93625.html">[PATCH] ASoC: Intel: Atom: read timestamp moved to	period_elapsed</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg93629.html">[PATCH 2/4] ALSA: compress: Prevent bypasses of	set_params</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#93628"><strong>Date</strong></a></li>
<li><a href="threads.html#93628"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/alsa-user/>[ALSA&nbsp;User]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/pulse-audio/>[Pulse&nbsp;Audio]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Kernel&nbsp;Archive]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=http://yosemitephotos.net/>[Photo&nbsp;Sharing]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/linux-sound/>[Linux&nbsp;Sound]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-media/>[Video&nbsp;4&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/gimp/>[Gimp]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

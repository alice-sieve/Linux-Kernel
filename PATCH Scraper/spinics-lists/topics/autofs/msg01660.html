<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH 1/3] autofs &#45; fix AT_NO_AUTOMOUNT not being honored -->
<!--X-From-R13: Wna Yrag &#60;eniraNgurznj.arg> -->
<!--X-Date: Tue, 8 Aug 2017 17:46:04 &#45;0700 -->
<!--X-Message-Id: 3ef5b801&#45;2a40&#45;975e&#45;3cfa&#45;ef24cc3ad288@themaw.net -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 150216641255.11652.4204561328197919771.stgit@pluto.themaw.net -->
<!--X-Reference: 1502197874.3935465.1066793424.598228B6@webmail.messagingengine.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re: [PATCH 1/3] autofs - fix AT_NO_AUTOMOUNT not being honored &mdash; Linux AutoFS">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH 1/3] autofs - fix AT_NO_AUTOMOUNT not being honored &mdash; Linux AutoFS</title>
<link rel="alternate" type="application/rss+xml" title="Linux AutoFS" href="//feeds.feedburner.com/autofs">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com/cse" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:isdiegq275o" />
    <input type="hidden" name="ie" value="ISO-8859-1" />
    <input type="text" name="q" size="37" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH 1/3] autofs - fix AT_NO_AUTOMOUNT not being honored</h1>
[<a href="msg01659.html">Date Prev</a>][<a href="msg01661.html">Date Next</a>][<a href="msg01659.html">Thread Prev</a>][<a href="msg01661.html">Thread Next</a>][<a href="maillist.html#01660">Date Index</a>][<a href="index.html#01660">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Colin Walters &lt;walters@xxxxxxxxxx&gt;,        Andrew Morton &lt;akpm@xxxxxxxxxxxxxxxxxxxx&gt;</li>
<li><em>Subject</em>: Re: [PATCH 1/3] autofs - fix AT_NO_AUTOMOUNT not being honored</li>
<li><em>From</em>: Ian Kent &lt;raven@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Wed, 9 Aug 2017 08:45:55 +0800</li>
<li><em>Cc</em>: autofs mailing list &lt;autofs@xxxxxxxxxxxxxxx&gt;,        Ondrej Holy &lt;oholy@xxxxxxxxxx&gt;, Colin Walters &lt;walters@xxxxxxxxxx&gt;,        Kernel Mailing List &lt;linux-kernel@xxxxxxxxxxxxxxx&gt;,        David Howells &lt;dhowells@xxxxxxxxxx&gt;,        linux-fsdevel &lt;linux-fsdevel@xxxxxxxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg01659.html">1502197874.3935465.1066793424.598228B6@webmail.messagingengine.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg01656.html">150216641255.11652.4204561328197919771.stgit@pluto.themaw.net</a>&gt; &lt;<a href="msg01659.html">1502197874.3935465.1066793424.598228B6@webmail.messagingengine.com</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Thunderbird/52.2.1</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On 08/08/17 21:11, Colin Walters wrote:
&gt; On Tue, Aug 8, 2017, at 12:26 AM, Ian Kent wrote:
&gt; 
&gt;&gt; --- a/include/linux/fs.h
&gt;&gt; +++ b/include/linux/fs.h
&gt;&gt; @@ -3022,8 +3022,7 @@ static inline int vfs_lstat(const char __user *name, struct kstat *stat)
&gt;&gt;  static inline int vfs_fstatat(int dfd, const char __user *filename,
&gt;&gt;  			      struct kstat *stat, int flags)
&gt;&gt;  {
&gt;&gt; -	return vfs_statx(dfd, filename, flags | AT_NO_AUTOMOUNT,
&gt;&gt; -			 stat, STATX_BASIC_STATS);
&gt;&gt; +	return vfs_statx(dfd, filename, flags, stat, STATX_BASIC_STATS);
&gt;&gt;  }
&gt;&gt;  static inline int vfs_fstat(int fd, struct kstat *stat)
&gt;&gt;  {
&gt; 
&gt; This is reverting the fstatat() prat of
&gt; <a  rel="nofollow" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=deccf497d804a4c5fca2dbfad2f104675a6f9102">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=deccf497d804a4c5fca2dbfad2f104675a6f9102</a>
&gt; Which itself seems weird to me - it looks like we were unconditionally
&gt; forcing on AT_NO_AUTOMOUNT regardless of what userspace passed?
&gt; So perhaps a
&gt; Fixes: deccf497d804a4c5fca2dbfad2f104675a6f9102
&gt; is appropriate here?

David posted this at my request.

I asked him to do it because, when I saw this, I thought restoring the semantics
to what they were before they were changed needed to be done as quickly as possible.

That was so that I could then work on fixing the AT_NO_AUTOMOUNT not being honored
with fstatat(2).

&gt; 
&gt; I understand that for stat()/lstat() we didn't expose the option to userspace,
&gt; so the behavior was...ah, there's this note in man-pages (man-pages-4.09-3.fc26.noarch):
&gt; 
&gt;&gt; On Linux, lstat() will generally not trigger automounter action, whereas stat() will (but see fstatat(2)).
&gt; 
&gt; I have no idea of the history here, but maybe it makes sense to drop
&gt; the AT_NO_AUTOMOUNT from the vfs_stat() too?
&gt; 

I thought I had talked about the history in the patch description but I guess
it's not clear and isn't detailed enough for people that haven't been close to
the development over time.

Historically stat family calls were not supposed to trigger automounts because
that can easily lead to mount storms that are really bad for large autofs mount
maps. But the mount storm problem was mostly only evident for autofs maps that
used the &quot;browse&quot; option, the non-negative dentry case. The negative dentry
case always triggered an automount regardless of the system call.

Because of the move in user space to mostly always use proc filesystem mount
tables where there can be many more mount entries than were present in the
text based mount tables it's critical to not perform mount callbacks that
aren't absolutely essentially.

At this point that means to me going over the stat(2) system call behavior
and making sure it is only calling back where necessary. That's because that
is where it's expected automounts won't be triggered and so should have least
impact.

So it's the negative dentry handling in follow_automount() you should be
thinking about in terms of impact rather than the actual fstatat(2) change.
If man pages need to change then they need to change.

AFAICT, as I said in the patch description, this should not cause regressions
but I can't be certain. In any case it is in keeping with the historical &quot;stat
family system calls shouldn't trigger automounts&quot; mantra needed from the beginning.

Also notice that the negative dentry handling change should only affect autofs
as other kernel uses will be triggering automounts for positive dentrys.

Hopefully this doesn't sound to aggressive, I don't mean it to sound that way.

Ian
--
To unsubscribe from this list: send the line &quot;unsubscribe autofs&quot; in


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="01656" href="msg01656.html">[PATCH 1/3] autofs - fix AT_NO_AUTOMOUNT not being honored</a></strong>
<ul><li><em>From:</em> Ian Kent</li></ul></li>
<li><strong><a name="01659" href="msg01659.html">Re: [PATCH 1/3] autofs - fix AT_NO_AUTOMOUNT not being honored</a></strong>
<ul><li><em>From:</em> Colin Walters</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg01659.html">Re: [PATCH 1/3] autofs - fix AT_NO_AUTOMOUNT not being honored</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg01661.html">Re: [PATCH 1/3] autofs - fix AT_NO_AUTOMOUNT not being honored</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg01659.html">Re: [PATCH 1/3] autofs - fix AT_NO_AUTOMOUNT not being honored</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg01661.html">Re: [PATCH 1/3] autofs - fix AT_NO_AUTOMOUNT not being honored</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#01660"><strong>Date</strong></a></li>
<li><a href="index.html#01660"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-fsdevel/>[Linux&nbsp;Filesystem&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-ext4/>[Linux&nbsp;Ext4]</a>
&nbsp;
&nbsp;
<a href=/lists/arm-kernel/>[Linux&nbsp;ARM&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/arm/>[Linux&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;Omap]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-arm/>[Fedora&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/ietf-ann/>[IETF&nbsp;Annouce]</a>
&nbsp;
&nbsp;
<a href=/lists/security/>[Security]</a>
&nbsp;
&nbsp;
<a href=/lists/bugtraq/>[Bugtraq]</a>
&nbsp;
&nbsp;
<a href=/linux/>[Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;OMAP]</a>
&nbsp;
&nbsp;
<a href=/lists/mips/>[Linux&nbsp;MIPS]</a>
&nbsp;
&nbsp;
<a href=/lists/ecos/>[ECOS]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;Internet&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-api/>[Linux&nbsp;API]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

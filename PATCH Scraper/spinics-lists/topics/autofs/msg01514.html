<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH 1/7] vfs &#45; merge path_is_mountpoint() and path_is_mountpoint_rcu() -->
<!--X-From-R13: Wna Yrag &#60;eniraNgurznj.arg> -->
<!--X-Date: Wed, 7 Dec 2016 19:29:59 &#45;0800 -->
<!--X-Message-Id: 1481167790.3924.3.camel@themaw.net -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 148029910861.27779.4517883721395202453.stgit@pluto.themaw.net -->
<!--X-Reference: 20161203051322.GA24765@ZenIV.linux.org.uk -->
<!--X-Reference: 1481017056.4589.21.camel@themaw.net -->
<!--X-Reference: 8737hzv34f.fsf@xmission.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu() &mdash; Linux AutoFS">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu() &mdash; Linux AutoFS</title>
<link rel="alternate" type="application/rss+xml" title="Linux AutoFS" href="//feeds.feedburner.com/autofs">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com/cse" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:isdiegq275o" />
    <input type="hidden" name="ie" value="ISO-8859-1" />
    <input type="text" name="q" size="37" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</h1>
[<a href="msg01513.html">Date Prev</a>][<a href="msg01515.html">Date Next</a>][<a href="msg01513.html">Thread Prev</a>][<a href="msg01515.html">Thread Next</a>][<a href="maillist.html#01514">Date Index</a>][<a href="index.html#01514">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: &quot;Eric W. Biederman&quot; &lt;ebiederm@xxxxxxxxxxxx&gt;</li>
<li><em>Subject</em>: Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</li>
<li><em>From</em>: Ian Kent &lt;raven@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 08 Dec 2016 11:29:50 +0800</li>
<li><em>Cc</em>: Al Viro &lt;viro@xxxxxxxxxxxxxxxxxx&gt;,        Andrew Morton &lt;akpm@xxxxxxxxxxxxxxxxxxxx&gt;,        autofs mailing list &lt;autofs@xxxxxxxxxxxxxxx&gt;,        Kernel Mailing List &lt;linux-kernel@xxxxxxxxxxxxxxx&gt;,        linux-fsdevel &lt;linux-fsdevel@xxxxxxxxxxxxxxx&gt;,        Omar Sandoval &lt;osandov@xxxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg01513.html">8737hzv34f.fsf@xmission.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg01498.html">148029910861.27779.4517883721395202453.stgit@pluto.themaw.net</a>&gt;         &lt;<a href="msg01507.html">20161203051322.GA24765@ZenIV.linux.org.uk</a>&gt;         &lt;<a href="msg01512.html">1481017056.4589.21.camel@themaw.net</a>&gt; &lt;<a href="msg01513.html">8737hzv34f.fsf@xmission.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Thu, 2016-12-08 at 10:30 +1300, Eric W. Biederman wrote:
&gt; Ian Kent &lt;raven@xxxxxxxxxx&gt; writes:
&gt; 
&gt; &gt; On Sat, 2016-12-03 at 05:13 +0000, Al Viro wrote:
&gt; &gt; &gt; 	FWIW, I've folded that pile into vfs.git#work.autofs.
&gt; &gt; &gt; 
&gt; &gt; &gt; Problems:
&gt; &gt; 
&gt; &gt; snip ...
&gt; &gt; 
&gt; &gt; &gt; 	* the last one (propagation-related) is too ugly to live - at the
&gt; &gt; &gt; very least, its pieces should live in fs/pnode.c; exposing
&gt; &gt; &gt; propagate_next()
&gt; &gt; &gt; is simply wrong.&#xA0;&#xA0;I hadn't picked that one at all, and I would suggest
&gt; &gt; &gt; coordinating anything in that area with ebiederman - he has some work
&gt; &gt; &gt; around fs/pnode.c and you risk stepping on his toes.
&gt; &gt; 
&gt; &gt; The earlier patches seem to be ok now so how about we talk a little about
&gt; &gt; this
&gt; &gt; last one.
&gt; &gt; 
&gt; &gt; Eric, Al mentioned that you are working with fs/pnode.c and recommended I
&gt; &gt; co-
&gt; &gt; ordinate with you.
&gt; &gt; 
&gt; &gt; So is my working on this this (which is most likely going to live in pnode.c
&gt; &gt; if
&gt; &gt; I can can get something acceptable) going to cause complications for you?
&gt; &gt; Is what your doing at a point were it would be worth doing as Al
&gt; &gt; suggests?
&gt; &gt; 
&gt; &gt; Anyway, the problem that this patch is supposed to solve is to check if any
&gt; &gt; of
&gt; &gt; the list of mnt_mounts or any of the mounts propagated from each are in use.
&gt; &gt; 
&gt; &gt; One obvious problem with it is the propagation could be very large.
&gt; &gt; 
&gt; &gt; But now I look at it again there's no reason to have to every tree because
&gt; &gt; if
&gt; &gt; one tree is busy then the the set of trees is busy. But every tree would be
&gt; &gt; visited if the not busy so it's perhaps still a problem.
&gt; &gt; 
&gt; &gt; The difficult thing is working out if a tree is busy, more so because there
&gt; &gt; could be a struct path holding references within any the trees so I don't
&gt; &gt; know
&gt; &gt; of a simpler, more efficient way to check for this.
&gt; 
&gt; So coordination seems to be in order.&#xA0;&#xA0;Not so much because of your
&gt; current implementation (which won't tell you what you want to know)

Umm ... ok I've missed something then because the patch I posted does appear to
get the calculation right. Perhaps I've missed a case where it gets it wrong
....

But now I'm looking deeper into it I'm beginning to wonder why it worked for one
of the cases. Maybe I need to do some more tests with even more printks. 

&gt; but because an implementation that tells you what you are looking for
&gt; has really bad &gt; O(N^2) complexity walking the propagation tree in
&gt; the worst case.

Yes it is bad indeed.

&gt; 
&gt; To be correct you code would need to use next_mnt and walk the tree and
&gt; on each mount use propagate_mnt_busy to see if that entry can be
&gt; unmounted.&#xA0;&#xA0;Possibly with small variations to match your case.&#xA0;&#xA0;Mounts
&gt; in one part of the tree may propagate to places that mounts in other
&gt; parts of the tree will not.

Right, the point there being use propagate_mnt_busy() for the check.

I tried to use that when I started this but had trouble, I'll have another look
at using it.

I thought the reason I couldn't use propagate_mnt_busy() is because it will see
any mount with submounts as busy and that's not what's need. It's mounts below
each of mounts having submounts that make them busy in my case.

You probably don't want to read about this but, unfortunately, an example is
possibly the best way to describe what I need to achieve.

A simple example for is the autofs direct mount map entry (a so called autofs
multi-mount):

/absolute/path/to/direct/mount-point \
&#xA0;&#xA0;&#xA0;&#xA0;/offset/path/one&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;server:/export/path/one \
&#xA0;&#xA0;&#xA0;&#xA0;/offset2/path/two&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;server2:/export/path/other

The path /absolute/path/to/direct/mount-point is an autofs direct mount trigger
and is essentially an autofs mount.

When the mount is triggered each of the offsets, /offset/path/one and
/offset2/path/two offset trigger mounts are mounted so they can trigger mounts
independently.

When the direct mount /absolute/path/to/direct/mount-point is expired the two
offsets need to be umounted if they are not busy so
/absolute/path/to/direct/mount-point having submounts doesn't necessarily make
it unable to be umounted.

But this is (supposed) to be for only to one level of mounts, for example if I
had:

/absolute/path/to/direct/mount-point \
&#xA0;&#xA0;&#xA0;&#xA0;/offset/path/one&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;  server:/export/path/one \
&#xA0;&#xA0;&#xA0;&#xA0;/offset2/path/two&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;  server2:/export/path/other \
    /offset/path/one/nested server3:/export/path3/nested

then the the offsets below the nesting point /offset/path/one make it busy and
need to be expired first.

So why would I even need to do this?

It's functionality of Sun autofs maps and that's the primary map format autofs
supports but that's why it's needed and not why I do it this way.

Another example of one these multi-mounts is:

/absolute/path/to/direct/mount-point \
    /                     servern:/another/export \
&#xA0;&#xA0;&#xA0;&#xA0;/offset/path/one&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;server:/export/path/one \
&#xA0;&#xA0;&#xA0;&#xA0;/offset2/path/two&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;server2:/export/path/other

where an NFS mount is done on the root of the offset tree (similar to the case
where nesting is present in the example map entry above).

Once that happens autofs can't get a callback to mount offsets unless there&#xA0;are
offset triggers mounted to trigger the mounts.

&gt; 
&gt; I am assuming you are not worried about MNT_DETACH, as that case would
&gt; not need may_umount_tree at all.

I'm not. 

&gt; 
&gt; I am researching how to make walking propagation for multiple mounts
&gt; efficient but it is a non-trivial problem.

Sure is.

&gt; 
&gt; &gt; Anyone have any suggestions at all?
&gt; 
&gt; In the short term I recommend just not doing this, but if you want to
&gt; see if you can find an efficient algorithm with me, I am happy to bring
&gt; you up to speed on all of the gory details.

I need to do this to make autofs play better in the presence of namespaces and
that's a problem now and is long overdue to be resolved.

So I'm happy to do whatever I can to work toward that.

I could leave this part of the implementation until later because the false
positive this solves leads to an expire fail and that is (must be) handled
properly by the user space daemon.

But when I first noticed the false positive the expire failure was handled ok by
the daemon (AFAICS) but there was what looked like a reference counting problem
(but not quite that either, odd) which I was going to return to later.

Maybe I've stumbled onto a subtle propagation bug that really needs fixing ....

Ian
--
To unsubscribe from this list: send the line &quot;unsubscribe autofs&quot; in


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="01515" href="msg01515.html">Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</a></strong>
<ul><li><em>From:</em> Eric W. Biederman</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="01498" href="msg01498.html">[PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</a></strong>
<ul><li><em>From:</em> Ian Kent</li></ul></li>
<li><strong><a name="01507" href="msg01507.html">Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</a></strong>
<ul><li><em>From:</em> Al Viro</li></ul></li>
<li><strong><a name="01512" href="msg01512.html">Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</a></strong>
<ul><li><em>From:</em> Ian Kent</li></ul></li>
<li><strong><a name="01513" href="msg01513.html">Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</a></strong>
<ul><li><em>From:</em> Eric W. Biederman</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg01513.html">Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg01515.html">Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg01513.html">Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg01515.html">Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#01514"><strong>Date</strong></a></li>
<li><a href="index.html#01514"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-fsdevel/>[Linux&nbsp;Filesystem&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-ext4/>[Linux&nbsp;Ext4]</a>
&nbsp;
&nbsp;
<a href=/lists/arm-kernel/>[Linux&nbsp;ARM&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/arm/>[Linux&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;Omap]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-arm/>[Fedora&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/ietf-ann/>[IETF&nbsp;Annouce]</a>
&nbsp;
&nbsp;
<a href=/lists/security/>[Security]</a>
&nbsp;
&nbsp;
<a href=/lists/bugtraq/>[Bugtraq]</a>
&nbsp;
&nbsp;
<a href=/linux/>[Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;OMAP]</a>
&nbsp;
&nbsp;
<a href=/lists/mips/>[Linux&nbsp;MIPS]</a>
&nbsp;
&nbsp;
<a href=/lists/ecos/>[ECOS]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;Internet&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-api/>[Linux&nbsp;API]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

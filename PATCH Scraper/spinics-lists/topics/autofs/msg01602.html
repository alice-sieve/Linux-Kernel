<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH] Fix usage of uninitialized pointer -->
<!--X-From-R13: Rbanyq Phpmrx &#60;ohpmrxNzbytra.zct.qr> -->
<!--X-Date: Wed, 31 May 2017 13:28:40 &#45;0700 -->
<!--X-Message-Id: 350fd28e&#45;8e61&#45;24b0&#45;f2e4&#45;38a4476c8108@molgen.mpg.de -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 1496151337&#45;21367&#45;1&#45;git&#45;send&#45;email&#45;buczek@molgen.mpg.de -->
<!--X-Reference: 1496190434.3804.1.camel@themaw.net -->
<!--X-Reference: 1496194664.3804.3.camel@themaw.net -->
<!--X-Reference: e4e26a3f&#45;7bda&#45;1c6a&#45;18e6&#45;af05c2490d6d@molgen.mpg.de -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re: [PATCH] Fix usage of uninitialized pointer &mdash; Linux AutoFS">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH] Fix usage of uninitialized pointer &mdash; Linux AutoFS</title>
<link rel="alternate" type="application/rss+xml" title="Linux AutoFS" href="//feeds.feedburner.com/autofs">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com/cse" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:isdiegq275o" />
    <input type="hidden" name="ie" value="ISO-8859-1" />
    <input type="text" name="q" size="37" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH] Fix usage of uninitialized pointer</h1>
[<a href="msg01601.html">Date Prev</a>][<a href="msg01603.html">Date Next</a>][<a href="msg01601.html">Thread Prev</a>][<a href="msg01603.html">Thread Next</a>][<a href="maillist.html#01602">Date Index</a>][<a href="index.html#01602">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Ian Kent &lt;raven@xxxxxxxxxx&gt;</li>
<li><em>Subject</em>: Re: [PATCH] Fix usage of uninitialized pointer</li>
<li><em>From</em>: Donald Buczek &lt;buczek@xxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Wed, 31 May 2017 22:28:35 +0200</li>
<li><em>Cc</em>: autofs@xxxxxxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg01601.html">e4e26a3f-7bda-1c6a-18e6-af05c2490d6d@molgen.mpg.de</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg01598.html">1496151337-21367-1-git-send-email-buczek@molgen.mpg.de</a>&gt; &lt;<a href="msg01599.html">1496190434.3804.1.camel@themaw.net</a>&gt; &lt;<a href="msg01600.html">1496194664.3804.3.camel@themaw.net</a>&gt; &lt;<a href="msg01601.html">e4e26a3f-7bda-1c6a-18e6-af05c2490d6d@molgen.mpg.de</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux x86_64; rv:45.0) Gecko/20100101 Thunderbird/45.8.0</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
On 31.05.2017 16:22, Donald Buczek wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On 05/31/17 03:37, Ian Kent wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On Wed, 2017-05-31 at 08:27 +0800, Ian Kent wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On Tue, 2017-05-30 at 15:35 +0200, Donald Buczek wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
In the error path after a getgrgid_r failure (e.g. when a unnamed gid
was used), the pointer tsv-&gt;group was left unitialized. Still the tsv
was given to pthread_setspecific(key_thread_stdenv_vars,...) and the
consumers used and freed the uninitialized pointer.
</pre></blockquote><pre style="margin: 0em;">
Umm ... ok, I'll check ... good catch.
</pre></blockquote><pre style="margin: 0em;">
I think this bug will warrant another release.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
     2017-05-29T18:16:11+02:00 rofl automount[14749]: attempting to
mount
entry
/package/twiki
     2017-05-29T18:16:11+02:00 rofl automount[14749]:
set_tsd_user_vars:
failed
to get group info from getgrgid_r
     2017-05-29T18:16:11+02:00 rofl automount[14749]: mounted
/package/twiki
     2017-05-29T18:16:11+02:00 rofl systemd[1]: automount.service: main
process
exited, code=dumped, status=6
     2017-05-29T18:16:12+02:00 rofl systemd[1]: automount.service
holdoff
time
over, scheduling restart.
     2017-05-29T18:16:12+02:00 rofl systemd[1]: Unit automount.service
entered
failed state.
     2017-05-29T18:16:12+02:00 rofl automount[17936]: Starting
automounter
version 5.1.3, master map auto.master

     [May29 18:16] traps: automount[18234] general protection
ip:7f8b025c324a
sp:7f8b0049a508 error:0 in libc-2.19.so[7f8b02541000+1a2000]

Handle the error by not calling pthread_setspecific. Clean up
and return instead.
---
  lib/mounts.c | 21 ++++++++++++---------
  1 file changed, 12 insertions(+), 9 deletions(-)

diff --git a/lib/mounts.c b/lib/mounts.c
index ce6a60a..fe1a6cd 100644
--- a/lib/mounts.c
+++ b/lib/mounts.c
@@ -1552,28 +1552,31 @@ void set_tsd_user_vars(unsigned int logopt,
uid_t
uid,
gid_t gid)
      }
    no_group:
-    if (status || !pgr)
+    if (status || !pgr) {
          error(logopt, &quot;failed to get group info from getgrgid_r&quot;);
-    else {
</pre></blockquote><pre style="margin: 0em;">
Extra braces, I leave these out (when I can) on single statement clauses
deliberately and always try to put the single statement as the first
branch of
the if.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
+        goto free_gr_tmp;
+    } else {
          tsv-&gt;group = strdup(gr.gr_name);
-        if (!tsv-&gt;group)
+        if (!tsv-&gt;group) {
              error(logopt, &quot;failed to malloc buffer for group&quot;);
+            goto free_gr_tmp;
+        }
      }
  -    if (gr_tmp)
-        free(gr_tmp);
-
      status = pthread_setspecific(key_thread_stdenv_vars, tsv);
      if (status) {
          error(logopt, &quot;failed to set stdenv thread var&quot;);
          goto free_tsv_group;
      }
-
+    if (gr_tmp)
+        free(gr_tmp);
</pre></blockquote><pre style="margin: 0em;">
But this doesn't do what I intended.

What I want to do is set the thread specific standard variables even
if the
group name can't be obtained.

It looks like I've made an assumption elsewhere that if the tsd is
set then
all
the variables have valid values, I'd rather fix that than do this.
</pre></blockquote><pre style="margin: 0em;">
I would prefer to do this instead.

Could you check this resolves the problem you have seen please.
</pre></blockquote><pre style="margin: 0em;">

Sorry, the patch doesn't apply, because it is line wrapped and contains
utf8 unicode non breaking space characters. Can I pull it?
</pre></blockquote><pre style="margin: 0em;">


Never mind, edited it in by hand.

I can confirm, that the bug is fixed.

Test procedure:

run

    valgrind --leak-check=full daemon/automount -f -v

in one shell. Run

    perl -e '$(=65533;$)=65533;system(&quot;ls /project/SOME_AUTOMOUNT_PATH&quot;)'

in another.

</pre><tt>Result from master (release_5.1.3) are several valgrind warnings and 
</tt><tt>death by segv:
</tt><pre style="margin: 0em;">

    set_tsd_user_vars: failed to get group info from getgrgid_r
    ==18686== Use of uninitialised value of size 8
    ==18686==    at 0x4C2AAF2: strlen (vg_replace_strmem.c:454)
    ==18686==    by 0x619FF8D: strdup (strdup.c:41)
    [...]
    ==18686== Invalid read of size 1
    ==18686==    at 0x4C2AAF2: strlen (vg_replace_strmem.c:454)
    ==18686==    by 0x619FF8D: strdup (strdup.c:41)
    ==18686==    by 0x13A18D: macro_addvar (macros.c:305)
    [...]
    ==18686==  Address 0x0 is not stack'd, malloc'd or (recently) free'd
</pre><tt>    ==18686== Process terminating with default action of signal 11 
</tt><tt>(SIGSEGV): dumping core
</tt><pre style="margin: 0em;">
    ==18686==  Access not within mapped region at address 0x0
    ==18686==    at 0x4C2AAF2: strlen (vg_replace_strmem.c:454)
    ==18686==    by 0x619FF8D: strdup (strdup.c:41)
    ==18686==    by 0x13A18D: macro_addvar (macros.c:305)
    ==18686==    by 0x12F1E4: do_macro_addvar (mounts.c:368)

</pre><tt>Result with you patch on top: No errors (aside from expected 
</tt><tt>&quot;set_tsd_user_vars: failed to get group info from getgrgid_r&quot;) and a 
</tt><tt>mounted directory.
</tt><pre style="margin: 0em;">

Didn't try to expand the variables in a map, though.

Thumbs up from my side.

  Donald



</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

Donald


</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

autofs-5.1.3 - fix unset tsd group name handling

From: Ian Kent &lt;raven@xxxxxxxxxx&gt;

Commit 1a64a6bbc5 changed set_tsd_user_vars() to set the thread specific
values even if the group name could not be obtained.

But the structure holding the values was not initialized on allocation
so the group field might not be NULL when no group name is available.

Also the macro addition and removal functions didn't handle setting a
macro name with a NULL value.

Signed-off-by: Ian Kent &lt;raven@xxxxxxxxxx&gt;
Reported-by: Donald Buczek &lt;buczek@xxxxxxxxxxxxx&gt;
---
  lib/macros.c |   27 +++++++++++++--------------
  lib/mounts.c |    1 +
  2 files changed, 14 insertions(+), 14 deletions(-)

diff --git a/lib/macros.c b/lib/macros.c
index ff9ba89..30dbcdb 100644
--- a/lib/macros.c
+++ b/lib/macros.c
@@ -281,19 +281,21 @@ macro_addvar(struct substvar *table, const char
*str, int
len, const char *value
      }
        if (lv) {
-        char *this = malloc(strlen(value) + 1);
-        if (!this) {
-            lv = table;
-            goto done;
+        char *this = NULL;
+
+        if (value) {
+            this = malloc(strlen(value) + 1);
+            if (this)
+                strcpy(this, value);
          }
-        strcpy(this, value);
-        free(lv-&gt;val);
+        if (lv-&gt;val)
+            free(lv-&gt;val);
          lv-&gt;val = this;
          if (lv != table)
              lv = table;
      } else {
          struct substvar *new;
-        char *def, *val;
+        char *def, *val = NULL;
            def = strdup(str);
          if (!def) {
@@ -302,18 +304,15 @@ macro_addvar(struct substvar *table, const char
*str, int
len, const char *value
          }
          def[len] = '\0';
  -        val = strdup(value);
-        if (!val) {
-            lv = table;
-            free(def);
-            goto done;
-        }
+        if (value)
+            val = strdup(value);
            new = malloc(sizeof(struct substvar));
          if (!new) {
              lv = table;
              free(def);
-            free(val);
+            if (val)
+                free(val);
              goto done;
          }
          new-&gt;def = def;
diff --git a/lib/mounts.c b/lib/mounts.c
index ce6a60a..0b38bd8 100644
--- a/lib/mounts.c
+++ b/lib/mounts.c
@@ -1463,6 +1463,7 @@ void set_tsd_user_vars(unsigned int logopt,
uid_t uid,
gid_t gid)
          error(logopt, &quot;failed alloc tsv storage&quot;);
          return;
      }
+    memset(tsv, 0, sizeof(struct thread_stdenv_vars));
        tsv-&gt;uid = uid;
      tsv-&gt;gid = gid;
</pre></blockquote><pre style="margin: 0em;">


</pre></blockquote><pre style="margin: 0em;">

--
Donald Buczek
buczek@xxxxxxxxxxxxx
Tel: +49 30 8413 1433
--
To unsubscribe from this list: send the line &quot;unsubscribe autofs&quot; in


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="01603" href="msg01603.html">Re: [PATCH] Fix usage of uninitialized pointer</a></strong>
<ul><li><em>From:</em> Ian Kent</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="01598" href="msg01598.html">[PATCH] Fix usage of uninitialized pointer</a></strong>
<ul><li><em>From:</em> Donald Buczek</li></ul></li>
<li><strong><a name="01599" href="msg01599.html">Re: [PATCH] Fix usage of uninitialized pointer</a></strong>
<ul><li><em>From:</em> Ian Kent</li></ul></li>
<li><strong><a name="01600" href="msg01600.html">Re: [PATCH] Fix usage of uninitialized pointer</a></strong>
<ul><li><em>From:</em> Ian Kent</li></ul></li>
<li><strong><a name="01601" href="msg01601.html">Re: [PATCH] Fix usage of uninitialized pointer</a></strong>
<ul><li><em>From:</em> Donald Buczek</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg01601.html">Re: [PATCH] Fix usage of uninitialized pointer</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg01603.html">Re: [PATCH] Fix usage of uninitialized pointer</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg01601.html">Re: [PATCH] Fix usage of uninitialized pointer</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg01603.html">Re: [PATCH] Fix usage of uninitialized pointer</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#01602"><strong>Date</strong></a></li>
<li><a href="index.html#01602"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-fsdevel/>[Linux&nbsp;Filesystem&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-ext4/>[Linux&nbsp;Ext4]</a>
&nbsp;
&nbsp;
<a href=/lists/arm-kernel/>[Linux&nbsp;ARM&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/arm/>[Linux&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;Omap]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-arm/>[Fedora&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/ietf-ann/>[IETF&nbsp;Annouce]</a>
&nbsp;
&nbsp;
<a href=/lists/security/>[Security]</a>
&nbsp;
&nbsp;
<a href=/lists/bugtraq/>[Bugtraq]</a>
&nbsp;
&nbsp;
<a href=/linux/>[Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;OMAP]</a>
&nbsp;
&nbsp;
<a href=/lists/mips/>[Linux&nbsp;MIPS]</a>
&nbsp;
&nbsp;
<a href=/lists/ecos/>[ECOS]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;Internet&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-api/>[Linux&nbsp;API]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH 3/3] autofs &#45; fix AT_NO_AUTOMOUNT not being honored -->
<!--X-From-R13: Wna Yrag &#60;eniraNgurznj.arg> -->
<!--X-Date: Tue, 21 Nov 2017 20:28:22 &#45;0800 -->
<!--X-Message-Id: ed908288&#45;536c&#45;d34a&#45;6d3d&#45;c21bb8fdfc62@themaw.net -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 149438991819.26550.11290804420751932707.stgit@pluto.themaw.net -->
<!--X-Reference: 149438992850.26550.14370272866390445786.stgit@pluto.themaw.net -->
<!--X-Reference: 874lpo2y9e.fsf@notabene.neil.brown.name -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re: [PATCH 3/3] autofs - fix AT_NO_AUTOMOUNT not being honored &mdash; Linux AutoFS">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH 3/3] autofs - fix AT_NO_AUTOMOUNT not being honored &mdash; Linux AutoFS</title>
<link rel="alternate" type="application/rss+xml" title="Linux AutoFS" href="//feeds.feedburner.com/autofs">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com/cse" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:isdiegq275o" />
    <input type="hidden" name="ie" value="ISO-8859-1" />
    <input type="text" name="q" size="37" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH 3/3] autofs - fix AT_NO_AUTOMOUNT not being honored</h1>
[<a href="msg01764.html">Date Prev</a>][<a href="msg01766.html">Date Next</a>][<a href="msg01764.html">Thread Prev</a>][<a href="msg01766.html">Thread Next</a>][<a href="maillist.html#01765">Date Index</a>][<a href="index.html#01765">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: NeilBrown &lt;neilb@xxxxxxxx&gt;, Al Viro &lt;viro@xxxxxxxxxxxxxxxxxx&gt;</li>
<li><em>Subject</em>: Re: [PATCH 3/3] autofs - fix AT_NO_AUTOMOUNT not being honored</li>
<li><em>From</em>: Ian Kent &lt;raven@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Wed, 22 Nov 2017 12:28:13 +0800</li>
<li><em>Cc</em>: Colin Walters &lt;walters@xxxxxxxxxx&gt;, Ondrej Holy &lt;oholy@xxxxxxxxxx&gt;,        autofs mailing list &lt;autofs@xxxxxxxxxxxxxxx&gt;,        Kernel Mailing List &lt;linux-kernel@xxxxxxxxxxxxxxx&gt;,        David Howells &lt;dhowells@xxxxxxxxxx&gt;,        linux-fsdevel &lt;linux-fsdevel@xxxxxxxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg01764.html">874lpo2y9e.fsf@notabene.neil.brown.name</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg01593.html">149438991819.26550.11290804420751932707.stgit@pluto.themaw.net</a>&gt; &lt;<a href="msg01595.html">149438992850.26550.14370272866390445786.stgit@pluto.themaw.net</a>&gt; &lt;<a href="msg01764.html">874lpo2y9e.fsf@notabene.neil.brown.name</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Thunderbird/52.3.0</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On 21/11/17 09:53, NeilBrown wrote:
&gt; On Wed, May 10 2017, Ian Kent wrote:
&gt; 
&gt;&gt; The fstatat(2) and statx() calls can pass the flag AT_NO_AUTOMOUNT
&gt;&gt; which is meant to clear the LOOKUP_AUTOMOUNT flag and prevent triggering
&gt;&gt; of an automount by the call. But this flag is unconditionally cleared
&gt;&gt; for all stat family system calls except statx().
&gt;&gt;
&gt;&gt; stat family system calls have always triggered mount requests for the
&gt;&gt; negative dentry case in follow_automount() which is intended but prevents
&gt;&gt; the fstatat(2) and statx() AT_NO_AUTOMOUNT case from being handled.
&gt;&gt;
&gt;&gt; In order to handle the AT_NO_AUTOMOUNT for both system calls the
&gt;&gt; negative dentry case in follow_automount() needs to be changed to
&gt;&gt; return ENOENT when the LOOKUP_AUTOMOUNT flag is clear (and the other
&gt;&gt; required flags are clear).
&gt;&gt;
&gt;&gt; AFAICT this change doesn't have any noticable side effects and may,
&gt;&gt; in some use cases (although I didn't see it in testing) prevent
&gt;&gt; unnecessary callbacks to the automount daemon.
&gt; 
&gt; Actually, this patch does have a noticeable side effect.

That's right.

&gt; 
&gt; Previously, if /home were an indirect mount point so that /home/neilb
&gt; would mount my home directory, &quot;ls -l /home/neilb&quot; would always work.
&gt; Now it doesn't.

An this is correct too.

The previous policy was that a -&gt;lookup() would always cause a mount to
occur. It's that policy that prevents the AT_NO_AUTOMOUNT flag from being
able to work consistently.

If you set the indirect mount &quot;browse&quot; option that will cause the mount
point directories for each of the map keys to be pre-created. So a
directory listing will show the mount points and an attempt to access
anything within the mount point directory will cause it to be mounted.

There is still the problem of not knowing map keys when the wildcard
map entry is used.

Still, stat family systems calls have always had similar problems that
prevent consistent behavior.

&gt; 
&gt; This happens because &quot;ls&quot; calls 'lstat' on the path and when that fails
&gt; with &quot;ENOENT&quot;, it doesn't bother trying to open.

I know, I believe the ENOENT is appropriate because there is no mount
and no directory at the time this happens.

&gt; 
&gt; An alternate approach to the problem that this patch addresses is to
&gt; *not* change follow_automount() but instead change the automount daemon
&gt; and possibly autofs.

Perhaps, but the daemon probably doesn't have enough information to
make decisions about this so there would need to be something coming
from the kernel too.

&gt; 
&gt; When a notification of access for an indirect mount point is received,
&gt; it would firstly just create the directory - not triggering a mount.
&gt; If another notification is then received (after the directory has been
&gt; created), it then triggers the mount.

Not sure, perhaps.

But I don't think that will work, I've had many problems with this type
behavior due to bugs and I think the the same sort of problems would be
encountered.

The indirect mount &quot;browse&quot; option which behaves very much like what your
suggesting is the internal program default, and has been since the initial
v5 release. Historically it is disabled on install to maintain backward
compatibility with the original Linux autofs (which is also the reason for
always triggering an automount on -&gt;lookup()).

Perhaps now is the time for that to change. 

&gt; 
&gt; I suspect this might need changes to autofs to avoid races when two
&gt; threads call lstat() on the same path at the same time.  We would need
&gt; to ensure that automount didn't see this as two requests.... though
&gt; maybe it already has enough locking.
&gt; 
&gt; Does that seem reasonable?  Should we revert this patch (as a
&gt; regression) and do something in automount instead?

Can you check out the &quot;browse&quot; option behavior before we talk further
about this please.

The problem in user space now is that there is no way to control
whether an indirect mount that uses the &quot;nobrowse&quot; option is triggered
or not (using fstatat() or statx()) regardless of the flags used and it's
essential the AT_NO_AUTOMOUNT flag work as expected to have user space
take more care in not triggering automounts.

&gt; 
&gt; Thanks,
&gt; NeilBrown
&gt; 
&gt; 
&gt;&gt;
&gt;&gt; It's also possible that a stat family call has been made with a
&gt;&gt; path that is in the process of being mounted by some other process.
&gt;&gt; But stat family calls should return the automount state of the path
&gt;&gt; as it is &quot;now&quot; so it shouldn't wait for mount completion.
&gt;&gt;
&gt;&gt; This is the same semantic as the positive dentry case already
&gt;&gt; handled.
&gt;&gt;
&gt;&gt; Signed-off-by: Ian Kent &lt;raven@xxxxxxxxxx&gt;
&gt;&gt; Cc: David Howells &lt;dhowells@xxxxxxxxxx&gt;
&gt;&gt; Cc: Colin Walters &lt;walters@xxxxxxxxxx&gt;
&gt;&gt; Cc: Ondrej Holy &lt;oholy@xxxxxxxxxx&gt;
&gt;&gt; Cc: stable@xxxxxxxxxxxxxxx
&gt;&gt; ---
&gt;&gt;  fs/namei.c         |   15 ++++++++++++---
&gt;&gt;  include/linux/fs.h |    3 +--
&gt;&gt;  2 files changed, 13 insertions(+), 5 deletions(-)
&gt;&gt;
&gt;&gt; diff --git a/fs/namei.c b/fs/namei.c
&gt;&gt; index 7286f87..cd74838 100644
&gt;&gt; --- a/fs/namei.c
&gt;&gt; +++ b/fs/namei.c
&gt;&gt; @@ -1129,9 +1129,18 @@ static int follow_automount(struct path *path, struct nameidata *nd,
&gt;&gt;  	 * of the daemon to instantiate them before they can be used.
&gt;&gt;  	 */
&gt;&gt;  	if (!(nd-&gt;flags &amp; (LOOKUP_PARENT | LOOKUP_DIRECTORY |
&gt;&gt; -			   LOOKUP_OPEN | LOOKUP_CREATE | LOOKUP_AUTOMOUNT)) &amp;&amp;
&gt;&gt; -	    path-&gt;dentry-&gt;d_inode)
&gt;&gt; -		return -EISDIR;
&gt;&gt; +			   LOOKUP_OPEN | LOOKUP_CREATE |
&gt;&gt; +			   LOOKUP_AUTOMOUNT))) {
&gt;&gt; +		/* Positive dentry that isn't meant to trigger an
&gt;&gt; +		 * automount, EISDIR will allow it to be used,
&gt;&gt; +		 * otherwise there's no mount here &quot;now&quot; so return
&gt;&gt; +		 * ENOENT.
&gt;&gt; +		 */
&gt;&gt; +		if (path-&gt;dentry-&gt;d_inode)
&gt;&gt; +			return -EISDIR;
&gt;&gt; +		else
&gt;&gt; +			return -ENOENT;
&gt;&gt; +	}
&gt;&gt;  
&gt;&gt;  	if (path-&gt;dentry-&gt;d_sb-&gt;s_user_ns != &amp;init_user_ns)
&gt;&gt;  		return -EACCES;
&gt;&gt; diff --git a/include/linux/fs.h b/include/linux/fs.h
&gt;&gt; index 26488b4..be09684 100644
&gt;&gt; --- a/include/linux/fs.h
&gt;&gt; +++ b/include/linux/fs.h
&gt;&gt; @@ -2935,8 +2935,7 @@ static inline int vfs_lstat(const char __user *name, struct kstat *stat)
&gt;&gt;  static inline int vfs_fstatat(int dfd, const char __user *filename,
&gt;&gt;  			      struct kstat *stat, int flags)
&gt;&gt;  {
&gt;&gt; -	return vfs_statx(dfd, filename, flags | AT_NO_AUTOMOUNT,
&gt;&gt; -			 stat, STATX_BASIC_STATS);
&gt;&gt; +	return vfs_statx(dfd, filename, flags, stat, STATX_BASIC_STATS);
&gt;&gt;  }
&gt;&gt;  static inline int vfs_fstat(int fd, struct kstat *stat)
&gt;&gt;  {

--
To unsubscribe from this list: send the line &quot;unsubscribe autofs&quot; in


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="01767" href="msg01767.html">Re: [PATCH 3/3] autofs - fix AT_NO_AUTOMOUNT not being honored</a></strong>
<ul><li><em>From:</em> NeilBrown</li></ul></li>
<li><strong><a name="01766" href="msg01766.html">Re: [PATCH 3/3] autofs - fix AT_NO_AUTOMOUNT not being honored</a></strong>
<ul><li><em>From:</em> Ian Kent</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="01593" href="msg01593.html">[PATCH 1/3] autofs - make disc device user accessible</a></strong>
<ul><li><em>From:</em> Ian Kent</li></ul></li>
<li><strong><a name="01595" href="msg01595.html">[PATCH 3/3] autofs - fix AT_NO_AUTOMOUNT not being honored</a></strong>
<ul><li><em>From:</em> Ian Kent</li></ul></li>
<li><strong><a name="01764" href="msg01764.html">Re: [PATCH 3/3] autofs - fix AT_NO_AUTOMOUNT not being honored</a></strong>
<ul><li><em>From:</em> NeilBrown</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg01764.html">Re: [PATCH 3/3] autofs - fix AT_NO_AUTOMOUNT not being honored</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg01766.html">Re: [PATCH 3/3] autofs - fix AT_NO_AUTOMOUNT not being honored</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg01764.html">Re: [PATCH 3/3] autofs - fix AT_NO_AUTOMOUNT not being honored</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg01766.html">Re: [PATCH 3/3] autofs - fix AT_NO_AUTOMOUNT not being honored</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#01765"><strong>Date</strong></a></li>
<li><a href="index.html#01765"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-fsdevel/>[Linux&nbsp;Filesystem&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-ext4/>[Linux&nbsp;Ext4]</a>
&nbsp;
&nbsp;
<a href=/lists/arm-kernel/>[Linux&nbsp;ARM&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/arm/>[Linux&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;Omap]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-arm/>[Fedora&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/ietf-ann/>[IETF&nbsp;Annouce]</a>
&nbsp;
&nbsp;
<a href=/lists/security/>[Security]</a>
&nbsp;
&nbsp;
<a href=/lists/bugtraq/>[Bugtraq]</a>
&nbsp;
&nbsp;
<a href=/linux/>[Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;OMAP]</a>
&nbsp;
&nbsp;
<a href=/lists/mips/>[Linux&nbsp;MIPS]</a>
&nbsp;
&nbsp;
<a href=/lists/ecos/>[ECOS]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;Internet&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-api/>[Linux&nbsp;API]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH 1/7] vfs &#45; merge path_is_mountpoint() and path_is_mountpoint_rcu() -->
<!--X-From-R13: Wna Yrag &#60;eniraNgurznj.arg> -->
<!--X-Date: Wed, 7 Dec 2016 22:18:35 &#45;0800 -->
<!--X-Message-Id: 1481177905.2480.1.camel@themaw.net -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 148029910861.27779.4517883721395202453.stgit@pluto.themaw.net -->
<!--X-Reference: 20161203051322.GA24765@ZenIV.linux.org.uk -->
<!--X-Reference: 1481017056.4589.21.camel@themaw.net -->
<!--X-Reference: 8737hzv34f.fsf@xmission.com -->
<!--X-Reference: 1481167790.3924.3.camel@themaw.net -->
<!--X-Reference: 87d1h32gf9.fsf@xmission.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu() &mdash; Linux AutoFS">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu() &mdash; Linux AutoFS</title>
<link rel="alternate" type="application/rss+xml" title="Linux AutoFS" href="//feeds.feedburner.com/autofs">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com/cse" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:isdiegq275o" />
    <input type="hidden" name="ie" value="ISO-8859-1" />
    <input type="text" name="q" size="37" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</h1>
[<a href="msg01515.html">Date Prev</a>][<a href="msg01517.html">Date Next</a>][<a href="msg01515.html">Thread Prev</a>][<a href="msg01519.html">Thread Next</a>][<a href="maillist.html#01516">Date Index</a>][<a href="index.html#01516">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: &quot;Eric W. Biederman&quot; &lt;ebiederm@xxxxxxxxxxxx&gt;</li>
<li><em>Subject</em>: Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</li>
<li><em>From</em>: Ian Kent &lt;raven@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 08 Dec 2016 14:18:25 +0800</li>
<li><em>Cc</em>: Al Viro &lt;viro@xxxxxxxxxxxxxxxxxx&gt;,        Andrew Morton &lt;akpm@xxxxxxxxxxxxxxxxxxxx&gt;,        autofs mailing list &lt;autofs@xxxxxxxxxxxxxxx&gt;,        Kernel Mailing List &lt;linux-kernel@xxxxxxxxxxxxxxx&gt;,        linux-fsdevel &lt;linux-fsdevel@xxxxxxxxxxxxxxx&gt;,        Omar Sandoval &lt;osandov@xxxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg01515.html">87d1h32gf9.fsf@xmission.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg01498.html">148029910861.27779.4517883721395202453.stgit@pluto.themaw.net</a>&gt;         &lt;<a href="msg01507.html">20161203051322.GA24765@ZenIV.linux.org.uk</a>&gt;         &lt;<a href="msg01512.html">1481017056.4589.21.camel@themaw.net</a>&gt; &lt;<a href="msg01513.html">8737hzv34f.fsf@xmission.com</a>&gt;         &lt;<a href="msg01514.html">1481167790.3924.3.camel@themaw.net</a>&gt; &lt;<a href="msg01515.html">87d1h32gf9.fsf@xmission.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Thu, 2016-12-08 at 17:28 +1300, Eric W. Biederman wrote:
&gt; Ian Kent &lt;raven@xxxxxxxxxx&gt; writes:
&gt; 
&gt; &gt; On Thu, 2016-12-08 at 10:30 +1300, Eric W. Biederman wrote:
&gt; &gt; &gt; Ian Kent &lt;raven@xxxxxxxxxx&gt; writes:
&gt; &gt; &gt; 
&gt; &gt; &gt; &gt; On Sat, 2016-12-03 at 05:13 +0000, Al Viro wrote:
&gt; &gt; &gt; &gt; &gt; 	FWIW, I've folded that pile into vfs.git#work.autofs.
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; Problems:
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; snip ...
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; 	* the last one (propagation-related) is too ugly to live - at
&gt; &gt; &gt; &gt; &gt; the
&gt; &gt; &gt; &gt; &gt; very least, its pieces should live in fs/pnode.c; exposing
&gt; &gt; &gt; &gt; &gt; propagate_next()
&gt; &gt; &gt; &gt; &gt; is simply wrong.&#xA0;&#xA0;I hadn't picked that one at all, and I would suggest
&gt; &gt; &gt; &gt; &gt; coordinating anything in that area with ebiederman - he has some work
&gt; &gt; &gt; &gt; &gt; around fs/pnode.c and you risk stepping on his toes.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; The earlier patches seem to be ok now so how about we talk a little
&gt; &gt; &gt; &gt; about
&gt; &gt; &gt; &gt; this
&gt; &gt; &gt; &gt; last one.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; Eric, Al mentioned that you are working with fs/pnode.c and recommended
&gt; &gt; &gt; &gt; I
&gt; &gt; &gt; &gt; co-
&gt; &gt; &gt; &gt; ordinate with you.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; So is my working on this this (which is most likely going to live in
&gt; &gt; &gt; &gt; pnode.c
&gt; &gt; &gt; &gt; if
&gt; &gt; &gt; &gt; I can can get something acceptable) going to cause complications for
&gt; &gt; &gt; &gt; you?
&gt; &gt; &gt; &gt; Is what your doing at a point were it would be worth doing as Al
&gt; &gt; &gt; &gt; suggests?
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; Anyway, the problem that this patch is supposed to solve is to check if
&gt; &gt; &gt; &gt; any
&gt; &gt; &gt; &gt; of
&gt; &gt; &gt; &gt; the list of mnt_mounts or any of the mounts propagated from each are in
&gt; &gt; &gt; &gt; use.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; One obvious problem with it is the propagation could be very large.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; But now I look at it again there's no reason to have to every tree
&gt; &gt; &gt; &gt; because
&gt; &gt; &gt; &gt; if
&gt; &gt; &gt; &gt; one tree is busy then the the set of trees is busy. But every tree would
&gt; &gt; &gt; &gt; be
&gt; &gt; &gt; &gt; visited if the not busy so it's perhaps still a problem.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; The difficult thing is working out if a tree is busy, more so because
&gt; &gt; &gt; &gt; there
&gt; &gt; &gt; &gt; could be a struct path holding references within any the trees so I
&gt; &gt; &gt; &gt; don't
&gt; &gt; &gt; &gt; know
&gt; &gt; &gt; &gt; of a simpler, more efficient way to check for this.
&gt; &gt; &gt; 
&gt; &gt; &gt; So coordination seems to be in order.&#xA0;&#xA0;Not so much because of your
&gt; &gt; &gt; current implementation (which won't tell you what you want to know)
&gt; &gt; 
&gt; &gt; Umm ... ok I've missed something then because the patch I posted does appear
&gt; &gt; to
&gt; &gt; get the calculation right. Perhaps I've missed a case where it gets it wrong
&gt; &gt; ....
&gt; &gt; 
&gt; &gt; But now I'm looking deeper into it I'm beginning to wonder why it worked for
&gt; &gt; one
&gt; &gt; of the cases. Maybe I need to do some more tests with even more
&gt; &gt; printks.
&gt; 
&gt; So the case that I am concerned about is that if someone happens to do
&gt; mount --bind the mount propagation trees would not just be mirror images
&gt; in single filesystems but have leaves in odd places.
&gt; 
&gt; Consider .../base/one/two (where one and two are automounts) and base
&gt; is the shared mountpoint that is propagated between namespaces.
&gt; 
&gt; If someone does mount --bind .../base/one ../somepath/one in any
&gt; namespace then there will be places where an unmount of &quot;two&quot; will
&gt; propagate to, but that an unmount of &quot;one&quot; won't as their respective
&gt; propagation trees are different.
&gt; 
&gt; Not accounting for different mount points having different propagation
&gt; trees is what I meant when I said your code was wrong.

Yeah, it's all too easy for me to miss important cases like this because such
things are not allowed (or rather not supported, since it can be done) within
automount managed directories. Even without propagation it can be problematic.

But you're right, that's no excuse for a VFS function to not cater for, or at
least handle sensibly, cases like this.

&gt; 
&gt; &gt; &gt; but because an implementation that tells you what you are looking for
&gt; &gt; &gt; has really bad &gt; O(N^2) complexity walking the propagation tree in
&gt; &gt; &gt; the worst case.
&gt; &gt; 
&gt; &gt; Yes it is bad indeed.
&gt; &gt; 
&gt; &gt; &gt; 
&gt; &gt; &gt; To be correct you code would need to use next_mnt and walk the tree and
&gt; &gt; &gt; on each mount use propagate_mnt_busy to see if that entry can be
&gt; &gt; &gt; unmounted.&#xA0;&#xA0;Possibly with small variations to match your case.&#xA0;&#xA0;Mounts
&gt; &gt; &gt; in one part of the tree may propagate to places that mounts in other
&gt; &gt; &gt; parts of the tree will not.
&gt; &gt; 
&gt; &gt; Right, the point there being use propagate_mnt_busy() for the check.
&gt; 
&gt; Or a variant of propagate_mnt_busy.
&gt; 
&gt; &gt; I tried to use that when I started this but had trouble, I'll have another
&gt; &gt; look
&gt; &gt; at using it.
&gt; &gt; 
&gt; &gt; I thought the reason I couldn't use propagate_mnt_busy() is because it will
&gt; &gt; see
&gt; &gt; any mount with submounts as busy and that's not what's need. It's mounts
&gt; &gt; below
&gt; &gt; each of mounts having submounts that make them busy in my case.
&gt; 
&gt; If you have the count of submounts passed into propagate_mnt_busy() it
&gt; will come very close to what you need.&#xA0;&#xA0;It is still possible to have
&gt; false positives in the face of propagation slaves that have had some of
&gt; your autofs mounts unmounted, and something else mounted upon them.

That shouldn't be done within an automount managed mount even though there's no
way to for the autofs module to veto such mounts and the daemon would probably
handle a good number of cases of it.

The justification being that automount managed mounts are defined by maps that
refer to specific paths which are specifically what the administrator wishes to
provide.

So, strictly speaking, passing an autofs mount point to a container with a
volume option should use the same path as the automount managed directory
although it isn't (can't be) enforced and works ok, it's wrong in principle.

Still, this is also an aside from the fact that the cases you site must be
handled by general kernel code.

&gt; 
&gt; If all you need is a better approximation something like your current
&gt; code with comments about it's limitations might even be reasonable.

Maybe but I worry about the propagation list becoming very large which is likely
for some larger autofs users. So I really do need to worry about these cases.

I was aware of this problem with the initial patch but really needed a starting
point for discussion.

&gt; 
&gt; &gt; You probably don't want to read about this but, unfortunately, an example is
&gt; &gt; possibly the best way to describe what I need to achieve.
&gt; 
&gt; [snip good example]
&gt; 
&gt; &gt; &gt; &gt; Anyone have any suggestions at all?
&gt; &gt; &gt; 
&gt; &gt; &gt; In the short term I recommend just not doing this, but if you want to
&gt; &gt; &gt; see if you can find an efficient algorithm with me, I am happy to bring
&gt; &gt; &gt; you up to speed on all of the gory details.
&gt; &gt; 
&gt; &gt; I need to do this to make autofs play better in the presence of namespaces
&gt; &gt; and
&gt; &gt; that's a problem now and is long overdue to be resolved.
&gt; &gt; 
&gt; &gt; So I'm happy to do whatever I can to work toward that.
&gt; &gt; 
&gt; &gt; I could leave this part of the implementation until later because the false
&gt; &gt; positive this solves leads to an expire fail and that is (must be) handled
&gt; &gt; properly by the user space daemon.
&gt; &gt; 
&gt; &gt; But when I first noticed the false positive the expire failure was handled
&gt; &gt; ok by
&gt; &gt; the daemon (AFAICS) but there was what looked like a reference counting
&gt; &gt; problem
&gt; &gt; (but not quite that either, odd) which I was going to return to later.
&gt; &gt; 
&gt; &gt; Maybe I've stumbled onto a subtle propagation bug that really needs
&gt; &gt; fixing ....
&gt; 
&gt; MNT_DETACH has worst case performance issues when a tree of mounts is
&gt; unmounted that would really be nice to fix, as it can propogate pretty
&gt; horrible.&#xA0;&#xA0;You are trying to do something very similar to MNT_DETACH so
&gt; an efficient solution for one is likely an efficient solution for the
&gt; other.

Let me digest that for a while.

Thanks
Ian

--
To unsubscribe from this list: send the line &quot;unsubscribe autofs&quot; in


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="01498" href="msg01498.html">[PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</a></strong>
<ul><li><em>From:</em> Ian Kent</li></ul></li>
<li><strong><a name="01507" href="msg01507.html">Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</a></strong>
<ul><li><em>From:</em> Al Viro</li></ul></li>
<li><strong><a name="01512" href="msg01512.html">Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</a></strong>
<ul><li><em>From:</em> Ian Kent</li></ul></li>
<li><strong><a name="01513" href="msg01513.html">Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</a></strong>
<ul><li><em>From:</em> Eric W. Biederman</li></ul></li>
<li><strong><a name="01514" href="msg01514.html">Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</a></strong>
<ul><li><em>From:</em> Ian Kent</li></ul></li>
<li><strong><a name="01515" href="msg01515.html">Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</a></strong>
<ul><li><em>From:</em> Eric W. Biederman</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg01515.html">Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg01517.html">[PATCH 2/6] autofs: fix typo in Documentation</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg01515.html">Re: [PATCH 1/7] vfs - merge path_is_mountpoint() and path_is_mountpoint_rcu()</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg01519.html">[PATCH 1/6] autofs: remove wrong comment</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#01516"><strong>Date</strong></a></li>
<li><a href="index.html#01516"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-fsdevel/>[Linux&nbsp;Filesystem&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-ext4/>[Linux&nbsp;Ext4]</a>
&nbsp;
&nbsp;
<a href=/lists/arm-kernel/>[Linux&nbsp;ARM&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/arm/>[Linux&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;Omap]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-arm/>[Fedora&nbsp;ARM]</a>
&nbsp;
&nbsp;
<a href=/lists/ietf-ann/>[IETF&nbsp;Annouce]</a>
&nbsp;
&nbsp;
<a href=/lists/security/>[Security]</a>
&nbsp;
&nbsp;
<a href=/lists/bugtraq/>[Bugtraq]</a>
&nbsp;
&nbsp;
<a href=/linux/>[Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-omap/>[Linux&nbsp;OMAP]</a>
&nbsp;
&nbsp;
<a href=/lists/mips/>[Linux&nbsp;MIPS]</a>
&nbsp;
&nbsp;
<a href=/lists/ecos/>[ECOS]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;Internet&nbsp;PBX]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-api/>[Linux&nbsp;API]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

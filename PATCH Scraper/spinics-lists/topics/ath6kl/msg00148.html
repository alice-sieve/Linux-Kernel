<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH v3 1/2] ath6kl_sdio: Add reset gpio module parameter for CHIP_PWD_L pin -->
<!--X-From-R13: Egrir qrDbfvre &#60;qrebfvreNtznvy.pbz> -->
<!--X-Date: Sun, 22 Nov 2015 16:18:09 &#45;0800 -->
<!--X-Message-Id: 1448237747&#45;20037&#45;2&#45;git&#45;send&#45;email&#45;steve.derosier@lairdtech.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 1448237747&#45;20037&#45;1&#45;git&#45;send&#45;email&#45;steve.derosier@lairdtech.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Linux ATH6KL: [PATCH v3 1/2] ath6kl_sdio: Add reset gpio module parameter for CHIP_PWD_L pin">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[PATCH v3 1/2] ath6kl_sdio: Add reset gpio module parameter for CHIP_PWD_L pin (Linux ATH6KL)</title>
<link rel="alternate" type="application/rss+xml" title="Linux ATH6KL" href="//feedproxy.google.com/LinuxATH6KL">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:6308783764" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH v3 1/2] ath6kl_sdio: Add reset gpio module parameter for CHIP_PWD_L pin</h1>
[<a href="msg00147.html">Date Prev</a>][<a href="msg00149.html">Date Next</a>][<a href="msg00147.html">Thread Prev</a>][<a href="msg00162.html">Thread Next</a>][<a href="maillist.html#00148">Date Index</a>][<a href="index.html#00148">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Kalle Valo &lt;<a href="mailto:kvalo@DOMAIN.HIDDEN">kvalo@xxxxxxxxxxxxxxxx</a>&gt;</li>
<li><em>Subject</em>: [PATCH v3 1/2] ath6kl_sdio: Add reset gpio module parameter for CHIP_PWD_L pin</li>
<li><em>From</em>: Steve deRosier &lt;<a href="mailto:derosier@DOMAIN.HIDDEN">derosier@xxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Sun, 22 Nov 2015 16:15:46 -0800</li>
<li><em>Cc</em>: Julian Calaby &lt;<a href="mailto:julian.calaby@DOMAIN.HIDDEN">julian.calaby@xxxxxxxxx</a>&gt;, <a href="mailto:ath6kl@DOMAIN.HIDDEN">ath6kl@xxxxxxxxxxxxxxxxxxx</a>,        <a href="mailto:linux-wireless@DOMAIN.HIDDEN">linux-wireless@xxxxxxxxxxxxxxx</a>,        Steve deRosier &lt;<a href="mailto:steve.derosier@DOMAIN.HIDDEN">steve.derosier@xxxxxxxxxxxxx</a>&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg00147.html">1448237747-20037-1-git-send-email-steve.derosier@lairdtech.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Many ath6k chips have a reset pin, usually labeled CHIP_PWD_L. This pin can
be pulled low by the host processor to hold the wifi chip in reset. By
holding the chip in reset, the lowest power consumption available can be
achieved.

This adds a module parameter so the ath6kl_sdio driver can control the
CHIP_PWD_L pin if the implementer so desires. This code is only available
if GPIOLIB is configured.

Signed-off-by: Steve deRosier &lt;steve.derosier@xxxxxxxxxxxxx&gt;
---
 drivers/net/wireless/ath/ath6kl/sdio.c | 70 +++++++++++++++++++++++++++++++++-
 1 file changed, 69 insertions(+), 1 deletion(-)

diff --git a/drivers/net/wireless/ath/ath6kl/sdio.c b/drivers/net/wireless/ath/ath6kl/sdio.c
index eab0ab9..d06aa41 100644
--- a/drivers/net/wireless/ath/ath6kl/sdio.c
+++ b/drivers/net/wireless/ath/ath6kl/sdio.c
@@ -23,6 +23,7 @@
 #include &lt;linux/mmc/sdio_ids.h&gt;
 #include &lt;linux/mmc/sdio.h&gt;
 #include &lt;linux/mmc/sd.h&gt;
+#include &lt;linux/gpio.h&gt;
 #include &quot;hif.h&quot;
 #include &quot;hif-ops.h&quot;
 #include &quot;target.h&quot;
@@ -69,6 +70,20 @@ struct ath6kl_sdio {
 	spinlock_t wr_async_lock;
 };
 
+/* Delay to avoid the mmc driver calling the probe on the prior notice of
+ * the chip, which we just killed. If this is missing, it results in a
+ * spurious warning:
+ * &quot;ath6kl_sdio: probe of mmc0:0001:1 failed with error -110&quot;
+ *
+ * Time chosen experimentally, with padding
+ */
+#define ATH6KL_MMC_PROBE_DELAY	150
+static unsigned int reset_pwd_gpio = ARCH_NR_GPIOS;
+#ifdef CONFIG_GPIOLIB
+module_param(reset_pwd_gpio, uint, 0644);
+MODULE_PARM_DESC(reset_pwd_gpio, &quot;WIFI CHIP_PWD reset pin GPIO&quot;);
+#endif
+
 #define CMD53_ARG_READ          0
 #define CMD53_ARG_WRITE         1
 #define CMD53_ARG_BLOCK_BASIS   1
@@ -1414,20 +1429,73 @@ static struct sdio_driver ath6kl_sdio_driver = {
 	.drv.pm = ATH6KL_SDIO_PM_OPS,
 };
 
+static int ath6kl_sdio_init_gpio(void)
+{
+	int ret = 0;
+
+	if (gpio_is_valid(reset_pwd_gpio)) {
+		/* Request the reset GPIO, and assert it to make sure we get a
+		 * clean boot in-case we had a floating input or other issue.
+		 */
+		ret = gpio_request_one(reset_pwd_gpio,
+				       GPIOF_OUT_INIT_LOW |
+				       GPIOF_EXPORT_DIR_FIXED,
+				       &quot;WIFI_RESET&quot;);
+		if (ret) {
+			ath6kl_err(&quot;Unable to get WIFI power gpio: %d\n&quot;, ret);
+			return ret;
+		}
+
+		ath6kl_dbg(ATH6KL_DBG_SUSPEND, &quot;Setup wifi gpio #%d\n&quot;,
+			   reset_pwd_gpio);
+		usleep_range(20, 50); /* Pin must be asserted at least 5 usec */
+		gpio_set_value(reset_pwd_gpio, 1); /* De-assert the pin */
+
+		msleep(ATH6KL_MMC_PROBE_DELAY);
+	}
+
+	return 0;
+}
+
+static void ath6kl_sdio_release_gpio(void)
+{
+	if (gpio_is_valid(reset_pwd_gpio)) {
+		/* Be sure we leave the chip in reset when we unload and also
+		 * release the GPIO
+		 */
+		gpio_set_value(reset_pwd_gpio, 0);
+		gpio_free(reset_pwd_gpio);
+	}
+}
+
 static int __init ath6kl_sdio_init(void)
 {
 	int ret;
 
-	ret = sdio_register_driver(&amp;ath6kl_sdio_driver);
+	ret = ath6kl_sdio_init_gpio();
 	if (ret)
+		goto err_gpio;
+
+	ret = sdio_register_driver(&amp;ath6kl_sdio_driver);
+	if (ret) {
 		ath6kl_err(&quot;sdio driver registration failed: %d\n&quot;, ret);
+		goto err_register;
+	}
 
 	return ret;
+
+err_register:
+	ath6kl_sdio_release_gpio();
+
+err_gpio:
+	return ret;
 }
 
 static void __exit ath6kl_sdio_exit(void)
 {
 	sdio_unregister_driver(&amp;ath6kl_sdio_driver);
+
+	ath6kl_sdio_release_gpio();
 }
 
 module_init(ath6kl_sdio_init);
-- 
1.9.1


_______________________________________________
ath6kl mailing list
ath6kl@xxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="http://lists.infradead.org/mailman/listinfo/ath6kl">http://lists.infradead.org/mailman/listinfo/ath6kl</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00166" href="msg00166.html">Re: [PATCH v3 1/2] ath6kl_sdio: Add reset gpio module parameter for CHIP_PWD_L pin</a></strong>
<ul><li><em>From:</em> kbuild test robot</li></ul></li>
<li><strong><a name="00162" href="msg00162.html">Re: [PATCH v3 1/2] ath6kl_sdio: Add reset gpio module parameter for CHIP_PWD_L pin</a></strong>
<ul><li><em>From:</em> Kalle Valo</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00147" href="msg00147.html">[PATCH v3 0/2] ath6kl_sdio: add control of CHIP_PWD_L via GPIO</a></strong>
<ul><li><em>From:</em> Steve deRosier</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00147.html">[PATCH v3 0/2] ath6kl_sdio: add control of CHIP_PWD_L via GPIO</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00149.html">[PATCH v3 2/2] ath6kl_sdio: Add power gpio reset feature into sdio driver for suspend</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00147.html">[PATCH v3 0/2] ath6kl_sdio: add control of CHIP_PWD_L via GPIO</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00162.html">Re: [PATCH v3 1/2] ath6kl_sdio: Add reset gpio module parameter for CHIP_PWD_L pin</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00148"><strong>Date</strong></a></li>
<li><a href="index.html#00148"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-wireless/>[Linux&nbsp;Wireless]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-bluetooth/>[Linux&nbsp;Bluetooth]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-wpan/>[Linux&nbsp;WPAN]</a>
&nbsp;
&nbsp;
<a href=/lists/netdev/>[Linux&nbsp;Netdev]</a>
&nbsp;
&nbsp;
<a href=/lists/newbies/>[Kernel&nbsp;Newbies]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-ide/>[IDE]</a>
&nbsp;
&nbsp;
<a href=/lists/security/>[Security]</a>
&nbsp;
&nbsp;
<a href=/lists/git/>[Git]</a>
&nbsp;
&nbsp;
<a href=/lists/netfilter/>[Netfilter]</a>
&nbsp;
&nbsp;
<a href=/lists/bugtraq/>[Bugtraq]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/mips/>[MIPS&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/arm/>[ARM&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/security/>[Linux&nbsp;Security]</a>
&nbsp;
&nbsp;
<a href=/lists/raid/>[Linux&nbsp;RAID]</a>
&nbsp;
&nbsp;
<a href=/lists/ataraid/>[Linux&nbsp;ATA&nbsp;RAID]</a>
&nbsp;
&nbsp;
<a href=/lists/samba/>[Samba]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

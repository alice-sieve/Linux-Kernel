<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH 03/10] drm/sysfs: Add mstpath attribute to connector devices -->
<!--X-From-R13: "Zv, Eha crat (Zrb)" &#60;Ehacrat.ZvNnzq.pbz> -->
<!--X-Date: Fri, 5 Jul 2019 07:04:02 &#45;0700 -->
<!--X-Message-Id: cfb3d588&#45;e961&#45;1d3b&#45;be6b&#45;d41069f5df03@amd.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190704190519.29525&#45;1&#45;sunpeng.li@amd.com -->
<!--X-Reference: 20190704190519.29525&#45;4&#45;sunpeng.li@amd.com -->
<!--X-Reference: 20190704193304.GJ5942@intel.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="AMD GFX: Re: [PATCH 03/10] drm/sysfs: Add mstpath attribute to connector devices">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH 03/10] drm/sysfs: Add mstpath attribute to connector devices &mdash; Linux AMD GFX</title>
<link rel="alternate" type="application/rss+xml" title="Linux AMD GFX" href="//feeds.feedburner.com/LinuxAmdGraphics">
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en" async defer></script>
<h1 itemprop="name">Re: [PATCH 03/10] drm/sysfs: Add mstpath attribute to connector devices</h1>
[<a href="msg35580.html">Date Prev</a>][<a href="msg35582.html">Date Next</a>][<a href="msg35566.html">Thread Prev</a>][<a href="msg35582.html">Thread Next</a>][<a href="maillist.html#35581">Date Index</a>][<a href="index.html#35581">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Ville Syrj&#xE4;l&#xE4; &lt;ville.syrjala@xxxxxxxxxxxxxxx&gt;</li>
<li><em>Subject</em>: Re: [PATCH 03/10] drm/sysfs: Add mstpath attribute to connector devices</li>
<li><em>From</em>: &quot;Li, Sun peng (Leo)&quot; &lt;Sunpeng.Li@xxxxxxx&gt;</li>
<li><em>Date</em>: Fri, 5 Jul 2019 14:03:52 +0000</li>
<li><em>Accept-language</em>: en-US</li>
<li><em>Cc</em>: &quot;dri-devel@xxxxxxxxxxxxxxxxxxxxx&quot; &lt;dri-devel@xxxxxxxxxxxxxxxxxxxxx&gt;,        &quot;amd-gfx@xxxxxxxxxxxxxxxxxxxxx&quot; &lt;amd-gfx@xxxxxxxxxxxxxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg35566.html">20190704193304.GJ5942@intel.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg35555.html">20190704190519.29525-1-sunpeng.li@amd.com</a>&gt; &lt;<a href="msg35559.html">20190704190519.29525-4-sunpeng.li@amd.com</a>&gt; &lt;<a href="msg35566.html">20190704193304.GJ5942@intel.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>


On 2019-07-04 3:33 p.m., Ville Syrj&#xE4;l&#xE4; wrote:
&gt;<i> On Thu, Jul 04, 2019 at 03:05:12PM -0400, sunpeng.li@xxxxxxx wrote:</i>
&gt;<i>&gt; From: Leo Li &lt;sunpeng.li@xxxxxxx&gt;</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; This can be used to create more descriptive symlinks for MST aux</i>
&gt;<i>&gt; devices. Consider the following udev rule:</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; SUBSYSTEM==&quot;drm_dp_aux_dev&quot;, SUBSYSTEMS==&quot;drm&quot;, ATTRS{mstpath}==&quot;?*&quot;,</i>
&gt;<i>&gt; 	SYMLINK+=&quot;drm_dp_aux/by-path/$attr{mstpath}&quot;</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; The following symlinks will be created (depending on your MST topology):</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; $ ls /dev/drm_dp_aux/by-path/</i>
&gt;<i>&gt; card0-mst:0-1  card0-mst:0-1-1  card0-mst:0-1-8  card0-mst:0-8</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; Signed-off-by: Leo Li &lt;sunpeng.li@xxxxxxx&gt;</i>
&gt;<i>&gt; ---</i>
&gt;<i>&gt;  drivers/gpu/drm/drm_sysfs.c | 23 +++++++++++++++++++++++</i>
&gt;<i>&gt;  1 file changed, 23 insertions(+)</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; diff --git a/drivers/gpu/drm/drm_sysfs.c b/drivers/gpu/drm/drm_sysfs.c</i>
&gt;<i>&gt; index ad10810bc972..53fd1f71e900 100644</i>
&gt;<i>&gt; --- a/drivers/gpu/drm/drm_sysfs.c</i>
&gt;<i>&gt; +++ b/drivers/gpu/drm/drm_sysfs.c</i>
&gt;<i>&gt; @@ -236,16 +236,39 @@ static ssize_t modes_show(struct device *device,</i>
&gt;<i>&gt;  	return written;</i>
&gt;<i>&gt;  }</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt; +static ssize_t mstpath_show(struct device *device,</i>
&gt;<i>&gt; +			    struct device_attribute *attr,</i>
&gt;<i>&gt; +			    char *buf)</i>
&gt;<i>&gt; +{</i>
&gt;<i>&gt; +	struct drm_connector *connector = to_drm_connector(device);</i>
&gt;<i>&gt; +	ssize_t ret = 0;</i>
&gt;<i>&gt; +	char *path;</i>
&gt;<i>&gt; +</i>
&gt;<i>&gt; +	mutex_lock(&amp;connector-&gt;dev-&gt;mode_config.mutex);</i>
&gt;<i> </i>
&gt;<i> The blob is populated when the connector is created so I don't think</i>
&gt;<i> this lock is actually doing anything for us.</i>

Right, will drop this.

&gt;<i> </i>
&gt;<i> One would also hope that device_unregister() protects us from racing</i>
&gt;<i> with the removal of the attribute. Eg. if you hold a file descriptor</i>
&gt;<i> open to the sysfs file does device_unregister() block until the fd is</i>
&gt;<i> closed?</i>

For dpcd transactions, as long as the aux device is unregistered through
drm_dp_aux_unregister_devnode(), we should be good. There's an atomic_t
use_count that syncs against reads and writes.

Although I'm not sure what would happen if the device was ripped out
from underneath us, say, if the parent connector device is removed
before calling aux_unregister_devnode(). If this does happen, I think
it's more of an order-of-operations issue from the driver. V2 of patch 2
(and 7-10) actually addresses a specific occurence of this during driver
unload.

Regarding sysfs attrs, the kernfs underneath does seem to guarantee that
any r/w is completed before removal. See kernfs_drain(), called as part
of kernfs_remove().

Leo

&gt;<i> </i>
&gt;<i>&gt; +	if (!connector-&gt;path_blob_ptr)</i>
&gt;<i>&gt; +		goto unlock;</i>
&gt;<i>&gt; +</i>
&gt;<i>&gt; +	path = connector-&gt;path_blob_ptr-&gt;data;</i>
&gt;<i>&gt; +	ret = snprintf(buf, PAGE_SIZE, &quot;card%d-%s\n&quot;,</i>
&gt;<i>&gt; +		       connector-&gt;dev-&gt;primary-&gt;index, path);</i>
&gt;<i>&gt; +</i>
&gt;<i>&gt; +unlock:</i>
&gt;<i>&gt; +	mutex_unlock(&amp;connector-&gt;dev-&gt;mode_config.mutex);</i>
&gt;<i>&gt; +	return ret;</i>
&gt;<i>&gt; +}</i>
&gt;<i>&gt; +</i>
&gt;<i>&gt;  static DEVICE_ATTR_RW(status);</i>
&gt;<i>&gt;  static DEVICE_ATTR_RO(enabled);</i>
&gt;<i>&gt;  static DEVICE_ATTR_RO(dpms);</i>
&gt;<i>&gt;  static DEVICE_ATTR_RO(modes);</i>
&gt;<i>&gt; +static DEVICE_ATTR_RO(mstpath);</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt;  static struct attribute *connector_dev_attrs[] = {</i>
&gt;<i>&gt;  	&amp;dev_attr_status.attr,</i>
&gt;<i>&gt;  	&amp;dev_attr_enabled.attr,</i>
&gt;<i>&gt;  	&amp;dev_attr_dpms.attr,</i>
&gt;<i>&gt;  	&amp;dev_attr_modes.attr,</i>
&gt;<i>&gt; +	&amp;dev_attr_mstpath.attr,</i>
&gt;<i>&gt;  	NULL</i>
&gt;<i>&gt;  };</i>
&gt;<i>&gt;  </i>
&gt;<i>&gt; -- </i>
&gt;<i>&gt; 2.22.0</i>
&gt;<i> </i>
_______________________________________________
amd-gfx mailing list
amd-gfx@xxxxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://lists.freedesktop.org/mailman/listinfo/amd-gfx">https://lists.freedesktop.org/mailman/listinfo/amd-gfx</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="35555" href="msg35555.html">[PATCH 00/10] Enable MST Aux devices (v2)</a></strong>
<ul><li><em>From:</em> sunpeng.li</li></ul></li>
<li><strong><a name="35559" href="msg35559.html">[PATCH 03/10] drm/sysfs: Add mstpath attribute to connector devices</a></strong>
<ul><li><em>From:</em> sunpeng.li</li></ul></li>
<li><strong><a name="35566" href="msg35566.html">Re: [PATCH 03/10] drm/sysfs: Add mstpath attribute to connector devices</a></strong>
<ul><li><em>From:</em> Ville Syrj&#xE4;l&#xE4;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg35580.html">Re: [PATCH v3 01/22] drm: Include ddc adapter pointer in struct drm_connector</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg35582.html">[PATCH v2] drm/sysfs: Add mstpath attribute to connector devices</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg35566.html">Re: [PATCH 03/10] drm/sysfs: Add mstpath attribute to connector devices</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg35582.html">[PATCH v2] drm/sysfs: Add mstpath attribute to connector devices</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#35581"><strong>Date</strong></a></li>
<li><a href="index.html#35581"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH 2/2] amdgpu: make SOC15/navi support conditional -->
<!--X-From-R13: Oeaq Pretznaa &#60;neaqNneaqo.qr> -->
<!--X-Date: Mon, 8 Jul 2019 07:43:11 &#45;0700 -->
<!--X-Message-Id: 20190708144205.2770771&#45;2&#45;arnd@arndb.de -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190708144205.2770771&#45;1&#45;arnd@arndb.de -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="AMD GFX: [PATCH 2/2] amdgpu: make SOC15/navi support conditional">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[PATCH 2/2] amdgpu: make SOC15/navi support conditional &mdash; Linux AMD GFX</title>
<link rel="alternate" type="application/rss+xml" title="Linux AMD GFX" href="//feeds.feedburner.com/LinuxAmdGraphics">
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en" async defer></script>
<h1 itemprop="name">[PATCH 2/2] amdgpu: make SOC15/navi support conditional</h1>
[<a href="msg35613.html">Date Prev</a>][<a href="msg35615.html">Date Next</a>][<a href="msg35613.html">Thread Prev</a>][<a href="msg35615.html">Thread Next</a>][<a href="maillist.html#35614">Date Index</a>][<a href="index.html#35614">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: Alex Deucher &lt;alexander.deucher@xxxxxxx&gt;,        Christian K&#xF6;nig &lt;christian.koenig@xxxxxxx&gt;,        &quot;David (ChunMing) Zhou&quot; &lt;David1.Zhou@xxxxxxx&gt;,        David Airlie &lt;airlied@xxxxxxxx&gt;, Daniel Vetter &lt;daniel@xxxxxxxx&gt;,        Oded Gabbay &lt;oded.gabbay@xxxxxxxxx&gt;</li>
<li><em>Subject</em>: [PATCH 2/2] amdgpu: make SOC15/navi support conditional</li>
<li><em>From</em>: Arnd Bergmann &lt;arnd@xxxxxxxx&gt;</li>
<li><em>Date</em>: Mon,  8 Jul 2019 16:41:44 +0200</li>
<li><em>Cc</em>: Philip Yang &lt;Philip.Yang@xxxxxxx&gt;, Jack Xiao &lt;Jack.Xiao@xxxxxxx&gt;,        Evan Quan &lt;evan.quan@xxxxxxx&gt;, Arnd Bergmann &lt;arnd@xxxxxxxx&gt;,        Yong Zhao &lt;Yong.Zhao@xxxxxxx&gt;, Amber Lin &lt;Amber.Lin@xxxxxxx&gt;,        Feifei Xu &lt;Feifei.Xu@xxxxxxx&gt;, Felix Kuehling &lt;Felix.Kuehling@xxxxxxx&gt;,        xinhui pan &lt;xinhui.pan@xxxxxxx&gt;, linux-kernel@xxxxxxxxxxxxxxx,        amd-gfx@xxxxxxxxxxxxxxxxxxxxx, Emily Deng &lt;Emily.Deng@xxxxxxx&gt;,        Huang Rui &lt;ray.huang@xxxxxxx&gt;, dri-devel@xxxxxxxxxxxxxxxxxxxxx,        Rex Zhu &lt;Rex.Zhu@xxxxxxx&gt;, Thomas Gleixner &lt;tglx@xxxxxxxxxxxxx&gt;,        Shaoyun Liu &lt;Shaoyun.Liu@xxxxxxx&gt;,        Andrey Grodzovsky &lt;andrey.grodzovsky@xxxxxxx&gt;,        Oak Zeng &lt;Oak.Zeng@xxxxxxx&gt;, Hawking Zhang &lt;Hawking.Zhang@xxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg35613.html">20190708144205.2770771-1-arnd@arndb.de</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg35613.html">20190708144205.2770771-1-arnd@arndb.de</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Enabling amdgpu but not CONFIG_DRM_AMD_DC leads to a warning:

drivers/gpu/drm/amd/amdgpu/nv.c: In function 'nv_set_ip_blocks':
drivers/gpu/drm/amd/amdgpu/nv.c:400:3: error: #warning &quot;Enable CONFIG_DRM_AMD_DC for display support on navi.&quot; [-Werror=cpp]
 # warning &quot;Enable CONFIG_DRM_AMD_DC for display support on navi.&quot;
   ^~~~~~~
drivers/gpu/drm/amd/amdgpu/soc15.c: In function 'soc15_set_ip_blocks':
drivers/gpu/drm/amd/amdgpu/soc15.c:653:3: error: #warning &quot;Enable CONFIG_DRM_AMD_DC for display support on SOC15.&quot; [-Werror=cpp]

However, CONFIG_DRM_AMD_DC can only be enabled on x86, so we
cannot do that when building for other architectures.

Add another Kconfig symbol to handle the SOC15 and navi, making
sure that we implicitly enable DC.

Signed-off-by: Arnd Bergmann &lt;arnd@xxxxxxxx&gt;
---
 drivers/gpu/drm/amd/amdgpu/Kconfig         |  7 +++++
 drivers/gpu/drm/amd/amdgpu/Makefile        | 32 +++++++++++++++-------
 drivers/gpu/drm/amd/amdgpu/amdgpu_amdkfd.c |  2 ++
 drivers/gpu/drm/amd/amdgpu/amdgpu_device.c |  2 ++
 4 files changed, 33 insertions(+), 10 deletions(-)

diff --git a/drivers/gpu/drm/amd/amdgpu/Kconfig b/drivers/gpu/drm/amd/amdgpu/Kconfig
index a04f2fc7bf37..d7186dd88dbc 100644
--- a/drivers/gpu/drm/amd/amdgpu/Kconfig
+++ b/drivers/gpu/drm/amd/amdgpu/Kconfig
@@ -24,6 +24,13 @@ config DRM_AMDGPU_CIK
 
 	  radeon.cik_support=0 amdgpu.cik_support=1
 
+config DRM_AMDGPU_SOC15
+	bool &quot;Enable amdgpu support for SOC15 parts&quot;
+	depends on DRM_AMDGPU
+	select DRM_AMD_DC
+	help
+	  Choose this option if you want to enable support for SOC15 asics.
+
 config DRM_AMDGPU_USERPTR
 	bool &quot;Always enable userptr write support&quot;
 	depends on DRM_AMDGPU
diff --git a/drivers/gpu/drm/amd/amdgpu/Makefile b/drivers/gpu/drm/amd/amdgpu/Makefile
index 3f5329906fce..e95ae468eaa1 100644
--- a/drivers/gpu/drm/amd/amdgpu/Makefile
+++ b/drivers/gpu/drm/amd/amdgpu/Makefile
@@ -64,9 +64,10 @@ amdgpu-$(CONFIG_DRM_AMDGPU_CIK)+= cik.o cik_ih.o kv_smc.o kv_dpm.o \
 
 amdgpu-$(CONFIG_DRM_AMDGPU_SI)+= si.o gmc_v6_0.o gfx_v6_0.o si_ih.o si_dma.o dce_v6_0.o si_dpm.o si_smc.o
 
-amdgpu-y += \
-	vi.o mxgpu_vi.o nbio_v6_1.o soc15.o emu_soc.o mxgpu_ai.o nbio_v7_0.o vega10_reg_init.o \
-	vega20_reg_init.o nbio_v7_4.o nbio_v2_3.o nv.o navi10_reg_init.o navi14_reg_init.o
+amdgpu-y += vi.o mxgpu_vi.o emu_soc.o nbio_v7_4.o
+
+amdgpu-$(CONFIG_DRM_AMDGPU_SOC15) += gmc_v9_0.o nbio_v6_1.o soc15.o mxgpu_ai.o nbio_v7_0.o \
+	vega10_reg_init.o vega20_reg_init.o nbio_v2_3.o nv.o navi10_reg_init.o navi14_reg_init.o
 
 # add DF block
 amdgpu-y += \
@@ -77,7 +78,10 @@ amdgpu-y += \
 amdgpu-y += \
 	gmc_v7_0.o \
 	gmc_v8_0.o \
-	gfxhub_v1_0.o mmhub_v1_0.o gmc_v9_0.o gfxhub_v1_1.o \
+	gfxhub_v1_0.o mmhub_v1_0.o gfxhub_v1_1.o
+
+amdgpu-$(CONFIG_DRM_AMDGPU_SOC15) += \
+	gmc_v9_0.o \
 	gfxhub_v2_0.o mmhub_v2_0.o gmc_v10_0.o
 
 # add IH block
@@ -86,7 +90,9 @@ amdgpu-y += \
 	amdgpu_ih.o \
 	iceland_ih.o \
 	tonga_ih.o \
-	cz_ih.o \
+	cz_ih.o
+
+amdgpu-$(CONFIG_DRM_AMDGPU_SOC15) += \
 	vega10_ih.o \
 	navi10_ih.o
 
@@ -111,7 +117,9 @@ amdgpu-y += \
 amdgpu-y += \
 	amdgpu_gfx.o \
 	amdgpu_rlc.o \
-	gfx_v8_0.o \
+	gfx_v8_0.o
+
+amdgpu-$(CONFIG_DRM_AMDGPU_SOC15) += \
 	gfx_v9_0.o \
 	gfx_v10_0.o
 
@@ -119,12 +127,14 @@ amdgpu-y += \
 amdgpu-y += \
 	amdgpu_sdma.o \
 	sdma_v2_4.o \
-	sdma_v3_0.o \
+	sdma_v3_0.o
+
+amdgpu-$(CONFIG_DRM_AMDGPU_SOC15) += \
 	sdma_v4_0.o \
 	sdma_v5_0.o
 
 # add MES block
-amdgpu-y += \
+amdgpu-$(CONFIG_DRM_AMDGPU_SOC15) += \
 	mes_v10_1.o
 
 # add UVD block
@@ -161,8 +171,10 @@ amdgpu-y += \
 	 amdgpu_amdkfd_fence.o \
 	 amdgpu_amdkfd_gpuvm.o \
 	 amdgpu_amdkfd_gfx_v8.o \
-	 amdgpu_amdkfd_gfx_v9.o \
-	 amdgpu_amdkfd_gfx_v10.o
+
+amdgpu-$(CONFIG_DRM_AMDGPU_SOC15) += \
+	amdgpu_amdkfd_gfx_v9.o \
+	amdgpu_amdkfd_gfx_v10.o
 
 ifneq ($(CONFIG_DRM_AMDGPU_CIK),)
 amdgpu-y += amdgpu_amdkfd_gfx_v7.o
diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_amdkfd.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_amdkfd.c
index 9fa4f25a3745..101d806ff996 100644
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_amdkfd.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_amdkfd.c
@@ -81,6 +81,7 @@ void amdgpu_amdkfd_device_probe(struct amdgpu_device *adev)
 	case CHIP_VEGAM:
 		kfd2kgd = amdgpu_amdkfd_gfx_8_0_get_functions();
 		break;
+#ifdef CONFIG_DRM_AMDGPU_SOC15
 	case CHIP_VEGA10:
 	case CHIP_VEGA12:
 	case CHIP_VEGA20:
@@ -90,6 +91,7 @@ void amdgpu_amdkfd_device_probe(struct amdgpu_device *adev)
 	case CHIP_NAVI10:
 		kfd2kgd = amdgpu_amdkfd_gfx_10_0_get_functions();
 		break;
+#endif
 	default:
 		dev_info(adev-&gt;dev, &quot;kfd not supported on this ASIC\n&quot;);
 		return;
diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c
index a02ccce7bf53..2a6447febcb0 100644
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c
@@ -1530,6 +1530,7 @@ static int amdgpu_device_ip_early_init(struct amdgpu_device *adev)
 			return r;
 		break;
 #endif
+#ifdef CONFIG_DRM_AMDGPU_SOC15
 	case CHIP_VEGA10:
 	case CHIP_VEGA12:
 	case CHIP_VEGA20:
@@ -1551,6 +1552,7 @@ static int amdgpu_device_ip_early_init(struct amdgpu_device *adev)
 		if (r)
 			return r;
 		break;
+#endif
 	default:
 		/* FIXME: not supported yet */
 		return -EINVAL;
-- 
2.20.0

_______________________________________________
amd-gfx mailing list
amd-gfx@xxxxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://lists.freedesktop.org/mailman/listinfo/amd-gfx">https://lists.freedesktop.org/mailman/listinfo/amd-gfx</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="35615" href="msg35615.html">Re: [PATCH 2/2] amdgpu: make SOC15/navi support conditional</a></strong>
<ul><li><em>From:</em> Alex Deucher</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="35613" href="msg35613.html">[PATCH 1/2] amdgpu: make pmu support optional</a></strong>
<ul><li><em>From:</em> Arnd Bergmann</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg35613.html">[PATCH 1/2] amdgpu: make pmu support optional</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg35615.html">Re: [PATCH 2/2] amdgpu: make SOC15/navi support conditional</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg35613.html">[PATCH 1/2] amdgpu: make pmu support optional</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg35615.html">Re: [PATCH 2/2] amdgpu: make SOC15/navi support conditional</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#35614"><strong>Date</strong></a></li>
<li><a href="index.html#35614"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

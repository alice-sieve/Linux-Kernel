<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH 65/87] drm/amd/display: init res_pool dccg_ref, dchub_ref with xtalin_freq -->
<!--X-From-R13: &#60;fhacrat.yvNnzq.pbz> -->
<!--X-Date: Mon, 15 Jul 2019 14:22:05 &#45;0700 -->
<!--X-Message-Id: 20190715212049.4584&#45;66&#45;sunpeng.li@amd.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190715212049.4584&#45;1&#45;sunpeng.li@amd.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="AMD GFX: [PATCH 65/87] drm/amd/display: init res_pool dccg_ref, dchub_ref with xtalin_freq">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[PATCH 65/87] drm/amd/display: init res_pool dccg_ref, dchub_ref with xtalin_freq &mdash; Linux AMD GFX</title>
<link rel="alternate" type="application/rss+xml" title="Linux AMD GFX" href="//feeds.feedburner.com/LinuxAmdGraphics">
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en" async defer></script>
<h1 itemprop="name">[PATCH 65/87] drm/amd/display: init res_pool dccg_ref, dchub_ref with xtalin_freq</h1>
[<a href="msg35916.html">Date Prev</a>][<a href="msg35918.html">Date Next</a>][<a href="msg35916.html">Thread Prev</a>][<a href="msg35918.html">Thread Next</a>][<a href="maillist.html#35917">Date Index</a>][<a href="index.html#35917">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: &lt;amd-gfx@xxxxxxxxxxxxxxxxxxxxx&gt;</li>
<li><em>Subject</em>: [PATCH 65/87] drm/amd/display: init res_pool dccg_ref, dchub_ref with xtalin_freq</li>
<li><em>From</em>: &lt;sunpeng.li@xxxxxxx&gt;</li>
<li><em>Date</em>: Mon, 15 Jul 2019 17:20:27 -0400</li>
<li><em>Cc</em>: Leo Li &lt;sunpeng.li@xxxxxxx&gt;, Jun Lei &lt;Jun.Lei@xxxxxxx&gt;,        hersen wu &lt;hersenxs.wu@xxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg35850.html">20190715212049.4584-1-sunpeng.li@amd.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg35850.html">20190715212049.4584-1-sunpeng.li@amd.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>From: hersen wu &lt;hersenxs.wu@xxxxxxx&gt;

[WHY] dc sw clock implementation of navi10 and raven are not exact the
same. dcccg, dchub reference clock initialization is done after dc calls
vbios dispcontroller_init table. for raven family, before
dispcontroller_init is called by dc, the ref clk values are referred
by sw clock implementation and program asic register using wrong
values. this causes dchub pstate error. This need provide valid ref
clk values. for navi10, since dispcontroller_init is not called,
dchubbub_global_timer_enable = 0, hubbub2_get_dchub_ref_freq will
hit aeert. this need remove hubbub2_get_dchub_ref_freq from this
location and move to dcn20_init_hw.

[HOW] for all asic, initialize dccg, dchub ref clk with data from
vbios firmware table by default. for raven asic family, use these data
from vbios, for asic which support sw dccg component, like navi10,
read ref clk by sw dccg functions and update the ref clk.

Signed-off-by: hersen wu &lt;hersenxs.wu@xxxxxxx&gt;
Reviewed-by: Jun Lei &lt;Jun.Lei@xxxxxxx&gt;
Acked-by: Leo Li &lt;sunpeng.li@xxxxxxx&gt;
---
 .../gpu/drm/amd/display/dc/core/dc_resource.c | 42 +++++++------------
 .../drm/amd/display/dc/dcn20/dcn20_hwseq.c    | 25 +++++++++++
 2 files changed, 41 insertions(+), 26 deletions(-)

diff --git a/drivers/gpu/drm/amd/display/dc/core/dc_resource.c b/drivers/gpu/drm/amd/display/dc/core/dc_resource.c
index 5e7b8b2dd178..b567b2159f1a 100644
--- a/drivers/gpu/drm/amd/display/dc/core/dc_resource.c
+++ b/drivers/gpu/drm/amd/display/dc/core/dc_resource.c
@@ -172,32 +172,22 @@ struct resource_pool *dc_create_resource_pool(struct dc  *dc,
 	if (res_pool != NULL) {
 		struct dc_firmware_info fw_info = { { 0 } };
 
-		if (dc-&gt;ctx-&gt;dc_bios-&gt;funcs-&gt;get_firmware_info(
-				dc-&gt;ctx-&gt;dc_bios, &amp;fw_info) == BP_RESULT_OK) {
-				res_pool-&gt;ref_clocks.xtalin_clock_inKhz = fw_info.pll_info.crystal_frequency;
-
-				if (IS_FPGA_MAXIMUS_DC(dc-&gt;ctx-&gt;dce_environment)) {
-					// On FPGA these dividers are currently not configured by GDB
-					res_pool-&gt;ref_clocks.dccg_ref_clock_inKhz = res_pool-&gt;ref_clocks.xtalin_clock_inKhz;
-					res_pool-&gt;ref_clocks.dchub_ref_clock_inKhz = res_pool-&gt;ref_clocks.xtalin_clock_inKhz;
-				} else if (res_pool-&gt;dccg &amp;&amp; res_pool-&gt;hubbub) {
-					// If DCCG reference frequency cannot be determined (usually means not set to xtalin) then this is a critical error
-					// as this value must be known for DCHUB programming
-					(res_pool-&gt;dccg-&gt;funcs-&gt;get_dccg_ref_freq)(res_pool-&gt;dccg,
-							fw_info.pll_info.crystal_frequency,
-							&amp;res_pool-&gt;ref_clocks.dccg_ref_clock_inKhz);
-
-					// Similarly, if DCHUB reference frequency cannot be determined, then it is also a critical error
-					(res_pool-&gt;hubbub-&gt;funcs-&gt;get_dchub_ref_freq)(res_pool-&gt;hubbub,
-							res_pool-&gt;ref_clocks.dccg_ref_clock_inKhz,
-							&amp;res_pool-&gt;ref_clocks.dchub_ref_clock_inKhz);
-				} else {
-					// Not all ASICs have DCCG sw component
-					res_pool-&gt;ref_clocks.dccg_ref_clock_inKhz = res_pool-&gt;ref_clocks.xtalin_clock_inKhz;
-					res_pool-&gt;ref_clocks.dchub_ref_clock_inKhz = res_pool-&gt;ref_clocks.xtalin_clock_inKhz;
-				}
-			} else
-				ASSERT_CRITICAL(false);
+		if (dc-&gt;ctx-&gt;dc_bios-&gt;funcs-&gt;get_firmware_info(dc-&gt;ctx-&gt;dc_bios,
+				&amp;fw_info) == BP_RESULT_OK) {
+			res_pool-&gt;ref_clocks.xtalin_clock_inKhz =
+				fw_info.pll_info.crystal_frequency;
+			/* initialize with firmware data first, no all
+			 * ASIC have DCCG SW component. FPGA or
+			 * simulation need initialization of
+			 * dccg_ref_clock_inKhz, dchub_ref_clock_inKhz
+			 * with xtalin_clock_inKhz
+			 */
+			res_pool-&gt;ref_clocks.dccg_ref_clock_inKhz =
+				res_pool-&gt;ref_clocks.xtalin_clock_inKhz;
+			res_pool-&gt;ref_clocks.dchub_ref_clock_inKhz =
+				res_pool-&gt;ref_clocks.xtalin_clock_inKhz;
+		} else
+			ASSERT_CRITICAL(false);
 	}
 
 	return res_pool;
diff --git a/drivers/gpu/drm/amd/display/dc/dcn20/dcn20_hwseq.c b/drivers/gpu/drm/amd/display/dc/dcn20/dcn20_hwseq.c
index 531ad4468457..566cd4cdfef4 100644
--- a/drivers/gpu/drm/amd/display/dc/dcn20/dcn20_hwseq.c
+++ b/drivers/gpu/drm/amd/display/dc/dcn20/dcn20_hwseq.c
@@ -562,6 +562,7 @@ static void dcn20_init_hw(struct dc *dc)
 	struct dc_bios *dcb = dc-&gt;ctx-&gt;dc_bios;
 	struct resource_pool *res_pool = dc-&gt;res_pool;
 	struct dc_state  *context = dc-&gt;current_state;
+	struct dc_firmware_info fw_info = { { 0 } };
 
 	if (dc-&gt;clk_mgr &amp;&amp; dc-&gt;clk_mgr-&gt;funcs-&gt;init_clocks)
 		dc-&gt;clk_mgr-&gt;funcs-&gt;init_clocks(dc-&gt;clk_mgr);
@@ -585,6 +586,30 @@ static void dcn20_init_hw(struct dc *dc)
 	} else {
 		if (!dcb-&gt;funcs-&gt;is_accelerated_mode(dcb)) {
 			bios_golden_init(dc);
+			if (dc-&gt;ctx-&gt;dc_bios-&gt;funcs-&gt;get_firmware_info(
+					dc-&gt;ctx-&gt;dc_bios, &amp;fw_info) == BP_RESULT_OK) {
+				res_pool-&gt;ref_clocks.xtalin_clock_inKhz = fw_info.pll_info.crystal_frequency;
+
+				if (!IS_FPGA_MAXIMUS_DC(dc-&gt;ctx-&gt;dce_environment)) {
+					if (res_pool-&gt;dccg &amp;&amp; res_pool-&gt;hubbub) {
+
+						(res_pool-&gt;dccg-&gt;funcs-&gt;get_dccg_ref_freq)(res_pool-&gt;dccg,
+								fw_info.pll_info.crystal_frequency,
+								&amp;res_pool-&gt;ref_clocks.dccg_ref_clock_inKhz);
+
+						(res_pool-&gt;hubbub-&gt;funcs-&gt;get_dchub_ref_freq)(res_pool-&gt;hubbub,
+								res_pool-&gt;ref_clocks.dccg_ref_clock_inKhz,
+								&amp;res_pool-&gt;ref_clocks.dchub_ref_clock_inKhz);
+					} else {
+						// Not all ASICs have DCCG sw component
+						res_pool-&gt;ref_clocks.dccg_ref_clock_inKhz =
+								res_pool-&gt;ref_clocks.xtalin_clock_inKhz;
+						res_pool-&gt;ref_clocks.dchub_ref_clock_inKhz =
+								res_pool-&gt;ref_clocks.xtalin_clock_inKhz;
+					}
+				}
+			} else
+				ASSERT_CRITICAL(false);
 			disable_vga(dc-&gt;hwseq);
 		}
 
-- 
2.22.0

_______________________________________________
amd-gfx mailing list
amd-gfx@xxxxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://lists.freedesktop.org/mailman/listinfo/amd-gfx">https://lists.freedesktop.org/mailman/listinfo/amd-gfx</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="35850" href="msg35850.html">[PATCH 00/87] DC Patches 15 Jul, 2019</a></strong>
<ul><li><em>From:</em> sunpeng.li</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg35916.html">[PATCH 72/87] drm/amd/display: Fix dc_create failure handling and 666 color depths</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg35918.html">[PATCH 71/87] drm/amd/display: populate last calculated bb state with max clocks</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg35916.html">[PATCH 72/87] drm/amd/display: Fix dc_create failure handling and 666 color depths</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg35918.html">[PATCH 71/87] drm/amd/display: populate last calculated bb state with max clocks</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#35917"><strong>Date</strong></a></li>
<li><a href="index.html#35917"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

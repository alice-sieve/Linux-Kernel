<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH 75/87] drm/amd/display: Set enabled to false at start of audio disable -->
<!--X-From-R13: &#60;fhacrat.yvNnzq.pbz> -->
<!--X-Date: Mon, 15 Jul 2019 14:22:14 &#45;0700 -->
<!--X-Message-Id: 20190715212049.4584&#45;76&#45;sunpeng.li@amd.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190715212049.4584&#45;1&#45;sunpeng.li@amd.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="AMD GFX: [PATCH 75/87] drm/amd/display: Set enabled to false at start of audio disable">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[PATCH 75/87] drm/amd/display: Set enabled to false at start of audio disable &mdash; Linux AMD GFX</title>
<link rel="alternate" type="application/rss+xml" title="Linux AMD GFX" href="//feeds.feedburner.com/LinuxAmdGraphics">
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en" async defer></script>
<h1 itemprop="name">[PATCH 75/87] drm/amd/display: Set enabled to false at start of audio disable</h1>
[<a href="msg35928.html">Date Prev</a>][<a href="msg35930.html">Date Next</a>][<a href="msg35928.html">Thread Prev</a>][<a href="msg35930.html">Thread Next</a>][<a href="maillist.html#35929">Date Index</a>][<a href="index.html#35929">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: &lt;amd-gfx@xxxxxxxxxxxxxxxxxxxxx&gt;</li>
<li><em>Subject</em>: [PATCH 75/87] drm/amd/display: Set enabled to false at start of audio disable</li>
<li><em>From</em>: &lt;sunpeng.li@xxxxxxx&gt;</li>
<li><em>Date</em>: Mon, 15 Jul 2019 17:20:37 -0400</li>
<li><em>Cc</em>: Leo Li &lt;sunpeng.li@xxxxxxx&gt;, Zhan Liu &lt;Zhan.Liu@xxxxxxx&gt;,        Nicholas Kazlauskas &lt;nicholas.kazlauskas@xxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg35850.html">20190715212049.4584-1-sunpeng.li@amd.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg35850.html">20190715212049.4584-1-sunpeng.li@amd.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>From: Nicholas Kazlauskas &lt;nicholas.kazlauskas@xxxxxxx&gt;

[Why]
In an effort to stop redundant calls to dce110_disable_audio_stream
the audio-&gt;enabled flag was added to the audio resource struct. While
this state probably shouldn't have been tracked on the audio struct
itself it still works fine for some sequences.

However, it does not work for cases where we're freeing the audio
resource (such as hotplugs) or when dynamic audio is enabled.

In these cases the pipe_ctx-&gt;stream_res.audio = NULL before we can
set audio-&gt;enabled = false. The next time we acquire the audio resource
such as on hotplug the audio will not be enabled for the stream since
DC thinks it's still enabled.

Audio state tracking should cover this sequence.

[How]
Set audio-&gt;enabled = false at the start as long as we have
pipe_ctx-&gt;stream_res.audio.

Signed-off-by: Nicholas Kazlauskas &lt;nicholas.kazlauskas@xxxxxxx&gt;
Reviewed-by: Zhan Liu &lt;Zhan.Liu@xxxxxxx&gt;
Acked-by: Leo Li &lt;sunpeng.li@xxxxxxx&gt;
---
 drivers/gpu/drm/amd/display/dc/dce110/dce110_hw_sequencer.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/amd/display/dc/dce110/dce110_hw_sequencer.c b/drivers/gpu/drm/amd/display/dc/dce110/dce110_hw_sequencer.c
index b8ef57a24228..46dfab749679 100644
--- a/drivers/gpu/drm/amd/display/dc/dce110/dce110_hw_sequencer.c
+++ b/drivers/gpu/drm/amd/display/dc/dce110/dce110_hw_sequencer.c
@@ -996,6 +996,8 @@ void dce110_disable_audio_stream(struct pipe_ctx *pipe_ctx, int option)
 	pipe_ctx-&gt;stream_res.stream_enc-&gt;funcs-&gt;audio_mute_control(
 			pipe_ctx-&gt;stream_res.stream_enc, true);
 	if (pipe_ctx-&gt;stream_res.audio) {
+		pipe_ctx-&gt;stream_res.audio-&gt;enabled = false;
+
 		if (dc-&gt;res_pool-&gt;pp_smu)
 			pp_smu = dc-&gt;res_pool-&gt;pp_smu;
 
@@ -1026,8 +1028,6 @@ void dce110_disable_audio_stream(struct pipe_ctx *pipe_ctx, int option)
 		/* dal_audio_disable_azalia_audio_jack_presence(stream-&gt;audio,
 		 * stream-&gt;stream_engine_id);
 		 */
-		if (pipe_ctx-&gt;stream_res.audio)
-			pipe_ctx-&gt;stream_res.audio-&gt;enabled = false;
 	}
 }
 
-- 
2.22.0

_______________________________________________
amd-gfx mailing list
amd-gfx@xxxxxxxxxxxxxxxxxxxxx
<a  rel="nofollow" href="https://lists.freedesktop.org/mailman/listinfo/amd-gfx">https://lists.freedesktop.org/mailman/listinfo/amd-gfx</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="35850" href="msg35850.html">[PATCH 00/87] DC Patches 15 Jul, 2019</a></strong>
<ul><li><em>From:</em> sunpeng.li</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg35928.html">[PATCH 74/87] drm/amd/display: Clean up dynamic metadata logic</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg35930.html">[PATCH 82/87] drm/amd/display: Add SMU version field to clk_mgr_internal</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg35928.html">[PATCH 74/87] drm/amd/display: Clean up dynamic metadata logic</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg35930.html">[PATCH 82/87] drm/amd/display: Add SMU version field to clk_mgr_internal</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#35929"><strong>Date</strong></a></li>
<li><a href="index.html#35929"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

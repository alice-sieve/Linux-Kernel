<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH bpf] xdp: fix race on generic receive path -->
<!--X-From-R13: [ntahf Yneyffba &#60;zntahf.xneyffbaNtznvy.pbz> -->
<!--X-Date: Tue, 2 Jul 2019 08:01:43 &#45;0700 -->
<!--X-Message-Id: CAJ8uoz34wS&#45;Ut=TiULN32Zs&#45;terBkzSiEws65jsd=f4S_rp43Q@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: CGME20190702143639eucas1p2b168c68c35b70aac75cad6c72ccc81ad@eucas1p2.samsung.com -->
<!--X-Reference: 20190702143634.19688&#45;1&#45;i.maximets@samsung.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="BPF: Re: [PATCH bpf] xdp: fix race on generic receive path">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH bpf] xdp: fix race on generic receive path &mdash; BPF</title>
<link rel="alternate" type="application/rss+xml" title="BPF" href="//feeds.feedburner.com/packetfilters">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH bpf] xdp: fix race on generic receive path</h1>
[<a href="msg04826.html">Date Prev</a>][<a href="msg04828.html">Date Next</a>][<a href="msg04826.html">Thread Prev</a>][<a href="msg04836.html">Thread Next</a>][<a href="maillist.html#04827">Date Index</a>][<a href="index.html#04827">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH bpf] xdp: fix race on generic receive path</li>
<li><em>From</em>: Magnus Karlsson &lt;magnus.karlsson@xxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 2 Jul 2019 17:01:30 +0200</li>
<li><em>Cc</em>: Network Development &lt;netdev@xxxxxxxxxxxxxxx&gt;,        linux-kernel@xxxxxxxxxxxxxxx, bpf &lt;bpf@xxxxxxxxxxxxxxx&gt;,        xdp-newbies@xxxxxxxxxxxxxxx, &quot;David S. Miller&quot; &lt;davem@xxxxxxxxxxxxx&gt;,        Bj&#xF6;rn T&#xF6;pel &lt;bjorn.topel@xxxxxxxxx&gt;,        Magnus Karlsson &lt;magnus.karlsson@xxxxxxxxx&gt;,        Jonathan Lemon &lt;jonathan.lemon@xxxxxxxxx&gt;,        Jakub Kicinski &lt;jakub.kicinski@xxxxxxxxxxxxx&gt;,        Alexei Starovoitov &lt;ast@xxxxxxxxxx&gt;,        Daniel Borkmann &lt;daniel@xxxxxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg04826.html">20190702143634.19688-1-i.maximets@samsung.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Tue, Jul 2, 2019 at 4:36 PM Ilya Maximets &lt;i.maximets@xxxxxxxxxxx&gt; wrote:
&gt;<i></i>
&gt;<i> Unlike driver mode, generic xdp receive could be triggered</i>
&gt;<i> by different threads on different CPU cores at the same time</i>
&gt;<i> leading to the fill and rx queue breakage. For example, this</i>
&gt;<i> could happen while sending packets from two processes to the</i>
&gt;<i> first interface of veth pair while the second part of it is</i>
&gt;<i> open with AF_XDP socket.</i>
&gt;<i></i>
&gt;<i> Need to take a lock for each generic receive to avoid race.</i>

Thanks for this catch Ilya. Do you have any performance numbers you
could share of the impact of adding this spin lock? The reason I ask
is that if the impact is negligible, then let us just add it. But if
it is too large, we might want to brain storm about some other
possible solutions.

Thanks: Magnus

&gt;<i> Fixes: c497176cb2e4 (&quot;xsk: add Rx receive functions and poll support&quot;)</i>
&gt;<i> Signed-off-by: Ilya Maximets &lt;i.maximets@xxxxxxxxxxx&gt;</i>
&gt;<i> ---</i>
&gt;<i>  include/net/xdp_sock.h |  2 ++</i>
&gt;<i>  net/xdp/xsk.c          | 32 +++++++++++++++++++++++---------</i>
&gt;<i>  2 files changed, 25 insertions(+), 9 deletions(-)</i>
&gt;<i></i>
&gt;<i> diff --git a/include/net/xdp_sock.h b/include/net/xdp_sock.h</i>
&gt;<i> index d074b6d60f8a..ac3c047d058c 100644</i>
&gt;<i> --- a/include/net/xdp_sock.h</i>
&gt;<i> +++ b/include/net/xdp_sock.h</i>
&gt;<i> @@ -67,6 +67,8 @@ struct xdp_sock {</i>
&gt;<i>          * in the SKB destructor callback.</i>
&gt;<i>          */</i>
&gt;<i>         spinlock_t tx_completion_lock;</i>
&gt;<i> +       /* Protects generic receive. */</i>
&gt;<i> +       spinlock_t rx_lock;</i>
&gt;<i>         u64 rx_dropped;</i>
&gt;<i>  };</i>
&gt;<i></i>
&gt;<i> diff --git a/net/xdp/xsk.c b/net/xdp/xsk.c</i>
&gt;<i> index a14e8864e4fa..19f41d2b670c 100644</i>
&gt;<i> --- a/net/xdp/xsk.c</i>
&gt;<i> +++ b/net/xdp/xsk.c</i>
&gt;<i> @@ -119,17 +119,22 @@ int xsk_generic_rcv(struct xdp_sock *xs, struct xdp_buff *xdp)</i>
&gt;<i>  {</i>
&gt;<i>         u32 metalen = xdp-&gt;data - xdp-&gt;data_meta;</i>
&gt;<i>         u32 len = xdp-&gt;data_end - xdp-&gt;data;</i>
&gt;<i> +       unsigned long flags;</i>
&gt;<i>         void *buffer;</i>
&gt;<i>         u64 addr;</i>
&gt;<i>         int err;</i>
&gt;<i></i>
&gt;<i> -       if (xs-&gt;dev != xdp-&gt;rxq-&gt;dev || xs-&gt;queue_id != xdp-&gt;rxq-&gt;queue_index)</i>
&gt;<i> -               return -EINVAL;</i>
&gt;<i> +       spin_lock_irqsave(&amp;xs-&gt;rx_lock, flags);</i>
&gt;<i> +</i>
&gt;<i> +       if (xs-&gt;dev != xdp-&gt;rxq-&gt;dev || xs-&gt;queue_id != xdp-&gt;rxq-&gt;queue_index) {</i>
&gt;<i> +               err = -EINVAL;</i>
&gt;<i> +               goto out_unlock;</i>
&gt;<i> +       }</i>
&gt;<i></i>
&gt;<i>         if (!xskq_peek_addr(xs-&gt;umem-&gt;fq, &amp;addr) ||</i>
&gt;<i>             len &gt; xs-&gt;umem-&gt;chunk_size_nohr - XDP_PACKET_HEADROOM) {</i>
&gt;<i> -               xs-&gt;rx_dropped++;</i>
&gt;<i> -               return -ENOSPC;</i>
&gt;<i> +               err = -ENOSPC;</i>
&gt;<i> +               goto out_drop;</i>
&gt;<i>         }</i>
&gt;<i></i>
&gt;<i>         addr += xs-&gt;umem-&gt;headroom;</i>
&gt;<i> @@ -138,13 +143,21 @@ int xsk_generic_rcv(struct xdp_sock *xs, struct xdp_buff *xdp)</i>
&gt;<i>         memcpy(buffer, xdp-&gt;data_meta, len + metalen);</i>
&gt;<i>         addr += metalen;</i>
&gt;<i>         err = xskq_produce_batch_desc(xs-&gt;rx, addr, len);</i>
&gt;<i> -       if (!err) {</i>
&gt;<i> -               xskq_discard_addr(xs-&gt;umem-&gt;fq);</i>
&gt;<i> -               xsk_flush(xs);</i>
&gt;<i> -               return 0;</i>
&gt;<i> -       }</i>
&gt;<i> +       if (err)</i>
&gt;<i> +               goto out_drop;</i>
&gt;<i> +</i>
&gt;<i> +       xskq_discard_addr(xs-&gt;umem-&gt;fq);</i>
&gt;<i> +       xskq_produce_flush_desc(xs-&gt;rx);</i>
&gt;<i></i>
&gt;<i> +       spin_unlock_irqrestore(&amp;xs-&gt;rx_lock, flags);</i>
&gt;<i> +</i>
&gt;<i> +       xs-&gt;sk.sk_data_ready(&amp;xs-&gt;sk);</i>
&gt;<i> +       return 0;</i>
&gt;<i> +</i>
&gt;<i> +out_drop:</i>
&gt;<i>         xs-&gt;rx_dropped++;</i>
&gt;<i> +out_unlock:</i>
&gt;<i> +       spin_unlock_irqrestore(&amp;xs-&gt;rx_lock, flags);</i>
&gt;<i>         return err;</i>
&gt;<i>  }</i>
&gt;<i></i>
&gt;<i> @@ -765,6 +778,7 @@ static int xsk_create(struct net *net, struct socket *sock, int protocol,</i>
&gt;<i></i>
&gt;<i>         xs = xdp_sk(sk);</i>
&gt;<i>         mutex_init(&amp;xs-&gt;mutex);</i>
&gt;<i> +       spin_lock_init(&amp;xs-&gt;rx_lock);</i>
&gt;<i>         spin_lock_init(&amp;xs-&gt;tx_completion_lock);</i>
&gt;<i></i>
&gt;<i>         mutex_lock(&amp;net-&gt;xdp.lock);</i>
&gt;<i> --</i>
&gt;<i> 2.17.1</i>
&gt;<i></i>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="04836" href="msg04836.html">Re: [PATCH bpf] xdp: fix race on generic receive path</a></strong>
<ul><li><em>From:</em> Ilya Maximets</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="04826" href="msg04826.html">[PATCH bpf] xdp: fix race on generic receive path</a></strong>
<ul><li><em>From:</em> Ilya Maximets</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg04826.html">[PATCH bpf] xdp: fix race on generic receive path</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg04828.html">Re: [PATCH bpf-next] libbpf: fix GCC8 warning for strncpy</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg04826.html">[PATCH bpf] xdp: fix race on generic receive path</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg04836.html">Re: [PATCH bpf] xdp: fix race on generic receive path</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#04827"><strong>Date</strong></a></li>
<li><a href="index.html#04827"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;Samsung&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-rockchip/>[Linux&nbsp;Rockchip&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-actions/>[Linux&nbsp;Actions&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-snps-arc/>[Linux&nbsp;for&nbsp;Synopsys&nbsp;ARC&nbsp;Processors]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nfs/>[Linux&nbsp;NFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nilfs/>[Linux&nbsp;NILFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/vfl/>[Video&nbsp;for&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<p>
<hr>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH AUTOSEL 5.2 231/249] tools: bpftool: Fix json dump crash on powerpc -->
<!--X-From-R13: Enfun Zriva &#60;fnfunyNxreary.bet> -->
<!--X-Date: Mon, 15 Jul 2019 07:01:54 &#45;0700 -->
<!--X-Message-Id: 20190715134655.4076&#45;231&#45;sashal@kernel.org -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190715134655.4076&#45;1&#45;sashal@kernel.org -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="BPF: [PATCH AUTOSEL 5.2 231/249] tools: bpftool: Fix json dump crash on powerpc">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[PATCH AUTOSEL 5.2 231/249] tools: bpftool: Fix json dump crash on powerpc &mdash; BPF</title>
<link rel="alternate" type="application/rss+xml" title="BPF" href="//feeds.feedburner.com/packetfilters">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH AUTOSEL 5.2 231/249] tools: bpftool: Fix json dump crash on powerpc</h1>
[<a href="msg05339.html">Date Prev</a>][<a href="msg05341.html">Date Next</a>][<a href="msg05339.html">Thread Prev</a>][<a href="msg05341.html">Thread Next</a>][<a href="maillist.html#05340">Date Index</a>][<a href="index.html#05340">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH AUTOSEL 5.2 231/249] tools: bpftool: Fix json dump crash on powerpc</li>
<li><em>From</em>: Sasha Levin &lt;sashal@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Mon, 15 Jul 2019 09:46:36 -0400</li>
<li><em>Cc</em>: Jiri Olsa &lt;jolsa@xxxxxxxxxx&gt;, Michael Petlan &lt;mpetlan@xxxxxxxxxx&gt;,        Jiri Olsa &lt;jolsa@xxxxxxxxxx&gt;,        Quentin Monnet &lt;quentin.monnet@xxxxxxxxxxxxx&gt;,        Jakub Kicinski &lt;jakub.kicinski@xxxxxxxxxxxxx&gt;,        Daniel Borkmann &lt;daniel@xxxxxxxxxxxxx&gt;,        Sasha Levin &lt;sashal@xxxxxxxxxx&gt;, netdev@xxxxxxxxxxxxxxx,        bpf@xxxxxxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;20190715134655.4076-1-sashal@kernel.org&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>From: Jiri Olsa &lt;jolsa@xxxxxxxxxx&gt;

[ Upstream commit aa52bcbe0e72fac36b1862db08b9c09c4caefae3 ]

Michael reported crash with by bpf program in json mode on powerpc:

  # bpftool prog -p dump jited id 14
  [{
        &quot;name&quot;: &quot;0xd00000000a9aa760&quot;,
        &quot;insns&quot;: [{
                &quot;pc&quot;: &quot;0x0&quot;,
                &quot;operation&quot;: &quot;nop&quot;,
                &quot;operands&quot;: [null
                ]
            },{
                &quot;pc&quot;: &quot;0x4&quot;,
                &quot;operation&quot;: &quot;nop&quot;,
                &quot;operands&quot;: [null
                ]
            },{
                &quot;pc&quot;: &quot;0x8&quot;,
                &quot;operation&quot;: &quot;mflr&quot;,
  Segmentation fault (core dumped)

The code is assuming char pointers in format, which is not always
true at least for powerpc. Fixing this by dumping the whole string
into buffer based on its format.

Please note that libopcodes code does not check return values from
fprintf callback, but as per Jakub suggestion returning -1 on allocation
failure so we do the best effort to propagate the error.

Fixes: 107f041212c1 (&quot;tools: bpftool: add JSON output for `bpftool prog dump jited *` command&quot;)
Reported-by: Michael Petlan &lt;mpetlan@xxxxxxxxxx&gt;
Signed-off-by: Jiri Olsa &lt;jolsa@xxxxxxxxxx&gt;
Reviewed-by: Quentin Monnet &lt;quentin.monnet@xxxxxxxxxxxxx&gt;
Reviewed-by: Jakub Kicinski &lt;jakub.kicinski@xxxxxxxxxxxxx&gt;
Signed-off-by: Daniel Borkmann &lt;daniel@xxxxxxxxxxxxx&gt;
Signed-off-by: Sasha Levin &lt;sashal@xxxxxxxxxx&gt;
---
 tools/bpf/bpftool/jit_disasm.c | 11 +++++++----
 1 file changed, 7 insertions(+), 4 deletions(-)

diff --git a/tools/bpf/bpftool/jit_disasm.c b/tools/bpf/bpftool/jit_disasm.c
index 3ef3093560ba..bfed711258ce 100644
--- a/tools/bpf/bpftool/jit_disasm.c
+++ b/tools/bpf/bpftool/jit_disasm.c
@@ -11,6 +11,8 @@
  * Licensed under the GNU General Public License, version 2.0 (GPLv2)
  */
 
+#define _GNU_SOURCE
+#include &lt;stdio.h&gt;
 #include &lt;stdarg.h&gt;
 #include &lt;stdint.h&gt;
 #include &lt;stdio.h&gt;
@@ -44,11 +46,13 @@ static int fprintf_json(void *out, const char *fmt, ...)
 	char *s;
 
 	va_start(ap, fmt);
+	if (vasprintf(&amp;s, fmt, ap) &lt; 0)
+		return -1;
+	va_end(ap);
+
 	if (!oper_count) {
 		int i;
 
-		s = va_arg(ap, char *);
-
 		/* Strip trailing spaces */
 		i = strlen(s) - 1;
 		while (s[i] == ' ')
@@ -61,11 +65,10 @@ static int fprintf_json(void *out, const char *fmt, ...)
 	} else if (!strcmp(fmt, &quot;,&quot;)) {
 		   /* Skip */
 	} else {
-		s = va_arg(ap, char *);
 		jsonw_string(json_wtr, s);
 		oper_count++;
 	}
-	va_end(ap);
+	free(s);
 	return 0;
 }
 
-- 
2.20.1



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg05339.html">[PATCH AUTOSEL 5.2 225/249] bpf, libbpf, smatch: Fix potential NULL pointer dereference</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg05341.html">[PATCH AUTOSEL 5.2 226/249] selftests: bpf: fix inlines in test_lwt_seg6local</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg05339.html">[PATCH AUTOSEL 5.2 225/249] bpf, libbpf, smatch: Fix potential NULL pointer dereference</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg05341.html">[PATCH AUTOSEL 5.2 226/249] selftests: bpf: fix inlines in test_lwt_seg6local</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#05340"><strong>Date</strong></a></li>
<li><a href="index.html#05340"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;Samsung&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-rockchip/>[Linux&nbsp;Rockchip&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-actions/>[Linux&nbsp;Actions&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-snps-arc/>[Linux&nbsp;for&nbsp;Synopsys&nbsp;ARC&nbsp;Processors]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nfs/>[Linux&nbsp;NFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nilfs/>[Linux&nbsp;NILFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/vfl/>[Video&nbsp;for&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<p>
<hr>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH bpf&#45;next v2 2/6] xsk: add support for need_wakeup flag in AF_XDP rings -->
<!--X-From-R13: [nkvz [vxvglnafxvl &#60;znkvzzvNzryynabk.pbz> -->
<!--X-Date: Tue, 2 Jul 2019 06:47:03 &#45;0700 -->
<!--X-Message-Id: d4318783&#45;18a4&#45;d5c1&#45;1044&#45;691aaebb2b0a@mellanox.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 1562059288&#45;26773&#45;1&#45;git&#45;send&#45;email&#45;magnus.karlsson@intel.com -->
<!--X-Reference: 1562059288&#45;26773&#45;3&#45;git&#45;send&#45;email&#45;magnus.karlsson@intel.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="BPF: Re: [PATCH bpf-next v2 2/6] xsk: add support for need_wakeup flag in AF_XDP rings">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH bpf-next v2 2/6] xsk: add support for need_wakeup flag in AF_XDP rings &mdash; BPF</title>
<link rel="alternate" type="application/rss+xml" title="BPF" href="//feeds.feedburner.com/packetfilters">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH bpf-next v2 2/6] xsk: add support for need_wakeup flag in AF_XDP rings</h1>
[<a href="msg04823.html">Date Prev</a>][<a href="msg04825.html">Date Next</a>][<a href="msg04815.html">Thread Prev</a>][<a href="msg04825.html">Thread Next</a>][<a href="maillist.html#04824">Date Index</a>][<a href="index.html#04824">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH bpf-next v2 2/6] xsk: add support for need_wakeup flag in AF_XDP rings</li>
<li><em>From</em>: Maxim Mikityanskiy &lt;maximmi@xxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 2 Jul 2019 13:46:18 +0000</li>
<li><em>Accept-language</em>: en-US</li>
<li><em>Cc</em>: &quot;bjorn.topel@xxxxxxxxx&quot; &lt;bjorn.topel@xxxxxxxxx&gt;,        &quot;daniel@xxxxxxxxxxxxx&quot; &lt;daniel@xxxxxxxxxxxxx&gt;,        &quot;netdev@xxxxxxxxxxxxxxx&quot; &lt;netdev@xxxxxxxxxxxxxxx&gt;,        &quot;brouer@xxxxxxxxxx&quot; &lt;brouer@xxxxxxxxxx&gt;,        &quot;bpf@xxxxxxxxxxxxxxx&quot; &lt;bpf@xxxxxxxxxxxxxxx&gt;,        &quot;bruce.richardson@xxxxxxxxx&quot; &lt;bruce.richardson@xxxxxxxxx&gt;,        &quot;ciara.loftus@xxxxxxxxx&quot; &lt;ciara.loftus@xxxxxxxxx&gt;,        &quot;jakub.kicinski@xxxxxxxxxxxxx&quot; &lt;jakub.kicinski@xxxxxxxxxxxxx&gt;,        &quot;xiaolong.ye@xxxxxxxxx&quot; &lt;xiaolong.ye@xxxxxxxxx&gt;,        &quot;qi.z.zhang@xxxxxxxxx&quot; &lt;qi.z.zhang@xxxxxxxxx&gt;,        &quot;sridhar.samudrala@xxxxxxxxx&quot; &lt;sridhar.samudrala@xxxxxxxxx&gt;,        &quot;kevin.laatz@xxxxxxxxx&quot; &lt;kevin.laatz@xxxxxxxxx&gt;,        &quot;ilias.apalodimas@xxxxxxxxxx&quot; &lt;ilias.apalodimas@xxxxxxxxxx&gt;,        &quot;kiran.patil@xxxxxxxxx&quot; &lt;kiran.patil@xxxxxxxxx&gt;,        &quot;axboe@xxxxxxxxx&quot; &lt;axboe@xxxxxxxxx&gt;,        &quot;maciej.fijalkowski@xxxxxxxxx&quot; &lt;maciej.fijalkowski@xxxxxxxxx&gt;,        &quot;maciejromanfijalkowski@xxxxxxxxx&quot; &lt;maciejromanfijalkowski@xxxxxxxxx&gt;,        &quot;intel-wired-lan@xxxxxxxxxxxxxxxx&quot; &lt;intel-wired-lan@xxxxxxxxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg04815.html">1562059288-26773-3-git-send-email-magnus.karlsson@intel.com</a>&gt;</li>
<li><em>Thread-index</em>: AQHVMLevUssjBLrxPEO5SaX/SuuNRaa3V5eA</li>
<li><em>Thread-topic</em>: [PATCH bpf-next v2 2/6] xsk: add support for need_wakeup flag in AF_XDP rings</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On 2019-07-02 12:21, Magnus Karlsson wrote:
&gt;<i>   </i>
&gt;<i> +/* XDP_RING flags */</i>
&gt;<i> +#define XDP_RING_NEED_WAKEUP (1 &lt;&lt; 0)</i>
&gt;<i> +</i>
&gt;<i>   struct xdp_ring_offset {</i>
&gt;<i>   	__u64 producer;</i>
&gt;<i>   	__u64 consumer;</i>
&gt;<i>   	__u64 desc;</i>
&gt;<i> +	__u64 flags;</i>
&gt;<i>   };</i>
&gt;<i>   </i>
&gt;<i>   struct xdp_mmap_offsets {</i>

&lt;snip&gt;

&gt;<i> @@ -621,9 +692,12 @@ static int xsk_getsockopt(struct socket *sock, int level, int optname,</i>
&gt;<i>   	case XDP_MMAP_OFFSETS:</i>
&gt;<i>   	{</i>
&gt;<i>   		struct xdp_mmap_offsets off;</i>
&gt;<i> +		bool flags_supported = true;</i>
&gt;<i>   </i>
&gt;<i> -		if (len &lt; sizeof(off))</i>
&gt;<i> +		if (len &lt; sizeof(off) - sizeof(off.rx.flags))</i>
&gt;<i>   			return -EINVAL;</i>
&gt;<i> +		else if (len &lt; sizeof(off))</i>
&gt;<i> +			flags_supported = false;</i>
&gt;<i>   </i>
&gt;<i>   		off.rx.producer = offsetof(struct xdp_rxtx_ring, ptrs.producer);</i>
&gt;<i>   		off.rx.consumer = offsetof(struct xdp_rxtx_ring, ptrs.consumer);</i>
&gt;<i> @@ -638,6 +712,16 @@ static int xsk_getsockopt(struct socket *sock, int level, int optname,</i>
&gt;<i>   		off.cr.producer = offsetof(struct xdp_umem_ring, ptrs.producer);</i>
&gt;<i>   		off.cr.consumer = offsetof(struct xdp_umem_ring, ptrs.consumer);</i>
&gt;<i>   		off.cr.desc	= offsetof(struct xdp_umem_ring, desc);</i>
&gt;<i> +		if (flags_supported) {</i>
&gt;<i> +			off.rx.flags = offsetof(struct xdp_rxtx_ring,</i>
&gt;<i> +						ptrs.flags);</i>
&gt;<i> +			off.tx.flags = offsetof(struct xdp_rxtx_ring,</i>
&gt;<i> +						ptrs.flags);</i>
&gt;<i> +			off.fr.flags = offsetof(struct xdp_umem_ring,</i>
&gt;<i> +						ptrs.flags);</i>
&gt;<i> +			off.cr.flags = offsetof(struct xdp_umem_ring,</i>
&gt;<i> +						ptrs.flags);</i>
&gt;<i> +		}</i>

As far as I understood (correct me if I'm wrong), you are trying to 
preserve backward compatibility, so that if userspace doesn't support 
the flags field, you will determine that by looking at len and fall back 
to the old format.

However, two things are broken here:

1. The check `len &lt; sizeof(off) - sizeof(off.rx.flags)` should be `len &lt; 
sizeof(off) - 4 * sizeof(flags)`, because struct xdp_mmap_offsets 
consists of 4 structs xdp_ring_offset.

2. The old and new formats are not binary compatible, as flags are 
inserted in the middle of struct xdp_mmap_offsets.



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="04825" href="msg04825.html">Re: [PATCH bpf-next v2 2/6] xsk: add support for need_wakeup flag in AF_XDP rings</a></strong>
<ul><li><em>From:</em> Magnus Karlsson</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="04819" href="msg04819.html">[PATCH bpf-next v2 0/6] add need_wakeup flag to the AF_XDP rings</a></strong>
<ul><li><em>From:</em> Magnus Karlsson</li></ul></li>
<li><strong><a name="04815" href="msg04815.html">[PATCH bpf-next v2 2/6] xsk: add support for need_wakeup flag in AF_XDP rings</a></strong>
<ul><li><em>From:</em> Magnus Karlsson</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg04823.html">[PATCH bpf-next] bpf: cgroup: Fix build error without CONFIG_NET</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg04825.html">Re: [PATCH bpf-next v2 2/6] xsk: add support for need_wakeup flag in AF_XDP rings</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg04815.html">[PATCH bpf-next v2 2/6] xsk: add support for need_wakeup flag in AF_XDP rings</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg04825.html">Re: [PATCH bpf-next v2 2/6] xsk: add support for need_wakeup flag in AF_XDP rings</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#04824"><strong>Date</strong></a></li>
<li><a href="index.html#04824"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;Samsung&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-rockchip/>[Linux&nbsp;Rockchip&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-actions/>[Linux&nbsp;Actions&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-snps-arc/>[Linux&nbsp;for&nbsp;Synopsys&nbsp;ARC&nbsp;Processors]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nfs/>[Linux&nbsp;NFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nilfs/>[Linux&nbsp;NILFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/vfl/>[Video&nbsp;for&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<p>
<hr>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

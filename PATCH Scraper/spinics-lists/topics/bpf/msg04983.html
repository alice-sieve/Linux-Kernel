<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH bpf&#45;next] tools: bpftool: add "prog run" subcommand to test&#45;run programs -->
<!--X-From-R13: Chragva [baarg &#60;dhragva.zbaargNargebabzr.pbz> -->
<!--X-Date: Fri, 5 Jul 2019 01:21:20 &#45;0700 -->
<!--X-Message-Id: b4bbb342&#45;1f77&#45;8669&#45;ec51&#45;8d5542f7e7b4@netronome.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190704085646.12406&#45;1&#45;quentin.monnet@netronome.com -->
<!--X-Reference: CAH3MdRXuDmXobkXESZg0+VV=FrBLsiAYPC61xQsjx2smKQKUtQ@mail.gmail.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="BPF: Re: [PATCH bpf-next] tools: bpftool: add &quot;prog run&quot; subcommand to test-run programs">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH bpf-next] tools: bpftool: add &quot;prog run&quot; subcommand to test-run programs &mdash; BPF</title>
<link rel="alternate" type="application/rss+xml" title="BPF" href="//feeds.feedburner.com/packetfilters">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH bpf-next] tools: bpftool: add &quot;prog run&quot; subcommand to test-run programs</h1>
[<a href="msg04982.html">Date Prev</a>][<a href="msg04984.html">Date Next</a>][<a href="msg04980.html">Thread Prev</a>][<a href="msg04988.html">Thread Next</a>][<a href="maillist.html#04983">Date Index</a>][<a href="index.html#04983">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH bpf-next] tools: bpftool: add &quot;prog run&quot; subcommand to test-run programs</li>
<li><em>From</em>: Quentin Monnet &lt;quentin.monnet@xxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Fri, 5 Jul 2019 09:21:16 +0100</li>
<li><em>Cc</em>: Alexei Starovoitov &lt;ast@xxxxxxxxxx&gt;,        Daniel Borkmann &lt;daniel@xxxxxxxxxxxxx&gt;, bpf &lt;bpf@xxxxxxxxxxxxxxx&gt;,        netdev &lt;netdev@xxxxxxxxxxxxxxx&gt;, oss-drivers@xxxxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;CAH3MdRXuDmXobkXESZg0+VV=FrBLsiAYPC61xQsjx2smKQKUtQ@mail.gmail.com&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Thunderbird/60.7.2</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>2019-07-04 22:49 UTC-0700 ~ Y Song &lt;ys114321@xxxxxxxxx&gt;
&gt;<i> On Thu, Jul 4, 2019 at 1:58 AM Quentin Monnet</i>
&gt;<i> &lt;quentin.monnet@xxxxxxxxxxxxx&gt; wrote:</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; Add a new &quot;bpftool prog run&quot; subcommand to run a loaded program on input</i>
&gt;<i>&gt; data (and possibly with input context) passed by the user.</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; Print output data (and output context if relevant) into a file or into</i>
&gt;<i>&gt; the console. Print return value and duration for the test run into the</i>
&gt;<i>&gt; console.</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; A &quot;repeat&quot; argument can be passed to run the program several times in a</i>
&gt;<i>&gt; row.</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; The command does not perform any kind of verification based on program</i>
&gt;<i>&gt; type (Is this program type allowed to use an input context?) or on data</i>
&gt;<i>&gt; consistency (Can I work with empty input data?), this is left to the</i>
&gt;<i>&gt; kernel.</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; Example invocation:</i>
&gt;<i>&gt;</i>
&gt;<i>&gt;     # perl -e 'print &quot;\x0&quot; x 14' | ./bpftool prog run \</i>
&gt;<i>&gt;             pinned /sys/fs/bpf/sample_ret0 \</i>
&gt;<i>&gt;             data_in - data_out - repeat 5</i>
&gt;<i>&gt;     0000000 0000 0000 0000 0000 0000 0000 0000      | ........ ......</i>
&gt;<i>&gt;     Return value: 0, duration (average): 260ns</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; When one of data_in or ctx_in is &quot;-&quot;, bpftool reads from standard input,</i>
&gt;<i>&gt; in binary format. Other formats (JSON, hexdump) might be supported (via</i>
&gt;<i>&gt; an optional command line keyword like &quot;data_fmt_in&quot;) in the future if</i>
&gt;<i>&gt; relevant, but this would require doing more parsing in bpftool.</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; Signed-off-by: Quentin Monnet &lt;quentin.monnet@xxxxxxxxxxxxx&gt;</i>
&gt;<i>&gt; Reviewed-by: Jakub Kicinski &lt;jakub.kicinski@xxxxxxxxxxxxx&gt;</i>
&gt;<i>&gt; ---</i>

[...]

&gt;<i>&gt; diff --git a/tools/bpf/bpftool/prog.c b/tools/bpf/bpftool/prog.c</i>
&gt;<i>&gt; index 9b0db5d14e31..8dcbaa0a8ab1 100644</i>
&gt;<i>&gt; --- a/tools/bpf/bpftool/prog.c</i>
&gt;<i>&gt; +++ b/tools/bpf/bpftool/prog.c</i>
&gt;<i>&gt; @@ -15,6 +15,7 @@</i>
&gt;<i>&gt;  #include &lt;sys/stat.h&gt;</i>
&gt;<i>&gt;</i>
&gt;<i>&gt;  #include &lt;linux/err.h&gt;</i>
&gt;<i>&gt; +#include &lt;linux/sizes.h&gt;</i>
&gt;<i>&gt;</i>
&gt;<i>&gt;  #include &lt;bpf.h&gt;</i>
&gt;<i>&gt;  #include &lt;btf.h&gt;</i>
&gt;<i>&gt; @@ -748,6 +749,344 @@ static int do_detach(int argc, char **argv)</i>
&gt;<i>&gt;         return 0;</i>
&gt;<i>&gt;  }</i>
&gt;<i>&gt;</i>
&gt;<i>&gt; +static int check_single_stdin(char *file_in, char *other_file_in)</i>
&gt;<i>&gt; +{</i>
&gt;<i>&gt; +       if (file_in &amp;&amp; other_file_in &amp;&amp;</i>
&gt;<i>&gt; +           !strcmp(file_in, &quot;-&quot;) &amp;&amp; !strcmp(other_file_in, &quot;-&quot;)) {</i>
&gt;<i>&gt; +               p_err(&quot;cannot use standard input for both data_in and ctx_in&quot;);</i>
&gt;<i> </i>
&gt;<i> The error message says data_in and ctx_in.</i>
&gt;<i> Maybe the input parameter should be file_data_in and file_ctx_in?</i>


Hi Yonghong,

It's true those parameters should be file names. But having
&quot;file_data_in&quot;, &quot;file_data_out&quot;, &quot;file_ctx_in&quot; and &quot;file_ctx_out&quot; on a
command line seems a bit heavy to me? (And relying on keyword prefixing
for typing the command won't help much.)

My opinion is that it should be clear from the man page or the &quot;help&quot;
command that the parameters are file names. What do you think? I can
prefix all four arguments with &quot;file_&quot; if you believe this is better.

[...]

&gt;<i>&gt; +static int do_run(int argc, char **argv)</i>
&gt;<i>&gt; +{</i>
&gt;<i>&gt; +       char *data_fname_in = NULL, *data_fname_out = NULL;</i>
&gt;<i>&gt; +       char *ctx_fname_in = NULL, *ctx_fname_out = NULL;</i>
&gt;<i>&gt; +       struct bpf_prog_test_run_attr test_attr = {0};</i>
&gt;<i>&gt; +       const unsigned int default_size = SZ_32K;</i>
&gt;<i>&gt; +       void *data_in = NULL, *data_out = NULL;</i>
&gt;<i>&gt; +       void *ctx_in = NULL, *ctx_out = NULL;</i>
&gt;<i>&gt; +       unsigned int repeat = 1;</i>
&gt;<i>&gt; +       int fd, err;</i>
&gt;<i>&gt; +</i>
&gt;<i>&gt; +       if (!REQ_ARGS(4))</i>
&gt;<i>&gt; +               return -1;</i>
&gt;<i>&gt; +</i>
&gt;<i>&gt; +       fd = prog_parse_fd(&amp;argc, &amp;argv);</i>
&gt;<i>&gt; +       if (fd &lt; 0)</i>
&gt;<i>&gt; +               return -1;</i>
&gt;<i>&gt; +</i>
&gt;<i>&gt; +       while (argc) {</i>
&gt;<i>&gt; +               if (detect_common_prefix(*argv, &quot;data_in&quot;, &quot;data_out&quot;,</i>
&gt;<i>&gt; +                                        &quot;data_size_out&quot;, NULL))</i>
&gt;<i>&gt; +                       return -1;</i>
&gt;<i>&gt; +               if (detect_common_prefix(*argv, &quot;ctx_in&quot;, &quot;ctx_out&quot;,</i>
&gt;<i>&gt; +                                        &quot;ctx_size_out&quot;, NULL))</i>
&gt;<i>&gt; +                       return -1;</i>
&gt;<i>&gt; +</i>
&gt;<i>&gt; +               if (is_prefix(*argv, &quot;data_in&quot;)) {</i>
&gt;<i>&gt; +                       NEXT_ARG();</i>
&gt;<i>&gt; +                       if (!REQ_ARGS(1))</i>
&gt;<i>&gt; +                               return -1;</i>
&gt;<i>&gt; +</i>
&gt;<i>&gt; +                       data_fname_in = GET_ARG();</i>
&gt;<i>&gt; +                       if (check_single_stdin(data_fname_in, ctx_fname_in))</i>
&gt;<i>&gt; +                               return -1;</i>
&gt;<i>&gt; +               } else if (is_prefix(*argv, &quot;data_out&quot;)) {</i>
&gt;<i> </i>
&gt;<i> Here, we all use is_prefix() to match &quot;data_in&quot;, &quot;data_out&quot;,</i>
&gt;<i> &quot;data_size_out&quot; etc.</i>
&gt;<i> That means users can use &quot;data_i&quot; instead of &quot;data_in&quot; as below</i>
&gt;<i>    ... | ./bpftool prog run id 283 data_i - data_out - repeat 5</i>
&gt;<i> is this expected?</i>
Yes, this is expected. We use prefix matching as we do pretty much
everywhere else in bpftool. It's not as useful here because most of the
strings for the names are similar. I agree that typing &quot;data_i&quot; instead
of &quot;data_in&quot; brings little advantage, but I see no reason why we should
reject prefixing for those keywords. And we accept &quot;data_s&quot; instead of
&quot;data_size_out&quot;, which is still shorter to type than the complete keyword.

Thanks for the review!
Quentin


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="04988" href="msg04988.html">Re: [PATCH bpf-next] tools: bpftool: add &quot;prog run&quot; subcommand to test-run programs</a></strong>
<ul><li><em>From:</em> Y Song</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="04951" href="msg04951.html">[PATCH bpf-next] tools: bpftool: add &quot;prog run&quot; subcommand to test-run programs</a></strong>
<ul><li><em>From:</em> Quentin Monnet</li></ul></li>
<li><strong><a name="04980" href="msg04980.html">Re: [PATCH bpf-next] tools: bpftool: add &quot;prog run&quot; subcommand to test-run programs</a></strong>
<ul><li><em>From:</em> Y Song</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg04982.html">Re: [PATCH bpf] xdp: fix possible cq entry leak</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg04984.html">Re: [PATCH bpf-next] Enable zext optimization for more RV64G ALU ops</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg04980.html">Re: [PATCH bpf-next] tools: bpftool: add &quot;prog run&quot; subcommand to test-run programs</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg04988.html">Re: [PATCH bpf-next] tools: bpftool: add &quot;prog run&quot; subcommand to test-run programs</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#04983"><strong>Date</strong></a></li>
<li><a href="index.html#04983"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;Samsung&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-rockchip/>[Linux&nbsp;Rockchip&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-actions/>[Linux&nbsp;Actions&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-snps-arc/>[Linux&nbsp;for&nbsp;Synopsys&nbsp;ARC&nbsp;Processors]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nfs/>[Linux&nbsp;NFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nilfs/>[Linux&nbsp;NILFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/vfl/>[Video&nbsp;for&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<p>
<hr>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

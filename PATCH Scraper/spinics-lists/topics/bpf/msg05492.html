<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace -->
<!--X-From-R13: Xbry Treanaqrf &#60;wbryNwbrysreanaqrf.bet> -->
<!--X-Date: Wed, 17 Jul 2019 19:51:48 &#45;0700 -->
<!--X-Message-Id: 20190718025143.GB153617@google.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190710141548.132193&#45;1&#45;joel@joelfernandes.org -->
<!--X-Reference: 20190716205455.iimn3pqpvsc3k4ry@ast&#45;mbp.dhcp.thefacebook.com -->
<!--X-Reference: 20190716213050.GA161922@google.com -->
<!--X-Reference: 20190716222650.tk2coihjtsxszarf@ast&#45;mbp.dhcp.thefacebook.com -->
<!--X-Reference: 20190716224150.GC172157@google.com -->
<!--X-Reference: 20190716235500.GA199237@google.com -->
<!--X-Reference: 20190717012406.lugqemvubixfdd6v@ast&#45;mbp.dhcp.thefacebook.com -->
<!--X-Reference: 20190717130119.GA138030@google.com -->
<!--X-Reference: CAADnVQJY_=yeY0C3k1ZKpRFu5oNbB4zhQf5tQnLr=Mi8i6cgeQ@mail.gmail.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="BPF: Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace &mdash; BPF</title>
<link rel="alternate" type="application/rss+xml" title="BPF" href="//feeds.feedburner.com/packetfilters">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</h1>
[<a href="msg05491.html">Date Prev</a>][<a href="msg05493.html">Date Next</a>][<a href="msg05488.html">Thread Prev</a>][<a href="msg05459.html">Thread Next</a>][<a href="maillist.html#05492">Date Index</a>][<a href="index.html#05492">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</li>
<li><em>From</em>: Joel Fernandes &lt;joel@xxxxxxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Wed, 17 Jul 2019 22:51:43 -0400</li>
<li><em>Cc</em>: LKML &lt;linux-kernel@xxxxxxxxxxxxxxx&gt;, bpf &lt;bpf@xxxxxxxxxxxxxxx&gt;,        Daniel Borkmann &lt;daniel@xxxxxxxxxxxxx&gt;,        Network Development &lt;netdev@xxxxxxxxxxxxxxx&gt;,        Steven Rostedt &lt;rostedt@xxxxxxxxxxx&gt;, kernel-team@xxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;CAADnVQJY_=yeY0C3k1ZKpRFu5oNbB4zhQf5tQnLr=Mi8i6cgeQ@mail.gmail.com&gt;</li>
<li><em>User-agent</em>: Mutt/1.10.1 (2018-07-13)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Hi Alexei,

On Wed, Jul 17, 2019 at 02:40:42PM -0700, Alexei Starovoitov wrote:
&gt;<i> On Wed, Jul 17, 2019 at 6:01 AM Joel Fernandes &lt;joel@xxxxxxxxxxxxxxxxx&gt; wrote:</i>
&gt;<i> </i>
&gt;<i> I trimmed cc. some emails were bouncing.</i>

Ok, thanks.

&gt;<i> &gt; &gt; I think allowing one tracepoint and disallowing another is pointless</i>
&gt;<i> &gt; &gt; from security point of view. Tracing bpf program can do bpf_probe_read</i>
&gt;<i> &gt; &gt; of anything.</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; I think the assumption here is the user controls the program instructions at</i>
&gt;<i> &gt; runtime, but that's not the case. The BPF program we are loading is not</i>
&gt;<i> &gt; dynamically generated, it is built at build time and it is loaded from a</i>
&gt;<i> &gt; secure verified partition, so even though it can do bpf_probe_read, it is</i>
&gt;<i> &gt; still not something that the user can change.</i>
&gt;<i> </i>
&gt;<i> so you're saying that by having a set of signed bpf programs which</i>
&gt;<i> instructions are known to be non-malicious and allowed set of tracepoints</i>
&gt;<i> to attach via selinux whitelist, such setup will be safe?</i>
&gt;<i> Have you considered how mix and match will behave?</i>

Do you mean the effect of mixing tracepoints and programs? I have not
considered this. I am Ok with further enforcing of this (only certain
tracepoints can be attached to certain programs) if needed. What do
you think? We could have a new bpf(2) syscall attribute specify which
tracepoint is expected, or similar.

I wanted to walk you through our 2 usecases we are working on:

1. timeinstate: By hooking 2 programs onto sched_switch and cpu_frequency
tracepoints, we are able to collect CPU power per-UID (specific app). Connor
O'Brien is working on that.

2. inode to file path mapping: By hooking onto VFS tracepoints we are adding to
the android kernels, we can collect data when the kernel resolves a file path
to a inode/device number. A BPF map stores the inode/dev number (key) and the
path (value). We have usecases where we need a high speed lookup of this
without having to scan all the files in the filesystem.

For the first usecase, the BPF program will be loaded and attached to the
scheduler and cpufreq tracepoints at boot time and will stay attached
forever.  This is why I was saying having a daemon to stay alive all the time
is pointless. However, if since you are completely against using tracefs
which it sounds like, then we can do a daemon that is always alive.

For the second usecase, the program attach is needed on-demand unlike the
first usecase, and then after the usecase completes, it is detached to avoid
overhead.

For the second usecase, privacy is important and we want the data to not be
available to any process. So we want to make sure only selected processes can
attach to that tracepoint. This is the reason why I was doing working on
these patches which use the tracefs as well, since we get that level of
control.

As you can see, I was trying to solve the sticky tracepoint problem in
usecase 1 and the privacy problem in usecase 2.

I had some discussions today at office and we think we can use the daemon
approach to solve both these problems as well which I think would make you
happy as well.

What do you think about all of this? Any other feedback?

&gt;<i> &gt; And, we are planning to make it</i>
&gt;<i> &gt; even more secure by making it kernel verify the program at load time as well</i>
&gt;<i> &gt; (you were on some discussions about that a few months ago).</i>
&gt;<i> </i>
&gt;<i> It sounds like api decisions for this sticky raw_tp feature are</i>
&gt;<i> driven by security choices which are not actually secure.</i>
&gt;<i> I'm suggesting to avoid bringing up point of security as a reason for</i>
&gt;<i> this api design, since it's making the opposite effect.</i>

Ok, that's a fair point.

thanks,

 - Joel



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="05170" href="msg05170.html">[PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
<ul><li><em>From:</em> Joel Fernandes (Google)</li></ul></li>
<li><strong><a name="05452" href="msg05452.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
<ul><li><em>From:</em> Alexei Starovoitov</li></ul></li>
<li><strong><a name="05453" href="msg05453.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
<ul><li><em>From:</em> Joel Fernandes</li></ul></li>
<li><strong><a name="05456" href="msg05456.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
<ul><li><em>From:</em> Alexei Starovoitov</li></ul></li>
<li><strong><a name="05458" href="msg05458.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
<ul><li><em>From:</em> Joel Fernandes</li></ul></li>
<li><strong><a name="05463" href="msg05463.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
<ul><li><em>From:</em> Joel Fernandes</li></ul></li>
<li><strong><a name="05469" href="msg05469.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
<ul><li><em>From:</em> Alexei Starovoitov</li></ul></li>
<li><strong><a name="05485" href="msg05485.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
<ul><li><em>From:</em> Joel Fernandes</li></ul></li>
<li><strong><a name="05488" href="msg05488.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
<ul><li><em>From:</em> Alexei Starovoitov</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg05491.html">Re: [PATCH v3 bpf-next 05/12] libbpf: add resizable non-thread safe internal hashmap</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg05493.html">Re: [PATCH v3 bpf-next 05/12] libbpf: add resizable non-thread safe internal hashmap</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg05488.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg05459.html">Re: [PATCH RFC 0/4] Add support to directly attach BPF program to ftrace</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#05492"><strong>Date</strong></a></li>
<li><a href="index.html#05492"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;Samsung&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-rockchip/>[Linux&nbsp;Rockchip&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-actions/>[Linux&nbsp;Actions&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-snps-arc/>[Linux&nbsp;for&nbsp;Synopsys&nbsp;ARC&nbsp;Processors]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nfs/>[Linux&nbsp;NFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nilfs/>[Linux&nbsp;NILFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/vfl/>[Video&nbsp;for&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<p>
<hr>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

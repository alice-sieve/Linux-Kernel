<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH] virtio&#45;net: parameterize min ring num_free for virtio receive -->
<!--X-From-R13: "[vpunry E. Ffvexva" &#60;zfgNerqung.pbz> -->
<!--X-Date: Thu, 18 Jul 2019 06:05:10 &#45;0700 -->
<!--X-Message-Id: 20190718085836&#45;mutt&#45;send&#45;email&#45;mst@kernel.org -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: BYAPR14MB32056583C4963342F5D817C4A6C80@BYAPR14MB3205.namprd14.prod.outlook.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="BPF: Re: [PATCH] virtio-net: parameterize min ring num_free for virtio receive">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH] virtio-net: parameterize min ring num_free for virtio receive &mdash; BPF</title>
<link rel="alternate" type="application/rss+xml" title="BPF" href="//feeds.feedburner.com/packetfilters">
<script type="text/javascript">
var addthis_config = addthis_config||{};
addthis_config.data_track_addressbar = false;
</script>
</head>
<body itemscope itemtype="//schema.org/Article" bgcolor=white vlink=green link=blue>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH] virtio-net: parameterize min ring num_free for virtio receive</h1>
[<a href="msg05495.html">Date Prev</a>][<a href="msg05497.html">Date Next</a>][<a href="msg05495.html">Thread Prev</a>][<a href="msg05498.html">Thread Next</a>][<a href="maillist.html#05496">Date Index</a>][<a href="index.html#05496">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH] virtio-net: parameterize min ring num_free for virtio receive</li>
<li><em>From</em>: &quot;Michael S. Tsirkin&quot; &lt;mst@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 18 Jul 2019 09:04:34 -0400</li>
<li><em>Cc</em>: &quot;jasowang@xxxxxxxxxx&quot; &lt;jasowang@xxxxxxxxxx&gt;,        &quot;davem@xxxxxxxxxxxxx&quot; &lt;davem@xxxxxxxxxxxxx&gt;,        &quot;ast@xxxxxxxxxx&quot; &lt;ast@xxxxxxxxxx&gt;,        &quot;daniel@xxxxxxxxxxxxx&quot; &lt;daniel@xxxxxxxxxxxxx&gt;,        &quot;jakub.kicinski@xxxxxxxxxxxxx&quot; &lt;jakub.kicinski@xxxxxxxxxxxxx&gt;,        &quot;hawk@xxxxxxxxxx&quot; &lt;hawk@xxxxxxxxxx&gt;,        &quot;john.fastabend@xxxxxxxxx&quot; &lt;john.fastabend@xxxxxxxxx&gt;,        &quot;kafai@xxxxxx&quot; &lt;kafai@xxxxxx&gt;,        &quot;songliubraving@xxxxxx&quot; &lt;songliubraving@xxxxxx&gt;,        &quot;yhs@xxxxxx&quot; &lt;yhs@xxxxxx&gt;,        &quot;virtualization@xxxxxxxxxxxxxxxxxxxxxxxxxx&quot;         &lt;virtualization@xxxxxxxxxxxxxxxxxxxxxxxxxx&gt;,        &quot;netdev@xxxxxxxxxxxxxxx&quot; &lt;netdev@xxxxxxxxxxxxxxx&gt;,        &quot;linux-kernel@xxxxxxxxxxxxxxx&quot; &lt;linux-kernel@xxxxxxxxxxxxxxx&gt;,        &quot;xdp-newbies@xxxxxxxxxxxxxxx&quot; &lt;xdp-newbies@xxxxxxxxxxxxxxx&gt;,        &quot;bpf@xxxxxxxxxxxxxxx&quot; &lt;bpf@xxxxxxxxxxxxxxx&gt;,        &quot;jiangran.jr@xxxxxxxxxxxxxxx&quot; &lt;jiangran.jr@xxxxxxxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;BYAPR14MB32056583C4963342F5D817C4A6C80@BYAPR14MB3205.namprd14.prod.outlook.com&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Thu, Jul 18, 2019 at 12:55:50PM +0000, ? jiang wrote:
&gt;<i> This change makes ring buffer reclaim threshold num_free configurable</i>
&gt;<i> for better performance, while it's hard coded as 1/2 * queue now.</i>
&gt;<i> According to our test with qemu + dpdk, packet dropping happens when</i>
&gt;<i> the guest is not able to provide free buffer in avail ring timely.</i>
&gt;<i> Smaller value of num_free does decrease the number of packet dropping</i>
&gt;<i> during our test as it makes virtio_net reclaim buffer earlier.</i>
&gt;<i> </i>
&gt;<i> At least, we should leave the value changeable to user while the</i>
&gt;<i> default value as 1/2 * queue is kept.</i>
&gt;<i> </i>
&gt;<i> Signed-off-by: jiangkidd &lt;jiangkidd@xxxxxxxxxxx&gt;</i>

That would be one reason, but I suspect it's not the
true one. If you need more buffer due to jitter
then just increase the queue size. Would be cleaner.


However are you sure this is the reason for
packet drops? Do you see them dropped by dpdk
due to lack of space in the ring? As opposed to
by guest?


&gt;<i> ---</i>
&gt;<i>  drivers/net/virtio_net.c | 8 +++++++-</i>
&gt;<i>  1 file changed, 7 insertions(+), 1 deletion(-)</i>
&gt;<i> </i>
&gt;<i> diff --git a/drivers/net/virtio_net.c b/drivers/net/virtio_net.c</i>
&gt;<i> index 0d4115c9e20b..bc190dec6084 100644</i>
&gt;<i> --- a/drivers/net/virtio_net.c</i>
&gt;<i> +++ b/drivers/net/virtio_net.c</i>
&gt;<i> @@ -26,6 +26,9 @@</i>
&gt;<i>  static int napi_weight = NAPI_POLL_WEIGHT;</i>
&gt;<i>  module_param(napi_weight, int, 0444);</i>
&gt;<i>  </i>
&gt;<i> +static int min_numfree;</i>
&gt;<i> +module_param(min_numfree, int, 0444);</i>
&gt;<i> +</i>
&gt;<i>  static bool csum = true, gso = true, napi_tx;</i>
&gt;<i>  module_param(csum, bool, 0444);</i>
&gt;<i>  module_param(gso, bool, 0444);</i>
&gt;<i> @@ -1315,6 +1318,9 @@ static int virtnet_receive(struct receive_queue *rq, int budget,</i>
&gt;<i>  	void *buf;</i>
&gt;<i>  	int i;</i>
&gt;<i>  </i>
&gt;<i> +	if (!min_numfree)</i>
&gt;<i> +		min_numfree = virtqueue_get_vring_size(rq-&gt;vq) / 2;</i>
&gt;<i> +</i>
&gt;<i>  	if (!vi-&gt;big_packets || vi-&gt;mergeable_rx_bufs) {</i>
&gt;<i>  		void *ctx;</i>
&gt;<i>  </i>
&gt;<i> @@ -1331,7 +1337,7 @@ static int virtnet_receive(struct receive_queue *rq, int budget,</i>
&gt;<i>  		}</i>
&gt;<i>  	}</i>
&gt;<i>  </i>
&gt;<i> -	if (rq-&gt;vq-&gt;num_free &gt; virtqueue_get_vring_size(rq-&gt;vq) / 2) {</i>
&gt;<i> +	if (rq-&gt;vq-&gt;num_free &gt; min_numfree) {</i>
&gt;<i>  		if (!try_fill_recv(vi, rq, GFP_ATOMIC))</i>
&gt;<i>  			schedule_delayed_work(&amp;vi-&gt;refill, 0);</i>
&gt;<i>  	}</i>
&gt;<i> -- </i>
&gt;<i> 2.11.0</i>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="05498" href="msg05498.html">Re: [PATCH] virtio-net: parameterize min ring num_free for virtio receive</a></strong>
<ul><li><em>From:</em> Jason Wang</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg05495.html">[PATCH bpf] selftests/bpf: fix &quot;valid read map access into a read-only array 1&quot; on s390</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg05497.html">Building bpftool with OUTPUT set breaks</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg05495.html">[PATCH bpf] selftests/bpf: fix &quot;valid read map access into a read-only array 1&quot; on s390</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg05498.html">Re: [PATCH] virtio-net: parameterize min ring num_free for virtio receive</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#05496"><strong>Date</strong></a></li>
<li><a href="index.html#05496"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-samsung-soc/>[Linux&nbsp;Samsung&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-rockchip/>[Linux&nbsp;Rockchip&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-actions/>[Linux&nbsp;Actions&nbsp;SoC]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-snps-arc/>[Linux&nbsp;for&nbsp;Synopsys&nbsp;ARC&nbsp;Processors]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nfs/>[Linux&nbsp;NFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-nilfs/>[Linux&nbsp;NILFS]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[Linux&nbsp;USB&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/vfl/>[Video&nbsp;for&nbsp;Linux]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info/>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kernel/>[Linux&nbsp;Kernel]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-scsi/>[Linux&nbsp;SCSI]</a>
</font>
</center>
<p>
<hr>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

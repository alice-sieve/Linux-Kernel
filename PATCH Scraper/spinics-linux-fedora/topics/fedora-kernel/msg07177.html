<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH] fix kexec_file_load failure in case Secure Boot enabled -->
<!--X-From-R13: Rnir Kbhat &#60;qlbhatNerqung.pbz> -->
<!--X-Date: Wed, 13 Jun 2018 23:18:40 &#45;0700 -->
<!--X-Message-Id: 20180614061823.GC11348@dhcp&#45;128&#45;65.nay.redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20180612100312.GA2284@dhcp&#45;128&#45;65.nay.redhat.com -->
<!--X-Reference: CAFbkSA3YOYEh8s=V9ime_cZOKtj5w2Vg58nd8n=byFTE_XzYWw@mail.gmail.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description content="Re: [PATCH] fix kexec_file_load failure in case Secure Boot enabled &mdash; Fedora Linux Kernel">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Re: [PATCH] fix kexec_file_load failure in case Secure Boot enabled &mdash; Fedora Linux Kernel</title>
<link rel="alternate" type="application/rss+xml" title="Fedora Linux Kernel" href="//feeds.feedburner.com/FedoraKernel">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en" async defer></script>
<h1 itemprop="name">Re: [PATCH] fix kexec_file_load failure in case Secure Boot enabled</h1>
[<a href="msg07176.html">Date Prev</a>][<a href="msg07178.html">Date Next</a>][<a href="msg07175.html">Thread Prev</a>][<a href="msg07178.html">Thread Next</a>][<a href="maillist.html#07177">Date Index</a>][<a href="index.html#07177">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH] fix kexec_file_load failure in case Secure Boot enabled</li>
<li><em>From</em>: Dave Young &lt;dyoung@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 14 Jun 2018 14:18:23 +0800</li>
<li><em>Cc</em>: David Howells &lt;dhowells@xxxxxxxxxx&gt;,        Kernel Fedora &lt;kernel@xxxxxxxxxxxxxxxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;CAFbkSA3YOYEh8s=V9ime_cZOKtj5w2Vg58nd8n=byFTE_XzYWw@mail.gmail.com&gt;</li>
<li><em>User-agent</em>: Mutt/1.9.5 (2018-04-13)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On 06/13/18 at 09:38am, Justin Forbes wrote:
&gt;<i> On Tue, Jun 12, 2018 at 5:03 AM, Dave Young &lt;dyoung@xxxxxxxxxx&gt; wrote:</i>
&gt;<i> </i>
&gt;<i> &gt; Fedora bug</i>
&gt;<i> &gt; <a  rel="nofollow" href="https://bugzilla.redhat.com/show_bug.cgi?id=1470995">https://bugzilla.redhat.com/show_bug.cgi?id=1470995</a></i>
&gt;<i> &gt;</i>
&gt;<i> &gt; With Fedora kernels on Secure Boot enabled machine kexec_file_load</i>
&gt;<i> &gt; fails because kernel can not use any keys other than kernel builtin</i>
&gt;<i> &gt; keyring.  verify_pefile_signature() requires caller to pass 1UL as</i>
&gt;<i> &gt; the keyring pointer to use other keyring.</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; Posted a fix in upstream, but no response for long time.  Thus going</i>
&gt;<i> &gt; with a Fedora fix same as what the module code does.</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; Latest upstream effort:</i>
&gt;<i> &gt; <a  rel="nofollow" href="https://www.spinics.net/lists/kernel/msg2825184.html">https://www.spinics.net/lists/kernel/msg2825184.html</a></i>
&gt;<i> &gt;</i>
&gt;<i> &gt; Signed-off-by: Dave Young &lt;dyoung@xxxxxxxxxx&gt;</i>
&gt;<i> &gt;</i>
&gt;<i> </i>
&gt;<i> I would really like to hear David Howell's opinion on this before we</i>
&gt;<i> consider carrying it.  I have CCed him.</i>

Justin, thanks for adding cc,  I'm also waiting for his review in
upstream.  But forgot to add him for the Fedora patch.

Since our module code already takes this workaround, for kexec it is
pretty safe.  I tested this patch with a scratch build,  pesigned the
kernel with a temp key, import it in mokutil.  The build works well for
me.

If the 1UL passing is wrong then we should drop the module patch as
well as this one and take some reasonable fix.

&gt;<i> </i>
&gt;<i> Thanks,</i>
&gt;<i> Justin</i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i> &gt; ---</i>
&gt;<i> &gt;  kernel.spec                                 |  3 ++</i>
&gt;<i> &gt;  kexec-bzimage-verify-pe-signature-fix.patch | 32 +++++++++++++++++++++</i>
&gt;<i> &gt;  2 files changed, 35 insertions(+)</i>
&gt;<i> &gt;  create mode 100644 kexec-bzimage-verify-pe-signature-fix.patch</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; diff --git a/kernel.spec b/kernel.spec</i>
&gt;<i> &gt; index d5e16d7f..7a20da1e 100644</i>
&gt;<i> &gt; --- a/kernel.spec</i>
&gt;<i> &gt; +++ b/kernel.spec</i>
&gt;<i> &gt; @@ -608,6 +608,9 @@ Patch501: Fix-for-module-sig-verification.patch</i>
&gt;<i> &gt;  # rhbz 1431375</i>
&gt;<i> &gt;  Patch502: input-rmi4-remove-the-need-for-artifical-IRQ.patch</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; +# rhbz 1470995</i>
&gt;<i> &gt; +Patch503: kexec-bzimage-verify-pe-signature-fix.patch</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt;  # END OF PATCH DEFINITIONS</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;  %endif</i>
&gt;<i> &gt; diff --git a/kexec-bzimage-verify-pe-signature-fix.patch</i>
&gt;<i> &gt; b/kexec-bzimage-verify-pe-signature-fix.patch</i>
&gt;<i> &gt; new file mode 100644</i>
&gt;<i> &gt; index 00000000..866b74b9</i>
&gt;<i> &gt; --- /dev/null</i>
&gt;<i> &gt; +++ b/kexec-bzimage-verify-pe-signature-fix.patch</i>
&gt;<i> &gt; @@ -0,0 +1,32 @@</i>
&gt;<i> &gt; +From: Dave Young &lt;dyoung@xxxxxxxxxx&gt;</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +Fix kexec_file_load pefile signature verification</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +Similar with Fix-for-module-sig-verification.patch, kexec_file syscall</i>
&gt;<i> &gt; also</i>
&gt;<i> &gt; +need pass 1UL to verify_pefile_signature so that secondary keys can be</i>
&gt;<i> &gt; used.</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +Fedora bug</i>
&gt;<i> &gt; +<a  rel="nofollow" href="https://bugzilla.redhat.com/show_bug.cgi?id=1470995">https://bugzilla.redhat.com/show_bug.cgi?id=1470995</a></i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +Latest upstream effort is below:</i>
&gt;<i> &gt; +<a  rel="nofollow" href="https://www.spinics.net/lists/kernel/msg2825184.html">https://www.spinics.net/lists/kernel/msg2825184.html</a></i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +Ideally this need an upstream fix, but since nobody response we can</i>
&gt;<i> &gt; workaround</i>
&gt;<i> &gt; +it like the module code did.</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +Signed-off-by: Dave Young &lt;dyoung@xxxxxxxxxx&gt;</i>
&gt;<i> &gt; +---</i>
&gt;<i> &gt; + arch/x86/kernel/kexec-bzimage64.c |    2 +-</i>
&gt;<i> &gt; + 1 file changed, 1 insertion(+), 1 deletion(-)</i>
&gt;<i> &gt; +</i>
&gt;<i> &gt; +--- linux-x86.orig/arch/x86/kernel/kexec-bzimage64.c</i>
&gt;<i> &gt; ++++ linux-x86/arch/x86/kernel/kexec-bzimage64.c</i>
&gt;<i> &gt; +@@ -533,7 +533,7 @@ static int bzImage64_cleanup(void *loade</i>
&gt;<i> &gt; + static int bzImage64_verify_sig(const char *kernel, unsigned long</i>
&gt;<i> &gt; kernel_len)</i>
&gt;<i> &gt; + {</i>
&gt;<i> &gt; +       return verify_pefile_signature(kernel, kernel_len,</i>
&gt;<i> &gt; +-                                     NULL,</i>
&gt;<i> &gt; ++                                     (void *)1UL,</i>
&gt;<i> &gt; +                                      VERIFYING_KEXEC_PE_SIGNATURE);</i>
&gt;<i> &gt; + }</i>
&gt;<i> &gt; + #endif</i>
&gt;<i> &gt; --</i>
&gt;<i> &gt; 2.17.0</i>
&gt;<i> &gt; _______________________________________________</i>
&gt;<i> &gt; kernel mailing list -- kernel@xxxxxxxxxxxxxxxxxxxxxxx</i>
&gt;<i> &gt; To unsubscribe send an email to kernel-leave@xxxxxxxxxxxxxxxxxxxxxxx</i>
&gt;<i> &gt; Fedora Code of Conduct: <a  rel="nofollow" href="https://getfedora.org/code-of-conduct.html">https://getfedora.org/code-of-conduct.html</a></i>
&gt;<i> &gt; List Guidelines: <a  rel="nofollow" href="https://fedoraproject.org/wiki/Mailing_list_guidelines">https://fedoraproject.org/wiki/Mailing_list_guidelines</a></i>
&gt;<i> &gt; List Archives: <a  rel="nofollow" href="https://lists.fedoraproject.org/archives/list/kernel@">https://lists.fedoraproject.org/archives/list/kernel@</a></i>
&gt;<i> &gt; lists.fedoraproject.org/message/RYRV32S4Z6F7WGR3BEIXVWOGX6XV3JSQ/</i>
&gt;<i> &gt;</i>
_______________________________________________
kernel mailing list -- kernel@xxxxxxxxxxxxxxxxxxxxxxx
To unsubscribe send an email to kernel-leave@xxxxxxxxxxxxxxxxxxxxxxx
Fedora Code of Conduct: <a  rel="nofollow" href="https://getfedora.org/code-of-conduct.html">https://getfedora.org/code-of-conduct.html</a>
List Guidelines: <a  rel="nofollow" href="https://fedoraproject.org/wiki/Mailing_list_guidelines">https://fedoraproject.org/wiki/Mailing_list_guidelines</a>
List Archives: <a  rel="nofollow" href="https://lists.fedoraproject.org/archives/list/kernel@xxxxxxxxxxxxxxxxxxxxxxx/message/QC4XAVP7DIHQOM37F5WQPNBPI2SZR3UR/">https://lists.fedoraproject.org/archives/list/kernel@xxxxxxxxxxxxxxxxxxxxxxx/message/QC4XAVP7DIHQOM37F5WQPNBPI2SZR3UR/</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="07178" href="msg07178.html">Re: [PATCH] fix kexec_file_load failure in case Secure Boot enabled</a></strong>
<ul><li><em>From:</em> Dave Young</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="07173" href="msg07173.html">[PATCH] fix kexec_file_load failure in case Secure Boot enabled</a></strong>
<ul><li><em>From:</em> Dave Young</li></ul></li>
<li><strong><a name="07175" href="msg07175.html">Re: [PATCH] fix kexec_file_load failure in case Secure Boot enabled</a></strong>
<ul><li><em>From:</em> Justin Forbes</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg07176.html">Re: [PATCH] fix kexec_file_load failure in case Secure Boot enabled</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg07178.html">Re: [PATCH] fix kexec_file_load failure in case Secure Boot enabled</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg07175.html">Re: [PATCH] fix kexec_file_load failure in case Secure Boot enabled</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg07178.html">Re: [PATCH] fix kexec_file_load failure in case Secure Boot enabled</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#07177"><strong>Date</strong></a></li>
<li><a href="index.html#07177"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;General&nbsp;Discussion]</a>
&nbsp;
&nbsp;
<a href=http://lists.linuxcoding.com/rhl/>[Older&nbsp;Fedora&nbsp;Users&nbsp;Archive]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-advisory-board/>[Fedora&nbsp;Advisory&nbsp;Board]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-security/>[Fedora&nbsp;Security]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-devel-java/>[Fedora&nbsp;Devel&nbsp;Java]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-legacy/>[Fedora&nbsp;Legacy]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/ataraid/>[ATA&nbsp;RAID]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-marketing/>[Fedora&nbsp;Marketing]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-mentors/>[Fedora&nbsp;Mentors]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-package-announce/>[Fedora&nbsp;Package&nbsp;Announce]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-package-review/>[Fedora&nbsp;Package&nbsp;Review]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-music/>[Fedora&nbsp;Music]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-packaging/>[Fedora&nbsp;Packaging]</a>
&nbsp;
&nbsp;
<a href=/lists/centos/>[Centos]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/coolkey/>[Coolkey]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/yum/>[Yum&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/tux/>[Tux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-art/>[Fedora&nbsp;Art]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-docs/>[Fedora&nbsp;Docs]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-usb/>[USB]</a>
&nbsp;
&nbsp;
<a href=/lists/asterisk/>[Asterisk&nbsp;PBX]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH] ASoC: atmel: add wm8904 based audio machine driver -->
<!--X-From-R13: Pb Eura &#60;ibvpr.furaNngzry.pbz> -->
<!--X-Date: Thu, 18 Jul 2013 19:46:03 &#45;0700 -->
<!--X-Message-Id: 51E8A6EF.4040608@atmel.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 1374132483&#45;25375&#45;1&#45;git&#45;send&#45;email&#45;voice.shen@atmel.com -->
<!--X-Reference: 20130718111709.GL22506@sirena.org.uk -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Linux Sound: Re: [PATCH] ASoC: atmel: add wm8904 based audio machine driver">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Linux Sound &mdash; Re: [PATCH] ASoC: atmel: add wm8904 based audio machine driver</title>
<link rel="alternate" type="application/rss+xml" title="Linux Sound" href="//feeds.feedburner.com/LinuxSound">
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:6612422167" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH] ASoC: atmel: add wm8904 based audio machine driver</h1>
[<a href="msg00347.html">Date Prev</a>][<a href="msg00349.html">Date Next</a>][<a href="msg00347.html">Thread Prev</a>][<a href="msg00349.html">Thread Next</a>][<a href="maillist.html#00348">Date Index</a>][<a href="index.html#00348">Thread Index</a>]
<script src="https://apis.google.com/js/platform.js" async defer></script>
<g:plusone size="small"></g:plusone>
<p>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH] ASoC: atmel: add wm8904 based audio machine driver</li>
<li><em>From</em>: Bo Shen &lt;<a href="mailto:voice.shen@DOMAIN.HIDDEN">voice.shen@xxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Fri, 19 Jul 2013 10:39:43 +0800</li>
<li><em>Cc</em>: &lt;<a href="mailto:nicolas.ferre@DOMAIN.HIDDEN">nicolas.ferre@xxxxxxxxx</a>&gt;, &lt;<a href="mailto:plagnioj@DOMAIN.HIDDEN">plagnioj@xxxxxxxxxxxx</a>&gt;,        &lt;<a href="mailto:linux-sound@DOMAIN.HIDDEN">linux-sound@xxxxxxxxxxxxxxx</a>&gt;, &lt;<a href="mailto:alsa-devel@DOMAIN.HIDDEN">alsa-devel@xxxxxxxxxxxxxxxx</a>&gt;,        &lt;<a href="mailto:linux-arm-kernel@DOMAIN.HIDDEN">linux-arm-kernel@xxxxxxxxxxxxxxxxxxx</a>&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg00347.html">20130718111709.GL22506@sirena.org.uk</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux x86_64; rv:17.0) Gecko/20130510 Thunderbird/17.0.6</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
Hi Mark,

On 07/18/2013 07:17 PM, Mark Brown wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On Thu, Jul 18, 2013 at 03:28:03PM +0800, Bo Shen wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
add wm8904 based audio machine driver

the following ek board based on it
   - at91sam9n12ek
   - sama5d3xek (d31, d33, d34, d35)

Signed-off-by: Bo Shen &lt;voice.shen@xxxxxxxxx&gt;
</pre></blockquote><pre style="margin: 0em;">

Looks pretty good, a few fairly small issues below.

The binding document should be CCed to devicetree-discuss for review.
</pre></blockquote><pre style="margin: 0em;">

OK, I will cc the devicetree-discuss next version.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
+	atmel,audio-routing =
+		&quot;Headphone Jack&quot;, &quot;HPOUTL&quot;,
+		&quot;Headphone Jack&quot;, &quot;HPOUTR&quot;,
+		&quot;IN2L&quot;, &quot;Line In Jack&quot;,
+		&quot;IN2R&quot;, &quot;Line In Jack&quot;,
+		&quot;Mic&quot;, &quot;MICBIAS&quot;,
+		&quot;IN1L&quot;, &quot;Mic&quot;;
</pre></blockquote><pre style="margin: 0em;">

The widgets defined by the board should be documented in this binding.
Those from the CODEC should be documented in the CODEC binding.
</pre></blockquote><pre style="margin: 0em;">

OK, I will separate this and put need information in this binding document.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
+#define MCLK_RATE 32768
+
+static struct clk *mclk;
</pre></blockquote><pre style="margin: 0em;">

This should be in driver data for the board.  Shouldn't the clock be
referenced using the clock bindings?
</pre></blockquote><pre style="margin: 0em;">

I will try to implement this in next version.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
+static int atmel_asoc_wm8904_init(struct snd_soc_pcm_runtime *rtd)
+{
+	struct snd_soc_dai *codec_dai = rtd-&gt;codec_dai;
+	int ret;
+
+	ret = snd_soc_dai_set_sysclk(codec_dai, WM8904_CLK_FLL,
+			12000000, SND_SOC_CLOCK_IN);
+	if (ret &lt; 0) {
+		pr_err(&quot;%s -failed to set wm8904 SYSCLK\n&quot;, __func__);
+		return ret;
+	}
</pre></blockquote><pre style="margin: 0em;">

This is an odd thing to set the clock rate to and limits the sample
rates the board can play back.  It would be better to set the clock rate
based on the requested sample rate in hw_params - you're using the FLL
so may as well take advantage of the ability it offers to support all
sample rates.
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
+static int atmel_asoc_wm8904_params(struct snd_pcm_substream *substream,
+		struct snd_pcm_hw_params *params)
+{
+	struct snd_soc_pcm_runtime *rtd = substream-&gt;private_data;
+	struct snd_soc_dai *codec_dai = rtd-&gt;codec_dai;
+	int ret;
+
+	ret = snd_soc_dai_set_pll(codec_dai, WM8904_FLL_MCLK, WM8904_FLL_MCLK,
+		32768, params_rate(params) * 256);
</pre></blockquote><pre style="margin: 0em;">

Ah, in fact you do actually do that - it'd be clearer to put the
set_sysclk() after this.
</pre></blockquote><pre style="margin: 0em;">

OK, I will put set_sysclk here.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
+	switch (level) {
+	case SND_SOC_BIAS_ON:
+	case SND_SOC_BIAS_PREPARE:
+		if (!mclk_on) {
+			ret = clk_prepare_enable(mclk);
+			if (ret == 0)
+				mclk_on = 1;
+		}
+		break;
+	case SND_SOC_BIAS_STANDBY:
+	case SND_SOC_BIAS_OFF:
+		if (mclk_on)
+			clk_disable_unprepare(mclk);
+		mclk_on = 0;
+		break;
+	}
</pre></blockquote><pre style="margin: 0em;">

It's better to write this using the previous state than to have the
mclk_on flag - you want to enable on the standby-&gt;prepare transition and
disable on the standby-&gt;off transition.
</pre></blockquote><pre style="margin: 0em;">

OK, I will implement it in next version.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
+static int atmel_asoc_wm8904_dt_init(struct platform_device *pdev)
+{
+	struct device_node *np = pdev-&gt;dev.of_node;
+	struct device_node *codec_np, *cpu_np;
+	struct snd_soc_card *card = &amp;atmel_asoc_wm8904_card;
+	struct snd_soc_dai_link *dailink = &amp;atmel_asoc_wm8904_dailink;
+	int ret;
+
+	if (!np)
+		return -1;
</pre></blockquote><pre style="margin: 0em;">

Return a real error code here.
</pre></blockquote><pre style="margin: 0em;">

Sure.

Thanks,

Best Reards,
Bo Shen


--
To unsubscribe from this list: send the line &quot;unsubscribe linux-sound&quot; in
the body of a message to majordomo@xxxxxxxxxxxxxxx
More majordomo info at  <a  rel="nofollow" href="http://vger.kernel.org/majordomo-info.html">http://vger.kernel.org/majordomo-info.html</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00349" href="msg00349.html">Re: [alsa-devel] [PATCH] ASoC: atmel: add wm8904 based audio machine driver</a></strong>
<ul><li><em>From:</em> Bo Shen</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00345" href="msg00345.html">[PATCH] ASoC: atmel: add wm8904 based audio machine driver</a></strong>
<ul><li><em>From:</em> Bo Shen</li></ul></li>
<li><strong><a name="00347" href="msg00347.html">Re: [PATCH] ASoC: atmel: add wm8904 based audio machine driver</a></strong>
<ul><li><em>From:</em> Mark Brown</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00347.html">Re: [PATCH] ASoC: atmel: add wm8904 based audio machine driver</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00349.html">Re: [alsa-devel] [PATCH] ASoC: atmel: add wm8904 based audio machine driver</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00347.html">Re: [PATCH] ASoC: atmel: add wm8904 based audio machine driver</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00349.html">Re: [alsa-devel] [PATCH] ASoC: atmel: add wm8904 based audio machine driver</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00348"><strong>Date</strong></a></li>
<li><a href="index.html#00348"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/Pulseaudio/>[Pulseaudio]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/alsa-devel/>[ALSA&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.html>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width="100%">
<tr>
<td valign=top align=left>&nbsp;</td>
<td valign=top align=right>
<a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr></table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

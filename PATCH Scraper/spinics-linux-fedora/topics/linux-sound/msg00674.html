<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH 1/4] aural error reporting framework -->
<!--X-From-R13: [nggrb Qebpr &#60;zpebprNerqung.pbz> -->
<!--X-Date: Mon, 1 Apr 2019 03:25:17 &#45;0700 -->
<!--X-Message-Id: 20190401102456.11162&#45;2&#45;mcroce@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190401102456.11162&#45;1&#45;mcroce@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Linux Sound: [PATCH 1/4] aural error reporting framework">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Linux Sound &mdash; [PATCH 1/4] aural error reporting framework</title>
<link rel="alternate" type="application/rss+xml" title="Linux Sound" href="//feeds.feedburner.com/LinuxSound">
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:6612422167" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH 1/4] aural error reporting framework</h1>
[<a href="msg00673.html">Date Prev</a>][<a href="msg00675.html">Date Next</a>][<a href="msg00673.html">Thread Prev</a>][<a href="msg00675.html">Thread Next</a>][<a href="maillist.html#00674">Date Index</a>][<a href="index.html#00674">Thread Index</a>]


<p>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH 1/4] aural error reporting framework</li>
<li><em>From</em>: Matteo Croce &lt;mcroce@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Mon,  1 Apr 2019 12:24:52 +0200</li>
<li><em>In-reply-to</em>: &lt;<a href="msg00673.html">20190401102456.11162-1-mcroce@redhat.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg00673.html">20190401102456.11162-1-mcroce@redhat.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>The Linux kernel has had verbal error reporting since the beginning.
Different error conditions trigger different error messages, with
different severity: from a simple warning to the most feared kernel panic.

While this detailed error reporting is much helpful to developers or end
users, there are some cases in which it's impossible to notice that an
error happened.
The most common case is headless devices, such as home servers without an
attached display, or routers without an exposed serial port. Needless
to say, logging into the machine via SSH is not an option after such
a severe error.
In other cases the monitor might be attached, but the system is unable to
display the error, probably because there is an X server running and
the KMS switch fails. Or simply the user is visually impaired.

These are all cases when the aural errors framework comes to help. This
framework adds to the kernel a generic library to play sounds, which can
be used to report errors or generic events.

As the sound card driver could, and most probably will, become unusable
during a kernel crash, the sounds are played via the system buzzer which
has been around since the dawn of time.
The buzzer driver is simple, requires just a few register writes to work,
the hardware is extremely cheap and is already present on most machines.

Signed-off-by: Matteo Croce &lt;mcroce@xxxxxxxxxx&gt;
---
 arch/x86/lib/Makefile |  1 +
 arch/x86/lib/play.c   | 75 +++++++++++++++++++++++++++++++++++++++++++
 include/linux/play.h  | 34 ++++++++++++++++++++
 lib/Kconfig.debug     |  5 +++
 4 files changed, 115 insertions(+)
 create mode 100644 arch/x86/lib/play.c
 create mode 100644 include/linux/play.h

diff --git a/arch/x86/lib/Makefile b/arch/x86/lib/Makefile
index 140e61843a07..fcd1ee6adfad 100644
--- a/arch/x86/lib/Makefile
+++ b/arch/x86/lib/Makefile
@@ -28,6 +28,7 @@ lib-$(CONFIG_INSTRUCTION_DECODER) += insn.o inat.o insn-eval.o
 lib-$(CONFIG_RANDOMIZE_BASE) += kaslr.o
 lib-$(CONFIG_FUNCTION_ERROR_INJECTION)	+= error-inject.o
 lib-$(CONFIG_RETPOLINE) += retpoline.o
+lib-$(CONFIG_PLAY_LIB) += play.o
 
 obj-y += msr.o msr-reg.o msr-reg-export.o hweight.o
 obj-y += iomem.o
diff --git a/arch/x86/lib/play.c b/arch/x86/lib/play.c
new file mode 100644
index 000000000000..e798eeb144f8
--- /dev/null
+++ b/arch/x86/lib/play.c
@@ -0,0 +1,75 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+/*
+ * Aural kernel panic - x86 implementation
+ *
+ * Copyright (C) 2019 Matteo Croce &lt;mcroce@xxxxxxxxxx&gt;
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License version
+ * 2 as published by the Free Software Foundation;
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ */
+
+#include &lt;linux/delay.h&gt;
+#include &lt;linux/timex.h&gt;
+#include &lt;linux/i8253.h&gt;
+#include &lt;linux/play.h&gt;
+#include &lt;asm/io.h&gt;
+
+#define CONTROL_WORD_REG	0x43
+#define COUNTER2		0x42
+#define SPEAKER_PORT		0x61
+
+void arch_play_one(unsigned int ms, unsigned int hz)
+{
+	unsigned long flags;
+	u8 p61;
+
+	/* filter out non audible by humans freqs */
+	if (hz &gt;= 16 &amp;&amp; hz &lt;= 22000) {
+		unsigned int count = PIT_TICK_RATE / hz;
+
+		raw_spin_lock_irqsave(&amp;i8253_lock, flags);
+
+		/* set buzzer
+		 * 0xB6
+		 * 1 0		Counter 2
+		 * 1 1		2xRD/2xWR bits 0..7, 8..15 of counter value
+		 * 0 1 1	Mode 3: Square Wave
+		 * 0		Counter is a 16 bit binary counter
+		 */
+		outb_p(0xB6, CONTROL_WORD_REG);
+
+		/* select desired HZ with two writes in counter 2, port 42h */
+		outb_p(count, COUNTER2);
+		outb_p(count &gt;&gt; 8, COUNTER2);
+
+		/* start beep
+		 * set bit 0-1 (0: SPEAKER DATA; 1: OUT2) of GATE2 (port 61h)
+		 */
+		p61 = inb_p(SPEAKER_PORT);
+		if ((p61 &amp; 3) != 3)
+			outb_p(p61 | 3, SPEAKER_PORT);
+
+		raw_spin_unlock_irqrestore(&amp;i8253_lock, flags);
+	}
+
+	msleep(ms * 9 / 10);
+
+	raw_spin_lock_irqsave(&amp;i8253_lock, flags);
+
+	/* stop beep
+	 * clear bit 0-1 of port 61h
+	 */
+	p61 = inb_p(SPEAKER_PORT);
+	if (p61 &amp; 3)
+		outb(p61 &amp; 0xFC, SPEAKER_PORT);
+
+	raw_spin_unlock_irqrestore(&amp;i8253_lock, flags);
+
+	msleep(ms / 10);
+}
diff --git a/include/linux/play.h b/include/linux/play.h
new file mode 100644
index 000000000000..ae30cb8a0c1d
--- /dev/null
+++ b/include/linux/play.h
@@ -0,0 +1,34 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+/*
+ * play.h - Definitions and headers for the aural error reporting framework.
+ *
+ * Copyright (C) 2019 Matteo Croce &lt;mcroce@xxxxxxxxxx&gt;
+ *
+ * This file is released under the GPLv2.
+ */
+
+#ifndef _LINUX_PLAY_H
+#define _LINUX_PLAY_H
+
+#ifdef CONFIG_PLAY_LIB
+
+struct note {
+	unsigned int freq;
+	unsigned int dur;
+};
+
+void arch_play_one(unsigned int ms, unsigned int hz);
+
+#define play(notes, len) do {						\
+		int i;							\
+		for (i = 0; i &lt; len; i++)				\
+			arch_play_one(notes[i].dur, notes[i].freq);	\
+	} while (0)
+
+#else
+
+#define play(n, l)
+
+#endif
+
+#endif
diff --git a/lib/Kconfig.debug b/lib/Kconfig.debug
index 0d9e81779e37..10d04b266aef 100644
--- a/lib/Kconfig.debug
+++ b/lib/Kconfig.debug
@@ -992,6 +992,11 @@ config PANIC_TIMEOUT
 	  value n &gt; 0 will wait n seconds before rebooting, while a timeout
 	  value n &lt; 0 will reboot immediately.
 
+config PLAY_LIB
+	bool
+	depends on HAVE_PCSPKR_PLATFORM
+	default n
+
 config SCHED_DEBUG
 	bool &quot;Collect scheduler debugging info&quot;
 	depends on DEBUG_KERNEL &amp;&amp; PROC_FS
-- 
2.20.1



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00673" href="msg00673.html">[PATCH 0/4] Introduce the aural error reporting framework</a></strong>
<ul><li><em>From:</em> Matteo Croce</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00673.html">[PATCH 0/4] Introduce the aural error reporting framework</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00675.html">[PATCH 2/4] panic: use the aural error reporting framework to report panics</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00673.html">[PATCH 0/4] Introduce the aural error reporting framework</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00675.html">[PATCH 2/4] panic: use the aural error reporting framework to report panics</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00674"><strong>Date</strong></a></li>
<li><a href="index.html#00674"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/Pulseaudio/>[Pulseaudio]</a>
&nbsp;
&nbsp;
<a href=/lists/linux-audio-users/>[Linux&nbsp;Audio&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/alsa-devel/>[ALSA&nbsp;Devel]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.html>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width="100%">
<tr>
<td valign=top align=left>&nbsp;</td>
<td valign=top align=right>
<a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr></table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

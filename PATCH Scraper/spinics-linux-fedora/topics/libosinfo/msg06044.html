<!-- MHonArc v2.6.19 -->
<!--X-Subject: [libosinfo PATCH v3 6/7] tree: Use libsoup for http://	&#38; https:// requests -->
<!--X-From-R13: =?GFT&#45;8?d?Tnovnab=20Tvq=Q3=OOapvb?= &#60;svqrapvbNerqung.pbz> -->
<!--X-Date: Tue, 16 Jul 2019 07:41:30 &#45;0700 -->
<!--X-Message-Id: 20190716144115.18612&#45;7&#45;fidencio@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190716144115.18612&#45;1&#45;fidencio@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<title>[libosinfo PATCH v3 6/7] tree: Use libsoup for http://	&amp; https:// requests &mdash; libosinfo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="libosinfo: [libosinfo PATCH v3 6/7] tree: Use libsoup for http://	&amp; https:// requests">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<link rel="alternate" type="application/rss+xml" title="libosinfo" href="//feeds.feedburner.com/libosinfo">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[libosinfo PATCH v3 6/7] tree: Use libsoup for http://	&amp; https:// requests</h1>
[<a href="msg06043.html">Date Prev</a>][<a href="msg06045.html">Date Next</a>][<a href="msg06047.html">Thread Prev</a>][<a href="msg06045.html">Thread Next</a>][<a href="maillist.html#06044">Date Index</a>][<a href="index.html#06044">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [libosinfo PATCH v3 6/7] tree: Use libsoup for http://	&amp; https:// requests</li>
<li><em>From</em>: Fabiano Fid&#xEA;ncio &lt;fidencio@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 16 Jul 2019 16:41:14 +0200</li>
<li><em>In-reply-to</em>: &lt;<a href="msg06038.html">20190716144115.18612-1-fidencio@redhat.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg06038.html">20190716144115.18612-1-fidencio@redhat.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>As osinfo_tree_create_from_location() handles non-local requests, it'd
end up relying on GVFS under the hood, which would cause this API to not
work when called from an app running as root.

In order to avoid this situation, let's rely on libsoup for this cases.

It's important to mention that glib minimum version has been bumped to
2.44 as that's the version where g_input_stream_read_all_async() has
been introuced.

<a  rel="nofollow" href="https://gitlab.com/libosinfo/libosinfo/issues/30">https://gitlab.com/libosinfo/libosinfo/issues/30</a>

Signed-off-by: Fabiano Fid&#xEA;ncio &lt;fidencio@xxxxxxxxxx&gt;
---
 configure.ac          |   4 +-
 osinfo/libosinfo.syms |   2 +
 osinfo/osinfo_tree.c  | 118 +++++++++++++++++++++++++++++++-----------
 osinfo/osinfo_tree.h  |  14 +++++
 4 files changed, 105 insertions(+), 33 deletions(-)

diff --git a/configure.ac b/configure.ac
index 02ea1df..0fde62c 100644
--- a/configure.ac
+++ b/configure.ac
@@ -37,8 +37,8 @@ m4_if(m4_version_compare([2.61a.100],
 m4_ifdef([AM_SILENT_RULES],[AM_SILENT_RULES([yes])])
 
 # Keep these two definitions in agreement.
-GLIB_MINIMUM_VERSION=&quot;2.38&quot;
-GLIB_ENCODED_VERSION=&quot;GLIB_VERSION_2_38&quot;
+GLIB_MINIMUM_VERSION=&quot;2.44&quot;
+GLIB_ENCODED_VERSION=&quot;GLIB_VERSION_2_44&quot;
 
 PKG_CHECK_MODULES([LIBXML], [libxml-2.0 &gt;= 2.6.0])
 PKG_CHECK_MODULES([LIBXSLT], [libxslt &gt;= 1.0.0])
diff --git a/osinfo/libosinfo.syms b/osinfo/libosinfo.syms
index 016d167..6d81e48 100644
--- a/osinfo/libosinfo.syms
+++ b/osinfo/libosinfo.syms
@@ -595,6 +595,8 @@ LIBOSINFO_1.6.0 {
 	osinfo_media_is_bootable;
 
 	osinfo_os_get_kernel_url_argument;
+
+	osinfo_tree_error_get_type;
 } LIBOSINFO_1.5.0;
 
 /* Symbols in next release...
diff --git a/osinfo/osinfo_tree.c b/osinfo/osinfo_tree.c
index 227f2c9..8e98f6c 100644
--- a/osinfo/osinfo_tree.c
+++ b/osinfo/osinfo_tree.c
@@ -26,14 +26,19 @@
 #include &lt;config.h&gt;
 
 #include &lt;osinfo/osinfo.h&gt;
+#include &quot;osinfo_util_private.h&quot;
 #include &lt;gio/gio.h&gt;
 #include &lt;stdlib.h&gt;
 #include &lt;string.h&gt;
 #include &lt;glib/gi18n-lib.h&gt;
+#include &lt;libsoup/soup.h&gt;
 
 typedef struct _CreateFromLocationAsyncData CreateFromLocationAsyncData;
 struct _CreateFromLocationAsyncData {
-    GFile *file;
+    SoupSession *session;
+    SoupMessage *message;
+
+    gchar *content;
     gchar *location;
     gchar *treeinfo;
 
@@ -42,7 +47,8 @@ struct _CreateFromLocationAsyncData {
 
 static void create_from_location_async_data_free(CreateFromLocationAsyncData *data)
 {
-    g_object_unref(data-&gt;file);
+    g_object_unref(data-&gt;session);
+    g_object_unref(data-&gt;message);
     g_object_unref(data-&gt;res);
 
     g_slice_free(CreateFromLocationAsyncData, data);
@@ -476,7 +482,7 @@ static void on_tree_create_from_location_ready(GObject *source_object,
  * @error: The location where to store any error, or %NULL
  *
  * Creates a new #OsinfoTree for installation tree at @location. The @location
- * could be any URI that GIO can handle or a local path.
+ * could be a http:// or a https:// URI.
  *
  * NOTE: Currently this only works for trees with a .treeinfo file
  *
@@ -653,24 +659,57 @@ static void
 osinfo_tree_create_from_location_async_helper(CreateFromLocationAsyncData *data,
                                               const gchar *treeinfo);
 
+static void on_content_read(GObject *source,
+                            GAsyncResult *res,
+                            gpointer user_data)
+{
+    CreateFromLocationAsyncData *data;
+    gsize length = 0;
+    GError *error = NULL;
+    OsinfoTree *ret;
+
+    data = (CreateFromLocationAsyncData *)user_data;
+
+    if (!g_input_stream_read_all_finish(G_INPUT_STREAM(source),
+                                        res,
+                                        &amp;length,
+                                        &amp;error)) {
+        g_prefix_error(&amp;error, _(&quot;Failed to load .treeinfo|treeinfo content: &quot;));
+        g_task_return_error(data-&gt;res, error);
+        create_from_location_async_data_free(data);
+    }
+
+    if (!(ret = load_keyinfo(data-&gt;location,
+                             data-&gt;content,
+                             length,
+                             &amp;error))) {
+        g_prefix_error(&amp;error, _(&quot;Failed to process keyinfo file: &quot;));
+        g_task_return_error(data-&gt;res, error);
+        goto cleanup;
+    }
+
+    g_task_return_pointer(data-&gt;res, ret, g_object_unref);
+
+ cleanup:
+    create_from_location_async_data_free(data);
+}
+
 static void on_location_read(GObject *source,
                              GAsyncResult *res,
                              gpointer user_data)
 {
     CreateFromLocationAsyncData *data;
     GError *error = NULL;
-    gchar *content = NULL;
-    gsize length = 0;
-    OsinfoTree *ret = NULL;
+    GInputStream *stream;
+    goffset content_size;
 
     data = (CreateFromLocationAsyncData *)user_data;
 
-    if (!g_file_load_contents_finish(G_FILE(source),
-                                     res,
-                                     &amp;content,
-                                     &amp;length,
-                                     NULL,
-                                     &amp;error)) {
+    stream = soup_session_send_finish(SOUP_SESSION(source),
+                                      res,
+                                      &amp;error);
+    if (stream == NULL ||
+        !SOUP_STATUS_IS_SUCCESSFUL(data-&gt;message-&gt;status_code)) {
         /* It means no &quot;.treeinfo&quot; file has been found. Try again, this time
          * looking for a &quot;treeinfo&quot; file. */
         if (g_str_equal(data-&gt;treeinfo, &quot;.treeinfo&quot;)) {
@@ -678,26 +717,28 @@ static void on_location_read(GObject *source,
             return;
         }
 
+        if (error == NULL) {
+            g_set_error_literal(&amp;error,
+                                OSINFO_TREE_ERROR,
+                                OSINFO_TREE_ERROR_NO_TREEINFO,
+                                soup_status_get_phrase(data-&gt;message-&gt;status_code));
+        }
         g_prefix_error(&amp;error, _(&quot;Failed to load .treeinfo|treeinfo file: &quot;));
         g_task_return_error(data-&gt;res, error);
         create_from_location_async_data_free(data);
         return;
     }
 
-    if (!(ret = load_keyinfo(data-&gt;location,
-                             content,
-                             length,
-                             &amp;error))) {
-        g_prefix_error(&amp;error, _(&quot;Failed to process keyinfo file: &quot;));
-        g_task_return_error(data-&gt;res, error);
-        goto cleanup;
-    }
-
-    g_task_return_pointer(data-&gt;res, ret, g_object_unref);
+    content_size = soup_message_headers_get_content_length(data-&gt;message-&gt;response_headers);
+    data-&gt;content = g_malloc0(content_size);
 
- cleanup:
-    create_from_location_async_data_free(data);
-    g_free(content);
+    g_input_stream_read_all_async(stream,
+                                  data-&gt;content,
+                                  content_size,
+                                  g_task_get_priority(data-&gt;res),
+                                  g_task_get_cancellable(data-&gt;res),
+                                  on_content_read,
+                                  data);
 }
 
 static void
@@ -708,18 +749,33 @@ osinfo_tree_create_from_location_async_helper(CreateFromLocationAsyncData *data,
 
     g_return_if_fail(treeinfo != NULL);
 
+    if (!osinfo_util_requires_soup(data-&gt;location)) {
+        GError *error = NULL;
+
+        g_set_error_literal(&amp;error,
+                            OSINFO_TREE_ERROR,
+                            OSINFO_TREE_ERROR_NOT_SUPPORTED_PROTOCOL,
+                            _(&quot;URL protocol is not supported&quot;));
+
+        g_task_return_error(data-&gt;res, error);
+    }
+
     location = g_strdup_printf(&quot;%s/%s&quot;, data-&gt;location, treeinfo);
 
-    g_clear_object(&amp;data-&gt;file);
-    data-&gt;file = g_file_new_for_uri(location);
+    if (data-&gt;session == NULL)
+        data-&gt;session = soup_session_new();
+
+    g_clear_object(&amp;data-&gt;message);
+    data-&gt;message = soup_message_new(&quot;GET&quot;, location);
 
     g_free(data-&gt;treeinfo);
     data-&gt;treeinfo = g_strdup(treeinfo);
 
-    g_file_load_contents_async(data-&gt;file,
-                               g_task_get_cancellable(data-&gt;res),
-                               on_location_read,
-                               data);
+    soup_session_send_async(data-&gt;session,
+                            data-&gt;message,
+                            g_task_get_cancellable(data-&gt;res),
+                            on_location_read,
+                            data);
     g_free(location);
 }
 
diff --git a/osinfo/osinfo_tree.h b/osinfo/osinfo_tree.h
index 661d06b..c13159b 100644
--- a/osinfo/osinfo_tree.h
+++ b/osinfo/osinfo_tree.h
@@ -35,6 +35,20 @@ osinfo_tree_error_quark (void) G_GNUC_CONST;
 
 #define OSINFO_TREE_ERROR (osinfo_tree_error_quark ())
 
+/**
+ * OsinfoTreeError:
+ * Since: 1.6.0
+ * @OSINFO_TREE_ERROR_NO_TREEINFO: No treeinfo found;
+ * @OSINFO_TREE_ERROR_NOT_SUPPORTED_PROTOCOL: The URL protocol is not supported.
+ *
+ * #GError codes used for errors in the #OSINFO_TREE_ERROR domain, during
+ * reading the treeinfo from a URI.
+ */
+typedef enum {
+    OSINFO_TREE_ERROR_NO_TREEINFO,
+    OSINFO_TREE_ERROR_NOT_SUPPORTED_PROTOCOL
+} OsinfoTreeError;
+
 
 /*
  * Type macros.
-- 
2.21.0

_______________________________________________
Libosinfo mailing list
Libosinfo@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libosinfo">https://www.redhat.com/mailman/listinfo/libosinfo</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg06043.html">[libosinfo PATCH v3 5/7] media: Use libsoup for http://	&amp; https:// requests</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg06045.html">[libosinfo PATCH v3 7/7] spec: Drop gvfs dependency</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg06047.html">Re:  [libosinfo PATCH v3 5/7] media: Use libsoup for http:// &amp; https:// requests</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg06045.html">[libosinfo PATCH v3 7/7] spec: Drop gvfs dependency</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#06044"><strong>Date</strong></a></li>
<li><a href="index.html#06044"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-maintainers/>[Fedora&nbsp;Maintainers]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.html>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

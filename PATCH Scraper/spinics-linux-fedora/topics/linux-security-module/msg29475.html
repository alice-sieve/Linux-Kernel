<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH v4 17/23] LSM: Use lsmcontext in security_secid_to_secctx -->
<!--X-From-R13: Qnfrl Epunhsyre &#60;pnfrlNfpunhsyre&#45;pn.pbz> -->
<!--X-Date: Thu, 27 Jun 2019 10:37:13 &#45;0700 -->
<!--X-Message-Id: e7b07964&#45;1f00&#45;b168&#45;de8c&#45;c63f7d2a1418@schaufler&#45;ca.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190626192234.11725&#45;1&#45;casey@schaufler&#45;ca.com -->
<!--X-Reference: 20190626192234.11725&#45;18&#45;casey@schaufler&#45;ca.com -->
<!--X-Reference: 201906262051.59B064019F@keescook -->
<!--X-Reference: cacf9eda&#45;7486&#45;80d3&#45;f47d&#45;b0dbb6872091@schaufler&#45;ca.com -->
<!--X-Reference: 201906271007.4248A3AE@keescook -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Linux Security Module, Re: [PATCH v4 17/23] LSM: Use lsmcontext in security_secid_to_secctx">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Linux Security Module -- Re: [PATCH v4 17/23] LSM: Use lsmcontext in security_secid_to_secctx</title>
<link rel="alternate" type="application/rss+xml" title="Linux Security Module" href="//feeds.feedburner.com/LinuxSecurityModule">
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH v4 17/23] LSM: Use lsmcontext in security_secid_to_secctx</h1>
[<a href="msg29474.html">Date Prev</a>][<a href="msg29476.html">Date Next</a>][<a href="msg29474.html">Thread Prev</a>][<a href="msg29494.html">Thread Next</a>][<a href="maillist.html#29475">Date Index</a>][<a href="index.html#29475">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH v4 17/23] LSM: Use lsmcontext in security_secid_to_secctx</li>
<li><em>From</em>: Casey Schaufler &lt;casey@xxxxxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 27 Jun 2019 10:36:57 -0700</li>
<li><em>Cc</em>: casey.schaufler@xxxxxxxxx, jmorris@xxxxxxxxx,        linux-security-module@xxxxxxxxxxxxxxx, selinux@xxxxxxxxxxxxxxx,        john.johansen@xxxxxxxxxxxxx, penguin-kernel@xxxxxxxxxxxxxxxxxxx,        paul@xxxxxxxxxxxxxx, sds@xxxxxxxxxxxxx, casey@xxxxxxxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;201906271007.4248A3AE@keescook&gt;</li>
<li><em>Openpgp</em>: preference=signencrypt</li>
<li><em>References</em>: &lt;<a href="msg29370.html">20190626192234.11725-1-casey@schaufler-ca.com</a>&gt; &lt;<a href="msg29386.html">20190626192234.11725-18-casey@schaufler-ca.com</a>&gt; &lt;201906262051.59B064019F@keescook&gt; &lt;<a href="msg29470.html">cacf9eda-7486-80d3-f47d-b0dbb6872091@schaufler-ca.com</a>&gt; &lt;201906271007.4248A3AE@keescook&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:60.0) Gecko/20100101 Thunderbird/60.7.2</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On 6/27/2019 10:17 AM, Kees Cook wrote:
&gt; On Thu, Jun 27, 2019 at 09:29:25AM -0700, Casey Schaufler wrote:
&gt;&gt; On 6/26/2019 8:53 PM, Kees Cook wrote:
&gt;&gt;&gt; On Wed, Jun 26, 2019 at 12:22:28PM -0700, Casey Schaufler wrote:
&gt;&gt;&gt;&gt; Replace the (secctx,seclen) pointer pair with a single
&gt;&gt;&gt;&gt; lsmcontext pointer to allow return of the LSM identifier
&gt;&gt;&gt;&gt; along with the context and context length. This allows
&gt;&gt;&gt;&gt; security_release_secctx() to know how to release the
&gt;&gt;&gt;&gt; context. Callers have been modified to use or save the
&gt;&gt;&gt;&gt; returned data from the new structure.
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Signed-off-by: Casey Schaufler &lt;casey@xxxxxxxxxxxxxxxx&gt;
&gt;&gt;&gt;&gt; ---
&gt;&gt;&gt;&gt;  drivers/android/binder.c                | 24 ++++++---------
&gt;&gt;&gt;&gt;  include/linux/security.h                |  4 +--
&gt;&gt;&gt;&gt;  include/net/scm.h                       |  9 ++----
&gt;&gt;&gt;&gt;  kernel/audit.c                          | 29 +++++++-----------
&gt;&gt;&gt;&gt;  kernel/auditsc.c                        | 31 +++++++------------
&gt;&gt;&gt;&gt;  net/ipv4/ip_sockglue.c                  |  7 ++---
&gt;&gt;&gt;&gt;  net/netfilter/nf_conntrack_netlink.c    | 14 +++++----
&gt;&gt;&gt;&gt;  net/netfilter/nf_conntrack_standalone.c |  7 ++---
&gt;&gt;&gt;&gt;  net/netfilter/nfnetlink_queue.c         |  5 +++-
&gt;&gt;&gt;&gt;  net/netlabel/netlabel_unlabeled.c       | 40 ++++++++-----------------
&gt;&gt;&gt;&gt;  net/netlabel/netlabel_user.c            |  7 ++---
&gt;&gt;&gt;&gt;  security/security.c                     |  9 ++++--
&gt;&gt;&gt;&gt;  12 files changed, 72 insertions(+), 114 deletions(-)
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; diff --git a/drivers/android/binder.c b/drivers/android/binder.c
&gt;&gt;&gt;&gt; index 89e574be34cc..5d417a7b9bb3 100644
&gt;&gt;&gt;&gt; --- a/drivers/android/binder.c
&gt;&gt;&gt;&gt; +++ b/drivers/android/binder.c
&gt;&gt;&gt;&gt; @@ -2874,9 +2874,7 @@ static void binder_transaction(struct binder_proc *proc,
&gt;&gt;&gt;&gt;  	binder_size_t last_fixup_min_off = 0;
&gt;&gt;&gt;&gt;  	struct binder_context *context = proc-&gt;context;
&gt;&gt;&gt;&gt;  	int t_debug_id = atomic_inc_return(&amp;binder_last_id);
&gt;&gt;&gt;&gt; -	char *secctx = NULL;
&gt;&gt;&gt;&gt; -	u32 secctx_sz = 0;
&gt;&gt;&gt;&gt; -	struct lsmcontext scaff; /* scaffolding */
&gt;&gt;&gt;&gt; +	struct lsmcontext lsmctx;
&gt;&gt;&gt; As James found, this needs to be zero initialized:
&gt;&gt;&gt;
&gt;&gt;&gt; struct lsmcontext lsmctx = { };
&gt;&gt; Thanks! I'll incorporate this in v5. It's great to
&gt;&gt; have y'all checking it out.
&gt; I looked through other removed NULL assignments, and I think I see some
&gt; other issues...
&gt;
&gt;                 binder_alloc_copy_to_buffer(&amp;target_proc-&gt;alloc,
&gt;                                             t-&gt;buffer, buf_offset,
&gt; -                                           secctx, secctx_sz);
&gt; -               security_release_secctx(secctx, secctx_sz);
&gt; -               secctx = NULL;
&gt; +                                           lsmctx.context, lsmctx.len);
&gt; +               security_release_secctx(&amp;lsmctx);
&gt;
&gt; The new security_release_secctx() performs the zeroing if there is a
&gt; slot match... should it be unconditional? (And should the no-op version
&gt; also zero?)

I don't see a reason not to zero in all cases. I'll change that.

&gt;
&gt; @@ -2420,8 +2420,7 @@ nfsd4_encode_fattr(struct xdr_stream *xdr, struct
&gt; svc_fh *fhp,
&gt;         __be32 status;
&gt;         int err;
&gt;         struct nfs4_acl *acl = NULL;
&gt; -       void *context = NULL;
&gt; -       int contextlen;
&gt; +       struct lsmcontext context;
&gt;
&gt; This needs the same = { } to retain the same meaning.

I'm going to have security_secid_to_secctx() initialize
the lsmcontext. There's no case where it should be used
to update an existing context, and it makes more sense to
do it in one place than to make all the callers worry
about it.

&gt; And here:
&gt;
&gt; @@ -1191,8 +1191,8 @@ static int audit_receive_msg(struct sk_buff *skb,
&gt; struct nlmsghdr *nlh)
&gt;         struct audit_buffer     *ab;
&gt;         u16                     msg_type = nlh-&gt;nlmsg_type;
&gt;         struct audit_sig_info   *sig_data;
&gt; -       char                    *ctx = NULL;
&gt;         u32                     len;
&gt; +       struct lsmcontext       context;
&gt;
&gt; And here:
&gt;
&gt; @@ -2069,24 +2070,23 @@ void audit_log_key(struct audit_buffer *ab, char
&gt; *key)
&gt;  
&gt;  int audit_log_task_context(struct audit_buffer *ab)
&gt;  {
&gt; -       char *ctx = NULL;
&gt; -       unsigned len;
&gt;         int error;
&gt; -       u32 sid;
&gt; +       struct lsmblob le;
&gt; +       struct lsmcontext context;
&gt;
&gt; and here:
&gt;
&gt;  static int audit_log_pid_context(struct audit_context *context, pid_t
&gt; pid,
&gt; -                                kuid_t auid, kuid_t uid, unsigned int
&gt;                                  sessionid,
&gt; -                                u32 sid, char *comm)
&gt; +                                kuid_t auid, kuid_t uid,
&gt; +                                unsigned int sessionid,
&gt; +                                struct lsmblob *l, char *comm)
&gt;  {
&gt;         struct audit_buffer *ab;
&gt; -       char *ctx = NULL;
&gt; -       u32 len;
&gt; +       struct lsmcontext lsmctx;
&gt;
&gt; Maybe here?
&gt;
&gt; -               if (osid) {
&gt; -                       char *ctx = NULL;
&gt; -                       u32 len;
&gt; -                       if (security_secid_to_secctx(osid, &amp;ctx, &amp;len))
&gt;                         {
&gt; -                               audit_log_format(ab, &quot; osid=%u&quot;, osid);
&gt; +               if (lsmblob_is_set(olsm)) {
&gt; +                       struct lsmcontext lsmcxt;
&gt; +                       if (security_secid_to_secctx(olsm, &amp;lsmcxt))
&gt;                                 *call_panic = 1;
&gt;
&gt; and:
&gt;
&gt; -       if (n-&gt;osid != 0) {
&gt; -               char *ctx = NULL;
&gt; -               u32 len;
&gt; +       if (lsmblob_is_set(&amp;n-&gt;olsm)) {
&gt; +               struct lsmcontext lsmctx;
&gt;  
&gt;
&gt; and:
&gt;
&gt; @@ -395,7 +401,7 @@ nfqnl_build_packet_message(struct net *net, struct
&gt; nfqnl_instance *queue,
&gt;         enum ip_conntrack_info uninitialized_var(ctinfo);
&gt;         struct nfnl_ct_hook *nfnl_ct;
&gt;         bool csum_verify;
&gt; -       char *secdata = NULL;
&gt; +       struct lsmcontext context;
&gt;
&gt; and:
&gt;
&gt; @@ -387,8 +387,7 @@ int netlbl_unlhsh_add(struct net *net,
&gt;         struct net_device *dev;
&gt;         struct netlbl_unlhsh_iface *iface;
&gt;         struct audit_buffer *audit_buf = NULL;
&gt; -       char *secctx = NULL;
&gt; -       u32 secctx_len;
&gt; +       struct lsmcontext context;
&gt;
&gt;
&gt; Sorry I forgot to check those the first time through!
&gt;




</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="29370" href="msg29370.html">[PATCH v4 00/23] LSM: Module stacking for AppArmor</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29386" href="msg29386.html">[PATCH v4 17/23] LSM: Use lsmcontext in security_secid_to_secctx</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29443" href="msg29443.html">Re: [PATCH v4 17/23] LSM: Use lsmcontext in security_secid_to_secctx</a></strong>
<ul><li><em>From:</em> Kees Cook</li></ul></li>
<li><strong><a name="29470" href="msg29470.html">Re: [PATCH v4 17/23] LSM: Use lsmcontext in security_secid_to_secctx</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29474" href="msg29474.html">Re: [PATCH v4 17/23] LSM: Use lsmcontext in security_secid_to_secctx</a></strong>
<ul><li><em>From:</em> Kees Cook</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg29474.html">Re: [PATCH v4 17/23] LSM: Use lsmcontext in security_secid_to_secctx</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg29476.html">Re: [PATCH v4 04/23] LSM: Create and manage the lsmblob data structure.</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg29474.html">Re: [PATCH v4 17/23] LSM: Use lsmcontext in security_secid_to_secctx</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg29494.html">Re: [PATCH v4 17/23] LSM: Use lsmcontext in security_secid_to_secctx</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#29475"><strong>Date</strong></a></li>
<li><a href="index.html#29475"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

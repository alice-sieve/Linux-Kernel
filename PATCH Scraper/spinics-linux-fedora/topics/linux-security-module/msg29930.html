<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH V35 26/29] debugfs: Restrict debugfs when the kernel is locked down -->
<!--X-From-R13: [nggurj Uneergg &#60;znggurjtneerggNtbbtyr.pbz> -->
<!--X-Date: Mon, 15 Jul 2019 13:02:16 &#45;0700 -->
<!--X-Message-Id: 20190715195946.223443&#45;27&#45;matthewgarrett@google.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190715195946.223443&#45;1&#45;matthewgarrett@google.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Linux Security Module, [PATCH V35 26/29] debugfs: Restrict debugfs when the kernel is locked down">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Linux Security Module -- [PATCH V35 26/29] debugfs: Restrict debugfs when the kernel is locked down</title>
<link rel="alternate" type="application/rss+xml" title="Linux Security Module" href="//feeds.feedburner.com/LinuxSecurityModule">
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH V35 26/29] debugfs: Restrict debugfs when the kernel is locked down</h1>
[<a href="msg29929.html">Date Prev</a>][<a href="msg29931.html">Date Next</a>][<a href="msg29929.html">Thread Prev</a>][<a href="msg29949.html">Thread Next</a>][<a href="maillist.html#29930">Date Index</a>][<a href="index.html#29930">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH V35 26/29] debugfs: Restrict debugfs when the kernel is locked down</li>
<li><em>From</em>: Matthew Garrett &lt;matthewgarrett@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Mon, 15 Jul 2019 12:59:43 -0700</li>
<li><em>Cc</em>: linux-security-module@xxxxxxxxxxxxxxx, linux-kernel@xxxxxxxxxxxxxxx,        linux-api@xxxxxxxxxxxxxxx, David Howells &lt;dhowells@xxxxxxxxxx&gt;,        Andy Shevchenko &lt;andy.shevchenko@xxxxxxxxx&gt;,        acpi4asus-user@xxxxxxxxxxxxxxxxxxxxx,        platform-driver-x86@xxxxxxxxxxxxxxx,        Matthew Garrett &lt;mjg59@xxxxxxxxxxxxx&gt;,        Thomas Gleixner &lt;tglx@xxxxxxxxxxxxx&gt;,        Matthew Garrett &lt;matthewgarrett@xxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg29916.html">20190715195946.223443-1-matthewgarrett@google.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg29916.html">20190715195946.223443-1-matthewgarrett@google.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>From: David Howells &lt;dhowells@xxxxxxxxxx&gt;

Disallow opening of debugfs files that might be used to muck around when
the kernel is locked down as various drivers give raw access to hardware
through debugfs.  Given the effort of auditing all 2000 or so files and
manually fixing each one as necessary, I've chosen to apply a heuristic
instead.  The following changes are made:

 (1) chmod and chown are disallowed on debugfs objects (though the root dir
     can be modified by mount and remount, but I'm not worried about that).

 (2) When the kernel is locked down, only files with the following criteria
     are permitted to be opened:

	- The file must have mode 00444
	- The file must not have ioctl methods
	- The file must not have mmap

 (3) When the kernel is locked down, files may only be opened for reading.

Normal device interaction should be done through configfs, sysfs or a
miscdev, not debugfs.

Note that this makes it unnecessary to specifically lock down show_dsts(),
show_devs() and show_call() in the asus-wmi driver.

I would actually prefer to lock down all files by default and have the
the files unlocked by the creator.  This is tricky to manage correctly,
though, as there are 19 creation functions and ~1600 call sites (some of
them in loops scanning tables).

Signed-off-by: David Howells &lt;dhowells@xxxxxxxxxx&gt;
cc: Andy Shevchenko &lt;andy.shevchenko@xxxxxxxxx&gt;
cc: acpi4asus-user@xxxxxxxxxxxxxxxxxxxxx
cc: platform-driver-x86@xxxxxxxxxxxxxxx
cc: Matthew Garrett &lt;mjg59@xxxxxxxxxxxxx&gt;
cc: Thomas Gleixner &lt;tglx@xxxxxxxxxxxxx&gt;
Signed-off-by: Matthew Garrett &lt;matthewgarrett@xxxxxxxxxx&gt;
---
 fs/debugfs/file.c            | 30 ++++++++++++++++++++++++++++++
 fs/debugfs/inode.c           | 32 ++++++++++++++++++++++++++++++--
 include/linux/security.h     |  1 +
 security/lockdown/lockdown.c |  1 +
 4 files changed, 62 insertions(+), 2 deletions(-)

diff --git a/fs/debugfs/file.c b/fs/debugfs/file.c
index 93e4ca6b2ad7..87846aad594b 100644
--- a/fs/debugfs/file.c
+++ b/fs/debugfs/file.c
@@ -19,6 +19,7 @@
 #include &lt;linux/atomic.h&gt;
 #include &lt;linux/device.h&gt;
 #include &lt;linux/poll.h&gt;
+#include &lt;linux/security.h&gt;
 
 #include &quot;internal.h&quot;
 
@@ -136,6 +137,25 @@ void debugfs_file_put(struct dentry *dentry)
 }
 EXPORT_SYMBOL_GPL(debugfs_file_put);
 
+/*
+ * Only permit access to world-readable files when the kernel is locked down.
+ * We also need to exclude any file that has ways to write or alter it as root
+ * can bypass the permissions check.
+ */
+static bool debugfs_is_locked_down(struct inode *inode,
+				   struct file *filp,
+				   const struct file_operations *real_fops)
+{
+	if ((inode-&gt;i_mode &amp; 07777) == 0444 &amp;&amp;
+	    !(filp-&gt;f_mode &amp; FMODE_WRITE) &amp;&amp;
+	    !real_fops-&gt;unlocked_ioctl &amp;&amp;
+	    !real_fops-&gt;compat_ioctl &amp;&amp;
+	    !real_fops-&gt;mmap)
+		return false;
+
+	return security_locked_down(LOCKDOWN_DEBUGFS);
+}
+
 static int open_proxy_open(struct inode *inode, struct file *filp)
 {
 	struct dentry *dentry = F_DENTRY(filp);
@@ -147,6 +167,11 @@ static int open_proxy_open(struct inode *inode, struct file *filp)
 		return r == -EIO ? -ENOENT : r;
 
 	real_fops = debugfs_real_fops(filp);
+
+	r = debugfs_is_locked_down(inode, filp, real_fops);
+	if (r)
+		goto out;
+
 	real_fops = fops_get(real_fops);
 	if (!real_fops) {
 		/* Huh? Module did not clean up after itself at exit? */
@@ -272,6 +297,11 @@ static int full_proxy_open(struct inode *inode, struct file *filp)
 		return r == -EIO ? -ENOENT : r;
 
 	real_fops = debugfs_real_fops(filp);
+
+	r = debugfs_is_locked_down(inode, filp, real_fops);
+	if (r)
+		goto out;
+
 	real_fops = fops_get(real_fops);
 	if (!real_fops) {
 		/* Huh? Module did not cleanup after itself at exit? */
diff --git a/fs/debugfs/inode.c b/fs/debugfs/inode.c
index 042b688ed124..7b975dbb2bb4 100644
--- a/fs/debugfs/inode.c
+++ b/fs/debugfs/inode.c
@@ -26,6 +26,7 @@
 #include &lt;linux/parser.h&gt;
 #include &lt;linux/magic.h&gt;
 #include &lt;linux/slab.h&gt;
+#include &lt;linux/security.h&gt;
 
 #include &quot;internal.h&quot;
 
@@ -35,6 +36,32 @@ static struct vfsmount *debugfs_mount;
 static int debugfs_mount_count;
 static bool debugfs_registered;
 
+/*
+ * Don't allow access attributes to be changed whilst the kernel is locked down
+ * so that we can use the file mode as part of a heuristic to determine whether
+ * to lock down individual files.
+ */
+static int debugfs_setattr(struct dentry *dentry, struct iattr *ia)
+{
+	int ret = security_locked_down(LOCKDOWN_DEBUGFS);
+
+	if (ret &amp;&amp; (ia-&gt;ia_valid &amp; (ATTR_MODE | ATTR_UID | ATTR_GID)))
+		return ret;
+	return simple_setattr(dentry, ia);
+}
+
+static const struct inode_operations debugfs_file_inode_operations = {
+	.setattr	= debugfs_setattr,
+};
+static const struct inode_operations debugfs_dir_inode_operations = {
+	.lookup		= simple_lookup,
+	.setattr	= debugfs_setattr,
+};
+static const struct inode_operations debugfs_symlink_inode_operations = {
+	.get_link	= simple_get_link,
+	.setattr	= debugfs_setattr,
+};
+
 static struct inode *debugfs_get_inode(struct super_block *sb)
 {
 	struct inode *inode = new_inode(sb);
@@ -369,6 +396,7 @@ static struct dentry *__debugfs_create_file(const char *name, umode_t mode,
 	inode-&gt;i_mode = mode;
 	inode-&gt;i_private = data;
 
+	inode-&gt;i_op = &amp;debugfs_file_inode_operations;
 	inode-&gt;i_fop = proxy_fops;
 	dentry-&gt;d_fsdata = (void *)((unsigned long)real_fops |
 				DEBUGFS_FSDATA_IS_REAL_FOPS_BIT);
@@ -532,7 +560,7 @@ struct dentry *debugfs_create_dir(const char *name, struct dentry *parent)
 	}
 
 	inode-&gt;i_mode = S_IFDIR | S_IRWXU | S_IRUGO | S_IXUGO;
-	inode-&gt;i_op = &amp;simple_dir_inode_operations;
+	inode-&gt;i_op = &amp;debugfs_dir_inode_operations;
 	inode-&gt;i_fop = &amp;simple_dir_operations;
 
 	/* directory inodes start off with i_nlink == 2 (for &quot;.&quot; entry) */
@@ -632,7 +660,7 @@ struct dentry *debugfs_create_symlink(const char *name, struct dentry *parent,
 		return failed_creating(dentry);
 	}
 	inode-&gt;i_mode = S_IFLNK | S_IRWXUGO;
-	inode-&gt;i_op = &amp;simple_symlink_inode_operations;
+	inode-&gt;i_op = &amp;debugfs_symlink_inode_operations;
 	inode-&gt;i_link = link;
 	d_instantiate(dentry, inode);
 	return end_creating(dentry);
diff --git a/include/linux/security.h b/include/linux/security.h
index 8ef366de70b0..d92323b44a3f 100644
--- a/include/linux/security.h
+++ b/include/linux/security.h
@@ -115,6 +115,7 @@ enum lockdown_reason {
 	LOCKDOWN_TIOCSSERIAL,
 	LOCKDOWN_MODULE_PARAMETERS,
 	LOCKDOWN_MMIOTRACE,
+	LOCKDOWN_DEBUGFS,
 	LOCKDOWN_INTEGRITY_MAX,
 	LOCKDOWN_KCORE,
 	LOCKDOWN_KPROBES,
diff --git a/security/lockdown/lockdown.c b/security/lockdown/lockdown.c
index e43c9d001e49..37ef46320ef4 100644
--- a/security/lockdown/lockdown.c
+++ b/security/lockdown/lockdown.c
@@ -30,6 +30,7 @@ static char *lockdown_reasons[LOCKDOWN_CONFIDENTIALITY_MAX+1] = {
 	[LOCKDOWN_TIOCSSERIAL] = &quot;reconfiguration of serial port IO&quot;,
 	[LOCKDOWN_MODULE_PARAMETERS] = &quot;unsafe module parameters&quot;,
 	[LOCKDOWN_MMIOTRACE] = &quot;unsafe mmio&quot;,
+	[LOCKDOWN_DEBUGFS] = &quot;debugfs access&quot;,
 	[LOCKDOWN_INTEGRITY_MAX] = &quot;integrity&quot;,
 	[LOCKDOWN_KCORE] = &quot;/proc/kcore access&quot;,
 	[LOCKDOWN_KPROBES] = &quot;use of kprobes&quot;,
-- 
2.22.0.510.g264f2c817a-goog



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="29949" href="msg29949.html">Re: [PATCH V35 26/29] debugfs: Restrict debugfs when the kernel is locked down</a></strong>
<ul><li><em>From:</em> James Morris</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="29916" href="msg29916.html">[PATCH V35 00/29] Kernel lockdown functionality</a></strong>
<ul><li><em>From:</em> Matthew Garrett</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg29929.html">[PATCH V35 24/29] Lock down perf when in confidentiality mode</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg29931.html">[PATCH V35 25/29] kexec: Allow kexec_file() with appropriate IMA policy when locked down</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg29929.html">[PATCH V35 24/29] Lock down perf when in confidentiality mode</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg29949.html">Re: [PATCH V35 26/29] debugfs: Restrict debugfs when the kernel is locked down</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#29930"><strong>Date</strong></a></li>
<li><a href="index.html#29930"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH v12 00/11] Appended signatures support for IMA appraisal -->
<!--X-From-R13: Fuvntb Xhat Pnhreznaa &#60;onhreznaNyvahk.voz.pbz> -->
<!--X-Date: Thu, 27 Jun 2019 19:20:09 &#45;0700 -->
<!--X-Message-Id: 20190628021934.4260&#45;1&#45;bauerman@linux.ibm.com -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Linux Security Module, [PATCH v12 00/11] Appended signatures support for IMA appraisal">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Linux Security Module -- [PATCH v12 00/11] Appended signatures support for IMA appraisal</title>
<link rel="alternate" type="application/rss+xml" title="Linux Security Module" href="//feeds.feedburner.com/LinuxSecurityModule">
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH v12 00/11] Appended signatures support for IMA appraisal</h1>
[<a href="msg29520.html">Date Prev</a>][<a href="msg29522.html">Date Next</a>][<a href="msg29511.html">Thread Prev</a>][<a href="msg29520.html">Thread Next</a>][<a href="maillist.html#29521">Date Index</a>][<a href="index.html#29521">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH v12 00/11] Appended signatures support for IMA appraisal</li>
<li><em>From</em>: Thiago Jung Bauermann &lt;bauerman@xxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 27 Jun 2019 23:19:23 -0300</li>
<li><em>Cc</em>: linux-security-module@xxxxxxxxxxxxxxx, keyrings@xxxxxxxxxxxxxxx,        linux-crypto@xxxxxxxxxxxxxxx, linuxppc-dev@xxxxxxxxxxxxxxxx,        linux-doc@xxxxxxxxxxxxxxx, linux-kernel@xxxxxxxxxxxxxxx,        Mimi Zohar &lt;zohar@xxxxxxxxxxxxx&gt;,        Dmitry Kasatkin &lt;dmitry.kasatkin@xxxxxxxxx&gt;,        James Morris &lt;jmorris@xxxxxxxxx&gt;, &quot;Serge E. Hallyn&quot; &lt;serge@xxxxxxxxxx&gt;,        David Howells &lt;dhowells@xxxxxxxxxx&gt;,        David Woodhouse &lt;dwmw2@xxxxxxxxxxxxx&gt;, Jessica Yu &lt;jeyu@xxxxxxxxxx&gt;,        Herbert Xu &lt;herbert@xxxxxxxxxxxxxxxxxxx&gt;,        &quot;David S. Miller&quot; &lt;davem@xxxxxxxxxxxxx&gt;,        Jonathan Corbet &lt;corbet@xxxxxxx&gt;,        &quot;AKASHI, Takahiro&quot; &lt;takahiro.akashi@xxxxxxxxxx&gt;,        Thiago Jung Bauermann &lt;bauerman@xxxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Hello,

This version is essentially identical to the last one.

It is only a rebase on top of today's linux-integrity/next-queued-testing,
prompted by conflicts with Prakhar Srivastava's patches to measure the
kernel command line. It also drops two patches that are already present in
that branch.

As I mentioned in an earlier email, I believe Mimi is happy with this
version but before she can accept it I still need acks from maintainers of
the module and asymmetric keys subsystems for the first three patches.

Many thanks to Mimi Zohar for her help with the development of this patch
series.

This patch which I sent earlier today needs to be applied first:

ima: Update MAX_TEMPLATE_NAME_LEN to fit largest reasonable definition

Original cover letter:

On the OpenPOWER platform, secure boot and trusted boot are being
implemented using IMA for taking measurements and verifying signatures.
Since the kernel image on Power servers is an ELF binary, kernels are
signed using the scripts/sign-file tool and thus use the same signature
format as signed kernel modules.

This patch series adds support in IMA for verifying those signatures.
It adds flexibility to OpenPOWER secure boot, because it allows it to boot
kernels with the signature appended to them as well as kernels where the
signature is stored in the IMA extended attribute.

Changes since v11:

- Patch &quot;integrity: Introduce struct evm_xattr&quot;
  - Dropped since it's already in linux-integrity/next-queued-testing.

- Patch &quot;ima: Use designated initializers for struct ima_event_data&quot;
  - Dropped since it's already in linux-integrity/next-queued-testing.

Changes since v10:

- Patch &quot;MODSIGN: Export module signature definitions&quot;
  - Moved config MODULE_SIG_FORMAT definition before its use. Suggested by
    Mimi Zohar.
  - Added missing kerneldoc for @name parameter. Suggested by Mimi Zohar.

- Patch &quot;ima: Implement support for module-style appended signatures&quot;
  - Bugfix: don't check status variable when deciding whether to verify
    modsig in ima_appraise_measurement(). Suggested by Mimi Zohar.
  - Bugfix: verify the modsig in ima_appraise_measurement() if the xattr
    contains a digest. Suggested by Mimi Zohar.

- Patch &quot;ima: Define ima-modsig template&quot;
  - Renamed ima_modsig_serialize() to ima_get_raw_modsig().
  - Renamed check_current_template_modsig() to check_template_modsig().
  - Fixed outdated comment in ima_eventmodsig_init(). Suggested by Mimi
    Zohar.
  - Check either the global or the per-rule template when an appraisal rule
    allows modsig. Suggested by Mimi Zohar.

- Patch &quot;ima: Store the measurement again when appraising a modsig&quot;
  - Bugfix: Only re-measure file containing modsig if it was measured
    before.
  - Check for modsig-related fields in the template_desc obtained in
    process_measurement() which can be a per-rule template. Suggested by Mimi
    Zohar.

- Patch &quot;ima: Allow template= option for appraise rules as well&quot;
  - New patch. Suggested by Mimi Zohar.

Changes since v9:

- Patch &quot;MODSIGN: Export module signature definitions&quot;
  - Moved mod_check_sig() to a new file so that CONFIG_IMA_APPRAISE_MODSIG
    doesn't have to depend on CONFIG_MODULES.
  - Changed scripts/Makefile to build sign-file if CONFIG_MODULE_SIG_FORMAT
    is set.
  - Removed Mimi's Reviewed-by because of the changes in this version.

- Patch &quot;PKCS#7: Refactor verify_pkcs7_signature()&quot;
  - Don't add function pkcs7_get_message_sig() anymore, since it's not
    needed in the current version.

- Patch &quot;PKCS#7: Introduce pkcs7_get_digest()&quot;
  - Changed 'len' argument from 'u8 *' to 'u32 *'.
  - Added 'hash_algo' argument to obtain the algo used for the digest.
  - Don't check whether 'buf', 'len' and 'hash_algo' output arguments are NULL,
    since the function's only caller always sets them.
  - Removed Mimi's Reviewed-by because of the changes in this version.

- Patch &quot;integrity: Introduce asymmetric_sig_has_known_key()&quot;
  - Dropped.

- Patch &quot;integrity: Introduce integrity_keyring_from_id&quot;
  - Squashed into &quot;ima: Implement support for module-style appended signatures&quot;
  - Changed integrity_keyring_from_id() to a static function (suggested by Mimi
    Zohar).

- Patch &quot;ima: Introduce is_signed()&quot;
  - Dropped.

- Patch &quot;ima: Export func_tokens&quot;
  - Squashed into &quot;ima: Implement support for module-style appended signatures&quot;

- Patch &quot;ima: Use designated initializers for struct ima_event_data&quot;
  - New patch.

- Patch &quot;ima: Factor xattr_verify() out of ima_appraise_measurement()&quot;
  - New patch.

- Patch &quot;ima: Implement support for module-style appended signatures&quot;
  - Renamed 'struct modsig_hdr' to 'struct modsig'.
  - Added integrity_modsig_verify() to integrity/digsig.c so that it's not
    necessary to export integrity_keyring_from_id() (Suggested by Mimi Zohar).
  - Don't add functions ima_xattr_sig_known_key() and
    modsig_has_known_key() since they're not necessary anymore.
  - Added modsig argument to ima_appraise_measurement().
  - Verify modsig in a separate function called by ima_appraise_measurement().
  - Renamed ima_read_collect_modsig() to ima_read_modsig(), with a separate
    collect function added in patch &quot;ima: Collect modsig&quot; (suggested by Mimi
    Zohar).
  - In ima_read_modsig(), moved code saving of raw PKCS7 data to 'struct
    modsig' to patch &quot;ima: Collect modsig&quot;.
  - In ima_read_modsig(), moved all parts related to the modsig hash to
    patch &quot;ima: Collect modsig&quot;.
  - In ima_read_modsig(), don't check if the buf pointer is NULL since it's
    never supposed to happen.
  - Renamed ima_free_xattr_data() to ima_free_modsig().
  - No need to check for modsig in ima_read_xattr() and
    ima_inode_set_xattr() anymore.
  - In ima_modsig_verify(), don't check if the modsig pointer is NULL since
    it's not supposed to happen.
  - Don't define IMA_MODSIG element in enum evm_ima_xattr_type.

- Patch &quot;ima: Collect modsig&quot;
  - New patch.

- Patch &quot;ima: Define ima-modsig template&quot;
  - Patch renamed from &quot;ima: Add new &quot;d-sig&quot; template field&quot;
  - Renamed 'd-sig' template field to 'd-modsig'.
  - Added 'modsig' template field.
  - Added 'ima-modsig' defined template descriptor.
  - Renamed ima_modsig_serialize_data() to ima_modsig_serialize().
  - Renamed ima_get_modsig_hash() to ima_get_modsig_digest(). Also the
    function is a lot simpler now since what it used to do is now done in
    ima_collect_modsig() and pkcs7_get_digest().
  - Added check for failed modsig collection in ima_eventdigest_modsig_init().
  - Added modsig argument to ima_store_measurement().
  - Added 'modsig' field to struct ima_event_data.
  - Removed check for modsig == NULL in ima_get_modsig_digest() and in
    ima_modsig_serialize_data() since their callers already performs that
    check.
  - Moved check_current_template_modsig() to this patch, previously was in
    &quot;ima: Store the measurement again when appraising a modsig&quot;.

- Patch &quot;ima: Store the measurement again when appraising a modsig&quot;
  - Renamed ima_template_has_sig() to ima_template_has_modsig().
  - Added a change to ima_collect_measurement(), making it to call
    ima_collect_modsig() even if IMA_COLLECT is set in iint-&gt;flags.
  - Removed IMA_READ_MEASURE flag.
  - Renamed template_has_sig global variable to template_has_modsig.
  - Renamed find_sig_in_template() to find_modsig_in_template().


Thiago Jung Bauermann (11):
  MODSIGN: Export module signature definitions
  PKCS#7: Refactor verify_pkcs7_signature()
  PKCS#7: Introduce pkcs7_get_digest()
  integrity: Select CONFIG_KEYS instead of depending on it
  ima: Add modsig appraise_type option for module-style appended
    signatures
  ima: Factor xattr_verify() out of ima_appraise_measurement()
  ima: Implement support for module-style appended signatures
  ima: Collect modsig
  ima: Define ima-modsig template
  ima: Store the measurement again when appraising a modsig
  ima: Allow template= option for appraise rules as well

 Documentation/ABI/testing/ima_policy      |   6 +-
 Documentation/security/IMA-templates.rst  |   3 +
 certs/system_keyring.c                    |  61 +++++--
 crypto/asymmetric_keys/pkcs7_verify.c     |  33 ++++
 include/crypto/pkcs7.h                    |   4 +
 include/linux/module.h                    |   3 -
 include/linux/module_signature.h          |  44 +++++
 include/linux/verification.h              |  10 ++
 init/Kconfig                              |   6 +-
 kernel/Makefile                           |   1 +
 kernel/module.c                           |   1 +
 kernel/module_signature.c                 |  46 +++++
 kernel/module_signing.c                   |  56 +------
 scripts/Makefile                          |   2 +-
 security/integrity/Kconfig                |   2 +-
 security/integrity/digsig.c               |  43 ++++-
 security/integrity/ima/Kconfig            |  13 ++
 security/integrity/ima/Makefile           |   1 +
 security/integrity/ima/ima.h              |  60 ++++++-
 security/integrity/ima/ima_api.c          |  23 ++-
 security/integrity/ima/ima_appraise.c     | 194 ++++++++++++++--------
 security/integrity/ima/ima_main.c         |  24 ++-
 security/integrity/ima/ima_modsig.c       | 169 +++++++++++++++++++
 security/integrity/ima/ima_policy.c       |  68 +++++++-
 security/integrity/ima/ima_template.c     |  26 ++-
 security/integrity/ima/ima_template_lib.c |  64 ++++++-
 security/integrity/ima/ima_template_lib.h |   4 +
 security/integrity/integrity.h            |  20 +++
 28 files changed, 819 insertions(+), 168 deletions(-)
 create mode 100644 include/linux/module_signature.h
 create mode 100644 kernel/module_signature.c
 create mode 100644 security/integrity/ima/ima_modsig.c



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="29599" href="msg29599.html">Re: [PATCH v12 00/11] Appended signatures support for IMA appraisal</a></strong>
<ul><li><em>From:</em> Mimi Zohar</li></ul></li>
<li><strong><a name="29531" href="msg29531.html">[PATCH v12 03/11] PKCS#7: Introduce pkcs7_get_digest()</a></strong>
<ul><li><em>From:</em> Thiago Jung Bauermann</li></ul></li>
<li><strong><a name="29530" href="msg29530.html">[PATCH v12 06/11] ima: Factor xattr_verify() out of ima_appraise_measurement()</a></strong>
<ul><li><em>From:</em> Thiago Jung Bauermann</li></ul></li>
<li><strong><a name="29529" href="msg29529.html">[PATCH v12 10/11] ima: Store the measurement again when appraising a modsig</a></strong>
<ul><li><em>From:</em> Thiago Jung Bauermann</li></ul></li>
<li><strong><a name="29528" href="msg29528.html">[PATCH v12 11/11] ima: Allow template= option for appraise rules as well</a></strong>
<ul><li><em>From:</em> Thiago Jung Bauermann</li></ul></li>
<li><strong><a name="29527" href="msg29527.html">[PATCH v12 09/11] ima: Define ima-modsig template</a></strong>
<ul><li><em>From:</em> Thiago Jung Bauermann</li></ul></li>
<li><strong><a name="29526" href="msg29526.html">[PATCH v12 07/11] ima: Implement support for module-style appended signatures</a></strong>
<ul><li><em>From:</em> Thiago Jung Bauermann</li></ul></li>
<li><strong><a name="29525" href="msg29525.html">[PATCH v12 05/11] ima: Add modsig appraise_type option for module-style appended signatures</a></strong>
<ul><li><em>From:</em> Thiago Jung Bauermann</li></ul></li>
<li><strong><a name="29524" href="msg29524.html">[PATCH v12 08/11] ima: Collect modsig</a></strong>
<ul><li><em>From:</em> Thiago Jung Bauermann</li></ul></li>
<li><strong><a name="29523" href="msg29523.html">[PATCH v12 01/11] MODSIGN: Export module signature definitions</a></strong>
<ul><li><em>From:</em> Thiago Jung Bauermann</li></ul></li>
<li><strong><a name="29522" href="msg29522.html">[PATCH v12 04/11] integrity: Select CONFIG_KEYS instead of depending on it</a></strong>
<ul><li><em>From:</em> Thiago Jung Bauermann</li></ul></li>
<li><strong><a name="29520" href="msg29520.html">[PATCH v12 02/11] PKCS#7: Refactor verify_pkcs7_signature()</a></strong>
<ul><li><em>From:</em> Thiago Jung Bauermann</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg29520.html">[PATCH v12 02/11] PKCS#7: Refactor verify_pkcs7_signature()</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg29522.html">[PATCH v12 04/11] integrity: Select CONFIG_KEYS instead of depending on it</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg29511.html">[PATCH] ima: Update MAX_TEMPLATE_NAME_LEN to fit largest reasonable definition</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg29520.html">[PATCH v12 02/11] PKCS#7: Refactor verify_pkcs7_signature()</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#29521"><strong>Date</strong></a></li>
<li><a href="index.html#29521"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH v5 15/23] LSM: Specify which LSM to display -->
<!--X-From-R13: Egrcura Eznyyrl &#60;fqfNglpub.afn.tbi> -->
<!--X-Date: Tue, 9 Jul 2019 14:36:31 &#45;0700 -->
<!--X-Message-Id: c592f686&#45;e026&#45;642e&#45;b8b3&#45;bca08d0a0f05@tycho.nsa.gov -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190703212538.7383&#45;1&#45;casey@schaufler&#45;ca.com -->
<!--X-Reference: 20190703212538.7383&#45;16&#45;casey@schaufler&#45;ca.com -->
<!--X-Reference: 6f593ae9&#45;4c79&#45;7a04&#45;41a3&#45;c04ebd689658@tycho.nsa.gov -->
<!--X-Reference: a3537a96&#45;84d7&#45;ad82&#45;f76e&#45;af0f44331c1b@schaufler&#45;ca.com -->
<!--X-Reference: dbdcfb3d&#45;a88a&#45;67eb&#45;a100&#45;848f3335e9a3@tycho.nsa.gov -->
<!--X-Reference: 1d62a67c&#45;2096&#45;5d8b&#45;dad4&#45;2e1c1c0ebc06@schaufler&#45;ca.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Linux Security Module, Re: [PATCH v5 15/23] LSM: Specify which LSM to display">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Linux Security Module -- Re: [PATCH v5 15/23] LSM: Specify which LSM to display</title>
<link rel="alternate" type="application/rss+xml" title="Linux Security Module" href="//feeds.feedburner.com/LinuxSecurityModule">
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH v5 15/23] LSM: Specify which LSM to display</h1>
[<a href="msg29822.html">Date Prev</a>][<a href="msg29824.html">Date Next</a>][<a href="msg29821.html">Thread Prev</a>][<a href="msg30042.html">Thread Next</a>][<a href="maillist.html#29823">Date Index</a>][<a href="index.html#29823">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH v5 15/23] LSM: Specify which LSM to display</li>
<li><em>From</em>: Stephen Smalley &lt;sds@xxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 9 Jul 2019 17:34:17 -0400</li>
<li><em>Cc</em>: keescook@xxxxxxxxxxxx, john.johansen@xxxxxxxxxxxxx,        penguin-kernel@xxxxxxxxxxxxxxxxxxx, paul@xxxxxxxxxxxxxx,        &quot;linux-audit@xxxxxxxxxx&quot; &lt;linux-audit@xxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg29821.html">1d62a67c-2096-5d8b-dad4-2e1c1c0ebc06@schaufler-ca.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg29655.html">20190703212538.7383-1-casey@schaufler-ca.com</a>&gt; &lt;<a href="msg29666.html">20190703212538.7383-16-casey@schaufler-ca.com</a>&gt; &lt;<a href="msg29813.html">6f593ae9-4c79-7a04-41a3-c04ebd689658@tycho.nsa.gov</a>&gt; &lt;<a href="msg29814.html">a3537a96-84d7-ad82-f76e-af0f44331c1b@schaufler-ca.com</a>&gt; &lt;<a href="msg29815.html">dbdcfb3d-a88a-67eb-a100-848f3335e9a3@tycho.nsa.gov</a>&gt; &lt;<a href="msg29821.html">1d62a67c-2096-5d8b-dad4-2e1c1c0ebc06@schaufler-ca.com</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Thunderbird/60.7.0</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
On 7/9/19 5:18 PM, Casey Schaufler wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On 7/9/2019 11:12 AM, Stephen Smalley wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On 7/9/19 1:51 PM, Casey Schaufler wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On 7/9/2019 10:13 AM, Stephen Smalley wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On 7/3/19 5:25 PM, Casey Schaufler wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Create a new entry &quot;display&quot; in /proc/.../attr for controlling
which LSM security information is displayed for a process.
The name of an active LSM that supplies hooks for human readable
data may be written to &quot;display&quot; to set the value. The name of
the LSM currently in use can be read from &quot;display&quot;.
At this point there can only be one LSM capable of display
active. A helper function lsm_task_display() to get the display
slot for a task_struct.
</pre></blockquote><pre style="margin: 0em;">

As I explained previously, this is a security hole waiting to happen. It still permits a process to affect the output of audit, alter the result of reading or writing /proc/self/attr nodes even by setuid/setgid/file-caps/context-changing programs, alter the contexts generated in netlink messages delivered to other processes (I think?), and possibly other effects beyond affecting the process' own view of things.
</pre></blockquote><pre style="margin: 0em;">

I would very much like some feedback regarding which of the
possible formats for putting multiple subject contexts in
audit records would be preferred:

 &#xA0;&#xA0;&#xA0;&#xA0;lsm=selinux,subj=xyzzy_t lsm=smack,subj=Xyzzy
 &#xA0;&#xA0;&#xA0;&#xA0;lsm=selinux,smack subj=xyzzy_t,Xyzzy
 &#xA0;&#xA0;&#xA0;&#xA0;subj=&quot;selinux='xyzzy_t',smack='Xyzzy'&quot;
</pre></blockquote><pre style="margin: 0em;">

(cc'd linux-audit mailing list)

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

Or something else. Free bikeshedding!

I don't see how you have a problem with netlink. My look
at what's in the kernel didn't expose anything, but I am
willing to be educated.
</pre></blockquote><pre style="margin: 0em;">

I haven't traced through it in detail, but it wasn't clear to me that the security_secid_to_secctx() call always occurs in the context of the receiving process (and hence use its display value).&#xA0; If not, then the display of the sender can affect what is reported to the receiver; hence, there is a forgery concern similar to the binder issue.&#xA0; It would be cleaner if we didn't alter the default behavior of security_secid_to_secctx() and security_secctx_to_secid() and instead introduced new hooks for any case where we truly want the display to take effect.
</pre></blockquote><pre style="margin: 0em;">

If the context is generated by security_secid_to_secctx() we
retain the slot number of the module that created it in lsmcontext.
We have to to ensure it is released correctly. If the potential
issue you're describing for netlink does in fact occur, we can check
the slot in lsmcontext to verify that it is the same.

security_secid_to_secctx() is called nowhere in net/netlink,
at least not that grep finds. Where are you seeing this potential
problem?
</pre></blockquote><pre style="margin: 0em;">

Look under net/netfilter.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Before:
$ id
uid=1002(sds2) gid=1002(sds2) groups=1002(sds2) context=staff_u:staff_r:staff_t:s0-s0:c0.c1023
$ su
Password:
su: Authentication failure

syscall audit record:
type=SYSCALL msg=audit(07/09/2019 11:52:49.784:365) : arch=x86_64 syscall=openat
 &#xA0;&#xA0;success=no exit=EACCES(Permission denied) a0=0xffffff9c a1=0x560897e58e00 a2=O_
WRONLY a3=0x0 items=1 ppid=3258 pid=3781 auid=sds2 uid=sds2 gid=sds2 euid=root s
uid=root fsuid=root egid=sds2 sgid=sds2 fsgid=sds2 tty=pts2 ses=6 comm=su exe=/usr/bin/su subj=staff_u:staff_r:staff_t:s0-s0:c0.c1023 key=(null)

After:
$ id
uid=1002(sds2) gid=1002(sds2) groups=1002(sds2) context=staff_u:staff_r:staff_t:s0-s0:c0.c1023
$ echo apparmor &gt; /proc/self/attr/display
$ su
Password:
su: Authentication failure

audit record:
type=SYSCALL msg=audit(07/09/2019 12:05:32.402:406) : arch=x86_64 syscall=openat success=no exit=EACCES(Permission denied) a0=0xffffff9c a1=0x556b41e1ae00 a2=O_WRONLY a3=0x0 items=1 ppid=3258 pid=9426 auid=sds2 uid=sds2 gid=sds2 euid=root suid=root fsuid=root egid=sds2 sgid=sds2 fsgid=sds2 tty=pts2 ses=6 comm=su exe=/usr/bin/su subj==unconfined key=(null)

NB The subj= field of the SYSCALL audit record is longer accurate and is potentially under the control of a process that would not be authorized to set its subject label to that value by SELinux.
</pre></blockquote><pre style="margin: 0em;">

It's still accurate, it's just not complete. It's a matter
of how best to complete it.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

Now, let's play with userspace.

Before:
# id
uid=0(root) gid=0(root) groups=0(root) context=staff_u:staff_r:staff_t:s0-s0:c0.c1023
# passwd root
passwd: SELinux deny access due to security policy.

audit record:
type=USER_AVC msg=audit(07/09/2019 12:24:35.135:812) : pid=12693 uid=root auid=sds2 ses=7 subj=staff_u:staff_r:passwd_t:s0-s0:c0.c1023 msg='avc:&#xA0; denied&#xA0; { passwd } for scontext=staff_u:staff_r:staff_t:s0-s0:c0.c1023 tcontext=staff_u:staff_r:staff_t:s0-s0:c0.c1023 tclass=passwd permissive=0&#xA0; exe=/usr/bin/passwd sauid=root hostname=? addr=? terminal=pts/2'
type=USER_CHAUTHTOK msg=audit(07/09/2019 12:24:35.135:813) : pid=12693 uid=root auid=sds2 ses=7 subj=staff_u:staff_r:passwd_t:s0-s0:c0.c1023 msg='op=attempted-to-change-password id=root exe=/usr/bin/passwd hostname=moss-pluto.infosec.tycho.ncsc.mil addr=? terminal=pts/2 res=failed'

After:
# id
uid=0(root) gid=0(root) groups=0(root) context=staff_u:staff_r:staff_t:s0-s0:c0.c1023
# echo apparmor &gt; /proc/self/attr/display
# passwd root
passwd: SELinux deny access due to security policy.

audit record:
type=USER_CHAUTHTOK msg=audit(07/09/2019 12:28:41.349:832) : pid=13083 uid=root auid=sds2 ses=7 subj==unconfined msg='op=attempted-to-change-password id=root exe=/usr/bin/passwd hostname=moss-pluto.infosec.tycho.ncsc.mil addr=? terminal=pts/2 res=failed'

Here we again get the wrong value for subj= in the USER_CHAUTHTOK audit record, and we further lose the USER_AVC record entirely because it didn't even reach the point of the permission check due to not being able to get the caller context.

The situation gets worse if the caller can set things up such that it can set an attribute value for one security module that is valid and privileged with respect to another security module.&#xA0; This isn't a far-fetched scenario; AppArmor will default to running everything unconfined, so as soon as you enable it, any root process can potentially load a policy that defines contexts that look exactly like SELinux contexts. Smack is even simpler; you can set any arbitrary string you want as long as you are root (by default); no policy required.&#xA0; So a root process that is confined by SELinux (or by AppAmor) can suddenly forge arbitrary contexts in audit records or reads of /proc/self/attr nodes or netlink messages or ..., just by virtue of applying these patches and enabling another security module like Smack. Or consider if ptags were ever made real and merged - by design, that's all about setting arbitrary tags from userspace.&#xA0; Then there is the separate issue of switching
display to prevent attempts by a more privileged program to set one of its attributes from taking effect. Where have we seen that before - sendmail capabilities bug anyone?&#xA0; And it is actually worse than that bug, because with the assistance of a friendly security module, the write may actually succeed; it just won't alter the SELinux context of the program or anything it creates!

This gets a NAK from me so long as it has these issues and setting the display remains outside the control of any security module.
</pre></blockquote><pre style="margin: 0em;">

The issues you've raised around audit are meritorious.
Any suggestions regarding how to address them would be
quite welcome.

As far as the general objection to the display mechanism,
I am eager to understand what you might propose as an
alternative. We can't dismiss backward compatibility for
any of the modules. We can't preclude any module combination.

We can require user space changes for configurations that
were impossible before, just as the addition of SELinux to
a system required user space changes. Update libselinux
to check the display before using the attr interfaces and
you've addressed most of the issues.
</pre></blockquote><pre style="margin: 0em;">

Either we ensure that setting of the display can only affect processes in the same security equivalence class (same credentials)
</pre></blockquote><pre style="margin: 0em;">

In the process of trying to argue against your point I
may have come around to your thinking. There would still
be the case where a privileged program sets the display
and invokes an equally privileged program which is &quot;tricked&quot;
into setting the wrong attribute, but you have to put the
responsibility for use of privilege on someone, somewhere.

I will propose a solution in the next round.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
or the security modules need to be able to control who can set the display.
</pre></blockquote><pre style="margin: 0em;">

That's a mechanism for a module to opt-out of stacking,
and Paul has been pretty clear that he won't go for that.
</pre></blockquote><pre style="margin: 0em;">

</pre><tt>It doesn't have to be used that way; it can just be used to limit the 
</tt><tt>set of authorized processes that can set the display to e.g. trusted 
</tt><tt>container runtimes.
</tt><pre style="margin: 0em;">


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="30042" href="msg30042.html">Re: [PATCH v5 15/23] LSM: Specify which LSM to display</a></strong>
<ul><li><em>From:</em> John Johansen</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="29655" href="msg29655.html">[PATCH v5 00/23] LSM: Module stacking for AppArmor</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29666" href="msg29666.html">[PATCH v5 15/23] LSM: Specify which LSM to display</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29813" href="msg29813.html">Re: [PATCH v5 15/23] LSM: Specify which LSM to display</a></strong>
<ul><li><em>From:</em> Stephen Smalley</li></ul></li>
<li><strong><a name="29814" href="msg29814.html">Re: [PATCH v5 15/23] LSM: Specify which LSM to display</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29815" href="msg29815.html">Re: [PATCH v5 15/23] LSM: Specify which LSM to display</a></strong>
<ul><li><em>From:</em> Stephen Smalley</li></ul></li>
<li><strong><a name="29821" href="msg29821.html">Re: [PATCH v5 15/23] LSM: Specify which LSM to display</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg29822.html">Re: [RFC PATCH v3 4/4] x86/sgx: Implement SGX specific hooks in SELinux</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg29824.html">Re: [RFC PATCH v3 3/4] X86/sgx: Introduce EMA as a new LSM module</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg29821.html">Re: [PATCH v5 15/23] LSM: Specify which LSM to display</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg30042.html">Re: [PATCH v5 15/23] LSM: Specify which LSM to display</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#29823"><strong>Date</strong></a></li>
<li><a href="index.html#29823"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

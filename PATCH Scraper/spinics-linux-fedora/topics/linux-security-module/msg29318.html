<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH v3 21/24] Audit: Store LSM audit information in an lsmblob -->
<!--X-From-R13: Qnfrl Epunhsyre &#60;pnfrlNfpunhsyre&#45;pn.pbz> -->
<!--X-Date: Mon, 24 Jun 2019 18:01:11 &#45;0700 -->
<!--X-Message-Id: 0ad8f906&#45;16ff&#45;61af&#45;ce7c&#45;0ea1e9760d03@schaufler&#45;ca.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190621185233.6766&#45;1&#45;casey@schaufler&#45;ca.com -->
<!--X-Reference: 20190621185233.6766&#45;22&#45;casey@schaufler&#45;ca.com -->
<!--X-Reference: 79cd4a92&#45;c221&#45;eda4&#45;58ba&#45;730b5c2680d7@canonical.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Linux Security Module, Re: [PATCH v3 21/24] Audit: Store LSM audit information in an lsmblob">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Linux Security Module -- Re: [PATCH v3 21/24] Audit: Store LSM audit information in an lsmblob</title>
<link rel="alternate" type="application/rss+xml" title="Linux Security Module" href="//feeds.feedburner.com/LinuxSecurityModule">
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH v3 21/24] Audit: Store LSM audit information in an lsmblob</h1>
[<a href="msg29317.html">Date Prev</a>][<a href="msg29319.html">Date Next</a>][<a href="msg29301.html">Thread Prev</a>][<a href="msg29320.html">Thread Next</a>][<a href="maillist.html#29318">Date Index</a>][<a href="index.html#29318">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH v3 21/24] Audit: Store LSM audit information in an lsmblob</li>
<li><em>From</em>: Casey Schaufler &lt;casey@xxxxxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Mon, 24 Jun 2019 18:01:05 -0700</li>
<li><em>Cc</em>: keescook@xxxxxxxxxxxx, penguin-kernel@xxxxxxxxxxxxxxxxxxx,        paul@xxxxxxxxxxxxxx, sds@xxxxxxxxxxxxx, Eric Paris &lt;eparis@xxxxxxxxxx&gt;,        casey@xxxxxxxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg29301.html">79cd4a92-c221-eda4-58ba-730b5c2680d7@canonical.com</a>&gt;</li>
<li><em>Openpgp</em>: preference=signencrypt</li>
<li><em>References</em>: &lt;<a href="msg29154.html">20190621185233.6766-1-casey@schaufler-ca.com</a>&gt; &lt;<a href="msg29173.html">20190621185233.6766-22-casey@schaufler-ca.com</a>&gt; &lt;<a href="msg29301.html">79cd4a92-c221-eda4-58ba-730b5c2680d7@canonical.com</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:60.0) Gecko/20100101 Thunderbird/60.7.2</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On 6/24/2019 2:33 PM, John Johansen wrote:
&gt; On 6/21/19 11:52 AM, Casey Schaufler wrote:
&gt;&gt; Change the audit code to store full lsmblob data instead of
&gt;&gt; a single u32 secid. This allows for multiple security modules
&gt;&gt; to use the audit system at the same time. It also allows the
&gt;&gt; removal of scaffolding code that was included during the
&gt;&gt; revision of LSM interfaces.
&gt;&gt;
&gt;&gt; Signed-off-by: Casey Schaufler &lt;casey@xxxxxxxxxxxxxxxx&gt;
&gt; I know Kees raised this too, but I haven't seen a reply
&gt;
&gt; Eric (Paul is already CCed): I have directly added you because of
&gt; the question below.
&gt;
&gt; In summary there isn't necessarily a single secid any more, and
&gt; we need to know whether dropping the logging of the secid or
&gt; logging all secids is the correct action.

It is to be considered that this is an error case. If
everything is working normally you should have produced
a secctx previously, which you'll have included in the
audit record. Including the secid in the record ought to
be pointless, as the secid is strictly an internal token
with no meaning outside the running kernel. You are providing
no security relevant information by providing the secid.
I will grant the possibility that the secid might be useful
in debugging, but for that a pr_warn is more appropriate
than a field in the audit record.

&gt;
&gt;&gt; ---
&gt;&gt;  kernel/audit.h   |  6 +++---
&gt;&gt;  kernel/auditsc.c | 38 +++++++++++---------------------------
&gt;&gt;  2 files changed, 14 insertions(+), 30 deletions(-)
&gt;&gt;
&gt;&gt; diff --git a/kernel/audit.h b/kernel/audit.h
&gt;&gt; index 29e29c6f4afb..a8dd479e9556 100644
&gt;&gt; --- a/kernel/audit.h
&gt;&gt; +++ b/kernel/audit.h
&gt;&gt; @@ -91,7 +91,7 @@ struct audit_names {
&gt;&gt;  	kuid_t			uid;
&gt;&gt;  	kgid_t			gid;
&gt;&gt;  	dev_t			rdev;
&gt;&gt; -	u32			osid;
&gt;&gt; +	struct lsmblob		olsm;
&gt;&gt;  	struct audit_cap_data	fcap;
&gt;&gt;  	unsigned int		fcap_ver;
&gt;&gt;  	unsigned char		type;		/* record type */
&gt;&gt; @@ -148,7 +148,7 @@ struct audit_context {
&gt;&gt;  	kuid_t		    target_auid;
&gt;&gt;  	kuid_t		    target_uid;
&gt;&gt;  	unsigned int	    target_sessionid;
&gt;&gt; -	struct lsmblob   target_lsm;
&gt;&gt; +	struct lsmblob	    target_lsm;
&gt;&gt;  	char		    target_comm[TASK_COMM_LEN];
&gt;&gt;  
&gt;&gt;  	struct audit_tree_refs *trees, *first_trees;
&gt;&gt; @@ -165,7 +165,7 @@ struct audit_context {
&gt;&gt;  			kuid_t			uid;
&gt;&gt;  			kgid_t			gid;
&gt;&gt;  			umode_t			mode;
&gt;&gt; -			u32			osid;
&gt;&gt; +			struct lsmblob		olsm;
&gt;&gt;  			int			has_perm;
&gt;&gt;  			uid_t			perm_uid;
&gt;&gt;  			gid_t			perm_gid;
&gt;&gt; diff --git a/kernel/auditsc.c b/kernel/auditsc.c
&gt;&gt; index 0478680cd0a8..d3ad13f11788 100644
&gt;&gt; --- a/kernel/auditsc.c
&gt;&gt; +++ b/kernel/auditsc.c
&gt;&gt; @@ -646,17 +646,15 @@ static int audit_filter_rules(struct task_struct *tsk,
&gt;&gt;  			if (f-&gt;lsm_rule) {
&gt;&gt;  				/* Find files that match */
&gt;&gt;  				if (name) {
&gt;&gt; -					lsmblob_init(&amp;blob, name-&gt;osid);
&gt;&gt;  					result = security_audit_rule_match(
&gt;&gt; -								&amp;blob,
&gt;&gt; +								&amp;name-&gt;olsm,
&gt;&gt;  								f-&gt;type,
&gt;&gt;  								f-&gt;op,
&gt;&gt;  								f-&gt;lsm_rule);
&gt;&gt;  				} else if (ctx) {
&gt;&gt;  					list_for_each_entry(n, &amp;ctx-&gt;names_list, list) {
&gt;&gt; -						lsmblob_init(&amp;blob, n-&gt;osid);
&gt;&gt;  						if (security_audit_rule_match(
&gt;&gt; -								&amp;blob,
&gt;&gt; +								&amp;n-&gt;olsm,
&gt;&gt;  								f-&gt;type,
&gt;&gt;  								f-&gt;op,
&gt;&gt;  								f-&gt;lsm_rule)) {
&gt;&gt; @@ -668,8 +666,7 @@ static int audit_filter_rules(struct task_struct *tsk,
&gt;&gt;  				/* Find ipc objects that match */
&gt;&gt;  				if (!ctx || ctx-&gt;type != AUDIT_IPC)
&gt;&gt;  					break;
&gt;&gt; -				lsmblob_init(&amp;blob, ctx-&gt;ipc.osid);
&gt;&gt; -				if (security_audit_rule_match(&amp;blob,
&gt;&gt; +				if (security_audit_rule_match(&amp;ctx-&gt;ipc.olsm,
&gt;&gt;  							      f-&gt;type, f-&gt;op,
&gt;&gt;  							      f-&gt;lsm_rule))
&gt;&gt;  					++result;
&gt;&gt; @@ -1187,21 +1184,18 @@ static void show_special(struct audit_context *context, int *call_panic)
&gt;&gt;  				context-&gt;socketcall.args[i]);
&gt;&gt;  		break; }
&gt;&gt;  	case AUDIT_IPC: {
&gt;&gt; -		u32 osid = context-&gt;ipc.osid;
&gt;&gt; +		struct lsmblob *olsm = &amp;context-&gt;ipc.olsm;
&gt;&gt;  
&gt;&gt;  		audit_log_format(ab, &quot;ouid=%u ogid=%u mode=%#ho&quot;,
&gt;&gt;  				 from_kuid(&amp;init_user_ns, context-&gt;ipc.uid),
&gt;&gt;  				 from_kgid(&amp;init_user_ns, context-&gt;ipc.gid),
&gt;&gt;  				 context-&gt;ipc.mode);
&gt;&gt; -		if (osid) {
&gt;&gt; +		if (lsmblob_is_set(olsm)) {
&gt;&gt;  			struct lsmcontext lsmcxt;
&gt;&gt; -			struct lsmblob blob;
&gt;&gt;  
&gt;&gt; -			lsmblob_init(&amp;blob, osid);
&gt;&gt; -			if (security_secid_to_secctx(&amp;blob, &amp;lsmcxt)) {
&gt;&gt; -				audit_log_format(ab, &quot; osid=%u&quot;, osid);
&gt; I am not comfortable just dropping this I would think logging all secids is the
&gt; correct action here.
&gt;
&gt;
&gt;&gt; +			if (security_secid_to_secctx(olsm, &amp;lsmcxt))
&gt;&gt;  				*call_panic = 1;
&gt;&gt; -			} else {
&gt;&gt; +			else {
&gt;&gt;  				audit_log_format(ab, &quot; obj=%s&quot;, lsmcxt.context);
&gt;&gt;  				security_release_secctx(&amp;lsmcxt);
&gt;&gt;  			}
&gt;&gt; @@ -1346,13 +1340,10 @@ static void audit_log_name(struct audit_context *context, struct audit_names *n,
&gt;&gt;  				 from_kgid(&amp;init_user_ns, n-&gt;gid),
&gt;&gt;  				 MAJOR(n-&gt;rdev),
&gt;&gt;  				 MINOR(n-&gt;rdev));
&gt;&gt; -	if (n-&gt;osid != 0) {
&gt;&gt; -		struct lsmblob blob;
&gt;&gt; +	if (lsmblob_is_set(&amp;n-&gt;olsm)) {
&gt;&gt;  		struct lsmcontext lsmctx;
&gt;&gt;  
&gt;&gt; -		lsmblob_init(&amp;blob, n-&gt;osid);
&gt;&gt; -		if (security_secid_to_secctx(&amp;blob, &amp;lsmctx)) {
&gt;&gt; -			audit_log_format(ab, &quot; osid=%u&quot;, n-&gt;osid);
&gt; and here
&gt;
&gt;
&gt;&gt; +		if (security_secid_to_secctx(&amp;n-&gt;olsm, &amp;lsmctx)) {
&gt;&gt;  			if (call_panic)
&gt;&gt;  				*call_panic = 2;
&gt;&gt;  		} else {
&gt;&gt; @@ -1906,17 +1897,13 @@ static inline int audit_copy_fcaps(struct audit_names *name,
&gt;&gt;  void audit_copy_inode(struct audit_names *name, const struct dentry *dentry,
&gt;&gt;  		      struct inode *inode, unsigned int flags)
&gt;&gt;  {
&gt;&gt; -	struct lsmblob blob;
&gt;&gt; -
&gt;&gt;  	name-&gt;ino   = inode-&gt;i_ino;
&gt;&gt;  	name-&gt;dev   = inode-&gt;i_sb-&gt;s_dev;
&gt;&gt;  	name-&gt;mode  = inode-&gt;i_mode;
&gt;&gt;  	name-&gt;uid   = inode-&gt;i_uid;
&gt;&gt;  	name-&gt;gid   = inode-&gt;i_gid;
&gt;&gt;  	name-&gt;rdev  = inode-&gt;i_rdev;
&gt;&gt; -	security_inode_getsecid(inode, &amp;blob);
&gt;&gt; -	/* scaffolding until osid is updated */
&gt;&gt; -	name-&gt;osid = blob.secid[0];
&gt;&gt; +	security_inode_getsecid(inode, &amp;name-&gt;olsm);
&gt;&gt;  	if (flags &amp; AUDIT_INODE_NOEVAL) {
&gt;&gt;  		name-&gt;fcap_ver = -1;
&gt;&gt;  		return;
&gt;&gt; @@ -2266,14 +2253,11 @@ void __audit_mq_getsetattr(mqd_t mqdes, struct mq_attr *mqstat)
&gt;&gt;  void __audit_ipc_obj(struct kern_ipc_perm *ipcp)
&gt;&gt;  {
&gt;&gt;  	struct audit_context *context = audit_context();
&gt;&gt; -	struct lsmblob blob;
&gt;&gt;  	context-&gt;ipc.uid = ipcp-&gt;uid;
&gt;&gt;  	context-&gt;ipc.gid = ipcp-&gt;gid;
&gt;&gt;  	context-&gt;ipc.mode = ipcp-&gt;mode;
&gt;&gt;  	context-&gt;ipc.has_perm = 0;
&gt;&gt; -	security_ipc_getsecid(ipcp, &amp;blob);
&gt;&gt; -	/* scaffolding on the [0] - change &quot;osid&quot; to a lsmblob */
&gt;&gt; -	context-&gt;ipc.osid = blob.secid[0];
&gt;&gt; +	security_ipc_getsecid(ipcp, &amp;context-&gt;ipc.olsm);
&gt;&gt;  	context-&gt;type = AUDIT_IPC;
&gt;&gt;  }
&gt;&gt;  
&gt;&gt;




</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="29320" href="msg29320.html">Re: [PATCH v3 21/24] Audit: Store LSM audit information in an lsmblob</a></strong>
<ul><li><em>From:</em> Paul Moore</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="29154" href="msg29154.html">[PATCH v3 00/24] LSM: Module stacking for AppArmor</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29173" href="msg29173.html">[PATCH v3 21/24] Audit: Store LSM audit information in an lsmblob</a></strong>
<ul><li><em>From:</em> Casey Schaufler</li></ul></li>
<li><strong><a name="29301" href="msg29301.html">Re: [PATCH v3 21/24] Audit: Store LSM audit information in an lsmblob</a></strong>
<ul><li><em>From:</em> John Johansen</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg29317.html">Re: [PATCH V31 07/25] kexec_file: Restrict at runtime if the kernel is locked down</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg29319.html">Re: [PATCH V31 07/25] kexec_file: Restrict at runtime if the kernel is locked down</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg29301.html">Re: [PATCH v3 21/24] Audit: Store LSM audit information in an lsmblob</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg29320.html">Re: [PATCH v3 21/24] Audit: Store LSM audit information in an lsmblob</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#29318"><strong>Date</strong></a></li>
<li><a href="index.html#29318"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

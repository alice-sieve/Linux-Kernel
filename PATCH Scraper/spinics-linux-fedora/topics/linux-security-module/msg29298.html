<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re: [PATCH V34 23/29] bpf: Restrict bpf when kernel lockdown is in confidentiality mode -->
<!--X-From-R13: Rnavry Pbexznaa &#60;qnavryNvbtrneobk.arg> -->
<!--X-Date: Mon, 24 Jun 2019 14:22:28 &#45;0700 -->
<!--X-Message-Id: 7f36edf7&#45;3120&#45;975e&#45;b643&#45;3c0fa470bafd@iogearbox.net -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190622000358.19895&#45;1&#45;matthewgarrett@google.com -->
<!--X-Reference: 20190622000358.19895&#45;24&#45;matthewgarrett@google.com -->
<!--X-Reference: 739e21b5&#45;9559&#45;d588&#45;3542&#45;bf0bc81de1b2@iogearbox.net -->
<!--X-Reference: CACdnJuvR2bn3y3fYzg06GWXXgAGjgED2Dfa5g0oAwJ28qCCqBg@mail.gmail.com -->
<!--X-Reference: CALCETrWmZX3R1L88Gz9vLY68gcK8zSXL4cA4GqAzQoyqSR7rRQ@mail.gmail.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Linux Security Module, Re: [PATCH V34 23/29] bpf: Restrict bpf when kernel lockdown is in confidentiality mode">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Linux Security Module -- Re: [PATCH V34 23/29] bpf: Restrict bpf when kernel lockdown is in confidentiality mode</title>
<link rel="alternate" type="application/rss+xml" title="Linux Security Module" href="//feeds.feedburner.com/LinuxSecurityModule">
</head>
<body vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re: [PATCH V34 23/29] bpf: Restrict bpf when kernel lockdown is in confidentiality mode</h1>
[<a href="msg29297.html">Date Prev</a>][<a href="msg29299.html">Date Next</a>][<a href="msg29295.html">Thread Prev</a>][<a href="msg29300.html">Thread Next</a>][<a href="maillist.html#29298">Date Index</a>][<a href="index.html#29298">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re: [PATCH V34 23/29] bpf: Restrict bpf when kernel lockdown is in confidentiality mode</li>
<li><em>From</em>: Daniel Borkmann &lt;daniel@xxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Mon, 24 Jun 2019 22:59:57 +0200</li>
<li><em>Cc</em>: James Morris &lt;jmorris@xxxxxxxxx&gt;,        LSM List &lt;linux-security-module@xxxxxxxxxxxxxxx&gt;,        Linux Kernel Mailing List &lt;linux-kernel@xxxxxxxxxxxxxxx&gt;,        Linux API &lt;linux-api@xxxxxxxxxxxxxxx&gt;,        David Howells &lt;dhowells@xxxxxxxxxx&gt;,        Alexei Starovoitov &lt;alexei.starovoitov@xxxxxxxxx&gt;,        Network Development &lt;netdev@xxxxxxxxxxxxxxx&gt;,        Chun-Yi Lee &lt;jlee@xxxxxxxx&gt;, Jann Horn &lt;jannh@xxxxxxxxxx&gt;,        bpf@xxxxxxxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg29294.html">CALCETrWmZX3R1L88Gz9vLY68gcK8zSXL4cA4GqAzQoyqSR7rRQ@mail.gmail.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg29183.html">20190622000358.19895-1-matthewgarrett@google.com</a>&gt; &lt;<a href="msg29203.html">20190622000358.19895-24-matthewgarrett@google.com</a>&gt; &lt;<a href="msg29273.html">739e21b5-9559-d588-3542-bf0bc81de1b2@iogearbox.net</a>&gt; &lt;<a href="msg29292.html">CACdnJuvR2bn3y3fYzg06GWXXgAGjgED2Dfa5g0oAwJ28qCCqBg@mail.gmail.com</a>&gt; &lt;<a href="msg29294.html">CALCETrWmZX3R1L88Gz9vLY68gcK8zSXL4cA4GqAzQoyqSR7rRQ@mail.gmail.com</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Thunderbird/52.3.0</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On 06/24/2019 10:08 PM, Andy Lutomirski wrote:
&gt; On Mon, Jun 24, 2019 at 12:54 PM Matthew Garrett &lt;mjg59@xxxxxxxxxx&gt; wrote:
&gt;&gt; On Mon, Jun 24, 2019 at 8:37 AM Daniel Borkmann &lt;daniel@xxxxxxxxxxxxx&gt; wrote:
&gt;&gt;&gt; On 06/22/2019 02:03 AM, Matthew Garrett wrote:
&gt;&gt;&gt;&gt; From: David Howells &lt;dhowells@xxxxxxxxxx&gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; There are some bpf functions can be used to read kernel memory:
&gt;&gt;&gt;
&gt;&gt;&gt; Nit: that
&gt;&gt;
&gt;&gt; Fixed.
&gt;&gt;
&gt;&gt;&gt;&gt; bpf_probe_read, bpf_probe_write_user and bpf_trace_printk.  These allow
&gt;&gt;&gt;
&gt;&gt;&gt; Please explain how bpf_probe_write_user reads kernel memory ... ?!
&gt;&gt;
&gt;&gt; Ha.
&gt;&gt;
&gt;&gt;&gt;&gt; private keys in kernel memory (e.g. the hibernation image signing key) to
&gt;&gt;&gt;&gt; be read by an eBPF program and kernel memory to be altered without
&gt;&gt;&gt;
&gt;&gt;&gt; ... and while we're at it, also how they allow &quot;kernel memory to be
&gt;&gt;&gt; altered without restriction&quot;. I've been pointing this false statement
&gt;&gt;&gt; out long ago.
&gt;&gt;
&gt;&gt; Yup. How's the following description:
&gt;&gt;
&gt;&gt;     bpf: Restrict bpf when kernel lockdown is in confidentiality mode
&gt;&gt;
&gt;&gt;     There are some bpf functions that can be used to read kernel memory and
&gt;&gt;     exfiltrate it to userland: bpf_probe_read, bpf_probe_write_user and
&gt;&gt;     bpf_trace_printk.  These could be abused to (eg) allow private
&gt;&gt; keys in kernel
&gt;&gt;     memory to be leaked. Disable them if the kernel has been locked
&gt;&gt; down in confidentiality
&gt;&gt;     mode.
&gt; 
&gt; I'm confused.  I understand why we're restricting bpf_probe_read().
&gt; Why are we restricting bpf_probe_write_user() and bpf_trace_printk(),
&gt; though?

Agree, for example, bpf_probe_write_user() can never write into
kernel memory (only user one). Just thinking out loud, wouldn't it
be cleaner and more generic to perform this check at the actual function
which performs the kernel memory without faulting? All three of these
are in mm/maccess.c, and the very few occasions that override the
probe_kernel_read symbol are calling eventually into __probe_kernel_read(),
so this would catch all of them wrt lockdown restrictions. Otherwise
you'd need to keep tracking every bit of new code being merged that
calls into one of these, no? That way you only need to do it once like
below and are guaranteed that the check catches these in future as well.

Thanks,
Daniel

diff --git a/mm/maccess.c b/mm/maccess.c
index 482d4d6..2c8220f 100644
--- a/mm/maccess.c
+++ b/mm/maccess.c
@@ -29,6 +29,9 @@ long __probe_kernel_read(void *dst, const void *src, size_t size)
 	long ret;
 	mm_segment_t old_fs = get_fs();

+	if (security_locked_down(LOCKDOWN_KERNEL_READ))
+		return -EFAULT;
+
 	set_fs(KERNEL_DS);
 	pagefault_disable();
 	ret = __copy_from_user_inatomic(dst,
@@ -57,6 +60,9 @@ long __probe_kernel_write(void *dst, const void *src, size_t size)
 	long ret;
 	mm_segment_t old_fs = get_fs();

+	if (security_locked_down(LOCKDOWN_KERNEL_WRITE))
+		return -EFAULT;
+
 	set_fs(KERNEL_DS);
 	pagefault_disable();
 	ret = __copy_to_user_inatomic((__force void __user *)dst, src, size);
@@ -90,6 +96,9 @@ long strncpy_from_unsafe(char *dst, const void *unsafe_addr, long count)
 	const void *src = unsafe_addr;
 	long ret;

+	if (security_locked_down(LOCKDOWN_KERNEL_READ))
+		return -EFAULT;
+
 	if (unlikely(count &lt;= 0))
 		return 0;



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="29300" href="msg29300.html">Re: [PATCH V34 23/29] bpf: Restrict bpf when kernel lockdown is in confidentiality mode</a></strong>
<ul><li><em>From:</em> Matthew Garrett</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="29183" href="msg29183.html">[PATCH V34 00/29] Lockdown as an LSM</a></strong>
<ul><li><em>From:</em> Matthew Garrett</li></ul></li>
<li><strong><a name="29203" href="msg29203.html">[PATCH V34 23/29] bpf: Restrict bpf when kernel lockdown is in confidentiality mode</a></strong>
<ul><li><em>From:</em> Matthew Garrett</li></ul></li>
<li><strong><a name="29273" href="msg29273.html">Re: [PATCH V34 23/29] bpf: Restrict bpf when kernel lockdown is in confidentiality mode</a></strong>
<ul><li><em>From:</em> Daniel Borkmann</li></ul></li>
<li><strong><a name="29292" href="msg29292.html">Re: [PATCH V34 23/29] bpf: Restrict bpf when kernel lockdown is in confidentiality mode</a></strong>
<ul><li><em>From:</em> Matthew Garrett</li></ul></li>
<li><strong><a name="29294" href="msg29294.html">Re: [PATCH V34 23/29] bpf: Restrict bpf when kernel lockdown is in confidentiality mode</a></strong>
<ul><li><em>From:</em> Andy Lutomirski</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg29297.html">Re: [PATCH v3 10/24] Use lsmblob in security_ipc_getsecid</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg29299.html">Re: [PATCH V31 07/25] kexec_file: Restrict at runtime if the kernel is locked down</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg29295.html">Re: [PATCH V34 23/29] bpf: Restrict bpf when kernel lockdown is in confidentiality mode</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg29300.html">Re: [PATCH V34 23/29] bpf: Restrict bpf when kernel lockdown is in confidentiality mode</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#29298"><strong>Date</strong></a></li>
<li><a href="index.html#29298"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH] lots and lots of updates to the yumcmd module:	&#45; add install/remove method &#45; add version&#45;specific	rpmdbVersion method &#45; add get_package_lists method &#45; handle	many errors better &#45; return more interesting results from	install/remove/update commands &#45; lay groundwork for other handling -->
<!--X-From-R13: Ergu Hvqny &#60;fxivqnyNsrqbencebwrpg.bet> -->
<!--X-Date: Mon, 23 Aug 2010 14:34:58 &#45;0700 -->
<!--X-Message-Id: 1282599171&#45;10417&#45;1&#45;git&#45;send&#45;email&#45;skvidal@fedoraproject.org -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Fedora Universal Network Connector, [PATCH] lots and lots of updates to the yumcmd module:	- add install/remove method - add version-specific	rpmdbVersion method - add get_package_lists method - handle	many errors better - return more interesting results from	install/remove/update commands - lay groundwork for other handling">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Fedora Universal Network Connector &mdash; [PATCH] lots and lots of updates to the yumcmd module:	- add install/remove method - add version-specific	rpmdbVersion method - add get_package_lists method - handle	many errors better - return more interesting results from	install/remove/update commands - lay groundwork for other handling</title>
<link rel="alternate" type="application/rss+xml" title="Fedora Universal Network Connector" href="//feeds.feedburner.com/FedoraUniversalNetworkConnector">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH] lots and lots of updates to the yumcmd module:	- add install/remove method - add version-specific	rpmdbVersion method - add get_package_lists method - handle	many errors better - return more interesting results from	install/remove/update commands - lay groundwork for other handling</h1>
[<a href="msg01579.html">Date Prev</a>][<a href="msg01581.html">Date Next</a>][<a href="msg01577.html">Thread Prev</a>][<a href="msg01581.html">Thread Next</a>][<a href="maillist.html#01580">Date Index</a>][<a href="index.html#01580">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH] lots and lots of updates to the yumcmd module:	- add install/remove method - add version-specific	rpmdbVersion method - add get_package_lists method - handle	many errors better - return more interesting results from	install/remove/update commands - lay groundwork for other handling</li>
<li><em>From</em>: Seth Vidal &lt;<a href="mailto:skvidal@DOMAIN.HIDDEN">skvidal@xxxxxxxxxxxxxxxxx</a>&gt;</li>
<li><em>Date</em>: Mon, 23 Aug 2010 17:32:51 -0400</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>---
 func/minion/modules/yumcmd.py |  144 +++++++++++++++++++++++++++++++++++------
 1 files changed, 125 insertions(+), 19 deletions(-)

diff --git a/func/minion/modules/yumcmd.py b/func/minion/modules/yumcmd.py
index b361d76..b44a39f 100644
--- a/func/minion/modules/yumcmd.py
+++ b/func/minion/modules/yumcmd.py
@@ -1,7 +1,8 @@
-# Copyright 2007, Red Hat, Inc
+# Copyright 2010, Red Hat, Inc
 # James Bowes &lt;jbowes@xxxxxxxxxx&gt;
 # Alex Wood &lt;awood@xxxxxxxxxx&gt;
-#
+# Seth Vidal &lt;skvidal@xxxxxxxxxxxxxxxxx&gt;
+
 # This software may be freely redistributed under the terms of the GNU
 # general public license.
 #
@@ -9,41 +10,126 @@
 # along with this program; if not, write to the Free Software
 # Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
-import func_module
+# TODOS:
+# - config_dict handling
+# multiple commands in a single call - multiple() == yum shell
+# - permanent config changes
+# - better _makeresults() that doesn't make me kinda hurl and makes the output more sensible
 
 
+import func_module
+from codes import FuncException
+    
 # XXX Use internal yum callback or write a useful one.
 class DummyCallback(object):
 
     def event(self, state, data=None):
         pass
 
+def _makeresults(tsInfo):
+    results = ''
+    for pkg in tsInfo:
+        # FIXME obviously much more should happen here :)
+        if pkg.ts_state:
+            results += '%s\n' % pkg
+    
+    return results
+
+def _singleAction(action, items=[], config_dict={}, **kwargs):
+    #FIXME - config_dict needs to do the equiv of --setopt in the yumcli
+    import yum
+    ayum = yum.YumBase()
+    ayum.doGenericSetup()
+    ayum.doRepoSetup()
+    if type(items) == type([]):
+        pkglist = []
+        for p in items:
+            pkglist.extend(p.split(' '))
+    else:
+        if items:
+            pkglist = items.split(' ')
+        else:
+            pkglist = []
+    
+    if len(pkglist) == 0 and action not in ('update', 'upgrade'):
+        raise FuncException(&quot;%s requires at least one pkg&quot; % action)
+    
+    results = 'command: %s %s\n' % (action, ' '.join(pkglist))
+    try:
+        ayum.doLock()
+        if pkglist:
+            for p in pkglist:
+                tx_mbrs = []
+                if action == 'install':
+                    tx_mbrs = ayum.install(pattern=p)
+                elif action in ('remove', 'erase'):
+                    tx_mbrs = ayum.remove(pattern=p)
+
+                elif action in ('update', 'upgrade'):
+                    tx_mbrs = ayum.update(pattern=p)
+                
+                if not tx_mbrs:
+                    results += &quot;No %s matched for %s\n&quot; % (action, p)
+
+        else:
+            ayum.update()
+
+        ayum.buildTransaction()
+        ayum.processTransaction(
+                callback=DummyCallback())
+    finally:
+        results += _makeresults(ayum.tsInfo)
+        ayum.closeRpmDB()
+        ayum.doUnlock()
+    return results
+    
 class Yum(func_module.FuncModule):
 
     version = &quot;0.0.1&quot;
     api_version = &quot;0.1.0&quot;
     description = &quot;Package updates through yum.&quot;
 
-    def update(self, pkg=None):
+    from yum import __version__ as yumversion
+    yvertuple = yumversion.split('.')
+    if int(yvertuple[0]) == 3 and int(yvertuple[2]) &gt;= 25:
+        def rpmdbVersion(self, **kwargs):
+            import yum
+            ayum = yum.YumBase()
+            versionlist = ayum.rpmdb.simpleVersion(main_only=True)
+            version = versionlist[0]
+            return versionlist
+    
+    def update(self, pkg=None, config_dict={}):
+        return _singleAction('update', items=pkg, config_dict=config_dict)
+
+    def install(self, pkg=None, config_dict={}):
+        return _singleAction('install', items=pkg, config_dict=config_dict)
+
+    def remove(self, pkg=None, config_dict={}):
+        return _singleAction('remove', items=pkg, config_dict=config_dict)
+    
+    #def multiple(self, cmdlist=[]):
+    #    &quot;&quot;&quot;take multiple commands as a single transaction - equiv of yum shell&quot;&quot;&quot;
+    #    raise FuncException(&quot;Not Implemented Yet!&quot;
+
+    def get_package_lists(self, pkgspec='installed,available,obsoletes,updates,extras', config_dict={}):
         import yum
         ayum = yum.YumBase()
         ayum.doGenericSetup()
         ayum.doRepoSetup()
-        try:
-            ayum.doLock()
-            if pkg not in [None, '']:
-                tx_result = ayum.update(pattern=pkg)
-            else:
-                tx_result = ayum.update()
-
-            ayum.buildTransaction()
-            ayum.processTransaction(
-                    callback=DummyCallback())
-        finally:
-            ayum.closeRpmDB()
-            ayum.doUnlock()
-        return map(str, tx_result)
-
+        resultsdict = {}
+        pkgspec = pkgspec.replace(',',' ')
+        pkgtypes = pkgspec.split(' ')
+        for pkgtype in pkgtypes:
+            pkgtype = pkgtype.strip()
+            obj = ayum.doPackageLists(pkgnarrow=pkgtype)
+            if hasattr(obj, pkgtype):
+                thislist = getattr(obj, pkgtype)
+                output_list = sorted(map(str, thislist))
+                resultsdict[pkgtype] = output_list
+        
+        return resultsdict
+        
     def check_update(self, filter=[], repo=None):
         &quot;&quot;&quot;Returns a list of packages due to be updated
            You can specify a filter using the standard yum wildcards
@@ -98,6 +184,26 @@ class Yum(func_module.FuncModule):
                         },
                     'description':&quot;Updating system according to a specified pattern&quot;
                     },
+                'install':{
+                    'args':{
+                        'pkg':{
+                            'type':'string',
+                            'optional':False,
+                            'description':&quot;The yum pattern for installing package&quot;
+                            }
+                        },
+                    'description':&quot;install package(s) according to a specified pattern&quot;
+                    },
+                'remove':{
+                    'args':{
+                        'pkg':{
+                            'type':'string',
+                            'optional':False,
+                            'description':&quot;The yum pattern for removing package&quot;
+                            }
+                        },
+                    'description':&quot;remove package(s) according to a specified pattern&quot;
+                    },
                 'check_update':{
                     'args':{
                         'filter':{
-- 
1.7.2.1

_______________________________________________
Func-list mailing list
Func-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/func-list">https://www.redhat.com/mailman/listinfo/func-list</a>

</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg01579.html">func/overlord</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg01581.html">[PATCH] Replaced utils.get_hostname with calls to	socket.getfqdn</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg01577.html">[PATCH] Take into account downed_hosts</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg01581.html">[PATCH] Replaced utils.get_hostname with calls to	socket.getfqdn</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#01580"><strong>Date</strong></a></li>
<li><a href="index.html#01580"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/netdev/>[Linux&nbsp;Networking]</a>
&nbsp;
&nbsp;
<a href=/lists/fll/>[Fedora&nbsp;Legacy&nbsp;List]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z//biglist.html>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

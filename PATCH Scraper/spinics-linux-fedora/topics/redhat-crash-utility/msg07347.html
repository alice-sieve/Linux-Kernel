<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH] filesys: Skip 'vmlinux.o' while searching	for vmlinux in 'find_booted_kernel()' -->
<!--X-From-R13: Puhcrfu Eunezn &#60;oufuneznNerqung.pbz> -->
<!--X-Date: Tue, 27 Feb 2018 14:08:46 &#45;0800 -->
<!--X-Message-Id: 1519769227&#45;16299&#45;1&#45;git&#45;send&#45;email&#45;bhsharma@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="[PATCH] filesys: Skip 'vmlinux.o' while searching	for vmlinux in 'find_booted_kernel()' &mdash; Red Hat Crash Utility">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Red Hat Crash Utility &mdash;  [PATCH] filesys: Skip 'vmlinux.o' while searching	for vmlinux in 'find_booted_kernel()'</title>
<link rel="alternate" type="application/rss+xml" title="Red Hat Crash Utility" href="//feeds.feedburner.com/RedHatCrashUtility">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH] filesys: Skip 'vmlinux.o' while searching	for vmlinux in 'find_booted_kernel()'</h1>
[<a href="msg07346.html">Date Prev</a>][<a href="msg07348.html">Date Next</a>][<a href="msg07343.html">Thread Prev</a>][<a href="msg07348.html">Thread Next</a>][<a href="maillist.html#07347">Date Index</a>][<a href="index.html#07347">Thread Index</a>]
<script src="https://apis.google.com/js/platform.js" async defer></script>
<g:plusone size="small"></g:plusone>
<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH] filesys: Skip 'vmlinux.o' while searching	for vmlinux in 'find_booted_kernel()'</li>
<li><em>From</em>: Bhupesh Sharma &lt;bhsharma@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Wed, 28 Feb 2018 03:37:07 +0530</li>
<li><em>Cc</em>: bhupesh.linux@xxxxxxxxx</li>
<li><em>Reply-to</em>: &quot;Discussion list for crash utility usage,	maintenance and development&quot; &lt;crash-utility@xxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" defer async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>I found this particular issue while compiling and installing
a kernel from source on a RHEL arm64 machine. I used the following
commands to build and install the kernel from source:

   # make olddefconfig
   # make
   # make modules_install INSTALL_MOD_STRIP=1 &amp;&amp; make install

This compiles and installs both 'vmlinux' and 'vmlinux.o' at
the following standard location - '/lib/modules/&lt;kernel&gt;/build/

Now the problem can be reproduced using the following steps:
1. Update grub to boot the freshly compiled kernel.
2. Reboot machine.
3. Now, run crash on live system, it errors out with the following
messages:

   crash: invalid kernel virtual address: 8470  type: &quot;possible&quot;
   WARNING: cannot read cpu_possible_map
   crash: invalid kernel virtual address: 8270  type: &quot;present&quot;
   WARNING: cannot read cpu_present_map
   crash: invalid kernel virtual address: 8070  type: &quot;online&quot;
   WARNING: cannot read cpu_online_map
   crash: invalid kernel virtual address: 8670  type: &quot;active&quot;
   WARNING: cannot read cpu_active_map

   crash: cannot resolve &quot;_stext&quot;

4. Enabling some debug messages in 'find_booted_kernel()' function
tells us that it finds 'vmlinux.o' earlier than 'vmlinux' and accepts
that as the kernel being boot'ed:

   find_booted_kernel: check: /lib/modules/4.14.0/build/vmlinux.o
   find_booted_kernel: found: /lib/modules/4.14.0/build/vmlinux.o

5. Now the problem happens due to following check inside
   'find_booted_kernel()' function:

	if (mount_point(kernel) ||
	    !file_readable(kernel) ||
	    !is_elf_file(kernel))
		continue;

6. Since 'vmlinux.o' is a elf file, is readable and is not
mount'able, so the check in point 5 fails and we incorrectly
accept this as the kernel being boot'ed, even though
there was a 'vmlinux' present inside
'/lib/modules/&lt;kernel&gt;/build'.

7. Now, later when crash tries to access symbols (like _stext)
using this kernel symbol file, we see errors.

Fix this by skipping 'vmlinux.o' from the check in point 5,
so that we can select 'vmlinux' correctly as the kernel file.

After this fix, crash no longer errors out and we can use
full functionality on the crash prompt.

Signed-off-by: Bhupesh Sharma &lt;bhsharma@xxxxxxxxxx&gt;
---
 filesys.c | 14 +++++++++++++-
 1 file changed, 13 insertions(+), 1 deletion(-)

diff --git a/filesys.c b/filesys.c
index 1b44ad5cefa8..9f240d6115a1 100644
--- a/filesys.c
+++ b/filesys.c
@@ -623,9 +623,21 @@ find_booted_kernel(void)
 
 			sprintf(kernel, &quot;%s%s&quot;, searchdirs[i], dp-&gt;d_name);
 
+			/* We may run into a special case with
+			 * 'vmlinux.o' been present inside
+			 * '/lib/modules/&lt;kernel&gt;/build/',
+			 * which has some special characteristics -
+			 * this is a elf file, is readable and is not
+			 * mount'able.
+			 *
+			 * So we need to handle this properly here to
+			 * make sure that we get to the real 'vmlinux'
+			 * rather than the 'vmlinux.o'
+			 */
 			if (mount_point(kernel) ||
 			    !file_readable(kernel) || 
-                            !is_elf_file(kernel))
+                            !is_elf_file(kernel) ||
+                            !(strcmp(dp-&gt;d_name, &quot;vmlinux.o&quot;)))
 				continue;
 
 			if (CRASHDEBUG(1)) 
-- 
2.7.4

--
Crash-utility mailing list
Crash-utility@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/crash-utility">https://www.redhat.com/mailman/listinfo/crash-utility</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="07348" href="msg07348.html">Re:  [PATCH] filesys: Skip 'vmlinux.o' while searching for vmlinux in 'find_booted_kernel()'</a></strong>
<ul><li><em>From:</em> Dave Anderson</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg07346.html">Re:  [PATCH] crash/symbols: Error out earlier in case _stext_vmlinux is NULL or UNINITIALIZED</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg07348.html">Re:  [PATCH] filesys: Skip 'vmlinux.o' while searching for vmlinux in 'find_booted_kernel()'</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg07343.html">[PATCH] crash/symbols: Error out earlier in case	_stext_vmlinux is NULL or UNINITIALIZED</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg07348.html">Re:  [PATCH] filesys: Skip 'vmlinux.o' while searching for vmlinux in 'find_booted_kernel()'</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#07347"><strong>Date</strong></a></li>
<li><a href="index.html#07347"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-devel/>[Fedora&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width="100%">
<tr>
<td align=left>&nbsp;</td>
<td valign=top align=right><H1><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></H1></td>
</tr></table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

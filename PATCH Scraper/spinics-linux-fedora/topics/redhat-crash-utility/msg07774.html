<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH] Fix unsigned signed comparison causing segfault for small VMCOREINFO notes -->
<!--X-From-R13: Rnir Oaqrefba &#60;naqrefbaNerqung.pbz> -->
<!--X-Date: Thu, 6 Jun 2019 07:23:19 &#45;0700 -->
<!--X-Message-Id: 1498304941.27884212.1559830934576.JavaMail.zimbra@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: MWHPR2101MB0874FDBBCBBED0A900C6BEE683160@MWHPR2101MB0874.namprd21.prod.outlook.com -->
<!--X-Reference: 442745959.27753161.1559765882793.JavaMail.zimbra@redhat.com -->
<!--X-Reference: 1484994335.27768768.1559771736414.JavaMail.zimbra@redhat.com -->
<!--X-Reference: MWHPR2101MB0874046EFFEE3C9C76C89C5783160@MWHPR2101MB0874.namprd21.prod.outlook.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re:  [PATCH] Fix unsigned signed comparison causing segfault for small VMCOREINFO notes &mdash; Red Hat Crash Utility">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Red Hat Crash Utility &mdash;  Re:  [PATCH] Fix unsigned signed comparison causing segfault for small VMCOREINFO notes</title>
<link rel="alternate" type="application/rss+xml" title="Red Hat Crash Utility" href="//feeds.feedburner.com/RedHatCrashUtility">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [PATCH] Fix unsigned signed comparison causing segfault for small VMCOREINFO notes</h1>
[<a href="msg07773.html">Date Prev</a>][<a href="msg07775.html">Date Next</a>][<a href="msg07773.html">Thread Prev</a>][<a href="msg07775.html">Thread Next</a>][<a href="maillist.html#07774">Date Index</a>][<a href="index.html#07774">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH] Fix unsigned signed comparison causing segfault for small VMCOREINFO notes</li>
<li><em>From</em>: Dave Anderson &lt;anderson@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 6 Jun 2019 10:22:14 -0400 (EDT)</li>
<li><em>Cc</em>: crash-utility@xxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg07773.html">MWHPR2101MB0874046EFFEE3C9C76C89C5783160@MWHPR2101MB0874.namprd21.prod.outlook.com</a>&gt;</li>
<li><em>Reply-to</em>: &quot;Discussion list for crash utility usage,	maintenance and development&quot; &lt;crash-utility@xxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" defer async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>

----- Original Message -----
&gt;<i> &gt; -----Original Message-----</i>
&gt;<i> &gt; From: Dave Anderson &lt;anderson@xxxxxxxxxx&gt;</i>
&gt;<i> &gt; Sent: Wednesday, June 5, 2019 2:56 PM</i>
&gt;<i> &gt; To: Nuno Das Neves &lt;Nuno.Das@xxxxxxxxxxxxx&gt;</i>
&gt;<i> &gt; Cc: Nuno Das Neves &lt;Nuno.Das@xxxxxxxxxxxxx&gt;</i>
&gt;<i> &gt; Subject: Fwd:  [PATCH] Fix unsigned signed comparison</i>
&gt;<i> &gt; causing segfault for small VMCOREINFO notes</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; </i>
&gt;<i> &gt; </i>
&gt;<i> &gt; ----- Forwarded Message -----</i>
&gt;<i> &gt; From: &quot;Dave Anderson&quot; &lt;anderson@xxxxxxxxxx&gt;</i>
&gt;<i> &gt; To: &quot;Discussion list for crash utility usage, maintenance and development&quot;</i>
&gt;<i> &gt; &lt;crash-utility@xxxxxxxxxx&gt;</i>
&gt;<i> &gt; Sent: Wednesday, June 5, 2019 4:18:02 PM</i>
&gt;<i> &gt; Subject: Re:  [PATCH] Fix unsigned signed comparison causing</i>
&gt;<i> &gt; segfault for small VMCOREINFO notes</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; </i>
&gt;<i> &gt; </i>
&gt;<i> &gt; ----- Original Message -----</i>
&gt;<i> &gt; &gt; Hi,</i>
&gt;<i> &gt; &gt;</i>
&gt;<i> &gt; &gt; This is a fix for a signed/unsigned comparison bug in vmcoreinfo_read_string.</i>
&gt;<i> &gt; &gt; The bug causes a segmentation fault if size_vmcoreinfo + 1 is smaller than</i>
&gt;<i> &gt; &gt; the length of the key string passed in.</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; I suppose that's true, but can you describe the instance where that actually happened?</i>
&gt;<i> </i>
&gt;<i> I'm debugging some issues with vm2core</i>
&gt;<i> (<a  rel="nofollow" href="https://github.com/Azure/azure-linux-utils/tree/master/vm2core">https://github.com/Azure/azure-linux-utils/tree/master/vm2core</a>), a tool for</i>
&gt;<i> converting Hyper-V snapshots to elf core files that can be analyzed with Crash.</i>
&gt;<i> There was a problem where versions of Crash newer than 7.1.5 crashed with elf</i>
&gt;<i> files generated by vm2core due to this issue.</i>
&gt;<i> </i>
&gt;<i> &gt; Can you show the actual note contents as shown by &quot;help -D&quot;?</i>
&gt;<i> </i>
&gt;<i> Elf64_Nhdr:</i>
&gt;<i>                n_namesz: 11 (&quot;VMCOREINFO&quot;)</i>
&gt;<i>                n_descsz: 10</i>
&gt;<i>                  n_type: 0 (unused)</i>
&gt;<i>                          VMCOREINFO</i>
&gt;<i> </i>
&gt;<i> So it seems the note doesn't really contain valid data as defined in</i>
&gt;<i> Documentation/kdump/vmcoreinfo.txt.</i>
&gt;<i> </i>
&gt;<i> I've done some additional testing and it appears this note isn't needed by</i>
&gt;<i> Crash at all - I can simply patch vm2core so it doesn't add the note.</i>
&gt;<i> So, I suppose this fix isn't required to solve my particular issue.</i>

I don't think you should avoid adding the VMCOREINFO note contents from the kernel.

While the vast majority of VMCOREINFO items are only used by makedumpfile(8),
several items are used by the crash utility.  For example, the x86_64 requires
things like the kernel's phys_offset value (at least if it's non-zero), either
the relocated &quot;_stext&quot; symbol value or KERNELOFFSET value for KASLR kernels,
possibly the KERNEL_IMAGE_SIZE, and to be able to recognize 5-level page tables.
 
&gt;<i> </i>
&gt;<i> However, could the VMCOREINFO note legitimately contain a single field e.g. &quot;PAGE_SIZE=4096&quot;?</i>
&gt;<i> If so, this is just 14 characters; 14 + 1 &lt;</i>
&gt;<i> strlen(&quot;NUMBER(KERNEL_IMAGE_SIZE)&quot;) - this string is used as the argument to</i>
&gt;<i> vmcoreinfo_read_string on line 202 of x86_64.c.</i>

No, it would never contains a single field.  Here's a typical dump on a 5.0.0 x86_64
kernel:

  crash&gt; help -D
  ... [ cut ] ...

               n_namesz: 11 (&quot;VMCOREINFO&quot;)
               n_descsz: 1980
                 n_type: 0 (unused)
                         OSRELEASE=5.0.0+
                         PAGESIZE=4096
                         SYMBOL(init_uts_ns)=ffffffffa9615540
                         SYMBOL(node_online_map)=ffffffffa976e068
                         SYMBOL(swapper_pg_dir)=ffffffffa960e000
                         SYMBOL(_stext)=ffffffffa8200000
                         SYMBOL(vmap_area_list)=ffffffffa9666230
                         SYMBOL(mem_section)=ffff90adbbff8000
                         LENGTH(mem_section)=2048
                         SIZE(mem_section)=16
                         OFFSET(mem_section.section_mem_map)=0
                         SIZE(page)=64
                         SIZE(pglist_data)=14016
                         SIZE(zone)=1280
                         SIZE(free_area)=72
                         SIZE(list_head)=16
                         SIZE(nodemask_t)=8
                         OFFSET(page.flags)=0
                         OFFSET(page._refcount)=52
                         OFFSET(page.mapping)=24
                         OFFSET(page.lru)=8
                         OFFSET(page._mapcount)=48
                         OFFSET(page.private)=40
                         OFFSET(page.compound_dtor)=16
                         OFFSET(page.compound_order)=17
                         OFFSET(page.compound_head)=8
                         OFFSET(pglist_data.node_zones)=0
                         OFFSET(pglist_data.nr_zones)=13344
                         OFFSET(pglist_data.node_start_pfn)=13352
                         OFFSET(pglist_data.node_spanned_pages)=13368
                         OFFSET(pglist_data.node_id)=13376
                         OFFSET(zone.free_area)=192
                         OFFSET(zone.vm_stat)=1088
                         OFFSET(zone.spanned_pages)=112
                         OFFSET(free_area.free_list)=0
                         OFFSET(list_head.next)=0
                         OFFSET(list_head.prev)=8
                         OFFSET(vmap_area.va_start)=0
                         OFFSET(vmap_area.list)=48
                         LENGTH(zone.free_area)=11
                         SYMBOL(log_buf)=ffffffffa964b250
                         SYMBOL(log_buf_len)=ffffffffa964b24c
                         SYMBOL(log_first_idx)=ffffffffa9d71668
                         SYMBOL(clear_idx)=ffffffffa9d71634
                         SYMBOL(log_next_idx)=ffffffffa9d71658
                         SIZE(printk_log)=16
                         OFFSET(printk_log.ts_nsec)=0
                         OFFSET(printk_log.len)=8
                         OFFSET(printk_log.text_len)=10
                         OFFSET(printk_log.dict_len)=12
                         LENGTH(free_area.free_list)=4
                         NUMBER(NR_FREE_PAGES)=0
                         NUMBER(PG_lru)=4
                         NUMBER(PG_private)=13
                         NUMBER(PG_swapcache)=10
                         NUMBER(PG_swapbacked)=19
                         NUMBER(PG_slab)=9
                         NUMBER(PG_head_mask)=65536
                         NUMBER(PAGE_BUDDY_MAPCOUNT_VALUE)=-129
                         NUMBER(HUGETLB_PAGE_DTOR)=2
                         NUMBER(PAGE_OFFLINE_MAPCOUNT_VALUE)=-257
                         NUMBER(phys_base)=-497025024
                         SYMBOL(init_top_pgt)=ffffffffa960e000
                         NUMBER(pgtable_l5_enabled)=0
                         SYMBOL(node_data)=ffffffffa976d680
                         LENGTH(node_data)=64
                         KERNELOFFSET=27200000
                         NUMBER(KERNEL_IMAGE_SIZE)=1073741824
                         NUMBER(sme_mask)=0
                         CRASHTIME=1555324290

I would guess the problem is how much awareness your vm2core facility has 
concerning the target kernel, e.g., can it can find the physical
memory containing the VMCOREINFO data.  On the target system,
the physical address and a page-granularity size can be located here: 

  $ cat /sys/kernel/vmcoreinfo
  2a21197c0 1000
  $

The kernel symbols of the data is &quot;vmcoreinfo_data&quot;, and the actual
size of the note is &quot;vmcoreinfo_size&quot;.  Or in 4.19 and later kernels,
/proc/kcore now has the VMCOREINFO note appended.

The KVM developers went through the same process as you are, and they 
eventually implemented a mechanism where they pass the vmcoreinfo data from
the target kernel to the KVM host that is doing a &quot;virsh dump&quot;.

In any case, even though it's theoretically impossible to have a zero-length
or very small VMCOREINFO note, your patch does makes logical sense, so I will
apply it.

Thanks,
  Dave

                       



 
&gt;<i> Regards,</i>
&gt;<i> Nuno</i>
&gt;<i> </i>
&gt;<i> &gt; </i>
&gt;<i> &gt; Thanks,</i>
&gt;<i> &gt;   Dave</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; </i>
&gt;<i> &gt; &gt;</i>
&gt;<i> &gt; &gt; Signed-off-by: Nuno Das Neves &lt;nudasnev@xxxxxxxxxxxxx&gt;</i>
&gt;<i> &gt; &gt; ---</i>
&gt;<i> &gt; &gt;  netdump.c | 2 +-</i>
&gt;<i> &gt; &gt;  1 file changed, 1 insertion(+), 1 deletion(-)</i>
&gt;<i> &gt; &gt;</i>
&gt;<i> &gt; &gt; diff --git a/netdump.c b/netdump.c</i>
&gt;<i> &gt; &gt; index 40f9cde..d257ecd 100644</i>
&gt;<i> &gt; &gt; --- a/netdump.c</i>
&gt;<i> &gt; &gt; +++ b/netdump.c</i>
&gt;<i> &gt; &gt; @@ -1838,7 +1838,7 @@ vmcoreinfo_read_string(const char *key)</i>
&gt;<i> &gt; &gt;  		return NULL;</i>
&gt;<i> &gt; &gt;</i>
&gt;<i> &gt; &gt;  	/* the '+ 1' is the equal sign */</i>
&gt;<i> &gt; &gt; -	for (i = 0; i &lt; (size_vmcoreinfo - key_length + 1); i++) {</i>
&gt;<i> &gt; &gt; +	for (i = 0; i &lt; (int)(size_vmcoreinfo - key_length + 1); i++) {</i>
&gt;<i> &gt; &gt;  		/*</i>
&gt;<i> &gt; &gt;  		 * We must also check if we're at the beginning of VMCOREINFO</i>
&gt;<i> &gt; &gt;  		 * or the separating newline is there, and of course if we</i>
&gt;<i> &gt; &gt; --</i>
&gt;<i> &gt; &gt; 1.8.3.1</i>
&gt;<i> &gt; &gt;</i>
&gt;<i> &gt; &gt; --</i>
&gt;<i> &gt; &gt; Crash-utility mailing list</i>
&gt;<i> &gt; &gt; Crash-utility@xxxxxxxxxx</i>
&gt;<i> &gt; &gt; <a  rel="nofollow" href="https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fwww.redhat.com%2Fmailman%2Flistinfo%2Fcrash-">https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fwww.redhat.com%2Fmailman%2Flistinfo%2Fcrash-</a></i>
&gt;<i> &gt; utility&amp;amp;data=02%7C01%7CNuno.Das%40microsoft.com%7C3a91428c54b34ed7855d08d6ea008afe%7C72f988bf86f141af91ab2d7cd0</i>
&gt;<i> &gt; 11db47%7C1%7C0%7C636953685382744097&amp;amp;sdata=BVID2b0QYkDmBip0bzPjX%2Fl4vltJtf78JrTE7pnqSIM%3D&amp;amp;reserved=0</i>
&gt;<i> &gt; &gt;</i>
&gt;<i> </i>

--
Crash-utility mailing list
Crash-utility@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/crash-utility">https://www.redhat.com/mailman/listinfo/crash-utility</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="07798" href="msg07798.html">Re:  [PATCH] extension/gcore: Fix the invalid	struct	size failure of pid_link on 4.19 and newer kernel.</a></strong>
<ul><li><em>From:</em> Dave Anderson</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="07771" href="msg07771.html">[PATCH] Fix unsigned signed comparison causing segfault for small VMCOREINFO notes</a></strong>
<ul><li><em>From:</em> Nuno Das Neves</li></ul></li>
<li><strong><a name="07772" href="msg07772.html">Re:  [PATCH] Fix unsigned signed comparison causing segfault for small VMCOREINFO notes</a></strong>
<ul><li><em>From:</em> Dave Anderson</li></ul></li>
<li><strong><a name="07773" href="msg07773.html">Re:  [PATCH] Fix unsigned signed comparison causing segfault for small VMCOREINFO notes</a></strong>
<ul><li><em>From:</em> Nuno Das Neves</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg07773.html">Re:  [PATCH] Fix unsigned signed comparison causing segfault for small VMCOREINFO notes</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg07775.html">Re:  [PATCH] Fix unsigned signed comparison causing segfault for small VMCOREINFO notes</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg07773.html">Re:  [PATCH] Fix unsigned signed comparison causing segfault for small VMCOREINFO notes</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg07775.html">Re:  [PATCH] Fix unsigned signed comparison causing segfault for small VMCOREINFO notes</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#07774"><strong>Date</strong></a></li>
<li><a href="index.html#07774"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-devel/>[Fedora&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width="100%">
<tr>
<td align=left>&nbsp;</td>
<td valign=top align=right><H1><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></H1></td>
</tr></table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH v3 0/4] Generalize KASLR calculation and use it for KDUMPs -->
<!--X-From-R13: Rnir Oaqrefba &#60;naqrefbaNerqung.pbz> -->
<!--X-Date: Tue, 20 Mar 2018 13:12:17 &#45;0700 -->
<!--X-Message-Id: 675571683.12815789.1521576724675.JavaMail.zimbra@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20180320124852.1763&#45;1&#45;slp@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Re:  [PATCH v3 0/4] Generalize KASLR calculation and use it for KDUMPs &mdash; Red Hat Crash Utility">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Red Hat Crash Utility &mdash;  Re:  [PATCH v3 0/4] Generalize KASLR calculation and use it for KDUMPs</title>
<link rel="alternate" type="application/rss+xml" title="Red Hat Crash Utility" href="//feeds.feedburner.com/RedHatCrashUtility">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">Re:  [PATCH v3 0/4] Generalize KASLR calculation and use it for KDUMPs</h1>
[<a href="msg07389.html">Date Prev</a>][<a href="msg07391.html">Date Next</a>][<a href="msg07389.html">Thread Prev</a>][<a href="msg07392.html">Thread Next</a>][<a href="maillist.html#07390">Date Index</a>][<a href="index.html#07390">Thread Index</a>]
<script src="https://apis.google.com/js/platform.js" async defer></script>
<g:plusone size="small"></g:plusone>
<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH v3 0/4] Generalize KASLR calculation and use it for KDUMPs</li>
<li><em>From</em>: Dave Anderson &lt;anderson@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 20 Mar 2018 16:12:04 -0400 (EDT)</li>
<li><em>Cc</em>: crash-utility@xxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg07385.html">20180320124852.1763-1-slp@redhat.com</a>&gt;</li>
<li><em>Reply-to</em>: &quot;Discussion list for crash utility usage,	maintenance and development&quot; &lt;crash-utility@xxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" defer async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>
Hi Sergio,  (and Takao and Daisuke)

This patch to map_cpus_to_prstatus_kdump_cmprs():

@@ -153,8 +154,13 @@ resize_note_pointers:
                            dd-&gt;num_qemu_notes * sizeof(void *))) == NULL)
                                error(FATAL,
                                    &quot;compressed kdump: cannot realloc QEMU note pointers\n&quot;);
+                       if  ((dd-&gt;nt_qemucs_percpu = realloc(dd-&gt;nt_qemucs_percpu,
+                           dd-&gt;num_qemu_notes * sizeof(void *))) == NULL)
+                               error(FATAL,
+                                   &quot;compressed kdump: cannot realloc QEMU note pointers\n&quot;);
                } else
                        free(dd-&gt;nt_qemu_percpu);
+                       free(dd-&gt;nt_qemucs_percpu);
        }
 }

is missing brackets around the else clause, resulting in:

        if (machine_type(&quot;X86_64&quot;) || machine_type(&quot;X86&quot;) ||
            machine_type(&quot;ARM64&quot;)) {
                if ((dd-&gt;nt_prstatus_percpu = realloc(dd-&gt;nt_prstatus_percpu,
                    dd-&gt;num_prstatus_notes * sizeof(void *))) == NULL)
                        error(FATAL,
                            &quot;compressed kdump: cannot realloc NT_PRSTATUS note pointers\n&quot;);
                if (dd-&gt;num_qemu_notes) {
                        if  ((dd-&gt;nt_qemu_percpu = realloc(dd-&gt;nt_qemu_percpu,
                            dd-&gt;num_qemu_notes * sizeof(void *))) == NULL)
                                error(FATAL,
                                    &quot;compressed kdump: cannot realloc QEMU note pointers\n&quot;);
                        if  ((dd-&gt;nt_qemucs_percpu = realloc(dd-&gt;nt_qemucs_percpu,
                            dd-&gt;num_qemu_notes * sizeof(void *))) == NULL)
                                error(FATAL,
                                    &quot;compressed kdump: cannot realloc QEMU note pointers\n&quot;);
                } else
                        free(dd-&gt;nt_qemu_percpu);
                        free(dd-&gt;nt_qemucs_percpu);
        }

So as soon as the realloc(dd-&gt;nt_qemucs_percpu, ...) is done, it gets free()'d.
So I'm not sure how your testing worked, but presumably, the freed data 
remained untouched at least long enough to get the job done during 
initialization.

One minor nit -- in order to be able to search for functions in a file 
by entering &quot;^function_name&quot;, I prefer that function names always be 
placed on their own line, with the return type or void on the line above.  

Other that, the patch looks OK.  

As I mentioned before, I will need ACK's from Takao Indou and Daisuke
Hatayama.  They can fix the bracket bug above themselves for their
sadump testing, so it's probably not necessary to repost the patch.
I've added d.hatayama@xxxxxxxxxxxxxx to the cc: list. 

Thanks,
  Dave



----- Original Message -----
&gt;<i> Commit 45b74b89530d611b3fa95a1041e158fbb865fa84 added support for</i>
&gt;<i> calculating phys_base and kernel offset for KASLR-enabled kernels on</i>
&gt;<i> SADUMPs by using a technique developed by Takao Indoh. Originally, the</i>
&gt;<i> patchset included support for KDUMPs, but this was dropped in v2, as it</i>
&gt;<i> was deemed unnecessary due to the implementation of the vmcoreinfo</i>
&gt;<i> device in QEMU.</i>
&gt;<i> </i>
&gt;<i> Sadly, there are many reasons for which the vmcoreinfo device may not be</i>
&gt;<i> present in the moment of taking the memory dump from a VM, ranging from</i>
&gt;<i> a Host running older QEMU/libvirt versions, to misconfigured VMs or</i>
&gt;<i> environments running Hypervisors that doesn't support this device.</i>
&gt;<i> </i>
&gt;<i> This patchset generalizes the kaslr related functions from sadump.c</i>
&gt;<i> moving them to kaslr_helper.c, and makes KDUMP analysis fallback to</i>
&gt;<i> KASLR offset calculation if vmcoreinfo data is missing.</i>
&gt;<i> </i>
&gt;<i> These changes have been successfully tested with a 3.10.0-830.el7.x86_64</i>
&gt;<i> under the following conditions:</i>
&gt;<i> </i>
&gt;<i>  - kdump with KASLR and vmcoreinfo</i>
&gt;<i> </i>
&gt;<i>  - kdump with KASLR but no vmcoreinfo</i>
&gt;<i> </i>
&gt;<i>  - kdump without KASLR (&quot;nokaslr&quot; kernel command line option)</i>
&gt;<i> </i>
&gt;<i> It was also tested that a &quot;crash&quot; patched with these changes still</i>
&gt;<i> builds and runs (live and kdump debugging) on an aarch64 machine.</i>
&gt;<i> </i>
&gt;<i> changelog:</i>
&gt;<i> </i>
&gt;<i> v3:</i>
&gt;<i>  - Merge *get_cr3 and *get_idtr functions and move them to</i>
&gt;<i>    kaslr_helper.c</i>
&gt;<i>  - diskdump: drop kaslr_phys_base addition and use</i>
&gt;<i>    sub_header_kdump-&gt;phys_base instead.</i>
&gt;<i>  - Unconditionally call x86_64_virt_phys_base after grabbing phys_base</i>
&gt;<i> </i>
&gt;<i> v2:</i>
&gt;<i>  - Limit application to QEMU ELF and QEMU COMPRESSED dumps (thanks Dave)</i>
&gt;<i>  - Add support for QEMU COMPRESSED dumps (diskdump)</i>
&gt;<i> </i>
&gt;<i> Sergio Lopez (4):</i>
&gt;<i>   Move kaslr related functions from sadump.c to kaslr_helper.c</i>
&gt;<i>   Move QEMUCPU* structs from netdump.h to defs.h</i>
&gt;<i>   netdump: infer kaslr offset for QEMU ELF dumps without vmcoreinfo</i>
&gt;<i>   diskdump: infer kaslr offset for QEMU COMPRESSED dumps without</i>
&gt;<i>     vmcoreinfo</i>
&gt;<i> </i>
&gt;<i>  Makefile       |   7 +-</i>
&gt;<i>  defs.h         |  39 +++++</i>
&gt;<i>  diskdump.c     |  61 ++++++++</i>
&gt;<i>  kaslr_helper.c | 488</i>
&gt;<i>  +++++++++++++++++++++++++++++++++++++++++++++++++++++++++</i>
&gt;<i>  netdump.c      |  54 +++++++</i>
&gt;<i>  netdump.h      |  24 +--</i>
&gt;<i>  sadump.c       | 486</i>
&gt;<i>  ++++----------------------------------------------------</i>
&gt;<i>  symbols.c      |  26 ++-</i>
&gt;<i>  x86_64.c       |  18 ++-</i>
&gt;<i>  9 files changed, 719 insertions(+), 484 deletions(-)</i>
&gt;<i>  create mode 100644 kaslr_helper.c</i>
&gt;<i> </i>
&gt;<i> --</i>
&gt;<i> 2.14.3</i>
&gt;<i> </i>
&gt;<i> </i>

--
Crash-utility mailing list
Crash-utility@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/crash-utility">https://www.redhat.com/mailman/listinfo/crash-utility</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="07392" href="msg07392.html">Re:  [PATCH v3 0/4] Generalize KASLR calculation and	use it for KDUMPs</a></strong>
<ul><li><em>From:</em> Sergio Lopez</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="07385" href="msg07385.html">[PATCH v3 0/4] Generalize KASLR calculation and use	it for KDUMPs</a></strong>
<ul><li><em>From:</em> Sergio Lopez</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg07389.html">[PATCH v3 4/4] diskdump: infer kaslr offset for	QEMU COMPRESSED dumps without vmcoreinfo</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg07391.html">[PATCH] vmware_vmss: read vCPUs regs and show them	in 'bt'</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg07389.html">[PATCH v3 4/4] diskdump: infer kaslr offset for	QEMU COMPRESSED dumps without vmcoreinfo</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg07392.html">Re:  [PATCH v3 0/4] Generalize KASLR calculation and	use it for KDUMPs</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#07390"><strong>Date</strong></a></li>
<li><a href="index.html#07390"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-devel/>[Fedora&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width="100%">
<tr>
<td align=left>&nbsp;</td>
<td valign=top align=right><H1><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></H1></td>
</tr></table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

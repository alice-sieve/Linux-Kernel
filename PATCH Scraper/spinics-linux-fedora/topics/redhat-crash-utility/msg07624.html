<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH for testing only] Make radix tree compatible	with 4.20&#45;rc1 xarray -->
<!--X-From-R13: Rbzvavdhr [negvarg &#60;nfznqrhfNpbqrjerpx.bet> -->
<!--X-Date: Sun, 4 Nov 2018 21:01:23 &#45;0800 -->
<!--X-Message-Id: 1541393707&#45;27181&#45;1&#45;git&#45;send&#45;email&#45;asmadeus@codewreck.org -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 886484154.50269594.1540909971080.JavaMail.zimbra@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="[PATCH for testing only] Make radix tree compatible	with 4.20-rc1 xarray &mdash; Red Hat Crash Utility">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>Red Hat Crash Utility &mdash;  [PATCH for testing only] Make radix tree compatible	with 4.20-rc1 xarray</title>
<link rel="alternate" type="application/rss+xml" title="Red Hat Crash Utility" href="//feeds.feedburner.com/RedHatCrashUtility">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="25" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[PATCH for testing only] Make radix tree compatible	with 4.20-rc1 xarray</h1>
[<a href="msg07623.html">Date Prev</a>][<a href="msg07625.html">Date Next</a>][<a href="msg07623.html">Thread Prev</a>][<a href="msg07625.html">Thread Next</a>][<a href="maillist.html#07624">Date Index</a>][<a href="index.html#07624">Thread Index</a>]
<script src="https://apis.google.com/js/platform.js" async defer></script>
<g:plusone size="small"></g:plusone>
<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH for testing only] Make radix tree compatible	with 4.20-rc1 xarray</li>
<li><em>From</em>: Dominique Martinet &lt;asmadeus@xxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Mon,  5 Nov 2018 05:55:07 +0100</li>
<li><em>In-reply-to</em>: &lt;<a href="msg07623.html">886484154.50269594.1540909971080.JavaMail.zimbra@redhat.com</a>&gt;</li>
<li><em>Reply-to</em>: &quot;Discussion list for crash utility usage,	maintenance and development&quot; &lt;crash-utility@xxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" defer async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>radix trees got replaced with xarrays in 4.20-rc1's f8d5d0cc145
(&quot;xarray: Add definition of struct xarray&quot;) and 01959dfe77 (&quot;xarray:
Define struct xa_node&quot;)

Attempt to detect and support this.
---
Dave Anderson wrote on Tue, Oct 30, 2018:
&gt;<i> Thanks for the heads-up -- this is a critical change w/respect to</i>
&gt;<i> the crash utility, affecting several other parts as well as the</i>
&gt;<i> PID/task gathering mechanism.  I don't have access to 4.20-rc1</i>
&gt;<i> kernels in-house, or from Fedora, at the moment, so I won't be able</i>
&gt;<i> to do any hands-on work on it for a while.  So given the insights</i>
&gt;<i> you've gained already, by all means please continue if you can!</i>

4.20-rc1 was not released yet so this isn't surprising :)
It came out just this weekend, should probably hit rawhide soon.


Meanwhile I had a second look (thanks for reminding me about the
`--active` switch, I can play with `tree -t radix` more easily now); I
had missed a couple more things with my initial test.
Basically, we need to:
 - fall back radix_tree_root to xarray, radix_tree_node to xa_node,
radix_tree_root_rnode to xarray's xa_head, radix_tree_node_slots to
xa_node's slots, radix_tree_node_shift to xa_node's shift
 - does not seem to be a max_height anymore
 - RADIX_TREE_INTERNAL_NODE changed from 1 to 2 (linux code: that 2 is
hardcoded in include/linux/xarray.h xa_mk_node and xa_to_node...)
The XA_CHUNK_MASK that replaces RADIX_TREE_ENTRY_MASK is bigger but
I didn't need to change that.
To use the same code with both radix tree and xarray, I'm now clearing
the entry mask instead of the interna node bit.
 - the second thing I had missed was `MEMBER_SIZE(&quot;radix_tree_node&quot;,
&quot;slots&quot;)` in do_radix_tree_iter as it wasn't with the other fields, need
to fallback to xa_node's slots here as well.
the check !(nlen = MEMBER_SIZE(...)) isn't correct as MEMBER_SIZE will
return -1 on failure, so comparing to 0 might be better.


So ultimately I can get crash to start with the attached patch, but this
is definitely more of monkeying around than a real fix.
One thing I'm not sure about in particular is if the radix tree/xarray
contains values instead of pointers some of the internal bits changed,
but we do not seem to handle that for radix trees right now so it might
not matter...?

Anyway, patch tested on 4.20-rc1, and fedora's 4.18.16-200.fc28.x86_64.
As said previously it probably warrants more testing on 4.20-rc1 and
possibly older centos/rhel kernels, I don't think any of the tree I
tried was multiple levels deep for example...
Please consider it a &quot;FYI&quot; patch more than anything else :)

 task.c  |  9 +++++++++
 tools.c | 23 +++++++++++------------
 2 files changed, 20 insertions(+), 12 deletions(-)

diff --git a/task.c b/task.c
index 1eecfce..34327c2 100644
--- a/task.c
+++ b/task.c
@@ -485,6 +485,15 @@ task_init(void)
 			&quot;radix_tree_node&quot;,&quot;height&quot;);
 		MEMBER_OFFSET_INIT(radix_tree_node_shift,
 			&quot;radix_tree_node&quot;,&quot;shift&quot;);
+	} else {
+		STRUCT_SIZE_INIT(radix_tree_root, &quot;xarray&quot;);
+		STRUCT_SIZE_INIT(radix_tree_node, &quot;xa_node&quot;);
+		MEMBER_OFFSET_INIT(radix_tree_root_rnode,
+			&quot;xarray&quot;,&quot;xa_head&quot;);
+		MEMBER_OFFSET_INIT(radix_tree_node_slots,
+			&quot;xa_node&quot;,&quot;slots&quot;);
+		MEMBER_OFFSET_INIT(radix_tree_node_shift,
+			&quot;xa_node&quot;,&quot;shift&quot;);
 	}
 
 	if (symbol_exists(&quot;pidhash&quot;) &amp;&amp; symbol_exists(&quot;pid_hash&quot;) &amp;&amp;
diff --git a/tools.c b/tools.c
index 634aec6..33d3787 100644
--- a/tools.c
+++ b/tools.c
@@ -4415,7 +4415,6 @@ static ulong RADIX_TREE_MAP_SIZE = UNINITIALIZED;
 static ulong RADIX_TREE_MAP_MASK = UNINITIALIZED;
 
 #define RADIX_TREE_ENTRY_MASK		3UL
-#define RADIX_TREE_INTERNAL_NODE	1UL
 
 static void do_radix_tree_iter(ulong node, uint height, char *path,
 			       ulong index, struct radix_tree_ops *ops)
@@ -4436,8 +4435,8 @@ static void do_radix_tree_iter(ulong node, uint height, char *path,
 		if (!slot)
 			continue;
 
-		if (slot &amp; RADIX_TREE_INTERNAL_NODE)
-			slot &amp;= ~RADIX_TREE_INTERNAL_NODE;
+		if (slot &amp; RADIX_TREE_ENTRY_MASK)
+			slot &amp;= ~RADIX_TREE_ENTRY_MASK;
 
 		if (height == 1)
 			ops-&gt;entry(node, slot, path, index | off, ops-&gt;private);
@@ -4467,13 +4466,13 @@ int do_radix_tree_traverse(ulong ptr, int is_root, struct radix_tree_ops *ops)
 	      !ARRAY_LENGTH(height_to_maxindex)) &amp;&amp;
 	     (!VALID_MEMBER(radix_tree_root_rnode) ||
 	      !VALID_MEMBER(radix_tree_node_shift) ||
-	      !VALID_MEMBER(radix_tree_node_slots) ||
-	      !ARRAY_LENGTH(height_to_maxnodes))))
+	      !VALID_MEMBER(radix_tree_node_slots))))
 		error(FATAL, &quot;radix trees do not exist or have changed &quot;
 			&quot;their format\n&quot;);
 
 	if (RADIX_TREE_MAP_SHIFT == UNINITIALIZED) {
-		if (!(nlen = MEMBER_SIZE(&quot;radix_tree_node&quot;, &quot;slots&quot;)))
+		if ((nlen = MEMBER_SIZE(&quot;radix_tree_node&quot;, &quot;slots&quot;)) &lt;= 0 &amp;&amp;
+		    (nlen = MEMBER_SIZE(&quot;xa_node&quot;, &quot;slots&quot;)) &lt;= 0)
 			error(FATAL, &quot;cannot determine length of &quot;
 				     &quot;radix_tree_node.slots[] array\n&quot;);
 		nlen /= sizeof(void *);
@@ -4483,7 +4482,7 @@ int do_radix_tree_traverse(ulong ptr, int is_root, struct radix_tree_ops *ops)
 
 		if (ARRAY_LENGTH(height_to_maxindex))
 			max_height = ARRAY_LENGTH(height_to_maxindex);
-		else
+		else if (ARRAY_LENGTH(height_to_maxnodes))
 			max_height = ARRAY_LENGTH(height_to_maxnodes);
 	}
 
@@ -4491,8 +4490,8 @@ int do_radix_tree_traverse(ulong ptr, int is_root, struct radix_tree_ops *ops)
 	if (!is_root) {
 		node_p = ptr;
 
-		if (node_p &amp; RADIX_TREE_INTERNAL_NODE)
-			node_p &amp;= ~RADIX_TREE_INTERNAL_NODE;
+		if (node_p &amp; RADIX_TREE_ENTRY_MASK)
+			node_p &amp;= ~RADIX_TREE_ENTRY_MASK;
 
 		if (VALID_MEMBER(radix_tree_node_height)) {
 			readmem(node_p + OFFSET(radix_tree_node_height), KVADDR,
@@ -4516,9 +4515,9 @@ int do_radix_tree_traverse(ulong ptr, int is_root, struct radix_tree_ops *ops)
 
 		readmem(ptr + OFFSET(radix_tree_root_rnode), KVADDR, &amp;node_p,
 			sizeof(void *), &quot;radix_tree_root rnode&quot;, FAULT_ON_ERROR);
-		is_internal = (node_p &amp; RADIX_TREE_INTERNAL_NODE);
-		if (node_p &amp; RADIX_TREE_INTERNAL_NODE)
-			node_p &amp;= ~RADIX_TREE_INTERNAL_NODE;
+		is_internal = (node_p &amp; RADIX_TREE_ENTRY_MASK);
+		if (node_p &amp; RADIX_TREE_ENTRY_MASK)
+			node_p &amp;= ~RADIX_TREE_ENTRY_MASK;
 
 		if (is_internal &amp;&amp; VALID_MEMBER(radix_tree_node_shift)) {
 			readmem(node_p + OFFSET(radix_tree_node_shift), KVADDR, &amp;shift,
-- 
2.19.1

--
Crash-utility mailing list
Crash-utility@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/crash-utility">https://www.redhat.com/mailman/listinfo/crash-utility</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="07625" href="msg07625.html">Re:  [PATCH for testing only] Make radix tree compatible with 4.20-rc1 xarray</a></strong>
<ul><li><em>From:</em> Dave Anderson</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="07623" href="msg07623.html">Re:  kernel 4.20-rc1 compatibility - radix tree replaced by xarray</a></strong>
<ul><li><em>From:</em> Dave Anderson</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg07623.html">Re:  kernel 4.20-rc1 compatibility - radix tree replaced by xarray</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg07625.html">Re:  [PATCH for testing only] Make radix tree compatible with 4.20-rc1 xarray</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg07623.html">Re:  kernel 4.20-rc1 compatibility - radix tree replaced by xarray</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg07625.html">Re:  [PATCH for testing only] Make radix tree compatible with 4.20-rc1 xarray</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#07624"><strong>Date</strong></a></li>
<li><a href="index.html#07624"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-devel/>[Fedora&nbsp;Development]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width="100%">
<tr>
<td align=left>&nbsp;</td>
<td valign=top align=right><H1><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></H1></td>
</tr></table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

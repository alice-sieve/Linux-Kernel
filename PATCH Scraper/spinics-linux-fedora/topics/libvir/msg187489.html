<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH v1 05/31] virpcimock: Create driver_override file in device dirs -->
<!--X-From-R13: [vpuny Bevibmavx &#60;zcevibmaNerqung.pbz> -->
<!--X-Date: Tue, 16 Jul 2019 07:37:20 &#45;0700 -->
<!--X-Message-Id: 6d7080af&#45;894b&#45;1ad7&#45;051e&#45;9b10de4515ce@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: cover.1562859733.git.mprivozn@redhat.com -->
<!--X-Reference: 883546a6872fb3afc83ea184d901bdb274b1000f.1562859733.git.mprivozn@redhat.com -->
<!--X-Reference: 20190716121354.GM2061@angien.pipo.sk -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; Re:  [PATCH v1 05/31] virpcimock: Create driver_override file in device dirs</title>
<meta name="description" content="libvirt: Re:  [PATCH v1 05/31] virpcimock: Create driver_override file in device dirs">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>Re:  [PATCH v1 05/31] virpcimock: Create driver_override file in device dirs</h1>
[<a href="msg187488.html">Date Prev</a>][<a href="msg187490.html">Date Next</a>][<a href="msg187466.html">Thread Prev</a>][<a href="msg187170.html">Thread Next</a>][<a href="maillist.html#187489">Date Index</a>][<a href="index.html#187489">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH v1 05/31] virpcimock: Create driver_override file in device dirs</li>
<li><em>From</em>: Michal Privoznik &lt;mprivozn@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 16 Jul 2019 16:37:11 +0200</li>
<li><em>Cc</em>: libvir-list@xxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187466.html">20190716121354.GM2061@angien.pipo.sk</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187163.html">cover.1562859733.git.mprivozn@redhat.com</a>&gt;	&lt;<a href="msg187169.html">883546a6872fb3afc83ea184d901bdb274b1000f.1562859733.git.mprivozn@redhat.com</a>&gt;	&lt;<a href="msg187466.html">20190716121354.GM2061@angien.pipo.sk</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101	Thunderbird/60.7.2</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
On 7/16/19 2:13 PM, Peter Krempa wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On Thu, Jul 11, 2019 at 17:53:52 +0200, Michal Privoznik wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Newer kernels (v3.16-rc1~29^2~6^4) have 'driver_override' file
which simplifies way of binding a PCI device to desired driver.
Libvirt has support for this for some time too (v2.3.0-rc1~236),
but not our virpcimock. So far we did not care because our code
is designed to deal with this situation. Except for one.
hypothetical case: binding a device to the vfio-pci driver can be
successful only via driver_override. Any attempt to bind a PCI
device to vfio-pci driver using old method (new_id + unbind +
bind) will fail because of b803b29c1a5. While on vanilla kernel
</pre></blockquote><pre style="margin: 0em;">

You've reverted the mentioned commit just before this patch.
</pre></blockquote><pre style="margin: 0em;">

Yep, I needed to do that s

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

Also I did not understand what this is supposed to do from the commit
message. Perhaps due to my limited understanding of the pci detachment
code. So either somebody else reviews this or you'll need to reprhase
the commit message.

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
I'm able to use the old method successfully, it's failing on RHEL
kernels (not sure why).
</pre></blockquote><pre style="margin: 0em;">

This does not inspire confidence.
</pre></blockquote><pre style="margin: 0em;">

</pre><tt>I've asked Alex Williamson about this and he confirmed that he can see 
</tt><tt>this behaviour but nor he could understand why RHEL-7 kernel behaves 
</tt><tt>that way.
</tt><pre style="margin: 0em;">

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

Signed-off-by: Michal Privoznik &lt;mprivozn@xxxxxxxxxx&gt;
---
  tests/virpcimock.c | 57 +++++++++++++++++++++++++++++++++++++++++-----
  1 file changed, 51 insertions(+), 6 deletions(-)

diff --git a/tests/virpcimock.c b/tests/virpcimock.c
index 6865f992dc..18d06d11d4 100644
--- a/tests/virpcimock.c
+++ b/tests/virpcimock.c
@@ -87,6 +87,11 @@ char *fakesysfspcidir;
   *   Probe for a driver that handles the specified device.
   *   Data in format &quot;DDDD:BB:DD.F&quot; (Domain:Bus:Device.Function).
   *
+ * /sys/bus/pci/devices/&lt;device&gt;/driver_override
+ *   Name of a driver that overrides preferred driver can be written
+ *   here. The device will be attached to it on drivers_probe event.
+ *   Writing an empty string (or &quot;\n&quot;) clears the override.
+ *
   * As a little hack, we are not mocking write to these files, but close()
   * instead. The advantage is we don't need any self growing array to hold the
   * partial writes and construct them back. We can let all the writes finish,
@@ -147,6 +152,7 @@ static struct pciDevice *pci_device_find_by_content(const char *path);
  static void pci_driver_new(const char *name, int fail, ...);
  static struct pciDriver *pci_driver_find_by_dev(struct pciDevice *dev);
  static struct pciDriver *pci_driver_find_by_path(const char *path);
+static struct pciDriver *pci_driver_find_by_driver_override(struct pciDevice *dev);
  static int pci_driver_bind(struct pciDriver *driver, struct pciDevice *dev);
  static int pci_driver_unbind(struct pciDriver *driver, struct pciDevice *dev);
  static int pci_driver_handle_change(int fd, const char *path);
@@ -202,7 +208,8 @@ make_symlink(const char *path,
  static int
  pci_read_file(const char *path,
                char *buf,
-              size_t buf_size)
+              size_t buf_size,
+              bool truncate)
  {
      int ret = -1;
      int fd = -1;
@@ -224,7 +231,8 @@ pci_read_file(const char *path,
          goto cleanup;
      }
</pre><tt>  
</tt><tt>-    if (ftruncate(fd, 0) &lt; 0)
</tt><pre style="margin: 0em;">
+    if (truncate &amp;&amp;
+        ftruncate(fd, 0) &lt; 0)
          goto cleanup;
</pre><tt>  
</tt><tt>      ret = 0;
</tt><pre style="margin: 0em;">
@@ -398,6 +406,8 @@ pci_device_new_from_stub(const struct pciDevice *data)
          ABORT(&quot;@tmp overflow&quot;);
      make_file(devpath, &quot;class&quot;, tmp, -1);
</pre><tt>  
</tt><tt>+    make_file(devpath, &quot;driver_override&quot;, NULL, -1);
</tt><pre style="margin: 0em;">
+
      if (snprintf(tmp, sizeof(tmp),
                   &quot;%s/../../../kernel/iommu_groups/%d&quot;,
                   devpath, dev-&gt;iommuGroup) &lt; 0) {
@@ -441,7 +451,7 @@ pci_device_find_by_content(const char *path)
  {
      char tmp[32];
</pre><tt>  
</tt><tt>-    if (pci_read_file(path, tmp, sizeof(tmp)) &lt; 0)
</tt><pre style="margin: 0em;">
+    if (pci_read_file(path, tmp, sizeof(tmp), true) &lt; 0)
          return NULL;
</pre><tt>  
</tt><tt>      return pci_device_find_by_id(tmp);
</tt><pre style="margin: 0em;">
@@ -450,7 +460,10 @@ pci_device_find_by_content(const char *path)
  static int
  pci_device_autobind(struct pciDevice *dev)
  {
-    struct pciDriver *driver = pci_driver_find_by_dev(dev);
+    struct pciDriver *driver = pci_driver_find_by_driver_override(dev);
+
+    if (!driver)
+        driver = pci_driver_find_by_dev(dev);
</pre></blockquote></blockquote><pre style="margin: 0em;">

</pre><tt>This could explain why the check from 03/31 can't be here. If it was, 
</tt><tt>then nor 'driver_override' would be able to bind a PCI device to the 
</tt><tt>vfio-pci driver (which obviously is not the case).
</tt><pre style="margin: 0em;">

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><tt>  
</tt><tt>      if (!driver) {
</tt><pre style="margin: 0em;">
          /* No driver found. Nothing to do */
@@ -544,6 +557,36 @@ pci_driver_find_by_path(const char *path)
      return NULL;
  }
</pre><tt>  
</tt><tt>+static struct pciDriver *
</tt><pre style="margin: 0em;">
+pci_driver_find_by_driver_override(struct pciDevice *dev)
+{
+    struct pciDriver *ret = NULL;
+    char *path = NULL;
+    char tmp[32];
+    size_t i;
+
+    if (virAsprintfQuiet(&amp;path,
+                         SYSFS_PCI_PREFIX &quot;devices/%s/driver_override&quot;,
+                         dev-&gt;id) &lt; 0)
+        return NULL;
+
+    if (pci_read_file(path, tmp, sizeof(tmp), false) &lt; 0)
+        goto cleanup;
+
+    for (i = 0; i &lt; nPCIDrivers; i++) {
+        struct pciDriver *driver = pciDrivers[i];
+
+        if (STREQ(tmp, driver-&gt;name)) {
+            ret = driver;
+            break;
+        }
+    }
+
+ cleanup:
+    VIR_FREE(path);
</pre></blockquote><pre style="margin: 0em;">

VIR_AUTOFREE should be available.
</pre></blockquote><pre style="margin: 0em;">

Ah, good point. Consider fixed.

Michal

--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187488.html">Re:  [PATCH v1 03/31] virpcimock: Move actions checking one level up</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187490.html">Re:  [PATCH v1 24/31] qemu: Create NVMe disk in domain namespace</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187466.html">Re:  [PATCH v1 05/31] virpcimock: Create driver_override file in device dirs</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187170.html">[PATCH v1 06/31] virPCIDeviceAddressEqual: Fix const	correctness</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187489"><strong>Date</strong></a></li>
<li><a href="index.html#187489"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

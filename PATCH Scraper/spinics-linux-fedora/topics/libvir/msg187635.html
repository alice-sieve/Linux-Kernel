<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH 2/2] virSecurityManagerMetadataLock: Skip over duplicate paths -->
<!--X-From-R13: Rnavry =?hgs&#45;8?P?GQ4tCzHlpzThL8Ac?= &#60;oreenatrNerqung.pbz> -->
<!--X-Date: Thu, 18 Jul 2019 02:30:12 &#45;0700 -->
<!--X-Message-Id: 20190718092857.GB15411@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: cover.1563441249.git.mprivozn@redhat.com -->
<!--X-Reference: b6e8d014badbbba6a0fbc52230825c6bfeea6b92.1563441249.git.mprivozn@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; Re:  [PATCH 2/2] virSecurityManagerMetadataLock: Skip over duplicate paths</title>
<meta name="description" content="libvirt: Re:  [PATCH 2/2] virSecurityManagerMetadataLock: Skip over duplicate paths">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>Re:  [PATCH 2/2] virSecurityManagerMetadataLock: Skip over duplicate paths</h1>
[<a href="msg187634.html">Date Prev</a>][<a href="msg187636.html">Date Next</a>][<a href="msg187631.html">Thread Prev</a>][<a href="msg187643.html">Thread Next</a>][<a href="maillist.html#187635">Date Index</a>][<a href="index.html#187635">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH 2/2] virSecurityManagerMetadataLock: Skip over duplicate paths</li>
<li><em>From</em>: Daniel P. Berrang&#xE9; &lt;berrange@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 18 Jul 2019 10:28:57 +0100</li>
<li><em>Cc</em>: libvir-list@xxxxxxxxxx, danielhb413@xxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187631.html">b6e8d014badbbba6a0fbc52230825c6bfeea6b92.1563441249.git.mprivozn@redhat.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187633.html">cover.1563441249.git.mprivozn@redhat.com</a>&gt;	&lt;<a href="msg187631.html">b6e8d014badbbba6a0fbc52230825c6bfeea6b92.1563441249.git.mprivozn@redhat.com</a>&gt;</li>
<li><em>Reply-to</em>: Daniel P. Berrang&#xE9; &lt;berrange@xxxxxxxxxx&gt;</li>
<li><em>User-agent</em>: Mutt/1.12.0 (2019-05-25)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Thu, Jul 18, 2019 at 11:14:49AM +0200, Michal Privoznik wrote:
&gt; If there are two paths on the list that are the same we need to
&gt; lock it only once. Because when we try to lock it the second time
&gt; then open() fails. And if it didn't, locking it the second time
&gt; would fail for sure. After all, it is sufficient to lock all
&gt; paths just once satisfy the caller.
&gt; 
&gt; Reported-by: Daniel Henrique Barboza &lt;danielhb413@xxxxxxxxx&gt;
&gt; Signed-off-by: Michal Privoznik &lt;mprivozn@xxxxxxxxxx&gt;
&gt; ---
&gt;  src/security/security_manager.c | 23 +++++++++++++++++++++--
&gt;  1 file changed, 21 insertions(+), 2 deletions(-)

Reviewed-by: Daniel P. Berrang&#xE9; &lt;berrange@xxxxxxxxxx&gt;


&gt; 
&gt; diff --git a/src/security/security_manager.c b/src/security/security_manager.c
&gt; index ade2c96141..7c905f0785 100644
&gt; --- a/src/security/security_manager.c
&gt; +++ b/src/security/security_manager.c
&gt; @@ -1294,16 +1294,35 @@ virSecurityManagerMetadataLock(virSecurityManagerPtr mgr ATTRIBUTE_UNUSED,
&gt;       * paths A B and there's another that is trying to lock them
&gt;       * in reversed order a deadlock might occur.  But if we sort
&gt;       * the paths alphabetically then both processes will try lock
&gt; -     * paths in the same order and thus no deadlock can occur. */
&gt; +     * paths in the same order and thus no deadlock can occur.
&gt; +     * Lastly, it makes searching for duplicate paths below
&gt; +     * simpler. */
&gt;      qsort(paths, npaths, sizeof(*paths), cmpstringp);
&gt;  
&gt;      for (i = 0; i &lt; npaths; i++) {
&gt;          const char *p = paths[i];
&gt;          struct stat sb;
&gt; +        size_t j;
&gt;          int retries = 10 * 1000;
&gt;          int fd;
&gt;  
&gt; -        if (!p || stat(p, &amp;sb) &lt; 0)
&gt; +        if (!p)
&gt; +            continue;
&gt; +
&gt; +        /* If there's a duplicate path on the list, skip it over.
&gt; +         * Not only we would fail open()-ing it the second time,
&gt; +         * we would deadlock with ourselves trying to lock it the
&gt; +         * second time. After all, we've locked it when iterating
&gt; +         * over it the first time. */

Presumably this deals with the problem at cold boot. Is it possible
to hit the same problem when we have cold plugged one device and
then later try to hotplug another device using the same resource,
or do the SRIOV assignment grouping requirements make the hotplug
impossible ?


Regards,
Daniel
-- 
|: <a  rel="nofollow" href="https://berrange.com">https://berrange.com</a>      -o-    <a  rel="nofollow" href="https://www.flickr.com/photos/dberrange">https://www.flickr.com/photos/dberrange</a> :|
|: <a  rel="nofollow" href="https://libvirt.org">https://libvirt.org</a>         -o-            <a  rel="nofollow" href="https://fstop138.berrange.com">https://fstop138.berrange.com</a> :|
|: <a  rel="nofollow" href="https://entangle-photo.org">https://entangle-photo.org</a>    -o-    <a  rel="nofollow" href="https://www.instagram.com/dberrange">https://www.instagram.com/dberrange</a> :|

--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187634.html">Re:  [PATCH 1/2] virSecurityManagerMetadataLock: Expand the comment on deadlocks</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187636.html">Re:  [PATCH] util: Fix uninitalized variable to avoid garbage value.</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187631.html">[PATCH 2/2] virSecurityManagerMetadataLock: Skip over	duplicate paths</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187643.html">Re:  [PATCH 2/2] virSecurityManagerMetadataLock: Skip over duplicate paths</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187635"><strong>Date</strong></a></li>
<li><a href="index.html#187635"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

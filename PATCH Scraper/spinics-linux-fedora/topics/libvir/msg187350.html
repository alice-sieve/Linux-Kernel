<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH v5 16/20] tpm: Use fd to pass password to	swtpm_setup and swtpm -->
<!--X-From-R13: Egrsna Pretre &#60;fgrsnaoNyvahk.iarg.voz.pbz> -->
<!--X-Date: Fri, 12 Jul 2019 09:24:27 &#45;0700 -->
<!--X-Message-Id: 20190712162354.2366936&#45;17&#45;stefanb@linux.vnet.ibm.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190712162354.2366936&#45;1&#45;stefanb@linux.vnet.ibm.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; [PATCH v5 16/20] tpm: Use fd to pass password to	swtpm_setup and swtpm</title>
<meta name="description" content="libvirt: [PATCH v5 16/20] tpm: Use fd to pass password to	swtpm_setup and swtpm">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>[PATCH v5 16/20] tpm: Use fd to pass password to	swtpm_setup and swtpm</h1>
[<a href="msg187349.html">Date Prev</a>][<a href="msg187351.html">Date Next</a>][<a href="msg187349.html">Thread Prev</a>][<a href="msg187351.html">Thread Next</a>][<a href="maillist.html#187350">Date Index</a>][<a href="index.html#187350">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH v5 16/20] tpm: Use fd to pass password to	swtpm_setup and swtpm</li>
<li><em>From</em>: Stefan Berger &lt;stefanb@xxxxxxxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Fri, 12 Jul 2019 12:23:50 -0400</li>
<li><em>Cc</em>: marcandre.lureau@xxxxxxxxxx, Stefan Berger &lt;stefanb@xxxxxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187340.html">20190712162354.2366936-1-stefanb@linux.vnet.ibm.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187340.html">20190712162354.2366936-1-stefanb@linux.vnet.ibm.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Allow vTPM state encryption when swtpm_setup and swtpm support
passing a passphrase using a file descriptor.

This patch enables the encryption of the vTPM state only. It does
not encrypt the state during migration, so the destination secret
does not need to have the same password at this point.

Signed-off-by: Stefan Berger &lt;stefanb@xxxxxxxxxxxxx&gt;
---
 src/libvirt_private.syms |   2 +
 src/qemu/qemu_tpm.c      | 110 ++++++++++++++++++++++++++++++++++++++-
 src/util/virtpm.c        |  16 ++++++
 src/util/virtpm.h        |   3 ++
 4 files changed, 129 insertions(+), 2 deletions(-)

diff --git a/src/libvirt_private.syms b/src/libvirt_private.syms
index 13829563e9..b531ab1efa 100644
--- a/src/libvirt_private.syms
+++ b/src/libvirt_private.syms
@@ -3182,7 +3182,9 @@ virTPMEmulatorInit;
 virTPMGetSwtpm;
 virTPMGetSwtpmIoctl;
 virTPMGetSwtpmSetup;
+virTPMSwtpmCapsGet;
 virTPMSwtpmFeatureTypeFromString;
+virTPMSwtpmSetupCapsGet;
 virTPMSwtpmSetupFeatureTypeFromString;
 
 
diff --git a/src/qemu/qemu_tpm.c b/src/qemu/qemu_tpm.c
index 2afa8db448..3bec68bce6 100644
--- a/src/qemu/qemu_tpm.c
+++ b/src/qemu/qemu_tpm.c
@@ -43,6 +43,7 @@
 #include &quot;dirname.h&quot;
 #include &quot;qemu_tpm.h&quot;
 #include &quot;virtpm.h&quot;
+#include &quot;secret_util.h&quot;
 
 #define VIR_FROM_THIS VIR_FROM_NONE
 
@@ -372,6 +373,66 @@ qemuTPMEmulatorPrepareHost(virDomainTPMDefPtr tpm,
     return ret;
 }
 
+/*
+ * qemuTPMSetupEncryption
+ *
+ * @secretuuid: The UUID with the secret holding passphrase
+ * @cmd: the virCommand to transfer the secret to
+ *
+ * Returns file descriptor representing the read-end of a pipe.
+ * The passphrase can be read from this pipe. Returns &lt; 0 in case
+ * of error.
+ *
+ * This function reads the passphrase and writes it into the
+ * write-end of a pipe so that the read-end of the pipe can be
+ * passed to the emulator for reading the passphrase from.
+ */
+static int
+qemuTPMSetupEncryption(const unsigned char *secretuuid,
+                       virCommandPtr cmd)
+{
+    int ret = -1;
+    int pipefd[2] = { -1, -1 };
+    virConnectPtr conn;
+    VIR_AUTOFREE(uint8_t *) secret = NULL;
+    size_t secret_len;
+    virSecretLookupTypeDef seclookupdef = {
+         .type = VIR_SECRET_LOOKUP_TYPE_UUID,
+    };
+
+    conn = virGetConnectSecret();
+    if (!conn)
+        return -1;
+
+    memcpy(seclookupdef.u.uuid, secretuuid, sizeof(seclookupdef.u.uuid));
+    if (virSecretGetSecretString(conn, &amp;seclookupdef,
+                                 VIR_SECRET_USAGE_TYPE_VTPM,
+                                 &amp;secret, &amp;secret_len) &lt; 0)
+        goto error;
+
+    if (pipe(pipefd) == -1) {
+        virReportSystemError(errno, &quot;%s&quot;,
+                             _(&quot;Unable to create pipe&quot;));
+        goto error;
+    }
+
+    if (virCommandSetSendBuffer(cmd, pipefd[1], secret, secret_len) &lt; 0)
+        goto error;
+
+    secret = NULL;
+    ret = pipefd[0];
+
+ cleanup:
+    virObjectUnref(conn);
+
+    return ret;
+
+ error:
+    VIR_FORCE_CLOSE(pipefd[1]);
+    VIR_FORCE_CLOSE(pipefd[0]);
+
+    goto cleanup;
+}
 
 /*
  * qemuTPMEmulatorRunSetup
@@ -386,6 +447,7 @@ qemuTPMEmulatorPrepareHost(virDomainTPMDefPtr tpm,
  * @logfile: The file to write the log into; it must be writable
  *           for the user given by userid or 'tss'
  * @tpmversion: The version of the TPM, either a TPM 1.2 or TPM 2
+ * @encryption: pointer to virStorageEncryption holding secret
  *
  * Setup the external swtpm by creating endorsement key and
  * certificates for it.
@@ -398,13 +460,15 @@ qemuTPMEmulatorRunSetup(const char *storagepath,
                         uid_t swtpm_user,
                         gid_t swtpm_group,
                         const char *logfile,
-                        const virDomainTPMVersion tpmversion)
+                        const virDomainTPMVersion tpmversion,
+                        const unsigned char *secretuuid)
 {
     virCommandPtr cmd = NULL;
     int exitstatus;
     int ret = -1;
     char uuid[VIR_UUID_STRING_BUFLEN];
     char *vmid = NULL;
+    VIR_AUTOCLOSE pwdfile_fd = -1;
 
     if (!privileged &amp;&amp; tpmversion == VIR_DOMAIN_TPM_VERSION_1_2)
         return virFileWriteStr(logfile,
@@ -434,6 +498,23 @@ qemuTPMEmulatorRunSetup(const char *storagepath,
         break;
     }
 
+    if (secretuuid) {
+        if (!virTPMSwtpmSetupCapsGet(
+                VIR_TPM_SWTPM_SETUP_FEATURE_CMDARG_PWDFILE_FD)) {
+            virReportError(VIR_ERR_ARGUMENT_UNSUPPORTED,
+                _(&quot;%s does not support passing a passphrase using a file &quot;
+                  &quot;descriptor&quot;), virTPMGetSwtpmSetup());
+            goto cleanup;
+        }
+        if ((pwdfile_fd = qemuTPMSetupEncryption(secretuuid, cmd)) &lt; 0)
+            goto cleanup;
+
+        virCommandAddArg(cmd, &quot;--pwdfile-fd&quot;);
+        virCommandAddArgFormat(cmd, &quot;%d&quot;, pwdfile_fd);
+        virCommandAddArgList(cmd, &quot;--cipher&quot;, &quot;aes-256-cbc&quot;, NULL);
+        virCommandPassFD(cmd, pwdfile_fd, VIR_COMMAND_PASS_FD_CLOSE_PARENT);
+        pwdfile_fd = -1;
+    }
 
     virCommandAddArgList(cmd,
                          &quot;--tpm-state&quot;, storagepath,
@@ -496,15 +577,21 @@ qemuTPMEmulatorBuildCommand(virDomainTPMDefPtr tpm,
     virCommandPtr cmd = NULL;
     bool created = false;
     char *pidfile;
+    VIR_AUTOCLOSE pwdfile_fd = -1;
+    const unsigned char *secretuuid = NULL;
 
     if (qemuTPMCreateEmulatorStorage(tpm-&gt;data.emulator.storagepath,
                                      &amp;created, swtpm_user, swtpm_group) &lt; 0)
         return NULL;
 
+    if (tpm-&gt;data.emulator.hassecretuuid)
+        secretuuid = tpm-&gt;data.emulator.secretuuid;
+
     if (created &amp;&amp;
         qemuTPMEmulatorRunSetup(tpm-&gt;data.emulator.storagepath, vmname, vmuuid,
                                 privileged, swtpm_user, swtpm_group,
-                                tpm-&gt;data.emulator.logfile, tpm-&gt;version) &lt; 0)
+                                tpm-&gt;data.emulator.logfile, tpm-&gt;version,
+                                secretuuid) &lt; 0)
         goto error;
 
     unlink(tpm-&gt;data.emulator.source.data.nix.path);
@@ -547,6 +634,25 @@ qemuTPMEmulatorBuildCommand(virDomainTPMDefPtr tpm,
     virCommandAddArgFormat(cmd, &quot;file=%s&quot;, pidfile);
     VIR_FREE(pidfile);
 
+    if (tpm-&gt;data.emulator.hassecretuuid) {
+        if (!virTPMSwtpmCapsGet(VIR_TPM_SWTPM_FEATURE_CMDARG_PWD_FD)) {
+            virReportError(VIR_ERR_ARGUMENT_UNSUPPORTED,
+                  _(&quot;%s does not support passing passphrase via file descriptor&quot;),
+                  virTPMGetSwtpm());
+            goto error;
+        }
+
+        pwdfile_fd = qemuTPMSetupEncryption(tpm-&gt;data.emulator.secretuuid, cmd);
+        if (pwdfile_fd)
+            goto error;
+
+        virCommandAddArg(cmd, &quot;--key&quot;);
+        virCommandAddArgFormat(cmd, &quot;pwdfd=%d,mode=aes-256-cbc,kdf=pbkdf2&quot;,
+                               pwdfile_fd);
+        virCommandPassFD(cmd, pwdfile_fd, VIR_COMMAND_PASS_FD_CLOSE_PARENT);
+        pwdfile_fd = -1;
+    }
+
     return cmd;
 
  error:
diff --git a/src/util/virtpm.c b/src/util/virtpm.c
index 692033e899..eda16a8c57 100644
--- a/src/util/virtpm.c
+++ b/src/util/virtpm.c
@@ -317,3 +317,19 @@ virTPMEmulatorInit(void)
 
     return 0;
 }
+
+bool
+virTPMSwtpmCapsGet(unsigned int cap)
+{
+    if (virTPMEmulatorInit() &lt; 0)
+        return false;
+    return virBitmapIsBitSet(swtpm_caps, cap);
+}
+
+bool
+virTPMSwtpmSetupCapsGet(unsigned int cap)
+{
+    if (virTPMEmulatorInit() &lt; 0)
+        return false;
+    return virBitmapIsBitSet(swtpm_setup_caps, cap);
+}
diff --git a/src/util/virtpm.h b/src/util/virtpm.h
index f3dc40cd68..40bde4c666 100644
--- a/src/util/virtpm.h
+++ b/src/util/virtpm.h
@@ -27,6 +27,9 @@ const char *virTPMGetSwtpmSetup(void);
 const char *virTPMGetSwtpmIoctl(void);
 int virTPMEmulatorInit(void);
 
+bool virTPMSwtpmCapsGet(unsigned int cap);
+bool virTPMSwtpmSetupCapsGet(unsigned int cap);
+
 typedef enum {
     VIR_TPM_SWTPM_FEATURE_CMDARG_PWD_FD,
 
-- 
2.20.1

--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187349.html">[PATCH v5 01/20] secret: Add support for usage type vTPM,	extend schema and test case</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187351.html">[PATCH v5 18/20] tpm: Check TPM XML device configuration	changes after edit</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187349.html">[PATCH v5 01/20] secret: Add support for usage type vTPM,	extend schema and test case</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187351.html">[PATCH v5 18/20] tpm: Check TPM XML device configuration	changes after edit</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187350"><strong>Date</strong></a></li>
<li><a href="index.html#187350"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH 24/29] remote: open secondary drivers via remote	driver if needed -->
<!--X-From-R13: =?GFT&#45;8?d?Rnavry=20B=2S=20Preenat=Q3=O9?= &#60;oreenatrNerqung.pbz> -->
<!--X-Date: Thu, 11 Jul 2019 09:05:56 &#45;0700 -->
<!--X-Message-Id: 20190711160516.2130&#45;25&#45;berrange@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190711160516.2130&#45;1&#45;berrange@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; [PATCH 24/29] remote: open secondary drivers via remote	driver if needed</title>
<meta name="description" content="libvirt: [PATCH 24/29] remote: open secondary drivers via remote	driver if needed">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>[PATCH 24/29] remote: open secondary drivers via remote	driver if needed</h1>
[<a href="msg187219.html">Date Prev</a>][<a href="msg187221.html">Date Next</a>][<a href="msg187219.html">Thread Prev</a>][<a href="msg187290.html">Thread Next</a>][<a href="maillist.html#187220">Date Index</a>][<a href="index.html#187220">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH 24/29] remote: open secondary drivers via remote	driver if needed</li>
<li><em>From</em>: Daniel P. Berrang&#xE9; &lt;berrange@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 11 Jul 2019 17:05:11 +0100</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187198.html">20190711160516.2130-1-berrange@redhat.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187198.html">20190711160516.2130-1-berrange@redhat.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>When the client has a connection to one of the hypervisor specific
daemons (eg virtqemud), the app may still expect to use the secondary
driver APIs (storage, network, etc). None of these will be registered in
the hypervisor daemon, so we must explicitly open a connection to each
of the daemons for the secondary drivers we need.

Signed-off-by: Daniel P. Berrang&#xE9; &lt;berrange@xxxxxxxxxx&gt;
---
 src/remote/remote_daemon_dispatch.c | 82 ++++++++++++++++++++++++-----
 1 file changed, 69 insertions(+), 13 deletions(-)

diff --git a/src/remote/remote_daemon_dispatch.c b/src/remote/remote_daemon_dispatch.c
index 856c5e48e7..c8a605c709 100644
--- a/src/remote/remote_daemon_dispatch.c
+++ b/src/remote/remote_daemon_dispatch.c
@@ -1954,6 +1954,9 @@ remoteDispatchConnectOpen(virNetServerPtr server ATTRIBUTE_UNUSED,
     unsigned int flags;
     struct daemonClientPrivate *priv = virNetServerClientGetPrivateData(client);
     int rv = -1;
+#ifndef LIBVIRTD
+    const char *type = NULL;
+#endif
 
     VIR_DEBUG(&quot;priv=%p conn=%p&quot;, priv, priv-&gt;conn);
     virMutexLock(&amp;priv-&gt;lock);
@@ -1972,20 +1975,73 @@ remoteDispatchConnectOpen(virNetServerPtr server ATTRIBUTE_UNUSED,
     if (virNetServerClientGetReadonly(client))
         flags |= VIR_CONNECT_RO;
 
-    priv-&gt;conn =
-        flags &amp; VIR_CONNECT_RO
-        ? virConnectOpenReadOnly(name)
-        : virConnectOpen(name);
-
-    if (priv-&gt;conn == NULL)
-        goto cleanup;
+#define OPEN_DRIVER(var, uri) \
+    do {                                 \
+        VIR_DEBUG(&quot;Opening driver %s&quot;, uri); \
+        if (!(priv-&gt;var = flags &amp; VIR_CONNECT_RO  \
+                    ? virConnectOpenReadOnly(uri) \
+                    : virConnectOpen(uri))) \
+          goto cleanup; \
+        VIR_DEBUG(&quot;Opened %p&quot;, priv-&gt;var); \
+    } while (0)
 
-    priv-&gt;interfaceConn = virObjectRef(priv-&gt;conn);
-    priv-&gt;networkConn = virObjectRef(priv-&gt;conn);
-    priv-&gt;nodedevConn = virObjectRef(priv-&gt;conn);
-    priv-&gt;nwfilterConn = virObjectRef(priv-&gt;conn);
-    priv-&gt;secretConn = virObjectRef(priv-&gt;conn);
-    priv-&gt;storageConn = virObjectRef(priv-&gt;conn);
+    OPEN_DRIVER(conn, name);
+
+#ifndef LIBVIRTD
+    if (!(type = virConnectGetType(priv-&gt;conn)))
+        goto cleanup;
+
+    VIR_DEBUG(&quot;Primary driver type is '%s'&quot;, type);
+    if (STREQ(type, &quot;QEMU&quot;) ||
+        STREQ(type, &quot;LIBXL&quot;) ||
+        STREQ(type, &quot;LXC&quot;) ||
+        STREQ(type, &quot;VBOX&quot;) ||
+        STREQ(type, &quot;bhyve&quot;) ||
+        STREQ(type, &quot;vz&quot;) ||
+        STREQ(type, &quot;Parallels&quot;)) {
+        VIR_DEBUG(&quot;Hypervisor driver found, opening connections to secondary drivers&quot;);
+        OPEN_DRIVER(interfaceConn, getuid() == 0 ? &quot;interface:///system&quot; : &quot;interface:///session&quot;);
+        OPEN_DRIVER(networkConn, getuid() == 0 ? &quot;network:///system&quot; : &quot;network:///session&quot;);
+        OPEN_DRIVER(nodedevConn, getuid() == 0 ? &quot;nodedev:///system&quot; : &quot;nodedev:///session&quot;);
+        if (getuid() == 0)
+            OPEN_DRIVER(nwfilterConn, &quot;nwfilter:///system&quot;);
+        OPEN_DRIVER(secretConn, getuid() == 0 ? &quot;secret:///system&quot; : &quot;secret:///session&quot;);
+        OPEN_DRIVER(storageConn, getuid() == 0 ? &quot;storage:///system&quot; : &quot;storage:///session&quot;);
+    } else if (STREQ(type, &quot;interface&quot;)) {
+        VIR_DEBUG(&quot;Interface driver found&quot;);
+        priv-&gt;interfaceConn = virObjectRef(priv-&gt;conn);
+    } else if (STREQ(type, &quot;network&quot;)) {
+        VIR_DEBUG(&quot;Network driver found&quot;);
+        priv-&gt;networkConn = virObjectRef(priv-&gt;conn);
+    } else if (STREQ(type, &quot;nodedev&quot;)) {
+        VIR_DEBUG(&quot;Nodedev driver found&quot;);
+        priv-&gt;nodedevConn = virObjectRef(priv-&gt;conn);
+    } else if (STREQ(type, &quot;nwfilter&quot;)) {
+        VIR_DEBUG(&quot;NWFilter driver found&quot;);
+        priv-&gt;nwfilterConn = virObjectRef(priv-&gt;conn);
+    } else if (STREQ(type, &quot;secret&quot;)) {
+        VIR_DEBUG(&quot;Secret driver found&quot;);
+        priv-&gt;secretConn = virObjectRef(priv-&gt;conn);
+    } else if (STREQ(type, &quot;storage&quot;)) {
+        VIR_DEBUG(&quot;Storage driver found&quot;);
+        priv-&gt;storageConn = virObjectRef(priv-&gt;conn);
+
+        /* Co-open the secret driver, as apps using the storage driver may well
+         * need access to secrets for storage auth
+         */
+        OPEN_DRIVER(secretConn, getuid == 0 ? &quot;secret:///system&quot; : &quot;secret:///session&quot;);
+    } else {
+#endif /* LIBVIRTD */
+        VIR_DEBUG(&quot;Pointing secondary drivers to primary&quot;);
+        priv-&gt;interfaceConn = virObjectRef(priv-&gt;conn);
+        priv-&gt;networkConn = virObjectRef(priv-&gt;conn);
+        priv-&gt;nodedevConn = virObjectRef(priv-&gt;conn);
+        priv-&gt;nwfilterConn = virObjectRef(priv-&gt;conn);
+        priv-&gt;secretConn = virObjectRef(priv-&gt;conn);
+        priv-&gt;storageConn = virObjectRef(priv-&gt;conn);
+#ifndef LIBVIRTD
+    }
+#endif /* LIBVIRTD */
 
     /* force update the @readonly attribute which was inherited from the
      * virNetServerService object - this is important for sockets that are RW
-- 
2.21.0

--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187219.html">[PATCH 14/29] storage: introduce virtstoraged daemon</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187221.html">[PATCH 16/29] nwfilter: introduce virtnwfilterd daemon</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187219.html">[PATCH 14/29] storage: introduce virtstoraged daemon</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187290.html">Re:  [PATCH 24/29] remote: open secondary drivers via remote driver if needed</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187220"><strong>Date</strong></a></li>
<li><a href="index.html#187220"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

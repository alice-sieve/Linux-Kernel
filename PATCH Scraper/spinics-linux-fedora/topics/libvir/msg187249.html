<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH v4 13/23] utils: Implement function to pass a	buffer to send via a fd to virCommand -->
<!--X-From-R13: Egrsna Pretre &#60;fgrsnaoNyvahk.iarg.voz.pbz> -->
<!--X-Date: Thu, 11 Jul 2019 12:43:06 &#45;0700 -->
<!--X-Message-Id: 20190711194151.3728114&#45;14&#45;stefanb@linux.vnet.ibm.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190711194151.3728114&#45;1&#45;stefanb@linux.vnet.ibm.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; [PATCH v4 13/23] utils: Implement function to pass a	buffer to send via a fd to virCommand</title>
<meta name="description" content="libvirt: [PATCH v4 13/23] utils: Implement function to pass a	buffer to send via a fd to virCommand">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>[PATCH v4 13/23] utils: Implement function to pass a	buffer to send via a fd to virCommand</h1>
[<a href="msg187248.html">Date Prev</a>][<a href="msg187250.html">Date Next</a>][<a href="msg187281.html">Thread Prev</a>][<a href="msg187250.html">Thread Next</a>][<a href="maillist.html#187249">Date Index</a>][<a href="index.html#187249">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH v4 13/23] utils: Implement function to pass a	buffer to send via a fd to virCommand</li>
<li><em>From</em>: Stefan Berger &lt;stefanb@xxxxxxxxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 11 Jul 2019 15:41:41 -0400</li>
<li><em>Cc</em>: marcandre.lureau@xxxxxxxxxx, Stefan Berger &lt;stefanb@xxxxxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187236.html">20190711194151.3728114-1-stefanb@linux.vnet.ibm.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187236.html">20190711194151.3728114-1-stefanb@linux.vnet.ibm.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Implement virCommandSetSendBuffer() that allows the caller to pass a
file descriptor and buffer to virCommand. virCommand will write the
buffer into the file descriptor. That file descriptor could be the
write end of a pipe or one of the file descriptors of a socketpair.
The other file descriptor should be passed to the launched process to
read the data from.

Only implement the function to allocate memory for send buffers
and to free them later on.

Signed-off-by: Stefan Berger &lt;stefanb@xxxxxxxxxxxxx&gt;
---
 src/libvirt_private.syms |  1 +
 src/util/vircommand.c    | 76 ++++++++++++++++++++++++++++++++++++++++
 src/util/vircommand.h    |  5 +++
 3 files changed, 82 insertions(+)

diff --git a/src/libvirt_private.syms b/src/libvirt_private.syms
index d2045895a1..62366d4fbe 100644
--- a/src/libvirt_private.syms
+++ b/src/libvirt_private.syms
@@ -1735,6 +1735,7 @@ virCommandSetOutputFD;
 virCommandSetPidFile;
 virCommandSetPreExecHook;
 virCommandSetSELinuxLabel;
+virCommandSetSendBuffer;
 virCommandSetUID;
 virCommandSetUmask;
 virCommandSetWorkingDirectory;
diff --git a/src/util/vircommand.c b/src/util/vircommand.c
index 8695c98d1b..9972a491d6 100644
--- a/src/util/vircommand.c
+++ b/src/util/vircommand.c
@@ -77,6 +77,16 @@ struct _virCommandFD {
     unsigned int flags;
 };
 
+typedef struct _virCommandSendBuffer virCommandSendBuffer;
+typedef virCommandSendBuffer *virCommandSendBufferPtr;
+
+struct _virCommandSendBuffer {
+    int fd;
+    unsigned char *buffer;
+    size_t buflen;
+    off_t offset;
+};
+
 struct _virCommand {
     int has_error; /* ENOMEM on allocation failure, -1 for anything else.  */
 
@@ -136,6 +146,9 @@ struct _virCommand {
     char *appArmorProfile;
 #endif
     int mask;
+
+    virCommandSendBufferPtr sendBuffers;
+    size_t numSendBuffers;
 };
 
 /* See virCommandSetDryRun for description for this variable */
@@ -1741,6 +1754,67 @@ virCommandSetWorkingDirectory(virCommandPtr cmd, const char *pwd)
 }
 
 
+static int
+virCommandGetNumSendBuffers(virCommandPtr cmd)
+{
+    return cmd-&gt;numSendBuffers;
+}
+
+
+static void
+virCommandFreeSendBuffers(virCommandPtr cmd)
+{
+    size_t i;
+
+    for (i = 0; i &lt; virCommandGetNumSendBuffers(cmd); i++) {
+        VIR_FORCE_CLOSE(cmd-&gt;sendBuffers[i].fd);
+        VIR_FREE(cmd-&gt;sendBuffers[i].buffer);
+    }
+    VIR_FREE(cmd-&gt;sendBuffers);
+}
+
+
+/**
+ * virCommandSetSendBuffer
+ * @cmd: the command to modify
+ *
+ * Pass a buffer to virCommand that will be written into the
+ * given file descriptor. The buffer will be freed automatically
+ * and the file descriptor closed.
+ */
+int
+virCommandSetSendBuffer(virCommandPtr cmd,
+                        int fd,
+                        unsigned char *buffer, size_t buflen)
+{
+    size_t i = virCommandGetNumSendBuffers(cmd);
+
+    if (!cmd || cmd-&gt;has_error)
+        return -1;
+
+    if (fcntl(fd, F_SETFL, O_NONBLOCK) &lt; 0) {
+        virReportSystemError(errno, &quot;%s&quot;,
+                             _(&quot;fcntl failed to set O_NONBLOCK&quot;));
+        cmd-&gt;has_error = errno;
+        return -1;
+    }
+
+    if (VIR_REALLOC_N(cmd-&gt;sendBuffers, i + 1) &lt; 0) {
+        cmd-&gt;has_error = ENOMEM;
+        return -1;
+    }
+
+    cmd-&gt;sendBuffers[i].fd = fd;
+    cmd-&gt;sendBuffers[i].buffer = buffer;
+    cmd-&gt;sendBuffers[i].buflen = buflen;
+    cmd-&gt;sendBuffers[i].offset = 0;
+
+    cmd-&gt;numSendBuffers++;
+
+    return 0;
+}
+
+
 /**
  * virCommandSetInputBuffer:
  * @cmd: the command to modify
@@ -2880,6 +2954,8 @@ virCommandFree(virCommandPtr cmd)
     VIR_FREE(cmd-&gt;appArmorProfile);
 #endif
 
+    virCommandFreeSendBuffers(cmd);
+
     VIR_FREE(cmd);
 }
 
diff --git a/src/util/vircommand.h b/src/util/vircommand.h
index c9a8d3c41c..716e84af3d 100644
--- a/src/util/vircommand.h
+++ b/src/util/vircommand.h
@@ -148,6 +148,11 @@ void virCommandAddArgList(virCommandPtr cmd,
 void virCommandSetWorkingDirectory(virCommandPtr cmd,
                                    const char *pwd) ATTRIBUTE_NONNULL(2);
 
+int virCommandSetSendBuffer(virCommandPtr cmd,
+                            int fd,
+                            unsigned char *buffer, size_t buflen)
+    ATTRIBUTE_NONNULL(1) ATTRIBUTE_NONNULL(3);
+
 void virCommandSetInputBuffer(virCommandPtr cmd,
                               const char *inbuf) ATTRIBUTE_NONNULL(2);
 
-- 
2.20.1

--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187248.html">[PATCH v4 16/23] utils: Mark inpipe as non-blocking</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187250.html">[PATCH v4 17/23] utils: Extend virCommandProcessIO to	include the send buffers</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187281.html">Re:  [PATCH v4 16/23] utils: Mark inpipe as non-blocking</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187250.html">[PATCH v4 17/23] utils: Extend virCommandProcessIO to	include the send buffers</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187249"><strong>Date</strong></a></li>
<li><a href="index.html#187249"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH 2/2] virSecurityManagerMetadataLock: Skip over duplicate paths -->
<!--X-From-R13: Rnavry Vraevdhr Pneobmn &#60;qnavryuo413Ntznvy.pbz> -->
<!--X-Date: Thu, 18 Jul 2019 05:52:40 &#45;0700 -->
<!--X-Message-Id: 37037e65&#45;532a&#45;3489&#45;5058&#45;8aa799b31afe@gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: cover.1563441249.git.mprivozn@redhat.com -->
<!--X-Reference: b6e8d014badbbba6a0fbc52230825c6bfeea6b92.1563441249.git.mprivozn@redhat.com -->
<!--X-Reference: 20190718092857.GB15411@redhat.com -->
<!--X-Reference: f8d18a2c&#45;0d35&#45;7ca1&#45;79bd&#45;9d403d9f7c78@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; Re:  [PATCH 2/2] virSecurityManagerMetadataLock: Skip over duplicate paths</title>
<meta name="description" content="libvirt: Re:  [PATCH 2/2] virSecurityManagerMetadataLock: Skip over duplicate paths">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>Re:  [PATCH 2/2] virSecurityManagerMetadataLock: Skip over duplicate paths</h1>
[<a href="msg187652.html">Date Prev</a>][<a href="msg187654.html">Date Next</a>][<a href="msg187643.html">Thread Prev</a>][<a href="msg187632.html">Thread Next</a>][<a href="maillist.html#187653">Date Index</a>][<a href="index.html#187653">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH 2/2] virSecurityManagerMetadataLock: Skip over duplicate paths</li>
<li><em>From</em>: Daniel Henrique Barboza &lt;danielhb413@xxxxxxxxx&gt;</li>
<li><em>Date</em>: Thu, 18 Jul 2019 09:52:27 -0300</li>
<li><em>Cc</em>: libvir-list@xxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187643.html">f8d18a2c-0d35-7ca1-79bd-9d403d9f7c78@redhat.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187633.html">cover.1563441249.git.mprivozn@redhat.com</a>&gt;	&lt;<a href="msg187631.html">b6e8d014badbbba6a0fbc52230825c6bfeea6b92.1563441249.git.mprivozn@redhat.com</a>&gt;	&lt;<a href="msg187635.html">20190718092857.GB15411@redhat.com</a>&gt;	&lt;<a href="msg187643.html">f8d18a2c-0d35-7ca1-79bd-9d403d9f7c78@redhat.com</a>&gt;</li>
<li><em>User-agent</em>: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101	Thunderbird/60.7.2</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">


On 7/18/19 8:30 AM, Michal Privoznik wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On 7/18/19 11:28 AM, Daniel P. Berrang&#xE9; wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
On Thu, Jul 18, 2019 at 11:14:49AM +0200, Michal Privoznik wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
If there are two paths on the list that are the same we need to
lock it only once. Because when we try to lock it the second time
then open() fails. And if it didn't, locking it the second time
would fail for sure. After all, it is sufficient to lock all
paths just once satisfy the caller.

Reported-by: Daniel Henrique Barboza &lt;danielhb413@xxxxxxxxx&gt;
Signed-off-by: Michal Privoznik &lt;mprivozn@xxxxxxxxxx&gt;
---
&#xA0; src/security/security_manager.c | 23 +++++++++++++++++++++--
&#xA0; 1 file changed, 21 insertions(+), 2 deletions(-)
</pre></blockquote><pre style="margin: 0em;">

Reviewed-by: Daniel P. Berrang&#xE9; &lt;berrange@xxxxxxxxxx&gt;


</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

</pre><tt>diff --git a/src/security/security_manager.c 
</tt><tt>b/src/security/security_manager.c
</tt><pre style="margin: 0em;">
index ade2c96141..7c905f0785 100644
--- a/src/security/security_manager.c
+++ b/src/security/security_manager.c
</pre><tt>@@ -1294,16 +1294,35 @@ 
</tt><tt>virSecurityManagerMetadataLock(virSecurityManagerPtr mgr 
</tt><tt>ATTRIBUTE_UNUSED,
</tt><pre style="margin: 0em;">
&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * paths A B and there's another that is trying to lock them
&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * in reversed order a deadlock might occur.&#xA0; But if we sort
&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * the paths alphabetically then both processes will try lock
-&#xA0;&#xA0;&#xA0;&#xA0; * paths in the same order and thus no deadlock can occur. */
+&#xA0;&#xA0;&#xA0;&#xA0; * paths in the same order and thus no deadlock can occur.
+&#xA0;&#xA0;&#xA0;&#xA0; * Lastly, it makes searching for duplicate paths below
+&#xA0;&#xA0;&#xA0;&#xA0; * simpler. */
&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; qsort(paths, npaths, sizeof(*paths), cmpstringp);
&#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; for (i = 0; i &lt; npaths; i++) {
&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; const char *p = paths[i];
&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; struct stat sb;
+&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; size_t j;
&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; int retries = 10 * 1000;
&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; int fd;
&#xA0; -&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (!p || stat(p, &amp;sb) &lt; 0)
+&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (!p)
+&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; continue;
+
+&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; /* If there's a duplicate path on the list, skip it over.
+&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * Not only we would fail open()-ing it the second time,
+&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * we would deadlock with ourselves trying to lock it the
+&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * second time. After all, we've locked it when iterating
+&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; * over it the first time. */
</pre></blockquote><pre style="margin: 0em;">

Presumably this deals with the problem at cold boot. Is it possible
to hit the same problem when we have cold plugged one device and
then later try to hotplug another device using the same resource,
or do the SRIOV assignment grouping requirements make the hotplug
impossible ?
</pre></blockquote><pre style="margin: 0em;">

</pre><tt>Okay, so digging deeper I think I know what the problem is. In 
</tt><tt>general, it is of course possible to open a file multiple times, but 
</tt><tt>that is not true for &quot;/dev/vfio/N&quot; which can be opened exactly one 
</tt><tt>time. Indeed, looking into vfio_group_fops_open() in 
</tt><tt>kernel.git/drivers/vfio/vfio.c if a group is already opened, then 
</tt><tt>-EBUSY is returned (what we've seen in the error message). In fact, 
</tt><tt>git log blames v3.11-rc1~46^2~1 which explicitly disallowed multiple 
</tt><tt>open()-s.
</tt><pre style="margin: 0em;">

</pre><tt>So, in theory, our code works, because we open() the files we are 
</tt><tt>chown()-ing and close them immediatelly after. So the problem in which 
</tt><tt>we try to lock /dev/vfio/N multiple times won't happen. However, since 
</tt><tt>qemu already has the device opened, we will fail opening it.
</tt><pre style="margin: 0em;">

I can see two options here:

</pre><tt>1) ignore this specific error in virSecurityManagerMetadataLock(). 
</tt><tt>This will of course mean that the caller 
</tt><tt>(virSecurityDACTransactionRun()) will chown() the /dev/vfio/N file 
</tt><tt>without a lock, but then again, we have namespaces and there can't be 
</tt><tt>any other domain using the path. And also, we don't really chown() if 
</tt><tt>the file already has the correct owner - which is going to be 99.99% 
</tt><tt>cases unless there would be different seclabels for two PCI devices 
</tt><tt>(do we even allow &lt;seclabel/&gt; for &lt;hostdev/&gt;?).
</tt></blockquote><pre style="margin: 0em;">

</pre><tt>This option seems better to me because it already establishes an 
</tt><tt>exception rule for
</tt><tt>files that can be opened only once. For now we found out about 
</tt><tt>/dev/vfio/N files,&#xA0; but
</tt><tt>there might be more in the future, and then it is just a matter of 
</tt><tt>adding more files
</tt><pre style="margin: 0em;">
to this exception rule.


Thanks,


DHB

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">

</pre><tt>2) Make virSecurityDACSetHostdevLabel() and 
</tt><tt>virSecurityDACRestoreHostdevLabel() be NO-OP if a domain already/still 
</tt><tt>has a device from the same IOMMU group like the one we're 
</tt><tt>attaching/detaching. If these are NO-OPs then no relabel is done and 
</tt><tt>thus the whole code I'm modifying in 1) is not even called.
</tt><pre style="margin: 0em;">

I have a preference for 1) because the code will be cleaner IMO.

Michal
</pre></blockquote><pre style="margin: 0em;">

--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187652.html">Re:  [dockerfiles PATCH 0/3] Add libosinfo-related projects</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187654.html">Re:  [dockerfiles PATCH 2/3] refresh: Add libosinfo-related projects</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187643.html">Re:  [PATCH 2/2] virSecurityManagerMetadataLock: Skip over duplicate paths</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187632.html">[PATCH 1/2] virSecurityManagerMetadataLock: Expand the	comment on deadlocks</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187653"><strong>Date</strong></a></li>
<li><a href="index.html#187653"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

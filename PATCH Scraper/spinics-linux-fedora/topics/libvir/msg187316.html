<!-- MHonArc v2.6.19 -->
<!--X-Subject: [PATCH 05/25] qemu: domain: Add global table of blockjobs -->
<!--X-From-R13: Brgre Yerzcn &#60;cxerzcnNerqung.pbz> -->
<!--X-Date: Fri, 12 Jul 2019 09:06:23 &#45;0700 -->
<!--X-Message-Id: 9ee90fc0839836522cf60382e9d2070f15ce915d.1562947284.git.pkrempa@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: cover.1562947283.git.pkrempa@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; [PATCH 05/25] qemu: domain: Add global table of blockjobs</title>
<meta name="description" content="libvirt: [PATCH 05/25] qemu: domain: Add global table of blockjobs">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>[PATCH 05/25] qemu: domain: Add global table of blockjobs</h1>
[<a href="msg187315.html">Date Prev</a>][<a href="msg187321.html">Date Next</a>][<a href="msg187407.html">Thread Prev</a>][<a href="msg187408.html">Thread Next</a>][<a href="maillist.html#187316">Date Index</a>][<a href="index.html#187316">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [PATCH 05/25] qemu: domain: Add global table of blockjobs</li>
<li><em>From</em>: Peter Krempa &lt;pkrempa@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Fri, 12 Jul 2019 18:05:46 +0200</li>
<li><em>Cc</em>: Peter Krempa &lt;pkrempa@xxxxxxxxxx&gt;</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187317.html">cover.1562947283.git.pkrempa@redhat.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187317.html">cover.1562947283.git.pkrempa@redhat.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Block jobs currently belong to disks only so we can look up the block
job data for them in the corresponding disks. This won't be the case
when using blockdev as certain jobs don't even correspond to a disk and
most of them can run on a part of the backing chain.

Add a global table of blockjobs which can be used to look up the data
for the blockjobs when the job events need to be processed.

The table is a hash table organized by job name and has a reference to
the job. New and running jobs will later be added to this table.
Reference counting will allow to reap job state for synchronous callers.

Signed-off-by: Peter Krempa &lt;pkrempa@xxxxxxxxxx&gt;
---
 src/qemu/qemu_domain.c | 7 +++++++
 src/qemu/qemu_domain.h | 3 +++
 2 files changed, 10 insertions(+)

diff --git a/src/qemu/qemu_domain.c b/src/qemu/qemu_domain.c
index 073c9744d3..5af8f3b30c 100644
--- a/src/qemu/qemu_domain.c
+++ b/src/qemu/qemu_domain.c
@@ -1982,6 +1982,9 @@ qemuDomainObjPrivateAlloc(void *opaque)
     if (!(priv-&gt;devs = virChrdevAlloc()))
         goto error;

+    if (!(priv-&gt;blockjobs = virHashCreate(5, virObjectFreeHashData)))
+        goto error;
+
     priv-&gt;migMaxBandwidth = QEMU_DOMAIN_MIG_BANDWIDTH_MAX;
     priv-&gt;driver = opaque;

@@ -2051,6 +2054,8 @@ qemuDomainObjPrivateDataClear(qemuDomainObjPrivatePtr priv)

     qemuDomainObjResetJob(priv);
     qemuDomainObjResetAsyncJob(priv);
+
+    virHashRemoveAll(priv-&gt;blockjobs);
 }


@@ -2082,6 +2087,8 @@ qemuDomainObjPrivateFree(void *data)
     qemuDomainSecretInfoFree(&amp;priv-&gt;migSecinfo);
     qemuDomainMasterKeyFree(priv);

+    virHashFree(priv-&gt;blockjobs);
+
     VIR_FREE(priv);
 }

diff --git a/src/qemu/qemu_domain.h b/src/qemu/qemu_domain.h
index 12882d5b91..b42b205398 100644
--- a/src/qemu/qemu_domain.h
+++ b/src/qemu/qemu_domain.h
@@ -389,6 +389,9 @@ struct _qemuDomainObjPrivate {

     /* true if global -mem-prealloc appears on cmd line */
     bool memPrealloc;
+
+    /* running block jobs */
+    virHashTablePtr blockjobs;
 };

 #define QEMU_DOMAIN_PRIVATE(vm) \
-- 
2.21.0

--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187315.html">[PATCH 04/25] qemu: blockjob: Separate and unify block	job (un)registration</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187321.html">[PATCH 01/25] qemu: domain: Repurpose and export helper	for saving domain status XML</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187407.html">Re:  [PATCH 04/25] qemu: blockjob: Separate and unify block job (un)registration</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187408.html">Re:  [PATCH 05/25] qemu: domain: Add global table of blockjobs</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187316"><strong>Date</strong></a></li>
<li><a href="index.html#187316"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

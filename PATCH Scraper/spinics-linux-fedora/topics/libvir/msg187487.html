<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH v1 23/31] qemu_domain: Introduce NVMe path getting helpers -->
<!--X-From-R13: Brgre Yerzcn &#60;cxerzcnNerqung.pbz> -->
<!--X-Date: Tue, 16 Jul 2019 07:30:37 &#45;0700 -->
<!--X-Message-Id: 20190716143028.GE2061@angien.pipo.sk -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: cover.1562859733.git.mprivozn@redhat.com -->
<!--X-Reference: 7e389b790d3d56ba988ebb785a692f23cc9ce538.1562859733.git.mprivozn@redhat.com -->
<!--X-Derived: pgpHjykx_jlzH.pgp -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; Re:  [PATCH v1 23/31] qemu_domain: Introduce NVMe path getting helpers</title>
<meta name="description" content="libvirt: Re:  [PATCH v1 23/31] qemu_domain: Introduce NVMe path getting helpers">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>Re:  [PATCH v1 23/31] qemu_domain: Introduce NVMe path getting helpers</h1>
[<a href="msg187486.html">Date Prev</a>][<a href="msg187488.html">Date Next</a>][<a href="msg187183.html">Thread Prev</a>][<a href="msg187184.html">Thread Next</a>][<a href="maillist.html#187487">Date Index</a>][<a href="index.html#187487">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH v1 23/31] qemu_domain: Introduce NVMe path getting helpers</li>
<li><em>From</em>: Peter Krempa &lt;pkrempa@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 16 Jul 2019 16:30:28 +0200</li>
<li><em>Cc</em>: libvir-list@xxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187183.html">7e389b790d3d56ba988ebb785a692f23cc9ce538.1562859733.git.mprivozn@redhat.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187163.html">cover.1562859733.git.mprivozn@redhat.com</a>&gt;	&lt;<a href="msg187183.html">7e389b790d3d56ba988ebb785a692f23cc9ce538.1562859733.git.mprivozn@redhat.com</a>&gt;</li>
<li><em>User-agent</em>: Mutt/1.12.0 (2019-05-25)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Thu, Jul 11, 2019 at 17:54:10 +0200, Michal Privoznik wrote:
&gt; Couple of places in the QEMU driver will want to know what paths
&gt; are associated with NVMe disks (for instance CGroup code or
&gt; namespaces code). Introduce helpers which return desired paths
&gt; (for instance /dev/vfio/vfio and /dev/vfio/N).
&gt; 
&gt; Signed-off-by: Michal Privoznik &lt;mprivozn@xxxxxxxxxx&gt;
&gt; ---
&gt;  src/qemu/qemu_domain.c | 44 ++++++++++++++++++++++++++++++++++++++++++
&gt;  src/qemu/qemu_domain.h |  6 ++++++
&gt;  2 files changed, 50 insertions(+)
&gt; 
&gt; diff --git a/src/qemu/qemu_domain.c b/src/qemu/qemu_domain.c
&gt; index 2a7f09ce24..949bbace88 100644
&gt; --- a/src/qemu/qemu_domain.c
&gt; +++ b/src/qemu/qemu_domain.c
&gt; @@ -11723,6 +11723,50 @@ qemuDomainSupportsVideoVga(virDomainVideoDefPtr video,
&gt;  }
&gt;  
&gt;  
&gt; +char *
&gt; +qemuDomainGetNVMeDiskPath(const virStorageSourceNVMeDef *nvme)

Name of this function is VERY misleading. It returns path of the IOMMU
group associated with the host portion of the NVMe device, but the name
implies smething completely different.

Include IOMMUGroup in the name and add a comment.

&gt; +{
&gt; +    VIR_AUTOPTR(virPCIDevice) pci = NULL;
&gt; +
&gt; +    /* All NVMe devices are VFIO PCI devices */
&gt; +    if (!(pci = virPCIDeviceNew(nvme-&gt;pciAddr.domain,
&gt; +                                nvme-&gt;pciAddr.bus,
&gt; +                                nvme-&gt;pciAddr.slot,
&gt; +                                nvme-&gt;pciAddr.function)))
&gt; +        return NULL;
&gt; +
&gt; +    return virPCIDeviceGetIOMMUGroupDev(pci);
&gt; +}
&gt; +
&gt; +
&gt; +char **
&gt; +qemuDomainGetDiskNVMePaths(const virDomainDef *def,

Also this name looks troubling.

&gt; +                           const virStorageSource *src,
&gt; +                           bool teardown)
&gt; +{
&gt; +    VIR_AUTOFREE(char *) iommuGroup = NULL;
&gt; +    VIR_AUTOSTRINGLIST paths = NULL;
&gt; +    bool includeVFIO = !teardown;
&gt; +
&gt; +    if (!(iommuGroup = qemuDomainGetNVMeDiskPath(src-&gt;nvme)))
&gt; +        return NULL;
&gt; +
&gt; +    if (virStringListAdd(&amp;paths, iommuGroup) &lt; 0)
&gt; +        return NULL;
&gt; +
&gt; +    if (teardown &amp;&amp; def &amp;&amp;
&gt; +        !virDomainDefHasNVMeDisk(def) &amp;&amp;
&gt; +        !virDomainDefHasVFIOHostdev(def))
&gt; +        includeVFIO = true;
&gt; +
&gt; +    if (includeVFIO &amp;&amp;
&gt; +        virStringListAdd(&amp;paths, QEMU_DEV_VFIO) &lt; 0)
&gt; +        return NULL;

I don't like this. It's hiding the stuff necessary to detach VFIO groups
in random function and the hostdev code will require exactly the same
treatment. Additionally any further possible VFIO based device would
require 3 places.

Can't we consolidate that somehow?
</pre><p><strong>Attachment:
<a href="attachments/pgpHjykx_jlzH.pgp" ><tt>signature.asc</tt></a></strong><br>
<em>Description:</em> PGP signature</p>
<pre>--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a></pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187486.html">Re:  [PATCH v1 22/31] qemu_domain: Separate VFIO code</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187488.html">Re:  [PATCH v1 03/31] virpcimock: Move actions checking one level up</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187183.html">[PATCH v1 23/31] qemu_domain: Introduce NVMe path getting	helpers</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187184.html">[PATCH v1 26/31] security_selinux: Simplify	virSecuritySELinuxSetImageLabelInternal</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187487"><strong>Date</strong></a></li>
<li><a href="index.html#187487"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

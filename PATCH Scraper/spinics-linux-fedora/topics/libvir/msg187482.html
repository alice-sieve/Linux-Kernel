<!-- MHonArc v2.6.19 -->
<!--X-Subject: Re:  [PATCH v1 19/31] qemu: Take NVMe disks into account when calculating memlock limit -->
<!--X-From-R13: Brgre Yerzcn &#60;cxerzcnNerqung.pbz> -->
<!--X-Date: Tue, 16 Jul 2019 07:18:43 &#45;0700 -->
<!--X-Message-Id: 20190716141827.GZ2061@angien.pipo.sk -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: cover.1562859733.git.mprivozn@redhat.com -->
<!--X-Reference: 7254ac9220dfaa6eb63c378c535ed059cb09c525.1562859733.git.mprivozn@redhat.com -->
<!--X-Derived: pgpfRNyk6Q90p.pgp -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>libvirt &mdash; Re:  [PATCH v1 19/31] qemu: Take NVMe disks into account when calculating memlock limit</title>
<meta name="description" content="libvirt: Re:  [PATCH v1 19/31] qemu: Take NVMe disks into account when calculating memlock limit">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="Libvirt Development" href="//feeds.feedburner.com/Libvir">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:8422278960" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1>Re:  [PATCH v1 19/31] qemu: Take NVMe disks into account when calculating memlock limit</h1>
[<a href="msg187481.html">Date Prev</a>][<a href="msg187483.html">Date Next</a>][<a href="msg187180.html">Thread Prev</a>][<a href="msg187186.html">Thread Next</a>][<a href="maillist.html#187482">Date Index</a>][<a href="index.html#187482">Thread Index</a>] 


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: Re:  [PATCH v1 19/31] qemu: Take NVMe disks into account when calculating memlock limit</li>
<li><em>From</em>: Peter Krempa &lt;pkrempa@xxxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 16 Jul 2019 16:18:27 +0200</li>
<li><em>Cc</em>: libvir-list@xxxxxxxxxx</li>
<li><em>In-reply-to</em>: &lt;<a href="msg187180.html">7254ac9220dfaa6eb63c378c535ed059cb09c525.1562859733.git.mprivozn@redhat.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg187163.html">cover.1562859733.git.mprivozn@redhat.com</a>&gt;	&lt;<a href="msg187180.html">7254ac9220dfaa6eb63c378c535ed059cb09c525.1562859733.git.mprivozn@redhat.com</a>&gt;</li>
<li><em>User-agent</em>: Mutt/1.12.0 (2019-05-25)</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5196c2ae1be43d18&async=1&domready=1" async></script>
<!-- AddThis Button END -->
<hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive link 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="8681825769"
     data-ad-format="link"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<p>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>On Thu, Jul 11, 2019 at 17:54:06 +0200, Michal Privoznik wrote:
&gt; We have this beautiful function that does crystal ball
&gt; divination. The function is named
&gt; qemuDomainGetMemLockLimitBytes() and it calculates the upper
&gt; limit of how much locked memory is given guest going to need. The
&gt; function bases its guess on devices defined for a domain. For
&gt; instance, if there is a VFIO hostdev defined then it adds 1GiB to
&gt; the guessed maximum. Since NVMe disks are pretty much VFIO
&gt; hostdevs (but not quite), we have to do the same sorcery.
&gt; 
&gt; Signed-off-by: Michal Privoznik &lt;mprivozn@xxxxxxxxxx&gt;
&gt; ---
&gt;  src/qemu/qemu_domain.c | 15 +++++++++++++++
&gt;  1 file changed, 15 insertions(+)
&gt; 
&gt; diff --git a/src/qemu/qemu_domain.c b/src/qemu/qemu_domain.c
&gt; index f09abc8a73..09e5ee37f4 100644
&gt; --- a/src/qemu/qemu_domain.c
&gt; +++ b/src/qemu/qemu_domain.c


preceeding hunk


    for (i = 0; i &lt; def-&gt;nhostdevs; i++) {
        virDomainHostdevSubsysPtr subsys = &amp;def-&gt;hostdevs[i]-&gt;source.subsys;

        if (def-&gt;hostdevs[i]-&gt;mode == VIR_DOMAIN_HOSTDEV_MODE_SUBSYS &amp;&amp;
            (subsys-&gt;type == VIR_DOMAIN_HOSTDEV_SUBSYS_TYPE_MDEV ||
             (subsys-&gt;type == VIR_DOMAIN_HOSTDEV_SUBSYS_TYPE_PCI &amp;&amp;
              subsys-&gt;u.pci.backend == VIR_DOMAIN_HOSTDEV_PCI_BACKEND_VFIO))) {
            memKB = virDomainDefGetMemoryTotal(def) + 1024 * 1024;
            goto done;
        }
    }


&gt; @@ -10950,6 +10950,21 @@ qemuDomainGetMemLockLimitBytes(virDomainDefPtr def)
&gt;          }
&gt;      }
&gt;  
&gt; +    for (i = 0; i &lt; def-&gt;ndisks; i++) {
&gt; +        virDomainDiskDefPtr disk = def-&gt;disks[i];
&gt; +        virStorageSourcePtr n;
&gt; +
&gt; +        if (!disk-&gt;src)
&gt; +            continue;
&gt; +
&gt; +        for (n = disk-&gt;src; virStorageSourceIsBacking(n); n = n-&gt;backingStore) {
&gt; +            if (n-&gt;type == VIR_STORAGE_TYPE_NVME) {
&gt; +                memKB = virDomainDefGetMemoryTotal(def) + 1024 * 1024;
&gt; +                goto done;
&gt; +            }
&gt; +        }
&gt; +    }

Please set a booleand such as 'needVFIO' in the above hunk and here and
do the calculation once based on that boolean.

This implementation creates two instancess needing fixing in case when
we'd need to ever change the number.

ACK with that change
</pre><p><strong>Attachment:
<a href="attachments/pgpfRNyk6Q90p.pgp" ><tt>signature.asc</tt></a></strong><br>
<em>Description:</em> PGP signature</p>
<pre>--
libvir-list mailing list
libvir-list@xxxxxxxxxx
<a  rel="nofollow" href="https://www.redhat.com/mailman/listinfo/libvir-list">https://www.redhat.com/mailman/listinfo/libvir-list</a></pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg187481.html">Re:  [PATCH v1 17/31] virhostdevtest: Test virNVMeDevice assignment</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg187483.html">Re:  [PATCH v1 18/31] qemu: prepare NVMe devices too</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg187180.html">[PATCH v1 19/31] qemu: Take NVMe disks into account when	calculating memlock limit</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg187186.html">[PATCH v1 16/31] virpcimock: Introduce NVMe driver and	devices</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#187482"><strong>Date</strong></a></li>
<li><a href="index.html#187482"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/virt-tools/>[Virt&nbsp;Tools]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libvirt-users/>[Libvirt&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/libosinfo/>[Lib&nbsp;OS&nbsp;Info]</a>
&nbsp;
&nbsp;
<a href=/linux/fedora/fedora-users/>[Fedora&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=http://www.ske-art.com/z/biglist.php>[Big&nbsp;List&nbsp;of&nbsp;Linux&nbsp;Books]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;News]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-tools/>[Fedora&nbsp;Tools]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script type="text/javascript"> 
 function initAddThis() {
    addthis.init()
 }
initAddThis();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
